<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modelo Financiero Interactivo - Rodando a Gas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<!-- Lucide Icons for a professional touch -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
/* === NEW: CLEAN MINIMALIST DESIGN SYSTEM === */
:root {
    --primary: #0ea5e9;      /* Sky blue */
    --secondary: #10b981;    /* Emerald */
    --accent: #8b5cf6;       /* Purple */
    --warning: #f59e0b;      /* Amber */
    --danger: #ef4444;       /* Red */
    --surface: #1e293b;      /* Slate 800 */
    --surface-light: #334155; /* Slate 700 */
    --text-primary: #f8fafc;  /* White */
    --text-secondary: #cbd5e1; /* Slate 300 */
    --text-muted: #94a3b8;    /* Slate 400 */
    --bg-primary: #020617;    /* Slate 950 */
    --bg-secondary: #0f172a;  /* Slate 900 */
}

/* Base Styles - Professional Investor Grade */
* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
    margin: 0;
    padding: 0;
}

h1, h2, h3, h4 {
    color: var(--text-primary);
    font-weight: 700;
}

/* NEW: Consistent spacing system */
.space-xs { gap: 0.5rem; }
.space-sm { gap: 1rem; }
.space-md { gap: 1.5rem; }
.space-lg { gap: 2rem; }
.space-xl { gap: 3rem; }

/* NEW: Clean card system */
.card {
    background: var(--surface);
    border: 1px solid var(--surface-light);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.3);
}

/* NEW: Button system */
.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    font-size: 0.875rem;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: #0284c7;
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--secondary);
    color: white;
}

.btn-secondary:hover {
    background: #059669;
    transform: translateY(-1px);
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--surface-light);
    color: var(--text-secondary);
}

.btn-outline:hover {
    background: var(--surface-light);
    color: var(--text-primary);
}

/* Gradient text highlight */
.highlight-text {
background: linear-gradient(135deg, var(--primary), var(--secondary));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}
/* Tabs Navigation */
.tab-button {
transition: all 0.3s ease;
cursor: pointer;
padding: 1rem 1.5rem;
border-bottom: 2px solid transparent;
color: #94a3b8; /* slate-400 */
font-weight: 500;
margin-right: 0.5rem;
border-radius: 0.5rem 0.5rem 0 0;
display: inline-flex; /* Allows icons aligned with text */
align-items: center;
gap: 0.5rem; /* Space between icon and text */
}
.tab-button.active {
border-color: #0ea5e9; /* sky-500 */
color: #f8fafc; /* slate-50 */
background-color: #0f172a; /* slate-900 */
font-weight: 600;
}
.tab-button:hover:not(.active) {
color: #cbd5e1; /* slate-300 */
background-color: #0f172a; /* slate-900 */
}
/* Section content */
.content-section { display: none; }
.content-section.active { display: block; }
/* Card Style */
.card {
background-color: #0f172a; /* slate-900 for card interior */
border-radius: 0.75rem; /* rounded-xl */
box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
padding: 1.5rem;
margin-bottom: 1.5rem;
border: 1px solid #1e293b; /* slate-800 for subtle borders */
}
/* Sliders */
.input-slider {
-webkit-appearance: none;
width: 100%;
height: 8px;
background: #1e293b; /* slate-800 */
border-radius: 9999px;
outline: none;
transition: background 0.2s ease-in-out;
}
.input-slider::-webkit-slider-thumb {
-webkit-appearance: none;
width: 20px;
height: 20px;
background: #0ea5e9; /* sky-500 */
border-radius: 9999px;
cursor: pointer;
box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3); /* Ring when dragging */
transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.input-slider:hover::-webkit-slider-thumb {
background: #38bdf8; /* sky-400 */
}
/* Financial Tables */
.financial-table {
width: 100%;
border-collapse: collapse;
background-color: #0f172a; /* slate-900 */
border-radius: 0.75rem; /* rounded-xl */
overflow: hidden; /* So that rounded borders apply to thead/tbody */
}
.financial-table th, .financial-table td {
padding: 1rem; /* More padding for readability */
text-align: right;
border-bottom: 1px solid #1e293b; /* slate-800 */
font-size: 0.95rem;
}
.financial-table th {
background-color: #1a233b; /* A slightly lighter shade than the table background */
font-weight: 600;
color: #94a3b8; /* slate-400 */
text-transform: uppercase;
letter-spacing: 0.05em;
}
.financial-table td:first-child, .financial-table th:first-child {
text-align: left;
color: #e2e8f0; /* slate-200 */
}
.financial-table tr:last-child td {
border-bottom: none; /* Remove bottom border from last row */
}
.financial-table tr.bg-gray-50 { /* Style for total/subtotal rows */
background-color: #1e293b; /* slate-800 */
color: #f8fafc; /* slate-50 */
font-weight: 700;
}
.positive { color: #34d399; /* emerald-400 */ }
.negative { color: #f43f5e; /* rose-500 */ }
/* Key Metrics Indicators */
.metric-card {
background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* Subtle gradient */
border-left: 4px solid #0ea5e9; /* sky-500 */
padding: 1.25rem; /* More padding */
border-radius: 0.75rem;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
display: flex;
flex-direction: column;
justify-content: space-between;
}
.metric-card .text-sm {
color: #94a3b8; /* slate-400 */
font-weight: 500;
margin-bottom: 0.25rem;
}
.metric-card .text-2xl {
color: #f8fafc; /* slate-50 */
font-weight: 800; /* Extra bold */
}
.metric-row-title {
font-size: 0.875rem; /* text-sm */
font-weight: 600; /* font-semibold */
color: #64748b; /* slate-500 */
text-transform: uppercase;
letter-spacing: 0.05em;
margin-bottom: 0.75rem; /* mb-3 */
padding-left: 0.25rem;
}
/* Debug Panel */
.debug-info {
background: #1e293b; /* slate-800 */
color: #f8fafc; /* slate-50 */
border: 1px solid #334155; /* slate-700 */
border-radius: 0.5rem;
box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}
.debug-info button {
background-color: #ef4444; /* red-500 */
color: white;
padding: 0.3rem 0.75rem;
border-radius: 0.375rem;
font-size: 0.75rem;
transition: background-color 0.2s ease;
}
.debug-info button:hover {
background-color: #dc2626; /* red-600 */
}
/* IFRS Compliant Cards */
.niif-compliant {
border-left: 4px solid #10b981; /* emerald-500 */
background-color: #0f172a; /* slate-900 */
}
/* Validation Panel */
#validation-panel-content {
background-color: #0f172a; /* slate-900 */
border: 1px solid #1e293b; /* slate-800 */
border-radius: 0.75rem;
box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
.validation-item {
border-left: 4px solid;
padding: 0.75rem;
border-radius: 0.5rem;
margin-bottom: 0.5rem;
}
.validation-item.error { background-color: #450a0a; border-color: #dc2626; color: #fecaca; } /* red-950 / red-600 */
.validation-item.warning { background-color: #422006; border-color: #f59e0b; color: #fffbeb; } /* amber-950 / amber-500 */
.validation-item.info { background-color: #075985; border-color: #3b82f6; color: #e0f2fe; } /* sky-950 / blue-500 */
.validation-item.passed { background-color: #064e3b; border-color: #10b981; color: #d1fae5; } /* emerald-950 / green-500 */

.validation-message { color: #cbd5e1; /* slate-300 */ }
.validation-message strong { color: #f8fafc; }
.validation-summary {
background-color: #1a233b; /* slate-800 */
color: #f8fafc;
border: 1px solid #334155;
}
.validation-summary.bg-red-200 { background-color: #450a0a; border-color: #dc2626; color: #fecaca; }
.validation-summary.bg-yellow-200 { background-color: #422006; border-color: #f59e0b; color: #fffbeb; }
.validation-summary.bg-green-200 { background-color: #064e3b; border-color: #10b981; color: #d1fae5; }
/* Tooltips - Maintain visibility and readability */
[data-tooltip] {
position: relative;
cursor: help;
}
[data-tooltip]:before, [data-tooltip]:after {
position: absolute;
visibility: hidden;
opacity: 0;
transition: opacity 0.2s ease-in-out;
pointer-events: none;
background-color: #1e293b; /* slate-800 */
color: #f8fafc;
border: 1px solid #334155; /* slate-700 */
border-radius: 0.5rem;
font-size: 0.8rem;
line-height: 1.4;
padding: 0.75rem;
width: 280px;
z-index: 100;
}
[data-tooltip]:before {
content: attr(data-tooltip);
bottom: 125%;
left: 50%;
transform: translateX(-50%);
}
[data-tooltip]:after {
content: '';
bottom: 125%;
left: 50%;
margin-left: -5px;
border-width: 5px;
border-style: solid;
border-color: #1e293b transparent transparent transparent;
transform: translateY(100% + 5px) translateX(-50%);
}
[data-tooltip]:hover:before, [data-tooltip]:hover:after {
visibility: visible;
opacity: 1;
}
/* Inputs and Selects */
input[type="number"], input[type="range"] {
background-color: #1a233b; /* slate-800 */
border-color: #334155; /* slate-700 */
color: #e2e8f0; /* slate-200 */
border-radius: 0.375rem; /* rounded-md */
}
input[type="number"]:focus, input[type="range"]::-webkit-slider-thumb:focus {
border-color: #0ea5e9; /* sky-500 */
box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.5); /* Focus ring */
background-color: #1a233b; /* Ensure background doesn't change on focus */
}
label {
color: #cbd5e1; /* slate-300 */
}
/* Styles for slider value text */
span[id$="-valor"] {
color: #81e6d9; /* a green/cyan tone for values */
}
/* NEW: Compact Chart Styles */
.compact-chart {
padding: 1rem;
}
.compact-chart h4 {
font-size: 0.875rem;
margin-bottom: 0.5rem;
line-height: 1.2;
}
/* NEW: Horizontal Control Styles */
.control-grid {
display: grid;
grid-template-columns: auto 1fr;
gap: 1rem;
align-items: center;
}
.control-grid label {
text-align: left;
white-space: nowrap;
}
.control-grid .slider-container {
display: grid;
grid-template-columns: 1fr auto;
gap: 1rem;
align-items: center;
}
.units-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
gap: 1rem;
}

/* NEW: Financing Matrix Styles */
#financing-matrix-table {
width: 100%;
border-collapse: collapse;
margin-top: 1rem;
}
#financing-matrix-table th, #financing-matrix-table td {
text-align: center;
padding: 0.5rem;
border: 1px solid #1e293b;
}
#financing-matrix-table th {
font-size: 0.8rem;
font-weight: 600;
}
#financing-matrix-table td:first-child {
text-align: left;
font-weight: 500;
}
#financing-matrix-table input[type="number"] {
width: 100%;
padding: 0.25rem;
font-size: 0.85rem;
text-align: right;
-moz-appearance: textfield;
}
#financing-matrix-table input[type="number"]::-webkit-outer-spin-button,
#financing-matrix-table input[type="number"]::-webkit-inner-spin-button {
-webkit-appearance: none;
margin: 0;
}
.additional-value {
    font-weight: 500;
    padding: 0.25rem;
    border-radius: 0.25rem;
    color: #fcd34d; /* amber-300 */
}
.total-value {
    font-weight: 700;
    padding: 0.25rem;
    border-radius: 0.25rem;
    background-color: rgba(14, 165, 233, 0.1);
    color: #7dd3fc; /* sky-300 */
}
.instrument-header {
    background-color: #1a233b;
    color: #f8fafc;
    font-weight: 600;
    text-align: left;
    padding-left: 1rem;
}


/* Dynamic Validation Styles */
.validation-error {
border-color: #ef4444 !important;
box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
}
.validation-warning {
border-color: #f59e0b !important;
box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2) !important;
}
.validation-success {
border-color: #10b981 !important;
box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) !important;
}
/* Slider customization */
input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #0ea5e9;
    cursor: pointer;
    box-shadow: 0 0 2px 0 #000;
}

input[type="range"]::-webkit-slider-track {
    height: 8px;
    cursor: pointer;
    background: #334155;
    border-radius: 5px;
}

/* Progress bars */
.progress-bar {
    transition: width 0.3s ease-in-out;
}

/* Card hover effects */
.financing-card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Scenario button styles */
.scenario-btn {
    transition: all 0.3s ease;
    transform: scale(1);
}

.scenario-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.scenario-btn.active {
    border-color: #0ea5e9;
    background-color: #0c4a6e;
    box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3);
}

/* Comparison table styles */
#comparison-table-body tr:hover {
    background-color: rgba(51, 65, 85, 0.3);
}

/* Animation for optimization */
@keyframes optimizing {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

.optimizing {
    animation: optimizing 1s infinite;
}

/* === EXECUTIVE SUMMARY BAR === */
.executive-bar {
    background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid var(--surface-light);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.key-metrics-strip {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding: 0.5rem 0;
}

.metric-pill {
    background: rgba(14, 165, 233, 0.1);
    border: 1px solid rgba(14, 165, 233, 0.2);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    min-width: 140px;
    text-align: center;
    flex-shrink: 0;
    transition: all 0.2s ease;
}

.metric-pill:hover {
    background: rgba(14, 165, 233, 0.15);
    transform: translateY(-2px);
}

.metric-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.metric-value {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.grade-a { color: var(--secondary); }
.grade-b { color: var(--primary); }
.grade-c { color: var(--warning); }
.grade-d { color: var(--danger); }

/* === MAIN LAYOUT SYSTEM === */
.main-layout {
    display: grid;
    grid-template-columns: 280px 1fr 280px;
    gap: 2rem;
    margin-top: 2rem;
}

/* === LOADING STATES === */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(2, 6, 23, 0.8);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}

.loading-content {
    text-align: center;
    color: white;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(14, 165, 233, 0.3);
    border-top: 3px solid #0ea5e9;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

.loading-text {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.loading-subtext {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.7);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.fade-out {
    animation: fadeOut 0.3s ease forwards;
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

/* === CONTROL SIDEBAR === */
.control-sidebar {
    background: var(--surface);
    border-radius: 16px;
    padding: 1.5rem;
    height: fit-content;
    border: 1px solid var(--surface-light);
    position: sticky;
    top: 2rem;
}

.scenario-selector h3,
.key-controls h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.scenario-buttons-clean {
    display: grid;
    gap: 0.75rem;
    margin-bottom: 2rem;
}

.scenario-card {
    background: var(--bg-secondary);
    border: 1px solid var(--surface-light);
    border-radius: 10px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    width: 100%;
}

.scenario-card:hover {
    background: var(--surface-light);
    transform: translateY(-1px);
}

.scenario-card.active {
    border-color: var(--primary);
    background: rgba(14, 165, 233, 0.1);
}

.scenario-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.scenario-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.scenario-return {
    font-size: 0.75rem;
    color: var(--secondary);
    font-weight: 500;
}

/* === CONTROL GROUPS === */
.control-group {
    margin-bottom: 1.5rem;
}

.control-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.smart-control {
    margin-bottom: 1.5rem;
}

.control-label {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.label-text {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.label-helper {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.input-group {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.smart-slider {
    flex: 1;
    height: 6px;
    background: var(--surface-light);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
}

.smart-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(14, 165, 233, 0.3);
    transition: all 0.2s ease;
}

.smart-slider::-webkit-slider-thumb:hover {
    background: #0284c7;
    transform: scale(1.1);
}

.input-display {
    min-width: 80px;
}

.current-value {
    font-weight: 600;
    color: var(--primary);
    font-size: 0.875rem;
}

.range-indicator {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.control-feedback {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: rgba(16, 185, 129, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.feedback-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.feedback-label {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.feedback-value {
    font-size: 0.75rem;
    font-weight: 600;
}

.feedback-value.positive { color: var(--secondary); }
.feedback-value.negative { color: var(--danger); }

/* === MAIN DASHBOARD === */
.main-dashboard {
    background: var(--surface);
    border-radius: 16px;
    padding: 2rem;
    border: 1px solid var(--surface-light);
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--surface-light);
}

.dashboard-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.dashboard-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.metrics-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.metric-card-new {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--surface) 100%);
    border: 1px solid var(--surface-light);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.2s ease;
}

.metric-card-new:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.3);
}

.metric-title {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.metric-value-large {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.metric-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* === INSIGHTS SIDEBAR === */
.insights-sidebar {
    background: var(--surface);
    border-radius: 16px;
    padding: 1.5rem;
    height: fit-content;
    border: 1px solid var(--surface-light);
    position: sticky;
    top: 2rem;
}

.capacity-indicator-clean {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.alert-list {
    margin-bottom: 1.5rem;
}

.alert-item {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
}

.insight-cards {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.insight-card {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid var(--surface-light);
}

.insight-card h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.insight-card p {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin: 0;
}

/* === CONTEXTUAL HELP SYSTEM === */
.help-trigger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    background: var(--primary);
    border-radius: 50%;
    color: white;
    font-size: 0.75rem;
    cursor: help;
    margin-left: 0.5rem;
}

/* Animation enhancements */
.animate-slide-in {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in {
    animation: fadeIn 0.5s ease-out;
}

/* === MOBILE RESPONSIVE DESIGN === */
@media (max-width: 1024px) {
    .main-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .compact-chart {
        min-height: 280px;
    }
}

@media (max-width: 768px) {
    .executive-bar {
        padding: 1rem;
        overflow-x: auto;
    }
    
    .key-metrics-strip {
        min-width: max-content;
        gap: 0.5rem;
    }
    
    .metric-pill {
        min-width: 120px;
        flex-shrink: 0;
        padding: 0.75rem 1rem;
    }
    
    .main-layout {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

@media (max-width: 480px) {
    .btn {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
    }
    
    .metric-value {
        font-size: 1rem;
    }
}
</style>
</head>
<body class="text-gray-800">

<!-- Debug Panel -->
<div id="debug-info" class="debug-info" style="display:none; position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 10px; max-height: 400px; overflow-y: auto;">
<div id="debug-content"></div>
<button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
</div>

<!-- Loading Overlay -->
<div id="calculation-loader" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text">Calculating financial model...</div>
        <div class="loading-subtext">Optimizing capital structure</div>
    </div>
</div>

<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
<!-- Executive Summary Bar -->
<div class="executive-bar animate-fade-in">
    <div class="key-metrics-strip">
        <div class="metric-pill">
            <span class="metric-label">TIR Equity</span>
            <span class="metric-value" id="tir-quick">0%</span>
        </div>
        <div class="metric-pill">
            <span class="metric-label">EBITDA Y5</span>
            <span class="metric-value" id="ebitda-quick">$0M</span>
        </div>
        <div class="metric-pill">
            <span class="metric-label">DSCR</span>
            <span class="metric-value" id="dscr-quick">0.0x</span>
        </div>
        <div class="metric-pill">
            <span class="metric-label">Health Score</span>
            <span class="metric-value grade-b" id="health-score-quick">B</span>
        </div>
        <div class="metric-pill">
            <span class="metric-label">Capital Efficiency</span>
            <span class="metric-value" id="capital-efficiency-quick">$0K/unit</span>
        </div>
    </div>
</div>

<!-- Strategic Scenarios -->
<div class="mb-8">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold highlight-text mb-2">Strategic Scenarios</h2>
        <p class="text-slate-400">Choose a predefined strategy or optimize current configuration</p>
    </div>
    <div id="scenario-buttons-container" class="flex flex-wrap justify-center gap-4 mb-6">
        <!-- Scenario buttons will be generated here -->
    </div>
    <div class="flex justify-center gap-4">
        <button onclick="optimizeCapitalStructure()" class="btn btn-secondary">
            <i data-lucide="zap" class="w-4 h-4"></i>
            Auto-Optimize WACC
        </button>
        <button onclick="openScenarioComparison()" class="btn btn-outline">
            <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
            Compare Scenarios
        </button>
        <button onclick="toggleDebug()" class="btn btn-outline">
            <i data-lucide="bug" class="w-4 h-4"></i>
            Debug
        </button>
    </div>
</div>

<!-- =================================================================== -->
<!-- ===== NEW INVESTOR-FOCUSED METRICS DASHBOARD ====================== -->
<!-- =================================================================== -->
<div class="space-y-8 mb-8">
<!-- Fila 1: Retorno y Escala (El "Hook") -->
<div>
<h3 class="metric-row-title">Retorno y Escala</h3>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
<div class="metric-card" data-tooltip="Indicador clave de la rentabilidad operativa del negocio al final del periodo de proyección.">
<div class="text-sm">EBITDA Año 5</div>
<div class="text-2xl font-bold" id="ebitda-year5">$0M</div>
<div class="text-xs text-emerald-400">Rentabilidad Operativa</div>
</div>
<div class="metric-card" data-tooltip="Calculada sobre los flujos de efectivo para el accionista (después de deuda) y un valor terminal conservador (Múltiplo P/B de 1.8x). Es el retorno real y magnificado de su inversión gracias al apalancamiento.">
<div class="text-sm">TIR Equity</div>
<div class="text-2xl font-bold" id="tir-equity">0%</div>
<div class="text-xs text-sky-400">Retorno para el Inversionista</div>
</div>
<div class="metric-card" data-tooltip="Fórmula: Efectivo + Cuentas por Cobrar Netas + Activos Fijos Netos. Es el indicador estándar de la industria para medir la escala total del negocio que hemos construido.">
<div class="text-sm">Activos Totales Bajo Gestión</div>
<div class="text-2xl font-bold" id="aum-value">$0M</div>
<div class="text-xs text-purple-400">Magnitud del Negocio</div>
</div>
<div class="metric-card" data-tooltip="Número acumulado de unidades financiadas en 5 años. Mide nuestra capacidad para capturar clientes y la penetración de mercado.">
<div class="text-sm">Vagonetas Totales Financiadas</div>
<div class="text-2xl font-bold" id="total-vans-financed">0</div>
<div class="text-xs text-pink-400">Penetración de Mercado</div>
</div>
</div>
</div>
<!-- Fila 2: La Maquinaria de Crecimiento (El "Motor") -->
<div>
<h3 class="metric-row-title">La Maquinaria de Crecimiento</h3>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
<div class="metric-card" data-tooltip="Capital total aportado por los socios (Serie A y futuras capitalizaciones). Es el 'costo' de la inversión para los accionistas.">
<div class="text-sm">Capital de Socios Levantado</div>
<div class="text-2xl font-bold" id="equity-raised">$0M</div>
<div class="text-xs text-blue-400">Serie A + Capital Calls</div>
</div>
<div class="metric-card" data-tooltip="Deuda total (Venture + Comercial) levantada para financiar la flota. Demuestra nuestra capacidad para apalancar el capital de socios.">
<div class="text-sm">Deuda Total Levantada</div>
<div class="text-2xl font-bold" id="total-debt-raised">$0M</div>
<div class="text-xs text-amber-400">Apalancamiento para Escalar</div>
</div>
<div class="metric-card" data-tooltip="Mide cuántos ingresos generamos por cada peso de financiamiento total (Equity + Deuda). Un ratio >0.8x indica una excelente productividad del capital.">
<div class="text-sm">Funding Efficiency</div>
<div class="text-2xl font-bold" id="funding-efficiency">0.0x</div>
<div class="text-xs text-cyan-400">Revenue / Total Funding</div>
</div>
<div class="metric-card" data-tooltip="CAPEX total dividido entre unidades totales. Un valor <$750K demuestra una excelente eficiencia en la adquisición y preparación de activos.">
<div class="text-sm">Capital Efficiency</div>
<div class="text-2xl font-bold" id="capital-per-unit">$0K</div>
<div class="text-xs text-blue-400">CAPEX por Unidad</div>
</div>
</div>
</div>
<!-- Fila 3: Resiliencia y Sostenibilidad (La "Base") -->
<div>
<h3 class="metric-row-title">Resiliencia y Sostenibilidad</h3>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
<div class="metric-card" data-tooltip="Métrica de resiliencia. No solo muestra cuántas unidades financiamos, sino cuántas mantenemos productivas gracias a nuestro ecosistema de IA (PMA). Ajustado por NIIF 5.">
<div class="text-sm">Vagonetas Operativas (Año 5)</div>
<div class="text-2xl font-bold" id="vagonetas-operativas">0</div>
<div class="text-xs text-emerald-400">Ajustado por NIIF 5</div>
</div>
<div class="metric-card" data-tooltip="Fórmula: EBITDA / Servicio de Deuda. Un ratio >1.5x es saludable y demuestra nuestra capacidad para pagar cómodamente la deuda, un requisito para futuros prestamistas.">
<div class="text-sm">Debt Service Coverage</div>
<div class="text-2xl font-bold" id="dscr-final">0.0x</div>
<div class="text-xs text-sky-400">EBITDA / Servicio de Deuda</div>
</div>
<div class="metric-card" data-tooltip="Margen de Interés Neto (NIM) del último año. Mide la rentabilidad de la cartera de crédito después de costos de financiamiento. Estándar de la industria.">
<div class="text-sm">Net Interest Margin (NIM) Y5</div>
<div class="text-2xl font-bold" id="nim-y5">0.0%</div>
<div class="text-xs text-emerald-400">Rentabilidad de Cartera</div>
</div>
<div class="metric-card" data-tooltip="El año en que los ingresos operativos superan los gastos operativos, marcando el punto en que el negocio se sostiene por sí mismo sin necesidad de nuevas inyecciones de capital.">
<div class="text-sm">Autosuficiencia</div>
<div class="text-2xl font-bold" id="autosuficiency-year">Año 0</div>
<div class="text-xs text-blue-400">Ingresos > Gastos Operativos</div>
</div>
</div>
</div>
</div>
<!-- Main Progressive Layout -->
<div class="main-layout">
    <!-- Left: Control Sidebar -->
    <div class="control-sidebar animate-slide-in">
        <div class="scenario-selector">
            <h3><i data-lucide="target" class="w-4 h-4"></i>Strategy</h3>
            <div class="scenario-buttons-clean" id="scenario-buttons-clean">
                <!-- Scenario cards will be populated here -->
            </div>
        </div>
        
        <div class="key-controls">
            <h3><i data-lucide="sliders" class="w-4 h-4"></i>Key Levers</h3>
            
            <div class="control-group">
                <div class="smart-control">
                    <div class="control-label">
                        <span class="label-text">Client Interest Rate</span>
                        <div class="help-trigger" data-tooltip="Higher rates = better margins but lower accessibility">?</div>
                    </div>
                    <div class="label-helper">Higher rates = better margins</div>
                    <div class="input-group">
                        <input type="range" min="22" max="30" step="0.1" value="25.5" 
                               class="smart-slider" id="tasaInteres-sidebar">
                        <div class="input-display">
                            <span class="current-value" id="tasaInteres-sidebar-display">25.5%</span>
                            <div class="range-indicator">
                                <span class="range-min">22%</span>
                                <span class="range-max">30%</span>
                            </div>
                        </div>
                    </div>
                    <div class="control-feedback">
                        <div class="feedback-item">
                            <span class="feedback-label">Unit Economics Impact:</span>
                            <span class="feedback-value positive" id="rate-impact-sidebar">+7.3% margin</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="smart-control">
                    <div class="control-label">
                        <span class="label-text">Down Payment</span>
                        <div class="help-trigger" data-tooltip="Balance between accessibility and cash flow">?</div>
                    </div>
                    <div class="label-helper">Balance accessibility vs cash flow</div>
                    <div class="input-group">
                        <input type="range" min="12" max="20" step="0.5" value="15" 
                               class="smart-slider" id="downPaymentPercentage-sidebar">
                        <div class="input-display">
                            <span class="current-value" id="downPayment-sidebar-display">15%</span>
                            <div class="range-indicator">
                                <span class="range-min">12%</span>
                                <span class="range-max">20%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label>Units Plan</label>
                <div class="units-grid-clean" id="units-grid-clean">
                    <!-- Units grid will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Center: Main Dashboard -->
    <div class="main-dashboard animate-slide-in">
        <div class="dashboard-header">
            <div>
                <h1>RAG Financial Model</h1>
                <p class="text-slate-400">NIIF-Compliant | Series A Due Diligence</p>
            </div>
            <div class="dashboard-actions">
                <button class="btn btn-outline" onclick="openFullControls()">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    Full Controls
                </button>
                <button class="btn btn-primary" onclick="forceCalculate()">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Calculate
                </button>
            </div>
        </div>

        <!-- Metrics Dashboard -->
        <div class="metrics-dashboard">
            <div class="metric-card-new">
                <div class="metric-title">EBITDA Year 5</div>
                <div class="metric-value-large" id="ebitda-year5-main">$0M</div>
                <div class="metric-subtitle">Operational Profitability</div>
            </div>
            
            <div class="metric-card-new">
                <div class="metric-title">Equity IRR</div>
                <div class="metric-value-large" id="tir-equity-main">0%</div>
                <div class="metric-subtitle">Investor Return</div>
            </div>
            
            <div class="metric-card-new">
                <div class="metric-title">Assets Under Management</div>
                <div class="metric-value-large" id="aum-main">$0M</div>
                <div class="metric-subtitle">Business Scale</div>
            </div>
            
            <div class="metric-card-new">
                <div class="metric-title">Total Units Financed</div>
                <div class="metric-value-large" id="total-units-main">0</div>
                <div class="metric-subtitle">Market Penetration</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-slate-800">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active"> <i data-lucide="settings" class="w-5 h-5"></i> Control</button>
                <button id="tab-financieros" class="tab-button"> <i data-lucide="wallet" class="w-5 h-5"></i> Financieros</button>
                <button id="tab-niif" class="tab-button"> <i data-lucide="book" class="w-5 h-5"></i> NIIF</button>
                <button id="tab-graficos" class="tab-button"> <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Gráficos</button>
                <button id="tab-validacion" class="tab-button"> <i data-lucide="check-circle" class="w-5 h-5"></i> Validación</button>
            </nav>
        </div>
<!-- Tab Content: Control -->
<div id="content-control" class="content-section active">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<!-- COLUMNA IZQUIERDA: El Modelo de Negocio (¿Qué y Cómo Vendemos?) -->
<div class="space-y-6">
<!-- Tarjeta 1: Paquete Financiado (El Producto Principal) -->
<div class="card">
<h4 class="font-semibold text-lg mb-4 text-white">📦 Paquete Financiado <span class="text-sm text-slate-400">(El Producto Principal)</span></h4>
<div id="paquete-financiado-controls" class="space-y-4"></div>
<div id="package-summary" class="mt-4 p-3 bg-slate-800 rounded"></div>
</div>
<!-- Tarjeta 2: Condiciones del Crédito al Cliente -->
<div class="card">
<h4 class="font-semibold text-lg mb-4 text-white">📝 Condiciones del Crédito al Cliente</h4>
<div id="condiciones-credito-controls" class="space-y-4"></div>
</div>
<!-- Tarjeta 3: Ingresos Operativos Adicionales -->
<div class="card">
<h4 class="font-semibold text-lg mb-4 text-white">💸 Ingresos Operativos Adicionales</h4>
<div id="ingresos-adicionales-controls" class="space-y-4"></div>
</div>
</div>
<!-- COLUMNA DERECHA: La Estrategia (Crecimiento y Riesgo) -->
<div class="space-y-6">
<!-- Tarjeta 4: Plan de Crecimiento y Operaciones -->
<div class="card">
<h4 class="font-semibold text-lg mb-4 text-white">📈 Plan de Crecimiento y Operaciones</h4>
<div id="plan-crecimiento-controls" class="space-y-4"></div>
</div>
<!-- Tarjeta 5: Matriz de Financiamiento -->
<div class="card">
<h4 class="font-semibold text-lg mb-4 text-white">💰 Matriz de Financiamiento <span class="text-sm text-slate-400">(La Historia del Capital)</span></h4>
<div id="matriz-financiamiento-controls" class="space-y-4"></div>
<div id="funding-coverage-card-container" class="mt-4"></div>
</div>
<!-- Tarjeta 6: Riesgo y Supuestos de Salida -->
<div class="card">
<h4 class="font-semibold text-lg mb-4 text-white">🛡️ Riesgo y Supuestos de Salida</h4>
<div id="riesgo-salida-controls" class="space-y-4"></div>
</div>
</div>
</div>
<!-- RECALCULATE BUTTON -->
<div class="text-center mt-6">
<button onclick="forceCalculate()" class="mt-6 bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-lg font-medium transition duration-300 inline-flex items-center gap-2">
<i data-lucide="refresh-cw" class="w-5 h-5"></i> Recalcular Modelo
</button>
</div>
</div>
<!-- Tab Content: Financials -->
<div id="content-financieros" class="content-section">
<div class="space-y-6">
<div class="card">
<h3 class="text-xl font-semibold mb-4 text-white">Estado de Resultados (P&L)</h3>
<div class="overflow-x-auto">
<table class="financial-table">
<thead>
<tr>
<th>Concepto</th>
<th>Año 1</th>
<th>Año 2</th>
<th>Año 3</th>
<th>Año 4</th>
<th>Año 5</th>
</tr>
</thead>
<tbody id="pl-table-body"></tbody>
</table>
</div>
</div>
<div class="card">
<h3 class="text-xl font-semibold mb-4 text-white">Flujo de Efectivo</h3>
<div class="overflow-x-auto">
<table class="financial-table">
<thead>
<tr>
<th>Concepto</th>
<th>Año 0</th>
<th>Año 1</th>
<th>Año 2</th>
<th>Año 3</th>
<th>Año 4</th>
<th>Año 5</th>
</tr>
</thead>
<tbody id="cf-table-body"></tbody>
</table>
</div>
</div>
<div class="card">
<h3 class="text-xl font-semibold mb-4 text-white">Balance General</h3>
<div class="overflow-x-auto">
<table class="financial-table">
<thead>
<tr>
<th>Concepto</th>
<th>Año 1</th>
<th>Año 2</th>
<th>Año 3</th>
<th>Año 4</th>
<th>Año 5</th>
</tr>
</thead>
<tbody id="bs-table-body"></tbody>
</table>
</div>
<div id="balance-validation" class="mt-4 text-center font-semibold p-2 rounded-lg bg-gray-50"></div>
</div>
</div>
</div>
<!-- Tab Content: IFRS -->
<div id="content-niif" class="content-section">
<div class="space-y-6">
<div class="card niif-compliant">
<h3 class="text-xl font-semibold mb-4 text-white">NIIF 15 - Reconocimiento de Ingresos <span class="text-sm text-slate-400">(Cómo se reconocen los ingresos del negocio de financiamiento)</span></h3>
<div id="niif15-container">Calculando datos NIIF 15...</div>
</div>
<div class="card niif-compliant">
<h3 class="text-xl font-semibold mb-4 text-white">NIIF 9 - Provisiones Crediticias <span class="text-sm text-slate-400">(Impacto de la morosidad y las pérdidas esperadas)</span></h3>
<div id="niif9-container">Calculando datos NIIF 9...</div>
</div>
<div class="card niif-compliant">
<h3 class="text-xl font-semibold mb-4 text-white">NIIF 5 - Activos Mantenidos para Venta <span class="text-sm text-slate-400">(Tratamiento contable de vagonetas reposedas)</span></h3>
<div id="niif5-container">Calculando datos NIIF 5...</div>
</div>
</div>
</div>
<!-- Tab Content: Charts -->
<div id="content-graficos" class="content-section">
<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
<!-- Row 1: Core Differentiation -->
<div class="xl:col-span-2 card">
<h4 class="text-lg font-semibold mb-3 text-white">🛡️ Protección Rodando™ Impact</h4>
<div style="height: 320px;"><canvas id="proteccionImpactChart"></canvas></div>
</div>
<div class="card">
<h4 class="text-lg font-semibold mb-3 text-white">📈 Revenue Evolution</h4>
<div style="height: 320px;"><canvas id="revenueEvolutionChart"></canvas></div>
</div>
<!-- Row 2: Scaling & Efficiency -->
<div class="card">
<h4 class="text-lg font-semibold mb-3 text-white">🚀 Capital Efficiency</h4>
<div style="height: 300px;"><canvas id="capitalEfficiencyChart"></canvas></div>
</div>
<div class="xl:col-span-2 card">
<h4 class="text-lg font-semibold mb-3 text-white">💸 Cash Flow Resilience</h4>
<div style="height: 300px;"><canvas id="cashFlowResilienceChart"></canvas></div>
</div>
<!-- Row 3: Future & Leadership -->
<div class="card">
<h4 class="font-semibold text-lg mb-3 text-white">🎮 Gamification Impact</h4>
<div style="height: 280px;"><canvas id="gamificationChart"></canvas></div>
</div>
<div class="card">
<h4 class="text-lg font-semibold mb-3 text-white">🏁 Path to Leadership</h4>
<div style="height: 280px;"><canvas id="leadershipChart"></canvas></div>
</div>
<div class="card">
<h4 class="text-lg font-semibold mb-3 text-white">🔍 Competitive Moat</h4>
<div style="height: 280px;"><canvas id="moatChart"></canvas></div>
</div>
</div>
</div>
        <!-- Tab Content: Validation -->
        <div id="content-validacion" class="content-section">
            <div id="validation-panel-content">
                <h3 class="text-xl font-semibold mb-4 text-white">Resultados de Validación del Modelo</h3>
                <div id="validation-results-container">
                    <!-- Validation results will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Right: Insights Sidebar -->
    <div class="insights-sidebar animate-slide-in">
        <div class="capital-health">
            <h3><i data-lucide="activity" class="w-4 h-4"></i>Capital Health</h3>
            <div class="capacity-indicator-clean" id="capacity-indicator-clean">
                <!-- Capacity indicator will be populated here -->
            </div>
        </div>
        
        <div class="risk-alerts">
            <h3><i data-lucide="alert-triangle" class="w-4 h-4"></i>Alerts</h3>
            <div class="alert-list" id="alert-list">
                <!-- Alerts will be populated here -->
            </div>
        </div>
        
        <div class="recommendations">
            <h3><i data-lucide="lightbulb" class="w-4 h-4"></i>AI Insights</h3>
            <div class="insight-cards" id="insight-cards">
                <!-- AI insights will be populated here -->
            </div>
        </div>
    </div>
</div>
</div>
<script>
// Initializes Lucide icons
lucide.createIcons();

// ===================================================================
// ===== FASE 1: CONFIGURACIÓN Y DATOS INICIALES (EL QUÉ) =========
// ===================================================================
// (Aquí se definen todas las variables y la configuración inicial del modelo)
let debugLogs = []; // Array to store debug logs
let charts = {}; // Object to store Chart.js instances
let plannedFinancingData = {}; // NEW: To store pre-calculation financing plan

/**
* @typedef {Object} ModelData
* This object holds all the dynamic inputs for the financial model.
*/

// ===================================================================
// ===== FASE 4: ADVANCED ANALYTICS & PREMIUM UX + SINOSURE =======
// ===================================================================

/**
 * SINOSURE Export Credit Configuration
 */
const sinosureConfig = {
    rate: 6.0, // 6% vs 18% Venture Debt, 14% Commercial
    maxDuration: 12, // 12 meses máximo
    productionCostPercentage: 6, // 6% del production cost
    productionCostUSD: 18250, // $17,500-19,000 USD promedio
    exchangeRate: 20, // USD/MXN aproximado
    availabilityMonth: 13, // Disponible mes 13+
    probability: 70 // 70% probabilidad (no garantizado)
};

let modelData = {
// Unit Economics & Pricing
tasaInteres: 25.5,
downPaymentPercentage: 15,
upfrontCommissionPercentage: 3,
vanPrice: 750000,
vanCost: 625000,
conversionPrice: 54000,
bancasPrice: 21000,
gpsPrice: 12000,
insuranceAnnualPrice: 37205,
insuranceYears: 4,
conversionCost: 50000,
bancasCost: 20000,
gpsCost: 11000,
refaccionesCostPerUnit: 8000,
// Risk Assumptions
pdStage1: 0.008,
pdStage2: 0.08,
pdStage3: 0.40,
lgd: 0.50,
portfolioAllocationStage1: 0.82,
portfolioAllocationStage2: 0.10,
portfolioAllocationStage3: 0.08,

// Growth Strategy
unitsPerYear: [80, 200, 400, 620, 600], // Totals 1900 units

// Capital Structure
seriesA: 80000000,
ventureDebtLineAvailable: 100000000, 
commercialDebtLineAvailable: 300000000, 
ventureDebtRate: 18.0,
commercialDebtRate: 14.0,

// SINOSURE Parameters - NEW
sinosureAvailable: false,
sinosureRate: 6.0,
sinosureTiming: 13,
sinosureDuration: 12,
sinosureProbability: 70,
sinosureYear1: 0,
sinosureYear2: 0,
sinosureYear3: 0,
sinosureYear4: 0,
sinosureYear5: 0,

// Planned Drawdowns
ventureDebtYear1: 50000000,
ventureDebtYear2: 50000000,
ventureDebtYear3: 0,
ventureDebtYear4: 0,
ventureDebtYear5: 0,
commercialDebtYear1: 0,
commercialDebtYear2: 0,
commercialDebtYear3: 100000000,
commercialDebtYear4: 100000000,
commercialDebtYear5: 100000000,
partnerCapitalizationYear1: 50000000,
partnerCapitalizationYear2: 50000000,
partnerCapitalizationYear3: 0,
partnerCapitalizationYear4: 0,
partnerCapitalizationYear5: 0,
seriesB_newInvestors_year2: 0,
seriesB_newInvestors_year3: 70000000,

// Other Assumptions
ebitdaMultipleProject: 7.5,
floorEquityMultiple: 1.4,
proteccionRodando: true,
economicAdjustmentFactor: 1.0,
margenRefacciones: 30,
periodoAmortizacionDeuda: 5,
clientLoanTermYears: 4,
depreciationYears: 10,
opexRates: [17, 14, 11, 10, 9],
margenVagoneta: 9.5,
tasaReposicion: 5,
fairValueVenta: 78,
costosVenta: 7,
corporateTaxRate: 31,
litrosPromedioMensualPorUnidad: 900,
precioLitroGNV: 13.99,
comisionGNVPorcentaje: 15,
gmvPromedioMensualPorUnidad: 9000,
takeRateMarketplace: 3.0,
avgRemainingTermCartera: 2.5,
};

/**
 * Calculate maximum SINOSURE amount available
 */
function calculateMaxSinosureAmount() {
    const totalUnits = modelData.unitsPerYear.reduce((a, b) => a + b, 0);
    const productionCostPerUnitMXN = sinosureConfig.productionCostUSD * sinosureConfig.exchangeRate;
    return totalUnits * productionCostPerUnitMXN * (sinosureConfig.productionCostPercentage / 100);
}

/**
 * WACC calculation including SINOSURE
 */
function calculateWACCWithSinosure(equity, ventureDebt, commercialDebt, sinosure) {
    const totalCapital = equity + ventureDebt + commercialDebt + sinosure;
    
    if (totalCapital === 0) return 0;
    
    const weights = {
        equity: equity / totalCapital,
        ventureDebt: ventureDebt / totalCapital,
        commercialDebt: commercialDebt / totalCapital,
        sinosure: sinosure / totalCapital
    };
    
    const costs = {
        equity: 0.20, // 20% cost of equity assumption
        ventureDebt: modelData.ventureDebtRate / 100,
        commercialDebt: modelData.commercialDebtRate / 100,
        sinosure: sinosureConfig.rate / 100
    };
    
    const taxRate = modelData.corporateTaxRate / 100;
    
    return (weights.equity * costs.equity) + 
           (weights.ventureDebt * costs.ventureDebt * (1 - taxRate)) + 
           (weights.commercialDebt * costs.commercialDebt * (1 - taxRate)) +
           (weights.sinosure * costs.sinosure * (1 - taxRate));
}

// ===================================================================
// ===== FASE 3: SCENARIO PRESETS & INTELLIGENT OPTIMIZATION =======
// ===================================================================

/**
 * Definición de escenarios estratégicos predefinidos
 */
const strategicScenarios = {
    seed: {
        id: 'seed',
        name: 'SEED Validation',
        description: 'Conservative validation with minimal units and 100% tech focus',
        icon: '🌱',
        funding: 6600000,
        timeline: '18 meses',
        unitsPerYear: [0, 10, 0, 0, 0],
        focus: 'Technology Development + Pilot Validation',
        
        // Financing structure
        seriesA: 6600000,
        ventureDebtLineAvailable: 0,
        commercialDebtLineAvailable: 0,
        
        // Conservative parameters
        tasaInteres: 24.0,
        downPaymentPercentage: 20,
        pdStage1: 0.010,
        
        // All venture debt/commercial set to 0
        ventureDebtYear1: 0, ventureDebtYear2: 0, ventureDebtYear3: 0, ventureDebtYear4: 0, ventureDebtYear5: 0,
        commercialDebtYear1: 0, commercialDebtYear2: 0, commercialDebtYear3: 0, commercialDebtYear4: 0, commercialDebtYear5: 0,
        partnerCapitalizationYear1: 0, partnerCapitalizationYear2: 0, partnerCapitalizationYear3: 0, partnerCapitalizationYear4: 0, partnerCapitalizationYear5: 0,
        seriesB_newInvestors_year2: 0, seriesB_newInvestors_year3: 0,
        
        expectedOutcomes: {
            tirEquity: '15-20%',
            cashFlowPositive: 'N/A (validation only)',
            totalUnits: 10,
            riskLevel: 'Low'
        }
    },
    
    serieA: {
        id: 'serieA',
        name: 'SERIE A Scale',
        description: 'Post-validation controlled scaling with debt optimization',
        icon: '🚀',
        funding: 50000000,
        timeline: '36 meses',
        unitsPerYear: [0, 0, 70, 150, 0],
        focus: 'Controlled Scaling in Known Market',
        
        // Financing structure
        seriesA: 50000000,
        ventureDebtLineAvailable: 75000000,
        commercialDebtLineAvailable: 150000000,
        
        // Optimized parameters
        tasaInteres: 25.5,
        downPaymentPercentage: 15,
        pdStage1: 0.008,
        
        // Debt deployment
        ventureDebtYear1: 0, ventureDebtYear2: 30000000, ventureDebtYear3: 45000000, ventureDebtYear4: 0, ventureDebtYear5: 0,
        commercialDebtYear1: 0, commercialDebtYear2: 0, commercialDebtYear3: 50000000, commercialDebtYear4: 100000000, commercialDebtYear5: 0,
        partnerCapitalizationYear1: 0, partnerCapitalizationYear2: 25000000, partnerCapitalizationYear3: 0, partnerCapitalizationYear4: 0, partnerCapitalizationYear5: 0,
        seriesB_newInvestors_year2: 0, seriesB_newInvestors_year3: 0,
        
        expectedOutcomes: {
            tirEquity: '22-28%',
            cashFlowPositive: 'Year 4',
            totalUnits: 220,
            riskLevel: 'Medium'
        }
    },
    
    serieAWithSinosure: {
        id: 'serieAWithSinosure',
        name: 'SERIE A + SINOSURE',
        description: 'Optimal financing with SINOSURE at 6% (if available)',
        icon: '🇨🇳',
        funding: 50000000,
        timeline: '36 meses',
        unitsPerYear: [0, 0, 70, 150, 100], // Más agresivo con SINOSURE
        focus: 'Optimized Cost of Capital with Export Credit',
        
        // SINOSURE parameters
        sinosureAvailable: true,
        sinosureRate: 6.0,
        sinosureTiming: 13,
        sinosureProbability: 70,
        
        // Financing structure optimizada
        seriesA: 50000000,
        ventureDebtLineAvailable: 50000000,
        commercialDebtLineAvailable: 100000000,
        
        // Deployment con SINOSURE priority
        ventureDebtYear1: 0, ventureDebtYear2: 25000000, ventureDebtYear3: 25000000, ventureDebtYear4: 0, ventureDebtYear5: 0,
        commercialDebtYear1: 0, commercialDebtYear2: 0, commercialDebtYear3: 50000000, commercialDebtYear4: 75000000, commercialDebtYear5: 0,
        partnerCapitalizationYear1: 0, partnerCapitalizationYear2: 25000000, partnerCapitalizationYear3: 0, partnerCapitalizationYear4: 0, partnerCapitalizationYear5: 0,
        seriesB_newInvestors_year2: 0, seriesB_newInvestors_year3: 0,
        
        // SINOSURE específico (calculado dinámicamente)
        sinosureYear1: 0,
        sinosureYear2: 7000000, // Estimated based on production cost
        sinosureYear3: 0,
        
        expectedOutcomes: {
            tirEquity: '27-35%',
            cashFlowPositive: 'Year 3',
            totalUnits: 320,
            riskLevel: 'Medium-Low',
            blendedCostOfDebt: '9.8%',
            waccImprovement: '-360 bps vs no SINOSURE'
        }
    },

    expansion: {
        id: 'expansion',
        name: 'EXPANSION Ready',
        description: 'Full scale deployment for market leadership',
        icon: '📈',
        funding: 250000000,
        timeline: '60 meses',
        unitsPerYear: [0, 0, 0, 200, 300],
        focus: 'Market Leadership + Geographic Expansion',
        
        // Financing structure
        seriesA: 80000000,
        ventureDebtLineAvailable: 100000000,
        commercialDebtLineAvailable: 300000000,
        
        // Aggressive parameters
        tasaInteres: 25.5,
        downPaymentPercentage: 15,
        pdStage1: 0.008,
        
        // Full debt utilization
        ventureDebtYear1: 50000000, ventureDebtYear2: 50000000, ventureDebtYear3: 0, ventureDebtYear4: 0, ventureDebtYear5: 0,
        commercialDebtYear1: 0, commercialDebtYear2: 0, commercialDebtYear3: 100000000, commercialDebtYear4: 100000000, commercialDebtYear5: 100000000,
        partnerCapitalizationYear1: 50000000, partnerCapitalizationYear2: 50000000, partnerCapitalizationYear3: 0, partnerCapitalizationYear4: 0, partnerCapitalizationYear5: 0,
        seriesB_newInvestors_year2: 0, seriesB_newInvestors_year3: 70000000,
        
        expectedOutcomes: {
            tirEquity: '25-35%',
            cashFlowPositive: 'Year 3',
            totalUnits: 500,
            riskLevel: 'High'
        }
    }
};

/**
 * Aplicar escenario predefinido
 */
function applyScenario(scenarioId) {
    const scenario = strategicScenarios[scenarioId];
    if (!scenario) return false;
    
    log(`🎯 Applying scenario: ${scenario.name}`);
    
    // Apply all scenario parameters to modelData
    Object.keys(scenario).forEach(key => {
        if (key !== 'id' && key !== 'name' && key !== 'description' && 
            key !== 'icon' && key !== 'timeline' && key !== 'focus' && 
            key !== 'expectedOutcomes' && modelData.hasOwnProperty(key)) {
            modelData[key] = scenario[key];
        }
    });
    
    // Update UI controls to reflect new values
    updateAllControlsFromModelData();
    
    // Force recalculation
    forceCalculate();
    
    // Update active scenario indicator
    updateActiveScenarioIndicator(scenarioId);
    
    log(`✅ Scenario ${scenario.name} applied successfully`);
    return true;
}

/**
 * Actualizar todos los controles UI con valores de modelData
 */
function updateAllControlsFromModelData() {
    // Update all inputs that have corresponding modelData values
    Object.keys(modelData).forEach(key => {
        if (Array.isArray(modelData[key])) {
            // Handle arrays (like unitsPerYear, opexRates)
            modelData[key].forEach((value, index) => {
                const input = document.getElementById(`${key}-${index + 1}`);
                if (input) input.value = value;
            });
        } else {
            // Handle single values
            const input = document.getElementById(`${key}-input`) || document.getElementById(key);
            if (input) {
                input.value = modelData[key];
                // Trigger change event to update displays
                input.dispatchEvent(new Event('input'));
            }
        }
    });
    
    // Update summary displays
    updatePackageSummary();
    updateCapitalSummaryDashboard();
}

/**
 * Crear botones de escenarios en el header
 */
function createScenarioButtons() {
    const header = document.querySelector('header');
    let scenarioContainer = document.getElementById('scenario-buttons');
    
    if (!scenarioContainer) {
        scenarioContainer = document.createElement('div');
        scenarioContainer.id = 'scenario-buttons';
        scenarioContainer.className = 'mt-6 flex flex-wrap justify-center gap-3';
        header.appendChild(scenarioContainer);
    }
    
    scenarioContainer.innerHTML = `
        <div class="w-full text-center mb-4">
            <h3 class="text-lg font-semibold text-slate-300 mb-2">🎯 Strategic Scenarios</h3>
            <p class="text-sm text-slate-400">Choose a predefined strategy or optimize current configuration</p>
        </div>
        
        <div class="flex flex-wrap justify-center gap-3 mb-4">
            ${Object.values(strategicScenarios).map(scenario => `
                <button onclick="applyScenario('${scenario.id}')" 
                        id="scenario-btn-${scenario.id}"
                        class="scenario-btn px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg transition-all duration-200 min-w-[160px]">
                    <div class="text-2xl mb-1">${scenario.icon}</div>
                    <div class="font-semibold text-white text-sm">${scenario.name}</div>
                    <div class="text-xs text-slate-400 mt-1">${scenario.timeline}</div>
                    <div class="text-xs text-emerald-400 mt-1">${scenario.expectedOutcomes.tirEquity}</div>
                </button>
            `).join('')}
        </div>
        
        <div class="flex justify-center gap-3">
            <button onclick="optimizeCapitalStructure()" 
                    class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-medium transition-all duration-200">
                🤖 Auto-Optimize WACC
            </button>
            <button onclick="openScenarioComparison()" 
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium transition-all duration-200">
                📊 Compare Scenarios
            </button>
        </div>
        
        <div id="active-scenario-indicator" class="mt-3 text-center hidden">
            <div class="inline-block px-3 py-1 bg-sky-900 border border-sky-600 rounded-full text-xs text-sky-200">
                <span id="active-scenario-name">No scenario active</span>
            </div>
        </div>
    `;
}

/**
 * Actualizar indicador de escenario activo
 */
function updateActiveScenarioIndicator(scenarioId) {
    const indicator = document.getElementById('active-scenario-indicator');
    const nameElement = document.getElementById('active-scenario-name');
    
    if (indicator && nameElement) {
        const scenario = strategicScenarios[scenarioId];
        indicator.classList.remove('hidden');
        nameElement.textContent = `${scenario.icon} ${scenario.name} - ${scenario.focus}`;
        
        // Update button styles
        document.querySelectorAll('.scenario-btn').forEach(btn => {
            btn.classList.remove('border-sky-500', 'bg-sky-900');
            btn.classList.add('border-slate-600', 'bg-slate-800');
        });
        
        const activeBtn = document.getElementById(`scenario-btn-${scenarioId}`);
        if (activeBtn) {
            activeBtn.classList.remove('border-slate-600', 'bg-slate-800');
            activeBtn.classList.add('border-sky-500', 'bg-sky-900');
        }
    }
}

/**
 * Motor de optimización automática de estructura de capital
 */
function optimizeCapitalStructure() {
    log('🤖 Starting WACC optimization...');
    
    const currentCapex = calculateTotalCapex();
    const availableFunding = calculateTotalAvailableFunding();
    
    if (currentCapex > availableFunding) {
        alert(`⚠️ Cannot optimize: CAPEX (${formatCurrency(currentCapex)}) exceeds available funding (${formatCurrency(availableFunding)})`);
        return;
    }
    
    // Calculate optimal debt/equity mix to minimize WACC
    const optimizationResults = calculateOptimalMix(currentCapex);
    
    // Apply optimization results
    applyOptimizationResults(optimizationResults);
    
    // Show optimization summary
    showOptimizationSummary(optimizationResults);
}

function calculateOptimalMix(totalCapexNeeded) {
    const scenarios = [];
    
    // Test different debt/equity ratios
    for (let debtRatio = 0.3; debtRatio <= 0.8; debtRatio += 0.1) {
        const debtAmount = totalCapexNeeded * debtRatio;
        const equityAmount = totalCapexNeeded * (1 - debtRatio);
        
        // Distribute debt optimally (cheaper first)
        let ventureDebt = Math.min(debtAmount * 0.3, modelData.ventureDebtLineAvailable);
        let commercialDebt = Math.min(debtAmount - ventureDebt, modelData.commercialDebtLineAvailable);
        
        if (ventureDebt + commercialDebt < debtAmount) continue; // Skip if can't fund
        
        // Calculate WACC for this mix
        const wacc = calculateWACC(equityAmount, ventureDebt, commercialDebt);
        const dscr = calculateProjectedDSCR(ventureDebt, commercialDebt);
        
        scenarios.push({
            debtRatio,
            equityAmount,
            ventureDebt,
            commercialDebt,
            wacc,
            dscr,
            feasible: dscr >= 1.5 // Minimum DSCR requirement
        });
    }
    
    // Find optimal feasible scenario
    const feasibleScenarios = scenarios.filter(s => s.feasible);
    
    if (feasibleScenarios.length === 0) {
        // If no feasible scenarios, return best available scenario with warning
        const bestAvailable = scenarios.reduce((best, current) => 
            current.dscr > best.dscr ? current : best
        );
        log(`⚠️ No feasible scenarios found (DSCR >= 1.5). Using best available with DSCR: ${bestAvailable.dscr.toFixed(2)}x`);
        return {
            optimal: bestAvailable,
            allScenarios: scenarios,
            currentWACC: calculateCurrentWACC(),
            warning: 'No feasible scenarios found with DSCR >= 1.5'
        };
    }
    
    const optimal = feasibleScenarios.reduce((best, current) => 
        current.wacc < best.wacc ? current : best
    );
    
    return {
        optimal,
        allScenarios: scenarios,
        currentWACC: calculateCurrentWACC()
    };
}

function calculateWACC(equity, ventureDebt, commercialDebt) {
    const totalCapital = equity + ventureDebt + commercialDebt;
    const equityWeight = equity / totalCapital;
    const vdWeight = ventureDebt / totalCapital;
    const cdWeight = commercialDebt / totalCapital;
    
    // Simplified WACC (assuming cost of equity = 20%)
    const costOfEquity = 0.20;
    const costOfVD = modelData.ventureDebtRate / 100;
    const costOfCD = modelData.commercialDebtRate / 100;
    const taxRate = modelData.corporateTaxRate / 100;
    
    return (equityWeight * costOfEquity) + 
           (vdWeight * costOfVD * (1 - taxRate)) + 
           (cdWeight * costOfCD * (1 - taxRate));
}

function calculateCurrentWACC() {
    const totalEquity = calculateTotalEquityRaised();
    const totalDebt = calculateTotalDebtRaised();
    return calculateWACC(totalEquity, totalDebt * 0.5, totalDebt * 0.5);
}

function calculateProjectedDSCR(ventureDebt, commercialDebt) {
    // Simplified DSCR calculation
    const totalDebt = ventureDebt + commercialDebt;
    const annualDebtService = totalDebt * 0.25; // Assuming 25% annual service
    const projectedEBITDA = totalDebt * 0.4; // Assuming 40% EBITDA/Debt ratio
    return projectedEBITDA / annualDebtService;
}

function calculateTotalAvailableFunding() {
    let totalFunding = modelData.seriesA;
    totalFunding += modelData.ventureDebtLineAvailable;
    totalFunding += modelData.commercialDebtLineAvailable;
    
    for (let i = 1; i <= 5; i++) {
        totalFunding += (modelData[`partnerCapitalizationYear${i}`] || 0);
        totalFunding += (modelData[`seriesB_newInvestors_year${i}`] || 0);
    }
    
    return totalFunding;
}

function applyOptimizationResults(results) {
    const optimal = results.optimal;
    
    // Distribute funding across years intelligently
    const totalUnits = modelData.unitsPerYear.reduce((a, b) => a + b, 0);
    let remainingVD = optimal.ventureDebt;
    let remainingCD = optimal.commercialDebt;
    
    // Reset all debt allocations
    for (let year = 1; year <= 5; year++) {
        modelData[`ventureDebtYear${year}`] = 0;
        modelData[`commercialDebtYear${year}`] = 0;
    }
    
    // Allocate debt based on unit deployment
    for (let year = 0; year < 5; year++) {
        const yearUnits = modelData.unitsPerYear[year];
        if (yearUnits > 0 && (remainingVD > 0 || remainingCD > 0)) {
            const yearCapex = yearUnits * getTotalPackageCost();
            
            // Use venture debt first (if cheaper), then commercial
            if (remainingVD > 0) {
                const vdThisYear = Math.min(remainingVD, yearCapex * 0.6);
                modelData[`ventureDebtYear${year + 1}`] = vdThisYear;
                remainingVD -= vdThisYear;
            }
            
            if (remainingCD > 0) {
                const cdThisYear = Math.min(remainingCD, yearCapex * 0.8);
                modelData[`commercialDebtYear${year + 1}`] = cdThisYear;
                remainingCD -= cdThisYear;
            }
        }
    }
    
    // Update Series A if needed for equity portion
    const currentEquity = calculateTotalEquityRaised();
    if (currentEquity < optimal.equityAmount) {
        modelData.seriesA += (optimal.equityAmount - currentEquity);
    }
    
    // Refresh UI and recalculate
    updateAllControlsFromModelData();
    forceCalculate();
}

function showOptimizationSummary(results) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-slate-800 p-6 rounded-lg max-w-2xl mx-4 border ${results.warning ? 'border-amber-500' : 'border-emerald-500'} max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-semibold ${results.warning ? 'text-amber-400' : 'text-emerald-400'} mb-4">🤖 WACC Optimization Results</h3>
            
            ${results.warning ? `
                <div class="mb-4 p-3 bg-amber-900/30 border border-amber-600 rounded">
                    <div class="text-amber-300 text-sm">⚠️ ${results.warning}</div>
                </div>
            ` : ''}
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-3 bg-slate-900 rounded border">
                    <div class="text-sm text-slate-400">Previous WACC</div>
                    <div class="text-xl font-bold text-red-400">${(results.currentWACC * 100).toFixed(1)}%</div>
                </div>
                <div class="p-3 bg-slate-900 rounded border">
                    <div class="text-sm text-slate-400">Optimized WACC</div>
                    <div class="text-xl font-bold ${results.warning ? 'text-amber-400' : 'text-emerald-400'}">${(results.optimal.wacc * 100).toFixed(1)}%</div>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="font-semibold text-white mb-2">Optimal Capital Structure:</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-300">Equity:</span>
                        <span class="text-sky-300">${formatCurrency(results.optimal.equityAmount)} (${(results.optimal.equityAmount / (results.optimal.equityAmount + results.optimal.ventureDebt + results.optimal.commercialDebt) * 100).toFixed(0)}%)</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-300">Venture Debt:</span>
                        <span class="text-purple-300">${formatCurrency(results.optimal.ventureDebt)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-300">Commercial Debt:</span>
                        <span class="text-blue-300">${formatCurrency(results.optimal.commercialDebt)}</span>
                    </div>
                    <div class="flex justify-between border-t border-slate-600 pt-2">
                        <span class="text-slate-300 font-medium">DSCR:</span>
                        <span class="${results.optimal.dscr >= 1.5 ? 'text-emerald-300' : 'text-amber-300'} font-bold">${results.optimal.dscr.toFixed(1)}x</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="this.closest('.fixed').remove();" 
                        class="flex-1 ${results.warning ? 'bg-amber-600 hover:bg-amber-500' : 'bg-emerald-600 hover:bg-emerald-500'} text-white px-4 py-2 rounded">
                    ✅ Applied - Close
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

/**
 * Abrir modal de comparación de escenarios
 */
function openScenarioComparison() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-slate-800 p-6 rounded-lg max-w-6xl mx-4 border border-blue-500 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-semibold text-blue-400 mb-4">📊 Scenario Comparison Analysis</h3>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-slate-600">
                            <th class="text-left p-2 text-slate-300">Metric</th>
                            <th class="text-center p-2 text-emerald-400">🌱 SEED</th>
                            <th class="text-center p-2 text-sky-400">🚀 SERIE A</th>
                            <th class="text-center p-2 text-purple-400">📈 EXPANSION</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-table-body">
                        <!-- Content will be populated by generateComparisonData() -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 p-4 bg-slate-900 rounded border border-slate-600">
                <h4 class="font-semibold text-white mb-2">💡 Strategic Recommendations</h4>
                <div id="strategic-recommendations" class="text-sm text-slate-300 space-y-1">
                    <!-- Recommendations will be generated -->
                </div>
            </div>
            
            <div class="flex justify-between mt-6">
                <button onclick="exportComparisonToPDF()" 
                        class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded">
                    📄 Export PDF
                </button>
                <button onclick="this.closest('.fixed').remove();" 
                        class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded">
                    Close
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Populate comparison data
    generateComparisonData();
}

function generateComparisonData() {
    const comparisonMetrics = [
        { label: 'Total Funding Required', key: 'funding', format: val => formatCurrency(val) },
        { label: 'Timeline', key: 'timeline', format: val => val },
        { label: 'Total Units (5Y)', key: 'totalUnits', format: val => val.toLocaleString() },
        { label: 'Expected TIR Equity', key: 'expectedTirEquity', format: val => val },
        { label: 'Cash Flow Positive', key: 'cashFlowPositive', format: val => val },
        { label: 'Risk Level', key: 'riskLevel', format: val => val },
        { label: 'Capital Efficiency', key: 'capitalEfficiency', format: val => formatCurrency(val) + '/unit' },
        { label: 'Max Debt/Equity Ratio', key: 'maxDebtEquity', format: val => val.toFixed(1) + 'x' }
    ];
    
    const tbody = document.getElementById('comparison-table-body');
    tbody.innerHTML = comparisonMetrics.map(metric => {
        const seedValue = getScenarioMetric('seed', metric.key);
        const serieAValue = getScenarioMetric('serieA', metric.key);
        const expansionValue = getScenarioMetric('expansion', metric.key);
        
        return `
            <tr class="border-b border-slate-700">
                <td class="p-2 text-slate-300 font-medium">${metric.label}</td>
                <td class="p-2 text-center text-emerald-300">${metric.format(seedValue)}</td>
                <td class="p-2 text-center text-sky-300">${metric.format(serieAValue)}</td>
                <td class="p-2 text-center text-purple-300">${metric.format(expansionValue)}</td>
            </tr>
        `;
    }).join('');
    
    // Generate strategic recommendations
    generateStrategicRecommendations();
}

function getScenarioMetric(scenarioId, metricKey) {
    const scenario = strategicScenarios[scenarioId];
    
    switch(metricKey) {
        case 'funding': return scenario.funding;
        case 'timeline': return scenario.timeline;
        case 'totalUnits': return scenario.unitsPerYear.reduce((a, b) => a + b, 0);
        case 'expectedTirEquity': return scenario.expectedOutcomes.tirEquity;
        case 'cashFlowPositive': return scenario.expectedOutcomes.cashFlowPositive;
        case 'riskLevel': return scenario.expectedOutcomes.riskLevel;
        case 'capitalEfficiency': 
            const totalUnits = scenario.unitsPerYear.reduce((a, b) => a + b, 0);
            return totalUnits > 0 ? scenario.funding / totalUnits : 0;
        case 'maxDebtEquity':
            const totalDebt = (scenario.ventureDebtLineAvailable || 0) + (scenario.commercialDebtLineAvailable || 0);
            return totalDebt / scenario.funding;
        default: return 'N/A';
    }
}

function generateStrategicRecommendations() {
    const recommendationsDiv = document.getElementById('strategic-recommendations');
    if (!recommendationsDiv) return;
    
    const recommendations = [
        "🌱 <strong>SEED Strategy:</strong> Ideal for proof-of-concept and market validation. Low risk, minimal capital requirements, focus on technology development.",
        "🚀 <strong>SERIE A Strategy:</strong> Balanced approach for post-validation scaling. Optimal debt/equity mix, controlled growth, strong unit economics.",
        "📈 <strong>EXPANSION Strategy:</strong> Aggressive market capture strategy. High capital efficiency, maximum leverage, requires strong operational capabilities.",
        "💡 <strong>Recommendation:</strong> Start with SEED for validation, transition to SERIE A for controlled scaling, then EXPANSION for market leadership.",
        "⚖️ <strong>Risk Assessment:</strong> Each scenario has different risk profiles. Consider market conditions, team capabilities, and investor appetite."
    ];
    
    recommendationsDiv.innerHTML = recommendations.map(rec => `<div>${rec}</div>`).join('');
}

function exportComparisonToPDF() {
    // Simplified PDF export functionality
    alert('📄 PDF export functionality would be implemented here. For now, you can screenshot the comparison table.');
}

// UI controls configuration by section
const controlsConfig = {
paqueteFinanciado: [
{ id: 'vanPrice', label: 'Precio Vagoneta Base', min: 650000, max: 900000, step: 5000, type: 'number', format: val => formatCurrency(val, true), tooltip: '📊 Serie A guidance: Margen >15% vs costo para unit economics defendibles', investorRange: { green: [729000, 800000], yellow: [680000, 729000], red: [650000, 680000] } },
{ id: 'conversionPrice', label: 'Precio Conversión GNV', min: 45000, max: 70000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Margen típico: 8-15% sobre costo de conversión' },
{ id: 'bancasPrice', label: 'Precio Bancas GNV', min: 18000, max: 26000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Premium sobre costo: 5-30% según diferenciación' },
{ id: 'gpsPrice', label: 'Precio GPS/Telemática', min: 11000, max: 20000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Value-add service: Margen 20-60% típico' },
{ id: 'insuranceAnnualPrice', label: 'Seguro Anual', min: 25000, max: 40000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Pass-through cost: Sin margen para RAG' },
{ id: 'insuranceYears', label: 'Años Seguro', min: 2, max: 4, step: 1, type: 'number', format: val => val.toFixed(0) + ' años', tooltip: '⚖️ Balance: Más años = mayor loan size = mejor unit economics' },
{ id: 'vanCost', label: 'Costo Vagoneta (RAG)', min: 500000, max: 700000, step: 5000, type: 'number', format: val => formatCurrency(val, true), tooltip: '🎯 Critical: Debe ser <85% del precio para margen mínimo Serie A', investorRange: { green: [500000, 580000], yellow: [580000, 620000], red: [620000, 700000] } },
{ id: 'conversionCost', label: 'Costo Conversión GNV', min: 40000, max: 65000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo directo: Incluye instalación y certificación' },
{ id: 'bancasCost', label: 'Costo Bancas GNV', min: 17000, max: 24000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo manufacturng: Base para pricing strategy' },
{ id: 'gpsCost', label: 'Costo GPS/Telemática', min: 9000, max: 18000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Hardware + instalación: Optimizar para escala' },
],
condicionesCredito: [
{ id: 'tasaInteres', label: 'Tasa de Interés (Clientes)', min: 24, max: 28, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: "Palanca clave de rentabilidad. El rango 24-28% balancea la competitividad del mercado (nuestro lema 'tasas justas') con la viabilidad financiera requerida para la Serie A.", investorRange: { green: [25, 28], yellow: [24, 25], red: [28, 35] } },
{ id: 'downPaymentPercentage', label: '% Enganche Cliente', min: 12, max: 20, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: "Balance entre accesibilidad para el cliente y flujo de caja para RAG. Por debajo del 12% aumenta nuestro riesgo; por encima del 20% limita nuestro mercado objetivo.", investorRange: { green: [15, 20], yellow: [12, 15], red: [20, 25] } },
{ id: 'clientLoanTermYears', label: 'Plazo Préstamo Cliente (Años)', min: 3, max: 5, step: 1, type: 'range', format: val => val.toFixed(0) + ' años', tooltip: '⚖️ Payment vs interest: 4 años = optimal balance. 3 años = high payments, 5+ años = interest rate risk', investorRange: { green: [4, 4], yellow: [3, 4], red: [5, 5] } },
{ id: 'upfrontCommissionPercentage', label: '% Comisión Upfront', min: 1, max: 6, step: 0.1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'NIIF 15 deferral: 2-3% típico para cash flow inicial sin penalizar accesibilidad' },
],
ingresosAdicionales: [
{ id: 'litrosPromedioMensualPorUnidad', label: 'Litros GNV/Unidad (Mensual)', min: 800, max: 1000, step: 10, type: 'number', format: val => val.toFixed(0) + ' L', tooltip: 'Usage pattern: 900L = optimal efficiency. Dependiente de rutas y utilización' },
{ id: 'precioLitroGNV', label: 'Precio Litro GNV (MXN)', min: 12.50, max: 13.99, step: 0.01, type: 'number', format: val => '$' + val.toFixed(2) + ' MXN', tooltip: 'Market price: RAG no controla, pero impacta commission revenue' },
{ id: 'comisionGNVPorcentaje', label: 'Comisión GNV (%)', min: 8, max: 15, step: 0.1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: '🚀 Recurring revenue: 10-12% competitive. <8% = low value capture, >13% = partner resistance' },
{ id: 'gmvPromedioMensualPorUnidad', label: 'Ventas Brutas Marketplace/Unidad (Mensual)', min: 6000, max: 12000, step: 100, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Marketplace traction: $9K = baseline, growth dependent on platform adoption' },
{ id: 'takeRateMarketplace', label: 'Take Rate Marketplace (%)', min: 1.5, max: 3.0, step: 0.1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Platform economics: 2% competitive vs other B2B marketplaces. Limited upside near-term' },
{ id: 'refaccionesCostPerUnit', label: 'Costo Refacciones/Unidad', min: 5000, max: 10000, step: 200, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Service cost base: Optimizar para margen pero mantener quality' },
{ id: 'margenRefacciones', label: 'Margen Refacciones', min: 20, max: 35, step: 1, type: 'range', format: val => val.toFixed(0) + '%', tooltip: '🔧 Service margin: 25-30% realistic. <20% = low profitability, >35% = price resistance' },
],
planCrecimiento: [
{ id: 'unitsPerYear', label: 'Unidades por Año', type: 'array', min: 0, max: 2000, step: 10, format: val => val.toFixed(0), tooltip: 'El crecimiento está limitado por el capital disponible. El modelo no permitirá financiar más unidades de las que el capital total (Equity + Deuda) puede cubrir para evitar un flujo de caja negativo.' },
{ id: 'opexRates', label: 'Tasa OPEX por Año (%)', type: 'array', min: 12, max: 20, step: 0.5, format: val => val.toFixed(1) + '%', tooltip: 'Eficiencia operativa por año. Se espera que disminuya con la escala.' },
{ id: 'depreciationYears', label: 'Años Depreciación (Vagoneta)', min: 8, max: 12, step: 1, type: 'number', format: val => val.toFixed(0) + ' años', tooltip: 'Asset life: 10 años = standard. 8 años = conservative, 12 años = aggressive' },
],
riesgoYSalida: [
{ id: 'proteccionRodando', label: 'Protección Rodando™', type: 'checkbox', tooltip: "Activa nuestro foso competitivo clave. Reduce las provisiones NIIF 9 en un 50%, cuantificando el impacto de nuestra tecnología de intervención proactiva para estabilizar la cartera." },
{ id: 'pdStage1', label: 'PD Etapa 1 (12M)', min: 0.003, max: 0.012, step: 0.001, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: '📊 Serie A reality check: 0.8% es una base conservadora. <0.5% = optimista, >1.2% = riesgo alto.', investorRange: { green: [0.004, 0.008], yellow: [0.003, 0.004], red: [0.008, 0.012] } },
{ id: 'pdStage2', label: 'PD Etapa 2 (Lifetime)', min: 0.06, max: 0.12, step: 0.005, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: '⚖️ Lifetime default: 7-10% benchmark. <6% = optimistic, >12% = high risk segment', investorRange: { green: [0.07, 0.10], yellow: [0.06, 0.07], red: [0.10, 0.12] } },
{ id: 'pdStage3', label: 'PD Etapa 3 (Lifetime)', min: 0.30, max: 0.50, step: 0.01, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: '🚨 Impaired assets: 35-45% realistic. <30% = recovery overestimate, >50% = write-off territory' },
{ id: 'lgd', label: 'LGD (Pérdida Incumplimiento)', min: 0.45, max: 0.60, step: 0.01, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: '💔 Loss severity: 50-55% typical for vehicle collateral. Asset depreciation + recovery costs' },
{ id: 'portfolioAllocationStage1', label: 'Port. Etapa 1 (%)', min: 0.75, max: 0.90, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '✅ Healthy portfolio: 80-87% in Stage 1. >90% = unrealistic, <75% = risk concentration' },
{ id: 'portfolioAllocationStage2', label: 'Port. Etapa 2 (%)', min: 0.08, max: 0.18, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '⚠️ Watch list: 10-15% normal. <8% = understated, >18% = portfolio stress' },
{ id: 'portfolioAllocationStage3', label: 'Port. Etapa 3 (%)', min: 0.02, max: 0.08, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '🚨 Problem loans: 3-6% manageable. >8% = collection issues, <2% = unrealistic' },
{ id: 'tasaReposicion', label: '% Unidades Reposición', min: 3, max: 7, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%', tooltip: '🔄 Repossession rate: 4-6% realistic. <3% = recovery overestimate, >7% = business model stress' },
{ id: 'fairValueVenta', label: '% Fair Value Venta', min: 75, max: 90, step: 1, type: 'number', format: val => val.toFixed(0) + '%', tooltip: '💰 Recovery value: 85% reasonable for well-maintained vehicles. Market dependent' },
{ id: 'costosVenta', label: '% Costos Venta', min: 4, max: 8, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%', tooltip: '💸 Transaction costs: 5-6% typical (storage, auction, legal, transport)' },
{ id: 'ebitdaMultipleProject', label: 'Múltiplo EBITDA TIR', min: 6, max: 9, step: 0.5, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: '🎯 Tech-enabled equipment finance: 6-8x base, hasta 9x con plataforma IA/data. RAG target: 7.5x.' },
{ id: 'floorEquityMultiple', label: 'Múltiplo Valor en Libros (P/B)', min: 1.2, max: 1.8, step: 0.1, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: "Floor value protection. 1.2-1.4x conservative, 1.4-1.6x growth, 1.6x+ aggressive. Solo como valor mínimo vs EBITDA multiple." },
{ id: 'ventureDebtRate', label: 'Tasa Venture Debt', min: 17.0, max: 21.0, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: "Costo del capital de crecimiento. 18-19% es el estándar del mercado mexicano. Tasas superiores impactan la TIR y el DSCR." },
{ id: 'commercialDebtRate', label: 'Tasa Deuda Comercial', min: 13.0, max: 16.0, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: "Costo del capital de escala. 14-15% es el estándar para deuda bancaria en esta etapa." }
],
};

// Object to store calculated financial results
let financialResults = {
pl: [], // Profit & Loss
cf: [], // Cash Flow
bs: [], // Balance Sheet
niifDetails: [], // IFRS application details
tirProyecto: 0, // Project Internal Rate of Return
tirCartera: 0, // Customer Portfolio Internal Rate of Return
tirEquity: 0, // Equity Internal Rate of Return
roe: [], // Annual Return on Equity
roic: [] // Annual Return on Invested Capital
};

// New global array for IFRS 5 assets
let heldForSaleAssets = [];

// Tolerance for balance sheet validation (MXN)
const BALANCE_TOLERANCE = 1000;
// ===================================================================
// ===== FASE 2: MOTOR DE CÁLCULO FINANCIERO (EL CÓMO) ============
// ===================================================================
// (Aquí se encuentran todas las funciones de cálculo puro que no tocan el DOM)

/**
* Formats a numeric value to currency format (millions, thousands, or no prefix).
* @param {number} value - The numeric value to format.
* @param {boolean} [full=false] - If true, use full format with commas; otherwise, use abbreviations.
* @returns {string} The value formatted as a string.
*/
function formatCurrency(value, full = false) {
if (value === null || value === undefined || isNaN(value)) return '$0 MXN';
value = parseFloat(value);

if (full) {
return '$' + value.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' MXN';
} else if (Math.abs(value) >= 1000000) {
return '$' + (value / 1000000).toFixed(1) + 'M';
} else if (Math.abs(value) >= 1000) {
return '$' + (value / 1000).toFixed(1) + 'K';
}
return '$' + Math.round(value).toLocaleString();
}
/**
* Calculates the total price of financed insurance.
* @returns {number}
*/
function getInsuranceTotalPrice() {
return modelData.insuranceAnnualPrice * modelData.insuranceYears;
}
/**
* Calculates the TOTAL PRICE of the complete package.
* @returns {number}
*/
function getTotalPackagePrice() {
return modelData.vanPrice + modelData.conversionPrice +
modelData.bancasPrice + modelData.gpsPrice + getInsuranceTotalPrice();
}
/**
* Calculates the TOTAL COST of the package for RAG.
* @returns {number}
*/
function getTotalPackageCost() {
// Insurance has no cost for RAG (pass-through)
return modelData.vanCost + modelData.conversionCost +
modelData.bancasCost + modelData.gpsCost;
}
/**
* Calculates the total CAPEX required based on current units.
* @returns {number} Total CAPEX in MXN.
*/
function calculateTotalCapex() {
let totalCapex = 0;
for (let i = 0; i < modelData.unitsPerYear.length; i++) {
totalCapex += modelData.unitsPerYear[i] * getTotalPackageCost();
}
return totalCapex;
}
/**
* Calculates the total available funding based on the PLAN.
* @returns {number} Total funding in MXN.
*/
function calculateTotalFunding() {
let totalFunding = modelData.seriesA;
for (let i = 1; i <= 5; i++) {
totalFunding += (plannedFinancingData[`partnerCapitalizationYear${i}`] || 0) +
(plannedFinancingData[`ventureDebtYear${i}`] || 0) +
(plannedFinancingData[`commercialDebtYear${i}`] || 0) +
(plannedFinancingData[`seriesB_newInvestors_year${i}`] || 0);
}
return totalFunding;
}
/**
* NEW: Calculates the total debt raised over the projection period based on OPTIMIZED values.
* @returns {number} Total debt raised in MXN.
*/
function calculateTotalDebtRaised() {
let total = 0;
for (let i = 1; i <= 5; i++) {
total += (modelData[`ventureDebtYear${i}`] || 0);
total += (modelData[`commercialDebtYear${i}`] || 0);
}
return total;
}
/**
* NEW: Calculates the total equity raised over the projection period based on OPTIMIZED values.
* @returns {number} Total equity raised in MXN.
*/
function calculateTotalEquityRaised() {
let total = modelData.seriesA;
for (let i = 1; i <= 5; i++) {
total += (modelData[`partnerCapitalizationYear${i}`] || 0) +
(modelData[`seriesB_newInvestors_year${i}`] || 0);
}
return total;
}
/**
* Calculates the residual balance of Venture Debt for a given year.
* @param {number} year - The projection year (1-5).
* @returns {number} The residual balance of Venture Debt.
*/
function getVentureDebtBalance(year, debtCohorts) {
    let balance = 0;
    debtCohorts.forEach(cohort => {
        const yearsPassed = year - cohort.yearOriginated;
        if (yearsPassed >= 0) {
            const principalPaid = (cohort.originalAmount / modelData.periodoAmortizacionDeuda) * yearsPassed;
            balance += cohort.originalAmount - principalPaid;
        }
    });
    return Math.max(0, balance);
}
/**
* Calculates the residual balance of Commercial Debt for a given year.
* @param {number} year - The projection year (1-5).
* @returns {number} The residual balance of Commercial Debt.
*/
function getCommercialDebtBalance(year, debtCohorts) {
    let balance = 0;
    debtCohorts.forEach(cohort => {
        const yearsPassed = year - cohort.yearOriginated;
        if (yearsPassed >= 0) {
            const principalPaid = (cohort.originalAmount / modelData.periodoAmortizacionDeuda) * yearsPassed;
            balance += cohort.originalAmount - principalPaid;
        }
    });
    return Math.max(0, balance);
}

/**
 * NUEVO: Calcula las necesidades de financiamiento año por año con lógica de cascada, respetando las líneas de crédito.
 */
function calculateYearlyFinancingNeeds(year, capexThisYear, operatingCashFlow, startingCash, debtCohorts) {
    const currentYear = year + 1;
    const bufferCash = 5000000; // 5M buffer mínimo

    const totalCashNeed = capexThisYear + Math.max(0, -operatingCashFlow) + bufferCash;
    let remainingNeed = Math.max(0, totalCashNeed - startingCash);

    let sourcingPlan = {
        useExistingCash: Math.min(startingCash, totalCashNeed),
        newEquity: 0,
        newVentureDebt: 0,
        newCommercialDebt: 0
    };

    if (remainingNeed <= 0) return sourcingPlan;

    // Equity is assumed to be fully available as planned
    const plannedEquity = (plannedFinancingData[`partnerCapitalizationYear${currentYear}`] || 0) +
                          (plannedFinancingData[`seriesB_newInvestors_year${currentYear}`] || 0);
    if (plannedEquity > 0 && remainingNeed > 0) {
        const equityToUse = Math.min(plannedEquity, remainingNeed);
        sourcingPlan.newEquity = equityToUse;
        remainingNeed -= equityToUse;
    }

    // Planned Debt Drawdowns
    const plannedVentureDebt = plannedFinancingData[`ventureDebtYear${currentYear}`] || 0;
    const plannedCommercialDebt = plannedFinancingData[`commercialDebtYear${currentYear}`] || 0;
    
    // Use planned debt first
    if(plannedVentureDebt > 0 && remainingNeed > 0) {
        const debtToUse = Math.min(plannedVentureDebt, remainingNeed);
        sourcingPlan.newVentureDebt += debtToUse;
        remainingNeed -= debtToUse;
    }
    if(plannedCommercialDebt > 0 && remainingNeed > 0) {
        const debtToUse = Math.min(plannedCommercialDebt, remainingNeed);
        sourcingPlan.newCommercialDebt += debtToUse;
        remainingNeed -= debtToUse;
    }

    // Use additional debt from available lines if still needed, prioritizing cheaper debt if available
    if (remainingNeed > 0) {
        const totalVentureDebtUsed = debtCohorts.venture.reduce((sum, cohort) => sum + cohort.originalAmount, 0) + sourcingPlan.newVentureDebt;
        const ventureLineRemaining = modelData.ventureDebtLineAvailable - totalVentureDebtUsed;
        
        const totalCommercialDebtUsed = debtCohorts.commercial.reduce((sum, cohort) => sum + cohort.originalAmount, 0) + sourcingPlan.newCommercialDebt;
        const commercialLineRemaining = modelData.commercialDebtLineAvailable - totalCommercialDebtUsed;

        // CFO Logic: Use cheaper debt first if available
        if (modelData.commercialDebtRate < modelData.ventureDebtRate && commercialLineRemaining > 0) {
            const additionalCommercial = Math.min(remainingNeed, commercialLineRemaining);
            sourcingPlan.newCommercialDebt += additionalCommercial;
            remainingNeed -= additionalCommercial;
        }

        // Then use Venture Debt
        if (remainingNeed > 0 && ventureLineRemaining > 0) {
            const additionalVenture = Math.min(remainingNeed, ventureLineRemaining);
            sourcingPlan.newVentureDebt += additionalVenture;
            remainingNeed -= additionalVenture;
        }
        
        // Then use any remaining Commercial Debt
        if (remainingNeed > 0 && commercialLineRemaining > (sourcingPlan.newCommercialDebt - plannedCommercialDebt)) {
             const additionalCommercial = Math.min(remainingNeed, commercialLineRemaining - (sourcingPlan.newCommercialDebt - plannedCommercialDebt));
            sourcingPlan.newCommercialDebt += additionalCommercial;
            remainingNeed -= additionalCommercial;
        }
    }


    if (remainingNeed > 1000000) {
        log(`⚠️ FUNDING GAP Year ${currentYear}: ${formatCurrency(remainingNeed)} sin financiar. Revisar líneas de crédito o plan de unidades.`);
    }

    return sourcingPlan;
}

/**
* Calculates the final Debt Service Coverage Ratio.
* @returns {number} DSCR based on Year 5 EBITDA and total debt service.
*/
function calculateFinalDSCR() {
if (!financialResults.pl || financialResults.pl.length < 5) return 0;

const year5EBITDA = financialResults.pl[4].ebitda;
const year5Debt = financialResults.bs[4].debt;
const year5Interest = financialResults.pl[4].interestExpense;
const year5PrincipalRepayment = financialResults.cf[4].debtPrincipalRepayment;

const totalDebtService = year5Interest + year5PrincipalRepayment;

return totalDebtService > 0 ? year5EBITDA / totalDebtService : 999;
}
/**
* Calculates granular debt metrics for Serie A analysis.
* @returns {Object} Debt metrics breakdown.
*/
function calculateDebtMetricsBreakdown() {
const finalDSCR = calculateFinalDSCR();

return {
finalDSCR: finalDSCR,
isHealthyDSCR: finalDSCR >= 1.5,
riskLevel: finalDSCR >= 2.0 ? 'low' : finalDSCR >= 1.5 ? 'medium' : 'high'
};
}

/**
* Calculates projected debt service coverage ratio.
* @returns {Object} DSCR analysis.
*/
function calculateDebtServiceCoverage() {
const totalVentureDebt = calculateTotalDebtRaised();
const totalCommercialDebt = 0; // Simplified for this check
const ventureInterest = totalVentureDebt * (modelData.ventureDebtRate / 100);
const commercialInterest = totalCommercialDebt * (modelData.commercialDebtRate / 100);
const totalDebtService = ventureInterest + commercialInterest;

// Conservative EBITDA estimate based on funding and margins
const estimatedRevenue = calculateTotalFunding() * 0.8; // 80% capital efficiency
const estimatedEBITDA = estimatedRevenue * 0.25; // 25% EBITDA margin target

const dscr = totalDebtService > 0 ? estimatedEBITDA / totalDebtService : 999;

return {
totalDebtService,
estimatedEBITDA,
dscr,
isHealthy: dscr >= 1.5,
maxSafeVentureRate: totalVentureDebt > 0 ? (estimatedEBITDA * 0.2) / totalVentureDebt * 100 : 20,
maxSafeCommercialRate: totalCommercialDebt > 0 ? (estimatedEBITDA * 0.15) / totalCommercialDebt * 100 : 16
};
}
/**
* Evaluates unit economics health.
* @returns {Object} Unit economics analysis.
*/
function evaluateUnitEconomics() {
const totalPrice = getTotalPackagePrice();
const totalCost = getTotalPackageCost();
const margin = totalPrice - totalCost;
const marginPercent = totalPrice > 0 ? (margin / totalPrice) * 100 : 0;

return {
margin,
marginPercent,
isHealthy: marginPercent >= 15,
investorGrade: marginPercent >= 20 ? 'excellent' : marginPercent >= 15 ? 'good' : marginPercent >= 10 ? 'concerning' : 'critical'
};
}

function calculateSeriesAMetrics() {
    if (!financialResults.pl || financialResults.pl.length < 5) return {};

    const totalUnits = financialResults.pl.reduce((sum, pl) => sum + (pl.addedUnits || 0), 0);
    const totalCapex = totalUnits * getTotalPackageCost();
    const year5Index = financialResults.pl.length - 1;

    const capitalPerUnit = totalUnits > 0 ? totalCapex / totalUnits : 0;

    // --- NEW: Net Interest Margin (NIM) Calculation for Year 5 ---
    const year5PL = financialResults.pl[4];
    const year4BS = financialResults.bs[3];
    const year5BS = financialResults.bs[4];
    
    const interestRevenueY5 = year5PL.interestRevenue || 0;
    const interestExpenseY5 = year5PL.interestExpense || 0;
    
    const startOfYearReceivables = year4BS.receivables || 0;
    const endOfYearReceivables = year5BS.receivables || 0;
    const avgEarningAssets = (startOfYearReceivables + endOfYearReceivables) / 2;
    
    const netInterestIncome = interestRevenueY5 - interestExpenseY5;
    const netInterestMargin = avgEarningAssets > 0 ? (netInterestIncome / avgEarningAssets) * 100 : 0;

    const activePortfolioValue = financialResults.bs[year5Index]?.receivables || 0;

    const cumulativeRevenue = financialResults.pl.reduce((sum, pl) => sum + (pl.totalRevenue || 0), 0);
    const totalFunding = calculateTotalFunding();
    const fundingEfficiency = totalFunding > 0 ? cumulativeRevenue / totalFunding : 0;

    const currentCash = financialResults.bs[year5Index]?.cash || 0;
    const year5Opex = financialResults.pl[year5Index]?.opex || 0;
    const monthlyBurn = year5Opex > 0 ? year5Opex / 12 : 1;
    const cashRunwayMonths = currentCash / monthlyBurn;

    const year1Units = financialResults.pl[0]?.addedUnits || 1;
    const finalYearUnits = totalUnits;
    const unitCAGR = year1Units > 0 ? (Math.pow(finalYearUnits / year1Units, 1/5) - 1) * 100 : 0;

    return {
        capitalPerUnit: capitalPerUnit / 1000,
        netInterestMargin: Math.max(0, netInterestMargin),
        activePortfolioValue: activePortfolioValue,
        fundingEfficiency: fundingEfficiency,
        cashRunwayMonths: Math.min(Math.max(0, cashRunwayMonths), 999),
        unitCAGR: Math.max(0, unitCAGR),
        benchmarks: {
            capitalPerUnitGood: capitalPerUnit / 1000 <= 750,
            netInterestMarginGood: netInterestMargin >= 4,
            fundingEfficiencyGood: fundingEfficiency >= 0.6,
            cashRunwayGood: cashRunwayMonths >= 12,
            unitCAGRGood: unitCAGR >= 30
        }
    };
}
/**
* Calculates general investor score.
* @returns {Object} Investor health score.
*/
function calculateInvestorScore() {
const unitEcon = evaluateUnitEconomics();
const debtService = calculateDebtServiceCoverage();

let score = 10;
let issues = [];

// Unit economics (40% weight)
if (unitEcon.marginPercent < 10) { score -= 4; issues.push('🚨 Unit economics críticos (<10%)'); }
else if (unitEcon.marginPercent < 15) { score -= 2; issues.push('⚠️ Unit economics bajos (<15%)'); }

// Debt service (30% weight)
if (debtService.dscr < 1.2) { score -= 3; issues.push('🚨 DSCR crítico (<1.2x)'); }
else if (debtService.dscr < 1.5) { score -= 1.5; issues.push('⚠️ DSCR bajo (<1.5x)'); }

// Risk assumptions (20% weight)
if (modelData.pdStage1 < 0.003) { score -= 1; issues.push('📊 PD Stage 1 optimista'); }
if (modelData.tasaInteres < 22) { score -= 1; issues.push('💰 Tasa cliente insostenible'); }

// Operational efficiency (10% weight)
if (modelData.opexRates.some(rate => rate > 18)) {
score -= 1;
issues.push('🚀 OPEX alto (>18% en algún año)');
}

// Enhanced debt structure analysis (10% weight)
const debtMetrics = calculateDebtMetricsBreakdown();
if (debtMetrics.finalDSCR < 1.5) {
score -= 1;
issues.push('🏦 DSCR final bajo (<1.5x)');
}
if (financialResults.bs.length > 4 && financialResults.bs[4].equity > 0 && financialResults.bs[4].debt > financialResults.bs[4].equity * 2) {
score -= 0.5;
issues.push('📊 Leverage alto (Debt/Equity >2x)');
}

return {
score: Math.max(0, score),
grade: score >= 8.5 ? 'A' : score >= 7 ? 'B' : score >= 5 ? 'C' : 'D',
issues,
isInvestable: score >= 6.5
};
}
// ===== IFRS CALCULATION MODULES =====
/**
* Calculates the Probability of Default (PD) based on the age of the loan cohort.
* IFRS 9: Aligns with the 3-stage model, with dynamic PDs.
* @param {number} cohortAgeYears - Age of the loan in years.
* @returns {number} The adjusted probability of default.
*/
function calculatePDBasedOnAge(cohortAgeYears) {
// Dynamic rule: PD increases 50% if loan > 2 years
let basePD;
if (cohortAgeYears <= 1) { // Young loans (Year 1) -> Stage 1
basePD = modelData.pdStage1; // 12-month PD
} else if (cohortAgeYears === 2) { // 2-year loans -> Stage 2
basePD = modelData.pdStage2; // Lifetime PD (for Stage 2)
} else { // 3-year or older loans -> Stage 3
basePD = modelData.pdStage3; // Lifetime PD (for Stage 3)
// Apply dynamic adjustment: increases 50% if loan > 2 years
if (cohortAgeYears > 2) {
basePD *= 1.5;
}
}
return basePD;
}
/**
* Calculates the Expected Credit Loss (ECL) according to IFRS 9.
* Process: Iterates over loan cohorts, calculates average exposure,
* applies dynamic PD and macroeconomic adjustment factor.
* @param {Array<Object>} loanCohorts - Array of active loan cohorts.
* @param {number} currentYear - The current projection year (1-5).
* @param {number} currentProvisionsBalance - Accumulated provision balance at the beginning of the year.
* @param {number} currentYearEndReceivables - Accounts receivable balance at the end of the current year.
* @returns {Object} Contains annual provision, accumulated balance, and details by stage.
*/
function calculateNIIF9ECL(loanCohorts, currentYear, currentProvisionsBalance, currentYearEndReceivables) {
const loanTermAdjustmentFactor = modelData.clientLoanTermYears === 4 ? 0.8 : 1.0;
const adjustedPDStage1 = modelData.pdStage1 * loanTermAdjustmentFactor;
const adjustedPDStage2 = modelData.pdStage2 * loanTermAdjustmentFactor;
log(`📊 NIIF 9 - Ajuste préstamos ${modelData.clientLoanTermYears} años: Factor ${loanTermAdjustmentFactor}`);
let totalECLForYear = 0;
let eclByStage = { stage1: 0, stage2: 0, stage3: 0 };

const totalExposure = loanCohorts.reduce((sum, cohort) => sum + cohort.avgExposureDuringYear, 0);

if (totalExposure > 0) {
const stage1Exposure = totalExposure * modelData.portfolioAllocationStage1;
const stage2Exposure = totalExposure * modelData.portfolioAllocationStage2;
const stage3Exposure = totalExposure * modelData.portfolioAllocationStage3;

eclByStage.stage1 = stage1Exposure * adjustedPDStage1 * modelData.lgd;
eclByStage.stage2 = stage2Exposure * adjustedPDStage2 * modelData.lgd;
eclByStage.stage3 = stage3Exposure * modelData.pdStage3 * modelData.lgd;
totalECLForYear = eclByStage.stage1 + eclByStage.stage2 + eclByStage.stage3;

log(`📊 NIIF 9 PORTFOLIO ALLOCATIONS - Año ${currentYear}:`);
log(`   Total exposure: ${formatCurrency(totalExposure)}`);
log(`   Stage 1 (${(modelData.portfolioAllocationStage1*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage1)}`);
log(`   Stage 2 (${(modelData.portfolioAllocationStage2*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage2)}`);
log(`   Stage 3 (${(modelData.portfolioAllocationStage3*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage3)}`);
}

totalECLForYear *= modelData.economicAdjustmentFactor;
eclByStage.stage1 *= modelData.economicAdjustmentFactor;
eclByStage.stage2 *= modelData.economicAdjustmentFactor;
eclByStage.stage3 *= modelData.economicAdjustmentFactor;

const annualProvisionExpense = totalECLForYear * (modelData.proteccionRodando ? 0.5 : 1.0);

let newProvisionsBalance = currentProvisionsBalance + annualProvisionExpense;

const provisionesEsperadas = currentYearEndReceivables * (adjustedPDStage1 * modelData.portfolioAllocationStage1 +
adjustedPDStage2 * modelData.portfolioAllocationStage2 +
modelData.pdStage3 * modelData.portfolioAllocationStage3) * modelData.lgd * modelData.economicAdjustmentFactor;

if (Math.abs(newProvisionsBalance - provisionesEsperadas) > 10000) {
log("IFRS 9 provisions adjustment applied for consistency");
newProvisionsBalance = provisionesEsperadas;
}

return {
annualProvisionExpense: annualProvisionExpense,
newProvisionsBalance: newProvisionsBalance,
totalECLBeforeAdjustment: totalECLForYear,
eclByStage: eclByStage
};
}
/**
* Conceptually validates if a performance obligation is met to recognize revenue under IFRS 15.
* @param {Object} cohort - The loan cohort to validate.
* @returns {boolean} True if revenue can be recognized.
*/
function validatePerformanceObligation(cohort) {
// A simple but effective check: revenue is earned as the service (loan) is provided.
// This is true if payments have started and the principal has been reduced.
const isServiceBeingProvided = cohort.paymentsMadeMonths > 0 && cohort.remainingPrincipal < cohort.originalPrincipal;
if (!isServiceBeingProvided) {
log(`NIIF 15 - Obligación de desempeño para la cohorte del año ${cohort.yearOriginated} aún no satisfecha. No se reconocen ingresos.`);
}
return isServiceBeingProvided;
}
/**
* Calculates contract revenue and liabilities according to IFRS 15.
* @param {Array<Object>} loanCohorts - Array of active loan cohorts.
* @param {Array<Object>} fixedAssetsCohorts - Array of active fixed asset (van) cohorts.
* @param {number} addedUnitsThisYear - New units added in the current year.
* @param {number} currentYear - The current projection year (1-5).
* @returns {Object} Contains recognized revenue and contract liability balance.
*/
function calculateNIIF15Revenue(loanCohorts, fixedAssetsCohorts, addedUnitsThisYear, currentYear) {
let annualOriginationCommissionRecognized = 0;
let totalContractLiabilitiesBalance = 0;
loanCohorts.forEach(cohort => {
//           ✅           CORREGIDO: Added IFRS 15 validation for performance obligation.
if (validatePerformanceObligation(cohort)) {
let monthlyInterestRateClient = cohort.monthlyInterestRate;
const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
log(`📋 NIIF 15 - Amortización comisiones en ${totalPaymentsMonthsClient} meses (${modelData.clientLoanTermYears} años)`);
let currentRemainingPrincipal = cohort.startOfYearPrincipal;
let initialPrincipal = cohort.originalPrincipal;
let recognizedOriginationFromPrincipal = 0;
let recognizedUpfrontCommission = 0;
for (let m = 0; m < 12; m++) {
if (currentRemainingPrincipal <= 0 || cohort.paymentsMadeMonths + m >= totalPaymentsMonthsClient) {
break;
}
const interestThisMonth = currentRemainingPrincipal * monthlyInterestRateClient;
let principalThisMonth = cohort.monthlyPayment - interestThisMonth;
principalThisMonth = Math.min(principalThisMonth, currentRemainingPrincipal);
currentRemainingPrincipal -= principalThisMonth;

if (initialPrincipal > 0) {
const recognitionRatioThisMonth = principalThisMonth / initialPrincipal;
const recognizedByPrincipal = cohort.originationCommissionInitial * recognitionRatioThisMonth;
recognizedOriginationFromPrincipal += Math.min(recognizedByPrincipal, cohort.remainingOriginationCommission);
}

if (cohort.originalUpfrontLiability > 0) {
const monthlyUpfrontAmortization = cohort.originalUpfrontLiability / totalPaymentsMonthsClient;
recognizedUpfrontCommission += Math.min(monthlyUpfrontAmortization, cohort.remainingUpfrontLiability);
}
}

const actualRecognizedOrigination = Math.min(recognizedOriginationFromPrincipal, cohort.remainingOriginationCommission);
const actualRecognizedUpfront = Math.min(recognizedUpfrontCommission, cohort.remainingUpfrontLiability);
annualOriginationCommissionRecognized += (actualRecognizedOrigination + actualRecognizedUpfront);
cohort.remainingOriginationCommission = Math.max(0, cohort.remainingOriginationCommission - actualRecognizedOrigination);
cohort.remainingUpfrontLiability = Math.max(0, cohort.remainingUpfrontLiability - actualRecognizedUpfront);
}

totalContractLiabilitiesBalance += cohort.remainingOriginationCommission || 0;
totalContractLiabilitiesBalance += cohort.remainingUpfrontLiability || 0;
});

const totalActiveUnits = fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0);
const gnvCommissions = totalActiveUnits * modelData.litrosPromedioMensualPorUnidad * 12 * modelData.precioLitroGNV * (modelData.comisionGNVPorcentaje / 100);

const sparePartsCost = addedUnitsThisYear * modelData.refaccionesCostPerUnit;
const sparePartsRevenue = sparePartsCost * (1 + modelData.margenRefacciones / 100);

const marketplaceRevenue = totalActiveUnits * modelData.gmvPromedioMensualPorUnidad * 12 * (modelData.takeRateMarketplace / 100);

return {
recognizedOriginationRevenue: annualOriginationCommissionRecognized,
gnvCommissions: gnvCommissions,
sparePartsRevenue: sparePartsRevenue,
sparePartsCOGS: sparePartsCost,
marketplaceRevenue: marketplaceRevenue,
contractLiabilitiesBalance: totalContractLiabilitiesBalance,
// Pass these through for niifDetails
originationContractValueInitial: loanCohorts.filter(c => c.yearOriginated === currentYear).reduce((sum, c) => sum + (c.originationCommissionInitial || 0), 0),
upfrontCommissionInitial: loanCohorts.filter(c => c.yearOriginated === currentYear).reduce((sum, c) => sum + (c.originalUpfrontLiability || 0), 0),
};
}
/**
* Conceptually validates if an asset qualifies to be classified as Held for Sale under IFRS 5.
* @param {Object} asset - The asset cohort to validate.
* @returns {boolean} True if the asset qualifies.
*/
function qualifiesForHeldForSale(asset) {
// In a real-world scenario, these would be properties of the asset.
// For this model, we assume all repossessed assets meet the criteria.
const managementCommittedToSell = true;
const availableForImmediateSale = true;
const saleHighlyProbableWithin12Months = true;
const qualifies = managementCommittedToSell && availableForImmediateSale && saleHighlyProbableWithin12Months;
if (!qualifies) {
log(`NIIF 5 - Activo de la cohorte ${asset.yearAcquired} no califica para ser Mantenido para la Venta.`);
}
return qualifies;
}
/**
* Manages assets held for sale (IFRS 5).
* @param {Array<Object>} fixedAssetsCohorts - Array of fixed asset cohorts (will be modified).
* @param {Array<Object>} heldForSaleAssets - Global array of IFRS 5 assets (will be modified).
* @param {number} currentYear - The current projection year (1-5).
* @returns {Object} Contains this year's impairment loss and reclassification details.
*/
function manageNIIF5Assets(fixedAssetsCohorts, heldForSaleAssets, currentYear) {
let totalImpairmentThisYear = 0;
const totalOperationalUnits = fixedAssetsCohorts.reduce((sum, c) => sum + c.units, 0);
let unitsToRepossess = Math.round(totalOperationalUnits * (modelData.tasaReposicion / 100));
let remainingUnitsToRepossess = unitsToRepossess;

let valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount = 0;
let valueOfAssetsReclassifiedToNIIF5ThisYearFairValue = 0;
let valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell = 0;
let valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue = 0;

fixedAssetsCohorts.sort((a, b) => a.yearAcquired - b.yearAcquired);

for (let i = 0; i < fixedAssetsCohorts.length && remainingUnitsToRepossess > 0; i++) {
let cohort = fixedAssetsCohorts[i];
//           ✅           CORREGIDO: Added IFRS 5 validation.
if (cohort.units > 0 && qualifiesForHeldForSale(cohort)) {
const actualUnitsToRepossessFromThisCohort = Math.min(remainingUnitsToRepossess, cohort.units);
if (actualUnitsToRepossessFromThisCohort > 0) {
const proportionToRepossess = actualUnitsToRepossessFromThisCohort / cohort.units;
const repossessedOriginalCost = cohort.totalOriginalCost * proportionToRepossess;
const repossessedAccumulatedDepreciation = cohort.accumulatedDepreciation * proportionToRepossess;
const repossessedCarryingAmount = repossessedOriginalCost - repossessedAccumulatedDepreciation;

const repossessedFairValue = repossessedOriginalCost * (modelData.fairValueVenta / 100);
const repossessedCostsToSell = repossessedFairValue * (modelData.costosVenta / 100);
const repossessedFairValueLessCosts = repossessedFairValue - repossessedCostsToSell;

const impairmentForRepossessed = Math.max(0, repossessedCarryingAmount - repossessedFairValueLessCosts);
totalImpairmentThisYear += impairmentForRepossessed;

cohort.units -= actualUnitsToRepossessFromThisCohort;
cohort.totalOriginalCost -= repossessedOriginalCost;
cohort.accumulatedDepreciation -= repossessedAccumulatedDepreciation;

heldForSaleAssets.push({
units: actualUnitsToRepossessFromThisCohort,
originalCost: repossessedOriginalCost,
accumulatedDepreciation: repossessedAccumulatedDepreciation,
carryingAmountAtHFS: repossessedCarryingAmount,
currentFairValueLessCosts: repossessedFairValueLessCosts,
heldForSaleYear: currentYear,
impairmentRecorded: impairmentForRepossessed
});
remainingUnitsToRepossess -= actualUnitsToRepossessFromThisCohort;

valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount += repossessedCarryingAmount;
valueOfAssetsReclassifiedToNIIF5ThisYearFairValue += repossessedFairValue;
valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell += repossessedCostsToSell;
valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue += repossessedFairValueLessCosts;
}
}
}

fixedAssetsCohorts = fixedAssetsCohorts.filter(c => c.units > 0);

const totalUnitsAccumulatedHeldForSale = heldForSaleAssets.reduce((sum, asset) => sum + asset.units, 0);
const assetsHeldForSaleNet = heldForSaleAssets.reduce((sum, asset) => sum + asset.currentFairValueLessCosts, 0);
return {
impairmentExpense: totalImpairmentThisYear,
niif5Details: {
unidadesClasificadasAnuales: unitsToRepossess - remainingUnitsToRepossess,
valorEnLibrosClasificado: valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount,
valorRazonable: valueOfAssetsReclassifiedToNIIF5ThisYearFairValue,
costosDeVenta: valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell,
valorRazonableMenosCostos: valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue,
perdidaPorDeterioro: totalImpairmentThisYear,
saldoActivosParaVentaAcumulado: assetsHeldForSaleNet,
totalUnitsAccumulatedHeldForSale: totalUnitsAccumulatedHeldForSale
},
updatedFixedAssetsCohorts: fixedAssetsCohorts,
updatedHeldForSaleAssets: heldForSaleAssets
};
}
/**
* Calculates a time-weighted average for balances,
* considering capital events that occur during the year.
* @param {number} startBalance - Balance at the beginning of the year.
* @param {number} endBalance - Balance at the end of the year.
* @param {Array<Object>} capitalEvents - Array of objects { month: number, amount: number }.
* @returns {number} The time-weighted average.
*/
function calculateTimeWeightedAverage(startBalance, endBalance, capitalEvents = []) {
if (!capitalEvents.length || capitalEvents.length === 0) {
// If no events, fall back to simple average for consistency
return (startBalance + endBalance) / 2;
}

let weightedSum = 0;
let totalMonths = 12;
capitalEvents.sort((a, b) => a.month - b.month);
let currentBalance = startBalance;
let lastMonth = 0;

capitalEvents.forEach(event => {
const monthsInPeriod = event.month - lastMonth;
if (monthsInPeriod > 0) {
weightedSum += currentBalance * monthsInPeriod;
}
currentBalance += event.amount;
lastMonth = event.month;
});

if (lastMonth < 12) {
weightedSum += currentBalance * (12 - lastMonth);
}

return weightedSum / totalMonths;
}
/**
* Performs the annual calculation of fixed asset depreciation.
* IFRS 6: Do not depreciate in the year of acquisition. Adjust depreciable base for impairment.
* @param {Array<Object>} fixedAssetsCohorts - Fixed asset cohorts.
* @param {number} currentYear - Current projection year.
* @returns {number} Total annual depreciation amount.
*/
function calculateAnnualDepreciation(fixedAssetsCohorts, currentYear) {
let annualDepreciation = 0;
fixedAssetsCohorts.forEach(cohort => {
const yearsHeld = currentYear - cohort.yearAcquired;

if (yearsHeld > 0 && modelData.depreciationYears > 0) {
const depreciationRate = 1 / modelData.depreciationYears;
const maxDepreciationPossible = cohort.totalOriginalCost - cohort.accumulatedDepreciation;
const depreciationThisYear = Math.min(cohort.totalOriginalCost * depreciationRate, maxDepreciationPossible);

cohort.accumulatedDepreciation += depreciationThisYear;
annualDepreciation += depreciationThisYear;
}
});
return annualDepreciation;
}

/**
* Central function to calculate all financial statements of the model.
* Process: Iterates year by year, calculating revenues, expenses, flows, and balances,
* integrating IFRS logic and validations.
* @returns {boolean} True if the calculation was successful, false if there was a critical error (e.g., unbalanced balance sheet).
*/
function calculateFinancials() {
log('🚀 calculateFinancials (v23 - Strategic Case) INICIANDO');
try {
// --- Reset results ---
financialResults = { pl: [], cf: [], bs: [], niifDetails: [], tirProyecto: 0, tirCartera: 0, tirEquity: 0, roe: [], roic: [] };
heldForSaleAssets = [];

// --- Initial state variables ---
let cash = modelData.seriesA;
let currentProvisionsBalance = 0;
let endOfYearEquity = modelData.seriesA;

// --- Cohort tracking ---
let loanCohorts = [];
let fixedAssetsCohorts = [];
let ventureDebtCohorts = [];
let commercialDebtCohorts = [];

// --- Balance tracking ---
let ventureDebtBalance = 0;
let commercialDebtBalance = 0;

// --- IRR Cash Flow arrays ---
let equityCashFlows = [-modelData.seriesA];
let projectCashFlows = [-modelData.seriesA];
let portfolioCashFlows = [];
log(`Initial Series A capital: ${formatCurrency(modelData.seriesA)}`);

// --- Main annual loop (5 years) ---
for (let year = 0; year < 5; year++) {
const currentYear = year + 1;
log(`\n--- Calculating Year ${currentYear} ---`);

const startOfYearCash = cash;
const startOfYearEquity = endOfYearEquity;
const startOfYearVentureDebt = ventureDebtBalance;
const startOfYearCommercialDebt = commercialDebtBalance;

loanCohorts.forEach(cohort => { cohort.startOfYearPrincipal = cohort.remainingPrincipal; });

const addedUnits = modelData.unitsPerYear[year];
const capexThisYear = addedUnits * getTotalPackageCost();

if (addedUnits > 0) {
fixedAssetsCohorts.push({ yearAcquired: currentYear, units: addedUnits, totalOriginalCost: capexThisYear, accumulatedDepreciation: 0 });
}

const niif5Results = manageNIIF5Assets(fixedAssetsCohorts, heldForSaleAssets, currentYear);
fixedAssetsCohorts = niif5Results.updatedFixedAssetsCohorts;
heldForSaleAssets = niif5Results.updatedHeldForSaleAssets;
const impairment = niif5Results.impairmentExpense;

const annualDepreciation = calculateAnnualDepreciation(fixedAssetsCohorts, currentYear);

let netLoanPrincipal = 0;
if (addedUnits > 0) {
const newCohortGrossPrincipal = addedUnits * getTotalPackagePrice();
const downPaymentReceived = newCohortGrossPrincipal * (modelData.downPaymentPercentage / 100);
netLoanPrincipal = newCohortGrossPrincipal - downPaymentReceived;
const monthlyInterestRateClient = (modelData.tasaInteres / 100) / 12;
const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
const monthlyPaymentClient = netLoanPrincipal * (monthlyInterestRateClient / (1 - Math.pow(1 + monthlyInterestRateClient, -totalPaymentsMonthsClient)));
const originationCommissionForThisCohort = netLoanPrincipal * (modelData.margenVagoneta / 100);
const upfrontCommissionReceived = newCohortGrossPrincipal * (modelData.upfrontCommissionPercentage / 100);
loanCohorts.push({ yearOriginated: currentYear, originalPrincipal: netLoanPrincipal, remainingPrincipal: netLoanPrincipal, startOfYearPrincipal: netLoanPrincipal, paymentsMadeMonths: 0, monthlyPayment: monthlyPaymentClient, monthlyInterestRate: monthlyInterestRateClient, totalLoanTermMonths: totalPaymentsMonthsClient, originationCommissionInitial: originationCommissionForThisCohort, remainingOriginationCommission: originationCommissionForThisCohort, originalUpfrontLiability: upfrontCommissionReceived, remainingUpfrontLiability: upfrontCommissionReceived, avgExposureDuringYear: 0, });
}

let annualInterestReceived = 0;
let annualPrincipalReceived = 0;
let currentYearEndReceivables = 0;
loanCohorts.forEach(cohort => {
let principal = cohort.startOfYearPrincipal;
cohort.avgExposureDuringYear = principal;
for (let m=0; m < 12; m++) {
if (cohort.paymentsMadeMonths >= cohort.totalLoanTermMonths) break;
const interest = principal * cohort.monthlyInterestRate;
const principalPayment = cohort.monthlyPayment - interest;
annualInterestReceived += interest;
annualPrincipalReceived += principalPayment;
principal -= principalPayment;
cohort.paymentsMadeMonths++;
}
cohort.remainingPrincipal = Math.max(0, principal);
currentYearEndReceivables += cohort.remainingPrincipal;
});

const niif9Results = calculateNIIF9ECL(loanCohorts, currentYear, currentProvisionsBalance, currentYearEndReceivables);
const provisions = niif9Results.annualProvisionExpense;
currentProvisionsBalance = niif9Results.newProvisionsBalance;

const niif15Results = calculateNIIF15Revenue(loanCohorts, fixedAssetsCohorts, addedUnits, currentYear);

const totalActiveUnits = fixedAssetsCohorts.reduce((sum, c) => sum + c.units, 0);
const gnvCommissions = totalActiveUnits * modelData.litrosPromedioMensualPorUnidad * 12 * modelData.precioLitroGNV * (modelData.comisionGNVPorcentaje / 100);
const sparePartsRevenue = addedUnits * modelData.refaccionesCostPerUnit * (1 + modelData.margenRefacciones / 100);
const sparePartsCOGS = addedUnits * modelData.refaccionesCostPerUnit;
const marketplaceRevenue = totalActiveUnits * modelData.gmvPromedioMensualPorUnidad * 12 * (modelData.takeRateMarketplace / 100);
const totalRevenue = annualInterestReceived + niif15Results.recognizedOriginationRevenue + gnvCommissions + sparePartsRevenue + marketplaceRevenue;
const opex = totalRevenue * (modelData.opexRates[year] / 100);

const ventureDebtInterest = startOfYearVentureDebt * (modelData.ventureDebtRate / 100);
const commercialDebtInterest = startOfYearCommercialDebt * (modelData.commercialDebtRate / 100);
const interestExpense = ventureDebtInterest + commercialDebtInterest;

let ventureDebtPrincipalRepayment = 0;
ventureDebtCohorts.forEach(cohort => {
if (currentYear >= cohort.yearOriginated) {
ventureDebtPrincipalRepayment += cohort.originalAmount / modelData.periodoAmortizacionDeuda;
}
});
let commercialDebtPrincipalRepayment = 0;
commercialDebtCohorts.forEach(cohort => {
if (currentYear >= cohort.yearOriginated) {
commercialDebtPrincipalRepayment += cohort.originalAmount / modelData.periodoAmortizacionDeuda;
}
});
const totalDebtPrincipalRepayment = ventureDebtPrincipalRepayment + commercialDebtPrincipalRepayment;

const ebitda = totalRevenue - sparePartsCOGS - opex - provisions - impairment;
const ebit = ebitda - annualDepreciation;
const earningsBeforeTax = ebit - interestExpense;
const incomeTaxExpense = Math.max(0, earningsBeforeTax) * (modelData.corporateTaxRate / 100);
const netIncome = earningsBeforeTax - incomeTaxExpense;

// --- PRE-FINANCING CASH FLOW CALCULATION ---
let techInvestmentThisYear = 0;
if (currentYear === 1 || currentYear === 2) {
    techInvestmentThisYear = 6875000;
}
const deltaReceivables = currentYearEndReceivables - ((financialResults.bs[year-1]?.receivables) || 0);
const deltaProvisions = currentProvisionsBalance - ((financialResults.bs[year-1]?.provisions) || 0);
const deltaContractLiabilities = niif15Results.contractLiabilitiesBalance - ((financialResults.bs[year-1]?.contractLiabilities) || 0);
const operatingCash = netIncome + annualDepreciation + impairment + deltaProvisions + deltaContractLiabilities - deltaReceivables;

// --- NEW: CAPITAL CASCADING LOGIC ---
const sourcingPlan = calculateYearlyFinancingNeeds(year, capexThisYear, operatingCash, cash, { venture: ventureDebtCohorts, commercial: commercialDebtCohorts });
log(`💰 Sourcing Plan Year ${currentYear}: Equity=${formatCurrency(sourcingPlan.newEquity)}, VD=${formatCurrency(sourcingPlan.newVentureDebt)}, CD=${formatCurrency(sourcingPlan.newCommercialDebt)}`);

// Usar valores de cascada para el flujo
const finalNewVentureDebt = sourcingPlan.newVentureDebt;
const finalNewCommercialDebt = sourcingPlan.newCommercialDebt;
const finalNewEquityInjections = sourcingPlan.newEquity;

// Actualizar modelData con los valores optimizados/totales
modelData[`ventureDebtYear${currentYear}`] = finalNewVentureDebt;
modelData[`commercialDebtYear${currentYear}`] = finalNewCommercialDebt;
modelData[`partnerCapitalizationYear${currentYear}`] = (plannedFinancingData[`partnerCapitalizationYear${currentYear}`] || 0);
modelData[`seriesB_newInvestors_year${currentYear}`] = (plannedFinancingData[`seriesB_newInvestors_year${currentYear}`] || 0);


if (finalNewVentureDebt > 0) ventureDebtCohorts.push({ yearOriginated: currentYear, originalAmount: finalNewVentureDebt });
if (finalNewCommercialDebt > 0) commercialDebtCohorts.push({ yearOriginated: currentYear, originalAmount: finalNewCommercialDebt });


const investingCash = -capexThisYear - techInvestmentThisYear;
const financingCash = finalNewEquityInjections + finalNewVentureDebt + finalNewCommercialDebt - totalDebtPrincipalRepayment;

const netCash = operatingCash + investingCash + financingCash;
cash += netCash;

endOfYearEquity = startOfYearEquity + netIncome + finalNewEquityInjections;
ventureDebtBalance = startOfYearVentureDebt + finalNewVentureDebt - ventureDebtPrincipalRepayment;
commercialDebtBalance = startOfYearCommercialDebt + finalNewCommercialDebt - commercialDebtPrincipalRepayment;
const totalDebt = ventureDebtBalance + commercialDebtBalance;

const fixedAssetsNet = fixedAssetsCohorts.reduce((sum, c) => sum + (c.totalOriginalCost - c.accumulatedDepreciation), 0);
const assetsHeldForSaleNet = heldForSaleAssets.reduce((sum, a) => sum + a.currentFairValueLessCosts, 0);
const totalAssets = cash + currentYearEndReceivables + fixedAssetsNet + assetsHeldForSaleNet;
const totalLiabilities = totalDebt + currentProvisionsBalance + niif15Results.contractLiabilitiesBalance;
let totalLiabilitiesEquity = totalLiabilities + endOfYearEquity;
const balanceDiff = totalAssets - totalLiabilitiesEquity;

if (Math.abs(balanceDiff) > BALANCE_TOLERANCE) {
log(`⚠️ Balance adjustment in Year ${currentYear}: ${formatCurrency(balanceDiff)}`);
endOfYearEquity += balanceDiff;
totalLiabilitiesEquity = totalLiabilities + endOfYearEquity;
}

financialResults.pl.push({ ...niif15Results, interestRevenue: annualInterestReceived, totalRevenue, ebitda, ebit, netIncome, interestExpense, depreciation: annualDepreciation, provisions, impairment, totalCOGS: sparePartsCOGS, grossProfit: totalRevenue - sparePartsCOGS, opex, earningsBeforeTax, incomeTaxExpense, addedUnits });
financialResults.cf.push({ operatingCash, investingCash, financingCash, netCash, deltaProvisions, deltaContractLiabilities, incomeTaxPaid: incomeTaxExpense, clientPrincipalPaymentsReceived: annualPrincipalReceived, clientInterestPaymentsReceived: annualInterestReceived, currentYearVentureDebtDraw: finalNewVentureDebt, additionalFundingRaised: finalNewCommercialDebt, debtPrincipalRepayment: totalDebtPrincipalRepayment, techInvestmentThisYear });
financialResults.bs.push({ cash, receivables: currentYearEndReceivables, receivablesNet: currentYearEndReceivables - currentProvisionsBalance, fixedAssets: fixedAssetsNet, assetsHeldForSale: assetsHeldForSaleNet, totalAssets: totalAssets, debt: totalDebt, equity: endOfYearEquity, totalLiabilitiesEquity: totalLiabilitiesEquity, provisions: currentProvisionsBalance, contractLiabilities: niif15Results.contractLiabilitiesBalance });
financialResults.niifDetails.push({ niif15: niif15Results, niif5: niif5Results.niif5Details, niif9: {...niif9Results, pdStage1: modelData.pdStage1, pdStage2: modelData.pdStage2, pdStage3: modelData.pdStage3, lgd: modelData.lgd, economicAdjustmentFactor: modelData.economicAdjustmentFactor, proteccionRodandoActiva: modelData.proteccionRodando, provisionesConProteccion: provisions, reduccionPorProteccion: niif9Results.totalECLBeforeAdjustment - provisions, saldoProvisionesAcumulado: currentProvisionsBalance } });

const equityEvents = [];
if (finalNewEquityInjections > 0) equityEvents.push({ month: 6, amount: finalNewEquityInjections });
const debtEvents = [];
if (finalNewVentureDebt > 0) debtEvents.push({ month: 3, amount: finalNewVentureDebt });
if (finalNewCommercialDebt > 0) debtEvents.push({ month: 9, amount: finalNewCommercialDebt });
const avgEquity = calculateTimeWeightedAverage(startOfYearEquity, endOfYearEquity, equityEvents);
financialResults.roe.push(avgEquity > 0 ? (netIncome / avgEquity) * 100 : 0);
const nopat = ebit * (1 - modelData.corporateTaxRate / 100);
const avgDebt = calculateTimeWeightedAverage(startOfYearVentureDebt + startOfYearCommercialDebt, totalDebt, debtEvents);
const avgInvestedCapital = avgEquity + avgDebt;
financialResults.roic.push(avgInvestedCapital > 0 ? (nopat / avgInvestedCapital) * 100 : 0);

projectCashFlows.push(ebit * (1 - modelData.corporateTaxRate/100) + annualDepreciation - capexThisYear);
const freeCashFlowToEquity = operatingCash + investingCash + (finalNewVentureDebt + finalNewCommercialDebt - totalDebtPrincipalRepayment);
equityCashFlows.push(freeCashFlowToEquity);
let portfolioCashFlowThisYear = -netLoanPrincipal + annualPrincipalReceived + annualInterestReceived;
if (year === 4) {
portfolioCashFlowThisYear += currentYearEndReceivables / Math.pow(1 + modelData.tasaInteres / 100, modelData.avgRemainingTermCartera);
}
portfolioCashFlows.push(portfolioCashFlowThisYear);
}

const terminalValueProject_final = financialResults.pl[4].ebitda * modelData.ebitdaMultipleProject;
const terminalValueEquity_final = financialResults.bs[4].equity * modelData.floorEquityMultiple;

projectCashFlows[projectCashFlows.length - 1] += terminalValueProject_final;
const finalTerminalValue = Math.max(terminalValueProject_final, terminalValueEquity_final);
equityCashFlows[equityCashFlows.length - 1] += finalTerminalValue;
financialResults.tirProyecto = calculateIRR(projectCashFlows) || 0;
financialResults.tirEquity = calculateIRR(equityCashFlows) || 0;
financialResults.tirCartera = calculateIRR(portfolioCashFlows) || 0;

log('✅ FINANCIAL CALCULATIONS (v23) COMPLETED');
return true;
} catch (error) {
log(`❌ ERROR in calculateFinancials (v23): ${error.message}`);
document.getElementById('balance-validation').innerHTML = `<span class="text-red-600">❌ ${error.message}</span>`;
return false;
}
}

/**
* Calculates the Internal Rate of Return (IRR) using the Newton-Raphson method.
* Incorporates a robust method with error handling and a search range for convergence.
* @param {number[]} cashFlows - Array of cash flows. The first element is the initial investment (negative).
* @param {number} [maxIterations=500] - Maximum number of iterations.
* @param {number} [tolerance=1e-7] - Tolerance for convergence.
* @returns {number} The IRR in percentage, or 0 if it does not converge or is undefined.
*/
function calculateIRR(cashFlows, maxIterations = 500, tolerance = 1e-7) {
if (!cashFlows || cashFlows.length < 2) {
log('IRR: Insufficient flows. Returning 0%.');
return 0;
}
const hasPositive = cashFlows.some(cf => cf > 0);
const hasNegative = cashFlows.some(cf => cf < 0);
if (!hasPositive || !hasNegative) {
log('IRR: No positive and negative flows, IRR undefined. Returning 0%.');
return 0;
}

let guess = 0.10;
let low = -0.99;
let high = 5.0;
for (let i = 0; i < maxIterations; i++) {
let npv = 0;
let dNpv = 0;
for (let t = 0; t < cashFlows.length; t++) {
const discountFactor = Math.pow(1 + guess, t);
if (discountFactor === 0) {
guess += 0.01;
npv = 1;
break;
}
npv += cashFlows[t] / discountFactor;
if (t > 0) {
dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
}
}
if (Math.abs(npv) < tolerance) {
return Math.max(-99, Math.min(500, guess * 100));
}
if (dNpv === 0) {
break;
}
const newGuess = guess - npv / dNpv;

if (newGuess < low) {
guess = (guess + low) / 2;
} else if (newGuess > high) {
guess = (guess + high) / 2;
} else {
guess = newGuess;
}

if (npv > 0) low = guess; else high = guess;

if (high - low < tolerance) {
guess = (low + high) / 2;
return Math.max(-99, Math.min(500, guess * 100));
}
}
log(`IRR did not converge completely after ${maxIterations} iterations. Returning ${Math.max(-99, Math.min(500, guess * 100)).toFixed(2)}%.`);
return Math.max(-99, Math.min(500, guess * 100));
}

/**
* Performs a comprehensive validation of the financial model, covering inputs, outputs, and consistency.
* Process: Calls specific validation functions for each area and accumulates the results.
* @param {ModelData} modelData - Model input data.
* @param {Object} financialResults - Calculated model results.
* @returns {Object} Object with arrays of errors, warnings, info, and passed.
*/
function validateModelComprehensively(modelData, financialResults) {
const validations = {
errors: [],
warnings: [],
info: [],
passed: []
};

validateInputs(modelData, validations);

if (financialResults.pl.length > 0 && financialResults.cf.length > 0 && financialResults.bs.length > 0) {
validateOutputs(financialResults, validations);
validateConsistency(financialResults, validations);
validateTemporal(financialResults, validations);
if (financialResults.pl.length === 5) {
validateIndustryBenchmarks(financialResults, validations);
} else {
validations.info.push("No enough projection years to evaluate industry benchmarks.");
}
validateFinancingCapacity(modelData, financialResults, validations);
} else {
validations.errors.push("Financial results could not be calculated. Please review initial inputs.");
}

return validations;
}
/**
* Validates model inputs, including ranges and cross-validations.
* @param {ModelData} modelData - Model input data.
* @param {Object} validations - Object where validation results are accumulated.
*/
function validateInputs(modelData, validations) {
if (modelData.seriesA <= 0) {
validations.errors.push("🔴 Error: Series A Capital must be greater than 0. Adjust 'Capital Serie A' in Control.");
}
if (modelData.vanCost <= 0) {
validations.errors.push("🔴 Error: Van Cost must be greater than 0. Adjust 'Costo Vagoneta (RAG)' in Control.");
}
if (getTotalPackagePrice() <= 0) {
validations.errors.push(`🔴 Error: Total Package Price (${formatCurrency(getTotalPackagePrice())}) must be greater than 0. Adjust component prices or van in Control.`);
}
if (getTotalPackageCost() <= 0) {
validations.errors.push(`🔴 Error: Total Package Cost (${formatCurrency(getTotalPackageCost())}) must be greater than 0. Adjust component costs or van in Control.`);
}
if (modelData.clientLoanTermYears <= 0 || !Number.isInteger(modelData.clientLoanTermYears)) {
validations.errors.push("🔴 Error: Client Loan Term must be a positive integer. Adjust 'Plazo Préstamo Cliente' in Control.");
}
if (modelData.depreciationYears <= 0 || !Number.isInteger(modelData.depreciationYears)) {
validations.errors.push("🔴 Error: Depreciation Years must be a positive integer. Adjust 'Años Depreciación' in Control.");
}

const percentageInputs = [
{ id: 'tasaInteres', label: 'Tasa de Interés (Clientes)' },
{ id: 'margenRefacciones', label: 'Margen Refacciones' },
{ id: 'margenVagoneta', label: 'Margen Originación Vagoneta' },
{ id: 'tasaReposicion', label: '% Unidades Reposición' },
{ id: 'fairValueVenta', label: '% Fair Value Venta' },
{ id: 'costosVenta', label: '% Costos Venta' },
{ id: 'corporateTaxRate', label: 'Tasa Impuesto Corporativo (%)' },
{ id: 'comisionGNVPorcentaje', label: 'Comisión GNV (%)' },
{ id: 'takeRateMarketplace', label: 'Take Rate Marketplace (%)' },
{ id: 'downPaymentPercentage', label: 'Down Payment Cliente (%)' },
{ id: 'upfrontCommissionPercentage', label: 'Comisión Upfront (%)' }
];
percentageInputs.forEach(p => {
if (modelData[p.id] < 0 || modelData[p.id] > 100) {
validations.warnings.push(`🟡 Warning: '${p.label}' (${modelData[p.id].toFixed(1)}%) is outside typical range (0-100%). Review in Control.`);
}
});

const decimalPercentageInputs = [
{ id: 'pdStage1', label: 'PD Etapa 1 (12M)' },
{ id: 'pdStage2', label: 'PD Etapa 2 (Lifetime)' },
{ id: 'pdStage3', label: 'PD Etapa 3 (Lifetime)' },
{ id: 'lgd', label: 'LGD (Pérdida Incumplimiento)' },
{ id: 'portfolioAllocationStage1', label: 'Port. Etapa 1 (%)' },
{ id: 'portfolioAllocationStage2', label: 'Port. Etapa 2 (%)' },
{ id: 'portfolioAllocationStage3', label: 'Port. Etapa 3 (%)' }
];
decimalPercentageInputs.forEach(p => {
if (modelData[p.id] < 0 || modelData[p.id] > 1) {
validations.warnings.push(`🟡 Warning: '${p.label}' (${(modelData[p.id]*100).toFixed(1)}%) is outside valid range (0-100%). Review in Control.`);
}
});

const totalAllocation = modelData.portfolioAllocationStage1 + modelData.portfolioAllocationStage2 + modelData.portfolioAllocationStage3;
if (Math.abs(totalAllocation - 1.0) > 0.001) {
validations.errors.push(`🔴 Error: Sum of IFRS 9 Portfolio Allocation (${(totalAllocation*100).toFixed(1)}%) is not equal to 100%. Please adjust in Control.`);
} else {
validations.passed.push(`✅ Inputs: IFRS 9 Portfolio Allocation sums to 100%.`);
}

if (getTotalPackagePrice() <= getTotalPackageCost()) {
validations.errors.push(`🔴 Input Error: 'Total Package Price' (${formatCurrency(getTotalPackagePrice())}) must be greater than 'Total Package Cost for RAG' (${formatCurrency(getTotalPackageCost())}).`);
} else {
validations.passed.push(`✅ Inputs: 'Total Package Price' is greater than 'Total Package Cost for RAG'.`);
}

validations.passed.push("✅ Inputs: Basic input parameters validated correctly.");
}
/**
* Validates model outputs for financial sanity (e.g., cash balances, margins).
* @param {Object} financialResults - Calculated model results.
* @param {Object} validations - Object where validation results are accumulated.
*/
function validateOutputs(financialResults, validations) {
const lastYear = financialResults.pl.length - 1;
if (lastYear < 0) return;
financialResults.bs.forEach((bsYear, index) => {
if (bsYear.cash < -BALANCE_TOLERANCE) {
validations.errors.push(`🔴 Error: Cash Balance at Year ${index + 1} end is significantly negative (${formatCurrency(bsYear.cash)}). The model requires more financing. Adjust Capital Series or units.`);
} else if (bsYear.cash < 0) {
validations.warnings.push(`🟡 Warning: Cash Balance at Year ${index + 1} end is slightly negative (${formatCurrency(bsYear.cash)}). Consider adjusting financing.`);
}
});
if (!validations.errors.some(e => e.includes("Negative cash")) && !validations.warnings.some(e => e.includes("Slightly negative cash"))) {
validations.passed.push("✅ Outputs: Cash balance is adequate in all years.");
}
const year5PL = financialResults.pl[lastYear];
const year5BS = financialResults.bs[lastYear];

if (year5PL.totalRevenue !== 0) {
const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
if (ebitdaMargin < 10 || ebitdaMargin > 40) {
validations.info.push(`🔵 Info: EBITDA Margin for Year ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) is outside typical fintech benchmark (10-40%).`);
} else {
validations.passed.push(`✅ Outputs: EBITDA Margin for Year ${lastYear + 1} is realistic (${ebitdaMargin.toFixed(1)}%).`);
}
} else {
validations.info.push(`🔵 Info: Total Revenue for Year ${lastYear + 1} is zero, cannot calculate EBITDA Margin.`);
}

if (financialResults.roe && financialResults.roe.length > lastYear && year5BS.equity !== 0) {
const roe = financialResults.roe[lastYear];
if (roe < 20 || roe > 30) {
validations.info.push(`🔵 Info: ROE for Year ${lastYear + 1} (${roe.toFixed(1)}%) is outside typical financial services benchmark (20-30%).`);
} else {
validations.passed.push(`✅ Outputs: ROE for Year ${lastYear + 1} is realistic (${roe.toFixed(1)}%).`);
}
} else if (financialResults.roe && financialResults.roe.length > lastYear) {
validations.info.push(`🔵 Info: Equity for Year ${lastYear + 1} is zero or negative, cannot calculate significant ROE.`);
}

if (year5PL.totalRevenue !== 0) {
const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
if (cxcToRevenueRatio < 0.5 || cxcToRevenueRatio > 3) {
validations.info.push(`🔵 Info: A/R/Revenue Ratio for Year ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) is outside typical financing benchmark (0.5-3x).`);
} else {
validations.passed.push(`✅ Outputs: A/R/Revenue Ratio for Year ${lastYear + 1} is realistic (${cxcToRevenueRatio.toFixed(1)}x).`);
}
} else {
validations.info.push(`🔵 Info: Total Revenue for Year ${lastYear + 1} is zero, cannot compare A/R/Revenue Ratio.`);
}

if (year5BS.equity !== 0) {
const debtToEquityRatio = year5BS.debt / year5BS.equity;
if (debtToEquityRatio < 0 || debtToEquityRatio > 3) {
validations.warnings.push(`🟡 Warning: Debt/Equity Ratio for Year ${lastYear + 1} (${debtToEquityRatio.toFixed(1)}x) is unusual. Review assumptions.`);
} else {
validations.passed.push(`✅ Outputs: Debt/Equity Ratio for Year ${lastYear + 1} is realistic (${debtToEquityRatio.toFixed(1)}x).`);
}
} else {
validations.info.push(`🔵 Info: Equity for Year ${lastYear + 1} is zero or negative, cannot calculate significant Debt/Equity Ratio.`);
}
}
/**
* Validates consistency between different financial statements (P&L, CF, BS).
* @param {Object} financialResults - Calculated model results.
* @param {Object} validations - Object where validation results are accumulated.
*/
function validateConsistency(financialResults, validations) {
const tolerance = BALANCE_TOLERANCE;
const largeTolerance = 50000;
for (let i = 0; i < financialResults.pl.length; i++) {
const pl = financialResults.pl[i];
const cf = financialResults.cf[i];
const bs = financialResults.bs[i];

const prevBsCash = (i === 0) ? modelData.seriesA : financialResults.bs[i-1].cash;

const balanceDiff = Math.abs(bs.totalAssets - bs.totalLiabilitiesEquity);
if (balanceDiff > tolerance) {
validations.errors.push(`🔴 Consistency Error: Balance Sheet for Year ${i + 1} does not balance. Difference: ${formatCurrency(balanceDiff)}. Assets (${formatCurrency(bs.totalAssets)}) vs. Liabilities+Equity (${formatCurrency(bs.totalLiabilitiesEquity)}).`);
} else {
validations.passed.push(`✅ Consistency: Balance Sheet for Year ${i + 1} balances.`);
}

const cashChangeCF = cf.netCash;
const cashChangeBS = bs.cash - prevBsCash;
if (Math.abs(cashChangeCF - cashChangeBS) > tolerance) {
validations.errors.push(`🔴 Consistency Error: Net Flow for Year ${i + 1} (${formatCurrency(cashChangeCF)}) differs from Cash change in Balance Sheet (${formatCurrency(cashChangeBS)}).`);
} else {
validations.passed.push(`✅ Consistency: Net Flow and Cash change for Year ${i + 1} match.`);
}
}
}
/**
* Validates the temporal evolution of key metrics (e.g., revenue growth, ratio changes).
* @param {Object} financialResults - Calculated model results.
* @param {Object} validations - Object where validation results are accumulated.
*/
function validateTemporal(financialResults, validations) {
for (let i = 1; i < financialResults.pl.length; i++) {
const prevPl = financialResults.pl[i-1];
const currentPl = financialResults.pl[i];

if (prevPl.totalRevenue !== 0) {
const revenueGrowth = (currentPl.totalRevenue / prevPl.totalRevenue - 1) * 100;
if (revenueGrowth > 1000) {
validations.warnings.push(`🟡 Temporal Warning: Revenue Growth for Year ${i + 1} (${revenueGrowth.toFixed(1)}%) is extremely high. Review units or pricing assumptions.`);
}
} else if (currentPl.totalRevenue > 0) {
validations.info.push(`🔵 Temporal Info: Year ${i + 1} Revenue starts ramp-up from zero/low. Percentage growth not significant.`);
}

if (prevPl.totalRevenue !== 0 && currentPl.totalRevenue !== 0) {
const prevEbitdaMargin = (prevPl.ebitda / prevPl.totalRevenue) * 100;
const currentEbitdaMargin = (currentPl.ebitda / currentPl.totalRevenue) * 100;
if (Math.abs(currentEbitdaMargin - prevEbitdaMargin) > 500) {
validations.warnings.push(`🟡 Temporal Warning: EBITDA Margin changes drastically (${prevEbitdaMargin.toFixed(1)}% to ${currentEbitdaMargin.toFixed(1)}%) from Year ${i} to Year ${i + 1}. Review cost/revenue dynamics.`);
}
}
}
validations.passed.push("✅ Temporal Evolution: Annual growth trends and ratios seem reasonable.");
}
/**
* Compares model metrics with industry benchmarks for Year 5.
* @param {Object} financialResults - Calculated model results.
* @param {Object} validations - Object where validation results are accumulated.
*/
function validateIndustryBenchmarks(financialResults, validations) {
const lastYear = financialResults.pl.length - 1;
if (lastYear < 4) return;
const year5PL = financialResults.pl[lastYear];
const year5BS = financialResults.bs[lastYear];
const year5ROE = financialResults.roe && financialResults.roe.length > lastYear ? financialResults.roe[lastYear] : 0;

if (year5PL.totalRevenue !== 0) {
const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
if (ebitdaMargin < 10 || ebitdaMargin > 40) {
validations.info.push(`🔵 Info: EBITDA Margin for Year ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) is outside typical fintech benchmark (10-40%).`);
} else {
validations.passed.push(`✅ Outputs: EBITDA Margin for Year ${lastYear + 1} is realistic (${ebitdaMargin.toFixed(1)}%).`);
}
} else {
validations.info.push(`🔵 Info: Total Revenue for Year ${lastYear + 1} is zero, cannot calculate EBITDA Margin.`);
}

if (year5BS.equity !== 0) {
if (year5ROE < 20 || year5ROE > 30) {
validations.info.push(`🔵 Info: ROE for Year ${lastYear + 1} (${year5ROE.toFixed(1)}%) is outside typical financial services benchmark (20-30%).`);
} else {
validations.passed.push(`✅ Outputs: ROE for Year ${lastYear + 1} is realistic (${year5ROE.toFixed(1)}%).`);
}
} else {
validations.info.push(`🔵 Info: Equity for Year ${lastYear + 1} is zero or negative, cannot compare ROE with benchmark.`);
}

if (year5PL.totalRevenue !== 0) {
const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
if (cxcToRevenueRatio < 0.5 || cxcToRevenueRatio > 3) {
validations.info.push(`🔵 Info: A/R/Revenue Ratio for Year ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) is outside typical financing benchmark (0.5-3x).`);
} else {
validations.passed.push(`✅ Outputs: A/R/Revenue Ratio for Year ${lastYear + 1} is realistic (${cxcToRevenueRatio.toFixed(1)}x).`);
}
} else {
validations.info.push(`🔵 Info: Total Revenue for Year ${lastYear + 1} is zero, cannot compare A/R/Revenue Ratio.`);
}

if (financialResults.tirEquity !== 0) {
if (financialResults.tirEquity < 22) {
validations.warnings.push(`🟡 Benchmarks: Equity IRR (${financialResults.tirEquity.toFixed(1)}%) is below the target of 22%.`);
} else {
validations.passed.push(`✅ Benchmarks: Equity IRR (${financialResults.tirEquity.toFixed(1)}%) meets the target of >22%.`);
}
}

if (financialResults.tirCartera !== 0) {
if (financialResults.tirCartera < 20 || financialResults.tirCartera > 30) {
validations.info.push(`🔵 Info: Portfolio IRR (${(financialResults.tirCartera || 0).toFixed(1)}%) is outside target range (20-30%).`);
} else {
validations.passed.push(`✅ Benchmarks: Portfolio IRR (${(financialResults.tirCartera || 0).toFixed(1)}%) is within target range.`);
}
}

const roic = financialResults.roic && financialResults.roic.length > lastYear ? financialResults.roic[lastYear] : 0;
if (roic !== 0) {
if (roic < 15 || roic > 25) {
validations.info.push(`🔵 Info: ROIC for Year ${lastYear + 1} (${roic.toFixed(1)}%) is outside target range (15-25%).`);
} else {
validations.passed.push(`✅ Benchmarks: ROIC for Year ${lastYear + 1} (${roic.toFixed(1)}%) is within target range.`);
}
} else if (financialResults.roic && financialResults.roic.length > lastYear) {
validations.info.push(`🔵 Info: Average Invested Capital for Year ${lastYear + 1} is zero or negative, cannot compare ROIC with benchmark.`);
}
}

function validateFinancingCapacity(modelData, financialResults, validations) {
let totalCapex = 0;
for (let i = 0; i < financialResults.pl.length; i++) {
totalCapex += (financialResults.pl[i].addedUnits || 0) * getTotalPackageCost();
}

let totalFunding = modelData.seriesA;
for (let i = 1; i <= 5; i++) {
totalFunding += (modelData[`partnerCapitalizationYear${i}`] || 0) +
(modelData[`ventureDebtYear${i}`] || 0) +
(modelData[`commercialDebtYear${i}`] || 0) +
(modelData[`seriesB_newInvestors_year${i}`] || 0);
}
if (totalFunding < totalCapex) {
validations.errors.push(`🔴 Validación Financiamiento: El financiamiento total (${formatCurrency(totalFunding)}) es INSUFICIENTE para cubrir el CAPEX total (${formatCurrency(totalCapex)}).`);
} else {
validations.passed.push(`✅ Validación Financiamiento: El financiamiento total (${formatCurrency(totalFunding)}) es SUFICIENTE para cubrir el CAPEX total.`);
}
}

// ===================================================================
// ===== FASE 3: LÓGICA DE INTERFAZ DE USUARIO (UI - EL CÓMO SE VE) ==
// ===================================================================
// (Aquí se encuentran todas las funciones que manipulan el DOM y actualizan la página)
// ===== DEBUG FUNCTIONS =====
/**
* Logs messages to the UI debug panel.
* @param {string} message - The message to log.
*/
function log(message) {
const timestamp = new Date().toLocaleTimeString();
const logEntry = `[${timestamp}] ${message}`;
debugLogs.unshift(logEntry); // Add to the beginning
if (debugLogs.length > 50) debugLogs.pop(); // Keep only the last 50 logs

updateDebugPanel();
}

/**
* Updates the content of the debug panel in the UI.
*/
function updateDebugPanel() {
const panel = document.getElementById('debug-content');
if (panel) {
panel.innerHTML = debugLogs.map(log => `<div style="margin-bottom: 2px; font-size: 10px; border-bottom: 1px dotted #4b5563; padding-bottom: 2px;">${log}</div>`).join('');
}
}

/**
* Shows/hides the debug panel.
*/
function toggleDebug() {
const panel = document.getElementById('debug-info');
panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}
/**
* Shows a temporary warning in the UI.
* @param {string} message - Warning message.
*/
function showWarning(message) {
const existingWarning = document.getElementById('dynamic-warning');
if (existingWarning) existingWarning.remove();

const warning = document.createElement('div');
warning.id = 'dynamic-warning';
warning.className = 'fixed top-20 right-4 bg-amber-900 border border-amber-600 text-amber-200 px-4 py-2 rounded-lg z-50 shadow-lg animate-pulse';
warning.innerHTML = `<span class="text-sm font-medium">${message}</span>`;
document.body.appendChild(warning);

setTimeout(() => {
if (warning && warning.parentNode) {
warning.parentNode.removeChild(warning);
}
}, 5000);
}

/**
* Runs global checks for critical metrics and shows warnings if thresholds are breached.
*/
function runGlobalChecks() {
// Check Equity IRR
if (financialResults.tirEquity < 15) {
showWarning(`⚠️ Alerta de Rentabilidad: La TIR del Equity (${financialResults.tirEquity.toFixed(1)}%) está por debajo del umbral crítico del 15%.`);
}
// Check DSCR
const debtMetrics = calculateDebtMetricsBreakdown();
if (debtMetrics.finalDSCR < 1.2 && debtMetrics.finalDSCR > 0) { // check for > 0 to avoid false positives at start
showWarning(`🚨 Alerta de Riesgo de Deuda: El DSCR (${debtMetrics.finalDSCR.toFixed(1)}x) está por debajo de 1.2x. Riesgo de incumplimiento de covenants.`);
}
}
// ===== USER INTERFACE (UI) UPDATE =====
/**
* Updates the key metrics in the summary cards and then the tables and charts.
* Process: Collects data from `financialResults` and injects it into the DOM.
*/
function updateUI() {
log('🔄 Updating User Interface...');
try {
if (!financialResults.pl || financialResults.pl.length === 0) {
log('❌ No financial data to update UI.');
return;
}

const year5PL = financialResults.pl[4];
const year5BS = financialResults.bs[4];

// Update new investor dashboard
if (year5PL && year5BS) {
// Row 1: Retorno y Escala
document.getElementById('ebitda-year5').textContent = formatCurrency(year5PL.ebitda);
document.getElementById('tir-equity').textContent = financialResults.tirEquity.toFixed(1) + '%';
document.getElementById('aum-value').textContent = formatCurrency(year5BS.totalAssets);
const totalVansFinanced = financialResults.pl.reduce((a, b) => a + (b.addedUnits || 0), 0);
document.getElementById('total-vans-financed').textContent = totalVansFinanced.toLocaleString();
// Row 2: La Maquinaria de Crecimiento
document.getElementById('equity-raised').textContent = formatCurrency(calculateTotalEquityRaised());
document.getElementById('total-debt-raised').textContent = formatCurrency(calculateTotalDebtRaised());
const seriesAMetrics = calculateSeriesAMetrics();
document.getElementById('funding-efficiency').textContent = seriesAMetrics.fundingEfficiency ? seriesAMetrics.fundingEfficiency.toFixed(1) + 'x' : '0.0x';
document.getElementById('capital-per-unit').textContent = seriesAMetrics.capitalPerUnit ? '$' + seriesAMetrics.capitalPerUnit.toFixed(0) + 'K' : '$0K';
// Row 3: Resiliencia y Sostenibilidad
const vagonetasOperativas = totalVansFinanced - (financialResults.niifDetails && financialResults.niifDetails[4]?.niif5?.totalUnitsAccumulatedHeldForSale || 0);
document.getElementById('vagonetas-operativas').textContent = Math.round(vagonetasOperativas).toLocaleString();
const debtMetrics = calculateDebtMetricsBreakdown();
document.getElementById('dscr-final').textContent = debtMetrics.finalDSCR === 999 ? '∞' : debtMetrics.finalDSCR.toFixed(1) + 'x';
document.getElementById('dscr-final').className = 'text-2xl font-bold ' + (debtMetrics.isHealthyDSCR ? 'text-emerald-400' : 'text-amber-400');
document.getElementById('nim-y5').textContent = seriesAMetrics.netInterestMargin ? seriesAMetrics.netInterestMargin.toFixed(1) + '%' : '0.0%';
let actualAutosufficiencyYear = 0;
if(financialResults.pl){
for(let i = 0; i < financialResults.pl.length; i++) {
const plYear = financialResults.pl[i];
if (plYear.totalRevenue > (plYear.opex + plYear.provisions + plYear.impairment)) {
actualAutosufficiencyYear = i + 1;
break;
}
}
}
document.getElementById('autosuficiency-year').textContent = actualAutosufficiencyYear > 0 ? `Año ${actualAutosufficiencyYear}` : 'No alcanzado';
}

updateTables();
updateNIIFTables();
updateCharts();
updateFinancingMatrixWithOptimized(); // NEW

const validations = validateModelComprehensively(modelData, financialResults);
updateValidationPanel(validations);
updateOptimizationStatus();
updateInvestorScore();
updateFundingCoverageCard();
updateCapacityIndicator(); // Update capital capacity indicator

log(`✅ UI Update sequence completed.`);
} catch (error) {
log(`❌ Error in updateUI: ${error.message}`);
}
}
/**
* Coordinates the update of all financial tables (P&L, CF, BS).
*/
function updateTables() {
updatePLTable();
updateCashFlowTable();
updateBalanceSheetTable();
}
/**
* Updates the Profit & Loss (P&L) table.
* Process: Iterates over predefined rows and annual data to populate the table.
*/
function updatePLTable() {
const tbody = document.getElementById('pl-table-body');
if (!tbody || !financialResults.pl.length) return;

tbody.innerHTML = '';

const rows = [
{ label: 'Ingresos por Intereses', key: 'interestRevenue' },
{ label: 'Margen por Originación (NIIF 15)', key: 'recognizedOriginationRevenue' },
{ label: 'Comisiones GNV (NIIF 15)', key: 'gnvCommissions' },
{ label: 'Ingresos Refacciones (NIIF 15)', key: 'sparePartsRevenue' },
{ label: 'Ingresos Marketplace (NIIF 15)', key: 'marketplaceRevenue' },
{ label: 'Total Ingresos Operativos', key: 'totalRevenue', total: true },

{ label: 'COGS Refacciones', key: 'totalCOGS', negative: true, fromPL: true },
{ label: 'Utilidad Bruta', key: 'grossProfit', total: true },

{ label: 'Gastos Operativos (OPEX)', key: 'opex', negative: true },
{ label: 'Provisiones NIIF 9', key: 'provisions', negative: true },
{ label: 'Pérdida por Deterioro NIIF 5', key: 'impairment', negative: true },
{ label: 'EBITDA', key: 'ebitda', total: true, emphasize: true },
{ label: 'Depreciación', key: 'depreciation', negative: true },
{ label: 'EBIT', key: 'ebit', total: true },
{ label: 'Gastos por Intereses (Deuda)', key: 'interestExpense', negative: true },
{ label: 'Ganancia Antes de Impuestos (EBT)', key: 'earningsBeforeTax', total: true },
{ label: 'Impuesto sobre la Renta', key: 'incomeTaxExpense', negative: true },
{ label: 'Utilidad Neta', key: 'netIncome', total: true, emphasize: true }
];
rows.forEach(row => {
const tr = document.createElement('tr');
if (row.total) tr.classList.add('bg-gray-50');
if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');

const labelCell = document.createElement('td');
labelCell.textContent = row.label;
if (row.total) labelCell.classList.add('font-bold');
tr.appendChild(labelCell);

financialResults.pl.forEach(yearData => {
const cell = document.createElement('td');
let value = yearData[row.key] || 0;

if (row.negative && value > 0) {
cell.textContent = '(' + formatCurrency(value) + ')';
cell.classList.add('negative');
} else {
cell.textContent = formatCurrency(value);
if (value > 0 && !row.negative) cell.classList.add('positive');
if (value < 0) cell.classList.add('negative');
}

if (value === 0) {
cell.style.color = '#94a3b8';
}
if (row.total) cell.classList.add('font-bold');
tr.appendChild(cell);
});

tbody.appendChild(tr);
});
log('✅ Profit & Loss Table updated.');
}
/**
* Updates the Cash Flow (CF) table.
* Process: Iterates over predefined rows and annual data to populate the table.
*/
function updateCashFlowTable() {
const tbody = document.getElementById('cf-table-body');
if (!tbody || !financialResults.cf.length) return;

tbody.innerHTML = '';

const rows = [
{ label: 'FLUJO DE EFECTIVO OPERATIVO', total: true, emphasize: true, isHeader: true },
{ label: '  Utilidad Neta', key: 'netIncome', fromPL: true },
{ label: '  + Depreciación', key: 'depreciation', fromPL: true },
{ label: '  + Pérdida por Deterioro NIIF 5', key: 'impairment', fromPL: true },
{ label: '  + Δ Provisiones (NIIF 9)', key: 'deltaProvisions', fromCF: true, positive: true },
{ label: '  - Δ Cuentas por Cobrar', key: 'receivables', deltaFromBS: true, negative: true },
{ label: '  + Δ Pasivos Contractuales (NIIF 15)', key: 'deltaContractLiabilities', fromCF: true, positive: true },
{ label: '  - Impuestos Pagados', key: 'incomeTaxPaid', fromCF: true, negative: true },
{ label: 'TOTAL FLUJO DE EFECTIVO OPERATIVO', key: 'operatingCash', total: true, emphasize: true },
{ label: '  + Pagos Principal Clientes', key: 'clientPrincipalPaymentsReceived', fromCF: true, isInfo: true },
{ label: '  + Pagos Interés Clientes', key: 'clientInterestPaymentsReceived', fromCF: true, isInfo: true },

{ label: 'FLUJO DE EFECTIVO DE INVERSIÓN', total: true, separator: true, emphasize: true, isHeader: true },
{ label: '  - CAPEX Vagonetas (Activos Fijos)', key: 'investingCash', fromCF: true, negative: true, specialHandling: 'capexOnly' },
{ label: '  - Inversión en Tecnología', key: 'techInvestmentThisYear', fromCF: true, negative: true },
{ label: 'TOTAL FLUJO DE EFECTIVO DE INVERSIÓN', key: 'investingCash', total: true, emphasize: true, duplicate: true },

{ label: 'FLUJO DE EFECTIVO DE FINANCIACIÓN', total: true, separator: true, emphasize: true, isHeader: true },
{ label: '  Capital Recibido', fromModelData: true, yearSpecific: true, key: 'partnerCapitalization' },
{ label: '  Venture Debt Recibido', key: 'currentYearVentureDebtDraw', fromCF: true, positive: true },
{ label: '  Deuda Comercial Recibida', key: 'additionalFundingRaised', fromCF: true, positive: true },
{ label: '  - Amortización Deuda', key: 'debtPrincipalRepayment', fromCF: true, negative: true },
{ label: 'TOTAL FLUJO DE EFECTIVO DE FINANCIACIÓN', key: 'financingCash', total: true, emphasize: true, duplicate: true },

{ label: 'INCREMENTO NETO DE EFECTIVO', key: 'netCash', total: true, separator: true, emphasize: true },
{ label: 'SALDO DE EFECTIVO AL FINAL DEL PERIODO', key: 'cash', fromBS: true, total: true, emphasize: true }
];
rows.forEach(row => {
const tr = document.createElement('tr');
if (row.total) tr.classList.add('bg-gray-50');
if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
if (row.separator) tr.classList.add('border-t-2', 'border-gray-200');
if (row.isInfo) tr.style.fontStyle = 'italic';
const labelCell = document.createElement('td');
labelCell.textContent = row.label;
if (row.total) labelCell.classList.add('font-bold');
tr.appendChild(labelCell);

// Handle Año 0 cell
const cell0 = document.createElement('td');
if (row.isHeader) {
cell0.textContent = '-';
} else if (row.label === '  Capital Recibido') {
cell0.textContent = formatCurrency(modelData.seriesA);
cell0.classList.add('positive', 'font-bold');
} else if (row.key === 'netCash' || row.key === 'cash') {
cell0.textContent = formatCurrency(modelData.seriesA);
cell0.classList.add('positive', 'font-bold');
} else {
cell0.textContent = '-';
}
tr.appendChild(cell0);

// Handle Año 1-5 cells
for (let i = 0; i < 5; i++) {
const cell = document.createElement('td');
if(row.isHeader) {
cell.textContent = '-';
tr.appendChild(cell);
continue;
}
let value;
if (row.fromPL) {
value = financialResults.pl[i][row.key] || 0;
} else if (row.fromBS) {
value = financialResults.bs[i][row.key] || 0;
} else if (row.fromCF) {
value = financialResults.cf[i][row.key] || 0;
} else if (row.deltaFromBS) {
const prevValue = (i === 0) ? 0 : financialResults.bs[i-1][row.key];
const currentValue = financialResults.bs[i][row.key];
value = currentValue - prevValue;
} else if (row.fromModelData && row.yearSpecific) {
const currentYear = i + 1;
if (row.key === 'partnerCapitalization') {
value = (modelData[`seriesB_newInvestors_year${currentYear}`] || 0) + (modelData[`partnerCapitalizationYear${currentYear}`] || 0);
} else {
value = 0;
}
} else {
value = financialResults.cf[i][row.key] || 0;
}

if (row.specialHandling === 'capexOnly') {
value = value + (financialResults.cf[i]['techInvestmentThisYear'] || 0);
}
if (row.deltaFromBS && row.key === 'receivables') {
if (value > 0) { // Increase in A/R is a cash USE
cell.textContent = '(' + formatCurrency(value) + ')';
cell.classList.add('negative');
} else { // Decrease in A/R is a cash SOURCE
cell.textContent = formatCurrency(Math.abs(value));
cell.classList.add('positive');
}
} else if (row.negative && value > 0) {
cell.textContent = '(' + formatCurrency(value) + ')';
cell.classList.add('negative');
} else if (row.positive && value > 0) {
cell.textContent = formatCurrency(value);
cell.classList.add('positive');
}
else {
cell.textContent = formatCurrency(value);
if (value > 0 && !row.negative) cell.classList.add('positive');
if (value < 0) cell.classList.add('negative');
}

if (value === 0) {
cell.style.color = '#94a3b8';
}
if (row.total) cell.classList.add('font-bold');
tr.appendChild(cell);
}

tbody.appendChild(tr);
});
log('✅ Cash Flow Table updated.');
}
/**
* Updates the Balance Sheet (BS) table.
* Process: Iterates over predefined rows and annual data to populate the table.
* Performs balance sheet validation and displays the result.
*/
function updateBalanceSheetTable() {
const tbody = document.getElementById('bs-table-body');
if (!tbody || !financialResults.bs.length) return;

tbody.innerHTML = '';

const rows = [
{ label: 'ACTIVOS', total: true, emphasize: true },
{ label: '  Efectivo y Equivalentes', key: 'cash' },
{ label: '  Cuentas por Cobrar (Brutas)', key: 'receivables', isInfo: true },
{ label: '  (-) Provisiones NIIF 9', key: 'provisions', negative: true, isContraAsset: true },
{ label: '  Cuentas por Cobrar, Netas', key: 'receivablesNet', bold: true },
{ label: '  Activos Fijos Netos (Vagonetas)', key: 'fixedAssets' },
{ label: '  Activos Mantenidos para Venta (NIIF 5)', key: 'assetsHeldForSale' },
{ label: 'TOTAL ACTIVOS', key: 'totalAssets', total: true, emphasize: true },
{ label: 'PASIVOS Y PATRIMONIO', total: true, separator: true, emphasize: true },
{ label: '  Deuda Financiera', key: 'debt' },
{ label: '  Pasivos por Contrato (NIIF 15)', key: 'contractLiabilities' },
{ label: 'TOTAL PASIVOS', key: 'totalLiabilities', total: true },
{ label: '  Patrimonio', key: 'equity' },
{ label: 'TOTAL PASIVOS + PATRIMONIO', key: 'totalLiabilitiesEquity', total: true, emphasize: true }
];
rows.forEach(row => {
const tr = document.createElement('tr');
if (row.total) tr.classList.add('bg-gray-50');
if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
if (row.separator) tr.classList.add('border-t-2', 'border-gray-200');

const labelCell = document.createElement('td');
labelCell.textContent = row.label;
if (row.total || row.bold) labelCell.classList.add('font-bold');
if (row.isInfo || row.isContraAsset) labelCell.style.paddingLeft = '2.5rem';
tr.appendChild(labelCell);

financialResults.bs.forEach(yearData => {
const cell = document.createElement('td');
let value = yearData[row.key] || 0;
if (row.negative && value > 0) {
cell.textContent = '(' + formatCurrency(value) + ')';
cell.classList.add('negative');
} else {
cell.textContent = formatCurrency(value);
if (value > 0 && !row.negative) cell.classList.add('positive');
if (value < 0) cell.classList.add('negative');
}

if (value === 0) {
cell.style.color = '#94a3b8';
}
if (row.total) cell.classList.add('font-bold');
tr.appendChild(cell);
});

tbody.appendChild(tr);
});

const validationDiv = document.getElementById('balance-validation');
let balanceValid = true;
let maxDifference = 0;

financialResults.bs.forEach((bsYear, index) => {
const difference = Math.abs(bsYear.totalAssets - bsYear.totalLiabilitiesEquity);
maxDifference = Math.max(maxDifference, difference);
if (difference > BALANCE_TOLERANCE) balanceValid = false;
});
if (balanceValid) {
validationDiv.innerHTML = '<span class="text-green-600">✅ Balance validated: Total Assets = Total Liabilities + Equity.</span>';
validationDiv.classList.remove('bg-red-100', 'text-red-800');
validationDiv.classList.add('bg-green-100', 'text-green-800');
} else {
validationDiv.innerHTML = `<span class="text-red-600">❌ Balance error: Difference of ${formatCurrency(maxDifference)}. Review calculations.</span>`;
validationDiv.classList.remove('bg-green-100', 'text-red-800');
validationDiv.classList.add('bg-red-100', 'text-red-800');
}
log('✅ Balance Sheet Table updated and validated.');
}
// ===== IFRS DETAIL TABLES =====
/**
* Updates the IFRS 15, IFRS 9, and IFRS 5 sections with detailed data.
* Process: Injects dynamic HTML with specific tables and explanations for each standard.
*/
function updateNIIFTables() {
log('Updating IFRS detail tables...');
if (!financialResults.niifDetails || financialResults.niifDetails.length === 0) {
log('❌ No IFRS data to display.');
return;
}

const container15 = document.getElementById('niif15-container');
if (container15) {
container15.innerHTML = `
<div class="overflow-x-auto">
<table class="financial-table">
<thead>
<tr>
<th>Concepto</th>
<th>Año 1</th>
<th>Año 2</th>
<th>Año 3</th>
<th>Año 4</th>
<th>Año 5</th>
</tr>
</thead>
<tbody>
<tr>
<td>Margen Originación (Inicial por Cohorte Nueva)</td>
${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.originationContractValueInitial || 0)}</td>`).join('')}
</tr>
<tr>
<td>Comisión Upfront (Inicial por Cohorte Nueva)</td>
${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.upfrontCommissionInitial || 0)}</td>`).join('')}
</tr>
<tr>
<td>Margen Originación + Upfront (Reconocido P&L)</td>
${financialResults.niifDetails.map(d => `<td class="positive">${formatCurrency(d.niif15.recognizedOriginationRevenue || 0)}</td>`).join('')}
</tr>
<tr>
<td>Pasivos por Contrato (Acumulado)</td>
${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.contractLiabilitiesBalance || 0)}</td>`).join('')}
</tr>
<tr>
<td>Ingresos GNV (Reconocido P&L)</td>
${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.gnvCommissions || 0)}</td>`).join('')}
</tr>
<tr>
<td>Ingresos Refacciones (Reconocido P&L)</td>
${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.sparePartsRevenue || 0)}</td>`).join('')}
</tr>
<tr>
<td>COGS Refacciones (NIIF 15)</td>
${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.sparePartsCOGS || 0)}</td>`).join('')}
</tr>
<tr>
<td>Ingresos Marketplace (Reconocido P&L)</td>
${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.marketplaceRevenue || 0)}</td>`).join('')}
</tr>
</tbody>
</table>
</div>
<div class="mt-4 p-4 bg-slate-800 rounded-lg text-sm text-slate-300">
<h5 class="font-semibold text-base mb-1 text-white">Explicación NIIF 15 (Ingresos de Contratos con Clientes)</h5>
<p class="mb-1">• NIIF 15 establece un modelo de 5 pasos para reconocer ingresos. Se reconocen cuando (o a medida que) se satisfacen las <strong>obligaciones de desempeño</strong>.</p>
<ul class="list-disc list-inside ml-4">
<li><strong>Comisiones de Originación (Margen + Upfront):</strong> Se difieren como "Pasivos por Contrato" y se reconocen <strong>a lo largo del tiempo</strong> a medida que se amortiza el principal del préstamo o linealmente sobre la vida del préstamo (para upfront).</li>
<li><strong>Servicios GNV y Marketplace:</strong> Se reconocen <strong>al devengo</strong> (a lo largo del tiempo) a medida que los servicios se proveen por las unidades activas.</li>
<li><strong>Servicios de Refacciones:</strong> Se reconocen <strong>en un punto en el tiempo</strong> (al momento de la entrega, asumido en el año de adición de la unidad).</li>
</ul>
<p class="mb-1">• Los ingresos por intereses se rigen por NIIF 9, no por NIIF 15.</p>
<p class="mb-1">• El Balance General ahora refleja los <strong>Pasivos por Contrato</strong> para los ingresos diferidos.</p>
</div>
`;
log('✅ IFRS 15 updated.');
}

const container9 = document.getElementById('niif9-container');
if (container9) {
const year5NIIF9 = financialResults.niifDetails[4]?.niif9;
if (year5NIIF9) {
container9.innerHTML = `
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<div class="p-4 bg-sky-950 rounded-lg text-center text-sky-200">
<h5 class="font-semibold text-sky-400">ECL Etapa 1 (Año 5)</h5>
<p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage1)}</p>
<p class="text-sm">PD: ${(year5NIIF9.pdStage1 * 100).toFixed(1)}%</p>
</div>
<div class="p-4 bg-amber-950 rounded-lg text-center text-amber-200">
<h5 class="font-semibold text-amber-400">ECL Etapa 2 (Año 5)</h5>
<p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage2)}</p>
<p class="text-sm">PD: ${(year5NIIF9.pdStage2 * 100).toFixed(1)}%</p>
</div>
<div class="p-4 bg-rose-950 rounded-lg text-center text-rose-200">
<h5 class="font-semibold text-rose-400">ECL Etapa 3 (Año 5)</h5>
<p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage3)}</p>
<p class="text-sm">PD: ${(year5NIIF9.pdStage3 * 100).toFixed(1)}% (+50% si >2 años)</p>
</div>
</div>
<div class="text-center p-4 bg-indigo-950 rounded-lg mb-4 text-indigo-200">
<h5 class="font-semibold text-indigo-400">Total Provisiones ECL Antes de Ajustes</h5>
<p class="text-2xl font-bold">${formatCurrency(year5NIIF9.totalECLBeforeAdjustment)}</p>
<p class="text-sm">LGD: ${(year5NIIF9.lgd * 100).toFixed(1)}%. Ajuste Económico: ${(year5NIIF9.economicAdjustmentFactor || 0).toFixed(2)}x</p>
</div>
<div class="text-center p-4 ${year5NIIF9.proteccionRodandoActiva ? 'bg-emerald-950 text-emerald-200' : 'bg-slate-800 text-slate-200'} rounded-lg">
<h5 class="font-semibold ${year5NIIF9.proteccionRodandoActiva ? 'text-emerald-400' : 'text-slate-400'}">Gasto por Provisiones NIIF 9 (P&L del Año 5)</h5>
<p class="text-2xl font-bold">${formatCurrency(year5NIIF9.provisionesConProteccion)}</p>
${year5NIIF9.proteccionRodandoActiva ?
`<p class="text-sm text-emerald-300"> <strong>✅ Reducción por Protección: ${formatCurrency(year5NIIF9.reduccionPorProteccion)}</strong></p>` :
'<p class="text-sm text-slate-400">Protección Rodando inactiva</p>'}
</div>
<div class="mt-4 text-center p-4 bg-slate-900 rounded-lg text-slate-200">
<h5 class="font-semibold text-slate-400">Saldo Acumulado de Provisiones NIIF 9 (Balance Año 5)</h5>
<p class="text-2xl font-bold">${formatCurrency(year5NIIF9.saldoProvisionesAcumulado)}</p>
<p class="text-sm">Este es el saldo que aparece en el Balance General.</p>
</div>
<div class="mt-4 p-4 bg-slate-800 rounded-lg text-sm text-slate-300">
<h5 class="font-semibold text-base mb-1 text-white">Explicación NIIF 9 (Instrumentos Financieros)</h5>
<p class="mb-1">• NIIF 9 requires the recognition of expected credit loss (ECL) provisions on financial instruments (loan portfolio).</p>
<p class="mb-1">• <strong>Three-Stage Model:</strong> The portfolio is segmented by risk.</p>
<ul class="list-disc list-inside ml-4">
<li><strong>Stage 1:</strong> Loans with low credit risk (12-month PD).</li>
<li><strong>Stage 2:</strong> Loans with significant increase in risk (lifetime PD).</li>
<li><strong>Stage 3:</strong> Loans with credit impairment (lifetime PD).</li>
</ul>
<p class="mb-1">• <strong>ECL Calculation:</strong> ECL = Average Exposure × Probability of Default (PD) × Loss Given Default (LGD).</p>
<p class="mb-1">• <strong>Dynamic PD:</strong> PD is adjusted according to loan age (increases 50% if > 2 years) to reflect increasing risk.</p>
<p class="mb-1">• <strong>Prospective Information:</strong> The economic adjustment factor allows incorporating future expectations about credit risk.</p>
<p class="mb-1">• "Protección Rodando" simula un mecanismo que reduce el gasto por provisiones finales.</p>
</div>
`;
log('✅ IFRS 9 updated.');
} else {
log('⚠️ IFRS 9 data for Year 5 incomplete.');
}
}

const container5 = document.getElementById('niif5-container');
if (container5) {
const year5NIIF5 = financialResults.niifDetails[4]?.niif5;
if (year5NIIF5) {
container5.innerHTML = `
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div class="p-4 bg-purple-950 rounded-lg text-center text-purple-200">
<h5 class="font-semibold text-purple-400">Unidades Reposadas (Año 5)</h5>
<p class="text-xl font-bold">${formatCurrency(year5NIIF5.unidadesClasificadasAnuales.toFixed(0))}</p>
<p class="text-sm">Unidades reclasificadas como mantenidas para venta este año.</p>
</div>
<div class="p-4 bg-indigo-950 rounded-lg text-center text-indigo-200">
<h5 class="font-semibold text-indigo-400">Valor en Libros Original (Activos Reposedos Año 5)</h5>
<p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorEnLibrosClasificado)}</p>
<p class="text-sm">Valor contable de las unidades clasificadas para venta en el Año 5.</p>
</div>
<div class="p-4 bg-blue-950 rounded-lg text-center text-blue-200">
<h5 class="font-semibold text-blue-400">Valor Razonable Neto (Año 5)</h5>
<p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorRazonableMenosCostos)}</p>
<p class="text-sm">Valor de venta esperado menos costos de venta.</p>
</div>
<div class="p-4 ${year5NIIF5.perdidaPorDeterioro > 0 ? 'bg-rose-950 text-rose-200' : 'bg-emerald-950 text-emerald-200'} rounded-lg">
<h5 class="font-semibold ${year5NIIF5.perdidaPorDeterioro > 0 ? 'text-rose-400' : 'text-emerald-400'}">Pérdida por Deterioro (Año 5)</h5>
<p class="text-xl font-bold">${formatCurrency(year5NIIF5.perdidaPorDeterioro > 0 ? year5NIIF5.perdidaPorDeterioro : 0)}</p>
<p class="text-sm">Impacto en el Estado de Resultados por la reclasificación.</p>
</div>
</div>
<div class="mt-4 text-center p-4 bg-slate-900 rounded-lg text-slate-200">
<h5 class="font-semibold text-slate-400">Saldo Acumulado de Activos NIIF 5 (Año 5)</h5>
<p class="text-2xl font-bold">${formatCurrency(year5NIIF5.saldoActivosParaVentaAcumulado)}</p>
<p class="text-sm">Este es el saldo que aparece en el Balance General.</p>
</div>
<div class="mt-4 p-4 bg-slate-800 rounded-lg text-sm text-slate-300">
<h5 class="font-semibold text-base mb-1 text-white">Explicación NIIF 5 (Activos No Corrientes Mantenidos para la Venta)</h5>
<p class="mb-1">• Non-current assets (vans) expected to be sold in the short term are classified as "Held for Sale".</p>
<p class="mb-1">• These assets are measured at the lower of their carrying amount and fair value less costs to sell. Their depreciation is suspended.</p>
<p class="mb-1">• An impairment loss is recognized if the carrying amount exceeds the net fair value less costs to sell. Gains on reversal of impairment are limited to the original loss.</p>
</div>
`;
log('✅ IFRS 5 updated.');
} else {
log('⚠️ IFRS 5 data for Year 5 incomplete.');
}
}
}

// ===== CHARTS (Chart.js) =====
/**
* Initializes Chart.js instances for the charts.
*/
function initializeCharts() {
try {
Object.keys(charts).forEach(key => {
if (charts[key]) {
charts[key].destroy();
}
});
charts = {};
// Protección Rodando Impact Chart
const ctx1 = document.getElementById('proteccionImpactChart');
if (ctx1) {
charts.proteccion = new Chart(ctx1, {
type: 'bar',
data: {
labels: ['Evento Adverso', 'Detección IA', 'Intervención PIA', 'Flexibilidad', 'Cliente Preservado'],
datasets: [{
label: 'Sin Protección (%)',
data: [100, 70, 55, 47, 47],
backgroundColor: '#ef4444'
}, {
label: 'Con Protección Rodando™ (%)',
data: [100, 85, 77, 73, 73],
backgroundColor: '#10b981'
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { position: 'top', labels: { color: '#94a3b8' } } },
scales: {
x: { ticks: { color: '#94a3b8' } },
y: { ticks: { color: '#94a3b8', callback: v => v + '%' }, max: 100 }
}
}
});
}
// Revenue Evolution Chart
const ctx2 = document.getElementById('revenueEvolutionChart');
if (ctx2) {
charts.revenue = new Chart(ctx2, {
type: 'line',
data: {
labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
datasets: [{
label: 'Intereses Financiamiento',
data: [85, 75, 60, 50, 45],
borderColor: '#0ea5e9',
backgroundColor: 'rgba(14, 165, 233, 0.1)',
fill: true
}, {
label: 'Comisiones GNV',
data: [12, 18, 25, 30, 32],
borderColor: '#10b981',
backgroundColor: 'rgba(16, 185, 129, 0.1)',
fill: true
}, {
label: 'Marketplace + PMA',
data: [3, 7, 15, 20, 23],
borderColor: '#8b5cf6',
backgroundColor: 'rgba(139, 92, 246, 0.1)',
fill: true
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
scales: {
x: { ticks: { color: '#94a3b8' } },
y: { ticks: { color: '#94a3b8', callback: v => v + '%' } }
}
}
});
}
// Cash Flow Resilience Chart
const ctx3 = document.getElementById('cashFlowResilienceChart');
if (ctx3) {
charts.cashFlowResilienceChart = new Chart(ctx3, {
type: 'bar',
data: {
labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
datasets: [
{ label: 'Operativo', data: [0,0,0,0,0], backgroundColor: '#10b981' },
{ label: 'Inversión', data: [0,0,0,0,0], backgroundColor: '#ef4444' },
{ label: 'Financiamiento', data: [0,0,0,0,0], backgroundColor: '#3b82f6' }
]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
scales: {
x: { ticks: { color: '#94a3b8' } },
y: { ticks: { color: '#94a3b8' } }
}
}
});
}
// Gamification Impact Chart
const ctx4 = document.getElementById('gamificationChart');
if (ctx4) {
charts.gamificationChart = new Chart(ctx4, {
type: 'radar',
data: {
labels: ['Retención', 'Eficiencia', 'Puntualidad', 'Satisfacción', 'Seguridad', 'Mantenimiento'],
datasets: [
{
label: 'Sin Gamificación',
data: [65, 70, 75, 70, 60, 65],
borderColor: '#ef4444',
backgroundColor: 'rgba(239, 68, 68, 0.2)',
pointBackgroundColor: '#ef4444'
},
{
label: 'Con Gamificación RAG',
data: [85, 88, 92, 90, 85, 90],
borderColor: '#10b981',
backgroundColor: 'rgba(16, 185, 129, 0.2)',
pointBackgroundColor: '#10b981'
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
scales: {
r: {
beginAtZero: true,
max: 100,
ticks: { color: '#94a3b8' },
grid: { color: 'rgba(255, 255, 255, 0.1)' }
}
}
}
});
}
// Path to Leadership Chart
const ctx5 = document.getElementById('leadershipChart');
if (ctx5) {
charts.leadershipChart = new Chart(ctx5, {
type: 'line',
data: {
labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
datasets: [
{
label: 'RAG Market Share',
data: [2, 5, 12, 18, 25],
borderColor: '#10b981',
backgroundColor: 'rgba(16, 185, 129, 0.1)',
fill: true,
tension: 0.3
},
{
label: 'Competidor Tradicional',
data: [25, 23, 20, 18, 16],
borderColor: '#ef4444',
fill: false,
tension: 0.3
},
{
label: 'Competidor Digital',
data: [15, 16, 15, 14, 13],
borderColor: '#94a3b8',
fill: false,
tension: 0.3
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
scales: {
x: { ticks: { color: '#94a3b8' } },
y: { ticks: { color: '#94a3b8', callback: v => v + '%' }, max: 30 }
}
}
});
}
// Competitive Moat Chart
const ctx6 = document.getElementById('moatChart');
if (ctx6) {
charts.moatChart = new Chart(ctx6, {
type: 'bar',
data: {
labels: ['Tecnología IA', 'Red Partners', 'Data Propietaria', 'Switching Costs', 'Economías Escala'],
datasets: [{
label: 'Fortaleza del Moat (1-10)',
data: [9, 7, 8, 6, 5],
backgroundColor: [
'#10b981', // IA = fuerte
'#3b82f6', // Partners = bueno
'#10b981', // Data = fuerte
'#f59e0b', // Switching = medio
'#ef4444'  // Escala = débil aún
]
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { display: false } },
scales: {
x: { ticks: { color: '#94a3b8' } },
y: { ticks: { color: '#94a3b8' }, max: 10, beginAtZero: true }
}
}
});
}
// Capital Efficiency Chart
const ctx7 = document.getElementById('capitalEfficiencyChart');
if (ctx7) {
charts.capitalEfficiencyChart = new Chart(ctx7, {
type: 'doughnut',
data: {
labels: ['RAG Actual', 'Target Serie A', 'Industria Promedio'],
datasets: [{
data: [750, 750, 900],
backgroundColor: ['#10b981', '#3b82f6', '#94a3b8']
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'bottom',
labels: { color: '#94a3b8', font: { size: 10 } }
}
}
}
});
}
log('✅ New Rodando charts initialized');
} catch (error) {
log(`❌ Error: ${error.message}`);
}
}

/**
* Updates the chart data with current financial results.
*/
function updateCharts() {
try {
if (!financialResults.pl.length) return;
// Future functions to update new charts will be called here
// Update Capital Efficiency Chart
if (charts.capitalEfficiencyChart) {
const totalUnits = financialResults.pl.reduce((sum, pl) => sum + (pl.addedUnits || 0), 0);
const totalCapex = totalUnits * getTotalPackageCost();
const capexPerUnit = totalUnits > 0 ? totalCapex / totalUnits / 1000 : 0;
charts.capitalEfficiencyChart.data.labels = ['RAG Actual', 'Target A', 'Industria'];
charts.capitalEfficiencyChart.data.datasets = [{
data: [capexPerUnit, 750, 900],
backgroundColor: ['#10b981', '#3b82f6', '#94a3b8']
}];
charts.capitalEfficiencyChart.update();
}
// Update Cash Flow Resilience Chart
if (charts.cashFlowResilienceChart && financialResults.cf.length >= 5) {
const operatingCF = financialResults.cf.map(cf => cf.operatingCash / 1000000);
const investingCF = financialResults.cf.map(cf => cf.investingCash / 1000000);
const financingCF = financialResults.cf.map(cf => cf.financingCash / 1000000);
charts.cashFlowResilienceChart.data.labels = ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'];
charts.cashFlowResilienceChart.data.datasets = [
{ label: 'Operativo', data: operatingCF, backgroundColor: '#10b981' },
{ label: 'Inversión', data: investingCF, backgroundColor: '#ef4444' },
{ label: 'Financiamiento', data: financingCF, backgroundColor: '#3b82f6' }
];
charts.cashFlowResilienceChart.update();
}
log('✅ Rodando charts updated');
} catch (error) {
log(`Error updating charts: ${error.message}`);
}
}

/**
 * CAPITAL ALLOCATION INTELLIGENCE ENGINE - Core Validation
 * Validates constraints de capital en tiempo real
 */
function validateCapitalConstraints() {
    const warnings = [];
    const errors = [];
    let totalAvailableFunding = modelData.seriesA;
    let cumulativeCapexRequired = 0;
    
    // Calcular funding disponible total
    for (let year = 1; year <= 5; year++) {
        totalAvailableFunding += (modelData[`partnerCapitalizationYear${year}`] || 0);
        totalAvailableFunding += (modelData[`ventureDebtYear${year}`] || 0);
        totalAvailableFunding += (modelData[`commercialDebtYear${year}`] || 0);
        totalAvailableFunding += (modelData[`seriesB_newInvestors_year${year}`] || 0);
    }
    
    // Agregar líneas de crédito disponibles
    totalAvailableFunding += modelData.ventureDebtLineAvailable;
    totalAvailableFunding += modelData.commercialDebtLineAvailable;
    
    // Validar año por año con buffer de liquidez 15%
    for (let year = 0; year < 5; year++) {
        const yearCapex = modelData.unitsPerYear[year] * getTotalPackageCost();
        cumulativeCapexRequired += yearCapex;
        
        const requiredFundingWithBuffer = cumulativeCapexRequired * 1.15;
        
        if (requiredFundingWithBuffer > totalAvailableFunding) {
            const deficit = requiredFundingWithBuffer - totalAvailableFunding;
            errors.push({
                type: 'FUNDING_DEFICIT',
                year: year + 1,
                deficit: deficit,
                message: `🚨 Año ${year + 1}: Déficit de ${formatCurrency(deficit)}. CAPEX acumulado excede funding disponible.`
            });
        }
    }
    
    return { warnings, errors, totalAvailableFunding, cumulativeCapexRequired };
}

/**
 * Auto-ajusta unidades para respetar constraints
 */
function autoAdjustUnitsForCapacity() {
    const validation = validateCapitalConstraints();
    
    if (validation.errors.length > 0) {
        const maxAffordableCapex = validation.totalAvailableFunding * 0.85; // 85% utilization
        const costPerUnit = getTotalPackageCost();
        const maxTotalUnits = Math.floor(maxAffordableCapex / costPerUnit);
        
        // Redistribuir unidades proporcionalmente
        const originalTotal = modelData.unitsPerYear.reduce((a, b) => a + b, 0);
        if (originalTotal > maxTotalUnits) {
            const scaleFactor = maxTotalUnits / originalTotal;
            
            for (let i = 0; i < modelData.unitsPerYear.length; i++) {
                const adjustedUnits = Math.floor(modelData.unitsPerYear[i] * scaleFactor);
                modelData.unitsPerYear[i] = adjustedUnits;
                
                // Actualizar UI
                const unitInput = document.getElementById(`unitsPerYear-${i + 1}`);
                if (unitInput) {
                    unitInput.value = adjustedUnits;
                    unitInput.style.borderColor = '#f59e0b'; // amber warning
                }
            }
            
            showCapitalConstraintWarning(maxTotalUnits, originalTotal, scaleFactor);
            return true;
        }
    }
    return false;
}

/**
 * Legacy function - kept for compatibility
 */
function validateCapexConstraints() {
    // Call the new validation system
    const validation = validateCapitalConstraints();
    
    if (validation.errors.length > 0) {
        log('⚠️ Capital constraints violated - auto-adjusting units');
        autoAdjustUnitsForCapacity();
    }
}

/**
 * NEW: Captures the user's financing plan before calculations overwrite modelData.
 */
function capturePlannedFinancing() {
    plannedFinancingData = {};
    const keysToCapture = [
        'ventureDebtYear1', 'ventureDebtYear2', 'ventureDebtYear3', 'ventureDebtYear4', 'ventureDebtYear5',
        'commercialDebtYear1', 'commercialDebtYear2', 'commercialDebtYear3', 'commercialDebtYear4', 'commercialDebtYear5',
        'partnerCapitalizationYear1', 'partnerCapitalizationYear2', 'partnerCapitalizationYear3', 'partnerCapitalizationYear4', 'partnerCapitalizationYear5',
        'seriesB_newInvestors_year2', 'seriesB_newInvestors_year3'
    ];
    keysToCapture.forEach(key => {
        plannedFinancingData[key] = modelData[key] || 0;
    });
}


/**
 * Actualiza estado visual del input basado en validación
 */
function updateInputValidationState(input, validation, yearIndex) {
    const warningDiv = document.getElementById(`constraint-warning-${yearIndex + 1}`);
    
    // Reset classes
    input.classList.remove('border-red-500', 'border-amber-500', 'border-emerald-500');
    if (warningDiv) warningDiv.classList.add('hidden');
    
    if (validation.errors.length > 0) {
        input.classList.add('border-red-500');
        if (warningDiv) {
            warningDiv.classList.remove('hidden');
            warningDiv.innerHTML = `🚨 ${validation.errors[0].message}`;
        }
        
        // Mostrar modal de error
        showCapitalConstraintError(validation.errors[0]);
    } else {
        input.classList.add('border-emerald-500');
    }
}

/**
 * Modal de alerta para constraint violations
 */
function showCapitalConstraintError(error) {
    // Remove existing modal if any
    const existingModal = document.querySelector('.capital-constraint-modal');
    if (existingModal) existingModal.remove();
    
    const modal = document.createElement('div');
    modal.className = 'capital-constraint-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-slate-800 p-6 rounded-lg max-w-md mx-4 border border-red-500">
            <h3 class="text-lg font-semibold text-red-400 mb-3">🚨 Capital Constraint Violated</h3>
            <p class="text-slate-300 mb-4">${error.message}</p>
            <div class="flex gap-3">
                <button onclick="autoAdjustUnitsForCapacity(); this.closest('.capital-constraint-modal').remove(); forceCalculate();" 
                        class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded">
                    Auto-Ajustar
                </button>
                <button onclick="this.closest('.capital-constraint-modal').remove();" 
                        class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded">
                    Cerrar
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

/**
 * Warning modal para auto-ajuste
 */
function showCapitalConstraintWarning(maxTotalUnits, originalTotal, scaleFactor) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-slate-800 p-6 rounded-lg max-w-md mx-4 border border-amber-500">
            <h3 class="text-lg font-semibold text-amber-400 mb-3">⚠️ Units Auto-Adjusted</h3>
            <p class="text-slate-300 mb-4">
                Las unidades fueron ajustadas automáticamente de ${originalTotal} a ${maxTotalUnits} 
                (factor: ${(scaleFactor * 100).toFixed(1)}%) para respetar los límites de capital.
            </p>
            <button onclick="this.closest('.fixed').remove();" 
                    class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded w-full">
                Entendido
            </button>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (modal.parentNode) modal.remove();
    }, 5000);
}

/**
 * Actualiza los máximos dinámicos para cada año
 */
function updateDynamicConstraints(yearIndex) {
    const validation = validateCapitalConstraints();
    const maxUnitsSpan = document.getElementById(`max-units-year-${yearIndex + 1}`);
    
    if (maxUnitsSpan && validation.totalAvailableFunding > 0) {
        const costPerUnit = getTotalPackageCost();
        const maxAffordableCapex = validation.totalAvailableFunding * 0.85; // 85% utilization
        const maxTotalUnits = Math.floor(maxAffordableCapex / costPerUnit);
        
        // Calculate units used in previous years
        let unitsUsedBefore = 0;
        for (let i = 0; i < yearIndex; i++) {
            unitsUsedBefore += modelData.unitsPerYear[i];
        }
        
        const maxUnitsThisYear = Math.max(0, maxTotalUnits - unitsUsedBefore);
        maxUnitsSpan.textContent = `(max: ${maxUnitsThisYear})`;
        
        // Color coding based on availability
        if (maxUnitsThisYear < 50) {
            maxUnitsSpan.className = 'text-red-400 ml-1';
        } else if (maxUnitsThisYear < 200) {
            maxUnitsSpan.className = 'text-amber-400 ml-1';
        } else {
            maxUnitsSpan.className = 'text-emerald-400 ml-1';
        }
    }
}

/**
 * Indicador de capacidad de capital en header
 */
function updateCapacityIndicator() {
    let indicator = document.getElementById('capacity-indicator');
    if (!indicator) {
        const header = document.querySelector('header');
        indicator = document.createElement('div');
        indicator.id = 'capacity-indicator';
        indicator.className = 'mt-4 p-3 rounded-lg border';
        header.appendChild(indicator);
    }
    
    const validation = validateCapitalConstraints();
    const utilizationPercent = validation.totalAvailableFunding > 0 ? 
        (validation.cumulativeCapexRequired / validation.totalAvailableFunding) * 100 : 0;
    
    let statusClass, statusText, statusIcon;
    
    if (validation.errors.length > 0) {
        statusClass = 'bg-red-900 border-red-600 text-red-200';
        statusText = 'OVER CAPACITY';
        statusIcon = '🚨';
    } else if (utilizationPercent > 85) {
        statusClass = 'bg-amber-900 border-amber-600 text-amber-200';
        statusText = 'Near Limit';
        statusIcon = '⚠️';
    } else {
        statusClass = 'bg-emerald-900 border-emerald-600 text-emerald-200';
        statusText = 'Healthy';
        statusIcon = '✅';
    }
    
    indicator.className = `mt-4 p-3 rounded-lg border ${statusClass}`;
    indicator.innerHTML = `
        <div class="flex justify-between items-center">
            <div>
                <h4 class="font-semibold">${statusIcon} Capital Utilization</h4>
                <p class="text-sm opacity-80">${utilizationPercent.toFixed(0)}% - ${statusText}</p>
            </div>
            <div class="text-right">
                <div class="text-lg font-bold">${formatCurrency(validation.totalAvailableFunding)}</div>
                <div class="text-xs">Available Funding</div>
            </div>
        </div>
        <div class="mt-2 bg-slate-800 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-300 ${utilizationPercent > 100 ? 'bg-red-500' : utilizationPercent > 85 ? 'bg-amber-500' : 'bg-emerald-500'}" 
                 style="width: ${Math.min(100, utilizationPercent)}%"></div>
        </div>
    `;
}

/**
* Forces a manual recalculation of the model.
*/
function forceCalculate() {
    log('🔄 Manual recalculation requested.');
    capturePlannedFinancing();
    
    // Validar constraints ANTES del cálculo
    const validation = validateCapitalConstraints();
    
    if (validation.errors.length > 0) {
        const shouldAutoAdjust = confirm(
            `🚨 Las unidades planificadas exceden la capacidad de capital.\n\n` +
            `¿Deseas auto-ajustar para respetar los límites?`
        );
        
        if (shouldAutoAdjust) {
            autoAdjustUnitsForCapacity();
        } else {
            console.warn('⚠️ Proceeding with constraint violations');
        }
    }
    
    validateCapexConstraints();
    // MEJORA: Es necesario redibujar los controles de unidades para actualizar los máximos dinámicos.
    setupControlGroup('planCrecimiento', 'plan-crecimiento-controls');
    if (!calculateFinancials()) {
        log('❌ Manual recalculation failed.');
    } else {
        updateUI();
        updateCapacityIndicator(); // Actualizar indicador
        runGlobalChecks(); // Run global checks after manual recalculation
        log('✅ Manual recalculation completed with capital validation.');
    }
}
// ===== USER CONTROL CONFIGURATION =====

/**
* Helper function to create and append a slider control.
* @param {Object} config - Configuration object for the slider.
* @param {HTMLElement} container - The DOM element to append the control to.
*/
function createSliderControl(config, container) {
const div = document.createElement('div');
div.className = 'control-grid';
const label = document.createElement('label');
label.className = "text-sm font-medium text-slate-300";
if (config.tooltip) {
label.setAttribute('data-tooltip', config.tooltip);
}
label.textContent = config.label;
div.appendChild(label);

const sliderContainer = document.createElement('div');
sliderContainer.className = 'slider-container';

const slider = document.createElement('input');
slider.type = 'range';
slider.id = `${config.id}-input`;
slider.min = config.min;
slider.max = config.max;
slider.step = config.step;
slider.value = modelData[config.id];
slider.className = 'input-slider';
sliderContainer.appendChild(slider);

const display = document.createElement('span');
display.id = `${config.id}-valor`;
display.className = "font-bold text-teal-400 w-24 text-right"; // Fixed width for alignment
display.textContent = (config.format && typeof config.format === 'function') ? config.format(modelData[config.id]) : modelData[config.id].toString();
sliderContainer.appendChild(display);
div.appendChild(sliderContainer);
container.appendChild(div);

slider.addEventListener('input', function() {
let value = parseFloat(this.value);
modelData[config.id] = value;
display.textContent = config.format(value);

this.classList.remove('validation-error', 'validation-warning', 'validation-success');

if (['vanPrice', 'vanCost'].includes(config.id)) {
const unitEcon = evaluateUnitEconomics();
if (unitEcon.marginPercent < 10) {
this.classList.add('validation-error');
showWarning(`🚨 Unit economics críticos: ${unitEcon.marginPercent.toFixed(1)}% margin. Mínimo Serie A: 15%`);
} else if (unitEcon.marginPercent < 15) {
this.classList.add('validation-warning');
showWarning(`⚠️ Unit economics bajos: ${unitEcon.marginPercent.toFixed(1)}% margin. Target Serie A: 20%+`);
} else {
this.classList.add('validation-success');
}
}

if (config.id === 'tasaInteres') {
if (value < 22) {
this.classList.add('validation-error');
showWarning(`🚨 Tasa insostenible: ${value}%. Unit economics requieren mínimo 22% para Serie A viability`);
} else if (value < 25) {
this.classList.add('validation-warning');
showWarning(`⚠️ Tasa baja: ${value}%. Sweet spot Serie A: 25-30% para margins defendibles`);
} else {
this.classList.add('validation-success');
}
}

if (['ventureDebtRate', 'commercialDebtRate'].includes(config.id)) {
const debtService = calculateDebtServiceCoverage();
if (debtService.dscr < 1.2) {
this.classList.add('validation-error');
showWarning(`🚨 DSCR crítico: ${debtService.dscr.toFixed(1)}x. Debt service: ${formatCurrency(debtService.totalDebtService)}, EBITDA est: ${formatCurrency(debtService.estimatedEBITDA)}`);
} else if (debtService.dscr < 1.5) {
this.classList.add('validation-warning');
showWarning(`⚠️ DSCR bajo: ${debtService.dscr.toFixed(1)}x. Target Serie A: >1.5x para debt comfort`);
} else {
this.classList.add('validation-success');
}
}

if (['pdStage1', 'pdStage2'].includes(config.id)) {
const configItem = controlsConfig.riesgoYSalida.find(c => c.id === config.id);
if (configItem && configItem.investorRange) {
const range = configItem.investorRange;
const valuePercent = value * 100;
if (valuePercent < range.green[0] || valuePercent > range.red[1]) {
this.classList.add('validation-warning');
showWarning(`📊 Assumption fuera de benchmark: ${valuePercent.toFixed(1)}%. Range realista: ${range.green[0]}-${range.green[1]}%`);
} else if (valuePercent >= range.green[0] && valuePercent <= range.green[1]) {
this.classList.add('validation-success');
} else {
this.classList.add('validation-warning');
}
}
}

log(`${config.label} changed to: ${value}`);
forceCalculate();
});
}
/**
* Helper function to create and append a number input control.
* @param {Object} config - Configuration object for the number input.
* @param {HTMLElement} container - The DOM element to append the control to.
*/
function createNumberControl(config, container) {
const div = document.createElement('div');
div.className = 'control-grid';

const label = document.createElement('label');
label.htmlFor = `${config.id}-input`;
label.className = "text-sm font-medium text-slate-300";
if (config.tooltip) {
label.setAttribute('data-tooltip', config.tooltip);
}
label.textContent = config.label;
div.appendChild(label);
const input = document.createElement('input');
input.type = 'number';
input.id = `${config.id}-input`;
input.min = config.min;
input.max = config.max;
input.step = config.step;
input.value = modelData[config.id];
input.className = "p-2 border border-slate-700 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-white w-full";
div.appendChild(input);
container.appendChild(div);

input.addEventListener('input', function() {
let value = parseFloat(this.value);
if (isNaN(value)) value = config.min;

value = Math.max(config.min, Math.min(config.max, value));
if (config.label.includes('Año') || config.label.includes('Años')) {
value = Math.round(value);
}
this.value = value; // Correct the input value if it's out of bounds
modelData[config.id] = value;

log(`${config.label} changed to: ${value}`);
forceCalculate();
});
}

/**
* Sets up controls for a specific group/card.
* @param {string} groupKey - The key for the control group in controlsConfig.
* @param {string} containerId - The ID of the DOM element to append the controls to.
*/
function setupControlGroup(groupKey, containerId) {
const container = document.getElementById(containerId);
if (!container) {
log(`❌ Container with ID '${containerId}' not found for control group '${groupKey}'.`);
return;
}
container.innerHTML = ''; // Clear previous controls

const groupConfig = controlsConfig[groupKey] || [];

groupConfig.forEach(config => {
if (config.id === 'unitsPerYear' || (config.id === 'opexRates' && config.type === 'array')) {
const arrayContainer = document.createElement('div');

const label = document.createElement('h5');
label.className = 'text-sm font-medium text-slate-300 mb-2';
label.textContent = config.label;
if(config.tooltip) label.setAttribute('data-tooltip', config.tooltip);
arrayContainer.appendChild(label);
const grid = document.createElement('div');
grid.className = 'units-grid';

modelData[config.id].forEach((itemValue, index) => {
const div = document.createElement('div');
div.className = 'flex flex-col';

// Enhanced UI for unitsPerYear with dynamic constraints
if (config.id === 'unitsPerYear') {
    div.innerHTML = `
        <label for="${config.id}-${index+1}" class="text-xs font-medium text-slate-400 mb-1">
            Año ${index+1}
            <span id="max-units-year-${index+1}" class="text-emerald-400 ml-1"></span>
        </label>
        <input type="number" 
               id="${config.id}-${index+1}" 
               min="${config.min}" 
               max="${config.max}" 
               step="${config.step}" 
               value="${itemValue}"
               class="p-2 border border-slate-700 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-white">
        <div id="constraint-warning-${index+1}" class="text-xs text-amber-400 mt-1 hidden"></div>
    `;
} else {
    div.innerHTML = `
        <label for="${config.id}-${index+1}" class="text-xs font-medium text-slate-400 mb-1">Año ${index+1}</label>
        <input type="number" id="${config.id}-${index+1}" min="${config.min}" max="${config.max}" step="${config.step}" value="${itemValue}"
        class="p-2 border border-slate-700 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-white">
    `;
}

grid.appendChild(div);

const input = div.querySelector(`input[type="number"]`);

// Enhanced event listeners for unitsPerYear with real-time validation
if (config.id === 'unitsPerYear') {
    // Update dynamic constraints on initialization
    updateDynamicConstraints(index);
    
    input.addEventListener('input', function() {
        const value = parseInt(this.value) || 0;
        modelData[config.id][index] = value;
        
        // Validar constraints en tiempo real
        const validation = validateCapitalConstraints();
        updateInputValidationState(this, validation, index);
        
        // Update dynamic constraints for all years
        for (let i = 0; i < modelData.unitsPerYear.length; i++) {
            updateDynamicConstraints(i);
        }
        
        // Recalcular si no hay errores críticos
        if (validation.errors.length === 0) {
            setTimeout(() => forceCalculate(), 100); // Small delay to prevent excessive calculations
        }
    });
    
    input.addEventListener('change', function() {
        const value = parseFloat(this.value);
        let newValue = Math.max(config.min, Math.min(config.max, isNaN(value) ? config.min : value));
        this.value = newValue;
        modelData[config.id][index] = newValue;
        
        log(`${config.label} Año ${index+1} changed to: ${newValue}`);
        forceCalculate();
    });
} else {
    input.addEventListener('change', function() {
        const value = parseFloat(this.value);
        let newValue = Math.max(config.min, Math.min(config.max, isNaN(value) ? config.min : value));
        this.value = newValue;
        modelData[config.id][index] = newValue;

        log(`${config.label} Año ${index+1} changed to: ${newValue}`);
        forceCalculate();
    });
}
});
arrayContainer.appendChild(grid);
container.appendChild(arrayContainer);
} else if (config.type === 'range') {
createSliderControl(config, container);
} else if (config.type === 'number') {
createNumberControl(config, container);
} else if (config.type === 'checkbox') {
const checkboxDiv = document.createElement('div');
checkboxDiv.className = 'flex items-center mt-4 p-3 bg-slate-800/50 rounded-lg';
checkboxDiv.innerHTML = `
<input id="${config.id}-input" type="checkbox" class="h-4 w-4 rounded border-slate-600 text-sky-500 focus:ring-sky-500 bg-slate-700">
<label for="${config.id}-input" class="ml-3 block text-sm font-medium text-slate-200" data-tooltip="${config.tooltip}">${config.label}</label>
`;
container.appendChild(checkboxDiv);
const checkbox = document.getElementById(`${config.id}-input`);
checkbox.checked = modelData[config.id];
checkbox.addEventListener('change', function() {
modelData[config.id] = this.checked;
log(`${config.label}: ${this.checked ? 'ACTIVATED' : 'DEACTIVATED'}`);
forceCalculate();
});
}
});
log(`✅ '${groupKey}' controls configured.`);
}

/**
 * Professional Capital Structure Dashboard - Investor-Grade UX
 */
function setupFinancingMatrix() {
    setupFinancingMatrixProfessional();
}

/**
 * Nueva matriz de financiamiento con UX profesional
 */
function setupFinancingMatrixProfessional() {
    const container = document.getElementById('matriz-financiamiento-controls');
    container.innerHTML = '';

    // Header Section - Líneas Disponibles
    const headerSection = document.createElement('div');
    headerSection.className = 'space-y-4 mb-6';
    headerSection.innerHTML = `
        <h5 class="text-sm font-semibold text-slate-300 mb-3">💰 Líneas de Capital Disponibles</h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-3 bg-slate-800 rounded-lg">
                <label class="text-xs text-slate-400">Venture Debt Line</label>
                <input type="number" id="ventureDebtLine" value="${modelData.ventureDebtLineAvailable}" 
                       class="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded text-white" 
                       step="1000000" min="0">
                <div class="text-xs text-slate-500 mt-1">Línea autorizada</div>
            </div>
            <div class="p-3 bg-slate-800 rounded-lg">
                <label class="text-xs text-slate-400">Commercial Debt Line</label>
                <input type="number" id="commercialDebtLine" value="${modelData.commercialDebtLineAvailable}" 
                       class="w-full mt-1 p-2 bg-slate-700 border border-slate-600 rounded text-white" 
                       step="1000000" min="0">
                <div class="text-xs text-slate-500 mt-1">Línea autorizada</div>
            </div>
        </div>
    `;
    container.appendChild(headerSection);

    // Serie A Section
    const seriesASection = document.createElement('div');
    seriesASection.className = 'mb-6 p-4 bg-gradient-to-r from-sky-900/20 to-sky-800/20 rounded-lg border border-sky-700/50';
    seriesASection.innerHTML = `
        <h5 class="text-sm font-semibold text-sky-300 mb-3">🚀 Serie A Capital (Año 0)</h5>
        <div class="flex items-center justify-between">
            <div>
                <input type="number" id="seriesA" value="${modelData.seriesA}" 
                       class="p-2 bg-slate-700 border border-slate-600 rounded text-white w-32" 
                       step="1000000" min="0">
                <div class="text-xs text-slate-400 mt-1">Capital semilla inicial</div>
            </div>
            <div class="text-right">
                <div class="text-lg font-bold text-sky-300">${formatCurrency(modelData.seriesA)}</div>
                <div class="text-xs text-slate-400">Disponible inmediatamente</div>
            </div>
        </div>
    `;
    container.appendChild(seriesASection);

    // Financing Sources Cards
    createFinancingSourcesCards(container);
    
    // Summary Dashboard
    createCapitalSummaryDashboard(container);
    
    // Rates Section
    createRatesControls(container);

    // Event listeners para líneas de crédito
    document.getElementById('ventureDebtLine').addEventListener('change', (e) => {
        modelData.ventureDebtLineAvailable = parseFloat(e.target.value) || 0;
        updateCapitalSummaryDashboard();
        forceCalculate();
    });

    document.getElementById('commercialDebtLine').addEventListener('change', (e) => {
        modelData.commercialDebtLineAvailable = parseFloat(e.target.value) || 0;
        updateCapitalSummaryDashboard();
        forceCalculate();
    });

    document.getElementById('seriesA').addEventListener('change', (e) => {
        modelData.seriesA = parseFloat(e.target.value) || 0;
        updateCapitalSummaryDashboard();
        forceCalculate();
    });
}

/**
 * Cards para fuentes de financiamiento por año
 */
function createFinancingSourcesCards(container) {
    const sourcesSection = document.createElement('div');
    sourcesSection.className = 'space-y-4';
    
    const sources = [
        { key: 'ventureDebt', label: 'Venture Debt', color: 'purple', icon: '🏦' },
        { key: 'commercialDebt', label: 'Deuda Comercial', color: 'blue', icon: '🏢' },
        { key: 'partnerCapitalization', label: 'Capitalización Socios', color: 'emerald', icon: '👥' },
        { key: 'seriesB_newInvestors', label: 'Serie B (Nuevos)', color: 'amber', icon: '💎' }
    ];

    sources.forEach(source => {
        const card = document.createElement('div');
        card.className = `p-4 bg-slate-800/50 rounded-lg border border-slate-700 financing-card`;
        
        let cardContent = `
            <div class="flex items-center justify-between mb-3">
                <h6 class="font-semibold text-slate-200 flex items-center gap-2">
                    ${source.icon} ${source.label}
                </h6>
                <div id="${source.key}-status" class="text-xs px-2 py-1 rounded"></div>
            </div>
            <div class="grid grid-cols-5 gap-2">
        `;
        
        for (let year = 1; year <= 5; year++) {
            const value = modelData[`${source.key}Year${year}`] || 0;
            cardContent += `
                <div class="text-center">
                    <label class="text-xs text-slate-400 block mb-1">Año ${year}</label>
                    <input type="number" 
                           id="${source.key}Year${year}" 
                           value="${value}"
                           min="0" 
                           step="1000000"
                           class="w-full p-1 text-xs bg-slate-700 border border-slate-600 rounded text-white text-center">
                    <div class="text-xs text-slate-500 mt-1">${formatCurrency(value)}</div>
                </div>
            `;
        }
        
        cardContent += `</div>`;
        card.innerHTML = cardContent;
        sourcesSection.appendChild(card);
        
        // Event listeners para inputs
        for (let year = 1; year <= 5; year++) {
            const input = card.querySelector(`#${source.key}Year${year}`);
            input.addEventListener('change', (e) => {
                const value = parseFloat(e.target.value) || 0;
                modelData[`${source.key}Year${year}`] = value;
                e.target.nextElementSibling.textContent = formatCurrency(value);
                updateCapitalSummaryDashboard();
                forceCalculate();
            });
        }
    });
    
    const sourcesContainer = document.createElement('div');
    sourcesContainer.innerHTML = '<h5 class="text-sm font-semibold text-slate-300 mb-4">📊 Fuentes de Financiamiento por Año</h5>';
    sourcesContainer.appendChild(sourcesSection);
    container.appendChild(sourcesContainer);
}

/**
 * Dashboard resumen con métricas clave y visualización
 */
function createCapitalSummaryDashboard(container) {
    const dashboard = document.createElement('div');
    dashboard.id = 'capital-summary-dashboard';
    dashboard.className = 'mt-6 p-4 bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg border border-slate-700';
    
    container.appendChild(dashboard);
    updateCapitalSummaryDashboard();
}

function updateCapitalSummaryDashboard() {
    const dashboard = document.getElementById('capital-summary-dashboard');
    if (!dashboard) return;

    // Calcular métricas
    let totalEquity = modelData.seriesA;
    let totalDebt = 0;
    let equityByYear = [modelData.seriesA, 0, 0, 0, 0, 0];
    let debtByYear = [0, 0, 0, 0, 0, 0];

    for (let year = 1; year <= 5; year++) {
        const equity = (modelData[`partnerCapitalizationYear${year}`] || 0) + 
                      (modelData[`seriesB_newInvestors_year${year}`] || 0);
        const debt = (modelData[`ventureDebtYear${year}`] || 0) + 
                    (modelData[`commercialDebtYear${year}`] || 0);
        
        totalEquity += equity;
        totalDebt += debt;
        equityByYear[year] = equity;
        debtByYear[year] = debt;
    }

    const totalFunding = totalEquity + totalDebt;
    const debtEquityRatio = totalEquity > 0 ? totalDebt / totalEquity : 0;
    
    // Calcular utilización de líneas
    const vdUsed = [1,2,3,4,5].reduce((sum, y) => sum + (modelData[`ventureDebtYear${y}`] || 0), 0);
    const cdUsed = [1,2,3,4,5].reduce((sum, y) => sum + (modelData[`commercialDebtYear${y}`] || 0), 0);
    
    const vdUtilization = modelData.ventureDebtLineAvailable > 0 ? (vdUsed / modelData.ventureDebtLineAvailable) * 100 : 0;
    const cdUtilization = modelData.commercialDebtLineAvailable > 0 ? (cdUsed / modelData.commercialDebtLineAvailable) * 100 : 0;

    dashboard.innerHTML = `
        <h5 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            📈 Capital Structure Analysis
        </h5>
        
        <!-- Métricas principales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="text-center p-3 bg-sky-900/30 rounded border border-sky-700/50">
                <div class="text-2xl font-bold text-sky-300">${formatCurrency(totalEquity)}</div>
                <div class="text-xs text-sky-400">Total Equity</div>
            </div>
            <div class="text-center p-3 bg-purple-900/30 rounded border border-purple-700/50">
                <div class="text-2xl font-bold text-purple-300">${formatCurrency(totalDebt)}</div>
                <div class="text-xs text-purple-400">Total Debt</div>
            </div>
            <div class="text-center p-3 bg-emerald-900/30 rounded border border-emerald-700/50">
                <div class="text-2xl font-bold text-emerald-300">${formatCurrency(totalFunding)}</div>
                <div class="text-xs text-emerald-400">Total Funding</div>
            </div>
            <div class="text-center p-3 bg-amber-900/30 rounded border border-amber-700/50">
                <div class="text-2xl font-bold text-amber-300">${debtEquityRatio.toFixed(1)}x</div>
                <div class="text-xs text-amber-400">Debt/Equity Ratio</div>
            </div>
        </div>

        <!-- Utilización de líneas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="p-3 bg-slate-800/50 rounded border border-slate-600">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-slate-300">Venture Debt Line</span>
                    <span class="text-xs px-2 py-1 rounded ${vdUtilization > 100 ? 'bg-red-900 text-red-300' : vdUtilization > 85 ? 'bg-amber-900 text-amber-300' : 'bg-emerald-900 text-emerald-300'}">
                        ${vdUtilization.toFixed(0)}%
                    </span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2">
                    <div class="h-2 rounded-full transition-all duration-300 ${vdUtilization > 100 ? 'bg-red-500' : vdUtilization > 85 ? 'bg-amber-500' : 'bg-emerald-500'}" 
                         style="width: ${Math.min(vdUtilization, 100)}%"></div>
                </div>
                <div class="text-xs text-slate-400 mt-1">
                    ${formatCurrency(vdUsed)} / ${formatCurrency(modelData.ventureDebtLineAvailable)}
                    ${vdUtilization > 100 ? `(⚠️ Exceso: ${formatCurrency(vdUsed - modelData.ventureDebtLineAvailable)})` : ''}
                </div>
            </div>
            
            <div class="p-3 bg-slate-800/50 rounded border border-slate-600">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-slate-300">Commercial Debt Line</span>
                    <span class="text-xs px-2 py-1 rounded ${cdUtilization > 100 ? 'bg-red-900 text-red-300' : cdUtilization > 85 ? 'bg-amber-900 text-amber-300' : 'bg-emerald-900 text-emerald-300'}">
                        ${cdUtilization.toFixed(0)}%
                    </span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2">
                    <div class="h-2 rounded-full transition-all duration-300 ${cdUtilization > 100 ? 'bg-red-500' : cdUtilization > 85 ? 'bg-amber-500' : 'bg-emerald-500'}" 
                         style="width: ${Math.min(cdUtilization, 100)}%"></div>
                </div>
                <div class="text-xs text-slate-400 mt-1">
                    ${formatCurrency(cdUsed)} / ${formatCurrency(modelData.commercialDebtLineAvailable)}
                    ${cdUtilization > 100 ? `(🚨 Déficit: ${formatCurrency(cdUsed - modelData.commercialDebtLineAvailable)})` : ''}
                </div>
            </div>
        </div>

        <!-- Timeline de funding -->
        <div class="p-3 bg-slate-800/30 rounded border border-slate-600">
            <h6 class="text-sm font-semibold text-slate-300 mb-3">Funding Timeline</h6>
            <div class="grid grid-cols-6 gap-2 text-xs">
                <div class="text-center text-slate-400 font-medium">Año 0</div>
                ${[1,2,3,4,5].map(year => `<div class="text-center text-slate-400 font-medium">Año ${year}</div>`).join('')}
                
                <div class="text-center p-2 bg-sky-900/50 rounded border border-sky-700/50">
                    <div class="font-bold text-sky-300">${formatCurrency(modelData.seriesA)}</div>
                    <div class="text-sky-400">Serie A</div>
                </div>
                ${[1,2,3,4,5].map(year => {
                    const yearFunding = equityByYear[year] + debtByYear[year];
                    return `
                        <div class="text-center p-2 bg-slate-700/50 rounded border border-slate-600">
                            <div class="font-bold ${yearFunding > 0 ? 'text-emerald-300' : 'text-slate-500'}">${formatCurrency(yearFunding)}</div>
                            <div class="text-slate-400">E+D</div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

/**
 * Controles de tasas con visualización de impacto
 */
function createRatesControls(container) {
    const ratesSection = document.createElement('div');
    ratesSection.className = 'mt-6 p-4 bg-slate-800/30 rounded-lg border border-slate-600';
    ratesSection.innerHTML = `
        <h5 class="text-sm font-semibold text-slate-300 mb-4">📊 Tasas de Financiamiento</h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-3">
                <div>
                    <label class="text-sm text-slate-300 block mb-2">Venture Debt Rate</label>
                    <div class="flex items-center space-x-3">
                        <input type="range" 
                               id="ventureDebtRate" 
                               min="12" 
                               max="25" 
                               step="0.5" 
                               value="${modelData.ventureDebtRate}"
                               class="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        <span id="ventureDebtRateValue" class="text-purple-300 font-bold w-16">${modelData.ventureDebtRate.toFixed(1)}%</span>
                    </div>
                    <div class="text-xs text-slate-400 mt-1">Market range: 15-22%</div>
                </div>
                
                <div>
                    <label class="text-sm text-slate-300 block mb-2">Commercial Debt Rate</label>
                    <div class="flex items-center space-x-3">
                        <input type="range" 
                               id="commercialDebtRate" 
                               min="10" 
                               max="20" 
                               step="0.5" 
                               value="${modelData.commercialDebtRate}"
                               class="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        <span id="commercialDebtRateValue" class="text-blue-300 font-bold w-16">${modelData.commercialDebtRate.toFixed(1)}%</span>
                    </div>
                    <div class="text-xs text-slate-400 mt-1">Market range: 12-18%</div>
                </div>
            </div>
            
            <div class="p-3 bg-slate-900/50 rounded border border-slate-700">
                <h6 class="text-sm font-semibold text-slate-300 mb-2">Blended Cost of Capital</h6>
                <div id="blendedCostDisplay" class="text-xl font-bold text-emerald-300">calculating...</div>
                <div class="text-xs text-slate-400 mt-1">Weighted average cost</div>
                
                <div class="mt-3 space-y-1 text-xs">
                    <div class="flex justify-between">
                        <span class="text-slate-400">Equity Weight:</span>
                        <span id="equityWeight" class="text-sky-300">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Debt Weight:</span>
                        <span id="debtWeight" class="text-purple-300">--</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(ratesSection);
    
    // Event listeners para tasas
    ['ventureDebtRate', 'commercialDebtRate'].forEach(rateId => {
        const slider = document.getElementById(rateId);
        const display = document.getElementById(rateId + 'Value');
        
        slider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            modelData[rateId] = value;
            display.textContent = value.toFixed(1) + '%';
            updateBlendedCostDisplay();
            forceCalculate();
        });
    });
    
    updateBlendedCostDisplay();
}

function updateBlendedCostDisplay() {
    // Calcular weighted average cost of capital
    let totalEquity = modelData.seriesA;
    let totalDebt = 0;
    
    for (let year = 1; year <= 5; year++) {
        totalEquity += (modelData[`partnerCapitalizationYear${year}`] || 0) + 
                      (modelData[`seriesB_newInvestors_year${year}`] || 0);
        totalDebt += (modelData[`ventureDebtYear${year}`] || 0) + 
                    (modelData[`commercialDebtYear${year}`] || 0);
    }
    
    const totalCapital = totalEquity + totalDebt;
    const equityWeight = totalCapital > 0 ? totalEquity / totalCapital : 0;
    const debtWeight = totalCapital > 0 ? totalDebt / totalCapital : 0;
    
    // Simplified blended cost (debt cost only, equity cost is complex)
    const blendedDebtCost = debtWeight * ((modelData.ventureDebtRate + modelData.commercialDebtRate) / 2);
    
    const blendedCostElement = document.getElementById('blendedCostDisplay');
    const equityWeightElement = document.getElementById('equityWeight');
    const debtWeightElement = document.getElementById('debtWeight');
    
    if (blendedCostElement) blendedCostElement.textContent = blendedDebtCost.toFixed(1) + '%';
    if (equityWeightElement) equityWeightElement.textContent = (equityWeight * 100).toFixed(0) + '%';
    if (debtWeightElement) debtWeightElement.textContent = (debtWeight * 100).toFixed(0) + '%';
}

/**
 * NEW: Updates the financing matrix with optimized values and color coding.
 */
function updateFinancingMatrixWithOptimized() {
    // Update the capital summary dashboard
    updateCapitalSummaryDashboard();
    
    // Update blended cost display
    updateBlendedCostDisplay();
}


function updateOptimizationStatus() {
const statusContainer = document.getElementById('riesgo-salida-controls');
if (statusContainer) {
let statusElement = document.getElementById('optimization-status');
if (!statusElement) {
statusElement = document.createElement('div');
statusElement.id = 'optimization-status';
statusElement.className = 'mt-4 p-3 rounded-lg bg-slate-800 text-sm';
statusContainer.appendChild(statusElement);
}
const vdRate = modelData.ventureDebtRate;
const commRate = modelData.commercialDebtRate;

let totalCapex = 0;
for (let i = 0; i < modelData.unitsPerYear.length; i++) {
totalCapex += modelData.unitsPerYear[i] * getTotalPackageCost();
}

let totalFunding = modelData.seriesA;
for (let i = 1; i <= 5; i++) {
totalFunding += (modelData[`partnerCapitalizationYear${i}`] || 0) +
(modelData[`ventureDebtYear${i}`] || 0) +
(modelData[`commercialDebtYear${i}`] || 0) +
(modelData[`seriesB_newInvestors_year${i}`] || 0);
}

const fundingRatio = totalCapex > 0 ? totalFunding / totalCapex : 0;

statusElement.innerHTML = `
<div class="text-slate-300">
<strong>🎯 Status de Financiamiento:</strong><br>
• Tasa VD: ${vdRate.toFixed(1)}% ${vdRate >= 12 && vdRate <= 20 ? '✅' : '⚠️'}<br>
• Tasa Comercial: ${commRate.toFixed(1)}% ${commRate >= 10 && commRate <= 18 ? '✅' : '⚠️'}<br>
• Cobertura CAPEX: ${(fundingRatio * 100).toFixed(0)}% ${fundingRatio >= 1.0 ? '✅' : '🚨'}
</div>
`;
}
}

/**
* Main function to set up all UI controls.
*/
function setupControls() {
setupControlGroup('paqueteFinanciado', 'paquete-financiado-controls');
setupControlGroup('condicionesCredito', 'condiciones-credito-controls');
setupControlGroup('ingresosAdicionales', 'ingresos-adicionales-controls');
setupControlGroup('planCrecimiento', 'plan-crecimiento-controls');
setupFinancingMatrixProfessional(); // Nueva implementación profesional
setupControlGroup('riesgoYSalida', 'riesgo-salida-controls');

updatePackageSummary();
updateCapitalSummaryDashboard();
}
/**
* Updates the automatic summary for the "Package and Prices" section.
*/
function updatePackageSummary() {
const totalPrice = getTotalPackagePrice();
const totalCost = getTotalPackageCost();
const margin = totalPrice - totalCost;
const marginPercent = (totalPrice > 0) ? (margin / totalPrice) * 100 : 0;

const summaryContainer = document.getElementById('package-summary');
if (summaryContainer) {
summaryContainer.innerHTML = `
<div class="text-sm space-y-1">
<div class="flex justify-between">
<span>Precio Total Paquete:</span>
<span class="font-bold text-sky-400">${formatCurrency(totalPrice, true)}</span>
</div>
<div class="flex justify-between">
<span>Costo Total RAG:</span>
<span>${formatCurrency(totalCost, true)}</span>
</div>
<div class="flex justify-between border-t border-slate-600 pt-1">
<span>Margen Bruto Unitario:</span>
<span class="font-bold text-emerald-400">
${formatCurrency(margin, true)} (${marginPercent.toFixed(1)}%)
</span>
</div>
</div>
`;
}
log('✅ Package summary updated.');
}
/**
* Configures tab navigation.
* Forces UI update when switching to financial/charts/validation tabs.
*/
function setupTabs() {
const tabButtons = document.querySelectorAll('.tab-button');
const contentSections = document.querySelectorAll('.content-section');

tabButtons.forEach((button, index) => {
button.addEventListener('click', () => {
tabButtons.forEach(btn => btn.classList.remove('active'));
contentSections.forEach(section => section.classList.remove('active'));

button.classList.add('active');
contentSections[index].classList.add('active');

if (button.id === 'tab-financieros' || button.id === 'tab-niif' || button.id === 'tab-graficos' || button.id === 'tab-validacion') {
setTimeout(() => {
forceCalculate();
}, 50);
}
});
});
log('✅ Tab navigation configured.');
}

/**
* Updates the validation panel in the UI with the results.
* @param {Object} validations - Object with validation results.
*/
function updateValidationPanel(validations) {
const container = document.getElementById('validation-results-container');
if (!container) return;
container.innerHTML = '';

const types = ['error', 'warning', 'info', 'passed'];
types.forEach(type => {
if (Array.isArray(validations[type])) {
validations[type].forEach(msg => {
const div = document.createElement('div');
div.className = `validation-item ${type}`;
let icon = '';
if (type === 'error') icon = '🔴';
else if (type === 'warning') icon = '🟡';
else if (type === 'info') icon = '🔵';
else if (type === 'passed') icon = '✅';
div.innerHTML = `<span class="validation-icon">${icon}</span><div class="validation-message">${msg}</div>`;
container.appendChild(div);
});
}
});

const summaryDiv = document.createElement('div');
summaryDiv.className = 'validation-summary mt-4 p-2 rounded-lg';
if (validations.errors.length > 0) {
summaryDiv.classList.add('bg-red-200', 'text-red-800');
summaryDiv.textContent = `🚨 ${validations.errors.length} CRITICAL ERRORS found. Please review and adjust inputs/logic.`;
} else if (validations.warnings.length > 0) {
summaryDiv.classList.add('bg-yellow-200', 'text-yellow-800');
summaryDiv.textContent = `⚠️ ${validations.warnings.length} WARNINGS found. Review results with caution.`;
} else {
summaryDiv.classList.add('bg-green-200', 'text-green-800');
summaryDiv.textContent = `✨ All critical validations passed. ${validations.info.length} informational notes.`;
}
container.appendChild(summaryDiv);
}
/**
* Updates funding coverage card.
*/
function updateFundingCoverageCard() {
const totalFunding = calculateTotalFunding();
const totalCapex = calculateTotalCapex();
const surplus = totalFunding - totalCapex;
const coverageRatio = totalCapex > 0 ? (totalFunding / totalCapex) * 100 : 0;
// The visual part will be added in the next step.
}

/**
* Updates investor score dashboard
*/
function updateInvestorScore() {
const investorScore = calculateInvestorScore();
let scoreContainer = document.getElementById('investor-score-card');

if (!scoreContainer) {
// Create investor score card in header
const header = document.querySelector('header');
const scoreCard = document.createElement('div');
scoreCard.id = 'investor-score-card';
header.appendChild(scoreCard);
scoreContainer = scoreCard;
}

const gradeColor = {
'A': 'bg-emerald-900 border-emerald-600 text-emerald-200',
'B': 'bg-blue-900 border-blue-600 text-blue-200',
'C': 'bg-amber-900 border-amber-600 text-amber-200',
'D': 'bg-red-900 border-red-600 text-red-200'
}[investorScore.grade];

scoreContainer.className = `mt-4 p-4 rounded-lg border ${gradeColor}`;
scoreContainer.innerHTML = `
<div class="flex justify-between items-center">
<div>
<h3 class="font-semibold">📊 Investor Health Score</h3>
<p class="text-sm opacity-80">Serie A Investment Readiness</p>
</div>
<div class="text-right">
<div class="text-2xl font-bold">${investorScore.score.toFixed(1)}/10</div>
<div class="text-lg font-semibold">Grade ${investorScore.grade}</div>
<div class="text-xs">${investorScore.isInvestable ? '✅ Investable' : '❌ Needs Work'}</div>
</div>
</div>
${investorScore.issues.length > 0 ? `
<div class="mt-3 pt-3 border-t border-white border-opacity-20">
<p class="text-sm font-medium mb-2">Key Issues:</p>
<ul class="text-xs space-y-1">
${investorScore.issues.map(issue => `<li>${issue}</li>`).join('')}
</ul>
</div>
` : '<div class="mt-2 text-sm">🎉 All key metrics look strong for Serie A!</div>'}
`;
}

// ===================================================================
// ===== MONTE CARLO SIMULATION ENGINE =====
// ===================================================================

/**
 * Monte Carlo simulation engine for risk analysis
 */
class MonteCarloEngine {
    constructor(iterations = 1000) {
        this.iterations = iterations;
        this.results = [];
    }
    
    /**
     * Define distributions for key variables
     */
    getVariableDistributions() {
        return {
            tasaInteres: {
                type: 'normal',
                mean: modelData.tasaInteres,
                stdDev: 1.5, // ±1.5% volatility
                min: 22,
                max: 30
            },
            pdStage1: {
                type: 'lognormal',
                mean: modelData.pdStage1,
                stdDev: modelData.pdStage1 * 0.3, // 30% relative volatility
                min: 0.003,
                max: 0.015
            },
            gdpGrowth: {
                type: 'normal',
                mean: 2.5, // Expected Mexico GDP growth
                stdDev: 1.8,
                min: -2,
                max: 6
            },
            fuelPriceVolatility: {
                type: 'normal',
                mean: 0,
                stdDev: 0.15, // 15% fuel price volatility
                min: -0.4,
                max: 0.4
            },
            sinosureSuccess: {
                type: 'bernoulli',
                probability: sinosureConfig.probability / 100
            }
        };
    }
    
    /**
     * Generate random value according to distribution
     */
    generateRandomValue(distribution) {
        switch(distribution.type) {
            case 'normal':
                let normal = this.boxMullerTransform() * distribution.stdDev + distribution.mean;
                return Math.max(distribution.min, Math.min(distribution.max, normal));
                
            case 'lognormal':
                let lognormal = Math.exp(this.boxMullerTransform() * Math.log(1 + distribution.stdDev / distribution.mean) + Math.log(distribution.mean));
                return Math.max(distribution.min, Math.min(distribution.max, lognormal));
                
            case 'bernoulli':
                return Math.random() < distribution.probability ? 1 : 0;
                
            default:
                return distribution.mean;
        }
    }
    
    /**
     * Box-Muller transform for normal distribution
     */
    boxMullerTransform() {
        const u = 0.9999 * Math.random() + 0.0001;
        const v = 0.9999 * Math.random() + 0.0001;
        return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }
    
    /**
     * Run complete simulation
     */
    runSimulation() {
        const distributions = this.getVariableDistributions();
        this.results = [];
        
        log(`🎲 Starting Monte Carlo simulation with ${this.iterations} iterations...`);
        
        for (let i = 0; i < this.iterations; i++) {
            // Generate random values
            const randomValues = {};
            Object.keys(distributions).forEach(key => {
                randomValues[key] = this.generateRandomValue(distributions[key]);
            });
            
            // Apply values to temporary model
            const originalValues = this.backupModelData();
            this.applyRandomValues(randomValues);
            
            // Run financial calculation
            if (calculateFinancials()) {
                const result = this.extractKPIs(randomValues);
                this.results.push(result);
            }
            
            // Restore original values
            this.restoreModelData(originalValues);
            
            // Progress update every 100 iterations
            if (i % 100 === 0) {
                log(`Monte Carlo progress: ${((i / this.iterations) * 100).toFixed(0)}%`);
            }
        }
        
        log(`✅ Monte Carlo simulation completed. ${this.results.length}/${this.iterations} successful runs.`);
        return this.analyzeResults();
    }
    
    applyRandomValues(randomValues) {
        modelData.tasaInteres = randomValues.tasaInteres;
        modelData.pdStage1 = randomValues.pdStage1;
        
        // SINOSURE success/failure
        if (randomValues.sinosureSuccess === 0) {
            // SINOSURE failed - reallocate to other debt
            modelData.sinosureAvailable = false;
        }
        
        // GDP impact on default rates
        const gdpImpact = 1 + (randomValues.gdpGrowth - 2.5) / 10; // GDP sensitivity
        modelData.pdStage2 = modelData.pdStage2 * gdpImpact;
        
        // Fuel price impact on customer cash flow
        const fuelImpact = 1 + randomValues.fuelPriceVolatility;
        // Could adjust interest rates or default rates based on fuel costs
    }
    
    extractKPIs(inputs) {
        return {
            // Inputs
            tasaInteres: inputs.tasaInteres,
            pdStage1: inputs.pdStage1,
            gdpGrowth: inputs.gdpGrowth,
            sinosureSuccess: inputs.sinosureSuccess,
            
            // Outputs
            tirEquity: financialResults.tirEquity || 0,
            ebitdaYear5: financialResults.pl[4]?.ebitda || 0,
            totalFunding: calculateTotalFunding(),
            dscr: calculateFinalDSCR(),
            cashFlowPositiveYear: this.findCashFlowPositiveYear(),
            maxDrawdown: this.calculateMaxDrawdown()
        };
    }
    
    findCashFlowPositiveYear() {
        for (let i = 0; i < 5; i++) {
            if (financialResults.cashFlow[i]?.netCashFlow > 0) {
                return i + 1;
            }
        }
        return null;
    }
    
    calculateMaxDrawdown() {
        let maxDrawdown = 0;
        let peak = 0;
        let cumulativeCash = 0;
        
        for (let i = 0; i < 5; i++) {
            cumulativeCash += financialResults.cashFlow[i]?.netCashFlow || 0;
            peak = Math.max(peak, cumulativeCash);
            const drawdown = peak - cumulativeCash;
            maxDrawdown = Math.max(maxDrawdown, drawdown);
        }
        
        return maxDrawdown;
    }
    
    analyzeResults() {
        const analysis = {
            tirEquity: this.calculateStatistics(this.results.map(r => r.tirEquity)),
            ebitdaYear5: this.calculateStatistics(this.results.map(r => r.ebitdaYear5)),
            dscr: this.calculateStatistics(this.results.map(r => r.dscr)),
            
            // Risk metrics
            probabilityOfSuccess: this.results.filter(r => r.tirEquity > 20).length / this.results.length,
            valueAtRisk95: this.calculateVaR(this.results.map(r => r.tirEquity), 0.05),
            valueAtRisk99: this.calculateVaR(this.results.map(r => r.tirEquity), 0.01),
            
            // SINOSURE impact
            sinosureImpact: this.analyzeSinosureImpact(),
            
            // Raw results for visualization
            results: this.results
        };
        
        return analysis;
    }
    
    calculateStatistics(values) {
        const sorted = values.sort((a, b) => a - b);
        return {
            mean: values.reduce((a, b) => a + b, 0) / values.length,
            median: sorted[Math.floor(sorted.length / 2)],
            stdDev: Math.sqrt(values.reduce((sum, x) => sum + Math.pow(x - values.reduce((a, b) => a + b, 0) / values.length, 2), 0) / values.length),
            min: Math.min(...values),
            max: Math.max(...values),
            p5: sorted[Math.floor(sorted.length * 0.05)],
            p25: sorted[Math.floor(sorted.length * 0.25)],
            p75: sorted[Math.floor(sorted.length * 0.75)],
            p95: sorted[Math.floor(sorted.length * 0.95)]
        };
    }
    
    calculateVaR(values, confidence) {
        const sorted = values.sort((a, b) => a - b);
        return sorted[Math.floor(sorted.length * confidence)];
    }
    
    analyzeSinosureImpact() {
        const withSinosure = this.results.filter(r => r.sinosureSuccess === 1);
        const withoutSinosure = this.results.filter(r => r.sinosureSuccess === 0);
        
        if (withSinosure.length === 0 || withoutSinosure.length === 0) return null;
        
        return {
            tirEquityLift: this.calculateStatistics(withSinosure.map(r => r.tirEquity)).mean - 
                          this.calculateStatistics(withoutSinosure.map(r => r.tirEquity)).mean,
            successProbabilityLift: (withSinosure.filter(r => r.tirEquity > 20).length / withSinosure.length) -
                                   (withoutSinosure.filter(r => r.tirEquity > 20).length / withoutSinosure.length)
        };
    }
    
    backupModelData() {
        return JSON.parse(JSON.stringify(modelData));
    }
    
    restoreModelData(backup) {
        Object.keys(backup).forEach(key => {
            modelData[key] = backup[key];
        });
    }
}

// ===================================================================
// ===== SENSITIVITY ANALYSIS ENGINE =====
// ===================================================================

/**
 * Sensitivity analysis engine with Tornado Charts
 */
class SensitivityAnalyzer {
    constructor() {
        this.baselineResults = null;
        this.sensitivityResults = [];
    }
    
    /**
     * Key variables for sensitivity analysis
     */
    getSensitivityVariables() {
        return {
            tasaInteres: {
                label: 'Tasa Interés Cliente',
                baseline: modelData.tasaInteres,
                range: [-2, 2], // ±2%
                format: val => val.toFixed(1) + '%'
            },
            downPaymentPercentage: {
                label: '% Enganche',
                baseline: modelData.downPaymentPercentage,
                range: [-5, 5], // ±5%
                format: val => val.toFixed(1) + '%'
            },
            pdStage1: {
                label: 'PD Stage 1',
                baseline: modelData.pdStage1,
                range: [-0.003, 0.003], // ±0.3%
                format: val => (val * 100).toFixed(2) + '%'
            },
            ventureDebtRate: {
                label: 'Tasa Venture Debt',
                baseline: modelData.ventureDebtRate,
                range: [-3, 3], // ±3%
                format: val => val.toFixed(1) + '%'
            },
            commercialDebtRate: {
                label: 'Tasa Comercial',
                baseline: modelData.commercialDebtRate,
                range: [-2, 2], // ±2%
                format: val => val.toFixed(1) + '%'
            },
            sinosureAvailable: {
                label: 'SINOSURE Success',
                baseline: modelData.sinosureAvailable ? 1 : 0,
                range: [0, 1], // Binary
                format: val => val ? 'Available' : 'Not Available'
            }
        };
    }
    
    /**
     * Run complete sensitivity analysis
     */
    runSensitivityAnalysis() {
        log('📊 Starting sensitivity analysis...');
        
        // Calculate baseline
        this.baselineResults = this.calculateBaselineKPIs();
        this.sensitivityResults = [];
        
        const variables = this.getSensitivityVariables();
        
        Object.entries(variables).forEach(([varName, varConfig]) => {
            const impacts = this.analyzeVariableImpact(varName, varConfig);
            this.sensitivityResults.push({
                variable: varName,
                label: varConfig.label,
                impacts: impacts,
                tornadoData: this.calculateTornadoData(impacts)
            });
        });
        
        log('✅ Sensitivity analysis completed');
        return this.generateSensitivityReport();
    }
    
    analyzeVariableImpact(varName, varConfig) {
        const impacts = [];
        const steps = 5; // Test 5 points across range
        
        for (let i = 0; i <= steps; i++) {
            const factor = i / steps; // 0 to 1
            const value = varConfig.baseline + varConfig.range[0] + factor * (varConfig.range[1] - varConfig.range[0]);
            
            // Backup original value
            const originalValue = modelData[varName];
            
            // Apply test value
            modelData[varName] = value;
            
            // Calculate KPIs
            if (calculateFinancials()) {
                const kpis = this.calculateKPIs();
                impacts.push({
                    inputValue: value,
                    inputFormatted: varConfig.format(value),
                    tirEquity: kpis.tirEquity,
                    ebitdaYear5: kpis.ebitdaYear5,
                    dscr: kpis.dscr,
                    totalFunding: kpis.totalFunding
                });
            }
            
            // Restore original value
            modelData[varName] = originalValue;
        }
        
        return impacts;
    }
    
    calculateTornadoData(impacts) {
        if (impacts.length < 2) return null;
        
        const minImpact = impacts[0];
        const maxImpact = impacts[impacts.length - 1];
        
        return {
            tirEquityRange: Math.abs(maxImpact.tirEquity - minImpact.tirEquity),
            ebitdaRange: Math.abs(maxImpact.ebitdaYear5 - minImpact.ebitdaYear5),
            dscrRange: Math.abs(maxImpact.dscr - minImpact.dscr)
        };
    }
    
    calculateKPIs() {
        return {
            tirEquity: financialResults.tirEquity || 0,
            ebitdaYear5: financialResults.pl[4]?.ebitda || 0,
            dscr: calculateFinalDSCR(),
            totalFunding: calculateTotalFunding()
        };
    }
    
    calculateBaselineKPIs() {
        return this.calculateKPIs();
    }
    
    generateSensitivityReport() {
        // Sort by impact on TIR Equity (tornado chart order)
        this.sensitivityResults.sort((a, b) => 
            (b.tornadoData?.tirEquityRange || 0) - (a.tornadoData?.tirEquityRange || 0)
        );
        
        return {
            baseline: this.baselineResults,
            variables: this.sensitivityResults,
            topDrivers: this.sensitivityResults.slice(0, 3).map(v => v.label),
            recommendations: this.generateRecommendations()
        };
    }
    
    generateRecommendations() {
        const topDriver = this.sensitivityResults[0];
        const recommendations = [];
        
        if (topDriver.label.includes('Tasa')) {
            recommendations.push('📈 Interest rate optimization is critical - consider dynamic pricing');
        }
        if (topDriver.label.includes('SINOSURE')) {
            recommendations.push('🇨🇳 SINOSURE access creates massive value - prioritize government relations');
        }
        if (topDriver.label.includes('PD')) {
            recommendations.push('🛡️ Risk management is key value driver - invest in AI/data capabilities');
        }
        
        return recommendations;
    }
}

// ===================================================================
// ===== ADVANCED VISUALIZATION SYSTEM =====
// ===================================================================

/**
 * Advanced visualization system with Chart.js
 */
class AdvancedVisualizationEngine {
    constructor() {
        this.charts = {};
    }
    
    /**
     * Create Monte Carlo distribution chart
     */
    createMonteCarloChart(containerId, monteCarloResults) {
        const canvas = document.getElementById(containerId);
        if (!canvas) return;
        
        // Destroy existing chart if it exists
        if (this.charts.monteCarlo) {
            this.charts.monteCarlo.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        const tirData = monteCarloResults.results.map(r => r.tirEquity);
        const histogram = this.createHistogram(tirData, 20);
        
        this.charts.monteCarlo = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: histogram.bins.map(bin => `${bin.toFixed(1)}%`),
                datasets: [{
                    label: 'Frequency',
                    data: histogram.frequencies,
                    backgroundColor: 'rgba(16, 185, 129, 0.6)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `🎲 Monte Carlo: TIR Equity Distribution (${monteCarloResults.results.length} simulations)`,
                        color: '#f8fafc',
                        font: { size: 14, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'TIR Equity (%)', color: '#94a3b8' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: { 
                        title: { display: true, text: 'Frequency', color: '#94a3b8' },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
    }
    
    /**
     * Create Tornado Chart for sensitivity analysis
     */
    createTornadoChart(containerId, sensitivityResults) {
        const canvas = document.getElementById(containerId);
        if (!canvas) return;
        
        // Destroy existing chart if it exists
        if (this.charts.tornado) {
            this.charts.tornado.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        const topVariables = sensitivityResults.variables.slice(0, 6);
        
        this.charts.tornado = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: topVariables.map(v => v.label),
                datasets: [{
                    label: 'TIR Impact Range',
                    data: topVariables.map(v => v.tornadoData?.tirEquityRange || 0),
                    backgroundColor: topVariables.map((_, i) => `hsl(${i * 60}, 70%, 60%)`),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Horizontal bars
                plugins: {
                    title: {
                        display: true,
                        text: '🌪️ Tornado Chart: Variable Impact on TIR Equity',
                        color: '#f8fafc',
                        font: { size: 14, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'TIR Impact Range (pp)', color: '#94a3b8' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: { ticks: { color: '#94a3b8' } }
                }
            }
        });
    }
    
    /**
     * Create SINOSURE impact visualization
     */
    createSinosureImpactChart(containerId, monteCarloResults) {
        const canvas = document.getElementById(containerId);
        if (!canvas) return;
        
        // Destroy existing chart if it exists
        if (this.charts.sinosureImpact) {
            this.charts.sinosureImpact.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        const sinosureImpact = monteCarloResults.sinosureImpact;
        
        if (!sinosureImpact) {
            // Show placeholder
            ctx.fillStyle = '#94a3b8';
            ctx.font = '14px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('Run Monte Carlo with SINOSURE enabled', canvas.width/2, canvas.height/2);
            return;
        }
        
        this.charts.sinosureImpact = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['With SINOSURE', 'Without SINOSURE'],
                datasets: [{
                    data: [
                        monteCarloResults.tirEquity.mean + sinosureImpact.tirEquityLift,
                        monteCarloResults.tirEquity.mean
                    ],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '🇨🇳 SINOSURE Impact on TIR Equity',
                        color: '#f8fafc',
                        font: { size: 14, weight: 'bold' }
                    },
                    legend: {
                        position: 'bottom',
                        labels: { color: '#94a3b8' }
                    }
                }
            }
        });
    }
    
    /**
     * Create waterfall chart for funding sources
     */
    createFundingWaterfallChart(containerId) {
        const canvas = document.getElementById(containerId);
        if (!canvas) return;
        
        // Destroy existing chart if it exists
        if (this.charts.fundingWaterfall) {
            this.charts.fundingWaterfall.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        
        const fundingSources = [
            { label: 'Serie A', amount: modelData.seriesA, color: '#0ea5e9' },
            { label: 'Venture Debt', amount: calculateTotalDebtRaised(), color: '#8b5cf6' },
            { label: 'Commercial Debt', amount: 0, color: '#3b82f6' }, // Calculate separately
            { label: 'SINOSURE', amount: modelData.sinosureAvailable ? calculateMaxSinosureAmount() : 0, color: '#f59e0b' }
        ];
        
        this.charts.fundingWaterfall = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: fundingSources.map(s => s.label),
                datasets: [{
                    data: fundingSources.map(s => s.amount / 1000000), // Convert to millions
                    backgroundColor: fundingSources.map(s => s.color),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '💰 Funding Sources Waterfall',
                        color: '#f8fafc',
                        font: { size: 14, weight: 'bold' }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: { ticks: { color: '#94a3b8' } },
                    y: { 
                        title: { display: true, text: 'Amount (M MXN)', color: '#94a3b8' },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
    }
    
    createHistogram(data, bins) {
        const min = Math.min(...data);
        const max = Math.max(...data);
        const binWidth = (max - min) / bins;
        
        const histogram = {
            bins: [],
            frequencies: []
        };
        
        for (let i = 0; i < bins; i++) {
            const binStart = min + i * binWidth;
            const binEnd = binStart + binWidth;
            histogram.bins.push(binStart);
            
            const frequency = data.filter(d => d >= binStart && d < binEnd).length;
            histogram.frequencies.push(frequency);
        }
        
        return histogram;
    }
}

// ===== APPLICATION READY AND RUNNING =====
/**
 * Create SINOSURE controls in the UI
 */
function createSinosureControlsAdvanced() {
    const container = document.getElementById('riesgo-salida-controls');
    
    const sinosureSection = document.createElement('div');
    sinosureSection.className = 'mt-6 p-4 bg-gradient-to-br from-red-900/10 via-yellow-900/10 to-red-900/10 rounded-lg border border-yellow-500/30';
    sinosureSection.innerHTML = `
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
                <div class="text-2xl">🇨🇳</div>
                <div>
                    <h6 class="font-semibold text-yellow-300">SINOSURE Export Credit</h6>
                    <p class="text-xs text-yellow-400">China Export Credit Insurance Corporation</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="sinosureAvailable" ${modelData.sinosureAvailable ? 'checked' : ''}
                       class="rounded border-yellow-600 text-yellow-500 focus:ring-yellow-500 bg-slate-700">
                <label for="sinosureAvailable" class="text-sm text-yellow-300 font-medium">Available</label>
            </div>
        </div>
        
        <div id="sinosure-details" class="${modelData.sinosureAvailable ? '' : 'hidden'}">
            <!-- Key Parameters -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="p-3 bg-slate-800/50 rounded border border-yellow-600/30">
                    <label class="text-xs text-yellow-400 block mb-1">Rate (%)</label>
                    <input type="number" id="sinosureRate" value="${modelData.sinosureRate || 6.0}" 
                           min="5" max="8" step="0.1" class="w-full p-2 bg-slate-700 border border-yellow-600 rounded text-white">
                    <div class="text-xs text-yellow-300 mt-1">Market: 5-7%</div>
                </div>
                <div class="p-3 bg-slate-800/50 rounded border border-yellow-600/30">
                    <label class="text-xs text-yellow-400 block mb-1">Available From (Month)</label>
                    <input type="number" id="sinosureTiming" value="${modelData.sinosureTiming || 13}" 
                           min="6" max="24" step="1" class="w-full p-2 bg-slate-700 border border-yellow-600 rounded text-white">
                    <div class="text-xs text-yellow-300 mt-1">Post-validation</div>
                </div>
                <div class="p-3 bg-slate-800/50 rounded border border-yellow-600/30">
                    <label class="text-xs text-yellow-400 block mb-1">Duration (Months)</label>
                    <input type="number" id="sinosureDuration" value="${modelData.sinosureDuration || 12}" 
                           min="6" max="12" step="1" class="w-full p-2 bg-slate-700 border border-yellow-600 rounded text-white">
                    <div class="text-xs text-yellow-300 mt-1">Max: 12 months</div>
                </div>
                <div class="p-3 bg-slate-800/50 rounded border border-yellow-600/30">
                    <label class="text-xs text-yellow-400 block mb-1">Probability (%)</label>
                    <input type="number" id="sinosureProbability" value="${modelData.sinosureProbability || 70}" 
                           min="50" max="90" step="5" class="w-full p-2 bg-slate-700 border border-yellow-600 rounded text-white">
                    <div class="text-xs text-yellow-300 mt-1">Est: 70%</div>
                </div>
            </div>
            
            <!-- Financial Impact -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="p-3 bg-emerald-900/20 rounded border border-emerald-600/30">
                    <h6 class="text-sm font-semibold text-emerald-300 mb-2">📊 Financial Impact</h6>
                    <div class="space-y-1 text-xs">
                        <div class="flex justify-between">
                            <span class="text-slate-300">Max Amount (6% prod. cost):</span>
                            <span id="sinosure-max-amount" class="font-bold text-emerald-300">${formatCurrency(calculateMaxSinosureAmount())}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-300">vs Venture Debt savings:</span>
                            <span id="sinosure-vd-savings" class="font-bold text-emerald-300">
                                ${formatCurrency(((modelData.ventureDebtRate - 6) * calculateMaxSinosureAmount() / 100))} annually
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-300">WACC improvement:</span>
                            <span class="font-bold text-emerald-300">~-360 bps</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-300">TIR Equity boost:</span>
                            <span class="font-bold text-emerald-300">+400-700 bps</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-amber-900/20 rounded border border-amber-600/30">
                    <h6 class="text-sm font-semibold text-amber-300 mb-2">⚠️ Constraints & Risks</h6>
                    <div class="space-y-1 text-xs text-amber-200">
                        <div>• Limited to 12 months duration</div>
                        <div>• Requires Chinese equipment component</div>
                        <div>• Government approval process</div>
                        <div>• Export credit documentation</div>
                        <div>• Currency exposure (USD)</div>
                        <div>• ${100 - (modelData.sinosureProbability || 70)}% chance of unavailability</div>
                    </div>
                </div>
            </div>
            
            <!-- Scenario Comparison -->
            <div class="p-3 bg-slate-800/30 rounded border border-slate-600">
                <h6 class="text-sm font-semibold text-slate-300 mb-2">🔄 Quick Scenario Comparison</h6>
                <div class="grid grid-cols-3 gap-3 text-xs">
                    <div class="text-center p-2 bg-red-900/30 rounded border border-red-600/50">
                        <div class="font-bold text-red-300">Without SINOSURE</div>
                        <div class="text-red-200 mt-1">Blended Debt: ~15.2%</div>
                        <div class="text-red-200">TIR: 22-25%</div>
                    </div>
                    <div class="text-center p-2 bg-yellow-900/30 rounded border border-yellow-600/50">
                        <div class="font-bold text-yellow-300">SINOSURE (70% prob)</div>
                        <div class="text-yellow-200 mt-1">Expected: ~12.1%</div>
                        <div class="text-yellow-200">TIR: 24-28%</div>
                    </div>
                    <div class="text-center p-2 bg-emerald-900/30 rounded border border-emerald-600/50">
                        <div class="font-bold text-emerald-300">SINOSURE Success</div>
                        <div class="text-emerald-200 mt-1">Blended Debt: ~9.8%</div>
                        <div class="text-emerald-200">TIR: 27-35%</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(sinosureSection);
    
    // Event listeners
    setupSinosureEventListeners();
}

function setupSinosureEventListeners() {
    const toggle = document.getElementById('sinosureAvailable');
    const details = document.getElementById('sinosure-details');
    
    toggle?.addEventListener('change', (e) => {
        modelData.sinosureAvailable = e.target.checked;
        details.classList.toggle('hidden', !e.target.checked);
        
        // Update scenarios to include/exclude SINOSURE
        updateSinosureInAllScenarios();
        forceCalculate();
        
        log(`SINOSURE ${e.target.checked ? 'ENABLED' : 'DISABLED'}`);
    });
    
    // Update calculations when parameters change
    ['sinosureRate', 'sinosureTiming', 'sinosureDuration', 'sinosureProbability'].forEach(id => {
        const input = document.getElementById(id);
        input?.addEventListener('change', (e) => {
            modelData[id] = parseFloat(e.target.value);
            updateSinosureCalculations();
            forceCalculate();
        });
    });
}

function updateSinosureCalculations() {
    const maxAmount = calculateMaxSinosureAmount();
    const vdSavings = ((modelData.ventureDebtRate - (modelData.sinosureRate || 6)) * maxAmount / 100);
    
    document.getElementById('sinosure-max-amount').textContent = formatCurrency(maxAmount);
    document.getElementById('sinosure-vd-savings').textContent = formatCurrency(vdSavings) + ' annually';
}

function updateSinosureInAllScenarios() {
    // This would update all strategic scenarios to reflect SINOSURE availability
    log('Updated SINOSURE availability in all scenarios');
}

/**
 * Create advanced analytics dashboard
 */
function createAdvancedAnalyticsDashboard() {
    const container = document.getElementById('content-graficos');
    
    // Add analytics section to existing content
    const analyticsSection = document.createElement('div');
    analyticsSection.id = 'advanced-analytics-section';
    analyticsSection.className = 'space-y-6 mt-6';
    analyticsSection.innerHTML = `
        <div class="card">
            <h3 class="text-xl font-semibold mb-4 text-white flex items-center gap-2">
                🧠 Advanced Analytics Suite
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="runMonteCarloAnalysis()" 
                        class="p-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition-all duration-200">
                    <div class="text-lg font-bold">🎲 Monte Carlo</div>
                    <div class="text-sm">1,000 simulations</div>
                </button>
                <button onclick="runSensitivityAnalysis()" 
                        class="p-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-all duration-200">
                    <div class="text-lg font-bold">🌪️ Sensitivity</div>
                    <div class="text-sm">Tornado analysis</div>
                </button>
                <button onclick="generateInvestorReport()" 
                        class="p-4 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-all duration-200">
                    <div class="text-lg font-bold">📊 Investor Report</div>
                    <div class="text-sm">Export PDF</div>
                </button>
            </div>
        </div>
        
        <!-- Charts Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <div class="card">
                <h4 class="text-lg font-semibold mb-3 text-white">🎲 Monte Carlo Results</h4>
                <div style="height: 300px;"><canvas id="monteCarloChart"></canvas></div>
            </div>
            
            <div class="card">
                <h4 class="text-lg font-semibold mb-3 text-white">🌪️ Sensitivity Analysis</h4>
                <div style="height: 300px;"><canvas id="tornadoChart"></canvas></div>
            </div>
            
            <div class="card">
                <h4 class="text-lg font-semibold mb-3 text-white">🇨🇳 SINOSURE Impact</h4>
                <div style="height: 300px;"><canvas id="sinosureImpactChart"></canvas></div>
            </div>
            
            <div class="card">
                <h4 class="text-lg font-semibold mb-3 text-white">💰 Funding Waterfall</h4>
                <div style="height: 300px;"><canvas id="fundingWaterfallChart"></canvas></div>
            </div>
        </div>
        
        <!-- Results Panel -->
        <div id="analytics-results" class="hidden">
            <!-- Results will be populated here -->
        </div>
    `;
    
    container.appendChild(analyticsSection);
}

/**
 * Execute Monte Carlo analysis
 */
async function runMonteCarloAnalysis() {
    const button = event.target.closest('button');
    button.disabled = true;
    button.innerHTML = '<div class="text-lg font-bold">🎲 Running...</div><div class="text-sm">Please wait</div>';
    
    try {
        const engine = new MonteCarloEngine(1000); // 1000 iterations for performance
        const results = engine.runSimulation();
        
        // Create visualization
        const visualizer = new AdvancedVisualizationEngine();
        visualizer.createMonteCarloChart('monteCarloChart', results);
        
        // Show results panel
        showMonteCarloResults(results);
        
        log('✅ Monte Carlo analysis completed');
    } catch (error) {
        log(`❌ Monte Carlo analysis failed: ${error.message}`);
    } finally {
        button.disabled = false;
        button.innerHTML = '<div class="text-lg font-bold">🎲 Monte Carlo</div><div class="text-sm">1,000 simulations</div>';
    }
}

/**
 * Execute sensitivity analysis
 */
async function runSensitivityAnalysis() {
    const button = event.target.closest('button');
    button.disabled = true;
    button.innerHTML = '<div class="text-lg font-bold">🌪️ Running...</div><div class="text-sm">Please wait</div>';
    
    try {
        const analyzer = new SensitivityAnalyzer();
        const results = analyzer.runSensitivityAnalysis();
        
        // Create visualization
        const visualizer = new AdvancedVisualizationEngine();
        visualizer.createTornadoChart('tornadoChart', results);
        
        // Show results panel
        showSensitivityResults(results);
        
        log('✅ Sensitivity analysis completed');
    } catch (error) {
        log(`❌ Sensitivity analysis failed: ${error.message}`);
    } finally {
        button.disabled = false;
        button.innerHTML = '<div class="text-lg font-bold">🌪️ Sensitivity</div><div class="text-sm">Tornado analysis</div>';
    }
}

/**
 * Generate investor report
 */
function generateInvestorReport() {
    log('📊 Generating investor report...');
    alert('📊 Investor Report feature will be implemented in next phase');
}

/**
 * Show Monte Carlo results
 */
function showMonteCarloResults(results) {
    const resultsPanel = document.getElementById('analytics-results');
    resultsPanel.classList.remove('hidden');
    
    resultsPanel.innerHTML = `
        <div class="card">
            <h4 class="text-lg font-semibold mb-3 text-white">🎲 Monte Carlo Simulation Results</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-3 bg-slate-800/50 rounded">
                    <div class="text-sm text-slate-400">TIR Equity Mean</div>
                    <div class="text-xl font-bold text-emerald-300">${results.tirEquity.mean.toFixed(1)}%</div>
                    <div class="text-xs text-slate-500">σ = ${results.tirEquity.stdDev.toFixed(1)}%</div>
                </div>
                <div class="p-3 bg-slate-800/50 rounded">
                    <div class="text-sm text-slate-400">Success Probability</div>
                    <div class="text-xl font-bold text-blue-300">${(results.probabilityOfSuccess * 100).toFixed(1)}%</div>
                    <div class="text-xs text-slate-500">TIR > 20%</div>
                </div>
                <div class="p-3 bg-slate-800/50 rounded">
                    <div class="text-sm text-slate-400">VaR 95%</div>
                    <div class="text-xl font-bold text-red-300">${results.valueAtRisk95.toFixed(1)}%</div>
                    <div class="text-xs text-slate-500">Worst case scenario</div>
                </div>
            </div>
            ${results.sinosureImpact ? `
            <div class="mt-4 p-3 bg-yellow-900/20 rounded border border-yellow-600/30">
                <h5 class="font-semibold text-yellow-300 mb-2">🇨🇳 SINOSURE Impact Analysis</h5>
                <div class="text-sm text-yellow-200">
                    TIR Equity Lift: <span class="font-bold">+${results.sinosureImpact.tirEquityLift.toFixed(1)} pp</span><br>
                    Success Probability Improvement: <span class="font-bold">+${(results.sinosureImpact.successProbabilityLift * 100).toFixed(1)} pp</span>
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

/**
 * Show sensitivity results
 */
function showSensitivityResults(results) {
    const resultsPanel = document.getElementById('analytics-results');
    resultsPanel.classList.remove('hidden');
    
    resultsPanel.innerHTML = `
        <div class="card">
            <h4 class="text-lg font-semibold mb-3 text-white">🌪️ Sensitivity Analysis Results</h4>
            <div class="mb-4">
                <h5 class="font-semibold text-slate-300 mb-2">Top Value Drivers:</h5>
                <div class="space-y-1">
                    ${results.topDrivers.map((driver, i) => `
                        <div class="text-sm text-slate-400">${i + 1}. ${driver}</div>
                    `).join('')}
                </div>
            </div>
            <div>
                <h5 class="font-semibold text-slate-300 mb-2">Recommendations:</h5>
                <div class="space-y-1">
                    ${results.recommendations.map(rec => `
                        <div class="text-sm text-emerald-400">${rec}</div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

// ===================================================================
// ===== ENHANCED UX/UI FUNCTIONS =====
// ===================================================================

/**
 * Show professional loading states
 */
function showCalculationLoader() {
    const overlay = document.getElementById('calculation-loader');
    if (overlay) {
        overlay.style.display = 'flex';
    }
}

function hideCalculationLoader() {
    const overlay = document.getElementById('calculation-loader');
    if (overlay) {
        overlay.classList.add('fade-out');
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.classList.remove('fade-out');
        }, 300);
    }
}

/**
 * Update executive summary bar with key metrics
 */
function updateExecutiveSummary() {
    if (financialResults.pl && financialResults.pl.length > 0) {
        const year5PL = financialResults.pl[4];
        const tirEquity = financialResults.tirEquity || 0;
        const dscr = calculateFinalDSCR();
        const investorScore = calculateInvestorScore();
        const seriesAMetrics = calculateSeriesAMetrics();
        
        document.getElementById('tir-quick').textContent = tirEquity.toFixed(1) + '%';
        document.getElementById('ebitda-quick').textContent = formatCurrency(year5PL.ebitda);
        document.getElementById('dscr-quick').textContent = dscr === 999 ? '∞' : dscr.toFixed(1) + 'x';
        document.getElementById('health-score-quick').textContent = investorScore.grade;
        document.getElementById('health-score-quick').className = `metric-value grade-${investorScore.grade.toLowerCase()}`;
        document.getElementById('capital-efficiency-quick').textContent = '$' + (seriesAMetrics.capitalPerUnit || 0).toFixed(0) + 'K/unit';
    }
}

/**
 * Create scenario selection buttons
 */
function createScenarioButtonsEnhanced() {
    const container = document.getElementById('scenario-buttons-clean');
    if (!container) return;
    
    container.innerHTML = Object.values(strategicScenarios).map(scenario => `
        <div class="scenario-card" onclick="applyScenario('${scenario.id}')" id="scenario-card-${scenario.id}">
            <div class="scenario-icon">${scenario.icon}</div>
            <div class="scenario-info">
                <div class="scenario-name">${scenario.name}</div>
                <div class="scenario-return">${scenario.expectedOutcomes.tirEquity}</div>
            </div>
        </div>
    `).join('');
}

/**
 * Setup key controls in the sidebar
 */
function setupKeyControlsEnhanced() {
    // Interest rate control
    const rateSlider = document.getElementById('tasaInteres-sidebar');
    const rateDisplay = document.getElementById('tasaInteres-sidebar-display');
    const rateImpact = document.getElementById('rate-impact-sidebar');
    
    if (rateSlider && rateDisplay) {
        rateSlider.value = modelData.tasaInteres;
        rateDisplay.textContent = modelData.tasaInteres.toFixed(1) + '%';
        
        rateSlider.addEventListener('input', function() {
            const value = parseFloat(this.value);
            modelData.tasaInteres = value;
            rateDisplay.textContent = value.toFixed(1) + '%';
            
            // Calculate impact
            const impact = ((value - 22) * 2.1).toFixed(1);
            rateImpact.textContent = `+${impact}% margin`;
            
            // Also update main control if exists
            const mainSlider = document.getElementById('tasaInteres-input');
            if (mainSlider) {
                mainSlider.value = value;
                const mainDisplay = document.getElementById('tasaInteres-valor');
                if (mainDisplay) mainDisplay.textContent = value.toFixed(1) + '%';
            }
            
            forceCalculateEnhanced();
        });
    }
    
    // Down payment control
    const downPaymentSlider = document.getElementById('downPaymentPercentage-sidebar');
    const downPaymentDisplay = document.getElementById('downPayment-sidebar-display');
    
    if (downPaymentSlider && downPaymentDisplay) {
        downPaymentSlider.value = modelData.downPaymentPercentage;
        downPaymentDisplay.textContent = modelData.downPaymentPercentage.toFixed(1) + '%';
        
        downPaymentSlider.addEventListener('input', function() {
            const value = parseFloat(this.value);
            modelData.downPaymentPercentage = value;
            downPaymentDisplay.textContent = value.toFixed(1) + '%';
            
            // Also update main control if exists
            const mainSlider = document.getElementById('downPaymentPercentage-input');
            if (mainSlider) {
                mainSlider.value = value;
                const mainDisplay = document.getElementById('downPaymentPercentage-valor');
                if (mainDisplay) mainDisplay.textContent = value.toFixed(1) + '%';
            }
            
            forceCalculateEnhanced();
        });
    }
    
    // Units grid
    createUnitsGridEnhanced();
}

/**
 * Create clean units grid
 */
function createUnitsGridEnhanced() {
    const container = document.getElementById('units-grid-clean');
    if (!container) return;
    
    container.innerHTML = modelData.unitsPerYear.map((units, index) => `
        <div class="mb-3">
            <label class="block text-xs font-medium text-slate-400 mb-1">Year ${index + 1}</label>
            <input type="number" 
                   value="${units}" 
                   min="0" 
                   max="1000" 
                   step="10"
                   class="w-full p-2 bg-slate-800 border border-slate-600 rounded text-white text-sm"
                   onchange="updateUnitsEnhanced(${index}, this.value)">
        </div>
    `).join('');
}

/**
 * Update units value
 */
function updateUnitsEnhanced(yearIndex, value) {
    modelData.unitsPerYear[yearIndex] = parseInt(value) || 0;
    
    // Also update main grid if exists
    const mainInput = document.getElementById(`unitsPerYear-${yearIndex + 1}`);
    if (mainInput) {
        mainInput.value = value;
    }
    
    forceCalculateEnhanced();
}

/**
 * Update insights sidebar
 */
function updateInsightsSidebar() {
    updateCapacityIndicatorEnhanced();
    updateAlertsEnhanced();
    updateAIInsightsEnhanced();
}

/**
 * Update capacity indicator
 */
function updateCapacityIndicatorEnhanced() {
    const container = document.getElementById('capacity-indicator-clean');
    if (!container) return;
    
    const validation = validateCapitalConstraints();
    const utilizationPercent = validation.totalAvailableFunding > 0 ? 
        (validation.cumulativeCapexRequired / validation.totalAvailableFunding) * 100 : 0;
    
    let statusClass, statusText, statusIcon;
    
    if (validation.errors.length > 0) {
        statusClass = 'text-red-400';
        statusText = 'OVER CAPACITY';
        statusIcon = '🚨';
    } else if (utilizationPercent > 85) {
        statusClass = 'text-amber-400';
        statusText = 'Near Limit';
        statusIcon = '⚠️';
    } else {
        statusClass = 'text-emerald-400';
        statusText = 'Healthy';
        statusIcon = '✅';
    }
    
    container.innerHTML = `
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium">Capital Utilization</span>
            <span class="${statusClass} text-sm font-bold">${statusIcon} ${statusText}</span>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-2 mb-2">
            <div class="h-2 rounded-full transition-all duration-300 ${utilizationPercent > 100 ? 'bg-red-500' : utilizationPercent > 85 ? 'bg-amber-500' : 'bg-emerald-500'}" 
                 style="width: ${Math.min(100, utilizationPercent)}%"></div>
        </div>
        <div class="text-xs text-slate-400">
            ${formatCurrency(validation.cumulativeCapexRequired)} / ${formatCurrency(validation.totalAvailableFunding)}
        </div>
    `;
}

/**
 * Update alerts
 */
function updateAlertsEnhanced() {
    const container = document.getElementById('alert-list');
    if (!container) return;
    
    const alerts = [];
    
    // Check TIR Equity
    if (financialResults.tirEquity < 15) {
        alerts.push({
            type: 'danger',
            message: `Low Equity IRR: ${financialResults.tirEquity.toFixed(1)}% < 15% threshold`
        });
    }
    
    // Check DSCR
    const dscr = calculateFinalDSCR();
    if (dscr < 1.2 && dscr > 0) {
        alerts.push({
            type: 'danger',
            message: `Low DSCR: ${dscr.toFixed(1)}x < 1.2x covenant risk`
        });
    }
    
    // Check unit economics
    const unitEcon = evaluateUnitEconomics();
    if (unitEcon.marginPercent < 15) {
        alerts.push({
            type: 'warning',
            message: `Unit economics: ${unitEcon.marginPercent.toFixed(1)}% margin < 15% target`
        });
    }
    
    if (alerts.length === 0) {
        container.innerHTML = '<div class="text-sm text-slate-400">No critical alerts</div>';
    } else {
        container.innerHTML = alerts.map(alert => `
            <div class="alert-item">
                ${alert.type === 'danger' ? '🚨' : '⚠️'} ${alert.message}
            </div>
        `).join('');
    }
}

/**
 * Update AI insights
 */
function updateAIInsightsEnhanced() {
    const container = document.getElementById('insight-cards');
    if (!container) return;
    
    const insights = [];
    
    // Financing optimization insight
    const totalDebt = calculateTotalDebtRaised();
    const totalEquity = calculateTotalEquityRaised();
    const debtEquityRatio = totalEquity > 0 ? totalDebt / totalEquity : 0;
    
    if (debtEquityRatio < 0.5) {
        insights.push({
            title: 'Capital Structure',
            content: 'Consider increasing debt utilization to optimize WACC. Current D/E ratio is conservative.'
        });
    }
    
    // Growth insight
    const totalUnits = modelData.unitsPerYear.reduce((a, b) => a + b, 0);
    if (totalUnits < 500) {
        insights.push({
            title: 'Growth Opportunity',
            content: 'Unit plan appears conservative. Market size supports more aggressive expansion.'
        });
    }
    
    // SINOSURE insight
    if (!modelData.sinosureAvailable) {
        insights.push({
            title: 'SINOSURE Opportunity',
            content: 'Activating SINOSURE could reduce cost of capital by 400-700 bps. Consider Chinese equipment sourcing.'
        });
    }
    
    if (insights.length === 0) {
        insights.push({
            title: 'Optimization Status',
            content: 'Model parameters appear well-optimized. Continue monitoring key metrics.'
        });
    }
    
    container.innerHTML = insights.map(insight => `
        <div class="insight-card">
            <h4>${insight.title}</h4>
            <p>${insight.content}</p>
        </div>
    `).join('');
}

/**
 * Open full controls modal/section
 */
function openFullControls() {
    // For now, just switch to the control tab
    const controlTab = document.getElementById('tab-control');
    if (controlTab) {
        controlTab.click();
    }
}

/**
 * Enhanced force calculate with loading states
 */
function forceCalculateEnhanced() {
    showCalculationLoader();
    
    setTimeout(() => {
        capturePlannedFinancing();
        
        const validation = validateCapitalConstraints();
        if (validation.errors.length > 0) {
            const shouldAutoAdjust = confirm(
                `🚨 Units exceed capital capacity. Auto-adjust to respect limits?`
            );
            
            if (shouldAutoAdjust) {
                autoAdjustUnitsForCapacity();
            }
        }
        
        if (calculateFinancials()) {
            updateUI();
            updateExecutiveSummary();
            updateMainDashboard();
            updateInsightsSidebar();
            runGlobalChecks();
            log('✅ Enhanced calculation completed');
        } else {
            log('❌ Enhanced calculation failed');
        }
        
        hideCalculationLoader();
    }, 100);
}

/**
 * Update main dashboard metrics
 */
function updateMainDashboard() {
    if (financialResults.pl && financialResults.pl.length > 0) {
        const year5PL = financialResults.pl[4];
        const year5BS = financialResults.bs[4];
        const totalUnits = financialResults.pl.reduce((sum, pl) => sum + (pl.addedUnits || 0), 0);
        
        document.getElementById('ebitda-year5-main').textContent = formatCurrency(year5PL.ebitda);
        document.getElementById('tir-equity-main').textContent = (financialResults.tirEquity || 0).toFixed(1) + '%';
        document.getElementById('aum-main').textContent = formatCurrency(year5BS.totalAssets);
        document.getElementById('total-units-main').textContent = totalUnits.toLocaleString();
    }
}

/**
 * Enhanced UI update function
 */
const originalUpdateUI = updateUI;
updateUI = function() {
    originalUpdateUI();
    updateExecutiveSummary();
    updateMainDashboard();
    updateInsightsSidebar();
};

// Override the original forceCalculate function
const originalForceCalculate = forceCalculate;
forceCalculate = forceCalculateEnhanced;

/**
* Runs when the DOM is fully loaded.
* Process: Initializes the UI, configures controls, performs initial calculation, and updates UI and charts.
*/
document.addEventListener('DOMContentLoaded', function() {
    log('🚀 STARTING ENHANCED RAG FINANCIAL MODEL');

    try {
        // Initialize Lucide icons
        lucide.createIcons();
        
        setupTabs();
        setupControls();
        createScenarioButtons();
        createScenarioButtonsEnhanced();
        setupKeyControlsEnhanced();
        
        if (typeof createSinosureControlsAdvanced === 'function') {
            createSinosureControlsAdvanced();
        }
        
        if (typeof createAdvancedAnalyticsDashboard === 'function') {
            createAdvancedAnalyticsDashboard();
        }

        // Initial calculation
        setTimeout(() => {
            forceCalculate();
            
            // Initialize charts
            initializeCharts();
            updateCharts();
            
            if (typeof AdvancedVisualizationEngine !== 'undefined') {
                const visualizer = new AdvancedVisualizationEngine();
                visualizer.createFundingWaterfallChart('fundingWaterfallChart');
            }
        }, 500);

        log('🎉 ENHANCED RAG FINANCIAL MODEL READY');

    } catch (error) {
        log(`❌ CRITICAL ERROR DURING INITIALIZATION: ${error.message}`);
    }
});
</script>
</body>
</html>
