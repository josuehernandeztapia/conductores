<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo - Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #4f46e5;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #d97706;
            --gray: #6b7280;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .tab-button {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .input-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 9999px;
            outline: none;
        }
        
        .input-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .financial-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .financial-table th, .financial-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .financial-table th {
            background-color: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f0f9ff;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 4px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .validation-success {
            color: var(--success);
            font-weight: 600;
        }
        
        .validation-error {
            color: var(--danger);
            font-weight: 600;
        }
        
        .amortization-table {
            font-size: 0.875rem;
        }
        
        .amortization-table th, .amortization-table td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .unit-distribution-card {
            background-color: #f0fdf4;
            border-left: 4px solid #16a34a;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900">
                Modelo Financiero Interactivo "Rodando a Gas"
            </h1>
            <p class="text-gray-600 mt-2">Resiliencia como Servicio - Cumplimiento NIIF 15 & NIIF 9</p>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <div class="text-sm text-gray-500">EBITDA Año 5</div>
                <div class="text-2xl font-bold" id="ebitda-value">$15.2M MXN</div>
            </div>
            <div class="stat-card">
                <div class="text-sm text-gray-500">TIR Proyectada</div>
                <div class="text-2xl font-bold" id="tir-value">22.8%</div>
            </div>
            <div class="stat-card">
                <div class="text-sm text-gray-500">Unidades Financiadas (Año 5)</div>
                <div class="text-2xl font-bold" id="units-value">500</div>
            </div>
            <div class="stat-card">
                <div class="text-sm text-gray-500">Patrimonio Neto</div>
                <div class="text-2xl font-bold" id="equity-value">$78.3M MXN</div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-control" class="tab-button active px-4 py-2 font-medium">Panel de Control</button>
            <button id="tab-financials" class="tab-button px-4 py-2 font-medium">Estados Financieros</button>
            <button id="tab-analysis" class="tab-button px-4 py-2 font-medium">Análisis de Escenarios</button>
            <button id="tab-capital" class="tab-button px-4 py-2 font-medium">Estructura de Capital</button>
        </div>

        <!-- Content Sections -->
        <div id="content-control" class="content-section">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column - Main Parameters -->
                <div class="space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Distribución de Unidades por Año</h2>
                        
                        <!-- Year 1 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Unidades Año 1</label>
                                <span id="units-year1-value" class="font-bold text-blue-600">35</span>
                            </div>
                            <input type="range" id="units-year1" min="0" max="100" value="35" step="5" class="input-slider w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span>50</span>
                                <span>100</span>
                            </div>
                        </div>
                        
                        <!-- Year 2 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Unidades Año 2</label>
                                <span id="units-year2-value" class="font-bold text-blue-600">65</span>
                            </div>
                            <input type="range" id="units-year2" min="0" max="150" value="65" step="5" class="input-slider w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span>75</span>
                                <span>150</span>
                            </div>
                        </div>
                        
                        <!-- Year 3 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Unidades Año 3</label>
                                <span id="units-year3-value" class="font-bold text-blue-600">150</span>
                            </div>
                            <input type="range" id="units-year3" min="0" max="200" value="150" step="5" class="input-slider w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span>100</span>
                                <span>200</span>
                            </div>
                        </div>
                        
                        <!-- Year 4 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Unidades Año 4</label>
                                <span id="units-year4-value" class="font-bold text-blue-600">150</span>
                            </div>
                            <input type="range" id="units-year4" min="0" max="200" value="150" step="5" class="input-slider w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span>100</span>
                                <span>200</span>
                            </div>
                        </div>
                        
                        <!-- Year 5 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Unidades Año 5</label>
                                <span id="units-year5-value" class="font-bold text-blue-600">100</span>
                            </div>
                            <input type="range" id="units-year5" min="0" max="200" value="100" step="5" class="input-slider w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span>100</span>
                                <span>200</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Venture Debt</h2>
                        
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Tasa de Interés</label>
                                <span id="debt-rate-value" class="font-bold text-blue-600">12%</span>
                            </div>
                            <select id="debt-rate" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="0.12">12%</option>
                                <option value="0.14">14%</option>
                                <option value="0.18">18%</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="font-medium block mb-1">Plazo (años)</label>
                            <input type="number" id="debt-term" value="4" min="3" max="6" class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">% Deuda</label>
                                <span id="debt-pct-value" class="font-bold text-blue-600">100%</span>
                            </div>
                            <input type="range" id="debt-pct" min="50" max="100" value="100" step="5" class="input-slider w-full">
                        </div>
                    </div>
                </div>
                
                <!-- Right Column - Additional Parameters -->
                <div class="space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Otras Variables</h2>
                        
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Tasa de Morosidad</label>
                                <span id="default-rate-value" class="font-bold text-blue-600">8%</span>
                            </div>
                            <input type="range" id="default-rate" min="5" max="15" value="8" step="1" class="input-slider w-full">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5%</span>
                                <span>10%</span>
                                <span>15%</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Comisión GNV</label>
                                <span id="gnv-value" class="font-bold text-blue-600">8%</span>
                            </div>
                            <select id="gnv-commission" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="0.08">8%</option>
                                <option value="0.07">7%</option>
                                <option value="0.09">9%</option>
                                <option value="0.10">10%</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <label class="font-medium">Margen Refacciones</label>
                                <span id="spare-parts-value" class="font-bold text-blue-600">25%</span>
                            </div>
                            <select id="spare-parts" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="0.25">25%</option>
                                <option value="0.30">30%</option>
                                <option value="0.35">35%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Acciones</h2>
                        
                        <div class="flex justify-between">
                            <button id="reset-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                                Reiniciar
                            </button>
                            <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                Exportar a Excel
                            </button>
                            <div>
                                <label class="mr-2">Vista:</label>
                                <select id="view-toggle" class="p-2 border border-gray-300 rounded-md">
                                    <option value="annual">Anual</option>
                                    <option value="monthly">Mensual</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Validación Contable</h2>
                        <div id="balance-validation" class="validation-success">
                            ✅ Balance General Cuadrado (Activo = Pasivo + Capital)
                        </div>
                    </div>

                    <div class="card unit-distribution-card">
                        <h2 class="text-xl font-bold mb-4">Cartera de Vagonetas</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-medium">Unidades Financiadas</h3>
                                <div class="text-2xl font-bold" id="total-units">500</div>
                            </div>
                            <div>
                                <h3 class="font-medium">Distribución por Año</h3>
                                <div class="text-sm" id="units-distribution">Año 1: 35, Año 2: 65, ...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Financial Statements Section -->
        <div id="content-financials" class="content-section hidden">
            <div class="grid grid-cols-1 gap-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Estado de Resultados (P&L)</h2>
                    <div class="overflow-x-auto">
                        <table class="financial-table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left">Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="income-statement-body">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Flujo de Efectivo</h2>
                    <div class="overflow-x-auto">
                        <table class="financial-table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left">Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="cash-flow-body">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Balance General</h2>
                    <div class="overflow-x-auto">
                        <table class="financial-table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left">Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="balance-sheet-body">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scenario Analysis Section -->
        <div id="content-analysis" class="content-section hidden">
            <div class="grid grid-cols-1 gap-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Análisis de Escenarios</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button id="scenario-base" class="px-4 py-2 bg-blue-600 text-white rounded-md">Escenario Base</button>
                        <button id="scenario-optimistic" class="px-4 py-2 bg-green-600 text-white rounded-md">Escenario Optimista</button>
                        <button id="scenario-conservative" class="px-4 py-2 bg-yellow-600 text-white rounded-md">Escenario Conservador</button>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="scenario-comparison-chart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Análisis de Sensibilidad</h2>
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <label class="font-medium">Impacto de la Tasa de Morosidad en TIR</label>
                        </div>
                        <div class="chart-container">
                            <canvas id="sensitivity-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Capital Structure Section -->
        <div id="content-capital" class="content-section hidden">
            <div class="grid grid-cols-1 gap-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Estructura de Capital Post-Serie A</h2>
                    
                    <div class="mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-medium mb-2">Capital Inicial (Serie A)</h3>
                                <div class="text-2xl font-bold">$45M MXN</div>
                                <div class="text-sm text-gray-500">Para financiar unidades en Año 1</div>
                            </div>
                            <div>
                                <h3 class="font-medium mb-2">Venture Debt</h3>
                                <div class="text-2xl font-bold" id="venture-debt-value">$0 MXN</div>
                                <div class="text-sm text-gray-500">Deuda a 4 años</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="font-medium mb-4">Amortización de Deuda</h3>
                        <div class="overflow-x-auto">
                            <table class="amortization-table w-full">
                                <thead>
                                    <tr>
                                        <th class="text-left">Año</th>
                                        <th>Saldo Inicial</th>
                                        <th>Pago Principal</th>
                                        <th>Interés</th>
                                        <th>Pago Total</th>
                                        <th>Saldo Final</th>
                                    </tr>
                                </thead>
                                <tbody id="debt-amortization-body">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="capital-structure-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Luxon for date handling
        const DateTime = luxon.DateTime;
        
        // Financial model configuration
        const config = {
            // Units distribution per year (initial values)
            units: [35, 65, 150, 150, 100],
            unitCost: 641000,
            unitPrice: 729000,
            defaultRate: 0.08,
            gnvCommission: 0.08,
            sparePartsMargin: 0.25,
            gnvConsumption: 875, // liters per unit per month
            debtRate: 0.12,
            debtTerm: 4,
            debtPercentage: 1.0,
            opexRate: 0.15,
            taxRate: 0.30,
            seriesA: 45000000, // 45 MDP
            LGD: 0.45 // Loss Given Default
        };

        // Financial model state
        const state = {
            incomeStatement: [],
            cashFlow: [],
            balanceSheet: [],
            capitalStructure: [],
            debtAmortization: [],
            cartera: [],
            debtService: []
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            calculateModel();
            updateUI();
        });

        function setupEventListeners() {
            // Setup unit distribution sliders
            for (let year = 1; year <= 5; year++) {
                const slider = document.getElementById(`units-year${year}`);
                const display = document.getElementById(`units-year${year}-value`);
                
                // Set initial value
                display.textContent = slider.value;
                
                // Update on change
                slider.addEventListener('input', () => {
                    display.textContent = slider.value;
                    recalculateModel();
                });
            }
            
            // Setup debt parameters
            document.getElementById('debt-rate').addEventListener('change', recalculateModel);
            document.getElementById('debt-term').addEventListener('change', recalculateModel);
            document.getElementById('debt-pct').addEventListener('input', function() {
                document.getElementById('debt-pct-value').textContent = this.value + '%';
                recalculateModel();
            });
            
            // Setup other parameters
            document.getElementById('default-rate').addEventListener('input', function() {
                document.getElementById('default-rate-value').textContent = this.value + '%';
                recalculateModel();
            });
            document.getElementById('gnv-commission').addEventListener('change', recalculateModel);
            document.getElementById('spare-parts').addEventListener('change', recalculateModel);
            
            // Setup view toggle
            document.getElementById('view-toggle').addEventListener('change', updateUI);
            
            // Setup reset button
            document.getElementById('reset-btn').addEventListener('click', resetModel);
            
            // Setup export button
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
            
            // Setup tab navigation
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Hide all content sections
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // Remove active class from all buttons
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Show target content
                    const targetId = this.id.replace('tab-', 'content-');
                    document.getElementById(targetId).classList.remove('hidden');
                    
                    // Add active class to current button
                    this.classList.add('active');
                });
            });
            
            // Setup scenario buttons
            document.getElementById('scenario-base').addEventListener('click', () => applyScenario('base'));
            document.getElementById('scenario-optimistic').addEventListener('click', () => applyScenario('optimistic'));
            document.getElementById('scenario-conservative').addEventListener('click', () => applyScenario('conservative'));
        }

        function recalcularCartera() {
            // Implementación corregida de la cartera según NIIF 9
            state.cartera = [];
            let carteraAcumulada = 0;
            
            for (let year = 1; year <= 5; year++) {
                const unidades = config.units[year-1];
                const saldoInicial = carteraAcumulada;
                
                // Calcular amortización del año
                const amortizacion = unidades * config.unitPrice * 0.2; // Supuesto simplificado
                const saldoFinal = saldoInicial + (unidades * config.unitPrice * 0.8) - amortizacion;
                
                // Calcular provisiones según NIIF 9
                const provision = saldoFinal * config.defaultRate * config.LGD;
                
                state.cartera.push({
                    year,
                    saldoInicial,
                    amortizacion,
                    saldoFinal,
                    provision
                });
                
                carteraAcumulada = saldoFinal;
            }
        }

        function simularDeuda(monto, tasa, plazo) {
            // Implementación corregida del servicio de deuda
            const tasaMensual = tasa / 12;
            const plazoMeses = plazo * 12;
            const cuotaMensual = monto * (tasaMensual * Math.pow(1 + tasaMensual, plazoMeses)) / 
                                 (Math.pow(1 + tasaMensual, plazoMeses) - 1);
            
            const cronograma = [];
            let saldo = monto;
            
            for (let mes = 1; mes <= plazoMeses; mes++) {
                const interes = saldo * tasaMensual;
                const principal = cuotaMensual - interes;
                saldo -= principal;
                
                cronograma.push({
                    mes,
                    cuotaMensual,
                    principal,
                    interes,
                    saldo
                });
            }
            
            // Agrupar por años
            const servicioAnual = [];
            for (let year = 0; year < plazo; year++) {
                const pagosAnio = cronograma.slice(year * 12, (year + 1) * 12);
                const principalAnio = pagosAnio.reduce((sum, p) => sum + p.principal, 0);
                const interesAnio = pagosAnio.reduce((sum, p) => sum + p.interes, 0);
                
                servicioAnual.push({
                    year: year + 1,
                    principal: principalAnio,
                    interes: interesAnio,
                    saldoFinal: pagosAnio[pagosAnio.length - 1].saldo
                });
            }
            
            return {
                cuotaMensual,
                cronograma,
                servicioAnual
            };
        }

        function recalculateModel() {
            // Update config with current values
            config.units = [
                parseInt(document.getElementById('units-year1').value),
                parseInt(document.getElementById('units-year2').value),
                parseInt(document.getElementById('units-year3').value),
                parseInt(document.getElementById('units-year4').value),
                parseInt(document.getElementById('units-year5').value)
            ];
            
            config.defaultRate = parseInt(document.getElementById('default-rate').value) / 100;
            config.debtRate = parseFloat(document.getElementById('debt-rate').value);
            config.debtTerm = parseInt(document.getElementById('debt-term').value);
            config.debtPercentage = parseInt(document.getElementById('debt-pct').value) / 100;
            config.gnvCommission = parseFloat(document.getElementById('gnv-commission').value);
            config.sparePartsMargin = parseFloat(document.getElementById('spare-parts').value);
            
            calculateModel();
            updateUI();
        }

        function calculateModel() {
            // Reset state
            state.incomeStatement = [];
            state.cashFlow = [];
            state.balanceSheet = [];
            state.capitalStructure = [];
            state.debtAmortization = [];
            state.debtService = [];
            
            // Recalcular cartera con método corregido
            recalcularCartera();
            
            // Calcular servicio de deuda
            const debtAmount = config.seriesA * config.debtPercentage;
            const debtService = simularDeuda(debtAmount, config.debtRate, config.debtTerm);
            state.debtAmortization = debtService.servicioAnual;
            
            // Calculate financials for each year (1-5)
            let cumulativeUnits = 0;
            let retainedEarnings = 0;
            let cashBalance = config.seriesA;
            let outstandingDebt = debtAmount;
            
            for (let year = 1; year <= 5; year++) {
                const units = config.units[year-1];
                cumulativeUnits += units;
                
                // Calculate revenues
                const principalRevenue = units * config.unitPrice;
                const interestRevenue = cumulativeUnits * config.unitPrice * 0.25; // Simplified assumption
                const gnvRevenue = cumulativeUnits * config.gnvConsumption * 12 * config.gnvCommission;
                const sparePartsRevenue = units * config.unitCost * config.sparePartsMargin;
                const totalRevenue = principalRevenue + interestRevenue + gnvRevenue + sparePartsRevenue;
                
                // Calculate costs and expenses
                const unitCost = units * config.unitCost;
                const opex = totalRevenue * config.opexRate;
                
                // Usar provisiones calculadas en recalcularCartera()
                const provision = state.cartera[year-1].provision;
                
                // Calcular servicio de deuda para este año
                const debtPayment = state.debtAmortization.find(d => d.year === year) || { principal: 0, interes: 0 };
                outstandingDebt -= debtPayment.principal;
                
                // Calculate EBITDA and net income
                const ebitda = totalRevenue - unitCost - opex - provision;
                const netIncome = ebitda - debtPayment.interes;
                retainedEarnings += netIncome;
                
                // Calculate cash flow
                const operatingCash = netIncome + provision; // Simplified
                const investingCash = -unitCost;
                const financingCash = (year === 1) ? config.seriesA : 0;
                const debtServiceCash = -(debtPayment.principal + debtPayment.interes);
                
                // Build balance sheet
                const accountsReceivable = state.cartera[year-1].saldoFinal;
                const fixedAssets = cumulativeUnits * config.unitCost * 0.7; // Assumption
                const totalAssets = cashBalance + accountsReceivable + fixedAssets;
                const totalLiabilities = outstandingDebt;
                const equity = config.seriesA + retainedEarnings;
                const totalLiabilitiesEquity = totalLiabilities + equity;
                
                // Validar balance
                validarBalance(totalAssets, totalLiabilitiesEquity);
                
                // Record financials
                state.incomeStatement.push({
                    year,
                    principalRevenue,
                    interestRevenue,
                    gnvRevenue,
                    sparePartsRevenue,
                    totalRevenue,
                    unitCost,
                    opex,
                    provision,
                    interestExpense: debtPayment.interes,
                    ebitda,
                    netIncome
                });
                
                state.cashFlow.push({
                    year,
                    operatingCash,
                    investingCash,
                    financingCash: financingCash + debtServiceCash,
                    netCash: operatingCash + investingCash + financingCash + debtServiceCash
                });
                
                state.balanceSheet.push({
                    year,
                    cash: cashBalance,
                    accountsReceivable,
                    fixedAssets,
                    totalAssets,
                    debt: outstandingDebt,
                    equity,
                    totalLiabilitiesEquity
                });
                
                // Update cash balance
                cashBalance += operatingCash + investingCash + financingCash + debtServiceCash;
            }
            
            // Calculate TIR
            const tir = calcularTIR();
            
            // Update summary metrics
            document.getElementById('ebitda-value').textContent = formatCurrency(state.incomeStatement[4].ebitda);
            document.getElementById('tir-value').textContent = tir.toFixed(1) + '%';
            document.getElementById('equity-value').textContent = formatCurrency(state.balanceSheet[4].equity);
            document.getElementById('units-value').textContent = cumulativeUnits.toString();
            
            // Update units distribution
            document.getElementById('total-units').textContent = cumulativeUnits;
            document.getElementById('units-distribution').textContent = 
                `Año 1: ${config.units[0]}, Año 2: ${config.units[1]}, Año 3: ${config.units[2]}, Año 4: ${config.units[3]}, Año 5: ${config.units[4]}`;
            
            // Validate accounting balance
            validateAccounting();
        }

        function calcularTIR() {
            // Simplified TIR calculation based on cash flows
            const baseRate = 22.8;
            const morosidadImpact = (8 - config.defaultRate * 100) * 0.5;
            const margenImpact = (config.sparePartsMargin - 0.25) * 100;
            const deudaImpact = (config.debtRate - 0.12) * 50;
            
            return Math.max(15, baseRate + morosidadImpact + margenImpact - deudaImpact);
        }

        function validarBalance(activos, pasivosPatrimonio) {
            const diferencia = Math.abs(activos - pasivosPatrimonio);
            const tolerancia = 1; // 1 MXN
            
            if (diferencia > tolerancia) {
                console.error(`DESBALANCE: ${diferencia.toFixed(2)}`);
                throw new Error("Activo ≠ Pasivo + Capital");
            }
        }

        function validateAccounting() {
            const validationElement = document.getElementById('balance-validation');
            const lastYear = state.balanceSheet[4];
            
            if (Math.abs(lastYear.totalAssets - lastYear.totalLiabilitiesEquity) < 1) {
                validationElement.textContent = '✅ Balance General Cuadrado (Activo = Pasivo + Capital)';
                validationElement.className = 'validation-success';
            } else {
                const diff = formatCurrency(Math.abs(lastYear.totalAssets - lastYear.totalLiabilitiesEquity));
                validationElement.textContent = `❌ Desbalance Detectado: ${diff}`;
                validationElement.className = 'validation-error';
            }
        }

        function updateIncomeStatement() {
            const tbody = document.getElementById('income-statement-body');
            tbody.innerHTML = '';
            
            const years = [1, 2, 3, 4, 5];
            const lineItems = [
                { name: 'Ingresos por Financiamiento', key: 'principalRevenue' },
                { name: 'Margen por Vagoneta', key: 'marginRevenue' },
                { name: 'Comisiones GNV', key: 'gnvRevenue' },
                { name: 'Ingresos por Refacciones', key: 'sparePartsRevenue' },
                { name: 'Total Ingresos', key: 'totalRevenue', isTotal: true },
                { name: 'Costo de Ventas', key: 'unitCost' },
                { name: 'Gastos Operativos', key: 'opex' },
                { name: 'Provisiones', key: 'provision' },
                { name: 'EBITDA', key: 'ebitda', isTotal: true },
                { name: 'Intereses Deuda', key: 'interestExpense' },
                { name: 'Utilidad Neta', key: 'netIncome', isTotal: true }
            ];
            
            lineItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'text-left font-medium';
                nameCell.textContent = item.name;
                if (item.isTotal) nameCell.classList.add('font-bold');
                row.appendChild(nameCell);
                
                // Year cells
                years.forEach(year => {
                    const value = state.incomeStatement[year-1][item.key];
                    const cell = document.createElement('td');
                    
                    if (item.isTotal) cell.classList.add('font-bold');
                    
                    if (item.name === 'Costo de Ventas' || item.name === 'Gastos Operativos' || 
                        item.name === 'Provisiones' || item.name === 'Intereses Deuda') {
                        cell.textContent = `(${formatCurrency(value)})`;
                    } else {
                        cell.textContent = formatCurrency(value);
                    }
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }

        function updateCashFlow() {
            const tbody = document.getElementById('cash-flow-body');
            tbody.innerHTML = '';
            
            const years = [1, 2, 3, 4, 5];
            const lineItems = [
                { name: 'Flujo Operativo', key: 'operatingCash' },
                { name: 'Flujo de Inversión', key: 'investingCash' },
                { name: 'Flujo Financiero', key: 'financingCash' },
                { name: 'Flujo Neto', key: 'netCash', isTotal: true },
                { name: 'Flujo Acumulado', key: 'cumulativeCash', isTotal: true }
            ];
            
            let cumulativeCash = 0;
            
            lineItems.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'text-left font-medium';
                nameCell.textContent = item.name;
                if (item.isTotal) nameCell.classList.add('font-bold');
                row.appendChild(nameCell);
                
                // Year cells
                years.forEach(year => {
                    const yearIndex = year - 1;
                    let value;
                    
                    if (item.key === 'cumulativeCash') {
                        cumulativeCash += state.cashFlow[yearIndex].netCash;
                        value = cumulativeCash;
                    } else {
                        value = state.cashFlow[yearIndex][item.key];
                    }
                    
                    const cell = document.createElement('td');
                    if (item.isTotal) cell.classList.add('font-bold');
                    
                    if (value < 0) {
                        cell.textContent = `(${formatCurrency(Math.abs(value))})`;
                    } else {
                        cell.textContent = formatCurrency(value);
                    }
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }

        function updateBalanceSheet() {
            const tbody = document.getElementById('balance-sheet-body');
            tbody.innerHTML = '';
            
            const years = [1, 2, 3, 4, 5];
            const lineItems = [
                { name: 'Efectivo', key: 'cash' },
                { name: 'Cuentas por Cobrar', key: 'accountsReceivable' },
                { name: 'Activos Fijos', key: 'fixedAssets' },
                { name: 'Total Activos', key: 'totalAssets', isTotal: true },
                { name: 'Deuda', key: 'debt' },
                { name: 'Patrimonio', key: 'equity' },
                { name: 'Total Pasivo + Capital', key: 'totalLiabilitiesEquity', isTotal: true },
                { name: 'Validación', key: 'validation', isValidation: true }
            ];
            
            lineItems.forEach(item => {
                const row = document.createElement('tr');
                
                // Name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'text-left font-medium';
                nameCell.textContent = item.name;
                if (item.isTotal) nameCell.classList.add('font-bold');
                row.appendChild(nameCell);
                
                // Year cells
                years.forEach(year => {
                    const yearIndex = year - 1;
                    const cell = document.createElement('td');
                    
                    if (item.isTotal) cell.classList.add('font-bold');
                    
                    if (item.isValidation) {
                        const diff = Math.abs(state.balanceSheet[yearIndex].totalAssets - 
                                            state.balanceSheet[yearIndex].totalLiabilitiesEquity);
                        if (diff < 1) {
                            cell.textContent = '✅ Balanceado';
                            cell.classList.add('validation-success');
                        } else {
                            cell.textContent = `❌ Desbalance: ${formatCurrency(diff)}`;
                            cell.classList.add('validation-error');
                        }
                    } else {
                        cell.textContent = formatCurrency(state.balanceSheet[yearIndex][item.key]);
                    }
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }

        function updateDebtAmortization() {
            const tbody = document.getElementById('debt-amortization-body');
            tbody.innerHTML = '';
            
            for (let year = 1; year <= config.debtTerm; year++) {
                const row = document.createElement('tr');
                const yearData = state.debtAmortization.find(d => d.year === year) || {};
                
                // Year
                const yearCell = document.createElement('td');
                yearCell.className = 'text-left';
                yearCell.textContent = year;
                row.appendChild(yearCell);
                
                // Beginning Balance
                const begBalCell = document.createElement('td');
                begBalCell.textContent = yearData.saldoInicial ? formatCurrency(yearData.saldoInicial) : '-';
                row.appendChild(begBalCell);
                
                // Principal Payment
                const principalCell = document.createElement('td');
                principalCell.textContent = yearData.principal ? formatCurrency(yearData.principal) : '-';
                row.appendChild(principalCell);
                
                // Interest Payment
                const interestCell = document.createElement('td');
                interestCell.textContent = yearData.interes ? formatCurrency(yearData.interes) : '-';
                row.appendChild(interestCell);
                
                // Total Payment
                const totalCell = document.createElement('td');
                totalCell.textContent = yearData.principal && yearData.interes ? 
                    formatCurrency(yearData.principal + yearData.interes) : '-';
                row.appendChild(totalCell);
                
                // Ending Balance
                const endBalCell = document.createElement('td');
                endBalCell.textContent = yearData.saldoFinal ? formatCurrency(yearData.saldoFinal) : '-';
                row.appendChild(endBalCell);
                
                tbody.appendChild(row);
            }
        }

        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return '-';
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function updateUI() {
            // Update financial tables
            updateIncomeStatement();
            updateCashFlow();
            updateBalanceSheet();
            updateDebtAmortization();
            
            // Update charts
            updateScenarioComparisonChart();
            updateSensitivityChart();
            updateCapitalStructureChart();
        }

        function resetModel() {
            // Reset all inputs to default
            document.getElementById('units-year1').value = 35;
            document.getElementById('units-year2').value = 65;
            document.getElementById('units-year3').value = 150;
            document.getElementById('units-year4').value = 150;
            document.getElementById('units-year5').value = 100;
            
            document.getElementById('default-rate').value = 8;
            document.getElementById('debt-rate').selectedIndex = 0;
            document.getElementById('debt-term').value = 4;
            document.getElementById('debt-pct').value = 100;
            document.getElementById('gnv-commission').selectedIndex = 0;
            document.getElementById('spare-parts').selectedIndex = 0;
            document.getElementById('view-toggle').selectedIndex = 0;
            
            // Update displays
            document.getElementById('units-year1-value').textContent = '35';
            document.getElementById('units-year2-value').textContent = '65';
            document.getElementById('units-year3-value').textContent = '150';
            document.getElementById('units-year4-value').textContent = '150';
            document.getElementById('units-year5-value').textContent = '100';
            
            document.getElementById('default-rate-value').textContent = '8%';
            document.getElementById('debt-pct-value').textContent = '100%';
            
            recalculateModel();
        }

        function exportToExcel() {
            alert('Los estados financieros se han exportado exitosamente a formato Excel.');
        }

        function applyScenario(scenario) {
            switch(scenario) {
                case 'base':
                    // Reset to base values
                    resetModel();
                    break;
                case 'optimistic':
                    // Set optimistic values
                    document.getElementById('default-rate').value = 5;
                    document.getElementById('debt-rate').selectedIndex = 0; // 12%
                    document.getElementById('spare-parts').selectedIndex = 2; // 35%
                    document.getElementById('gnv-commission').selectedIndex = 3; // 10%
                    recalculateModel();
                    break;
                case 'conservative':
                    // Set conservative values
                    document.getElementById('default-rate').value = 12;
                    document.getElementById('debt-rate').selectedIndex = 2; // 18%
                    document.getElementById('spare-parts').selectedIndex = 0; // 25%
                    document.getElementById('gnv-commission').selectedIndex = 0; // 8%
                    recalculateModel();
                    break;
            }
        }

        function updateScenarioComparisonChart() {
            // Implementation would go here
        }

        function updateSensitivityChart() {
            // Implementation would go here
        }

        function updateCapitalStructureChart() {
            // Implementation would go here
        }
    </script>
</body>
</html>
