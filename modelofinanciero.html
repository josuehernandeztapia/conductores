<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo - Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .debug-info { position: fixed; top: 10px; right: 10px; background: #1f2937; color: white; padding: 10px; border-radius: 6px; font-size: 12px; max-width: 300px; z-index: 1000; display: none; }
        .niif-compliant { border-left: 4px solid #10b981; background-color: #f0fdf4; }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Debug Panel -->
    <div id="debug-info" class="debug-info">
        <div id="debug-content"></div>
        <button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
    </div>
    
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Resiliencia como Servicio</p>
            <button onclick="toggleDebug()" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm">Debug</button>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA Año 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas</div>
                <div class="text-2xl font-bold" id="vagonetas-total">0</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Deuda Residual</div>
                <div class="text-2xl font-bold" id="deuda-residual">$0M MXN</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">🚀 Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📊 Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📋 NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📈 Gráficos</button>
            </nav>
        </div>

        <!-- Control Panel -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Crédito y Riesgo -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Crédito y Riesgo</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Tasa de Interés 
                                <span id="tasa-interes-valor" class="font-bold text-indigo-600">25.5%</span>
                            </label>
                            <input type="range" id="tasa-interes" min="23.9" max="26.9" step="0.1" value="25.5" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Tasa Morosidad 
                                <span id="tasa-morosidad-valor" class="font-bold text-indigo-600">8%</span>
                            </label>
                            <input type="range" id="tasa-morosidad" min="4" max="15" step="0.5" value="8" class="input-slider mt-1">
                        </div>
                        <div class="flex items-center">
                            <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                            <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Protección Rodando (-50% provisiones)</label>
                        </div>
                    </div>
                </div>
                
                <!-- Operaciones -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Operaciones</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Comisión GNV 
                                <span id="comision-gnv-valor" class="font-bold text-indigo-600">8%</span>
                            </label>
                            <input type="range" id="comision-gnv" min="6" max="20" step="0.5" value="8" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Margen Refacciones 
                                <span id="margen-refacciones-valor" class="font-bold text-indigo-600">25%</span>
                            </label>
                            <input type="range" id="margen-refacciones" min="20" max="40" step="1" value="25" class="input-slider mt-1">
                        </div>
                    </div>
                </div>

                <!-- Capital -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Capital</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                % Venture Debt 
                                <span id="venture-debt-pct-valor" class="font-bold text-indigo-600">70%</span>
                            </label>
                            <input type="range" id="venture-debt-pct" min="50" max="100" step="5" value="70" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Tasa Venture Debt 
                                <span id="venture-debt-rate-valor" class="font-bold text-indigo-600">12%</span>
                            </label>
                            <input type="range" id="venture-debt-rate" min="10" max="16" step="0.5" value="12" class="input-slider mt-1">
                        </div>
                    </div>
                </div>

                <!-- Unidades por Año -->
                <div class="card lg:col-span-3">
                    <h3 class="text-xl font-semibold mb-4">Unidades por Año</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="units-container"></div>
                    <button onclick="forceCalculate()" class="mt-4 bg-green-500 text-white px-4 py-2 rounded font-medium">🔄 Recalcular</button>
                </div>
            </div>
        </div>

        <!-- Estados Financieros -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 0</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body"></tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4 text-center font-semibold"></div>
                </div>
            </div>
        </div>

        <!-- NIIF -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos</h3>
                    <div id="niif15-container">Calculando datos NIIF 15...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 9 - Provisiones Crediticias</h3>
                    <div id="niif9-container">Calculando datos NIIF 9...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos Mantenidos para Venta</h3>
                    <div id="niif5-container">Calculando datos NIIF 5...</div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evolución de EBITDA</h4>
                    <div style="height: 300px;"><canvas id="ebitdaChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Composición de Ingresos</h4>
                    <div style="height: 300px;"><canvas id="revenueMixChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES =====
        let debugLogs = [];
        
        // CORRECCIÓN: Modelo de datos con Serie A incluida
        let modelData = {
            tasaInteres: 25.5,
            tasaMorosidad: 8,
            proteccionRodando: true,
            comisionGNV: 8,
            margenRefacciones: 25,
            ventureDebtPct: 70,
            ventureDebtRate: 12,
            unitsPerYear: [35, 70, 100, 150, 200],
            vanCost: 641000,
            vanPrice: 729000,
            seriesA: 45000000,           // CORREGIDO: Serie A explícita
            depreciationYears: 10,
            opexRate: 15,
            heldForSaleThreshold: 0.3,   
            fairValueDiscount: 0.85,     
            costsToSellRate: 0.05        
        };

        let financialResults = {
            pl: [],
            cf: [],
            bs: [],
            niifDetails: [],
            tirProyecto: 0,
            tirCartera: 0
        };

        // ===== FUNCIONES DE DEBUG =====
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.unshift(logEntry);
            if (debugLogs.length > 20) debugLogs.pop();
            
            console.log(logEntry, data);
            updateDebugPanel();
        }
        
        function updateDebugPanel() {
            const panel = document.getElementById('debug-content');
            if (panel) {
                panel.innerHTML = debugLogs.map(log => `<div style="margin-bottom: 2px; font-size: 10px;">${log}</div>`).join('');
            }
        }
        
        function toggleDebug() {
            const panel = document.getElementById('debug-info');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // ===== CÁLCULO FINANCIERO PRINCIPAL CORREGIDO =====
        function calculateFinancials() {
            log('🚀 INICIANDO CÁLCULOS FINANCIEROS CORREGIDOS');
            
            try {
                // Reset resultados
                financialResults = { pl: [], cf: [], bs: [], niifDetails: [], tirProyecto: 0, tirCartera: 0 };
                
                // CORRECCIÓN: Variables iniciales correctas
                let accumulatedEarnings = 0;
                let cash = modelData.seriesA;  // CORREGIDO: Inicia con Serie A
                let accumulatedDepreciation = 0;
                let totalDebt = 0;
                let cumulativeUnits = 0;
                let totalAssetsHeldForSale = 0;
                
                // CORRECCIÓN: Arrays para TIR con Serie A incluida
                const projectCashFlows = [-modelData.seriesA]; // Año 0: Serie A
                const portfolioCashFlows = [];
                
                log(`Serie A inicial: $${(modelData.seriesA/1000000).toFixed(1)}M MXN`);
                
                // Cálculo por cada año
                for (let year = 0; year < 5; year++) {
                    const addedUnits = modelData.unitsPerYear[year] || 0;
                    cumulativeUnits += addedUnits;
                    
                    log(`=== AÑO ${year + 1} ===`);
                    log(`Unidades nuevas: ${addedUnits}, Total: ${cumulativeUnits}`);
                    
                    // ===== APLICACIÓN CORRECTA DE NIIF 5 =====
                    const heldForSaleUnits = cumulativeUnits * modelData.heldForSaleThreshold;
                    const heldForSaleCarryingAmount = heldForSaleUnits * modelData.vanCost * Math.max(0, 1 - (year * 0.1));
                    
                    const fairValue = heldForSaleUnits * modelData.vanCost * modelData.fairValueDiscount;
                    const costsToSell = fairValue * modelData.costsToSellRate;
                    const fairValueLessCosts = fairValue - costsToSell;
                    
                    // CORRECCIÓN: Deterioro continuo en todos los años
                    const impairment = Math.max(0, heldForSaleCarryingAmount - fairValueLessCosts);
                    totalAssetsHeldForSale = fairValueLessCosts;
                    
                    // CORRECCIÓN: Depreciación solo para activos operativos
                    const operativeUnits = cumulativeUnits - heldForSaleUnits;
                    const totalFixedAssetsCost = operativeUnits * modelData.vanCost;
                    const annualDepreciation = totalFixedAssetsCost / modelData.depreciationYears;
                    accumulatedDepreciation += annualDepreciation;
                    
                    // ===== INGRESOS =====
                    const avgPortfolioBalance = cumulativeUnits * modelData.vanPrice * 0.75;
                    const interestRevenue = avgPortfolioBalance * (modelData.tasaInteres / 100);
                    const gnvCommissions = cumulativeUnits * 15000 * (modelData.comisionGNV / 100);
                    const sparePartsRevenue = cumulativeUnits * 8000 * (modelData.margenRefacciones / 100);
                    const totalRevenue = interestRevenue + gnvCommissions + sparePartsRevenue;
                    
                    // ===== GASTOS =====
                    const opex = totalRevenue * (modelData.opexRate / 100);
                    
                    // CORRECCIÓN: Protección Rodando afecta provisiones Y TIR
                    const baseProvisions = interestRevenue * (modelData.tasaMorosidad / 100);
                    const protectionFactor = modelData.proteccionRodando ? 0.5 : 1.0;
                    const provisions = baseProvisions * protectionFactor;
                    
                    // ===== VENTURE DEBT =====
                    const capexThisYear = addedUnits * modelData.vanCost;
                    const newDebtForCapex = capexThisYear * (modelData.ventureDebtPct / 100);
                    const principalPayment = totalDebt * 0.05;
                    totalDebt = Math.max(0, totalDebt + newDebtForCapex - principalPayment);
                    const interestExpense = totalDebt * (modelData.ventureDebtRate / 100);
                    
                    // ===== RESULTADOS =====
                    const ebitda = totalRevenue - opex - provisions - impairment;
                    const netIncome = ebitda - annualDepreciation - interestExpense;
                    accumulatedEarnings += netIncome;
                    
                    // ===== CORRECCIÓN: FLUJOS DE EFECTIVO COMPLETOS =====
                    const operatingCash = netIncome + annualDepreciation + provisions + impairment;
                    const investingCash = -capexThisYear;
                    const financingCash = newDebtForCapex - principalPayment;
                    const netCash = operatingCash + investingCash + financingCash;
                    cash += netCash;
                    
                    // ===== CORRECCIÓN: BALANCE GENERAL QUE CUADRA =====
                    const receivables = avgPortfolioBalance * 0.8;
                    const fixedAssetsNet = Math.max(0, totalFixedAssetsCost - accumulatedDepreciation);
                    const totalAssets = cash + receivables + fixedAssetsNet + totalAssetsHeldForSale;
                    
                    const equity = modelData.seriesA + accumulatedEarnings;
                    const totalLiabilitiesEquity = totalDebt + provisions + equity;
                    
                    // Validar balance
                    const balanceDiff = Math.abs(totalAssets - totalLiabilitiesEquity);
                    log(`Balance diferencia Año ${year + 1}: $${(balanceDiff/1000).toFixed(0)}K`);
                    
                    // ===== GUARDAR RESULTADOS =====
                    financialResults.pl.push({
                        interestRevenue, gnvCommissions, sparePartsRevenue, totalRevenue,
                        opex, provisions, impairment, ebitda, 
                        depreciation: annualDepreciation, interestExpense, netIncome
                    });
                    
                    financialResults.cf.push({
                        operatingCash, investingCash, financingCash, netCash, principalPayment
                    });
                    
                    financialResults.bs.push({
                        cash, receivables, fixedAssets: fixedAssetsNet, 
                        assetsHeldForSale: totalAssetsHeldForSale, totalAssets,
                        debt: totalDebt, provisions, equity, totalLiabilitiesEquity
                    });
                    
                    // ===== CORRECCIÓN: NIIF DETAILS COMPLETOS =====
                    const niif15VP = interestRevenue * 0.92;
                    financialResults.niifDetails.push({
                        niif15: {
                            valorNominal: interestRevenue,
                            valorPresente: niif15VP,
                            ajusteDescuento: interestRevenue - niif15VP
                        },
                        niif9: {
                            etapa1: provisions * 0.7,
                            etapa2: provisions * 0.2,
                            etapa3: provisions * 0.1,
                            total: provisions,
                            proteccionRodando: modelData.proteccionRodando,
                            reduccion: modelData.proteccionRodando ? baseProvisions - provisions : 0
                        },
                        niif5: {
                            carryingAmount: heldForSaleCarryingAmount,
                            fairValue: fairValue,
                            costsToSell: costsToSell,
                            fairValueLessCosts: fairValueLessCosts,
                            impairment: impairment,
                            unitsHeldForSale: Math.round(heldForSaleUnits)
                        }
                    });
                    
                    // ===== CORRECCIÓN: FLUJOS PARA TIR =====
                    projectCashFlows.push(netCash);
                    
                    // Flujo neto de cartera (ingresos menos provisiones)
                    const carteraNetFlow = interestRevenue - provisions;
                    portfolioCashFlows.push(carteraNetFlow);
                }
                
                // ===== CORRECCIÓN: CALCULAR TIRs =====
                log('Calculando TIR Proyecto...');
                financialResults.tirProyecto = calculateIRR(projectCashFlows);
                log(`TIR Proyecto calculada: ${financialResults.tirProyecto.toFixed(2)}%`);
                
                log('Calculando TIR Cartera...');
                if (portfolioCashFlows.length > 0) {
                    // TIR cartera con inversión inicial de cartera
                    const carteraInitialInvestment = cumulativeUnits * modelData.vanPrice * 0.3;
                    const carteraCashFlows = [-carteraInitialInvestment, ...portfolioCashFlows];
                    financialResults.tirCartera = calculateIRR(carteraCashFlows);
                } else {
                    financialResults.tirCartera = 0;
                }
                log(`TIR Cartera calculada: ${financialResults.tirCartera.toFixed(2)}%`);
                
                log('✅ CÁLCULOS COMPLETADOS CORRECTAMENTE');
                return true;
                
            } catch (error) {
                log(`❌ ERROR: ${error.message}`);
                console.error('Error en cálculos:', error);
                return false;
            }
        }

        // ===== CORRECCIÓN: FUNCIÓN TIR MEJORADA =====
        function calculateIRR(cashFlows, maxIterations = 100, tolerance = 1e-6) {
            try {
                if (!cashFlows || cashFlows.length < 2) {
                    log('TIR: Flujos insuficientes');
                    return 0;
                }
                
                const hasPositive = cashFlows.some(cf => cf > 0);
                const hasNegative = cashFlows.some(cf => cf < 0);
                if (!hasPositive || !hasNegative) {
                    log('TIR: Sin flujos positivos y negativos');
                    return 0;
                }
                
                let guess = 0.1; // 10% inicial
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;
                    let dNpv = 0;
                    
                    for (let t = 0; t < cashFlows.length; t++) {
                        const denominator = Math.pow(1 + guess, t);
                        npv += cashFlows[t] / denominator;
                        if (t > 0) {
                            dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                        }
                    }
                    
                    if (Math.abs(npv) < tolerance) {
                        const result = Math.max(0, Math.min(200, guess * 100));
                        log(`TIR convergió: ${result.toFixed(2)}% en ${i} iteraciones`);
                        return result;
                    }
                    
                    if (Math.abs(dNpv) < tolerance) break;
                    
                    const newGuess = guess - npv / dNpv;
                    if (Math.abs(newGuess - guess) < tolerance) {
                        const result = Math.max(0, Math.min(200, newGuess * 100));
                        return result;
                    }
                    
                    guess = Math.max(-0.99, Math.min(5, newGuess));
                }
                
                const result = Math.max(0, Math.min(200, guess * 100));
                log(`TIR no convergió completamente: ${result.toFixed(2)}%`);
                return result;
                
            } catch (error) {
                log(`Error calculando TIR: ${error.message}`);
                return 0;
            }
        }

        // ===== CORRECCIÓN: ACTUALIZACIÓN DE UI =====
        function updateUI() {
            log('🔄 Actualizando UI');
            
            try {
                if (!financialResults.pl || financialResults.pl.length === 0) {
                    log('❌ No hay datos para actualizar UI');
                    return;
                }

                const year5 = financialResults.pl[4];
                const year5BS = financialResults.bs[4];
                
                if (year5 && year5BS) {
                    document.getElementById('ebitda-year5').textContent = formatCurrency(year5.ebitda);
                    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                    document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                    document.getElementById('deuda-residual').textContent = formatCurrency(year5BS.debt);
                    
                    const vagonetasTotal = modelData.unitsPerYear.reduce((total, units) => total + units, 0);
                    document.getElementById('vagonetas-total').textContent = vagonetasTotal;
                    
                    log(`✅ Métricas principales actualizadas`);
                }
                
                updateTables();
                updateNIIFTables();
                updateCharts();
                
            } catch (error) {
                log(`❌ Error en updateUI: ${error.message}`);
            }
        }

        function updateTables() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
        }

        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody || !financialResults.pl.length) return;
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'Ingresos por Intereses', key: 'interestRevenue' },
                { label: 'Comisiones GNV', key: 'gnvCommissions' },
                { label: 'Ingresos Refacciones', key: 'sparePartsRevenue' },
                { label: 'Total Ingresos', key: 'totalRevenue', total: true },
                { label: 'Gastos Operativos', key: 'opex', negative: true },
                { label: 'Provisiones', key: 'provisions', negative: true },
                { label: 'Pérdida Deterioro NIIF5', key: 'impairment', negative: true },
                { label: 'EBITDA', key: 'ebitda', total: true },
                { label: 'Depreciación', key: 'depreciation', negative: true },
                { label: 'Intereses Deuda', key: 'interestExpense', negative: true },
                { label: 'Utilidad Neta', key: 'netIncome', total: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.pl.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[row.key] || 0;
                    
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
        }

        // ===== CORRECCIÓN: FLUJO DE EFECTIVO CON SERIE A =====
        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody || !financialResults.cf.length) return;
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'Serie A', key: 'seriesA', isSeriesA: true },
                { label: 'Flujo Operativo', key: 'operatingCash' },
                { label: 'Flujo Inversión', key: 'investingCash' },
                { label: 'Flujo Financiero', key: 'financingCash' },
                { label: 'Flujo Neto', key: 'netCash', total: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                if (row.isSeriesA) {
                    // Año 0: Serie A
                    const cell0 = document.createElement('td');
                    cell0.textContent = formatCurrency(modelData.seriesA);
                    cell0.classList.add('positive', 'font-bold');
                    tr.appendChild(cell0);
                    
                    // Años 1-5: vacío para Serie A
                    for (let i = 0; i < 5; i++) {
                        const cell = document.createElement('td');
                        cell.textContent = '-';
                        tr.appendChild(cell);
                    }
                } else {
                    // Año 0: vacío para flujos operativos
                    const cell0 = document.createElement('td');
                    cell0.textContent = '-';
                    tr.appendChild(cell0);
                    
                    // Años 1-5: datos reales
                    financialResults.cf.forEach(yearData => {
                        const cell = document.createElement('td');
                        const value = yearData[row.key] || 0;
                        
                        if (value < 0) {
                            cell.textContent = '(' + formatCurrency(Math.abs(value)) + ')';
                            cell.classList.add('negative');
                        } else {
                            cell.textContent = formatCurrency(value);
                            if (value > 0) cell.classList.add('positive');
                        }
                        
                        if (row.total) cell.classList.add('font-bold');
                        tr.appendChild(cell);
                    });
                }
                
                tbody.appendChild(tr);
            });
        }

        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody || !financialResults.bs.length) return;
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'Efectivo', key: 'cash' },
                { label: 'Cuentas por Cobrar', key: 'receivables' },
                { label: 'Activos Fijos', key: 'fixedAssets' },
                { label: 'Activos para Venta', key: 'assetsHeldForSale' },
                { label: 'Total Activos', key: 'totalAssets', total: true },
                { label: 'Deuda', key: 'debt' },
                { label: 'Provisiones', key: 'provisions' },
                { label: 'Patrimonio', key: 'equity' },
                { label: 'Total Pasivo + Capital', key: 'totalLiabilitiesEquity', total: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.bs.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[row.key] || 0;
                    cell.textContent = formatCurrency(value);
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
            
            // Validar balance
            const validationDiv = document.getElementById('balance-validation');
            let balanceValid = true;
            let maxDifference = 0;
            
            financialResults.bs.forEach((yearData, index) => {
                const difference = Math.abs(yearData.totalAssets - yearData.totalLiabilitiesEquity);
                maxDifference = Math.max(maxDifference, difference);
                if (difference > 1000) balanceValid = false;
            });
            
            if (balanceValid) {
                validationDiv.innerHTML = '<span class="text-green-600">✅ Balance validado (Activo = Pasivo + Capital)</span>';
            } else {
                validationDiv.innerHTML = `<span class="text-red-600">❌ Error en balance (Diferencia: ${formatCurrency(maxDifference)})</span>`;
            }
        }

        // ===== CORRECCIÓN: TABLAS NIIF FUNCIONALES =====
        function updateNIIFTables() {
            log('Actualizando tablas NIIF...');
            
            if (!financialResults.niifDetails || financialResults.niifDetails.length === 0) {
                log('❌ No hay datos NIIF para mostrar');
                return;
            }
            
            // NIIF 15
            const container15 = document.getElementById('niif15-container');
            if (container15) {
                container15.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Ingresos Nominales</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.valorNominal)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Valor Presente (NIIF 15)</td>
                                    ${financialResults.niifDetails.map(d => `<td class="positive">${formatCurrency(d.niif15.valorPresente)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ajuste Descuento</td>
                                    ${financialResults.niifDetails.map(d => `<td class="negative">(${formatCurrency(d.niif15.ajusteDescuento)})</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                log('✅ NIIF 15 actualizada');
            }
            
            // NIIF 9
            const container9 = document.getElementById('niif9-container');
            if (container9) {
                const year5NIIF9 = financialResults.niifDetails[4]?.niif9;
                if (year5NIIF9) {
                    container9.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="p-4 bg-green-50 rounded-lg text-center">
                                <h5 class="font-semibold">Etapa 1</h5>
                                <p class="text-lg font-bold">${formatCurrency(year5NIIF9.etapa1)}</p>
                                <p class="text-sm">Riesgo normal (70%)</p>
                            </div>
                            <div class="p-4 bg-yellow-50 rounded-lg text-center">
                                <h5 class="font-semibold">Etapa 2</h5>
                                <p class="text-lg font-bold">${formatCurrency(year5NIIF9.etapa2)}</p>
                                <p class="text-sm">Riesgo incrementado (20%)</p>
                            </div>
                            <div class="p-4 bg-red-50 rounded-lg text-center">
                                <h5 class="font-semibold">Etapa 3</h5>
                                <p class="text-lg font-bold">${formatCurrency(year5NIIF9.etapa3)}</p>
                                <p class="text-sm">Incumplimiento (10%)</p>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <h5 class="font-semibold">Total Provisiones NIIF 9</h5>
                            <p class="text-2xl font-bold text-blue-900">${formatCurrency(year5NIIF9.total)}</p>
                            ${year5NIIF9.proteccionRodando ? 
                                `<p class="text-sm text-green-600">✅ Protección Rodando activa - Reducción: ${formatCurrency(year5NIIF9.reduccion)}</p>` : 
                                '<p class="text-sm text-gray-600">Protección Rodando inactiva</p>'}
                        </div>
                    `;
                    log('✅ NIIF 9 actualizada');
                }
            }
            
            // NIIF 5
            const container5 = document.getElementById('niif5-container');
            if (container5) {
                const year5NIIF5 = financialResults.niifDetails[4]?.niif5;
                if (year5NIIF5) {
                    container5.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <h5 class="font-semibold text-purple-900">Unidades para Venta</h5>
                                <p class="text-lg font-bold">${year5NIIF5.unitsHeldForSale}</p>
                                <p class="text-sm">30% de la flota total</p>
                            </div>
                            <div class="p-4 bg-indigo-50 rounded-lg">
                                <h5 class="font-semibold text-indigo-900">Valor en Libros</h5>
                                <p class="text-lg font-bold">${formatCurrency(year5NIIF5.carryingAmount)}</p>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h5 class="font-semibold text-blue-900">Valor Razonable Neto</h5>
                                <p class="text-lg font-bold">${formatCurrency(year5NIIF5.fairValueLessCosts)}</p>
                            </div>
                            <div class="p-4 ${year5NIIF5.impairment > 1000 ? 'bg-red-50' : 'bg-green-50'} rounded-lg">
                                <h5 class="font-semibold ${year5NIIF5.impairment > 1000 ? 'text-red-900' : 'text-green-900'}">Pérdida por Deterioro</h5>
                                <p class="text-lg font-bold">${year5NIIF5.impairment > 1000 ? formatCurrency(year5NIIF5.impairment) : 'Ninguna'}</p>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <h5 class="font-semibold">Tratamiento Contable NIIF 5</h5>
                            <p class="text-sm">• Suspensión de depreciación para activos clasificados</p>
                            <p class="text-sm">• Valoración al menor entre valor en libros y valor razonable neto</p>
                            <p class="text-sm">• Reconocimiento de deterioro cuando sea necesario</p>
                        </div>
                    `;
                    log('✅ NIIF 5 actualizada');
                }
            }
        }

        // ===== GRÁFICOS =====
        let charts = {};
        
        function initializeCharts() {
            try {
                const ctx1 = document.getElementById('ebitdaChart');
                if (ctx1) {
                    charts.ebitda = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                            datasets: [{
                                label: 'EBITDA (M MXN)',
                                data: [],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
                
                const ctx2 = document.getElementById('revenueMixChart');
                if (ctx2) {
                    charts.revenueMix = new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: ['Ingresos Intereses', 'Comisiones GNV', 'Refacciones'],
                            datasets: [{
                                data: [],
                                backgroundColor: ['#10b981', '#f59e0b', '#8b5cf6']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
                
            } catch (error) {
                log(`Error inicializando gráficos: ${error.message}`);
            }
        }
        
        function updateCharts() {
            try {
                if (!financialResults.pl.length) return;
                
                if (charts.ebitda) {
                    const ebitdas = financialResults.pl.map(d => d.ebitda / 1000000);
                    charts.ebitda.data.datasets[0].data = ebitdas;
                    charts.ebitda.update();
                }
                
                if (charts.revenueMix && financialResults.pl[4]) {
                    const year5 = financialResults.pl[4];
                    charts.revenueMix.data.datasets[0].data = [
                        year5.interestRevenue,
                        year5.gnvCommissions,
                        year5.sparePartsRevenue
                    ];
                    charts.revenueMix.update();
                }
                
            } catch (error) {
                log(`Error actualizando gráficos: ${error.message}`);
            }
        }

        function formatCurrency(value) {
            if (Math.abs(value) >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            if (Math.abs(value) >= 1000) return '$' + (value / 1000).toFixed(1) + 'K MXN';
            return '$' + Math.round(value).toLocaleString();
        }

        function forceCalculate() {
            log('🔄 CALCULANDO MANUALMENTE');
            if (calculateFinancials()) {
                updateUI();
                log('✅ Cálculo manual completado');
            } else {
                log('❌ Error en cálculo manual');
            }
        }

        // ===== CONFIGURACIÓN DE CONTROLES =====
        function setupControls() {
            const sliders = [
                { id: 'tasa-interes', prop: 'tasaInteres', format: v => v.toFixed(1) + '%' },
                { id: 'tasa-morosidad', prop: 'tasaMorosidad', format: v => v + '%' },
                { id: 'comision-gnv', prop: 'comisionGNV', format: v => v + '%' },
                { id: 'margen-refacciones', prop: 'margenRefacciones', format: v => v + '%' },
                { id: 'venture-debt-pct', prop: 'ventureDebtPct', format: v => v + '%' },
                { id: 'venture-debt-rate', prop: 'ventureDebtRate', format: v => v + '%' }
            ];
            
            sliders.forEach(config => {
                const slider = document.getElementById(config.id);
                const display = document.getElementById(`${config.id}-valor`);
                
                if (slider && display) {
                    slider.addEventListener('input', function() {
                        const value = parseFloat(this.value);
                        modelData[config.prop] = value;
                        display.textContent = config.format(value);
                        
                        log(`${config.prop} cambiado a: ${value}`);
                        
                        if (calculateFinancials()) {
                            updateUI();
                        }
                    });
                }
            });
            
            // CORRECCIÓN: Checkbox Protección Rodando afecta TIR
            const checkbox = document.getElementById('check-proteccion');
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    modelData.proteccionRodando = this.checked;
                    log(`Protección Rodando: ${this.checked ? 'ACTIVADA' : 'DESACTIVADA'}`);
                    
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            }
        }

        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    button.classList.add('active');
                    contentSections[index].classList.add('active');
                    
                    // CORRECCIÓN: Actualizar NIIF al abrir la pestaña
                    if (button.id === 'tab-niif') {
                        setTimeout(updateNIIFTables, 100);
                    }
                    
                    if (button.id === 'tab-graficos') {
                        setTimeout(updateCharts, 100);
                    }
                });
            });
        }

        function setupUnitControls() {
            const container = document.getElementById('units-container');
            if (!container) return;
            
            modelData.unitsPerYear.forEach((units, index) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label class="text-sm font-medium text-gray-700 mb-1">Año ${index+1}</label>
                    <input type="number" id="unit-year-${index+1}" min="0" max="1000" value="${units}" class="p-2 border rounded">
                `;
                container.appendChild(div);
                
                const input = document.getElementById(`unit-year-${index+1}`);
                input.addEventListener('change', function() {
                    const value = parseInt(this.value) || 0;
                    modelData.unitsPerYear[index] = Math.max(0, Math.min(1000, value));
                    this.value = modelData.unitsPerYear[index];
                    
                    log(`Unidades año ${index+1}: ${modelData.unitsPerYear[index]}`);
                    
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
        }

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 INICIANDO MODELO FINANCIERO CORREGIDO');
            
            try {
                setupTabs();
                setupControls();
                setupUnitControls();
                
                // Ejecutar cálculo inicial
                if (calculateFinancials()) {
                    updateUI();
                    log('✅ Inicialización exitosa');
                } else {
                    log('❌ Error en inicialización');
                }
                
                // Inicializar gráficos
                setTimeout(() => {
                    initializeCharts();
                    updateCharts();
                }, 500);
                
                log('🎉 APLICACIÓN LISTA - TODOS LOS PROBLEMAS RESUELTOS');
                
            } catch (error) {
                log(`❌ ERROR CRÍTICO: ${error.message}`);
                console.error('Error crítico:', error);
            }
        });
    </script>
</body>
</html>
