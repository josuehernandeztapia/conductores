<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo - Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8f9fa; 
        }
        .tab-button { 
            transition: all 0.3s ease; 
            cursor: pointer;
        }
        .tab-button.active { 
            border-color: #2563eb; 
            color: #2563eb; 
            background-color: #eff6ff; 
        }
        .tab-button:not(.active):hover { 
            background-color: #f3f4f6; 
        }
        .content-section { 
            display: none; 
        }
        .content-section.active { 
            display: block; 
        }
        .card { 
            background-color: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem;
        }
        .input-slider { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 100%; 
            height: 8px; 
            background: #e5e7eb; 
            border-radius: 9999px; 
            outline: none; 
            transition: opacity .2s; 
        }
        .input-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 20px; 
            height: 20px; 
            background: #2563eb; 
            border-radius: 9999px; 
            cursor: pointer; 
        }
        .input-slider::-moz-range-thumb { 
            width: 20px; 
            height: 20px; 
            background: #2563eb; 
            border-radius: 9999px; 
            cursor: pointer; 
            border: none;
        }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            margin-left: auto; 
            margin-right: auto; 
            height: 350px; 
            max-height: 50vh; 
        }
        .financial-table {
            width: 100%;
            border-collapse: collapse;
        }
        .financial-table th,
        .financial-table td {
            padding: 0.75rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        .financial-table th {
            background-color: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .financial-table td:first-child,
        .financial-table th:first-child {
            text-align: left;
        }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid #2563eb;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero Interactivo</h1>
            <p class="text-lg text-gray-600">Rodando a Gas: Resiliencia como Servicio</p>
            <p class="text-sm text-gray-500 mt-2">Cumplimiento NIIF 15 & NIIF 9 | Proyecciones a 5 a√±os</p>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA A√±o 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$15.2M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyectada</div>
                <div class="text-2xl font-bold" id="tir-proyectada">22.8%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Unidades Financiadas (A√±o 5)</div>
                <div class="text-2xl font-bold" id="unidades-year5">500</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Patrimonio Neto</div>
                <div class="text-2xl font-bold" id="patrimonio-neto">$78.3M MXN</div>
            </div>
        </div>

        <main>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üöÄ Panel de Control</button>
                    <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìä Estados Financieros</button>
                    <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìà An√°lisis Gr√°fico</button>
                    <button id="tab-resumen" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìñ Resumen Estrat√©gico</button>
                </nav>
            </div>

            <!-- Panel de Control -->
            <div id="content-control" class="content-section active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card lg:col-span-3">
                           <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold text-gray-800">Par√°metros Globales y Escenarios</h3>
                                <div class="flex items-center space-x-4">
                                   <select id="select-escenario" class="block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                        <option value="base">Escenario Base</option>
                                        <option value="optimista">Escenario Optimista</option>
                                        <option value="conservador">Escenario Conservador</option>
                                    </select>
                                    <select id="select-vista" class="block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                        <option value="anual">Vista Anual</option>
                                        <option value="mensual">Vista Mensual</option>
                                    </select>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Ajuste las variables clave para simular diferentes condiciones de mercado. Los cambios se reflejar√°n en todos los estados financieros y gr√°ficos en tiempo real.</p>
                            <div id="scenario-details" class="text-sm text-gray-600 mt-2 p-2 bg-gray-50 rounded-md">
                                <strong>Escenario Base:</strong> Tasa de morosidad 8%, Margen por vagoneta $88,000 MXN, TIR objetivo ‚â•22.8%
                            </div>
                    </div>

                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Cr√©dito y Riesgo</h4>
                        <p class="text-xs text-gray-500 mb-4">Ajuste las condiciones del financiamiento y las provisiones por riesgo (NIIF 9).</p>
                        <div class="space-y-4">
                            <div>
                                <label for="tasa-interes" class="flex justify-between text-sm font-medium text-gray-700">Tasa de Inter√©s Anual <span id="tasa-interes-valor" class="font-bold text-indigo-600">25.5%</span></label>
                                <input type="range" id="tasa-interes" min="23.9" max="26.9" step="0.1" value="25.5" class="input-slider mt-1">
                            </div>
                             <div>
                                <label for="tasa-morosidad" class="flex justify-between text-sm font-medium text-gray-700">Tasa de Morosidad <span id="tasa-morosidad-valor" class="font-bold text-indigo-600">8%</span></label>
                                <input type="range" id="tasa-morosidad" min="4" max="12" step="0.5" value="8" class="input-slider mt-1">
                            </div>
                             <div class="flex items-center">
                                <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Incluir "Protecci√≥n Rodando"</label>
                                <span class="ml-2 text-xs text-green-600">(Reduce morosidad hasta 50%)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Operaciones y M√°rgenes</h4>
                        <p class="text-xs text-gray-500 mb-4">Configure los m√°rgenes de ganancia para las l√≠neas de ingreso.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="margen-vagoneta" class="flex justify-between text-sm font-medium text-gray-700">Margen por Vagoneta <span id="margen-vagoneta-valor" class="font-bold text-indigo-600">$88,000</span></label>
                                <input type="range" id="margen-vagoneta" min="50000" max="120000" step="1000" value="88000" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="comision-gnv" class="flex justify-between text-sm font-medium text-gray-700">Comisi√≥n GNV <span id="comision-gnv-valor" class="font-bold text-indigo-600">8%</span></label>
                                <input type="range" id="comision-gnv" min="7" max="10" step="0.5" value="8" class="input-slider mt-1">
                            </div>
                             <div>
                                <label for="margen-refacciones" class="flex justify-between text-sm font-medium text-gray-700">Margen Refacciones <span id="margen-refacciones-valor" class="font-bold text-indigo-600">25%</span></label>
                                <input type="range" id="margen-refacciones" min="25" max="35" step="1" value="25" class="input-slider mt-1">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Estructura de Capital (Post-Serie A)</h4>
                        <p class="text-xs text-gray-500 mb-4">Simule el impacto de la financiaci√≥n con venture debt vs. equity.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="venture-debt-pct" class="flex justify-between text-sm font-medium text-gray-700">% Venture Debt <span id="venture-debt-pct-valor" class="font-bold text-indigo-600">0%</span></label>
                                <input type="range" id="venture-debt-pct" min="0" max="50" step="5" value="0" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="venture-debt-rate" class="flex justify-between text-sm font-medium text-gray-700">Tasa Venture Debt <span id="venture-debt-rate-valor" class="font-bold text-indigo-600">12%</span></label>
                                <select id="venture-debt-rate" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                    <option value="12">12%</option>
                                    <option value="14">14%</option>
                                    <option value="18">18%</option>
                                </select>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-md">
                                <p class="text-xs text-blue-700"><strong>Estrategia RAG:</strong> Usar venture debt para flota, preservar equity para tecnolog√≠a e IA.</p>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <p class="text-lg font-bold text-gray-800">TIR de la Cartera: <span id="irr-value" class="text-indigo-600">22.8%</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estados Financieros -->
            <div id="content-financieros" class="content-section">
                <div class="space-y-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>A√±o 1</th>
                                        <th>A√±o 2</th>
                                        <th>A√±o 3</th>
                                        <th>A√±o 4</th>
                                        <th>A√±o 5</th>
                                    </tr>
                                </thead>
                                <tbody id="pl-table-body">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>A√±o 1</th>
                                        <th>A√±o 2</th>
                                        <th>A√±o 3</th>
                                        <th>A√±o 4</th>
                                        <th>A√±o 5</th>
                                    </tr>
                                </thead>
                                <tbody id="cf-table-body">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>A√±o 1</th>
                                        <th>A√±o 2</th>
                                        <th>A√±o 3</th>
                                        <th>A√±o 4</th>
                                        <th>A√±o 5</th>
                                    </tr>
                                </thead>
                                <tbody id="bs-table-body">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- An√°lisis Gr√°fico -->
            <div id="content-graficos" class="content-section">
                <div class="space-y-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Evoluci√≥n de Ingresos y EBITDA</h3>
                        <div class="chart-container">
                            <canvas id="revenue-ebitda-chart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Composici√≥n de L√≠neas de Ingreso</h3>
                        <div class="chart-container">
                            <canvas id="revenue-breakdown-chart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">An√°lisis de Sensibilidad: Impacto de Morosidad en EBITDA</h3>
                        <div class="chart-container">
                            <canvas id="sensitivity-chart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Estructura de Capital vs. TIR</h3>
                        <div class="chart-container">
                            <canvas id="capital-structure-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen Estrat√©gico -->
            <div id="content-resumen" class="content-section">
                <div class="space-y-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">üéØ Propuesta de Valor: "Resiliencia como Servicio"</h3>
                        <div class="space-y-4">
                            <p class="text-gray-700">Rodando a Gas redefine el financiamiento de activos como un <strong>"Ecosistema de Resiliencia Operativa"</strong>, dise√±ado para asegurar la continuidad y rentabilidad del negocio del operador a largo plazo.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-blue-900">üß† HASE</h4>
                                    <p class="text-sm text-blue-700">Hyper-Adaptive Scoring Engine: Scoring din√°mico y predictivo con datos propietarios</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-900">‚ù§Ô∏è PIA</h4>
                                    <p class="text-sm text-green-700">Proactive Intervention Agent: Comunicaci√≥n emp√°tica y preventiva a escala</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-yellow-900">üõ°Ô∏è PMA</h4>
                                    <p class="text-sm text-yellow-700">Predictive Maintenance Advisor: Mantenimiento predictivo y nuevos ingresos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">üöÄ Oportunidad de Mercado</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                                <div class="text-2xl font-bold text-blue-900">$10.9B MXN</div>
                                <div class="text-sm text-blue-700">TAM: Mercado Total Direccionable</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                                <div class="text-2xl font-bold text-green-900">$4.3B MXN</div>
                                <div class="text-sm text-green-700">SAM: Mercado Servible Direccionable</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg">
                                <div class="text-2xl font-bold text-purple-900">$1.1B MXN</div>
                                <div class="text-sm text-purple-700">SOM: Mercado Obtenible (3-5 a√±os)</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">üõ°Ô∏è "Protecci√≥n Rodando": El Game Changer</h3>
                        <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg">
                            <p class="text-gray-700 mb-4">Sistema de seguro proactivo gestionado por IA que redefine la relaci√≥n prestamista-prestatario, transformando la volatilidad del mercado en un activo gestionado.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="font-semibold text-green-900 mb-2">Beneficios Cuantitativos:</h4>
                                    <ul class="text-sm text-green-700 space-y-1">
                                        <li>‚Ä¢ Reducci√≥n de morosidad hasta 50%</li>
                                        <li>‚Ä¢ TIR mantenida ‚â•22.8%</li>
                                        <li>‚Ä¢ Ahorro $5,000 MXN por evento evitado</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-900 mb-2">Validaci√≥n Multicapa:</h4>
                                    <ul class="text-sm text-blue-700 space-y-1">
                                        <li>‚Ä¢ An√°lisis de Opciones Reales (ROA)</li>
                                        <li>‚Ä¢ Modelos Merton y Vasicek</li>
                                        <li>‚Ä¢ Algoritmo de Equilibrio TIR</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">üè∞ Los Cuatro Fosos Competitivos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border-l-4 border-blue-500 pl-4">
                                <h4 class="font-semibold text-blue-900">üóÉÔ∏è Foso de Datos</h4>
                                <p class="text-sm text-gray-600">Datos operativos (GNV, GPS), "carta aval de ruta", telem√°tica PMA, etiquetado de intervenciones</p>
                            </div>
                            <div class="border-l-4 border-green-500 pl-4">
                                <h4 class="font-semibold text-green-900">ü§ñ Foso Tecnol√≥gico</h4>
                                <p class="text-sm text-gray-600">Ecosistema sin√©rgico HASE-PIA-PMA con mejora continua auto-reforzada</p>
                            </div>
                            <div class="border-l-4 border-yellow-500 pl-4">
                                <h4 class="font-semibold text-yellow-900">‚öôÔ∏è Foso Operacional</h4>
                                <p class="text-sm text-gray-600">Proceso de 6 pasos automatizado, eficiencia ultra-escalable, PMA reduce costos de recuperaci√≥n</p>
                            </div>
                            <div class="border-l-4 border-purple-500 pl-4">
                                <h4 class="font-semibold text-purple-900">üåê Foso de Red</h4>
                                <p class="text-sm text-gray-600">Flywheel de datos: m√°s clientes ‚Üí m√°s datos ‚Üí IA m√°s inteligente ‚Üí mejor producto ‚Üí m√°s clientes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global variables
        let charts = {};
        // Model parameters, updated directly from UI controls
        let modelData = {
            tasaInteres: 25.5, // Tasa de inter√©s anual de los pr√©stamos a clientes
            tasaMorosidad: 8, // Tasa de morosidad anual
            proteccionRodando: true, // Si "Protecci√≥n Rodando" est√° activa
            margenVagoneta: 88000, // Margen por vagoneta vendida
            comisionGNV: 8, // % de comisi√≥n GNV
            margenRefacciones: 25, // % de margen de refacciones
            ventureDebtPct: 0, // % de unidades financiadas con Venture Debt (post-equity)
            ventureDebtRate: 12 // Tasa de inter√©s del Venture Debt
        };

        // Financial configuration (fixed values from the business plan document)
        const financialConfig = {
            unitsPerYear: [35, 70, 100, 150, 200], // New units financed per year for Years 1-5
            unitCost: 641000, // Cost of acquiring a unit for RAG
            unitPrice: 729000, // Price at which unit is sold/financed to customer
            gnvConsumptionPerUnit: 875 * 12, // Annual liters of GNV consumption per unit
            opexRate: 0.15, // Operating expenses as % of total revenue
            seriesA: 45000000, // 45 MDP initial Series A capital (100% equity)
            seriesA_tech_team_pct: 0.40, // 40% of Series A for Tech & Team
            seriesA_unit_funding_pct: 0.60, // 60% of Series A for initial unit funding
            avgLoanTerm: 5, // Average customer loan term in years (for amortization and depreciation)
            taxRate: 0.30, // Income tax rate
            LGD: 0.45 // Loss Given Default for NIIF 9 provisions
        };

        // State for financial statements (results of calculation)
        let financialState = {
            incomeStatement: [],
            cashFlow: [],
            balanceSheet: [],
            debtAmortization: [],
            cumulativeUnits: [], // Cumulative units financed over time
            cumulativeVentureDebtRaised: 0, // Total venture debt raised across all years
            outstandingVentureDebtPrincipal: 0 // Current outstanding balance of venture debt
        };


        // --- Core Model Calculation Functions ---

        /**
         * Calculates the financial model (Income Statement, Cash Flow, Balance Sheet, Debt Amortization).
         * This function implements NIIF 15 and NIIF 9 principles.
         */
        function calculateModel() {
            console.log('--- Starting Model Calculation ---');
            // Reset financial state for recalculation
            financialState = {
                incomeStatement: [],
                cashFlow: [],
                balanceSheet: [],
                debtAmortization: [],
                cumulativeUnits: [],
                cumulativeVentureDebtRaised: 0,
                outstandingVentureDebtPrincipal: 0
            };
            
            let currentCashBalance = financialConfig.seriesA; // Start with total Series A as cash
            let currentRetainedEarnings = 0;
            
            let cumulativeAssetCostBasis = 0; // Total original cost of units (for PP&E)
            let accumulatedDepreciation = 0; // Total depreciation booked
            
            let outstandingCustomerLoansPrincipal = 0; // Gross principal balance of customer loans
            let accumulatedProvisionForCreditLosses = 0; // Allowance for credit losses (contra-asset)

            // Initial allocation of Series A equity
            const techTeamExpenseInitial = financialConfig.seriesA * financialConfig.seriesA_tech_team_pct; 
            let remainingEquityForUnitFunding = financialConfig.seriesA * financialConfig.seriesA_unit_funding_pct; 

            // Apply initial tech and team expenses (cash outflow) in Year 1 (only once)
            currentCashBalance -= techTeamExpenseInitial; 
            console.log(`Initial Cash (after Tech/Team initial spend): ${formatCurrency(currentCashBalance)}`);


            for (let i = 0; i < 5; i++) { // Loop for 5 years
                const year = i + 1;
                console.log(`\n--- Year ${year} Calculations ---`);

                const newUnitsFinancedThisYear = financialConfig.unitsPerYear[i]; // Units for current year
                // Cumulative units in portfolio
                const prevCumulativeUnits = (i > 0) ? financialState.cumulativeUnits[i-1] : 0;
                const currentCumulativeUnits = prevCumulativeUnits + newUnitsFinancedThisYear;
                financialState.cumulativeUnits.push(currentCumulativeUnits);
                
                const costOfNewUnitsAcquired = newUnitsFinancedThisYear * financialConfig.unitCost;
                cumulativeAssetCostBasis += costOfNewUnitsAcquired; 
                console.log(`Units Financed This Year: ${newUnitsFinancedThisYear}, Cumulative Units: ${currentCumulativeUnits}`);
                console.log(`Cost of New Units Acquired: ${formatCurrency(costOfNewUnitsAcquired)}, Cumulative Asset Basis (Gross PP&E): ${formatCurrency(cumulativeAssetCostBasis)}`);

                // --- FUNDING LOGIC FOR NEW UNITS ---
                let equityUsedForUnitsThisYear = 0;
                let debtIncurredThisYear = 0; 
                const fundingNeededForUnits = costOfNewUnitsAcquired;

                if (remainingEquityForUnitFunding > 0) {
                    equityUsedForUnitsThisYear = Math.min(remainingEquityForUnitFunding, fundingNeededForUnits);
                    remainingEquityForUnitFunding -= equityUsedForUnitsThisYear;
                    const unfundedByEquity = fundingNeededForUnits - equityUsedForUnitsThisYear;
                    debtIncurredThisYear = unfundedByEquity * (modelData.ventureDebtPct / 100);
                    // The rest, if any, is covered by implicit operational cash or retained earnings
                    equityUsedForUnitsThisYear += (unfundedByEquity * (1 - (modelData.ventureDebtPct / 100))); 
                } else {
                    // If initial equity is exhausted, use the configured debtPercentage for new units
                    debtIncurredThisYear = fundingNeededForUnits * (modelData.ventureDebtPct / 100);
                    equityUsedForUnitsThisYear = fundingNeededForUnits * (1 - (modelData.ventureDebtPct / 100));
                }
                
                debtIncurredThisYear = Math.max(0, debtIncurredThisYear); 
                equityUsedForUnitsThisYear = Math.max(0, equityUsedForUnitsThisYear); 

                financialState.cumulativeVentureDebtRaised += debtIncurredThisYear; // Total debt drawn over all years
                
                let outstandingVentureDebtPrincipalAtBoY = financialState.outstandingVentureDebtPrincipal; 
                financialState.outstandingVentureDebtPrincipal += debtIncurredThisYear; // Add new debt tranche

                console.log(`Debt Incurred This Year: ${formatCurrency(debtIncurredThisYear)}, Equity Used for Units: ${formatCurrency(equityUsedForUnitsThisYear)}`);
                console.log(`Cumulative Debt Raised: ${formatCurrency(financialState.cumulativeVentureDebtRaised)}, Outstanding Debt BoY (before payments): ${formatCurrency(financialState.outstandingVentureDebtPrincipal)}`);

                // --- CUSTOMER LOANS (Pr√©stamos por Cobrar) - NIIF 9 & NIIF 15 ---
                const loansExtendedThisYear = newUnitsFinancedThisYear * financialConfig.unitPrice; 
                let customerLoansPrincipalBoY = outstandingCustomerLoansPrincipal; 

                outstandingCustomerLoansPrincipal += loansExtendedThisYear; 

                // Amortization of customer loans (simplified: linear amortization of the total outstanding principal)
                const customerPrincipalRepaymentThisYear = outstandingCustomerLoansPrincipal / financialConfig.avgLoanTerm; 
                outstandingCustomerLoansPrincipal = Math.max(0, outstandingCustomerLoansPrincipal - customerPrincipalRepaymentThisYear);
                
                console.log(`Loans Extended This Year: ${formatCurrency(loansExtendedThisYear)}, Customer Principal Repaid: ${formatCurrency(customerPrincipalRepaymentThisYear)}`);
                console.log(`Outstanding Customer Loans Principal EoY (Gross): ${formatCurrency(outstandingCustomerLoansPrincipal)}`);

                // NIIF 15: Interest Revenue on Customer Loans (based on average outstanding balance)
                const avgCustomerLoansDuringYear = (customerLoansPrincipalBoY + outstandingCustomerLoansPrincipal) / 2;
                const interestRevenue = avgCustomerLoansDuringYear * (modelData.tasaInteres / 100); 
                
                // Other Service Revenues:
                const gnvRevenue = currentCumulativeUnits * financialConfig.gnvConsumption * (modelData.comisionGNV / 100);
                const sparePartsRevenue = currentCumulativeUnits * financialConfig.unitCost * (modelData.margenRefacciones / 100); 
                // Marketplace revenue based on total sales value of new units
                const marketplaceRevenue = (newUnitsFinancedThisYear * financialConfig.unitPrice) * 0.01; // Assuming 1% for now, add to modelData if adjustable

                // Total Revenue: (Gross Profit from Sales) + Service Revenues + Interest Revenue
                const totalRevenue = (newUnitsFinancedThisYear * modelData.margenVagoneta) 
                                    + interestRevenue + gnvRevenue + sparePartsRevenue + marketplaceRevenue;
                console.log(`Total Revenue: ${formatCurrency(totalRevenue)} (Gross Profit from Sales: ${formatCurrency(newUnitsFinancedThisYear * modelData.margenVagoneta)}, Interest: ${formatCurrency(interestRevenue)})`);

                // --- EXPENSES ---
                const costOfGoodsSold = newUnitsFinancedThisYear * financialConfig.unitCost; 
                const opex = totalRevenue * financialConfig.opexRate;
                
                // Depreciation on PP&E (units)
                const annualDepreciation = costOfNewUnitsAcquired / financialConfig.avgLoanTerm; 
                accumulatedDepreciation += annualDepreciation;
                console.log(`Annual Depreciation: ${formatCurrency(annualDepreciation)}, Accumulated Depreciation: ${formatCurrency(accumulatedDepreciation)}`);

                // NIIF 9: Provision for Expected Credit Losses (Expense)
                // Reflects expected loss on new loans extended, adjusted by LGD and default rate
                const annualProvisionExpense = (newUnitsFinancedThisYear * financialConfig.unitPrice) * (modelData.tasaMorosidad / 100) * financialConfig.LGD; 
                accumulatedProvisionForCreditLosses += annualProvisionExpense; 
                console.log(`Annual Provision Expense (NIIF 9): ${formatCurrency(annualProvisionExpense)}, Accumulated Provision: ${formatCurrency(accumulatedProvisionForCreditLosses)}`);

                // --- VENTURE DEBT SERVICE ---
                let annualVentureDebtInterest = 0;
                let annualVentureDebtPrincipalPayment = 0;

                // Calculate debt service if there is outstanding debt and a term defined
                if (financialState.outstandingVentureDebtPrincipal > 0 && financialConfig.debtTerm > 0) {
                    annualVentureDebtInterest = financialState.outstandingVentureDebtPrincipal * (modelData.ventureDebtRate / 100);
                    // Amortize the total outstanding principal linearly over the specified debt term
                    annualVentureDebtPrincipalPayment = financialState.outstandingVentureDebtPrincipal / financialConfig.debtTerm; 
                    annualVentureDebtPrincipalPayment = Math.min(annualVentureDebtPrincipalPayment, financialState.outstandingVentureDebtPrincipal); 
                }
                financialState.outstandingVentureDebtPrincipal -= annualVentureDebtPrincipalPayment;
                financialState.outstandingVentureDebtPrincipal = Math.max(0, financialState.outstandingVentureDebtPrincipal); 
                console.log(`Annual Debt Interest: ${formatCurrency(annualVentureDebtInterest)}, Annual Debt Principal Payment: ${formatCurrency(annualVentureDebtPrincipalPayment)}`);
                console.log(`Outstanding Debt EoY (Global): ${formatCurrency(financialState.outstandingVentureDebtPrincipal)}`);

                // --- INCOME STATEMENT Calculation ---
                const ebitda = totalRevenue 
                                - opex 
                                - annualProvisionExpense 
                                - annualDepreciation; 
                
                const netIncomeBeforeTax = ebitda - annualVentureDebtInterest;
                const incomeTax = netIncomeBeforeTax > 0 ? netIncomeBeforeTax * financialConfig.taxRate : 0;
                const netIncome = netIncomeBeforeTax - incomeTax;
                currentRetainedEarnings += netIncome; 
                console.log(`EBITDA: ${formatCurrency(ebitda)}, Net Income: ${formatCurrency(netIncome)}`);

                // Store Income Statement data for the year
                financialState.incomeStatement.push({
                    year,
                    principalRevenue: newUnitsFinancedThisYear * financialConfig.unitPrice, 
                    interestRevenue,
                    gnvRevenue,
                    sparePartsRevenue,
                    marketplaceRevenue,
                    totalRevenue,
                    costOfGoodsSold,
                    opex,
                    provisionForLosses: annualProvisionExpense, 
                    annualDepreciation,
                    ebitda,
                    currentAnnualDebtInterest: annualVentureDebtInterest,
                    incomeTax,
                    netIncome,
                    cumulativeUnits: currentCumulativeUnits 
                });

                // --- CASH FLOW STATEMENT (Indirect Method) ---
                const operatingCashFlow = netIncome 
                                        + annualProvisionExpense 
                                        + annualDepreciation; 
                
                const investingCashFlow = -(equityUsedForUnitsThisYear) + customerPrincipalRepaymentThisYear;
                console.log(`Operating CF: ${formatCurrency(operatingCashFlow)}, Investing CF: ${formatCurrency(investingCashFlow)}`);

                const financingCashFlow = (year === 1 ? (financialConfig.seriesA - techTeamExpenseInitial) : 0) 
                                        + debtIncurredThisYear 
                                        - annualVentureDebtPrincipalPayment; 
                console.log(`Financing CF: ${formatCurrency(financingCashFlow)}`);

                const netCashFlow = operatingCashFlow + investingCashFlow + financingCashFlow;
                currentCashBalance += netCashFlow;
                console.log(`Net Cash Flow: ${formatCurrency(netCashFlow)}, Ending Cash Balance: ${formatCurrency(currentCashBalance)}`);

                // Store Cash Flow data for the year
                financialState.cashFlow.push({
                    year, operatingCashFlow, investingCashFlow, financingCashFlow, netCashFlow, endingCashBalance: currentCashBalance
                });
                
                // --- BALANCE SHEET ---
                const cashAndEquivalents = currentCashBalance;
                const loansReceivableNet = outstandingCustomerLoansPrincipal - accumulatedProvisionForCreditLosses; 
                const propertyPlantEquipmentNet = cumulativeAssetCostBasis - accumulatedDepreciation; 
                const totalAssets = cashAndEquivalents + loansReceivableNet + propertyPlantEquipmentNet;

                const outstandingDebtBS = financialState.outstandingVentureDebtPrincipal; 
                const otherLiabilities = totalRevenue * 0.05; 
                const totalLiabilities = outstandingDebtBS + otherLiabilities;

                const shareCapital = financialConfig.seriesA; 
                const retainedEarnings = currentRetainedEarnings;
                const totalEquity = shareCapital + retainedEarnings;
                const totalLiabilitiesAndEquity = totalLiabilities + totalEquity;

                // Store Balance Sheet data for the year
                financialState.balanceSheet.push({
                    year, cashAndEquivalents, loansReceivable: loansReceivableNet, propertyPlantEquipmentNet, totalAssets,
                    outstandingDebt: outstandingDebtBS, otherLiabilities, totalLiabilities, shareCapital, retainedEarnings, totalEquity, totalLiabilitiesAndEquity
                });
                console.log(`Balance Sheet Year ${year}: Assets: ${formatCurrency(totalAssets)}, L+E: ${formatCurrency(totalLiabilitiesAndEquity)}`);

                // Store Debt Amortization Summary (for the table)
                annualDebtServiceSummary.push({
                    year,
                    beginningBalance: outstandingVentureDebtPrincipalAtBoY + debtIncurredThisYear, 
                    principalPaid: annualVentureDebtPrincipalPayment,
                    interestPaid: annualVentureDebtInterest,
                    totalPayment: annualVentureDebtPrincipalPayment + annualVentureDebtInterest,
                    endingBalance: financialState.outstandingVentureDebtPrincipal 
                });
            }
            financialState.debtAmortization = annualDebtServiceSummary; 

            // Calculate IRR using the Net Cash Flows (initial Series A is the first outflow)
            const cashFlowsForIRR = [
                -financialConfig.seriesA, 
                ...financialState.cashFlow.map(cf => cf.netCashFlow)
            ];
            const irr = calculateIRR(cashFlowsForIRR); 

            // Update Summary Metrics on UI
            document.getElementById('ebitda-year5').textContent = formatCurrency(financialState.incomeStatement[4].ebitda);
            document.getElementById('tir-proyectada').textContent = `${(isNaN(irr) ? 0 : irr * 100).toFixed(1)}%`;
            document.getElementById('unidades-year5').textContent = financialState.incomeStatement[4].cumulativeUnits.toString();
            document.getElementById('patrimonio-neto').textContent = formatCurrency(financialState.balanceSheet[4].totalEquity);
            document.getElementById('irr-value').textContent = `${(isNaN(irr) ? 0 : irr * 100).toFixed(1)}%`;


            validateAccounting(); // Final validation
            console.log('--- Model Calculation Complete ---');
        }

        // --- UI Update Functions ---

        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all tabs and content sections
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));

                    // Add active class to clicked tab and corresponding content
                    button.classList.add('active');
                    const targetContentId = button.id.replace('tab-', 'content-');
                    document.getElementById(targetContentId).classList.add('active');

                    // Update charts if switching to graphics tab
                    if (button.id === 'tab-graficos') {
                        // Small delay to ensure canvas is rendered
                        setTimeout(updateCharts, 100); 
                    }
                });
            });
        }

        function setupControls() {
            // Mapping for controls: [element ID, modelData property, display element ID (optional), display format function]
            const controlMappings = [
                // Unit distribution sliders
                ['units-year1', null, 'units-year1-value', (val) => val],
                ['units-year2', null, 'units-year2-value', (val) => val],
                ['units-year3', null, 'units-year3-value', (val) => val],
                ['units-year4', null, 'units-year4-value', (val) => val],
                ['units-year5', null, 'units-year5-value', (val) => val],

                // Main Parameters / Credit & Risk
                ['tasa-interes', 'tasaInteres', 'tasa-interes-valor', (val) => `${parseFloat(val).toFixed(1)}%`],
                ['tasa-morosidad', 'tasaMorosidad', 'tasa-morosidad-valor', (val) => `${parseFloat(val).toFixed(0)}%`],
                ['margen-vagoneta', 'margenVagoneta', 'margen-vagoneta-valor', (val) => `$${parseFloat(val).toLocaleString()}`],
                
                // Other Parameters / Operaciones y M√°rgenes
                ['comision-gnv', 'comisionGNV', 'comision-gnv-valor', (val) => `${parseFloat(val).toFixed(1)}%`],
                ['margen-refacciones', 'margenRefacciones', 'margen-refacciones-valor', (val) => `${parseFloat(val).toFixed(0)}%`],
                
                // Venture Debt / Estructura de Capital
                ['venture-debt-pct', 'ventureDebtPct', 'venture-debt-pct-valor', (val) => `${parseFloat(val).toFixed(0)}%`],
                ['venture-debt-rate', 'ventureDebtRate', 'venture-debt-rate-valor', (val) => `${parseFloat(val).toFixed(0)}%`],
                
                // Actions / Global view controls
                ['debt-rate', null, 'debt-rate-value', (val) => `${parseFloat(val) * 100}%`], // This corresponds to config.debtRate, not modelData
                ['debt-term', null, null, (val) => val], // No display span
                ['debt-pct', null, 'debt-pct-value', (val) => `${parseFloat(val)}%`], // This should be for config.debtPercentage
                ['default-rate', null, 'default-rate-value', (val) => `${parseFloat(val)}%`], // This should be for config.defaultRate
                ['gnv-commission', null, 'gnv-value', (val) => `${parseFloat(val) * 100}%`], // This corresponds to config.gnvCommission
                ['spare-parts', null, 'spare-parts-value', (val) => `${parseFloat(val) * 100}%`] // This corresponds to config.sparePartsMargin
            ];

            controlMappings.forEach(mapping => {
                const [elementId, modelProperty, displayId, formatFn] = mapping;
                const element = document.getElementById(elementId);
                const displayElement = document.getElementById(displayId);

                if (!element) {
                    console.warn(`Control element not found: ${elementId}`);
                    return;
                }

                // Initial display update based on current element value
                if (displayElement && formatFn) {
                    displayElement.textContent = formatFn(element.value, element);
                }

                // Add event listener
                const eventType = (element.type === 'range' || element.type === 'number') ? 'input' : 'change';
                element.addEventListener(eventType, () => {
                    // Update modelData for specific mapped properties
                    if (modelProperty) {
                        modelData[modelProperty] = parseFloat(element.value);
                    } else if (elementId.startsWith('units-year')) { // Special handling for units distribution
                        const yearIndex = parseInt(elementId.replace('units-year', '')) - 1;
                        financialConfig.unitsPerYear[yearIndex] = parseInt(element.value);
                    } else { // Direct update to config for other non-modelData parameters
                         // For these, ensure config is directly updated.
                         // This is where previous mismatch caused issues.
                         switch(elementId) {
                            case 'debt-rate': financialConfig.debtRate = parseFloat(element.value); break;
                            case 'debt-term': financialConfig.debtTerm = parseInt(element.value); break;
                            case 'debt-pct': financialConfig.debtPercentage = parseFloat(element.value) / 100; break;
                            case 'default-rate': financialConfig.defaultRate = parseFloat(element.value) / 100; break;
                            case 'gnv-commission': financialConfig.gnvCommission = parseFloat(element.value); break;
                            case 'spare-parts': financialConfig.sparePartsMargin = parseFloat(element.value); break;
                         }
                    }

                    // Update display value on interaction
                    if (displayElement && formatFn) {
                        displayElement.textContent = formatFn(element.value, element);
                    }
                    calculateModel(); // Recalculate model on any control change
                });
            });

            // Specific handler for "Protecci√≥n Rodando" checkbox
            const proteccionCheckbox = document.getElementById('check-proteccion');
            if (proteccionCheckbox) {
                proteccionCheckbox.addEventListener('change', () => {
                    modelData.proteccionRodando = proteccionCheckbox.checked;
                    calculateModel();
                });
            }

            // Scenario selector
            const scenarioSelect = document.getElementById('select-escenario');
            if (scenarioSelect) {
                scenarioSelect.addEventListener('change', function() {
                    applyScenario(this.value);
                });
            }
        }
        
        /**
         * Applies predefined scenario settings to the model parameters and updates UI controls.
         * @param {string} scenario - The scenario to apply ('base', 'optimista', 'conservador').
         */
        function applyScenario(scenario) {
            // Define scenarios with their specific settings for modelData and financialConfig.unitsPerYear
            const scenarios = {
                'base': {
                    tasaMorosidad: 8,
                    margenVagoneta: 88000,
                    unitsPerYear: [35, 70, 100, 150, 200]
                },
                'optimista': {
                    tasaMorosidad: 5,
                    margenVagoneta: 100000,
                    unitsPerYear: [50, 100, 150, 100, 100] // Example: faster initial growth
                },
                'conservador': {
                    tasaMorosidad: 12,
                    margenVagoneta: 75000,
                    unitsPerYear: [20, 50, 80, 75, 75] // Example: slower growth
                }
            };

            const selectedScenario = scenarios[scenario];

            // Apply modelData specific changes and update UI controls
            modelData.tasaMorosidad = selectedScenario.tasaMorosidad;
            modelData.margenVagoneta = selectedScenario.margenVagoneta;
            document.getElementById('tasa-morosidad').value = selectedScenario.tasaMorosidad;
            document.getElementById('margen-vagoneta').value = selectedScenario.margenVagoneta;
            document.getElementById('tasa-morosidad-valor').textContent = `${selectedScenario.tasaMorosidad}%`;
            document.getElementById('margen-vagoneta-valor').textContent = `$${selectedScenario.margenVagoneta.toLocaleString()}`;

            // Apply financialConfig.unitsPerYear changes and update corresponding UI sliders
            financialConfig.unitsPerYear = [...selectedScenario.unitsPerYear]; // Ensure it's a new array
            selectedScenario.unitsPerYear.forEach((units, index) => {
                const year = index + 1;
                const slider = document.getElementById(`units-year${year}`);
                const display = document.getElementById(`units-year${year}-value`);
                if (slider) slider.value = units;
                if (display) display.textContent = units;
            });

            updateScenarioDetails(); // Update scenario description
            calculateModel(); // Recalculate model with new parameters
            updateUI(); // Ensure all UI reflects changes
        }

        /**
         * Updates the scenario details display based on the selected scenario.
         */
        function updateScenarioDetails() {
            const scenario = document.getElementById('select-escenario').value;
            const details = document.getElementById('scenario-details');
            
            switch(scenario) {
                case 'base':
                    details.innerHTML = '<strong>Escenario Base:</strong> Tasa de morosidad 8%, Margen por vagoneta $88,000 MXN, TIR objetivo ‚â•22.8%';
                    break;
                case 'optimista':
                    details.innerHTML = '<strong>Escenario Optimista:</strong> Tasa de morosidad 5%, Margen por vagoneta $100,000 MXN, crecimiento acelerado';
                    break;
                case 'conservador':
                    details.innerHTML = '<strong>Escenario Conservador:</strong> Tasa de morosidad 12%, Margen por vagoneta $75,000 MXN, crecimiento moderado';
                    break;
            }
        }


        /**
         * Updates all UI elements including financial tables and charts.
         */
        function updateUI() {
            updatePLTable(); // Pass no args, tables read from financialState directly
            updateCashFlowTable();
            updateBalanceSheetTable();
            updateDebtAmortization(); 
            updateCharts();
        }

        /**
         * Populates the Income Statement table.
         */
        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            tbody.innerHTML = '';
            
            const lineItems = [
                { label: 'Ingresos por Financiamiento (Capital)', key: 'principalRevenue', isNegative: false },
                { label: 'Ingresos por Intereses (NIIF 15)', key: 'interestRevenue', isNegative: false },
                { label: 'Comisiones GNV', key: 'gnvRevenue', isNegative: false },
                { label: 'Ingresos por Refacciones', key: 'sparePartsRevenue', isNegative: false },
                { label: 'Marketplace', key: 'marketplaceRevenue', isNegative: false },
                { label: 'Total Ingresos', key: 'totalRevenue', isTotal: true, isNegative: false },
                { label: 'Costo de Unidades Vendidas', key: 'costOfGoodsSold', isNegative: true },
                { label: 'Gastos Operativos', key: 'opex', isNegative: true },
                { label: 'Provisiones (NIIF 9)', key: 'provisionForLosses', isNegative: true },
                { label: 'Depreciaci√≥n', key: 'annualDepreciation', isNegative: true },
                { label: 'EBITDA', key: 'ebitda', isTotal: true, isNegative: false },
                { label: 'Intereses Deuda', key: 'currentAnnualDebtInterest', isNegative: true },
                { label: 'Impuesto sobre la Renta', key: 'incomeTax', isNegative: true },
                { label: 'Utilidad Neta', key: 'netIncome', isTotal: true, isNegative: false }
            ];
            
            lineItems.forEach(item => {
                const tr = document.createElement('tr');
                if (item.isTotal) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = item.label;
                if (item.isTotal) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialState.incomeStatement.forEach(yearData => {
                    const cell = document.createElement('td');
                    let value = yearData[item.key];
                    
                    if (item.isTotal) cell.classList.add('font-bold');
                    
                    if (item.isNegative && value !== undefined) {
                        cell.textContent = `(${formatCurrency(Math.abs(value))})`;
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(value);
                        if (value < 0 && !item.isNegative) cell.classList.add('negative'); 
                        else if (value > 0 && !item.isNegative) cell.classList.add('positive');
                    }
                    tr.appendChild(cell);
                });
                tbody.appendChild(tr);
            });
        }

        /**
         * Populates the Cash Flow Statement table.
         */
        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            tbody.innerHTML = '';
            
            const lineItems = [
                { label: 'Flujo de Efectivo Operativo', key: 'operatingCashFlow' },
                { label: 'Flujo de Efectivo de Inversi√≥n', key: 'investingCashFlow' },
                { label: 'Flujo de Efectivo Financiero', key: 'financingCashFlow' },
                { label: 'Flujo Neto de Efectivo', key: 'netCashFlow', isTotal: true },
                { label: 'Saldo de Efectivo Final', key: 'endingCashBalance', isTotal: true }
            ];
            
            lineItems.forEach(item => {
                const tr = document.createElement('tr');
                if (item.isTotal) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = item.label;
                if (item.isTotal) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialState.cashFlow.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[item.key];
                    
                    cell.textContent = formatCurrency(value);
                    if (item.isTotal) cell.classList.add('font-bold');
                    if (value < 0) cell.classList.add('negative');
                    else cell.classList.add('positive');
                    tr.appendChild(cell);
                });
                tbody.appendChild(tr);
            });
        }

        /**
         * Populates the Balance Sheet table.
         */
        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            tbody.innerHTML = '';
            
            const lineItems = [
                { label: 'Efectivo y Equivalentes', key: 'cashAndEquivalents' },
                { label: 'Pr√©stamos por Cobrar (Clientes, Neto)', key: 'loansReceivable' }, 
                { label: 'Propiedad, Planta y Equipo (Neto)', key: 'propertyPlantEquipmentNet' },
                { label: 'Total Activos', key: 'totalAssets', isTotal: true },
                { label: 'Deuda por Pagar (Venture Debt)', key: 'outstandingDebt' },
                { label: 'Otras Obligaciones', key: 'otherLiabilities' },
                { label: 'Total Pasivos', key: 'totalLiabilities', isTotal: true },
                { label: 'Capital Social', key: 'shareCapital' },
                { label: 'Utilidades Retenidas', key: 'retainedEarnings' },
                { label: 'Total Capital', key: 'totalEquity', isTotal: true },
                { label: 'Total Pasivo + Capital', key: 'totalLiabilitiesAndEquity', isTotal: true },
                { label: 'Validaci√≥n (Activo - P+C)', key: 'validation', isValidation: true }
            ];
            
            lineItems.forEach(item => {
                const tr = document.createElement('tr');
                if (item.isTotal) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = item.label;
                if (item.isTotal) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialState.balanceSheet.forEach(yearData => {
                    const cell = document.createElement('td');
                    if (item.isTotal) cell.classList.add('font-bold');
                    
                    if (item.isValidation) {
                        const diff = yearData.totalAssets - yearData.totalLiabilitiesAndEquity;
                        if (Math.abs(diff) < 0.01) { 
                            cell.textContent = '‚úÖ Balanceado';
                            cell.classList.add('positive');
                        } else {
                            cell.textContent = `‚ùå Desbalance: ${formatCurrency(diff)}`;
                            cell.classList.add('negative');
                        }
                    } else {
                        cell.textContent = formatCurrency(yearData[item.key]);
                    }
                    tr.appendChild(cell);
                });
                tbody.appendChild(tr);
            });
        }

        /**
         * Populates the Debt Amortization table.
         */
        function updateDebtAmortization() {
            const tbody = document.getElementById('debt-amortization-body');
            tbody.innerHTML = '';
            
            financialState.debtAmortization.forEach(yearData => { 
                const tr = document.createElement('tr');
                
                const cells = [
                    yearData.year,
                    yearData.beginningBalance,
                    yearData.principalPaid,
                    yearData.interestPaid,
                    yearData.totalPayment,
                    yearData.endingBalance
                ];

                cells.forEach((value, index) => {
                    const cell = document.createElement('td');
                    if (index === 0) { // Year column
                        cell.textContent = value;
                        cell.classList.add('text-left');
                    } else {
                        cell.textContent = formatCurrency(value);
                    }
                    if (index === 2 || index === 3 || index === 4) { // Principal, Interest, Total Payments are outflows
                        if (value > 0) cell.classList.add('negative');
                    }
                    tr.appendChild(cell);
                });
                tbody.appendChild(tr);
            });
        }


        // --- Charting Functions ---

        function initializeCharts() {
            // Destroy existing charts if they exist
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {}; // Reset charts object

            // Initialize all charts with dummy/initial data
            // Revenue and EBITDA evolution chart
            const ctx1 = document.getElementById('revenue-ebitda-chart');
            if (ctx1) {
                charts.revenueEbitda = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: financialConfig.unitsPerYear.map((_, i) => `A√±o ${i+1}`),
                        datasets: [
                            { label: 'Ingresos Totales', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', tension: 0.4 },
                            { label: 'EBITDA', data: [], borderColor: '#16a34a', backgroundColor: 'rgba(22, 163, 74, 0.1)', tension: 0.4 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Millones MXN' } } } }
                });
            }

            // Revenue breakdown chart
            const ctx2 = document.getElementById('revenue-breakdown-chart');
            if (ctx2) {
                charts.revenueBreakdown = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Financiamiento', 'Margen Vagoneta', 'Comisiones GNV', 'Refacciones PMA'],
                        datasets: [{ data: [], backgroundColor: ['#2563eb', '#16a34a', '#d97706', '#7c3aed'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            // Sensitivity analysis chart (EBITDA vs Morosidad)
            const ctx3 = document.getElementById('sensitivity-chart');
            if (ctx3) {
                charts.sensitivity = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['4%', '6%', '8%', '10%', '12%'],
                        datasets: [{ label: 'EBITDA A√±o 5 (Millones MXN)', data: [], backgroundColor: ['#16a34a', '#22c55e', '#2563eb', '#3b82f6', '#f59e0b'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, title: { display: true, text: 'EBITDA (Millones MXN)' } }, x: { title: { display: true, text: 'Tasa de Morosidad' } } } }
                });
            }

            // Capital structure chart (TIR vs % Venture Debt)
            const ctx4 = document.getElementById('capital-structure-chart');
            if (ctx4) {
                charts.capitalStructure = new Chart(ctx4, {
                    type: 'scatter',
                    data: {
                        datasets: [{ 
                            label: 'TIR vs % Venture Debt', 
                            data: [], 
                            backgroundColor: '#2563eb', 
                            borderColor: '#2563eb' 
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: '% Venture Debt' } }, y: { title: { display: true, text: 'TIR (%)' } } } }
                });
            }
            updateCharts(); // Populate with initial calculated data
        }


        /**
         * Updates the data for all Chart.js instances.
         */
        function updateCharts() {
            // Update Revenue and EBITDA chart
            if (charts.revenueEbitda) {
                charts.revenueEbitda.data.datasets[0].data = financialState.incomeStatement.map(d => d.totalRevenue / 1000000);
                charts.revenueEbitda.data.datasets[1].data = financialState.incomeStatement.map(d => d.ebitda / 1000000);
                charts.revenueEbitda.update();
            }

            // Update Revenue breakdown chart (using Year 5 data for breakdown)
            if (charts.revenueBreakdown && financialState.incomeStatement[4]) {
                const year5Data = financialState.incomeStatement[4];
                const breakdownData = [
                    year5Data.interestRevenue,
                    year5Data.principalRevenue, 
                    year5Data.gnvRevenue,
                    year5Data.sparePartsRevenue
                ];
                charts.revenueBreakdown.data.datasets[0].data = breakdownData;
                charts.revenueBreakdown.update();
            }

            // Update Sensitivity analysis chart (EBITDA vs Morosidad)
            if (charts.sensitivity) {
                const defaultRates = [0.04, 0.06, 0.08, 0.10, 0.12]; // Rates to test
                const ebitdaValues = defaultRates.map(rate => {
                    // Temporarily store original modelData and financialState values
                    const originalModelData = { ...modelData };
                    const originalFinancialState = JSON.parse(JSON.stringify(financialState)); // Deep copy for full reset

                    // Apply temporary modelData change for sensitivity analysis
                    modelData.tasaMorosidad = rate * 100; 
                    
                    // Run a temporary full model calculation
                    calculateModel(); // This will modify the global financialState

                    const calculatedEbitda = financialState.incomeStatement[4].ebitda / 1000000;

                    // Restore original modelData and financialState
                    modelData.tasaMorosidad = originalModelData.tasaMorosidad; // Restore modelData
                    Object.assign(financialState, originalFinancialState); // Restore financialState

                    return calculatedEbitda;
                });
                charts.sensitivity.data.datasets[0].data = ebitdaValues;
                charts.sensitivity.update();
            }


            // Update Capital structure chart (TIR vs % Venture Debt)
            if (charts.capitalStructure) {
                const ventureDebtPcts = [0, 10, 20, 30, 40, 50]; // % Venture Debt to test
                const tirValues = ventureDebtPcts.map(pct => {
                    // Temporarily store original modelData and financialState values
                    const originalModelData = { ...modelData };
                    const originalFinancialState = JSON.parse(JSON.stringify(financialState)); // Deep copy for full reset

                    // Apply temporary modelData change
                    modelData.ventureDebtPct = pct;

                    // Run a temporary full model calculation
                    calculateModel(); // This will modify the global financialState

                    const cashFlowsForIRR = [
                        -financialConfig.seriesA, 
                        ...financialState.cashFlow.map(cf => cf.netCashFlow)
                    ];
                    const irr = calculateIRR(cashFlowsForIRR) * 100; 

                    // Restore original modelData and financialState
                    modelData.ventureDebtPct = originalModelData.ventureDebtPct;
                    Object.assign(financialState, originalFinancialState);
                    
                    return { x: pct, y: isNaN(irr) ? 0 : irr };
                });
                charts.capitalStructure.data.datasets[0].data = tirValues;
                charts.capitalStructure.update();
            }
        }


        // --- Utility Functions ---

        /**
         * Validates the accounting equation (Assets = Liabilities + Equity) for the last year.
         */
        function validateAccounting() {
            const validationElement = document.getElementById('balance-validation');
            const lastYear = financialState.balanceSheet[4]; 
            
            if (!lastYear) {
                validationElement.textContent = 'C√°lculos incompletos para validaci√≥n de balance.';
                validationElement.className = 'validation-error';
                return;
            }

            const diff = lastYear.totalAssets - lastYear.totalLiabilitiesAndEquity;
            
            if (Math.abs(diff) < 0.01) { 
                validationElement.textContent = '‚úÖ Balance General Cuadrado (Activo = Pasivo + Capital)';
                validationElement.className = 'validation-success';
            } else {
                validationElement.textContent = `‚ùå Desbalance Detectado: ${formatCurrency(diff)}`;
                validationElement.className = 'validation-error';
            }
        }

        /**
         * Resets all model parameters to their initial default values.
         */
        function resetModel() {
            // Reset modelData to initial defaults
            modelData = {
                tasaInteres: 25.5,
                tasaMorosidad: 8,
                proteccionRodando: true,
                margenVagoneta: 88000,
                comisionGNV: 8,
                margenRefacciones: 25,
                ventureDebtPct: 0,
                ventureDebtRate: 12
            };

            // Reset financialConfig.unitsPerYear to its default distribution
            financialConfig.unitsPerYear = [35, 70, 100, 150, 200];


            // Reset UI controls to reflect modelData defaults and financialConfig defaults
            document.getElementById('tasa-interes').value = modelData.tasaInteres;
            document.getElementById('tasa-morosidad').value = modelData.tasaMorosidad;
            document.getElementById('check-proteccion').checked = modelData.proteccionRodando;
            document.getElementById('margen-vagoneta').value = modelData.margenVagoneta;
            document.getElementById('comision-gnv').value = modelData.comisionGNV;
            document.getElementById('margen-refacciones').value = modelData.margenRefacciones;
            document.getElementById('venture-debt-pct').value = modelData.ventureDebtPct;
            document.getElementById('venture-debt-rate').value = modelData.ventureDebtRate;
            document.getElementById('select-escenario').value = 'base'; 
            
            // Update individual unit sliders and their displays
            financialConfig.unitsPerYear.forEach((units, index) => {
                const year = index + 1;
                const slider = document.getElementById(`units-year${year}`);
                const display = document.getElementById(`units-year${year}-value`);
                if (slider) slider.value = units;
                if (display) display.textContent = units;
            });


            // Manually update remaining display spans based on new values
            document.getElementById('tasa-interes-valor').textContent = modelData.tasaInteres.toFixed(1) + '%';
            document.getElementById('tasa-morosidad-valor').textContent = modelData.tasaMorosidad + '%';
            document.getElementById('margen-vagoneta-valor').textContent = '$' + modelData.margenVagoneta.toLocaleString();
            document.getElementById('comision-gnv-valor').textContent = modelData.comisionGNV + '%';
            document.getElementById('margen-refacciones-valor').textContent = modelData.margenRefacciones + '%';
            document.getElementById('venture-debt-pct-valor').textContent = modelData.ventureDebtPct + '%';
            document.getElementById('venture-debt-rate-valor').textContent = modelData.ventureDebtRate + '%';

            // Also reset general config values, which are now distinct from modelData
            document.getElementById('debt-rate').value = financialConfig.debtRate;
            document.getElementById('debt-term').value = financialConfig.debtTerm;
            document.getElementById('debt-pct').value = financialConfig.debtPercentage * 100; // Convert to %
            document.getElementById('default-rate').value = financialConfig.defaultRate * 100; // Convert to %
            document.getElementById('gnv-commission').value = financialConfig.gnvCommission; // This is a select, value should match option value
            document.getElementById('spare-parts').value = financialConfig.sparePartsMargin; // This is a select, value should match option value

            // Update associated display spans for these config-related controls
            document.getElementById('debt-rate-value').textContent = `${financialConfig.debtRate * 100}%`;
            document.getElementById('debt-pct-value').textContent = `${financialConfig.debtPercentage * 100}%`;
            document.getElementById('default-rate-value').textContent = `${financialConfig.defaultRate * 100}%`;
            document.getElementById('gnv-value').textContent = `${financialConfig.gnvCommission * 100}%`; // Corrected ID
            document.getElementById('spare-parts-value').textContent = `${financialConfig.sparePartsMargin * 100}%`;

            updateScenarioDetails(); 
            calculateModel(); 
            updateUI(); 
        }

        /**
         * Placeholder for exporting data to Excel.
         */
        function exportToExcel() {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                z-index: 1000; text-align: center; font-family: 'Inter', sans-serif;
            `;
            messageBox.innerHTML = `
                <p class="text-lg font-bold mb-4">Exportaci√≥n Completada</p>
                <p>Los estados financieros se han exportado exitosamente a formato Excel.</p>
                <button class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" onclick="this.parentNode.remove()">Cerrar</button>
            `;
            document.body.appendChild(messageBox);
        }

        /**
         * Formats a numeric value as Mexican Pesos currency.
         * @param {number} value - The numeric value to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return '-';
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        /**
         * Calculates the Internal Rate of Return (IRR) for a series of cash flows.
         * @param {Array<number>} cashFlows - An array of cash flows, where cashFlows[0] is the initial investment (negative).
         * @returns {number} The IRR as a decimal, or NaN if not convergent.
         */
        function calculateIRR(cashFlows) {
            if (!cashFlows || cashFlows.length === 0) {
                return NaN;
            }
            // If all cash flows are zero, IRR is 0.
            if (cashFlows.every(cf => cf === 0)) {
                return 0;
            }

            const MAX_ITERATIONS = 1000;
            const ACCURACY = 1e-7; 

            let low = -1.0; // Lower bound for IRR guess (-100%)
            let high = 10.0; // Upper bound for IRR guess (1000%) - wide range for common financial models

            for (let i = 0; i < MAX_ITERATIONS; i++) {
                const mid = (low + high) / 2; // Midpoint guess
                if (mid === 0) { // Avoid division by zero in NPV calculation
                    low = mid; // Try higher rate
                    continue;
                }

                let npv = 0;
                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + mid, j);
                }

                if (Math.abs(npv) < ACCURACY) {
                    return mid; // Found a good enough IRR
                }

                if (npv > 0) {
                    low = mid; // NPV is positive, so try a higher discount rate
                } else {
                    high = mid; // NPV is negative, so try a lower discount rate
                }
            }
            return NaN; // Could not converge
        }

        // Initialize app on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupControls(); 
            initializeCharts();
            updateScenarioDetails(); 
            calculateModel(); 
            updateUI(); 
        });
    </script>
</body>
</html>
