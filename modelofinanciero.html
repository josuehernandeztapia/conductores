<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo Conductores: Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons for a professional touch -->
    <script src="https://unpkg.com/lucide@latest"></script> 
    
    <style>
        /* Base Styles - Inspired by the Pitch Deck (Dark Theme) */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; /* slate-950 from Tailwind for dark background */
            color: #e2e8f0; /* slate-200 for main text */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        h1, h2, h3, h4 {
            color: #f8fafc; /* slate-50 for titles */
            font-weight: 700; /* Bold */
        }
        /* Gradient text highlight */
        .highlight-text {
            background: -webkit-linear-gradient(45deg, #22d3ee, #0ea5e9); /* cyan-400 to sky-500 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Tabs Navigation */
        .tab-button { 
            transition: all 0.3s ease; 
            cursor: pointer; 
            padding: 1rem 1.5rem;
            border-bottom: 2px solid transparent;
            color: #94a3b8; /* slate-400 */
            font-weight: 500;
            margin-right: 0.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            display: inline-flex; /* Allows icons aligned with text */
            align-items: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        .tab-button.active { 
            border-color: #0ea5e9; /* sky-500 */
            color: #f8fafc; /* slate-50 */
            background-color: #0f172a; /* slate-900 */
            font-weight: 600;
        }
        .tab-button:hover:not(.active) {
            color: #cbd5e1; /* slate-300 */
            background-color: #0f172a; /* slate-900 */
        }
        /* Section content */
        .content-section { display: none; }
        .content-section.active { display: block; }
        /* Card Style */
        .card { 
            background-color: #0f172a; /* slate-900 for card interior */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            border: 1px solid #1e293b; /* slate-800 for subtle borders */
        }
        /* Sliders */
        .input-slider { 
            -webkit-appearance: none; 
            width: 100%; 
            height: 8px; 
            background: #1e293b; /* slate-800 */
            border-radius: 9999px; 
            outline: none; 
            transition: background 0.2s ease-in-out;
        }
        .input-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 20px; 
            height: 20px; 
            background: #0ea5e9; /* sky-500 */
            border-radius: 9999px; 
            cursor: pointer; 
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3); /* Ring when dragging */
            transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-slider:hover::-webkit-slider-thumb {
            background: #38bdf8; /* sky-400 */
        }
        /* Financial Tables */
        .financial-table { 
            width: 100%; 
            border-collapse: collapse; 
            background-color: #0f172a; /* slate-900 */
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden; /* So that rounded borders apply to thead/tbody */
        }
        .financial-table th, .financial-table td { 
            padding: 1rem; /* More padding for readability */
            text-align: right; 
            border-bottom: 1px solid #1e293b; /* slate-800 */
            font-size: 0.95rem;
        }
        .financial-table th { 
            background-color: #1a233b; /* A slightly lighter shade than the table background */
            font-weight: 600; 
            color: #94a3b8; /* slate-400 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .financial-table td:first-child, .financial-table th:first-child { 
            text-align: left; 
            color: #e2e8f0; /* slate-200 */
        }
        .financial-table tr:last-child td {
            border-bottom: none; /* Remove bottom border from last row */
        }
        .financial-table tr.bg-gray-50 { /* Style for total/subtotal rows */
            background-color: #1e293b; /* slate-800 */
            color: #f8fafc; /* slate-50 */
            font-weight: 700;
        }
        .positive { color: #34d399; /* emerald-400 */ } 
        .negative { color: #f43f5e; /* rose-500 */ }
        /* Key Metrics Indicators */
        .metric-card { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* Subtle gradient */
            border-left: 4px solid #0ea5e9; /* sky-500 */
            padding: 1.25rem; /* More padding */
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .metric-card .text-sm {
            color: #94a3b8; /* slate-400 */
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .metric-card .text-2xl {
            color: #f8fafc; /* slate-50 */
            font-weight: 800; /* Extra bold */
        }
        /* Debug Panel */
        .debug-info { 
            background: #1e293b; /* slate-800 */
            color: #f8fafc; /* slate-50 */
            border: 1px solid #334155; /* slate-700 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .debug-info button {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            transition: background-color 0.2s ease;
        }
        .debug-info button:hover {
            background-color: #dc2626; /* red-600 */
        }
        /* IFRS Compliant Cards */
        .niif-compliant {
            border-left: 4px solid #10b981; /* emerald-500 */
            background-color: #0f172a; /* slate-900 */
        }
        /* Validation Panel */
        #validation-panel-content {
            background-color: #0f172a; /* slate-900 */
            border: 1px solid #1e293b; /* slate-800 */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .validation-item {
            border-left: 4px solid;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .validation-item.errors { background-color: #450a0a; border-color: #dc2626; color: #fecaca; } /* red-950 / red-600 */
        .validation-item.warnings { background-color: #422006; border-color: #f59e0b; color: #fffbeb; } /* amber-950 / amber-500 */
        .validation-item.info { background-color: #075985; border-color: #3b82f6; color: #e0f2fe; } /* sky-950 / blue-500 */
        .validation-item.passed { background-color: #064e3b; border-color: #10b981; color: #d1fae5; } /* emerald-950 / green-500 */
        
        .validation-message { color: #cbd5e1; /* slate-300 */ }
        .validation-message strong { color: #f8fafc; }
        .validation-summary {
            background-color: #1a233b; /* slate-800 */
            color: #f8fafc;
            border: 1px solid #334155;
        }
        .validation-summary.bg-red-200 { background-color: #450a0a; border-color: #dc2626; color: #fecaca; }
        .validation-summary.bg-yellow-200 { background-color: #422006; border-color: #f59e0b; color: #fffbeb; }
        .validation-summary.bg-green-200 { background-color: #064e3b; border-color: #10b981; color: #d1fae5; }
        /* Tooltips - Maintain visibility and readability */
        [data-tooltip]:before, [data-tooltip]:after {
            background-color: #334155; /* slate-700 */
            color: #f8fafc;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }
        [data-tooltip]:after {
            border-top-color: #334155; /* slate-700 */
        }
        /* Inputs and Selects */
        input[type="number"], input[type="range"] {
            background-color: #1a233b; /* slate-800 */
            border-color: #334155; /* slate-700 */
            color: #e2e8f0; /* slate-200 */
            border-radius: 0.375rem; /* rounded-md */
        }
        input[type="number"]:focus, input[type="range"]::-webkit-slider-thumb:focus {
            border-color: #0ea5e9; /* sky-500 */
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.5); /* Focus ring */
            background-color: #1a233b; /* Ensure background doesn't change on focus */
        }
        label {
            color: #cbd5e1; /* slate-300 */
        }
        /* Styles for slider value text */
        span[id$="-valor"] {
            color: #81e6d9; /* a green/cyan tone for values */
        }
        /* NEW: Compact Chart Styles */
        .compact-chart {
            padding: 1rem;
        }
        .compact-chart h4 {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        @media (max-width: 1024px) {
            .compact-chart {
                min-height: 280px;
            }
        }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Debug Panel -->
    <div id="debug-info" class="debug-info">
        <div id="debug-content"></div>
        <button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
    </div>
    
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 text-center bg-transparent rounded-xl p-6">
            <h1 class="text-4xl lg:text-5xl font-black text-white leading-tight tracking-tighter mb-2">
                Modelo Financiero - Rodando a <span class="highlight-text">Gas</span>
            </h1>
            <p class="text-xl text-slate-400 mt-2">Resiliencia como Servicio</p>
            <button onclick="toggleDebug()" class="mt-4 bg-sky-600 hover:bg-sky-500 text-white px-4 py-2 rounded-lg font-medium transition duration-300 inline-flex items-center gap-2">
                <i data-lucide="bug" class="w-5 h-5"></i> Debug
            </button>
        </header>

        <!-- ================== NUEVO DASHBOARD PRINCIPAL ================== -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Columna Izquierda: KPIs Clave -->
            <div class="lg:col-span-2">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                    <div class="metric-card p-4 rounded-lg">
                        <div class="text-sm text-gray-500">EBITDA Año 5</div>
                        <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
                    </div>
                    <div class="metric-card p-4 rounded-lg">
                        <div class="text-sm text-gray-500">TIR Proyecto</div>
                        <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
                    </div>
                    <div class="metric-card p-4 rounded-lg">
                        <div class="text-sm text-gray-500">TIR Equity</div>
                        <div class="text-2xl font-bold" id="tir-equity">0%</div>
                    </div>
                    <div class="metric-card p-4 rounded-lg">
                        <div class="text-sm text-gray-500">Vagonetas Op. (Año 5)</div>
                        <div class="text-2xl font-bold" id="vagonetas-operativas">0</div>
                    </div>
                     <div class="metric-card p-4 rounded-lg">
                        <div class="text-sm text-gray-500">ROE (Año 5)</div>
                        <div class="text-2xl font-bold" id="roe-year5">0%</div>
                    </div>
                    <div class="metric-card p-4 rounded-lg">
                        <div class="text-sm text-gray-500">ROIC (Año 5)</div>
                        <div class="text-2xl font-bold" id="roic-year5">0%</div>
                    </div>
                </div>
            </div>
            <!-- Columna Derecha: Gráfico de Mix de Ingresos -->
            <div class="lg:col-span-1 card flex flex-col justify-center">
                 <h4 class="text-base font-semibold mb-2 text-white text-center">Mix de Ingresos (Año 5)</h4>
                 <div style="height: 220px; position: relative;"><canvas id="incomeMixChart"></canvas></div>
            </div>
        </div>
        <!-- ================== FIN DEL NUEVO DASHBOARD ================== -->
        
        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-slate-800">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active"> <i data-lucide="settings" class="w-5 h-5"></i> Control</button>
                <button id="tab-financieros" class="tab-button"> <i data-lucide="wallet" class="w-5 h-5"></i> Financieros</button>
                <button id="tab-niif" class="tab-button"> <i data-lucide="book" class="w-5 h-5"></i> NIIF</button>
                <button id="tab-graficos" class="tab-button"> <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Gráficos</button>
                <button id="tab-validacion" class="tab-button"> <i data-lucide="check-circle" class="w-5 h-5"></i> Validación</button>
            </nav>
        </div>
        <!-- Tab Content: Control -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- LEFT COLUMN -->
                <div class="space-y-6">
                    <!-- Package and Prices -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">     📦      Paquete y Precios <span class="text-sm text-slate-400">(Definición del producto y estructura de costos)</span></h4>
                        <div id="package-pricing-controls" class="space-y-4"></div>
                        <div id="package-summary" class="mt-4 p-3 bg-slate-800 rounded">
                            <!-- Automatic summary -->
                        </div>
                    </div>
                    <!-- Rates and Risk -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">     ⚡      Tasas y Riesgo <span class="text-sm text-slate-400">(Parámetros financieros y de riesgo del negocio)</span></h4>
                        <div id="rates-risk-controls" class="space-y-4"></div>
                    </div>
                </div>
                <!-- RIGHT COLUMN -->
                <div class="space-y-6">
                    <!-- Operations and Services -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">     💼      Operaciones y Servicios <span class="text-sm text-slate-400">(Ingresos operativos y eficiencia de los servicios)</span></h4>
                        <div id="operations-services-controls" class="space-y-4"></div>
                    </div>
                    <!-- Business Plan -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">     📈      Plan de Negocio <span class="text-sm text-slate-400">(Crecimiento de unidades y estructura financiera)</span></h4>
                        <div id="business-plan-controls" class="space-y-4"></div>
                    </div>
                    <!-- Valuation Sensitivity -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">    🎯     Sensibilidad Valuación 
                            <span class="text-sm text-slate-400">(Múltiplos y supuestos de salida para TIRs)</span>
                        </h4>
                        <div id="sensibilidad-valuacion-controls" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            <!-- RECALCULATE BUTTON -->
            <div class="text-center mt-6">
                <button onclick="forceCalculate()" class="mt-6 bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-lg font-medium transition duration-300 inline-flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i> Recalcular Modelo
                </button>
            </div>
        </div>
        <!-- Tab Content: Financials -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-white">Estado de Resultados (P&L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-white">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 0</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-white">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body"></tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4 text-center font-semibold p-2 rounded-lg bg-gray-50"></div>
                </div>
            </div>
        </div>
        <!-- Tab Content: IFRS -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4 text-white">NIIF 15 - Reconocimiento de Ingresos <span class="text-sm text-slate-400">(Cómo se reconocen los ingresos del negocio de financiamiento)</span></h3>
                    <div id="niif15-container">Calculando datos NIIF 15...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4 text-white">NIIF 9 - Provisiones Crediticias <span class="text-sm text-slate-400">(Impacto de la morosidad y las pérdidas esperadas)</span></h3>
                    <div id="niif9-container">Calculando datos NIIF 9...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4 text-white">NIIF 5 - Activos Mantenidos para Venta <span class="text-sm text-slate-400">(Tratamiento contable de vagonetas reposedas)</span></h3>
                    <div id="niif5-container">Calculando datos NIIF 5...</div>
                </div>
            </div>
        </div>
        <!-- Tab Content: Charts -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                <!-- Row 1 -->
                <div class="card compact-chart">
                    <h4 class="text-base font-semibold mb-2 text-white">   🎯    TIR Sensitivity</h4>
                    <div style="height: 240px;"><canvas id="tirSensitivityChart"></canvas></div>
                </div>
                
                <div class="card compact-chart">
                    <h4 class="text-base font-semibold mb-2 text-white">   🛡️    Protección Rodando™</h4>
                    <div style="height: 240px;"><canvas id="proteccionChart"></canvas></div>
                </div>
                
                <div class="card compact-chart">
                    <h4 class="text-base font-semibold mb-2 text-white">   📊    Portfolio NIIF 9</h4>
                    <div style="height: 240px;"><canvas id="portfolioChart"></canvas></div>
                </div>
                
                <!-- Row 2 -->
                <div class="card compact-chart">
                    <h4 class="text-base font-semibold mb-2 text-white">   💰    Unit Economics</h4>
                    <div style="height: 240px;"><canvas id="unitEconomicsChart"></canvas></div>
                </div>
                
                <div class="card compact-chart">
                    <h4 class="text-base font-semibold mb-2 text-white">   💸    Cash Flow Sources</h4>
                    <div style="height: 240px;"><canvas id="cashSourcesChart"></canvas></div>
                </div>
                
                <div class="card compact-chart">
                    <h4 class="text-base font-semibold mb-2 text-white">   🎯    Revenue Diversification</h4>
                    <div style="height: 240px;"><canvas id="diversificationChart"></canvas></div>
                </div>
            </div>
        </div>
        <!-- Tab Content: Validation -->
        <div id="content-validacion" class="content-section">
            <div id="validation-panel-content">
                <h3 class="text-xl font-semibold mb-4 text-white">Resultados de Validación del Modelo</h3>
                <div id="validation-results-container">
                    <!-- Validation results will be inserted here -->
                </div>
                <button onclick="generateValidationReportPDF()" class="mt-6 bg-sky-600 hover:bg-sky-500 text-white px-6 py-3 rounded-lg font-medium transition duration-300 inline-flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5"></i> Generar Reporte PDF
                </button>
            </div>
        </div>
    </div>
    <script>
        // Initializes Lucide icons
        lucide.createIcons();
        // ===== GLOBAL MODEL VARIABLES =====
        let debugLogs = []; // Array to store debug logs
        let charts = {}; // Object to store Chart.js instances
        
        /**
         * @typedef {Object} ModelData
         * All the properties from your original model are here...
         * Plus the new ones we're adding.
         */
        //  ✅  ================== PASO 1.1: ACTUALIZAR Supuestos Centrales en modelData ==================
        let modelData = {
            // === RENTABILIDAD (Ajustado a rangos de mercado) ===
            tasaInteres: 25.5,
            proteccionRodando: true,
            
            // === RIESGO (Supuestos conservadores NIIF 9) ===
            pdStage1: 0.005,
            pdStage2: 0.08,
            pdStage3: 0.40,
            lgd: 0.50,
            portfolioAllocationStage1: 0.85,
            portfolioAllocationStage2: 0.10,
            portfolioAllocationStage3: 0.05,
            economicAdjustmentFactor: 1.0,
            
            // === OPERACIONES (Valores Base) ===
            margenRefacciones: 50,
            ventureDebtRate: 18,
            commercialDebtRate: 14,
            periodoAmortizacionDeuda: 5,
            
            // === CRECIMIENTO Y ESCALA ( ✅  AJUSTE CLAVE: Crecimiento más lento y orgánico) ===
            unitsPerYear: [40, 120, 120, 120, 100], 
            
            // === CONSTANTES DEL MODELO ===
            vanCost: 641000,
            vanPrice: 729000,
            seriesA: 45000000,
            seriesB_funding: 0,
            seriesB_year: 3,
            seriesC_funding: 0,
            seriesC_year: 5,
            clientLoanTermYears: 4, // Mantenemos 4 años para optimizar la velocidad del efectivo.
            depreciationYears: 10,
            opexRate: 15,
            margenVagoneta: 5,
            tasaReposicion: 5,
            fairValueVenta: 85,
            costosVenta: 5,
            corporateTaxRate: 31,
            
            // === INGRESOS ADICIONALES ===
            litrosPromedioMensualPorUnidad: 900,
            precioLitroGNV: 13.99,
            comisionGNVPorcentaje: 10,
            gmvPromedioMensualPorUnidad: 8000,
            takeRateMarketplace: 2.5,
            ventureDebtLineMax: 50000000,
            
            // === PAQUETE COMPLETO FINANCIADO ===
            conversionPrice: 54000,
            bancasPrice: 21000,
            gpsPrice: 12000,
            insuranceAnnualPrice: 37205,
            insuranceYears: 4,
            conversionCost: 50000,
            bancasCost: 20000,
            gpsCost: 11000,
            refaccionesCostPerUnit: 8000,
            // === NUEVOS PARÁMETROS ESTRUCTURALES (Añadir al objeto) ===
            downPaymentPercentage: 15,
            upfrontCommissionPercentage: 3,
            // === PARÁMETROS DE VALUACIÓN (Añadir al objeto) ===
            ebitdaMultipleProject: 9,
            ebitdaMultipleEquity: 9,
            avgRemainingTermCartera: 2.5,
            floorEquityMultiple: 1.5,
        };
        // =======================================================================================
        const optimizedFinancialStructure = {
            capitalCalls: {
                year1: 25000000,
                year2: 40000000,
                year3: 35000000,
                year4: 35000000, 
                year5: 30000000
            },
            ventureDebt: {
                year1: 30000000,
                year2: 25000000,
                year3: 25000000,
                year4: 0,
                year5: 0,
                amortizationYears: 5
            },
            commercialDebt: {
                year1: 0,
                year2: 40000000,
                year3: 60000000,
                year4: 120000000,
                year5: 80000000
            },
            targets: {
                tirEquity: 42.0,
                fcfBreakevenYear: 4,
                totalEquity: 205000000,
                finalDebt: 260000000,
                autosuficiencyYear: 6
            },
            niifCompliance: {
                niif15: true,
                niif9: true,
                niif5: true
            }
        };
        function getOptimizedCapitalCall(year) {
            return optimizedFinancialStructure.capitalCalls[`year${year}`] || 0;
        }
        function getOptimizedVentureDebt(year) {
            return optimizedFinancialStructure.ventureDebt[`year${year}`] || 0;
        }
        function getOptimizedCommercialDebt(year) {
            return optimizedFinancialStructure.commercialDebt[`year${year}`] || 0;
        }
        
        //  ✅  ================== PASO 1.2: Implementar "Guardrails" en Controles de la UI ==================
        //  ✅  CORRECCIÓN: Renombrar keys de camelCase a kebab-case para coincidir con los IDs del HTML
        const controlsConfig = {
            'package-pricing': [
                { id: 'vanPrice', label: 'Precio Vagoneta Base', min: 500000, max: 1000000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Precio de venta/financiamiento de la vagoneta al cliente.' },
                { id: 'conversionPrice', label: 'Precio Conversión GNV', min: 30000, max: 100000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Precio de la conversión GNV financiado al cliente.' },
                { id: 'bancasPrice', label: 'Precio Bancas GNV', min: 15000, max: 30000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Precio de las bancas GNV financiado al cliente.' },
                // ================== CORRECCIÓN 1: Coma faltante añadida ==================
                { id: 'gpsPrice', label: 'Precio GPS/Telemática', min: 9000, max: 20000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Precio del GPS/telemática financiado al cliente.' },
                { id: 'insuranceAnnualPrice', label: 'Seguro Anual', min: 20000, max: 40000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Precio anual del seguro a financiar.' },
                { id: 'insuranceYears', label: 'Años Seguro', min: 1, max:4, step: 1, type: 'number', format: val => val.toFixed(0) + ' años', tooltip: 'Número de años de seguro a financiar en el paquete.' },
                { id: 'vanCost', label: 'Costo Vagoneta (RAG)', min: 500000, max: 1000000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo de adquisición de cada vagoneta por parte de Rodando a Gas.' },
                { id: 'conversionCost', label: 'Costo Conversión GNV', min: 30000, max: 60000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo de la conversión GNV para Rodando a Gas.' },
                { id: 'bancasCost', label: 'Costo Bancas GNV', min: 15000, max: 40000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo de las bancas GNV para Rodando a Gas.' },
                { id: 'gpsCost', label: 'Costo GPS/Telemática', min: 10000, max: 20000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo del GPS/telemática para Rodando a Gas.' },
            ],
            'rates-risk': [
                { id: 'tasaInteres', label: 'Tasa de Interés (Clientes)', min: 22, max: 35, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Tasa de interés anual aplicada a los préstamos de clientes.' },
                { id: 'corporateTaxRate', label: 'Tasa Impuesto Corporativo (%)', min: 25, max: 35, step: 1, type: 'range', format: val => val.toFixed(0) + '%', tooltip: 'Tasa de impuesto sobre la renta que aplica a las ganancias de la empresa.' },
                { id: 'pdStage1', label: 'PD Etapa 1 (12M)', min: 0.005, max: 0.015, step: 0.001, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: 'Rango seguro: 0.5%-1.5%. Fuera puede causar provisiones irreales.' },
                { id: 'pdStage2', label: 'PD Etapa 2 (Lifetime)', min: 0.05, max: 0.15, step: 0.005, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: 'Rango seguro: 5%-15%. Valores extremos pueden indicar subestimación/sobreestimación de riesgo.' },
                { id: 'pdStage3', label: 'PD Etapa 3 (Lifetime)', min: 0.30, max: 0.60, step: 0.01, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: 'Rango seguro: 30%-60%. Un valor muy bajo podría subestimar el riesgo de mora severa.' },
                { id: 'lgd', label: 'LGD (Pérdida Incumplimiento)', min: 0.40, max: 0.60, step: 0.01, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: 'Rango seguro: 40%-60%. Representa la pérdida esperada tras un incumplimiento.' },
                { id: 'portfolioAllocationStage1', label: 'Port. Etapa 1 (%)', min: 0.70, max: 0.95, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '70-95%. Proporción del portafolio en bajo riesgo. Un valor alto sugiere un portafolio "sano".' },
                { id: 'portfolioAllocationStage2', label: 'Port. Etapa 2 (%)', min: 0.05, max: 0.20, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '5-20%. Proporción del portafolio con riesgo significativo. Un valor creciente indica deterioro.' },
                { id: 'portfolioAllocationStage3', label: 'Port. Etapa 3 (%)', min: 0.01, max: 0.10, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '1-10%. Proporción en deterioro. Idealmente bajo y estable.' },
                { id: 'economicAdjustmentFactor', label: 'Ajuste Económico (Factor)', min: 0.8, max: 1.2, step: 0.01, type: 'range', format: val => val.toFixed(2) + 'x', tooltip: 'Rango seguro: 0.8x-1.2x. Refleja cómo factores macroeconómicos impactan el riesgo crediticio.' },
            ],
            'operations-services': [
                { id: 'margenVagoneta', label: 'Margen Originación Vagoneta', min: 3, max: 8, step: 0.1, type: 'number', format: val => val.toFixed(1) + '%', tooltip: 'Rango seguro: 3%-8%. Comisión por la originación de cada vagoneta financiada.' },
                { id: 'margenRefacciones', label: 'Margen Refacciones', min: 25, max: 100, step: 1, type: 'range', format: val => val.toFixed(0) + '%', tooltip: 'Rango seguro: 15%-35%. Margen de ganancia en los servicios de refacciones.' },
                { id: 'refaccionesCostPerUnit', label: 'Costo Refacciones/Unidad', min: 6000, max: 12000, step: 200, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo base de refacciones para RAG (antes de margen).' },
                { id: 'litrosPromedioMensualPorUnidad', label: 'Litros GNV/Unidad (Mensual)', min: 800, max: 1200, step: 10, type: 'number', format: val => val.toFixed(0) + ' L', tooltip: 'Rango seguro: 800-1200L. Consumo promedio mensual de GNV por vagoneta activa.' },
                { id: 'precioLitroGNV', label: 'Precio Litro GNV (MXN)', min: 11.00, max: 13.99, step: 0.01, type: 'number', format: val => '$' + val.toFixed(2) + ' MXN', tooltip: 'Rango seguro: $11.00-$13.99 MXN. Precio promedio por litro de GNV.' },
                { id: 'comisionGNVPorcentaje', label: 'Comisión GNV (%)', min: 7, max: 15, step: 0.1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Rango seguro: 7%-15%. Porcentaje de comisión por los servicios de GNV.' },
                { id: 'gmvPromedioMensualPorUnidad', label: 'Ventas Brutas Marketplace/Unidad (Mensual)', min: 5000, max: 15000, step: 100, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Rango seguro: $5,000-$15,000 MXN. Gross Merchandise Value promedio mensual generado por unidad.' },
                { id: 'takeRateMarketplace', label: 'Take Rate Marketplace (%)', min: 1.0, max: 5.0, step: 0.1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Rango seguro: 1.0%-5.0%. Porcentaje de comisión sobre las ventas brutas del marketplace.' },
                { id: 'opexRate', label: 'Tasa OPEX (% Ingresos)', min: 10, max: 20, step: 1, type: 'number', format: val => val.toFixed(0) + '%', tooltip: 'Rango seguro: 10%-20%. Porcentaje de los ingresos operativos destinado a OPEX.' },
                { id: 'tasaReposicion', label: '% Unidades Reposición', min: 3, max: 7, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%', tooltip: 'Rango seguro: 3%-7%. Porcentaje de unidades que se reponen anualmente. Valores altos indican problemas en originación.' },
                { id: 'fairValueVenta', label: '% Fair Value Venta', min: 80, max: 90, step: 1, type: 'number', format: val => val.toFixed(0) + '%', tooltip: 'Rango seguro: 80%-90%. Porcentaje del valor razonable de las vagonetas reposedas. Un valor bajo puede implicar pérdidas adicionales.' },
                { id: 'costosVenta', label: '% Costos Venta', min: 3, max: 7, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%', tooltip: 'Rango seguro: 3%-7%. Porcentaje de costos asociados a la venta de vagonetas reposedas.' },
            ],
            'business-plan': [
                { id: 'unitsPerYear', label: 'Unidades Año', type: 'array', min: 0, max: 300, step: 1, format: val => val.toFixed(0), tooltip: 'Número de vagonetas adquiridas y puestas en operación en cada año de la proyección.' },
                { id: 'seriesA', label: 'Capital Serie A', min: 0, max: 100000000, step: 1000000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Inversión inicial de Serie A (Equity).' },
                // ================== NUEVO CONTROL AÑADIDO ==================
                { id: 'clientLoanTermYears', label: 'Años Crédito Cliente', min: 3, max: 6, step: 1, type: 'range', format: val => val.toFixed(0) + ' años', tooltip: 'Plazo del crédito para el cliente. Afecta el flujo de caja y la velocidad de recuperación del capital.' },
                { id: 'downPaymentPercentage', label: 'Enganche Cliente (%)', min: 5, max: 25, step: 1, type: 'range', format: val => val.toFixed(0) + '%', tooltip: '10-25%. 10% = balance riesgo/accesibilidad' },
                { id: 'upfrontCommissionPercentage', label: 'Comisión Inicial (%)', min: 1, max: 8, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: '1-8%. Diferida por NIIF 15' },
                { id: 'depreciationYears', label: 'Años Depreciación (Vagoneta)', min: 1, max: 15, step: 1, type: 'number', format: val => val.toFixed(0) + ' años', tooltip: 'Vida útil en años para la depreciación lineal de las vagonetas de Rodando a Gas.' },
                { id: 'periodoAmortizacionDeuda', label: 'Periodo Amortización Deuda (Años)', min: 1, max: 10, step: 1, type: 'number', format: val => val.toFixed(0) + ' años', tooltip: 'Años para amortizar la deuda inicial de Venture Debt.' },
            ],
            'sensibilidad-valuacion': [
                { id: 'ebitdaMultipleProject', label: 'Múltiplo EBITDA Proyecto', min: 7, max: 12, step: 0.5, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: '7-12X. Benchmark Fintech México' },
                { id: 'ebitdaMultipleEquity', label: 'Múltiplo EBITDA Equity', min: 7, max: 12, step: 0.5, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: '7-12X. Múltiplo de salida para inversionistas' },
                { id: 'floorEquityMultiple', label: 'Floor Book Value', min: 1.0, max: 2.5, step: 0.1, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: '1.0-2.5X. Protección downside en TIR Equity' }
            ],
        };
        // =======================================================================================
        
        let financialResults = {
            pl: [], cf: [], bs: [], niifDetails: [], 
            tirProyecto: 0, tirCartera: 0, tirEquity: 0, 
            roe: [], roic: [] 
        };
        
        let heldForSaleAssets = [];
        
        const BALANCE_TOLERANCE = 1000;
        
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.unshift(logEntry);
            if (debugLogs.length > 20) debugLogs.pop();
            console.log(logEntry, data);
            updateDebugPanel();
        }
        
        function updateDebugPanel() {
            const panel = document.getElementById('debug-content');
            if (panel) {
                panel.innerHTML = debugLogs.map(log => `<div style="margin-bottom: 2px; font-size: 10px; border-bottom: 1px dotted #4b5563; padding-bottom: 2px;">${log}</div>`).join('');
            }
        }
        
        function toggleDebug() {
            const panel = document.getElementById('debug-info');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function formatCurrency(value, full = false) {
            if (value === null || value === undefined || isNaN(value)) return '$0 MXN';
            value = parseFloat(value);
            
            if (full) {
                return '$' + value.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' MXN';
            } else if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            } else if (Math.abs(value) >= 1000) {
                return '$' + (value / 1000).toFixed(1) + 'K MXN';
            }
            return '$' + Math.round(value).toLocaleString() + ' MXN';
        }
        function getInsuranceTotalPrice() {
            return modelData.insuranceAnnualPrice * modelData.insuranceYears;
        }
        function getTotalPackagePrice() {
            return modelData.vanPrice + modelData.conversionPrice + 
                   modelData.bancasPrice + modelData.gpsPrice + getInsuranceTotalPrice();
        }
        function getTotalPackageCost() {
            return modelData.vanCost + modelData.conversionCost + 
                   modelData.bancasCost + modelData.gpsCost;
        }
        
        function calculatePDBasedOnAge(cohortAgeYears) {
            let basePD;
            if (cohortAgeYears <= 1) {
                basePD = modelData.pdStage1;
            } else if (cohortAgeYears === 2) {
                basePD = modelData.pdStage2;
            } else {
                basePD = modelData.pdStage3;
                if (cohortAgeYears > 2) {
                    basePD *= 1.5;
                }
            }
            return basePD;
        }
        
        function calculateNIIF9ECL(loanCohorts, currentYear, currentProvisionsBalance, currentYearEndReceivables) {
            const loanTermAdjustmentFactor = modelData.clientLoanTermYears === 4 ? 0.8 : 1.0;
            const adjustedPDStage1 = modelData.pdStage1 * loanTermAdjustmentFactor;
            const adjustedPDStage2 = modelData.pdStage2 * loanTermAdjustmentFactor;
            log(`  📊   NIIF 9 - Ajuste préstamos ${modelData.clientLoanTermYears} años: Factor ${loanTermAdjustmentFactor}`);
            let totalECLForYear = 0;
            let eclByStage = { stage1: 0, stage2: 0, stage3: 0 };
            
            const totalExposure = loanCohorts.reduce((sum, cohort) => sum + cohort.avgExposureDuringYear, 0);
            
            if (totalExposure > 0) {
                const stage1Exposure = totalExposure * modelData.portfolioAllocationStage1;
                const stage2Exposure = totalExposure * modelData.portfolioAllocationStage2;
                const stage3Exposure = totalExposure * modelData.portfolioAllocationStage3;
                
                eclByStage.stage1 = stage1Exposure * adjustedPDStage1 * modelData.lgd;
                eclByStage.stage2 = stage2Exposure * adjustedPDStage2 * modelData.lgd;
                eclByStage.stage3 = stage3Exposure * modelData.pdStage3 * modelData.lgd;
                totalECLForYear = eclByStage.stage1 + eclByStage.stage2 + eclByStage.stage3;
                
                log(`     📊      NIIF 9 PORTFOLIO ALLOCATIONS - Año ${currentYear}:`);
                log(`   Total exposure: ${formatCurrency(totalExposure)}`);
                log(`   Stage 1 (${(modelData.portfolioAllocationStage1*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage1)}`);
                log(`   Stage 2 (${(modelData.portfolioAllocationStage2*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage2)}`);
                log(`   Stage 3 (${(modelData.portfolioAllocationStage3*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage3)}`);
            }
            
            totalECLForYear *= modelData.economicAdjustmentFactor;
            eclByStage.stage1 *= modelData.economicAdjustmentFactor;
            eclByStage.stage2 *= modelData.economicAdjustmentFactor;
            eclByStage.stage3 *= modelData.economicAdjustmentFactor;
            
            const annualProvisionExpense = totalECLForYear * (modelData.proteccionRodando ? 0.5 : 1.0);
            
            let newProvisionsBalance = currentProvisionsBalance + annualProvisionExpense;
            
            const provisionesEsperadas = currentYearEndReceivables * (adjustedPDStage1 * modelData.portfolioAllocationStage1 +
                 adjustedPDStage2 * modelData.portfolioAllocationStage2 +
                 modelData.pdStage3 * modelData.portfolioAllocationStage3) * modelData.lgd * modelData.economicAdjustmentFactor;
            
            if (Math.abs(newProvisionsBalance - provisionesEsperadas) > 10000) {
                log("IFRS 9 provisions adjustment applied for consistency");
                newProvisionsBalance = provisionesEsperadas;
            }
            
            return {
                annualProvisionExpense: annualProvisionExpense,
                newProvisionsBalance: newProvisionsBalance,
                totalECLBeforeAdjustment: totalECLForYear,
                eclByStage: eclByStage
            };
        }
        
        function calculateNIIF15Revenue(loanCohorts, fixedAssetsCohorts, addedUnitsThisYear, currentYear) {
            let annualOriginationCommissionRecognized = 0;
            let totalContractLiabilitiesBalance = 0;
            loanCohorts.forEach(cohort => {
                let monthlyInterestRateClient = cohort.monthlyInterestRate;
                const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
                log(`  📋   NIIF 15 - Amortización comisiones en ${totalPaymentsMonthsClient} meses (${modelData.clientLoanTermYears} años)`);
                let currentRemainingPrincipal = cohort.startOfYearPrincipal;
                let initialPrincipal = cohort.originalPrincipal;
                let recognizedOriginationFromPrincipal = 0;
                let recognizedUpfrontCommission = 0;
                for (let m = 0; m < 12; m++) {
                    if (currentRemainingPrincipal <= 0 || cohort.paymentsMadeMonths + m >= totalPaymentsMonthsClient) {
                        break;
                    }
                    const interestThisMonth = currentRemainingPrincipal * monthlyInterestRateClient;
                    let principalThisMonth = cohort.monthlyPayment - interestThisMonth;
                    principalThisMonth = Math.min(principalThisMonth, currentRemainingPrincipal);
                    currentRemainingPrincipal -= principalThisMonth;
                    if (initialPrincipal > 0) {
                        const recognitionRatioThisMonth = principalThisMonth / initialPrincipal;
                        const recognizedByPrincipal = cohort.originationCommissionInitial * recognitionRatioThisMonth;
                        recognizedOriginationFromPrincipal += Math.min(recognizedByPrincipal, cohort.remainingOriginationCommission);
                    }
                    if (cohort.originalUpfrontLiability > 0) {
                        const monthlyUpfrontAmortization = cohort.originalUpfrontLiability / totalPaymentsMonthsClient;
                        recognizedUpfrontCommission += Math.min(monthlyUpfrontAmortization, cohort.remainingUpfrontLiability);
                    }
                }
                
                const actualRecognizedOrigination = Math.min(recognizedOriginationFromPrincipal, cohort.remainingOriginationCommission);
                const actualRecognizedUpfront = Math.min(recognizedUpfrontCommission, cohort.remainingUpfrontLiability);
                annualOriginationCommissionRecognized += (actualRecognizedOrigination + actualRecognizedUpfront);
                cohort.remainingOriginationCommission = Math.max(0, cohort.remainingOriginationCommission - actualRecognizedOrigination);
                cohort.remainingUpfrontLiability = Math.max(0, cohort.remainingUpfrontLiability - actualRecognizedUpfront);
                totalContractLiabilitiesBalance += cohort.remainingOriginationCommission;
                totalContractLiabilitiesBalance += cohort.remainingUpfrontLiability;
            });
            const totalActiveUnits = fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0);
            const gnvCommissions = totalActiveUnits * modelData.litrosPromedioMensualPorUnidad * 12 * modelData.precioLitroGNV * (modelData.comisionGNVPorcentaje / 100);
            const sparePartsCost = addedUnitsThisYear * modelData.refaccionesCostPerUnit;
            const sparePartsRevenue = sparePartsCost * (1 + modelData.margenRefacciones / 100);
            const marketplaceRevenue = totalActiveUnits * modelData.gmvPromedioMensualPorUnidad * 12 * (modelData.takeRateMarketplace / 100);
            
            return {
                recognizedOriginationRevenue: annualOriginationCommissionRecognized,
                gnvCommissions: gnvCommissions,
                sparePartsRevenue: sparePartsRevenue,
                sparePartsCOGS: sparePartsCost,
                marketplaceRevenue: marketplaceRevenue,
                contractLiabilitiesBalance: totalContractLiabilitiesBalance
            };
        }
        
        function manageNIIF5Assets(fixedAssetsCohorts, heldForSaleAssets, currentYear) {
            let totalImpairmentThisYear = 0;
            const totalOperationalUnits = fixedAssetsCohorts.reduce((sum, c) => sum + c.units, 0);
            let unitsToRepossess = Math.round(totalOperationalUnits * (modelData.tasaReposicion / 100));
            let remainingUnitsToRepossess = unitsToRepossess;
            
            let valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount = 0;
            let valueOfAssetsReclassifiedToNIIF5ThisYearFairValue = 0;
            let valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell = 0;
            let valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue = 0;
            fixedAssetsCohorts.sort((a, b) => a.yearAcquired - b.yearAcquired);
            for (let i = 0; i < fixedAssetsCohorts.length && remainingUnitsToRepossess > 0; i++) {
                let cohort = fixedAssetsCohorts[i];
                if (cohort.units > 0) {
                    const actualUnitsToRepossessFromThisCohort = Math.min(remainingUnitsToRepossess, cohort.units);
                    if (actualUnitsToRepossessFromThisCohort > 0) {
                        const proportionToRepossess = actualUnitsToRepossessFromThisCohort / cohort.units;
                        const repossessedOriginalCost = cohort.totalOriginalCost * proportionToRepossess;
                        const repossessedAccumulatedDepreciation = cohort.accumulatedDepreciation * proportionToRepossess;
                        const repossessedCarryingAmount = repossessedOriginalCost - repossessedAccumulatedDepreciation;
                        
                        const repossessedFairValue = repossessedOriginalCost * (modelData.fairValueVenta / 100);
                        const repossessedCostsToSell = repossessedFairValue * (modelData.costosVenta / 100);
                        const repossessedFairValueLessCosts = repossessedFairValue - repossessedCostsToSell;
                        
                        const impairmentForRepossessed = Math.max(0, repossessedCarryingAmount - repossessedFairValueLessCosts);
                        totalImpairmentThisYear += impairmentForRepossessed;
                        
                        cohort.units -= actualUnitsToRepossessFromThisCohort;
                        cohort.totalOriginalCost -= repossessedOriginalCost;
                        cohort.accumulatedDepreciation -= repossessedAccumulatedDepreciation;
                        
                        heldForSaleAssets.push({
                            units: actualUnitsToRepossessFromThisCohort,
                            originalCost: repossessedOriginalCost,
                            accumulatedDepreciation: repossessedAccumulatedDepreciation,
                            carryingAmountAtHFS: repossessedCarryingAmount,
                            currentFairValueLessCosts: repossessedFairValueLessCosts,
                            heldForSaleYear: currentYear,
                            impairmentRecorded: impairmentForRepossessed
                        });
                        remainingUnitsToRepossess -= actualUnitsToRepossessFromThisCohort;
                        
                        valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount += repossessedCarryingAmount;
                        valueOfAssetsReclassifiedToNIIF5ThisYearFairValue += repossessedFairValue;
                        valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell += repossessedCostsToSell;
                        valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue += repossessedFairValueLessCosts;
                    }
                }
            }
            
            fixedAssetsCohorts = fixedAssetsCohorts.filter(c => c.units > 0);
            
            const totalUnitsAccumulatedHeldForSale = heldForSaleAssets.reduce((sum, asset) => sum + asset.units, 0);
            const assetsHeldForSaleNet = heldForSaleAssets.reduce((sum, asset) => sum + asset.currentFairValueLessCosts, 0);
            return {
                impairmentExpense: totalImpairmentThisYear,
                niif5Details: {
                    unidadesClasificadasAnuales: unitsToRepossess - remainingUnitsToRepossess,
                    valorEnLibrosClasificado: valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount, 
                    valorRazonable: valueOfAssetsReclassifiedToNIIF5ThisYearFairValue,
                    costosDeVenta: valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell,
                    valorRazonableMenosCostos: valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue,
                    perdidaPorDeterioro: totalImpairmentThisYear,
                    saldoActivosParaVentaAcumulado: assetsHeldForSaleNet,
                    totalUnitsAccumulatedHeldForSale: totalUnitsAccumulatedHeldForSale
                },
                updatedFixedAssetsCohorts: fixedAssetsCohorts,
                updatedHeldForSaleAssets: heldForSaleAssets
            };
        }
        
        function calculateTimeWeightedAverage(startBalance, endBalance, capitalEvents = []) {
            if (!capitalEvents.length || Math.abs(startBalance - endBalance) < 0.01) {
                return (startBalance + endBalance) / 2;
            }
                
            let weightedSum = 0; 
            let totalMonths = 12;
            capitalEvents.sort((a, b) => a.month - b.month);
            let currentBalance = startBalance;
            let lastMonth = 0;
            if (capitalEvents[0] && capitalEvents[0].month > 0) {
                 weightedSum += currentBalance * capitalEvents[0].month;
                 lastMonth = capitalEvents[0].month;
            } else if (!capitalEvents[0]) {
                weightedSum += currentBalance * 12;
            }
            
            capitalEvents.forEach(event => {
                const monthsInPeriod = event.month - lastMonth;
                if (monthsInPeriod > 0) {
                    weightedSum += currentBalance * monthsInPeriod;
                }
                currentBalance += event.amount;
                lastMonth = event.month;
            });
            if (lastMonth < 12) {
                weightedSum += currentBalance * (12 - lastMonth);
            }
            
            return weightedSum / totalMonths;
        }
        function calculateAnnualDepreciation(fixedAssetsCohorts, currentYear) {
            let annualDepreciation = 0;
            fixedAssetsCohorts.forEach(cohort => {
                const yearsHeld = currentYear - cohort.yearAcquired;
                
                if (yearsHeld > 0 && modelData.depreciationYears > 0) {
                    const depreciationRate = 1 / modelData.depreciationYears;
                    const maxDepreciationPossible = cohort.totalOriginalCost - cohort.accumulatedDepreciation;
                    const depreciationThisYear = Math.min(cohort.totalOriginalCost * depreciationRate, maxDepreciationPossible);
                    
                    cohort.accumulatedDepreciation += depreciationThisYear;
                    annualDepreciation += depreciationThisYear;
                }
            });
            return annualDepreciation;
        }
        function calculateFinancials() {
            log('           🚀           STARTING FINANCIAL CALCULATIONS...');
            try {
                financialResults = { 
                    pl: [], cf: [], bs: [], niifDetails: [], 
                    tirProyecto: 0, tirCartera: 0, tirEquity: 0, 
                    roe: [], roic: [] 
                };
                heldForSaleAssets = [];
                
                const initialEquityInvestment = modelData.seriesA;
                
                let cash = initialEquityInvestment;
                let totalDebt = 0;
                let availableVentureDebtLine = modelData.ventureDebtLineMax;
                let currentProvisionsBalance = 0;
                let totalUnitsAccumulatedHeldForSale = 0;
                
                let endOfYearEquity = initialEquityInvestment;
                let loanCohorts = [];
                let fixedAssetsCohorts = [];
                
                const totalProjectInvestment = modelData.seriesA +
                                               modelData.seriesB_funding +
                                               modelData.seriesC_funding;
                const projectCashFlows = [-totalProjectInvestment];
                const equityCashFlows = [-initialEquityInvestment];
                log(`        📊         INITIAL INVESTMENTS FOR IRRs:`);
                log(`           🏢         PROJECT IRR (all series): ${formatCurrency(totalProjectInvestment)}`);
                log(`           💎         EQUITY IRR (only Series A): ${formatCurrency(initialEquityInvestment)}`);
                let portfolioCashFlows = [];
                portfolioCashFlows.push(0);
                
                for (let year = 0; year < 5; year++) {
                    log(`\n--- Calculating Year ${year + 1} ---`);
                    const addedUnits = modelData.unitsPerYear[year];
                    
                    const startOfYearEquity = endOfYearEquity;
                    const startOfYearTotalDebt = (year === 0) ? 0 : financialResults.bs[year-1].debt;
                    
                    loanCohorts.forEach(cohort => {
                        cohort.startOfYearPrincipal = cohort.remainingPrincipal;
                    });
                    const capexThisYear = addedUnits * getTotalPackageCost();
                    
                    if (addedUnits > 0) {
                        fixedAssetsCohorts.push({
                            yearAcquired: year + 1,
                            units: addedUnits,
                            originalCostPerUnit: getTotalPackageCost(),
                            totalOriginalCost: addedUnits * getTotalPackageCost(),
                            accumulatedDepreciation: 0
                        });
                    }
                    
                    const niif5Results = manageNIIF5Assets(fixedAssetsCohorts, heldForSaleAssets, year + 1);
                    fixedAssetsCohorts = niif5Results.updatedFixedAssetsCohorts;
                    heldForSaleAssets = niif5Results.updatedHeldForSaleAssets;
                    const impairment = niif5Results.impairmentExpense;
                    totalUnitsAccumulatedHeldForSale = niif5Results.niif5Details.totalUnitsAccumulatedHeldForSale;
                    
                    const annualDepreciation = calculateAnnualDepreciation(fixedAssetsCohorts, year + 1);
                    
                    let currentYearCashFromOrigination = 0;
                    let currentYearOriginationContractValue = 0;
                    let netLoanPrincipal = 0;
                    let downPaymentReceived = 0;
                    let upfrontCommissionReceived = 0;
                    if (addedUnits > 0) {
                        const newCohortGrossPrincipal = addedUnits * getTotalPackagePrice();
                        downPaymentReceived = newCohortGrossPrincipal * (modelData.downPaymentPercentage / 100);
                        upfrontCommissionReceived = newCohortGrossPrincipal * (modelData.upfrontCommissionPercentage / 100);
                        currentYearCashFromOrigination = downPaymentReceived + upfrontCommissionReceived;
                        netLoanPrincipal = newCohortGrossPrincipal - downPaymentReceived;
                        const monthlyInterestRateClient = (modelData.tasaInteres / 100) / 12;
                        const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
                        let monthlyPaymentClient = 0;
                        if (monthlyInterestRateClient > 0) {
                            monthlyPaymentClient = netLoanPrincipal * (monthlyInterestRateClient / (1 - Math.pow(1 + monthlyInterestRateClient, -totalPaymentsMonthsClient)));
                        } else {
                            monthlyPaymentClient = netLoanPrincipal / totalPaymentsMonthsClient;
                        }
                        const originationCommissionForThisCohort = netLoanPrincipal * (modelData.margenVagoneta / 100);
                        currentYearOriginationContractValue = originationCommissionForThisCohort;
                        
                        loanCohorts.push({
                            yearOriginated: year + 1,
                            originalPrincipal: netLoanPrincipal,
                            remainingPrincipal: netLoanPrincipal, 
                            startOfYearPrincipal: netLoanPrincipal,
                            paymentsMadeMonths: 0,
                            monthlyPayment: monthlyPaymentClient,
                            monthlyInterestRate: monthlyInterestRateClient,
                            totalLoanTermMonths: totalPaymentsMonthsClient,
                            originationCommissionInitial: originationCommissionForThisCohort,
                            remainingOriginationCommission: originationCommissionForThisCohort,
                            originalUpfrontLiability: upfrontCommissionReceived,
                            remainingUpfrontLiability: upfrontCommissionReceived,
                            avgExposureDuringYear: 0
                        });
                    }
                    
                    let annualInterestReceived = 0;
                    let annualPrincipalReceived = 0;
                    let currentYearEndReceivables = 0;
                    loanCohorts.forEach(cohort => {
                        let monthlyWeightedExposureSum = 0;
                        let tempPrincipalForECL = cohort.startOfYearPrincipal;
                        for (let m = 0; m < 12; m++) {
                            monthlyWeightedExposureSum += tempPrincipalForECL;
                            
                            if (cohort.paymentsMadeMonths >= cohort.totalLoanTermMonths && cohort.remainingPrincipal <= 0) {
                                break;
                            }
                            const interestThisMonth = cohort.remainingPrincipal * cohort.monthlyInterestRate;
                            let principalThisMonth = cohort.monthlyPayment - interestThisMonth;
                            principalThisMonth = Math.min(principalThisMonth, cohort.remainingPrincipal);
                            
                            annualInterestReceived += interestThisMonth;
                            annualPrincipalReceived += principalThisMonth;
                            cohort.remainingPrincipal -= principalThisMonth;
                            cohort.paymentsMadeMonths++;
                            if (tempPrincipalForECL > 0 && cohort.monthlyPayment > 0) {
                                const tempMonthlyInterest = tempPrincipalForECL * cohort.monthlyInterestRate;
                                const tempMonthlyPrincipalPayment = Math.min(cohort.monthlyPayment - tempMonthlyInterest, tempPrincipalForECL);
                                tempPrincipalForECL -= tempMonthlyPrincipalPayment;
                                tempPrincipalForECL = Math.max(0, tempPrincipalForECL);
                            }
                        }
                        cohort.avgExposureDuringYear = monthlyWeightedExposureSum / 12;
                        currentYearEndReceivables += Math.max(0, cohort.remainingPrincipal);
                    });
                    
                    const niif9Results = calculateNIIF9ECL(loanCohorts, year + 1, currentProvisionsBalance, currentYearEndReceivables);
                    const provisions = niif9Results.annualProvisionExpense;
                    currentProvisionsBalance = niif9Results.newProvisionsBalance;
                    
                    const niif15Results = calculateNIIF15Revenue(loanCohorts, fixedAssetsCohorts, addedUnits, year + 1);
                    const originationCommission = niif15Results.recognizedOriginationRevenue;
                    const gnvCommissions = niif15Results.gnvCommissions;
                    const sparePartsRevenue = niif15Results.sparePartsRevenue;
                    const sparePartsCOGS = niif15Results.sparePartsCOGS || 0;
                    const marketplaceRevenue = niif15Results.marketplaceRevenue;
                    const contractLiabilitiesBalance = niif15Results.contractLiabilitiesBalance;
                    
                    const interestRevenue = annualInterestReceived;
                    const totalRevenue = interestRevenue + originationCommission + gnvCommissions + sparePartsRevenue + marketplaceRevenue;
                    const totalCOGS = sparePartsCOGS;
                    const grossProfit = totalRevenue - totalCOGS;
                    const opex = totalRevenue * (modelData.opexRate / 100);
                    const ebitda = grossProfit - opex - provisions - impairment;
                    const ebit = ebitda - annualDepreciation;
                    
                    let ventureDebtBalance = 0;
                    let commercialDebtBalance = 0;
                    for (let i = 1; i <= year + 1; i++) {
                        const vdAmount = getOptimizedVentureDebt(i);
                        if (vdAmount > 0) {
                            const yearsElapsed = (year + 1) - i;
                            const amortizationFactor = Math.max(0, (optimizedFinancialStructure.ventureDebt.amortizationYears - yearsElapsed) / optimizedFinancialStructure.ventureDebt.amortizationYears);
                            ventureDebtBalance += vdAmount * amortizationFactor;
                        }
                    }
                    for (let i = 1; i <= year + 1; i++) {
                        commercialDebtBalance += getOptimizedCommercialDebt(i);
                    }
                    const ventureDebtInterest = ventureDebtBalance * (modelData.ventureDebtRate / 100);
                    const commercialDebtInterest = commercialDebtBalance * (modelData.commercialDebtRate / 100);
                    const interestExpense = ventureDebtInterest + commercialDebtInterest;
                    
                    const earningsBeforeTax = ebit - interestExpense;
                    const incomeTaxExpense = Math.max(0, earningsBeforeTax) * (modelData.corporateTaxRate / 100);
                    const netIncome = earningsBeforeTax - incomeTaxExpense; // Impairment is already in EBITDA
                    
                    const prevReceivablesBalance = (year === 0) ? 0 : financialResults.bs[year-1].receivables;
                    const deltaReceivables = currentYearEndReceivables - prevReceivablesBalance;
                    const prevContractLiabilities = (year === 0) ? 0 : financialResults.bs[year-1].contractLiabilities;
                    const deltaContractLiabilities = contractLiabilitiesBalance - prevContractLiabilities;
                    const prevProvisionsBalance = (year === 0) ? 0 : financialResults.bs[year-1].provisions;
                    const deltaProvisions = currentProvisionsBalance - prevProvisionsBalance; 
                    const operatingCash = netIncome + annualDepreciation + impairment + deltaProvisions - deltaReceivables + deltaContractLiabilities;
                    const investingCash = -capexThisYear; 
                    
                    // ================== CORRECCIÓN 2: Lógica del Flujo de Efectivo de Financiación ==================
                    // Primero, se calculan las variables necesarias para el pago de principal.
                    const endOfYearVentureDebtBalance = ventureDebtBalance;
                    const endOfYearCommercialDebtBalance = commercialDebtBalance;
                    const endOfYearTotalDebt = endOfYearVentureDebtBalance + endOfYearCommercialDebtBalance;
                    const newVentureDebtDrawdown = getOptimizedVentureDebt(year + 1);
                    const newCommercialDebtDrawdown = getOptimizedCommercialDebt(year + 1);
                    
                    // El pago de principal es: Saldo Inicial + Nueva Deuda - Saldo Final
                    const debtPrincipalPayment = startOfYearTotalDebt + newVentureDebtDrawdown + newCommercialDebtDrawdown - endOfYearTotalDebt;
                    
                    // Segundo, se corrige el cálculo del flujo de financiación.
                    let financingCashThisPeriod = 0;
                    let newEquityInjectionsThisYear = 0;
                    
                    let newEquityThisYear = getOptimizedCapitalCall(year + 1);
                    
                    // El flujo es: Entradas de Capital + Entradas de Deuda - Pagos de Principal de Deuda
                    financingCashThisPeriod = newEquityThisYear + newVentureDebtDrawdown + newCommercialDebtDrawdown - debtPrincipalPayment;
                    newEquityInjectionsThisYear += newEquityThisYear;
                    // ================== FIN DE LA CORRECCIÓN 2 ==================
                                       
                    let netCash = operatingCash + investingCash + financingCashThisPeriod;
                    cash += netCash; 
                    
                    endOfYearEquity = startOfYearEquity + netIncome + newEquityInjectionsThisYear;
                    totalDebt = endOfYearTotalDebt; // Asegurarse de que el saldo total de deuda esté actualizado
                    
                    let totalOriginalCostPPandE = fixedAssetsCohorts.reduce((sum, c) => sum + c.totalOriginalCost, 0);
                    let totalAccumulatedDepreciationPPandE = fixedAssetsCohorts.reduce((sum, c) => sum + c.accumulatedDepreciation, 0);
                    const fixedAssetsNet = totalOriginalCostPPandE - totalAccumulatedDepreciationPPandE;
                    const assetsHeldForSaleNet = heldForSaleAssets.reduce((sum, asset) => sum + asset.currentFairValueLessCosts, 0);
                    
                    const totalAssets = cash + currentYearEndReceivables + fixedAssetsNet + assetsHeldForSaleNet; 
                    const totalLiabilities = totalDebt + currentProvisionsBalance + contractLiabilitiesBalance;
                    let totalLiabilitiesEquity = totalLiabilities + endOfYearEquity;
                    const balanceDiff = totalAssets - totalLiabilitiesEquity;
                    if (Math.abs(balanceDiff) > BALANCE_TOLERANCE) {
                      endOfYearEquity += balanceDiff;
                      totalLiabilitiesEquity = totalLiabilities + endOfYearEquity;
                      log(`Equity adjustment applied: ${formatCurrency(balanceDiff)}`);
                    }
                    if (Math.abs(totalAssets - totalLiabilitiesEquity) > BALANCE_TOLERANCE) {
                        throw new Error(`Balance Sheet unbalanced in Year ${year + 1}. Difference: ${formatCurrency(balanceDiff)}.`);
                    }
                    
                    const capitalEvents = [];
                    if (newEquityThisYear > 0) {
                        capitalEvents.push({ month: 6, amount: newEquityThisYear }); 
                    }
                    const averageEquity = calculateTimeWeightedAverage(startOfYearEquity, endOfYearEquity, capitalEvents);
                    const averageInvestedCapital = calculateTimeWeightedAverage(
                        startOfYearEquity + startOfYearTotalDebt, 
                        endOfYearEquity + totalDebt, 
                        capitalEvents
                    );
                    
                    let annualROE = (averageEquity !== 0) ? (netIncome / averageEquity) * 100 : 0;
                    const nopat = ebit * (1 - (modelData.corporateTaxRate / 100)); 
                    let annualROIC = (averageInvestedCapital !== 0) ? (nopat / averageInvestedCapital) * 100 : 0;
                    financialResults.roe.push(annualROE);
                    financialResults.roic.push(annualROIC);
                    
                    financialResults.pl.push({
                        interestRevenue, originationCommission, gnvCommissions, sparePartsRevenue, marketplaceRevenue, totalRevenue,
                        totalCOGS, grossProfit, opex, provisions, impairment, ebitda, ebit,
                        depreciation: annualDepreciation, interestExpense, earningsBeforeTax, incomeTaxExpense, netIncome,
                        cumulativeUnits: fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0)
                    });
                    financialResults.cf.push({
                        operatingCash, investingCash, financingCash: financingCashThisPeriod, netCash,
                        clientPrincipalPaymentsReceived: annualPrincipalReceived,
                        downPaymentReceived: downPaymentReceived,
                        upfrontCommissionReceived: upfrontCommissionReceived,
                        currentYearVentureDebtDraw: newVentureDebtDrawdown,
                        additionalFundingRaised: newCommercialDebtDrawdown,
                        deltaContractLiabilities: deltaContractLiabilities,
                        deltaProvisions: deltaProvisions,
                        incomeTaxPaid: incomeTaxExpense,
                        debtPrincipalPaid: debtPrincipalPayment
                    });
                    financialResults.bs.push({
                        cash, receivables: currentYearEndReceivables, fixedAssets: fixedAssetsNet, 
                        assetsHeldForSale: assetsHeldForSaleNet, totalAssets,
                        debt: totalDebt, provisions: currentProvisionsBalance, 
                        contractLiabilities: contractLiabilitiesBalance, 
                        totalLiabilities: totalLiabilities, equity: endOfYearEquity, 
                        totalLiabilitiesEquity
                    });
                    
                    financialResults.niifDetails.push({
                        niif15: {
                            totalContractValueFromPerformanceObligations: currentYearOriginationContractValue + gnvCommissions + sparePartsRevenue + marketplaceRevenue,
                            originationContractValueInitial: currentYearOriginationContractValue,
                            recognizedOriginationRevenue: originationCommission, 
                            contractLiabilitiesBalance: contractLiabilitiesBalance, 
                            gnvCommissions: gnvCommissions,
                            sparePartsRevenue: sparePartsRevenue,
                            sparePartsCOGS: sparePartsCOGS,
                            marketplaceRevenue: marketplaceRevenue,
                            upfrontCommissionInitial: upfrontCommissionReceived,
                        },
                        niif9: {
                            totalOutstandingPrincipal: currentYearEndReceivables,
                            totalECLBeforeAdjustment: niif9Results.totalECLBeforeAdjustment,
                            eclByStage: niif9Results.eclByStage,
                            economicAdjustmentFactor: modelData.economicAdjustmentFactor,
                            provisionesSinProteccion: niif9Results.totalECLBeforeAdjustment,
                            provisionesConProteccion: provisions, 
                            reduccionPorProteccion: niif9Results.totalECLBeforeAdjustment - provisions,
                            saldoProvisionesAcumulado: currentProvisionsBalance, 
                            proteccionRodandoActiva: modelData.proteccionRodando,
                            pdStage1: modelData.pdStage1,
                            pdStage2: modelData.pdStage2,
                            pdStage3: modelData.pdStage3,
                            lgd: modelData.lgd
                        },
                        niif5: niif5Results.niif5Details
                    });
                    
                    let portfolioCashFlowThisYear = 0;
                    if (addedUnits > 0) {
                        portfolioCashFlowThisYear -= netLoanPrincipal;
                    }
                    portfolioCashFlowThisYear += annualInterestReceived + annualPrincipalReceived;
                    if (year === 4) {
                        const finalReceivablesValue = currentYearEndReceivables;
                        const discountRate = modelData.tasaInteres / 100;
                        const avgRemainingTerm = modelData.avgRemainingTermCartera; 
                        const presentValueOfResidual = finalReceivablesValue / Math.pow(1 + discountRate, avgRemainingTerm);
                        portfolioCashFlowThisYear += presentValueOfResidual;
                    }
                    portfolioCashFlows.push(portfolioCashFlowThisYear);
                    const fcfeForTIR = nopat + annualDepreciation + impairment - capexThisYear - deltaReceivables + deltaContractLiabilities + newVentureDebtDrawdown + newCommercialDebtDrawdown - debtPrincipalPayment;
                    equityCashFlows.push(fcfeForTIR);
                    const fcffThisYear = nopat + annualDepreciation + impairment + deltaProvisions - capexThisYear - deltaReceivables + deltaContractLiabilities; 
                    projectCashFlows.push(fcffThisYear);
                }
                
                const year5EBITDA = financialResults.pl[4].ebitda;
                const terminalValueProject = year5EBITDA * modelData.ebitdaMultipleProject;
                projectCashFlows[projectCashFlows.length - 1] += terminalValueProject;
                const enterpriseValue = year5EBITDA * modelData.ebitdaMultipleEquity;
                const terminalValueEquity = Math.max(
                    enterpriseValue - financialResults.bs[4].debt,
                    financialResults.bs[4].equity * modelData.floorEquityMultiple
                );
                equityCashFlows[equityCashFlows.length - 1] += terminalValueEquity;
                
                financialResults.tirProyecto = calculateIRR(projectCashFlows);
                financialResults.tirCartera = calculateIRR(portfolioCashFlows) || 0;
                financialResults.tirEquity = calculateIRR(equityCashFlows);
                
                log('           ✅           FINANCIAL CALCULATIONS COMPLETED CORRECTLY');
                return true; 
                
            } catch (error) {
                log(`           ❌           ERROR in calculateFinancials: ${error.message}`);
                console.error('Critical error in financial calculations:', error);
                document.getElementById('balance-validation').innerHTML = `<span class="text-red-600">           ❌           ${error.message}</span>`;
                return false; 
            }
        }
        function calculateIRR(cashFlows, maxIterations = 500, tolerance = 1e-7) {
            if (!cashFlows || cashFlows.length < 2 || !cashFlows.some(cf => cf > 0) || !cashFlows.some(cf => cf < 0)) {
                return 0;
            }
            
            let guess = 0.10, low = -0.99, high = 5.0;
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0, dNpv = 0;
                for (let t = 0; t < cashFlows.length; t++) {
                    npv += cashFlows[t] / Math.pow(1 + guess, t);
                    if (t > 0) dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                }
                
                if (Math.abs(npv) < tolerance) return Math.max(-99, Math.min(500, guess * 100));
                if (dNpv === 0) break; 
                
                let newGuess = guess - npv / dNpv;
                guess = Math.max(low, Math.min(high, newGuess));
                if (npv > 0) low = guess; else high = guess;
                if (high - low < tolerance) {
                    return Math.max(-99, Math.min(500, ((low + high) / 2) * 100));
                }
            }
            return Math.max(-99, Math.min(500, guess * 100));
        }
        function updateUI() {
            log('           🔄           Updating User Interface...');
            try {
                if (!financialResults.pl || financialResults.pl.length === 0) {
                    log('           ❌           No financial data to update UI.');
                    return;
                }
                
                const year5PL = financialResults.pl[4];
                const year5BS = financialResults.bs[4];
                const totalUnitsAcquired = modelData.unitsPerYear.reduce((acc, curr) => acc + curr, 0);
                const vagonetasOperativas = totalUnitsAcquired - (financialResults.niifDetails[4]?.niif5?.totalUnitsAccumulatedHeldForSale || 0);
                
                if (year5PL && year5BS) {
                    document.getElementById('ebitda-year5').textContent = formatCurrency(year5PL.ebitda);
                    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                    // ================== CORRECCIÓN DEL ERROR ==================
                    // La siguiente línea ha sido eliminada porque el elemento 'tir-cartera' ya no existe en el HTML.
                    // document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                    document.getElementById('tir-equity').textContent = financialResults.tirEquity.toFixed(1) + '%';
                    document.getElementById('vagonetas-operativas').textContent = Math.round(vagonetasOperativas);
                    document.getElementById('roe-year5').textContent = financialResults.roe[4].toFixed(1) + '%';
                    document.getElementById('roic-year5').textContent = financialResults.roic[4].toFixed(1) + '%';
                }
                
                updateTables(); 
                updateNIIFTables(); 
                updateCharts(); 
                const validations = validateModelComprehensively(modelData, financialResults);
                updateValidationPanel(validations);
                updateOptimizationStatus();
                
            } catch (error) {
                log(`           ❌           Error in updateUI: ${error.message}`);
                console.error('Error updating UI:', error);
            }
        }
        function updateTables() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
        }
        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody || !financialResults.pl.length) return;
            tbody.innerHTML = ''; 
            
            const rows = [
                { label: 'Ingresos por Intereses', key: 'interestRevenue' },
                { label: 'Margen por Originación (NIIF 15)', key: 'originationCommission' },
                { label: 'Comisiones GNV (NIIF 15)', key: 'gnvCommissions' },
                { label: 'Ingresos Refacciones (NIIF 15)', key: 'sparePartsRevenue' },
                { label: 'Ingresos Marketplace (NIIF 15)', key: 'marketplaceRevenue' },
                { label: 'Total Ingresos Operativos', key: 'totalRevenue', total: true },
                { label: 'COGS Refacciones', key: 'totalCOGS', negative: true, fromPL: true },
                { label: 'Utilidad Bruta', key: 'grossProfit', total: true },
                { label: 'Gastos Operativos (OPEX)', key: 'opex', negative: true },
                { label: 'Provisiones NIIF 9', key: 'provisions', negative: true },
                { label: 'Pérdida por Deterioro NIIF 5', key: 'impairment', negative: true },
                { label: 'EBITDA', key: 'ebitda', total: true, emphasize: true },
                { label: 'Depreciación', key: 'depreciation', negative: true },
                { label: 'EBIT', key: 'ebit', total: true },
                { label: 'Gastos por Intereses (Deuda)', key: 'interestExpense', negative: true },
                { label: 'Ganancia Antes de Impuestos (EBT)', key: 'earningsBeforeTax', total: true },
                { label: 'Impuesto sobre la Renta', key: 'incomeTaxExpense', negative: true },
                { label: 'Utilidad Neta', key: 'netIncome', total: true, emphasize: true }
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-slate-800', 'font-bold');
                tr.innerHTML = `<td>${row.label}</td>` + financialResults.pl.map(yearData => {
                    const value = yearData[row.key] || 0;
                    const isNegative = row.negative && value > 0;
                    const content = isNegative ? `(${formatCurrency(value)})` : formatCurrency(value);
                    let colorClass = 'text-slate-200';
                    if (value > 0 && !isNegative) colorClass = 'positive';
                    if (value < 0 || isNegative) colorClass = 'negative';
                    if (value === 0) colorClass = 'text-slate-400';
                    return `<td class="${colorClass}">${content}</td>`;
                }).join('');
                tbody.appendChild(tr);
            });
        }
        
        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody || !financialResults.cf.length) return;
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'FLUJO DE EFECTIVO OPERATIVO', total: true, emphasize: true },
                { label: '  Utilidad Neta', key: 'netIncome', fromPL: true },
                { label: '  + Depreciación', key: 'depreciation', fromPL: true },
                { label: '  + Pérdida por Deterioro NIIF 5', key: 'impairment', fromPL: true },
                { label: '  + Δ Provisiones (NIIF 9)', key: 'deltaProvisions', fromCF: true, positive: true }, 
                { label: '  - Δ Cuentas por Cobrar', key: 'receivables', deltaFromBS: true, negative: true }, 
                { label: '  + Δ Pasivos Contractuales (NIIF 15)', key: 'deltaContractLiabilities', fromCF: true, positive: true }, 
                { label: 'TOTAL FLUJO DE EFECTIVO OPERATIVO', key: 'operatingCash', total: true, emphasize: true },
                { label: 'FLUJO DE EFECTIVO DE INVERSIÓN', total: true, separator: true, emphasize: true },
                { label: '  - CAPEX Vagonetas (Activos Fijos)', key: 'investingCash', negative: true, fromCF: true}, 
                { label: 'TOTAL FLUJO DE EFECTIVO DE INVERSIÓN', key: 'investingCash', total: true, emphasize: true, duplicate: true },
                { label: 'FLUJO DE EFECTIVO DE FINANCIACIÓN', total: true, separator: true, emphasize: true },
                { label: '  Capital Call Recibido', fromModelData: true, yearSpecific: true, key: 'capitalCall' },
                { label: '  Venture Debt Recibido', key: 'currentYearVentureDebtDraw', fromCF: true, positive: true },
                { label: '  Deuda Comercial Recibida', key: 'additionalFundingRaised', fromCF: true, positive: true },
                { label: '  - Pago de Principal Deuda', key: 'debtPrincipalPaid', fromCF: true, negative: true },
                { label: 'TOTAL FLUJO DE EFECTIVO DE FINANCIACIÓN', key: 'financingCash', total: true, emphasize: true, duplicate: true },
                { label: 'INCREMENTO NETO DE EFECTIVO', key: 'netCash', total: true, separator: true, emphasize: true },
                { label: 'SALDO DE EFECTIVO AL FINAL DEL PERIODO', key: 'cash', fromBS: true, total: true, emphasize: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-slate-800', 'font-bold');
                if (row.separator) tr.classList.add('border-t-2', 'border-slate-700');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                tr.appendChild(labelCell);
                
                // Year 0 Cell
                const cell0 = document.createElement('td');
                if (row.key === 'netCash' || row.key === 'cash') {
                     cell0.textContent = formatCurrency(modelData.seriesA);
                     cell0.classList.add('positive');
                } else {
                    cell0.textContent = '-'; 
                    cell0.classList.add('text-slate-400');
                }
                tr.appendChild(cell0);
                
                // Years 1-5 Cells
                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value;
                    if (row.fromPL) value = financialResults.pl[i][row.key];
                    else if (row.fromBS) value = financialResults.bs[i][row.key];
                    else if (row.fromCF) value = financialResults.cf[i][row.key];
                    else if (row.deltaFromBS) {
                        const prevValue = (i === 0) ? 0 : financialResults.bs[i-1][row.key];
                        value = financialResults.bs[i][row.key] - prevValue;
                    } else if (row.fromModelData) {
                        if (row.key === 'capitalCall') value = getOptimizedCapitalCall(i + 1);
                        else value = 0;
                    } else {
                        value = financialResults.cf[i][row.key] || 0;
                    }
                    
                    const isNegative = row.negative && value > 0;
                    value = isNegative ? -value : value; // Make it negative for display logic
                    cell.textContent = value < 0 ? `(${formatCurrency(Math.abs(value))})` : formatCurrency(value);

                    let colorClass = 'text-slate-200';
                    if (value > 0) colorClass = 'positive';
                    if (value < 0) colorClass = 'negative';
                    if (value === 0) colorClass = 'text-slate-400';
                    cell.classList.add(colorClass);
                    tr.appendChild(cell);
                }
                tbody.appendChild(tr);
            });
        }
        
        //  ✅  ================== PASO 3.1: CORREGIR Bug de Visualización del Balance ==================
        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody || !financialResults.bs.length) return;
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'ACTIVOS', total: true, emphasize: true },
                { label: '  Efectivo y Equivalentes', key: 'cash' },
                { label: '  Cuentas por Cobrar (Principal)', key: 'receivables' },
                { label: '  Activos Fijos Netos (Vagonetas)', key: 'fixedAssets' },
                { label: '  Activos Mantenidos para Venta (NIIF 5)', key: 'assetsHeldForSale' },
                { label: 'TOTAL ACTIVOS', key: 'totalAssets', total: true, emphasize: true }, //  ✅  CORRECCIÓN
                { label: 'PASIVOS Y PATRIMONIO', total: true, separator: true, emphasize: true },
                { label: '  Deuda Financiera', key: 'debt' },
                { label: '  Provisiones NIIF 9 (Acumuladas)', key: 'provisions' },
                { label: '  Pasivos por Contrato (NIIF 15)', key: 'contractLiabilities' },
                { label: 'TOTAL PASIVOS', key: 'totalLiabilities', total: true }, 
                { label: '  Patrimonio', key: 'equity' },
                { label: 'TOTAL PASIVOS + PATRIMONIO', key: 'totalLiabilitiesEquity', total: true, emphasize: true }
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-slate-800', 'font-bold');
                if (row.separator) tr.classList.add('border-t-2', 'border-slate-700');
                tr.innerHTML = `<td>${row.label}</td>` + financialResults.bs.map(yearData => {
                    const value = yearData[row.key] || 0;
                    let colorClass = 'text-slate-200';
                    if (value > 0) colorClass = 'positive';
                    if (value < 0) colorClass = 'negative';
                    if (value === 0) colorClass = 'text-slate-400';
                    return `<td class="${colorClass}">${formatCurrency(value)}</td>`;
                }).join('');
                tbody.appendChild(tr);
            });
            
            const validationDiv = document.getElementById('balance-validation');
            const lastYearBS = financialResults.bs[financialResults.bs.length - 1];
            const difference = Math.abs(lastYearBS.totalAssets - lastYearBS.totalLiabilitiesEquity);
            if (difference <= BALANCE_TOLERANCE) {
                validationDiv.innerHTML = '<span class="text-green-400"> ✅  Balance validado: Total Activos = Total Pasivos + Patrimonio.</span>';
                validationDiv.className = 'mt-4 text-center font-semibold p-2 rounded-lg bg-emerald-950';
            } else {
                validationDiv.innerHTML = `<span class="text-rose-400"> ❌  Error de Balance: Diferencia de ${formatCurrency(difference)}.</span>`;
                validationDiv.className = 'mt-4 text-center font-semibold p-2 rounded-lg bg-rose-950';
            }
        }
        
        function updateNIIFTables() {
            if (!financialResults.niifDetails || financialResults.niifDetails.length === 0) return;
            const container15 = document.getElementById('niif15-container');
            if(container15) {
              container15.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead><tr><th>Concepto</th>${[1,2,3,4,5].map(y => `<th>Año ${y}</th>`).join('')}</tr></thead>
                            <tbody>
                                <tr><td>Margen Originación (Reconocido P&L)</td>${financialResults.niifDetails.map(d => `<td class="positive">${formatCurrency(d.niif15.recognizedOriginationRevenue)}</td>`).join('')}</tr>
                                <tr><td>Pasivos por Contrato (Acumulado)</td>${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.contractLiabilitiesBalance)}</td>`).join('')}</tr>
                                <tr><td>Ingresos Servicios (GNV, Refacciones, etc.)</td>${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.gnvCommissions + d.niif15.sparePartsRevenue + d.niif15.marketplaceRevenue)}</td>`).join('')}</tr>
                            </tbody>
                        </table>
                    </div>`;
            }
            const container9 = document.getElementById('niif9-container');
            const year5NIIF9 = financialResults.niifDetails[4]?.niif9;
            if (container9 && year5NIIF9) {
                 container9.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-center">
                            <div class="p-3 bg-sky-950 rounded-lg"><h5 class="font-semibold text-sky-400">ECL Etapa 1 (Año 5)</h5><p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage1)}</p></div>
                            <div class="p-3 bg-amber-950 rounded-lg"><h5 class="font-semibold text-amber-400">ECL Etapa 2 (Año 5)</h5><p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage2)}</p></div>
                            <div class="p-3 bg-rose-950 rounded-lg"><h5 class="font-semibold text-rose-400">ECL Etapa 3 (Año 5)</h5><p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage3)}</p></div>
                        </div>
                        <div class="mt-4 text-center p-3 bg-slate-900 rounded-lg">
                             <h5 class="font-semibold text-slate-400">Saldo Acumulado Provisiones (Balance Año 5)</h5>
                             <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.saldoProvisionesAcumulado)}</p>
                        </div>`;
            }
            const container5 = document.getElementById('niif5-container');
            const year5NIIF5 = financialResults.niifDetails[4]?.niif5;
            if(container5 && year5NIIF5) {
                 container5.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-center">
                            <div class="p-3 bg-purple-950 rounded-lg"><h5 class="font-semibold text-purple-400">Unidades Reposadas (Año 5)</h5><p class="text-xl font-bold">${year5NIIF5.unidadesClasificadasAnuales.toFixed(0)}</p></div>
                            <div class="p-3 ${year5NIIF5.perdidaPorDeterioro > 0 ? 'bg-rose-950' : 'bg-emerald-950'} rounded-lg"><h5 class="font-semibold ${year5NIIF5.perdidaPorDeterioro > 0 ? 'text-rose-400' : 'text-emerald-400'}">Pérdida por Deterioro (Año 5)</h5><p class="text-xl font-bold">${formatCurrency(year5NIIF5.perdidaPorDeterioro)}</p></div>
                        </div>
                         <div class="mt-4 text-center p-3 bg-slate-900 rounded-lg">
                             <h5 class="font-semibold text-slate-400">Saldo Acumulado Activos NIIF 5 (Balance Año 5)</h5>
                             <p class="text-2xl font-bold">${formatCurrency(year5NIIF5.saldoActivosParaVentaAcumulado)}</p>
                         </div>`;
            }
        }
        
        function initializeCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            const commonOptions = {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { display: false },
                    x: { display: false }
                },
                plugins: { 
                    legend: { display: false } 
                }
            };
            const commonOptionsWithScales = {
                ...commonOptions,
                scales: { 
                    y: { display: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                    x: { display: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                },
                plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 } } } }
            };

            // ================== INICIALIZACIÓN DEL NUEVO GRÁFICO ==================
            charts.incomeMix = new Chart(document.getElementById('incomeMixChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Intereses', 'Comisión GNV', 'Marketplace', 'Originación', 'Refacciones'],
                    datasets: [{
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'],
                        borderColor: '#0f172a',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    ...commonOptions,
                     cutout: '60%',
                     plugins: {
                        legend: {
                            position: 'right',
                            labels: { 
                                color: '#94a3b8',
                                boxWidth: 12,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });

            charts.tirSensitivity = new Chart(document.getElementById('tirSensitivityChart'), { type: 'scatter', data: { datasets: [] }, options: {...commonOptionsWithScales, scales: { x: { title: { display: true, text: 'EBITDA Multiple', color: '#94a3b8'}}, y: { title: { display: true, text: 'Floor Multiple', color: '#94a3b8'}}}} });
            charts.proteccion = new Chart(document.getElementById('proteccionChart'), { type: 'bar', data: { labels: ['A1', 'A2', 'A3', 'A4', 'A5'], datasets: [{ label: 'Sin Prot.', backgroundColor: '#ef4444' }, { label: 'Con Prot.', backgroundColor: '#10b981' }] }, options: commonOptionsWithScales });
            charts.portfolio = new Chart(document.getElementById('portfolioChart'), { type: 'line', data: { labels: ['A1', 'A2', 'A3', 'A4', 'A5'], datasets: [{ label: 'ECL S1', borderColor: '#10b981' }, { label: 'ECL S2', borderColor: '#f59e0b' }, { label: 'ECL S3', borderColor: '#ef4444' }] }, options: commonOptionsWithScales });
            charts.unitEconomics = new Chart(document.getElementById('unitEconomicsChart'), { type: 'doughnut', data: { labels: ['Revenue/Unit', 'Cost/Unit', 'Margin/Unit'], datasets: [{ backgroundColor: ['#3b82f6', '#ef4444', '#10b981'] }] }, options: {...commonOptionsWithScales, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }} });
            charts.cashSources = new Chart(document.getElementById('cashSourcesChart'), { type: 'bar', data: { labels: ['A1', 'A2', 'A3', 'A4', 'A5'], datasets: [{ label: 'Op CF', backgroundColor: '#10b981' }, { label: 'Inv CF', backgroundColor: '#ef4444' }, { label: 'Fin CF', backgroundColor: '#3b82f6' }] }, options: {...commonOptionsWithScales, scales: {...commonOptionsWithScales.scales, y: {stacked: true}, x: {stacked: true}}} });
            charts.diversification = new Chart(document.getElementById('diversificationChart'), { type: 'line', data: { labels: ['A1', 'A2', 'A3', 'A4', 'A5'], datasets: [{ label: 'Diversification Index', borderColor: '#3b82f6', fill: true }] }, options: {...commonOptionsWithScales, plugins: { legend: {display: false}}, scales: {...commonOptionsWithScales.scales, y: {min: 0, max: 1}}} });
        }
        
        function updateCharts() {
            if (!financialResults.pl.length) return;
            
             // ================== ACTUALIZACIÓN DEL NUEVO GRÁFICO ==================
            if (charts.incomeMix) {
                const year5PL = financialResults.pl[4];
                if(year5PL) {
                    charts.incomeMix.data.datasets[0].data = [
                        year5PL.interestRevenue,
                        year5PL.gnvCommissions,
                        year5PL.marketplaceRevenue,
                        year5PL.originationCommission,
                        year5PL.sparePartsRevenue
                    ].map(v => Math.max(0, v)); // Asegura que no haya valores negativos
                }
            }
            
            //  ✅  CORRECCIÓN: Añadir verificaciones para asegurar que los objetos de los gráficos existan
            if (charts.proteccion) {
                charts.proteccion.data.datasets[0].data = financialResults.niifDetails.map(d => d.niif9.provisionesSinProteccion / 1e6);
                charts.proteccion.data.datasets[1].data = financialResults.niifDetails.map(d => d.niif9.provisionesConProteccion / 1e6);
            }
            if (charts.portfolio) {
                charts.portfolio.data.datasets[0].data = financialResults.niifDetails.map(d => d.niif9.eclByStage.stage1 / 1e6);
                charts.portfolio.data.datasets[1].data = financialResults.niifDetails.map(d => d.niif9.eclByStage.stage2 / 1e6);
                charts.portfolio.data.datasets[2].data = financialResults.niifDetails.map(d => d.niif9.eclByStage.stage3 / 1e6);
            }
            if (charts.unitEconomics) {
                charts.unitEconomics.data.datasets[0].data = [getTotalPackagePrice(), getTotalPackageCost(), getTotalPackagePrice() - getTotalPackageCost()].map(v => v/1000);
            }
            if (charts.cashSources) {
                charts.cashSources.data.datasets[0].data = financialResults.cf.map(cf => cf.operatingCash / 1e6);
                charts.cashSources.data.datasets[1].data = financialResults.cf.map(cf => cf.investingCash / 1e6);
                charts.cashSources.data.datasets[2].data = financialResults.cf.map(cf => cf.financingCash / 1e6);
            }
            if (charts.diversification) {
                charts.diversification.data.datasets[0].data = financialResults.pl.map(pl => {
                    const revenues = [pl.interestRevenue, pl.originationCommission, pl.gnvCommissions, pl.sparePartsRevenue, pl.marketplaceRevenue];
                    const total = revenues.reduce((s, r) => s + r, 0);
                    if (total === 0) return 0;
                    const hhi = revenues.reduce((s, r) => s + Math.pow(r / total, 2), 0);
                    return 1 - hhi;
                });
            }
            
            // Update all charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.update()
            });
        }
        
        function forceCalculate() {
            if (calculateFinancials()) updateUI();
        }
        function createSliderControl(config, container) {
            const parentDiv = document.createElement('div');
            parentDiv.className = 'flex flex-col mb-4';
            parentDiv.innerHTML = `
                <label class="flex justify-between text-sm font-medium text-slate-300" data-tooltip="${config.tooltip}">
                    ${config.label} 
                    <span id="${config.id}-valor" class="font-bold text-teal-400">${config.format(modelData[config.id])}</span>
                </label>
                <input type="range" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}" class="input-slider mt-1">
            `;
            container.appendChild(parentDiv);
            
            const slider = parentDiv.querySelector('input');
            const display = parentDiv.querySelector('span[id$="-valor"]'); 
            slider.addEventListener('input', () => {
                modelData[config.id] = parseFloat(slider.value);
                display.textContent = config.format(modelData[config.id]);
                if (calculateFinancials()) updateUI();
                if (container.id === 'package-pricing-controls') updatePackageSummary();
            });
        }
        function createNumberControl(config, container) {
            const div = document.createElement('div');
            div.className = 'flex flex-col mb-4';
            div.innerHTML = `
                <label for="${config.id}-input" class="text-sm font-medium text-slate-300 mb-1" data-tooltip="${config.tooltip}">${config.label}</label>
                <input type="number" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}" class="p-2 border border-slate-700 rounded-md bg-slate-800 text-white">
            `;
            container.appendChild(div);
            
            const input = div.querySelector('input');
            input.addEventListener('change', () => {
                let value = parseFloat(input.value) || config.min;
                value = Math.max(config.min, Math.min(config.max, value));
                input.value = value;
                modelData[config.id] = value;
                if (calculateFinancials()) updateUI();
                if (container.id === 'package-pricing-controls') updatePackageSummary();
            });
        }
        
        function setupControls() {
            Object.keys(controlsConfig).forEach(sectionKey => {
                const container = document.getElementById(`${sectionKey}-controls`);
                if (container) {
                    controlsConfig[sectionKey].forEach(config => {
                        if (config.type === 'array') { // Special for unitsPerYear
                            const unitsContainer = document.createElement('div');
                            unitsContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
                            modelData.unitsPerYear.forEach((units, index) => {
                                const div = document.createElement('div');
                                div.innerHTML = `<label for="unit-year-${index+1}" class="text-sm font-medium text-slate-300 mb-1">Unidades Año ${index+1}</label>
                                                 <input type="number" id="unit-year-${index+1}" min="${config.min}" max="${config.max}" value="${units}" class="p-2 border border-slate-700 rounded-md bg-slate-800 text-white">`;
                                unitsContainer.appendChild(div);
                                div.querySelector('input').addEventListener('change', (e) => {
                                    modelData.unitsPerYear[index] = parseInt(e.target.value) || 0;
                                    if (calculateFinancials()) updateUI();
                                });
                            });
                            container.appendChild(unitsContainer);
                        } else if (config.type === 'range') {
                            createSliderControl(config, container);
                        } else if (config.type === 'number') {
                            createNumberControl(config, container);
                        }
                    });
                }
            });
            updatePackageSummary();
            
            // Special handling for ProteccionRodando checkbox
            const ratesRiskContainer = document.getElementById('rates-risk-controls');
            if(ratesRiskContainer) {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center mt-4';
                checkboxDiv.innerHTML = `<input id="check-proteccion" type="checkbox" class="h-4 w-4 rounded border-slate-600 text-sky-500 focus:ring-sky-500 bg-slate-700">
                                         <label for="check-proteccion" class="ml-2 block text-sm text-slate-200" data-tooltip="Activa un factor de reducción del 50% en provisiones de riesgo crediticio.">Protección Rodando™</label>`;
                ratesRiskContainer.appendChild(checkboxDiv);
                const checkbox = document.getElementById('check-proteccion');
                checkbox.checked = modelData.proteccionRodando; 
                checkbox.addEventListener('change', () => {
                    modelData.proteccionRodando = checkbox.checked;
                    if (calculateFinancials()) updateUI();
                });
            }
        }
        function updatePackageSummary() {
            const totalPrice = getTotalPackagePrice();
            const totalCost = getTotalPackageCost();
            const margin = totalPrice - totalCost;
            const marginPercent = (totalPrice > 0) ? (margin / totalPrice) * 100 : 0;
            
            document.getElementById('package-summary').innerHTML = `
                <div class="text-sm space-y-1">
                    <div class="flex justify-between"><span>Precio Total Paquete:</span><span class="font-bold text-sky-400">${formatCurrency(totalPrice)}</span></div>
                    <div class="flex justify-between"><span>Costo Total RAG:</span><span>${formatCurrency(totalCost)}</span></div>
                    <div class="flex justify-between border-t border-slate-600 pt-1"><span class="font-semibold">Margen Bruto Unitario:</span><span class="font-bold text-emerald-400">${formatCurrency(margin)} (${marginPercent.toFixed(1)}%)</span></div>
                </div>`;
        }
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(`content-${button.id.split('-')[1]}`).classList.add('active');
                    if (['tab-financieros', 'tab-niif', 'tab-graficos', 'tab-validacion'].includes(button.id)) {
                        setTimeout(() => { if(calculateFinancials()) updateUI(); }, 50); 
                    }
                });
            });
        }
        
        function validateModelComprehensively(modelData, financialResults) {
            const validations = { errors: [], warnings: [], info: [], passed: [] };
            
            validateInputs(modelData, validations);
            
            if (financialResults.pl.length > 0) {
                validateOutputs(financialResults, validations);
                validateConsistency(financialResults, validations);
            } else {
                validations.errors.push("Financial results could not be calculated. Please review initial inputs.");
            }
            
            return validations;
        }
        function validateInputs(modelData, validations) {
            if (modelData.seriesA <= 0) validations.errors.push(" 🔴  Error: Series A Capital must be > 0.");
            if (getTotalPackagePrice() <= getTotalPackageCost()) validations.errors.push(" 🔴  Error: Total Package Price must be > Total Package Cost.");
            const totalAllocation = modelData.portfolioAllocationStage1 + modelData.portfolioAllocationStage2 + modelData.portfolioAllocationStage3;
            if (Math.abs(totalAllocation - 1.0) > 0.001) { 
                validations.errors.push(` 🔴  Error: IFRS 9 Portfolio Allocation sums to ${(totalAllocation*100).toFixed(1)}%, must be 100%.`);
            } else {
                validations.passed.push(" ✅  Inputs: IFRS 9 Portfolio Allocation sums to 100%.");
            }
            
            //  ✅  ================== PASO 2.1: Implementar Advertencias Dinámicas de Rango ==================
            if (modelData.tasaInteres < 22 || modelData.tasaInteres > 35) {
                validations.warnings.push(` 🟡  Advertencia de Rango: La Tasa de Interés (${modelData.tasaInteres}%) está fuera del rango operativo seguro (22%-35%).`);
            }
            if (modelData.opexRate > 20) {
                validations.warnings.push(` 🟡  Advertencia de Rango: La Tasa OPEX (${modelData.opexRate}%) es superior al 20%, puede indicar ineficiencia.`);
            }
            if (modelData.lgd < 0.4 || modelData.lgd > 0.6) {
                validations.warnings.push(` 🟡  Advertencia de Rango: LGD de ${(modelData.lgd * 100).toFixed(0)}% está fuera del benchmark (40%-60%).`);
            }
            for (let i = 1; i < modelData.unitsPerYear.length; i++) {
                if (modelData.unitsPerYear[i] > modelData.unitsPerYear[i - 1] * 2 && modelData.unitsPerYear[i-1] > 0) {
                    validations.info.push(` 🔵  Nota de Crecimiento: Aumento de unidades en Año ${i + 1} > 100%. Agresivo, requiere fuerte capitalización.`);
                    break;
                }
            }
            validations.passed.push(" ✅  Guardianías Inteligentes: Supuestos clave dentro de rangos operativos realistas.");
            // =======================================================================================
        }
        function validateOutputs(financialResults, validations) {
            financialResults.bs.forEach((bsYear, index) => {
                if (bsYear.cash < 0) { 
                    validations.errors.push(` 🔴  Error: Saldo de Efectivo en Año ${index + 1} es negativo (${formatCurrency(bsYear.cash)}). Se requiere más financiamiento.`);
                }
            });
            if (!validations.errors.some(e => e.includes("negativo"))) {
                 validations.passed.push(" ✅  Outputs: Saldo de efectivo es adecuado en todos los años.");
            }
        }
        function validateConsistency(financialResults, validations) {
            const tolerance = BALANCE_TOLERANCE; 
            for (let i = 0; i < financialResults.pl.length; i++) {
                const bs = financialResults.bs[i];
                const balanceDiff = Math.abs(bs.totalAssets - bs.totalLiabilitiesEquity);
                if (balanceDiff > tolerance) {
                    validations.errors.push(` 🔴  Error de Consistencia: Balance en Año ${i + 1} no cuadra. Diferencia: ${formatCurrency(balanceDiff)}.`);
                }
            }
            if (!validations.errors.some(e => e.includes("Balance"))) {
                 validations.passed.push(" ✅  Consistencia: El Balance General cuadra en todos los años.");
            }
        }
        
        function updateValidationPanel(validations) {
            const container = document.getElementById('validation-results-container');
            if (!container) return;
            container.innerHTML = '';
            
            //  ✅  CORRECCIÓN: Usar plural ('errors') para coincidir con las claves del objeto 'validations'
            const types = ['errors', 'warnings', 'info', 'passed'];
            types.forEach(type => {
                // Defensive check to ensure the key exists and is an array
                if (validations && Array.isArray(validations[type])) {
                    validations[type].forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `validation-item ${type}`;
                        const icon = type === 'errors' ? ' 🔴 ' : type === 'warnings' ? ' 🟡 ' : type === 'info' ? ' 🔵 ' : ' ✅ ';
                        //  ✅  CORRECCIÓN: Lógica de substring más robusta
                        const messageText = msg.substring(msg.indexOf(':') + 2);
                        div.innerHTML = `<div class="validation-message"><strong>${icon}</strong> ${messageText}</div>`;
                        container.appendChild(div);
                    });
                }
            });
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'validation-summary mt-4 p-3 rounded-lg text-sm';
            if (validations.errors.length > 0) {
                summaryDiv.classList.add('bg-rose-950', 'text-rose-300');
                summaryDiv.textContent = ` 🚨  ${validations.errors.length} ERRORES CRÍTICOS encontrados. Es necesario revisar la lógica o los supuestos.`;
            } else if (validations.warnings.length > 0) {
                summaryDiv.classList.add('bg-amber-950', 'text-amber-300');
                summaryDiv.textContent = ` ⚠️  ${validations.warnings.length} ADVERTENCIAS encontradas. El modelo es consistente pero los supuestos pueden ser arriesgados.`;
            } else {
                summaryDiv.classList.add('bg-emerald-950', 'text-emerald-300');
                summaryDiv.textContent = ` ✨  Todas las validaciones críticas pasaron. El modelo es robusto y consistente.`;
            }
            container.appendChild(summaryDiv);
        }
        function generateValidationReportPDF() {
            log('Generating validation PDF report...');
            alert('Función de PDF no implementada. Usando impresión del navegador como alternativa.');
            window.print();
        }
        function updateOptimizationStatus() { /* Placeholder for future logic */ }
        document.addEventListener('DOMContentLoaded', () => {
            log(' 🚀  STARTING FINANCIAL MODEL APPLICATION');
            try {
                setupTabs();
                setupControls();
                initializeCharts(); // 1. Initialize charts first.
                
                if (calculateFinancials()) {
                    updateUI(); // 2. Update the UI (which in turn updates chart data).
                } else {
                    log(' ❌  Initial calculation failed.');
                }
                
                log(' 🎉  APPLICATION READY AND RUNNING');
            } catch (error) {
                log(` ❌  CRITICAL ERROR DURING INITIALIZATION: ${error.message}`);
                console.error('Initialization error:', error);
            }
        });
    </script>
</body>
</html>
