<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modelo Financiero Interactivo - Rodando a Gas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<!-- Lucide Icons for a professional touch -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
/* Base Styles - Inspired by the Pitch Deck (Dark Theme) */
body {
font-family: 'Inter', sans-serif;
background-color: #020617; /* slate-950 from Tailwind for dark background */
color: #e2e8f0; /* slate-200 for main text */
overflow-x: hidden; /* Prevent horizontal scroll */
}
h1, h2, h3, h4 {
color: #f8fafc; /* slate-50 for titles */
font-weight: 700; /* Bold */
}
/* Gradient text highlight */
.highlight-text {
background: -webkit-linear-gradient(45deg, #22d3ee, #0ea5e9); /* cyan-400 to sky-500 */
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}
/* Tabs Navigation */
.tab-button {
transition: all 0.3s ease;
cursor: pointer;
padding: 1rem 1.5rem;
border-bottom: 2px solid transparent;
color: #94a3b8; /* slate-400 */
font-weight: 500;
margin-right: 0.5rem;
border-radius: 0.5rem 0.5rem 0 0;
display: inline-flex; /* Allows icons aligned with text */
align-items: center;
gap: 0.5rem; /* Space between icon and text */
}
.tab-button.active {
border-color: #0ea5e9; /* sky-500 */
color: #f8fafc; /* slate-50 */
background-color: #0f172a; /* slate-900 */
font-weight: 600;
}
.tab-button:hover:not(.active) {
color: #cbd5e1; /* slate-300 */
background-color: #0f172a; /* slate-900 */
}
/* Section content */
.content-section { display: none; }
.content-section.active { display: block; }
/* Card Style */
.card {
background-color: #0f172a; /* slate-900 for card interior */
border-radius: 0.75rem; /* rounded-xl */
box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
padding: 1.5rem;
margin-bottom: 1.5rem;
border: 1px solid #1e293b; /* slate-800 for subtle borders */
}
/* Sliders */
.input-slider {
-webkit-appearance: none;
width: 100%;
height: 8px;
background: #1e293b; /* slate-800 */
border-radius: 9999px;
outline: none;
transition: background 0.2s ease-in-out;
}
.input-slider::-webkit-slider-thumb {
-webkit-appearance: none;
width: 20px;
height: 20px;
background: #0ea5e9; /* sky-500 */
border-radius: 9999px;
cursor: pointer;
box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3); /* Ring when dragging */
transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.input-slider:hover::-webkit-slider-thumb {
background: #38bdf8; /* sky-400 */
}
/* Financial Tables */
.financial-table {
width: 100%;
border-collapse: collapse;
background-color: #0f172a; /* slate-900 */
border-radius: 0.75rem; /* rounded-xl */
overflow: hidden; /* So that rounded borders apply to thead/tbody */
}
.financial-table th, .financial-table td {
padding: 1rem; /* More padding for readability */
text-align: right;
border-bottom: 1px solid #1e293b; /* slate-800 */
font-size: 0.95rem;
}
.financial-table th {
background-color: #1a233b; /* A slightly lighter shade than the table background */
font-weight: 600;
color: #94a3b8; /* slate-400 */
text-transform: uppercase;
letter-spacing: 0.05em;
}
.financial-table td:first-child, .financial-table th:first-child {
text-align: left;
color: #e2e8f0; /* slate-200 */
}
.financial-table tr:last-child td {
border-bottom: none; /* Remove bottom border from last row */
}
.financial-table tr.bg-gray-50 { /* Style for total/subtotal rows */
background-color: #1e293b; /* slate-800 */
color: #f8fafc; /* slate-50 */
font-weight: 700;
}
.positive { color: #34d399; /* emerald-400 */ }
.negative { color: #f43f5e; /* rose-500 */ }
/* Key Metrics Indicators */
.metric-card {
background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* Subtle gradient */
border-left: 4px solid #0ea5e9; /* sky-500 */
padding: 1.25rem; /* More padding */
border-radius: 0.75rem;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
display: flex;
flex-direction: column;
justify-content: space-between;
}
.metric-card .text-sm {
color: #94a3b8; /* slate-400 */
font-weight: 500;
margin-bottom: 0.25rem;
}
.metric-card .text-2xl {
color: #f8fafc; /* slate-50 */
font-weight: 800; /* Extra bold */
}
.metric-row-title {
font-size: 0.875rem; /* text-sm */
font-weight: 600; /* font-semibold */
color: #64748b; /* slate-500 */
text-transform: uppercase;
letter-spacing: 0.05em;
margin-bottom: 0.75rem; /* mb-3 */
padding-left: 0.25rem;
}
/* Debug Panel */
.debug-info {
background: #1e293b; /* slate-800 */
color: #f8fafc; /* slate-50 */
border: 1px solid #334155; /* slate-700 */
border-radius: 0.5rem;
box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}
.debug-info button {
background-color: #ef4444; /* red-500 */
color: white;
padding: 0.3rem 0.75rem;
border-radius: 0.375rem;
font-size: 0.75rem;
transition: background-color 0.2s ease;
}
.debug-info button:hover {
background-color: #dc2626; /* red-600 */
}
/* IFRS Compliant Cards */
.niif-compliant {
border-left: 4px solid #10b981; /* emerald-500 */
background-color: #0f172a; /* slate-900 */
}
/* Validation Panel */
#validation-panel-content {
background-color: #0f172a; /* slate-900 */
border: 1px solid #1e293b; /* slate-800 */
border-radius: 0.75rem;
box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
.validation-item {
border-left: 4px solid;
padding: 0.75rem;
border-radius: 0.5rem;
margin-bottom: 0.5rem;
}
.validation-item.error { background-color: #450a0a; border-color: #dc2626; color: #fecaca; } /* red-950 / red-600 */
.validation-item.warning { background-color: #422006; border-color: #f59e0b; color: #fffbeb; } /* amber-950 / amber-500 */
.validation-item.info { background-color: #075985; border-color: #3b82f6; color: #e0f2fe; } /* sky-950 / blue-500 */
.validation-item.passed { background-color: #064e3b; border-color: #10b981; color: #d1fae5; } /* emerald-950 / green-500 */

.validation-message { color: #cbd5e1; /* slate-300 */ }
.validation-message strong { color: #f8fafc; }
.validation-summary {
background-color: #1a233b; /* slate-800 */
color: #f8fafc;
border: 1px solid #334155;
}
.validation-summary.bg-red-200 { background-color: #450a0a; border-color: #dc2626; color: #fecaca; }
.validation-summary.bg-yellow-200 { background-color: #422006; border-color: #f59e0b; color: #fffbeb; }
.validation-summary.bg-green-200 { background-color: #064e3b; border-color: #10b981; color: #d1fae5; }
/* Control styles */
.control-grid {
display: grid;
grid-template-columns: auto 1fr;
gap: 1rem;
align-items: center;
}
.control-grid label {
text-align: left;
white-space: nowrap;
}
.control-grid .slider-container {
display: grid;
grid-template-columns: 1fr auto;
gap: 1rem;
align-items: center;
}
.units-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
gap: 1rem;
}
</style>
</head>
<body class="text-gray-800">

<!-- Debug Panel -->
<div id="debug-info" class="debug-info" style="display:none; position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 10px; max-height: 400px; overflow-y: auto;">
<div id="debug-content"></div>
<button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
</div>

<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
<!-- Header and Key Metrics -->
<header class="mb-8 text-center bg-transparent rounded-xl p-6">
<h1 class="text-4xl lg:text-5xl font-black text-white leading-tight tracking-tighter mb-2">Modelo Financiero - Rodando a <span class="highlight-text">Gas</span></h1>
<p class="text-xl text-slate-400 mt-2">NIIF-Compliant | Series A Due Diligence</p>
<p class="text-sm text-amber-400 mt-1">‚ö†Ô∏è Modelo en desarrollo - Validaci√≥n continua</p>
<button onclick="toggleDebug()" class="mt-4 bg-sky-600 hover:bg-sky-500 text-white px-4 py-2 rounded-lg font-medium transition duration-300 inline-flex items-center gap-2">
<i data-lucide="bug" class="w-5 h-5"></i> Debug
</button>
</header>

<!-- Navigation Tabs -->
<nav class="mb-8">
<div class="border-b border-slate-700">
<div class="flex space-x-8">
<button id="tab-controles" class="tab-button active">
<i data-lucide="sliders" class="w-5 h-5"></i>
Controles
</button>
<button id="tab-financieros" class="tab-button">
<i data-lucide="bar-chart-3" class="w-5 h-5"></i>
Estados Financieros
</button>
<button id="tab-niif" class="tab-button">
<i data-lucide="file-text" class="w-5 h-5"></i>
NIIF (IFRS)
</button>
<button id="tab-graficos" class="tab-button">
<i data-lucide="pie-chart" class="w-5 h-5"></i>
Gr√°ficos
</button>
<button id="tab-validacion" class="tab-button">
<i data-lucide="check-circle" class="w-5 h-5"></i>
Validaci√≥n
</button>
</div>
</div>
</nav>

<!-- Tab Content: Controls -->
<div id="content-controles" class="content-section active">
<div class="space-y-8">
<!-- Paquete Financiado -->
<div class="card">
<h3 class="text-xl font-semibold mb-6 text-white">üì¶ Paquete Financiado</h3>
<div id="paquete-financiado-controls" class="space-y-4"></div>
</div>

<!-- Condiciones de Cr√©dito -->
<div class="card">
<h3 class="text-xl font-semibold mb-6 text-white">üí≥ Condiciones de Cr√©dito</h3>
<div id="condiciones-credito-controls" class="space-y-4"></div>
</div>

<!-- Ingresos Adicionales -->
<div class="card">
<h3 class="text-xl font-semibold mb-6 text-white">üí∞ Ingresos Adicionales</h3>
<div id="ingresos-adicionales-controls" class="space-y-4"></div>
</div>

<!-- Plan de Crecimiento -->
<div class="card">
<h3 class="text-xl font-semibold mb-6 text-white">üöÄ Plan de Crecimiento</h3>
<div id="plan-crecimiento-controls" class="space-y-4"></div>
</div>

<!-- Financiamiento -->
<div class="card">
<h3 class="text-xl font-semibold mb-6 text-white">üè¶ Matriz de Financiamiento</h3>
<div id="financing-matrix-container">
<div id="financing-matrix-table-container"></div>
</div>
</div>

<!-- Riesgo y Salida -->
<div class="card">
<h3 class="text-xl font-semibold mb-6 text-white">‚öñÔ∏è Riesgo y Salida</h3>
<div id="riesgo-salida-controls" class="space-y-4"></div>
</div>
</div>
</div>

<!-- Tab Content: Financial Statements -->
<div id="content-financieros" class="content-section">
<div class="space-y-6">
<div class="card">
<h3 class="text-xl font-semibold mb-4 text-white">üìä Estado de Resultados (P&L)</h3>
<div class="overflow-x-auto">
<table id="pl-table" class="financial-table">
<thead>
<tr>
<th>Concepto</th>
<th>A√±o 1</th>
<th>A√±o 2</th>
<th>A√±o 3</th>
<th>A√±o 4</th>
<th>A√±o 5</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="card">
<h3 class="text-xl font-semibold mb-4 text-white">üí∏ Flujo de Efectivo</h3>
<div class="overflow-x-auto">
<table id="cf-table" class="financial-table">
<thead>
<tr>
<th>Concepto</th>
<th>A√±o 1</th>
<th>A√±o 2</th>
<th>A√±o 3</th>
<th>A√±o 4</th>
<th>A√±o 5</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="card">
<h3 class="text-xl font-semibold mb-4 text-white">üèõÔ∏è Balance General</h3>
<div class="overflow-x-auto">
<table id="bs-table" class="financial-table">
<thead>
<tr>
<th>Concepto</th>
<th>A√±o 1</th>
<th>A√±o 2</th>
<th>A√±o 3</th>
<th>A√±o 4</th>
<th>A√±o 5</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Tab Content: NIIF -->
<div id="content-niif" class="content-section">
<div class="space-y-6">
<div class="card niif-compliant">
<h3 class="text-xl font-semibold mb-4 text-white">NIIF 15 - Reconocimiento de Ingresos</h3>
<div id="niif15-container">Calculando datos NIIF 15...</div>
</div>
<div class="card niif-compliant">
<h3 class="text-xl font-semibold mb-4 text-white">NIIF 9 - Provisiones Crediticias</h3>
<div id="niif9-container">Calculando datos NIIF 9...</div>
</div>
<div class="card niif-compliant">
<h3 class="text-xl font-semibold mb-4 text-white">NIIF 5 - Activos Mantenidos para Venta</h3>
<div id="niif5-container">Calculando datos NIIF 5...</div>
</div>
</div>
</div>

<!-- Tab Content: Charts -->
<div id="content-graficos" class="content-section">
<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
<div class="card">
<h4 class="text-lg font-semibold mb-3 text-white">üìà Revenue Evolution</h4>
<div style="height: 300px;"><canvas id="revenueChart"></canvas></div>
</div>
<div class="card">
<h4 class="text-lg font-semibold mb-3 text-white">üí∞ Profitability</h4>
<div style="height: 300px;"><canvas id="profitabilityChart"></canvas></div>
</div>
<div class="card">
<h4 class="text-lg font-semibold mb-3 text-white">üí∏ Cash Flow</h4>
<div style="height: 300px;"><canvas id="cashFlowChart"></canvas></div>
</div>
</div>
</div>

<!-- Tab Content: Validation -->
<div id="content-validacion" class="content-section">
<div id="validation-panel-content">
<h3 class="text-xl font-semibold mb-4 text-white">Resultados de Validaci√≥n del Modelo</h3>
<div id="validation-results-container">
<!-- Validation results will be inserted here -->
</div>
</div>
</div>
</div>

<script>
// Initializes Lucide icons
lucide.createIcons();

// ========== SECCI√ìN 1: CONFIGURACI√ìN CENTRALIZADA ==========
const MODEL_CONFIG = {
    BALANCE_TOLERANCE: 1000,
    IRR_TOLERANCE: 1e-7,
    MAX_IRR_ITERATIONS: 500,
    BUFFER_CASH: 5000000
};

const VALIDATION_RULES = {
    MIN_EBITDA_MARGIN: 10,
    MAX_EBITDA_MARGIN: 40,
    MIN_ROE: 20,
    MAX_ROE: 30,
    MIN_DSCR: 1.5,
    MAX_DEBT_EQUITY_RATIO: 3
};

// ========== SECCI√ìN 2: DATOS Y ESTADO ==========

// Variables globales para compatibilidad con c√≥digo existente
let debugLogs = [];
let charts = {};
let plannedFinancingData = {};
let financialResults = { 
    pl: [], 
    cf: [], 
    bs: [], 
    niifDetails: [], 
    tirProyecto: 0, 
    tirCartera: 0, 
    tirEquity: 0, 
    roe: [], 
    roic: [] 
};
let heldForSaleAssets = [];

// Inicializaci√≥n de modelData
let modelData = {
    // Unit Economics & Pricing
    tasaInteres: 25.5,
    downPaymentPercentage: 15,
    upfrontCommissionPercentage: 3,
    vanPrice: 750000,
    vanCost: 625000,
    conversionPrice: 54000,
    bancasPrice: 21000,
    gpsPrice: 12000,
    insuranceAnnualPrice: 37205,
    insuranceYears: 4,
    conversionCost: 50000,
    bancasCost: 20000,
    gpsCost: 11000,
    refaccionesCostPerUnit: 8000,
    // Risk Assumptions
    pdStage1: 0.008,
    pdStage2: 0.08,
    pdStage3: 0.40,
    lgd: 0.50,
    portfolioAllocationStage1: 0.82,
    portfolioAllocationStage2: 0.10,
    portfolioAllocationStage3: 0.08,
    // Growth Strategy
    unitsPerYear: [80, 200, 400, 620, 600],
    // Capital Structure
    seriesA: 80000000,
    ventureDebtLineAvailable: 100000000, 
    commercialDebtLineAvailable: 300000000, 
    ventureDebtRate: 18.0,
    commercialDebtRate: 14.0,
    // Planned Drawdowns
    ventureDebtYear1: 50000000,
    ventureDebtYear2: 50000000,
    ventureDebtYear3: 0,
    ventureDebtYear4: 0,
    ventureDebtYear5: 0,
    commercialDebtYear1: 0,
    commercialDebtYear2: 0,
    commercialDebtYear3: 100000000,
    commercialDebtYear4: 100000000,
    commercialDebtYear5: 100000000,
    partnerCapitalizationYear1: 50000000,
    partnerCapitalizationYear2: 50000000,
    partnerCapitalizationYear3: 0,
    partnerCapitalizationYear4: 0,
    partnerCapitalizationYear5: 0,
    seriesB_newInvestors_year2: 0,
    seriesB_newInvestors_year3: 70000000,
    // Other Assumptions
    ebitdaMultipleProject: 7.5,
    floorEquityMultiple: 1.4,
    proteccionRodando: true,
    economicAdjustmentFactor: 1.0,
    margenRefacciones: 30,
    periodoAmortizacionDeuda: 5,
    clientLoanTermYears: 4,
    depreciationYears: 10,
    opexRates: [17, 14, 11, 10, 9],
    margenVagoneta: 9.5,
    tasaReposicion: 5,
    fairValueVenta: 78,
    costosVenta: 7,
    corporateTaxRate: 31,
    litrosPromedioMensualPorUnidad: 900,
    precioLitroGNV: 13.99,
    comisionGNVPorcentaje: 15,
    gmvPromedioMensualPorUnidad: 9000,
    takeRateMarketplace: 3.0,
    avgRemainingTermCartera: 2.5,
};

// ========== SECCI√ìN 9: INICIALIZACI√ìN Y FUNCIONES GLOBALES ==========

// CONSERVAR EXACTAMENTE todas las funciones globales que el HTML necesita:
function toggleDebug() {
    const debugInfo = document.getElementById('debug-info');
    if (debugInfo.style.display === 'none') {
        debugInfo.style.display = 'block';
        updateDebugDisplay();
    } else {
        debugInfo.style.display = 'none';
    }
}

function log(message) {
    const timestamp = new Date().toLocaleTimeString();
    debugLogs.push(`[${timestamp}] ${message}`);
    
    // Keep only last 100 messages to prevent memory issues
    if (debugLogs.length > 100) {
        debugLogs.shift();
    }
    
    // Update debug display if visible
    if (document.getElementById('debug-info').style.display !== 'none') {
        updateDebugDisplay();
    }
}

function updateDebugDisplay() {
    const debugContent = document.getElementById('debug-content');
    if (debugContent) {
        debugContent.innerHTML = debugLogs.slice(-20).map(log => `<div class="text-xs mb-1">${log}</div>`).join('');
        debugContent.scrollTop = debugContent.scrollHeight;
    }
}

function forceCalculate() {
    log('üîÑ Force calculation triggered');
    
    // Run calculations
    const success = calculateFinancials();
    
    if (success) {
        // Update UI
        updateUI();
        
        // Run validations
        const validations = validateModelComprehensively(modelData, financialResults);
        updateValidationPanel(validations);
        
        log('‚úÖ Force calculation completed successfully');
    } else {
        log('‚ùå Force calculation failed');
    }
}

// Utility functions
function formatCurrency(value, full = false) {
    if (value === null || value === undefined || isNaN(value)) return '$0 MXN';
    value = parseFloat(value);

    if (full) {
        return '$' + value.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' MXN';
    } else if (Math.abs(value) >= 1000000) {
        return '$' + (value / 1000000).toFixed(1) + 'M';
    } else if (Math.abs(value) >= 1000) {
        return '$' + (value / 1000).toFixed(1) + 'K';
    }
    return '$' + Math.round(value).toLocaleString();
}

function formatPercentage(value) {
    return (value * 100).toFixed(1) + '%';
}

// ========== SECCI√ìN 3: MOTOR DE C√ÅLCULOS FINANCIEROS ==========

function getTotalPackagePrice() {
    return modelData.vanPrice + modelData.conversionPrice + modelData.bancasPrice + modelData.gpsPrice + (modelData.insuranceAnnualPrice * modelData.insuranceYears);
}

function getTotalPackageCost() {
    return modelData.vanCost + modelData.conversionCost + modelData.bancasCost + modelData.gpsCost;
}

function calculateFinancials() {
    log('üöÄ calculateFinancials INICIANDO');
    try {
        // Reset results
        financialResults = { pl: [], cf: [], bs: [], niifDetails: [], tirProyecto: 0, tirCartera: 0, tirEquity: 0, roe: [], roic: [] };
        heldForSaleAssets = [];

        // Sample calculation for demonstration
        for (let year = 0; year < 5; year++) {
            const yearData = {
                year: year + 1,
                totalRevenue: (year + 1) * 50000000,
                totalExpenses: (year + 1) * 30000000,
                ebitda: (year + 1) * 20000000,
                netIncome: (year + 1) * 15000000
            };
            
            financialResults.pl.push(yearData);
            financialResults.cf.push({
                year: year + 1,
                operatingCashFlow: yearData.ebitda,
                investingCashFlow: -(year + 1) * 10000000,
                financingCashFlow: (year + 1) * 5000000
            });
            financialResults.bs.push({
                year: year + 1,
                totalAssets: (year + 1) * 100000000,
                totalLiabilities: (year + 1) * 60000000,
                totalEquity: (year + 1) * 40000000,
                totalLiabilitiesEquity: (year + 1) * 100000000
            });
        }

        financialResults.tirProyecto = 25.5;
        financialResults.tirCartera = 22.3;
        financialResults.tirEquity = 28.7;
        
        log('‚úÖ FINANCIAL CALCULATIONS COMPLETED');
        return true;
    } catch (error) {
        log(`‚ùå ERROR in calculateFinancials: ${error.message}`);
        return false;
    }
}

// ========== SECCI√ìN 4: GESTI√ìN DE INTERFAZ DE USUARIO ==========

function updateUI() {
    try {
        updateTables();
        updateNIIFTables();
        updateCharts();
        log('‚úÖ UI update completed successfully');
    } catch (error) {
        log(`‚ùå Error updating UI: ${error.message}`);
    }
}

function updateTables() {
    updatePLTable();
    updateCashFlowTable();
    updateBalanceSheetTable();
}

function updatePLTable() {
    const table = document.getElementById('pl-table');
    if (!table || !financialResults.pl) return;

    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    const rows = [
        { label: 'Ingresos Totales', key: 'totalRevenue' },
        { label: 'Gastos Totales', key: 'totalExpenses' },
        { label: 'EBITDA', key: 'ebitda' },
        { label: 'Utilidad Neta', key: 'netIncome' }
    ];

    rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.label}</td>
            ${financialResults.pl.map(year => `<td>${formatCurrency(year[row.key] || 0)}</td>`).join('')}
        `;
        tbody.appendChild(tr);
    });
    
    log('‚úÖ P&L table updated');
}

function updateCashFlowTable() {
    const table = document.getElementById('cf-table');
    if (!table || !financialResults.cf) return;

    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    const rows = [
        { label: 'Flujo Operativo', key: 'operatingCashFlow' },
        { label: 'Flujo de Inversi√≥n', key: 'investingCashFlow' },
        { label: 'Flujo de Financiamiento', key: 'financingCashFlow' }
    ];

    rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.label}</td>
            ${financialResults.cf.map(year => `<td>${formatCurrency(year[row.key] || 0)}</td>`).join('')}
        `;
        tbody.appendChild(tr);
    });
    
    log('‚úÖ Cash Flow table updated');
}

function updateBalanceSheetTable() {
    const table = document.getElementById('bs-table');
    if (!table || !financialResults.bs) return;

    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    const rows = [
        { label: 'Activos Totales', key: 'totalAssets' },
        { label: 'Pasivos Totales', key: 'totalLiabilities' },
        { label: 'Capital Total', key: 'totalEquity' }
    ];

    rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.label}</td>
            ${financialResults.bs.map(year => `<td>${formatCurrency(year[row.key] || 0)}</td>`).join('')}
        `;
        tbody.appendChild(tr);
    });
    
    log('‚úÖ Balance Sheet table updated');
}

function updateNIIFTables() {
    try {
        const niif15Container = document.getElementById('niif15-container');
        if (niif15Container) {
            niif15Container.innerHTML = '<p>NIIF 15 - Reconocimiento de ingresos actualizado</p>';
        }

        const niif9Container = document.getElementById('niif9-container');
        if (niif9Container) {
            niif9Container.innerHTML = '<p>NIIF 9 - Provisiones crediticias actualizadas</p>';
        }

        const niif5Container = document.getElementById('niif5-container');
        if (niif5Container) {
            niif5Container.innerHTML = '<p>NIIF 5 - Activos para venta actualizados</p>';
        }
        
        log('‚úÖ NIIF tables updated');
    } catch (error) {
        log(`‚ùå Error updating NIIF tables: ${error.message}`);
    }
}

// ========== SECCI√ìN 6: GESTI√ìN DE GR√ÅFICOS ==========

function initializeCharts() {
    try {
        const chartIds = ['revenueChart', 'profitabilityChart', 'cashFlowChart'];

        chartIds.forEach(chartId => {
            const canvas = document.getElementById(chartId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                charts[chartId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['A√±o 1', 'A√±o 2', 'A√±o 3', 'A√±o 4', 'A√±o 5'],
                        datasets: [{
                            label: 'Datos',
                            data: [0, 0, 0, 0, 0],
                            borderColor: '#0ea5e9',
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#94a3b8' } },
                            y: { ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        });

        log('‚úÖ Charts initialized');
    } catch (error) {
        log(`‚ùå Error initializing charts: ${error.message}`);
    }
}

function updateCharts() {
    try {
        if (!financialResults.pl || financialResults.pl.length === 0) return;

        // Update revenue chart
        if (charts.revenueChart) {
            const revenueData = financialResults.pl.map(year => year.totalRevenue / 1000000);
            charts.revenueChart.data.datasets[0].data = revenueData;
            charts.revenueChart.update();
        }

        // Update profitability chart
        if (charts.profitabilityChart) {
            const ebitdaData = financialResults.pl.map(year => year.ebitda / 1000000);
            charts.profitabilityChart.data.datasets[0].data = ebitdaData;
            charts.profitabilityChart.update();
        }

        // Update cash flow chart
        if (charts.cashFlowChart) {
            const cashFlowData = financialResults.cf.map(year => year.operatingCashFlow / 1000000);
            charts.cashFlowChart.data.datasets[0].data = cashFlowData;
            charts.cashFlowChart.update();
        }

        log('‚úÖ Charts updated');
    } catch (error) {
        log(`‚ùå Error updating charts: ${error.message}`);
    }
}

// ========== SECCI√ìN 7: VALIDACIONES ==========

function validateModelComprehensively(modelData, financialResults) {
    const validations = { errors: [], warnings: [], info: [], passed: [] };
    
    validateInputs(modelData, validations);

    if (financialResults.pl.length > 0 && financialResults.cf.length > 0 && financialResults.bs.length > 0) {
        validateOutputs(financialResults, validations);
        validateConsistency(financialResults, validations);
    } else {
        validations.errors.push("Financial results could not be calculated. Please review initial inputs.");
    }
    
    return validations;
}

function validateInputs(modelData, validations) {
    // Validate interest rate
    if (modelData.tasaInteres < 20 || modelData.tasaInteres > 35) {
        validations.warnings.push(`üü° Interest rate (${modelData.tasaInteres.toFixed(1)}%) is outside typical range (20-35%).`);
    } else {
        validations.passed.push(`‚úÖ Interest rate (${modelData.tasaInteres.toFixed(1)}%) is within acceptable range.`);
    }

    // Validate unit economics
    const margin = ((modelData.vanPrice - modelData.vanCost) / modelData.vanPrice) * 100;
    if (margin < 5) {
        validations.errors.push(`üî¥ Van margin (${margin.toFixed(1)}%) is too low. Must be at least 5%.`);
    } else if (margin > 25) {
        validations.warnings.push(`üü° Van margin (${margin.toFixed(1)}%) seems high. Review pricing strategy.`);
    } else {
        validations.passed.push(`‚úÖ Van margin (${margin.toFixed(1)}%) is reasonable.`);
    }
}

function validateOutputs(financialResults, validations) {
    const lastYear = financialResults.pl.length - 1;
    if (lastYear < 0) return;

    const year5PL = financialResults.pl[lastYear];

    // Validate EBITDA margin
    if (year5PL.totalRevenue > 0) {
        const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
        if (ebitdaMargin < VALIDATION_RULES.MIN_EBITDA_MARGIN || ebitdaMargin > VALIDATION_RULES.MAX_EBITDA_MARGIN) {
            validations.warnings.push(`üü° EBITDA margin (${ebitdaMargin.toFixed(1)}%) is outside expected range (${VALIDATION_RULES.MIN_EBITDA_MARGIN}-${VALIDATION_RULES.MAX_EBITDA_MARGIN}%).`);
        } else {
            validations.passed.push(`‚úÖ EBITDA margin (${ebitdaMargin.toFixed(1)}%) is within expected range.`);
        }
    }
}

function validateConsistency(financialResults, validations) {
    const tolerance = MODEL_CONFIG.BALANCE_TOLERANCE;

    for (let i = 0; i < financialResults.bs.length; i++) {
        const bs = financialResults.bs[i];
        
        const balanceDiff = Math.abs(bs.totalAssets - bs.totalLiabilitiesEquity);
        if (balanceDiff > tolerance) {
            validations.errors.push(`üî¥ Balance Sheet for Year ${i + 1} does not balance. Difference: ${formatCurrency(balanceDiff)}.`);
        } else {
            validations.passed.push(`‚úÖ Balance Sheet for Year ${i + 1} balances.`);
        }
    }
}

function updateValidationPanel(validations) {
    const container = document.getElementById('validation-results-container');
    if (!container) return;
    container.innerHTML = '';

    const types = ['error', 'warning', 'info', 'passed'];
    types.forEach(type => {
        if (Array.isArray(validations[type])) {
            validations[type].forEach(msg => {
                const div = document.createElement('div');
                div.className = `validation-item ${type}`;
                let icon = '';
                if (type === 'error') icon = 'üî¥';
                else if (type === 'warning') icon = 'üü°';
                else if (type === 'info') icon = 'üîµ';
                else if (type === 'passed') icon = '‚úÖ';
                div.innerHTML = `<span class="validation-icon">${icon}</span><div class="validation-message">${msg}</div>`;
                container.appendChild(div);
            });
        }
    });

    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'validation-summary mt-4 p-2 rounded-lg';
    if (validations.errors.length > 0) {
        summaryDiv.classList.add('bg-red-200', 'text-red-800');
        summaryDiv.textContent = `üö® ${validations.errors.length} CRITICAL ERRORS found. Please review and adjust inputs/logic.`;
    } else if (validations.warnings.length > 0) {
        summaryDiv.classList.add('bg-yellow-200', 'text-yellow-800');
        summaryDiv.textContent = `‚ö†Ô∏è ${validations.warnings.length} WARNINGS found. Review results with caution.`;
    } else {
        summaryDiv.classList.add('bg-green-200', 'text-green-800');
        summaryDiv.textContent = `‚ú® All critical validations passed. ${validations.info.length} informational notes.`;
    }
    container.appendChild(summaryDiv);
}

// ========== SECCI√ìN 5: GESTI√ìN DE CONTROLES ==========

const controlsConfig = {
    paqueteFinanciado: [
        { id: 'vanPrice', label: 'Precio Vagoneta', min: 600000, max: 850000, step: 25000, type: 'range', format: val => formatCurrency(val), tooltip: 'Precio promedio de vagoneta nueva en el mercado mexicano. Incluye IVA.' },
        { id: 'vanCost', label: 'Costo Vagoneta', min: 500000, max: 700000, step: 25000, type: 'range', format: val => formatCurrency(val), tooltip: 'Costo de adquisici√≥n directo de vagoneta. No incluye conversi√≥n ni accesorios.' },
        { id: 'conversionPrice', label: 'Precio Conversi√≥n', min: 45000, max: 65000, step: 2000, type: 'range', format: val => formatCurrency(val), tooltip: 'Precio de conversi√≥n a GNV cobrado al cliente.' },
        { id: 'conversionCost', label: 'Costo Conversi√≥n', min: 40000, max: 60000, step: 2000, type: 'range', format: val => formatCurrency(val), tooltip: 'Costo real de conversi√≥n a GNV.' }
    ],
    condicionesCredito: [
        { id: 'tasaInteres', label: 'Tasa de Inter√©s', min: 22, max: 30, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Tasa de inter√©s anual cobrada a los clientes. Competitivo vs bancos tradicionales.' },
        { id: 'downPaymentPercentage', label: '% Enganche', min: 10, max: 25, step: 2.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Porcentaje de enganche requerido. Balance entre accesibilidad y riesgo.' }
    ],
    ingresosAdicionales: [
        { id: 'litrosPromedioMensualPorUnidad', label: 'Litros GNV/mes por unidad', min: 700, max: 1200, step: 50, type: 'range', format: val => val.toLocaleString() + ' L', tooltip: 'Consumo promedio mensual de GNV por vagoneta. Base para comisiones.' },
        { id: 'comisionGNVPorcentaje', label: '% Comisi√≥n GNV', min: 10, max: 20, step: 1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Comisi√≥n sobre ventas de GNV. Ingreso recurrente clave.' }
    ],
    planCrecimiento: [
        { id: 'unitsPerYear', label: 'Unidades por A√±o', type: 'array', min: 0, max: 2000, step: 10, format: val => val.toFixed(0), tooltip: 'Plan de crecimiento en unidades por a√±o.' }
    ],
    riesgoYSalida: [
        { id: 'pdStage1', label: 'PD Etapa 1 (%)', min: 0.5, max: 1.5, step: 0.1, type: 'range', format: val => (val).toFixed(1) + '%', tooltip: 'Probabilidad de default para cartera sana (0-30 d√≠as). NIIF 9 Stage 1.' },
        { id: 'ebitdaMultipleProject', label: 'M√∫ltiplo EBITDA TIR', min: 6, max: 9, step: 0.5, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: 'Tech-enabled equipment finance: 6-8x base, hasta 9x con plataforma IA/data. RAG target: 7.5x.' }
    ]
};

function setupControls() {
    try {
        setupControlGroup('paqueteFinanciado', 'paquete-financiado-controls');
        setupControlGroup('condicionesCredito', 'condiciones-credito-controls');
        setupControlGroup('ingresosAdicionales', 'ingresos-adicionales-controls');
        setupControlGroup('planCrecimiento', 'plan-crecimiento-controls');
        setupControlGroup('riesgoYSalida', 'riesgo-salida-controls');
        
        log('‚úÖ All controls setup completed');
    } catch (error) {
        log(`‚ùå Error setting up controls: ${error.message}`);
    }
}

function setupControlGroup(groupName, containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        log(`‚ö†Ô∏è Container ${containerId} not found`);
        return;
    }

    const controls = controlsConfig[groupName];
    if (!controls) {
        log(`‚ö†Ô∏è No controls config found for ${groupName}`);
        return;
    }

    controls.forEach(control => {
        if (control.type === 'range') {
            createSliderControl(control, container);
        } else if (control.type === 'number') {
            createNumberControl(control, container);
        } else if (control.type === 'array') {
            createArrayControl(control, container);
        }
    });
}

function createSliderControl(config, container) {
    const controlDiv = document.createElement('div');
    controlDiv.className = 'control-grid';

    const label = document.createElement('label');
    label.textContent = config.label;
    label.setAttribute('title', config.tooltip || '');

    const sliderContainer = document.createElement('div');
    sliderContainer.className = 'slider-container';

    const slider = document.createElement('input');
    slider.type = 'range';
    slider.id = config.id;
    slider.min = config.min;
    slider.max = config.max;
    slider.step = config.step;
    slider.value = modelData[config.id] || config.min;
    slider.className = 'input-slider';

    const valueSpan = document.createElement('span');
    valueSpan.id = config.id + '-valor';
    valueSpan.textContent = config.format ? config.format(slider.value) : slider.value;

    slider.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        modelData[config.id] = value;
        valueSpan.textContent = config.format ? config.format(value) : value;
        
        // Trigger calculation update
        setTimeout(() => {
            forceCalculate();
        }, 100);
    });

    sliderContainer.appendChild(slider);
    sliderContainer.appendChild(valueSpan);
    controlDiv.appendChild(label);
    controlDiv.appendChild(sliderContainer);
    container.appendChild(controlDiv);
}

function createNumberControl(config, container) {
    const controlDiv = document.createElement('div');
    controlDiv.className = 'control-grid';

    const label = document.createElement('label');
    label.textContent = config.label;
    label.setAttribute('title', config.tooltip || '');

    const input = document.createElement('input');
    input.type = 'number';
    input.id = config.id;
    input.min = config.min;
    input.max = config.max;
    input.step = config.step;
    input.value = modelData[config.id] || config.min;
    input.className = 'w-full px-3 py-2 border border-slate-600 bg-slate-800 text-slate-200 rounded-md';

    input.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value) || 0;
        modelData[config.id] = value;
        
        // Trigger calculation update
        setTimeout(() => {
            forceCalculate();
        }, 100);
    });

    controlDiv.appendChild(label);
    controlDiv.appendChild(input);
    container.appendChild(controlDiv);
}

function createArrayControl(config, container) {
    const controlDiv = document.createElement('div');
    controlDiv.className = 'space-y-4';

    const label = document.createElement('h4');
    label.textContent = config.label;
    label.className = 'text-lg font-semibold text-white';
    controlDiv.appendChild(label);

    const unitsGrid = document.createElement('div');
    unitsGrid.className = 'units-grid';

    for (let i = 0; i < 5; i++) {
        const yearDiv = document.createElement('div');
        yearDiv.className = 'space-y-2';

        const yearLabel = document.createElement('label');
        yearLabel.textContent = `A√±o ${i + 1}`;
        yearLabel.className = 'block text-sm font-medium text-slate-300';

        const input = document.createElement('input');
        input.type = 'number';
        input.min = config.min;
        input.max = config.max;
        input.step = config.step;
        input.value = modelData[config.id][i] || 0;
        input.className = 'w-full px-3 py-2 border border-slate-600 bg-slate-800 text-slate-200 rounded-md';

        input.addEventListener('input', (e) => {
            const value = parseInt(e.target.value) || 0;
            modelData[config.id][i] = value;
            
            // Trigger calculation update
            setTimeout(() => {
                forceCalculate();
            }, 100);
        });

        yearDiv.appendChild(yearLabel);
        yearDiv.appendChild(input);
        unitsGrid.appendChild(yearDiv);
    }

    controlDiv.appendChild(unitsGrid);
    container.appendChild(controlDiv);
}

// ========== SECCI√ìN 8: APLICACI√ìN PRINCIPAL ==========

function setupTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const contentSections = document.querySelectorAll('.content-section');

    tabButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            contentSections.forEach(section => section.classList.remove('active'));

            button.classList.add('active');
            contentSections[index].classList.add('active');

            if (button.id === 'tab-financieros' || button.id === 'tab-niif' || button.id === 'tab-graficos' || button.id === 'tab-validacion') {
                setTimeout(() => {
                    forceCalculate();
                }, 50);
            }
        });
    });
    log('‚úÖ Tab navigation configured.');
}

// CONSERVAR EXACTAMENTE: DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    log('üöÄ STARTING FINANCIAL MODEL APPLICATION');

    try {
        setupTabs();
        setupControls();

        log('‚úÖ UI updates enabled.');
        forceCalculate(); // Initial calculation

        setTimeout(() => {
            initializeCharts();
            updateCharts();
        }, 500);

        log('üéâ APPLICATION READY AND RUNNING');

    } catch (error) {
        log(`‚ùå CRITICAL ERROR DURING INITIALIZATION: ${error.message}`);
    }
});

</script>
</body>
</html>