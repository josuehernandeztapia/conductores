<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo - Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons for a professional touch -->
    <script src="https://unpkg.com/lucide@latest"></script> 
    
    <style>
        /* Base Styles - Inspired by the Pitch Deck (Dark Theme) */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; /* slate-950 from Tailwind for dark background */
            color: #e2e8f0; /* slate-200 for main text */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        h1, h2, h3, h4 {
            color: #f8fafc; /* slate-50 for titles */
            font-weight: 700; /* Bold */
        }
        /* Gradient text highlight */
        .highlight-text {
            background: -webkit-linear-gradient(45deg, #22d3ee, #0ea5e9); /* cyan-400 to sky-500 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Tabs Navigation */
        .tab-button { 
            transition: all 0.3s ease; 
            cursor: pointer; 
            padding: 1rem 1.5rem;
            border-bottom: 2px solid transparent;
            color: #94a3b8; /* slate-400 */
            font-weight: 500;
            margin-right: 0.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            display: inline-flex; /* Allows icons aligned with text */
            align-items: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        .tab-button.active { 
            border-color: #0ea5e9; /* sky-500 */
            color: #f8fafc; /* slate-50 */
            background-color: #0f172a; /* slate-900 */
            font-weight: 600;
        }
        .tab-button:hover:not(.active) {
            color: #cbd5e1; /* slate-300 */
            background-color: #0f172a; /* slate-900 */
        }
        /* Section content */
        .content-section { display: none; }
        .content-section.active { display: block; }
        /* Card Style */
        .card { 
            background-color: #0f172a; /* slate-900 for card interior */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            border: 1px solid #1e293b; /* slate-800 for subtle borders */
        }
        /* Sliders */
        .input-slider { 
            -webkit-appearance: none; 
            width: 100%; 
            height: 8px; 
            background: #1e293b; /* slate-800 */
            border-radius: 9999px; 
            outline: none; 
            transition: background 0.2s ease-in-out;
        }
        .input-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 20px; 
            height: 20px; 
            background: #0ea5e9; /* sky-500 */
            border-radius: 9999px; 
            cursor: pointer; 
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3); /* Ring when dragging */
            transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-slider:hover::-webkit-slider-thumb {
            background: #38bdf8; /* sky-400 */
        }
        /* Financial Tables */
        .financial-table { 
            width: 100%; 
            border-collapse: collapse; 
            background-color: #0f172a; /* slate-900 */
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden; /* So that rounded borders apply to thead/tbody */
        }
        .financial-table th, .financial-table td { 
            padding: 1rem; /* More padding for readability */
            text-align: right; 
            border-bottom: 1px solid #1e293b; /* slate-800 */
            font-size: 0.95rem;
        }
        .financial-table th { 
            background-color: #1a233b; /* A slightly lighter shade than the table background */
            font-weight: 600; 
            color: #94a3b8; /* slate-400 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .financial-table td:first-child, .financial-table th:first-child { 
            text-align: left; 
            color: #e2e8f0; /* slate-200 */
        }
        .financial-table tr:last-child td {
            border-bottom: none; /* Remove bottom border from last row */
        }
        .financial-table tr.bg-gray-50 { /* Style for total/subtotal rows */
            background-color: #1e293b; /* slate-800 */
            color: #f8fafc; /* slate-50 */
            font-weight: 700;
        }
        .positive { color: #34d399; /* emerald-400 */ } 
        .negative { color: #f43f5e; /* rose-500 */ }
        /* Key Metrics Indicators */
        .metric-card { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* Subtle gradient */
            border-left: 4px solid #0ea5e9; /* sky-500 */
            padding: 1.25rem; /* More padding */
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .metric-card .text-sm {
            color: #94a3b8; /* slate-400 */
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .metric-card .text-2xl {
            color: #f8fafc; /* slate-50 */
            font-weight: 800; /* Extra bold */
        }
        /* Debug Panel */
        .debug-info { 
            background: #1e293b; /* slate-800 */
            color: #f8fafc; /* slate-50 */
            border: 1px solid #334155; /* slate-700 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .debug-info button {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            transition: background-color 0.2s ease;
        }
        .debug-info button:hover {
            background-color: #dc2626; /* red-600 */
        }
        /* IFRS Compliant Cards */
        .niif-compliant {
            border-left: 4px solid #10b981; /* emerald-500 */
            background-color: #0f172a; /* slate-900 */
        }
        /* Validation Panel */
        #validation-panel-content {
            background-color: #0f172a; /* slate-900 */
            border: 1px solid #1e293b; /* slate-800 */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .validation-item {
            border-left: 4px solid;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .validation-item.error { background-color: #450a0a; border-color: #dc2626; color: #fecaca; } /* red-950 / red-600 */
        .validation-item.warning { background-color: #422006; border-color: #f59e0b; color: #fffbeb; } /* amber-950 / amber-500 */
        .validation-item.info { background-color: #075985; border-color: #3b82f6; color: #e0f2fe; } /* sky-950 / blue-500 */
        .validation-item.passed { background-color: #064e3b; border-color: #10b981; color: #d1fae5; } /* emerald-950 / green-500 */
        
        .validation-message { color: #cbd5e1; /* slate-300 */ }
        .validation-message strong { color: #f8fafc; }
        .validation-summary {
            background-color: #1a233b; /* slate-800 */
            color: #f8fafc;
            border: 1px solid #334155;
        }
        .validation-summary.bg-red-200 { background-color: #450a0a; border-color: #dc2626; color: #fecaca; }
        .validation-summary.bg-yellow-200 { background-color: #422006; border-color: #f59e0b; color: #fffbeb; }
        .validation-summary.bg-green-200 { background-color: #064e3b; border-color: #10b981; color: #d1fae5; }
        /* Tooltips - Maintain visibility and readability */
        [data-tooltip]:before, [data-tooltip]:after {
            background-color: #334155; /* slate-700 */
            color: #f8fafc;
            border-radius: 0.375rem;
            font-size: 0.75rem;
        }
        [data-tooltip]:after {
            border-top-color: #334155; /* slate-700 */
        }
        /* Inputs and Selects */
        input[type="number"], input[type="range"] {
            background-color: #1a233b; /* slate-800 */
            border-color: #334155; /* slate-700 */
            color: #e2e8f0; /* slate-200 */
            border-radius: 0.375rem; /* rounded-md */
        }
        input[type="number"]:focus, input[type="range"]::-webkit-slider-thumb:focus {
            border-color: #0ea5e9; /* sky-500 */
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.5); /* Focus ring */
            background-color: #1a233b; /* Ensure background doesn't change on focus */
        }
        label {
            color: #cbd5e1; /* slate-300 */
        }
        /* Styles for slider value text */
        span[id$="-valor"] {
            color: #81e6d9; /* a green/cyan tone for values */
        }
        /* NEW: Compact Chart Styles */
        .compact-chart {
            padding: 1rem;
        }
        .compact-chart h4 {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        /* NEW: Horizontal Control Styles */
        .control-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 1rem;
            align-items: center;
        }
        .control-grid label {
            text-align: left;
            white-space: nowrap;
        }
        .control-grid .slider-container {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
        }
        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
        }
        
        /* NEW: Financing Matrix Styles */
        #financing-matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #financing-matrix-table th, #financing-matrix-table td {
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #1e293b;
        }
        #financing-matrix-table th {
            font-size: 0.8rem;
            font-weight: 600;
        }
        #financing-matrix-table td:first-child {
            text-align: left;
            font-weight: 500;
        }
        #financing-matrix-table input[type="number"] {
            width: 100%;
            padding: 0.25rem;
            font-size: 0.85rem;
            text-align: right;
            -moz-appearance: textfield;
        }
        #financing-matrix-table input[type="number"]::-webkit-outer-spin-button,
        #financing-matrix-table input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Dynamic Validation Styles */
        .validation-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
        }
        .validation-warning {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2) !important;
        }
        .validation-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) !important;
        }
        @media (max-width: 1024px) {
            .compact-chart {
                min-height: 280px;
            }
        }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Debug Panel -->
    <div id="debug-info" class="debug-info" style="display:none; position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 10px; max-height: 400px; overflow-y: auto;">
        <div id="debug-content"></div>
        <button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
    </div>
    
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header and Key Metrics -->
        <header class="mb-8 text-center bg-transparent rounded-xl p-6">
            <h1 class="text-4xl lg:text-5xl font-black text-white leading-tight tracking-tighter mb-2">Modelo Financiero - Rodando a <span class="highlight-text">Gas</span></h1>
            <p class="text-xl text-slate-400 mt-2">NIIF-Compliant | Series A Due Diligence</p>
            <p class="text-sm text-amber-400 mt-1"> ⚠️  Modelo en desarrollo - Validación continua</p>
            <button onclick="toggleDebug()" class="mt-4 bg-sky-600 hover:bg-sky-500 text-white px-4 py-2 rounded-lg font-medium transition duration-300 inline-flex items-center gap-2">
                <i data-lucide="bug" class="w-5 h-5"></i> Debug
            </button>
            <div class="mt-4 flex justify-center gap-2">
                <button class="px-3 py-1 bg-slate-800 text-white rounded border border-slate-600 text-sm">Base Case</button>
                <button class="px-3 py-1 bg-slate-700 text-slate-300 rounded border border-slate-600 text-sm">Conservative</button>
                <button class="px-3 py-1 bg-slate-700 text-slate-300 rounded border border-slate-600 text-sm">Stress Test</button>
            </div>
        </header>
        <!-- Key Metrics Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA Año 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
             <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Equity</div>
                <div class="text-2xl font-bold" id="tir-equity">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas Operativas (Año 5)</div>
                <div class="text-2xl font-bold" id="vagonetas-operativas">0</div>
            </div>
           
        </div>
        <!-- Additional row for ROE and ROIC -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg" data-tooltip="CAPEX total dividido entre unidades totales. <$750K = excelente eficiencia, >$900K = concerning para Serie A.">
                <div class="text-sm text-gray-500">Capital Efficiency</div>
                <div class="text-2xl font-bold" id="capital-per-unit">$0K</div>
                <div class="text-xs text-blue-400">CAPEX por Unidad</div>
            </div>
            <div class="metric-card p-4 rounded-lg" data-tooltip="Margin neto de intereses. >20% = excelente, 15-20% = bueno, <15% = low pricing power.">
                <div class="text-sm text-gray-500">Portfolio Yield</div>
                <div class="text-2xl font-bold" id="portfolio-yield">0.0%</div>
                <div class="text-xs text-emerald-400">Net Interest Margin</div>
            </div>
            <!-- Enhanced Debt Metrics -->
            <div class="metric-card p-4 rounded-lg" data-tooltip="Venture Debt típicamente 16-18% tasa, mayor flexibilidad pero más caro. Ideal para growth capital inicial.">
                <div class="text-sm text-gray-500">Venture Debt Residual</div>
                <div class="text-2xl font-bold" id="venture-debt-residual">$0M MXN</div>
                <div class="text-xs text-amber-400">Alto costo, flexible</div>
            </div>
            <div class="metric-card p-4 rounded-lg" data-tooltip="Deuda Comercial típicamente 12-15% tasa, menor flexibilidad pero más barata. Ideal para scaling operaciones.">
                <div class="text-sm text-gray-500">Deuda Comercial Residual</div>
                <div class="text-2xl font-bold" id="commercial-debt-residual">$0M MXN</div>
                <div class="text-xs text-emerald-400">Bajo costo, scaling</div>
            </div>
            
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Capital Total Requerido</div>
                <div class="text-2xl font-bold" id="total-equity-required">$0M MXN</div>
                <div class="text-xs text-blue-400">Serie A + Capital Calls</div>
            </div>
            <div class="metric-card p-4 rounded-lg" data-tooltip="DSCR = EBITDA / Debt Service. >2.0x = excelente, 1.5-2.0x = bueno, <1.5x = riesgo. Critical para covenant compliance.">
                <div class="text-sm text-gray-500">Debt Service Coverage</div>
                <div class="text-2xl font-bold" id="dscr-final">0.0x</div>
                <div class="text-xs text-sky-400">EBITDA/Debt Service</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Break-even FCF</div>
                <div class="text-2xl font-bold" id="fcf-breakeven-year">Año 0</div>
                <div class="text-xs text-blue-400">Año de FCF Positivo</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Autosuficiencia</div>
                <div class="text-2xl font-bold" id="autosuficiency-year">Año 0</div>
                <div class="text-xs text-blue-400">Ingresos > Gastos Operativos</div>
            </div>
             <div class="metric-card p-4 rounded-lg" data-tooltip="Valor total del portfolio activo (receivables). Muestra escala del negocio de financiamiento.">
                <div class="text-sm text-gray-500">Active Portfolio</div>
                <div class="text-2xl font-bold" id="active-portfolio-value">$0M MXN</div>
                <div class="text-xs text-purple-400">Receivables + Interest</div>
            </div>
            <div class="metric-card p-4 rounded-lg" data-tooltip="Revenue generado por cada peso de funding. >0.8x = excelente capital productivity, <0.6x = concerning.">
                <div class="text-sm text-gray-500">Funding Efficiency</div>
                <div class="text-2xl font-bold" id="funding-efficiency">0.0x</div>
                <div class="text-xs text-cyan-400">Revenue/Total Funding</div>
            </div>
            <div class="metric-card p-4 rounded-lg" data-tooltip="Meses de operación con cash actual. >12 meses = safe, 6-12 = adequate, <6 = risky para Series A.">
                <div class="text-sm text-gray-500">Cash Runway</div>
                <div class="text-2xl font-bold" id="cash-runway-months">0</div>
                <div class="text-xs text-orange-400">Meses de Operación</div>
            </div>
            <div class="metric-card p-4 rounded-lg" data-tooltip="CAGR de unidades 5 años. >50% = high growth, 30-50% = good, <30% = slow scaling.">
                <div class="text-sm text-gray-500">Unit CAGR</div>
                <div class="text-2xl font-bold" id="unit-growth-cagr">0%</div>
                <div class="text-xs text-pink-400">5-Year Growth Rate</div>
            </div>
        </div>
        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-slate-800">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active"> <i data-lucide="settings" class="w-5 h-5"></i> Control</button>
                <button id="tab-financieros" class="tab-button"> <i data-lucide="wallet" class="w-5 h-5"></i> Financieros</button>
                <button id="tab-niif" class="tab-button"> <i data-lucide="book" class="w-5 h-5"></i> NIIF</button>
                <button id="tab-graficos" class="tab-button"> <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Gráficos</button>
                <button id="tab-validacion" class="tab-button"> <i data-lucide="check-circle" class="w-5 h-5"></i> Validación</button>
            </nav>
        </div>
        <!-- Tab Content: Control -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- COLUMNA IZQUIERDA: El Modelo de Negocio (¿Qué y Cómo Vendemos?) -->
                <div class="space-y-6">
                    <!-- Tarjeta 1: Paquete Financiado (El Producto Principal) -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">   📦    Paquete Financiado <span class="text-sm text-slate-400">(El Producto Principal)</span></h4>
                        <div id="paquete-financiado-controls" class="space-y-4"></div>
                        <div id="package-summary" class="mt-4 p-3 bg-slate-800 rounded"></div>
                    </div>
                    <!-- Tarjeta 2: Condiciones del Crédito al Cliente -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">   📝    Condiciones del Crédito al Cliente</h4>
                        <div id="condiciones-credito-controls" class="space-y-4"></div>
                    </div>
                    <!-- Tarjeta 3: Ingresos Operativos Adicionales -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">   💸    Ingresos Operativos Adicionales</h4>
                        <div id="ingresos-adicionales-controls" class="space-y-4"></div>
                    </div>
                </div>
                <!-- COLUMNA DERECHA: La Estrategia (Crecimiento y Riesgo) -->
                <div class="space-y-6">
                    <!-- Tarjeta 4: Plan de Crecimiento y Operaciones -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">   📈    Plan de Crecimiento y Operaciones</h4>
                        <div id="plan-crecimiento-controls" class="space-y-4"></div>
                    </div>
                     <!-- Tarjeta 5: Matriz de Financiamiento -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">   💰    Matriz de Financiamiento <span class="text-sm text-slate-400">(La Historia del Capital)</span></h4>
                        <div id="matriz-financiamiento-controls" class="space-y-4"></div>
                        <!-- ================================================================= -->
                        <!-- ========= PASO 3: UI PARA COBERTURA - INICIO ==================== -->
                        <!-- ================================================================= -->
                        <div id="funding-coverage-card-container" class="mt-4"></div>
                        <!-- ================================================================= -->
                        <!-- ========= PASO 3: UI PARA COBERTURA - FIN ======================= -->
                        <!-- ================================================================= -->
                    </div>
                    <!-- Tarjeta 6: Riesgo y Supuestos de Salida -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">   🛡️    Riesgo y Supuestos de Salida</h4>
                        <div id="riesgo-salida-controls" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            <!-- RECALCULATE BUTTON -->
            <div class="text-center mt-6">
                <button onclick="forceCalculate()" class="mt-6 bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-lg font-medium transition duration-300 inline-flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i> Recalcular Modelo
                </button>
            </div>
        </div>
        <!-- Tab Content: Financials -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-white">Estado de Resultados (P&L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-white">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 0</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4 text-white">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body"></tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4 text-center font-semibold p-2 rounded-lg bg-gray-50"></div>
                </div>
            </div>
        </div>
        <!-- Tab Content: IFRS -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4 text-white">NIIF 15 - Reconocimiento de Ingresos <span class="text-sm text-slate-400">(Cómo se reconocen los ingresos del negocio de financiamiento)</span></h3>
                    <div id="niif15-container">Calculando datos NIIF 15...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4 text-white">NIIF 9 - Provisiones Crediticias <span class="text-sm text-slate-400">(Impacto de la morosidad y las pérdidas esperadas)</span></h3>
                    <div id="niif9-container">Calculando datos NIIF 9...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4 text-white">NIIF 5 - Activos Mantenidos para Venta <span class="text-sm text-slate-400">(Tratamiento contable de vagonetas reposedas)</span></h3>
                    <div id="niif5-container">Calculando datos NIIF 5...</div>
                </div>
            </div>
        </div>
        <!-- Tab Content: Charts -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Row 1: Core Differentiation -->
                <div class="xl:col-span-2 card">
                    <h4 class="text-lg font-semibold mb-3 text-white"> 🛡️  Protección Rodando™ Impact</h4>
                    <div style="height: 320px;"><canvas id="proteccionImpactChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="text-lg font-semibold mb-3 text-white"> 📈  Revenue Evolution</h4>
                    <div style="height: 320px;"><canvas id="revenueEvolutionChart"></canvas></div>
                </div>
                <!-- Row 2: Scaling & Efficiency -->
                <div class="card">
                    <h4 class="text-lg font-semibold mb-3 text-white"> 🚀  Capital Efficiency</h4>
                    <div style="height: 300px;"><canvas id="capitalEfficiencyChart"></canvas></div>
                </div>
                <div class="xl:col-span-2 card">
                    <h4 class="text-lg font-semibold mb-3 text-white"> 💸  Cash Flow Resilience</h4>
                    <div style="height: 300px;"><canvas id="cashFlowResilienceChart"></canvas></div>
                </div>
                <!-- Row 3: Future & Leadership -->
                <div class="card">
                    <h4 class="text-lg font-semibold mb-3 text-white"> 🎮  Gamification Impact</h4>
                    <div style="height: 280px;"><canvas id="gamificationChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="text-lg font-semibold mb-3 text-white"> 🏁  Path to Leadership</h4>
                    <div style="height: 280px;"><canvas id="leadershipChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="text-lg font-semibold mb-3 text-white"> 🔍  Competitive Moat</h4>
                    <div style="height: 280px;"><canvas id="moatChart"></canvas></div>
                </div>
            </div>
        </div>
        <!-- Tab Content: Validation -->
        <div id="content-validacion" class="content-section">
            <div id="validation-panel-content">
                <h3 class="text-xl font-semibold mb-4 text-white">Resultados de Validación del Modelo</h3>
                <div id="validation-results-container">
                    <!-- Validation results will be inserted here -->
                </div>
                <button onclick="generateValidationReportPDF()" class="mt-6 bg-sky-600 hover:bg-sky-500 text-white px-6 py-3 rounded-lg font-medium transition duration-300 inline-flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5"></i> Generar Reporte PDF
                </button>
            </div>
        </div>
    </div>
    <script>
        // Initializes Lucide icons
        lucide.createIcons();
        // ===== GLOBAL MODEL VARIABLES =====
        let debugLogs = []; // Array to store debug logs
        let charts = {}; // Object to store Chart.js instances
        
        /**
         * @typedef {Object} ModelData
         * This object holds all the dynamic inputs for the financial model.
         */
        let modelData = {
            tasaInteres: 25.5,
            pdStage1: 0.008,
            ebitdaMultipleProject: 7,
            ebitdaMultipleEquity: 7,
            
            proteccionRodando: true,
            pdStage2: 0.08,
            pdStage3: 0.40,
            lgd: 0.50,
            portfolioAllocationStage1: 0.85,
            portfolioAllocationStage2: 0.10,
            portfolioAllocationStage3: 0.05,
            economicAdjustmentFactor: 1.0,
            margenRefacciones: 50,
            periodoAmortizacionDeuda: 5,
            unitsPerYear: [40, 120, 180, 220, 220],
            vanCost: 641000,
            vanPrice: 729000,
            clientLoanTermYears: 4,
            depreciationYears: 10,
            opexRates: [17, 17, 15, 15, 15], 
            margenVagoneta: 5,
            tasaReposicion: 5,
            fairValueVenta: 85,
            costosVenta: 5,
            corporateTaxRate: 31,
            litrosPromedioMensualPorUnidad: 900,
            precioLitroGNV: 13.99,
            comisionGNVPorcentaje: 10,
            gmvPromedioMensualPorUnidad: 9000,
            takeRateMarketplace: 2.5,
            ventureDebtLineMax: 50000000,
            downPaymentPercentage: 15,
            upfrontCommissionPercentage: 3,
            conversionPrice: 54000,
            bancasPrice: 21000,
            gpsPrice: 12000,
            insuranceAnnualPrice: 37205,
            insuranceYears: 4,
            conversionCost: 50000,
            bancasCost: 20000,
            gpsCost: 11000,
            refaccionesCostPerUnit: 8000,
            avgRemainingTermCartera: 2.5,
            floorEquityMultiple: 1.5,
            seriesA: 45000000,
            seriesB_newInvestors_year2: 200000000,
            partnerCapitalizationYear2: 50000000,
            partnerCapitalizationYear3: 50000000,
            partnerCapitalizationYear4: 50000000,
            partnerCapitalizationYear5: 50000000,
            ventureDebtYear1: 55000000,
            ventureDebtYear2: 35000000,
            ventureDebtYear3: 0,
            ventureDebtYear4: 0,
            ventureDebtYear5: 0,
            commercialDebtYear1: 0,
            commercialDebtYear2: 0,
            commercialDebtYear3: 60000000,
            commercialDebtYear4: 100000000,
            commercialDebtYear5: 50000000,
            ventureDebtRate: 18,
            commercialDebtRate: 14,
        };
        
        // UI controls configuration by section
        const controlsConfig = {
            paqueteFinanciado: [
                { id: 'vanPrice', label: 'Precio Vagoneta Base', min: 650000, max: 900000, step: 5000, type: 'number', format: val => formatCurrency(val, true), tooltip: '  📊   Serie A guidance: Margen >15% vs costo para unit economics defendibles', investorRange: { green: [729000, 800000], yellow: [680000, 729000], red: [650000, 680000] } },
                { id: 'conversionPrice', label: 'Precio Conversión GNV', min: 45000, max: 70000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Margen típico: 8-15% sobre costo de conversión' },
                { id: 'bancasPrice', label: 'Precio Bancas GNV', min: 18000, max: 26000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Premium sobre costo: 5-30% según diferenciación' },
                { id: 'gpsPrice', label: 'Precio GPS/Telemática', min: 11000, max: 20000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Value-add service: Margen 20-60% típico' },
                { id: 'insuranceAnnualPrice', label: 'Seguro Anual', min: 25000, max: 40000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Pass-through cost: Sin margen para RAG' },
                { id: 'insuranceYears', label: 'Años Seguro', min: 2, max: 4, step: 1, type: 'number', format: val => val.toFixed(0) + ' años', tooltip: '  ⚖️   Balance: Más años = mayor loan size = mejor unit economics' },
                { id: 'vanCost', label: 'Costo Vagoneta (RAG)', min: 500000, max: 700000, step: 5000, type: 'number', format: val => formatCurrency(val, true), tooltip: '  🎯   Critical: Debe ser <85% del precio para margen mínimo Serie A', investorRange: { green: [500000, 580000], yellow: [580000, 620000], red: [620000, 700000] } },
                { id: 'conversionCost', label: 'Costo Conversión GNV', min: 40000, max: 65000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo directo: Incluye instalación y certificación' },
                { id: 'bancasCost', label: 'Costo Bancas GNV', min: 17000, max: 24000, step: 1000, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Costo manufacturng: Base para pricing strategy' },
                { id: 'gpsCost', label: 'Costo GPS/Telemática', min: 9000, max: 18000, step: 500, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Hardware + instalación: Optimizar para escala' },
            ],
            condicionesCredito: [
                { id: 'tasaInteres', label: 'Tasa de Interés (Clientes)', min: 22, max: 30, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: '  📊   Serie A benchmark: 25-30% sweet spot. <22% = unsustainable unit economics, >30% = regulatory risk', investorRange: { green: [25, 30], yellow: [22, 25], red: [30, 35] } },
                { id: 'downPaymentPercentage', label: '% Enganche Cliente', min: 12, max: 25, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: '  💰   Cash flow vs accessibility: 15-20% optimal. <12% = cash flow stress, >25% = market limitation', investorRange: { green: [15, 20], yellow: [12, 15], red: [20, 25] } },
                { id: 'clientLoanTermYears', label: 'Plazo Préstamo Cliente (Años)', min: 3, max: 5, step: 1, type: 'range', format: val => val.toFixed(0) + ' años', tooltip: '  ⚖️   Payment vs interest: 4 años = optimal balance. 3 años = high payments, 5+ años = interest rate risk', investorRange: { green: [4, 4], yellow: [3, 4], red: [5, 5] } },
                { id: 'upfrontCommissionPercentage', label: '% Comisión Upfront', min: 1, max: 4, step: 0.1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'NIIF 15 deferral: 2-3% típico para cash flow inicial sin penalizar accesibilidad' },
            ],
            ingresosAdicionales: [
                { id: 'litrosPromedioMensualPorUnidad', label: 'Litros GNV/Unidad (Mensual)', min: 800, max: 1000, step: 10, type: 'number', format: val => val.toFixed(0) + ' L', tooltip: 'Usage pattern: 900L = optimal efficiency. Dependiente de rutas y utilización' },
                { id: 'precioLitroGNV', label: 'Precio Litro GNV (MXN)', min: 12.50, max: 13.99, step: 0.01, type: 'number', format: val => '$' + val.toFixed(2) + ' MXN', tooltip: 'Market price: RAG no controla, pero impacta commission revenue' },
                { id: 'comisionGNVPorcentaje', label: 'Comisión GNV (%)', min: 8, max: 13, step: 0.1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: '  🚀   Recurring revenue: 10-12% competitive. <8% = low value capture, >13% = partner resistance' },
                { id: 'gmvPromedioMensualPorUnidad', label: 'Ventas Brutas Marketplace/Unidad (Mensual)', min: 6000, max: 12000, step: 100, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Marketplace traction: $9K = baseline, growth dependent on platform adoption' },
                { id: 'takeRateMarketplace', label: 'Take Rate Marketplace (%)', min: 1.5, max: 2.0, step: 0.1, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Platform economics: 2% competitive vs other B2B marketplaces. Limited upside near-term' },
                { id: 'refaccionesCostPerUnit', label: 'Costo Refacciones/Unidad', min: 5000, max: 10000, step: 200, type: 'number', format: val => formatCurrency(val, true), tooltip: 'Service cost base: Optimizar para margen pero mantener quality' },
                { id: 'margenRefacciones', label: 'Margen Refacciones', min: 20, max: 35, step: 1, type: 'range', format: val => val.toFixed(0) + '%', tooltip: '  🔧   Service margin: 25-30% realistic. <20% = low profitability, >35% = price resistance' },
            ],
            planCrecimiento: [
                { id: 'unitsPerYear', label: 'Unidades por Año', type: 'array', min: 0, max: 'dynamic', step: 1, format: val => val.toFixed(0), tooltip: '  💸   Capital efficiency crítica: Más unidades = más capital needs. ROI debe mantenerse >25%. Máximo basado en funding disponible.', dynamicMax: true },
                // =================================================================
                // ========= PASO 3: UI PARA OPEX - INICIO =========================
                // =================================================================
                { id: 'opexRates', label: 'Tasa OPEX por Año (%)', type: 'array', min: 12, max: 20, step: 0.5, format: val => val.toFixed(1) + '%', tooltip: 'Eficiencia operativa por año. Se espera que disminuya con la escala.' },
                // =================================================================
                // ========= PASO 3: UI PARA OPEX - FIN ============================
                // =================================================================
                { id: 'depreciationYears', label: 'Años Depreciación (Vagoneta)', min: 8, max: 12, step: 1, type: 'number', format: val => val.toFixed(0) + ' años', tooltip: 'Asset life: 10 años = standard. 8 años = conservative, 12 años = aggressive' },
            ],
            riesgoYSalida: [
                { id: 'proteccionRodando', label: 'Protección Rodando™', type: 'checkbox', tooltip: '  🛡️   Competitive advantage: 50% provision reduction vs traditional lending' },
                { id: 'pdStage1', label: 'PD Etapa 1 (12M)', min: 0.003, max: 0.012, step: 0.001, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: '  📊   Serie A reality check: 0.8% es una base conservadora. <0.5% = optimista, >1.2% = riesgo alto.', investorRange: { green: [0.004, 0.008], yellow: [0.003, 0.004], red: [0.008, 0.012] } },
                { id: 'pdStage2', label: 'PD Etapa 2 (Lifetime)', min: 0.06, max: 0.12, step: 0.005, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: '  ⚖️   Lifetime default: 7-10% benchmark. <6% = optimistic, >12% = high risk segment', investorRange: { green: [0.07, 0.10], yellow: [0.06, 0.07], red: [0.10, 0.12] } },
                { id: 'pdStage3', label: 'PD Etapa 3 (Lifetime)', min: 0.30, max: 0.50, step: 0.01, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: '  🚨   Impaired assets: 35-45% realistic. <30% = recovery overestimate, >50% = write-off territory' },
                { id: 'lgd', label: 'LGD (Pérdida Incumplimiento)', min: 0.45, max: 0.60, step: 0.01, type: 'range', format: val => (val * 100).toFixed(1) + '%', tooltip: '  💔   Loss severity: 50-55% typical for vehicle collateral. Asset depreciation + recovery costs' },
                { id: 'portfolioAllocationStage1', label: 'Port. Etapa 1 (%)', min: 0.75, max: 0.90, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '  ✅   Healthy portfolio: 80-87% in Stage 1. >90% = unrealistic, <75% = risk concentration' },
                { id: 'portfolioAllocationStage2', label: 'Port. Etapa 2 (%)', min: 0.08, max: 0.18, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '  ⚠️   Watch list: 10-15% normal. <8% = understated, >18% = portfolio stress' },
                { id: 'portfolioAllocationStage3', label: 'Port. Etapa 3 (%)', min: 0.02, max: 0.08, step: 0.01, type: 'range', format: val => (val * 100).toFixed(0) + '%', tooltip: '  🚨   Problem loans: 3-6% manageable. >8% = collection issues, <2% = unrealistic' },
                { id: 'tasaReposicion', label: '% Unidades Reposición', min: 3, max: 7, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%', tooltip: '  🔄   Repossession rate: 4-6% realistic. <3% = recovery overestimate, >7% = business model stress' },
                { id: 'fairValueVenta', label: '% Fair Value Venta', min: 80, max: 88, step: 1, type: 'number', format: val => val.toFixed(0) + '%', tooltip: '  💰   Recovery value: 85% reasonable for well-maintained vehicles. Market dependent' },
                { id: 'costosVenta', label: '% Costos Venta', min: 4, max: 8, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%', tooltip: '  💸   Transaction costs: 5-6% typical (storage, auction, legal, transport)' },
                { id: 'ebitdaMultipleProject', label: 'Múltiplo EBITDA TIR Proyecto', min: 5, max: 9, step: 0.5, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: '  🎯   Valuation realista: 7x es una base conservadora. Equipment finance típico 6-8x.' },
                { id: 'ebitdaMultipleEquity', label: 'Múltiplo EBITDA TIR Equity', min: 5, max: 9, step: 0.5, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: '  💎   Exit multiple: 7x es una base conservadora. 8-9x = IPO/escenario optimista.' },
                { id: 'avgRemainingTermCartera', label: 'Término Residual Cartera (Años)', min: 2, max: 4, step: 0.1, type: 'range', format: val => val.toFixed(1) + ' años', tooltip: 'Portfolio maturity: 2.5 años = weighted average remaining term' },
                { id: 'floorEquityMultiple', label: 'Floor Book Value Equity', min: 1.0, max: 2.0, step: 0.1, type: 'range', format: val => val.toFixed(1) + 'X', tooltip: '  📚   Downside protection: 1.2-1.5x = conservative liquidation scenario, >1.5x = optimistic asset recovery.' },
                { id: 'ventureDebtRate', label: 'Tasa Venture Debt', min: 14, max: 20, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: '  ⚖️   Risk balance: 16-18% market rate. >18% = covenant risk, debt service stress con commercial debt', investorRange: { green: [16, 18], yellow: [14, 16], red: [18, 20] } },
                { id: 'commercialDebtRate', label: 'Tasa Deuda Comercial', min: 12, max: 16, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: '  🏦   Blended target: Total debt service <35% EBITDA. Monitor combined with venture debt para DSCR saludable', investorRange: { green: [13, 15], yellow: [12, 13], red: [15, 16] } }
            ],
        };
        
        // Object to store calculated financial results
        let financialResults = {
            pl: [],             // Profit & Loss
            cf: [],             // Cash Flow
            bs: [],             // Balance Sheet
            niifDetails: [],    // IFRS application details
            tirProyecto: 0,     // Project Internal Rate of Return
            tirCartera: 0,      // Customer Portfolio Internal Rate of Return
            tirEquity: 0,       // Equity Internal Rate of Return
            roe: [],            // Annual Return on Equity
            roic: []            // Annual Return on Invested Capital
        };
        
        // New global array for IFRS 5 assets
        let heldForSaleAssets = [];
        
        // Tolerance for balance sheet validation (MXN)
        const BALANCE_TOLERANCE = 1000;
        
        // ===== DEBUG FUNCTIONS =====
        /**
         * Logs messages to the console and the UI debug panel.
         * @param {string} message - The message to log.
         * @param {any} [data=null] - Additional data to log (optional).
         */
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.unshift(logEntry); // Add to the beginning
            if (debugLogs.length > 50) debugLogs.pop(); // Keep only the last 50 logs
            
            console.log(logEntry, data);
            updateDebugPanel();
        }
        
        /**
         * Updates the content of the debug panel in the UI.
         */
        function updateDebugPanel() {
            const panel = document.getElementById('debug-content');
            if (panel) {
                panel.innerHTML = debugLogs.map(log => `<div style="margin-bottom: 2px; font-size: 10px; border-bottom: 1px dotted #4b5563; padding-bottom: 2px;">${log}</div>`).join('');
            }
        }
        
        /**
         * Shows/hides the debug panel.
         */
        function toggleDebug() {
            const panel = document.getElementById('debug-info');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // ===== HELPER FUNCTIONS =====
        /**
         * Formats a numeric value to currency format (millions, thousands, or no prefix).
         * @param {number} value - The numeric value to format.
         * @param {boolean} [full=false] - If true, use full format with commas; otherwise, use abbreviations.
         * @returns {string} The value formatted as a string.
         */
        function formatCurrency(value, full = false) {
            if (value === null || value === undefined || isNaN(value)) return '$0 MXN';
            value = parseFloat(value);
            
            if (full) {
                return '$' + value.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' MXN';
            } else if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            } else if (Math.abs(value) >= 1000) {
                return '$' + (value / 1000).toFixed(1) + 'K MXN';
            }
            return '$' + Math.round(value).toLocaleString() + ' MXN';
        }
        /**
         * Calculates the total price of financed insurance.
         * @returns {number}
         */
        function getInsuranceTotalPrice() {
            return modelData.insuranceAnnualPrice * modelData.insuranceYears;
        }
        /**
         * Calculates the TOTAL PRICE of the complete package.
         * @returns {number}
         */
        function getTotalPackagePrice() {
            return modelData.vanPrice + modelData.conversionPrice + 
                   modelData.bancasPrice + modelData.gpsPrice + getInsuranceTotalPrice();
        }
        /**
         * Calculates the TOTAL COST of the package for RAG.
         * @returns {number}
         */
        function getTotalPackageCost() {
            // Insurance has no cost for RAG (pass-through)
            return modelData.vanCost + modelData.conversionCost + 
                   modelData.bancasCost + modelData.gpsCost;
        }
        /**
         * Calculates the total CAPEX required based on current units.
         * @returns {number} Total CAPEX in MXN.
         */
        function calculateTotalCapex() {
            let totalCapex = 0;
            for (let i = 0; i < modelData.unitsPerYear.length; i++) {
                totalCapex += modelData.unitsPerYear[i] * getTotalPackageCost();
            }
            return totalCapex;
        }
        /**
         * Calculates the total available funding.
         * @returns {number} Total funding in MXN.
         */
        function calculateTotalFunding() {
            let totalFunding = modelData.seriesA;
            for (let i = 1; i <= 5; i++) {
                totalFunding += (modelData[`partnerCapitalizationYear${i}`] || 0) + 
                                (modelData[`ventureDebtYear${i}`] || 0) + 
                                (modelData[`commercialDebtYear${i}`] || 0) +
                                (modelData[`seriesB_newInvestors_year${i}`] || 0);
            }
            return totalFunding;
        }
        /**
         * Calculates the total Venture Debt.
         * @returns {number} Total Venture Debt in MXN.
         */
        function getTotalVentureDebt() {
            let total = 0;
            for (let i = 1; i <= 5; i++) {
                total += (modelData[`ventureDebtYear${i}`] || 0);
            }
            return total;
        }
        /**
         * Calculates the total Commercial Debt.
         * @returns {number} Total Commercial Debt in MXN.
         */
        function getTotalCommercialDebt() {
            let total = 0;
            for (let i = 1; i <= 5; i++) {
                total += (modelData[`commercialDebtYear${i}`] || 0);
            }
            return total;
        }
        /**
         * Calculates the residual balance of Venture Debt for a given year.
         * @param {number} year - The projection year (1-5).
         * @returns {number} The residual balance of Venture Debt.
         */
        function getVentureDebtBalance(year) {
            let balance = 0;
            for (let i = 1; i <= year; i++) {
                balance += (modelData[`ventureDebtYear${i}`] || 0);
            }
            // Assume linear amortization over an average of 3 years
            const yearsElapsed = year;
            const avgAmortizationYears = 3;
            const amortizationRate = Math.min(yearsElapsed / avgAmortizationYears, 1);
            return balance * (1 - amortizationRate * 0.6); // 60% average amortization
        }
        /**
         * Calculates the residual balance of Commercial Debt for a given year.
         * @param {number} year - The projection year (1-5).
         * @returns {number} The residual balance of Commercial Debt.
         */
        function getCommercialDebtBalance(year) {
            let balance = 0;
            for (let i = 1; i <= year; i++) {
                balance += (modelData[`commercialDebtYear${i}`] || 0);
            }
            // Assume linear amortization over an average of 5 years
            const yearsElapsed = year;
            const avgAmortizationYears = 5;
            const amortizationRate = Math.min(yearsElapsed / avgAmortizationYears, 1);
            return balance * (1 - amortizationRate * 0.4); // 40% average amortization
        }
        /**
         * Calculates the final Debt Service Coverage Ratio.
         * @returns {number} DSCR based on Year 5 EBITDA and total debt service.
         */
        function calculateFinalDSCR() {
            if (!financialResults.pl || financialResults.pl.length < 5) return 0;
            
            const year5EBITDA = financialResults.pl[4].ebitda;
            const ventureDebtBalance = getVentureDebtBalance(5);
            const commercialDebtBalance = getCommercialDebtBalance(5);
            
            const ventureDebtService = ventureDebtBalance * (modelData.ventureDebtRate / 100);
            const commercialDebtService = commercialDebtBalance * (modelData.commercialDebtRate / 100);
            const totalDebtService = ventureDebtService + commercialDebtService;
            
            return totalDebtService > 0 ? year5EBITDA / totalDebtService : 999;
        }
        /**
         * Calculates granular debt metrics for Serie A analysis.
         * @returns {Object} Debt metrics breakdown.
         */
        function calculateDebtMetricsBreakdown() {
            const ventureBalance = getVentureDebtBalance(5);
            const commercialBalance = getCommercialDebtBalance(5);
            const finalDSCR = calculateFinalDSCR();
            
            return {
                ventureDebtResidual: ventureBalance,
                commercialDebtResidual: commercialBalance,
                totalDebtResidual: ventureBalance + commercialBalance,
                finalDSCR: finalDSCR,
                debtMix: {
                    venturePercent: (ventureBalance + commercialBalance) > 0 ? 
                        (ventureBalance / (ventureBalance + commercialBalance)) * 100 : 0,
                    commercialPercent: (ventureBalance + commercialBalance) > 0 ? 
                        (commercialBalance / (ventureBalance + commercialBalance)) * 100 : 0
                },
                isHealthyDSCR: finalDSCR >= 1.5,
                riskLevel: finalDSCR >= 2.0 ? 'low' : finalDSCR >= 1.5 ? 'medium' : 'high'
            };
        }
        
        /**
         * Calculates the maximum number of financeable units.
         * @returns {number} Maximum number of units.
         */
        function calculateMaxUnitsFinanceable() {
            const totalFunding = calculateTotalFunding();
            const packageCost = getTotalPackageCost();
            if (packageCost === 0) return 9999;
            return Math.floor(totalFunding / packageCost);
        }
        /**
         * Calculates projected debt service coverage ratio.
         * @returns {Object} DSCR analysis.
         */
        function calculateDebtServiceCoverage() {
            const totalVentureDebt = getTotalVentureDebt();
            const totalCommercialDebt = getTotalCommercialDebt();
            const ventureInterest = totalVentureDebt * (modelData.ventureDebtRate / 100);
            const commercialInterest = totalCommercialDebt * (modelData.commercialDebtRate / 100);
            const totalDebtService = ventureInterest + commercialInterest;
            
            // Conservative EBITDA estimate based on funding and margins
            const estimatedRevenue = calculateTotalFunding() * 0.8; // 80% capital efficiency
            const estimatedEBITDA = estimatedRevenue * 0.25; // 25% EBITDA margin target
            
            const dscr = totalDebtService > 0 ? estimatedEBITDA / totalDebtService : 999;
            
            return {
                totalDebtService,
                estimatedEBITDA,
                dscr,
                isHealthy: dscr >= 1.5,
                maxSafeVentureRate: totalVentureDebt > 0 ? (estimatedEBITDA * 0.2) / totalVentureDebt * 100 : 20,
                maxSafeCommercialRate: totalCommercialDebt > 0 ? (estimatedEBITDA * 0.15) / totalCommercialDebt * 100 : 16
            };
        }
        /**
         * Evaluates unit economics health.
         * @returns {Object} Unit economics analysis.
         */
        function evaluateUnitEconomics() {
            const totalPrice = getTotalPackagePrice();
            const totalCost = getTotalPackageCost();
            const margin = totalPrice - totalCost;
            const marginPercent = totalPrice > 0 ? (margin / totalPrice) * 100 : 0;
            
            return {
                margin,
                marginPercent,
                isHealthy: marginPercent >= 15,
                investorGrade: marginPercent >= 20 ? 'excellent' : marginPercent >= 15 ? 'good' : marginPercent >= 10 ? 'concerning' : 'critical'
            };
        }
        
        function calculateSeriesAMetrics() {
            if (!financialResults.pl || financialResults.pl.length === 0) return {};
            
            const totalUnits = modelData.unitsPerYear.reduce((sum, units) => sum + units, 0);
            const totalCapex = totalUnits * getTotalPackageCost();
            const year5Index = financialResults.pl.length - 1;
            
            const capitalPerUnit = totalUnits > 0 ? totalCapex / totalUnits : 0;
            
            const totalInterestRevenue = financialResults.pl.reduce((sum, pl) => sum + (pl.interestRevenue || 0), 0);
            const totalPortfolioProvisions = financialResults.pl.reduce((sum, pl) => sum + (pl.provisions || 0), 0);
            const netInterestRevenue = totalInterestRevenue - totalPortfolioProvisions;
            
            let totalPortfolioYears = 0;
            let weightedPortfolio = 0;
            financialResults.bs.forEach((bs, index) => {
                if (bs.receivables > 0) {
                    totalPortfolioYears++;
                    weightedPortfolio += bs.receivables;
                }
            });
            const avgPortfolio = totalPortfolioYears > 0 ? weightedPortfolio / totalPortfolioYears : 1;
            const portfolioYield = avgPortfolio > 0 ? (netInterestRevenue / avgPortfolio) * (5 / totalPortfolioYears) * 100 : 0;
            
            const activePortfolioValue = financialResults.bs[year5Index]?.receivables || 0;
            
            const cumulativeRevenue = financialResults.pl.reduce((sum, pl) => sum + (pl.totalRevenue || 0), 0);
            const totalFunding = calculateTotalFunding();
            const fundingEfficiency = totalFunding > 0 ? cumulativeRevenue / totalFunding : 0;
            
            const currentCash = financialResults.bs[year5Index]?.cash || 0;
            const year5Opex = financialResults.pl[year5Index]?.opex || 0;
            const monthlyBurn = year5Opex > 0 ? year5Opex / 12 : 1;
            const cashRunwayMonths = currentCash / monthlyBurn;
            
            const year1Units = modelData.unitsPerYear[0] || 1;
            const finalYearUnits = totalUnits;
            const unitCAGR = year1Units > 0 ? (Math.pow(finalYearUnits / year1Units, 1/5) - 1) * 100 : 0;
            
            return {
                capitalPerUnit: capitalPerUnit / 1000,
                portfolioYield: Math.max(0, portfolioYield),
                activePortfolioValue: activePortfolioValue,
                fundingEfficiency: fundingEfficiency,
                cashRunwayMonths: Math.min(Math.max(0, cashRunwayMonths), 999),
                unitCAGR: Math.max(0, unitCAGR),
                benchmarks: {
                    capitalPerUnitGood: capitalPerUnit / 1000 <= 750,
                    portfolioYieldGood: portfolioYield >= 15,
                    fundingEfficiencyGood: fundingEfficiency >= 0.6,
                    cashRunwayGood: cashRunwayMonths >= 12,
                    unitCAGRGood: unitCAGR >= 30
                }
            };
        }
        /**
         * Calculates general investor score.
         * @returns {Object} Investor health score.
         */
        function calculateInvestorScore() {
            const unitEcon = evaluateUnitEconomics();
            const debtService = calculateDebtServiceCoverage();
            
            let score = 10;
            let issues = [];
            
            // Unit economics (40% weight)
            if (unitEcon.marginPercent < 10) { score -= 4; issues.push('  🚨   Unit economics críticos (<10%)'); }
            else if (unitEcon.marginPercent < 15) { score -= 2; issues.push('  ⚠️   Unit economics bajos (<15%)'); }
            
            // Debt service (30% weight)
            if (debtService.dscr < 1.2) { score -= 3; issues.push('  🚨   DSCR crítico (<1.2x)'); }
            else if (debtService.dscr < 1.5) { score -= 1.5; issues.push('  ⚠️   DSCR bajo (<1.5x)'); }
            
            // Risk assumptions (20% weight)
            if (modelData.pdStage1 < 0.003) { score -= 1; issues.push('  📊   PD Stage 1 optimista'); }
            if (modelData.tasaInteres < 22) { score -= 1; issues.push('  💰   Tasa cliente insostenible'); }
            
            // Operational efficiency (10% weight)
            if (modelData.opexRates.some(rate => rate > 18)) { 
                score -= 1; 
                issues.push('  🚀   OPEX alto (>18% en algún año)'); 
            }
            
            // Enhanced debt structure analysis (10% weight)
            const debtMetrics = calculateDebtMetricsBreakdown();
            if (debtMetrics.finalDSCR < 1.5) { 
                score -= 1; 
                issues.push('  🏦   DSCR final bajo (<1.5x)'); 
            }
            if (debtMetrics.debtMix.venturePercent > 60) { 
                score -= 0.5; 
                issues.push('  ⚠️   Alta dependencia Venture Debt (>60%)'); 
            }
            if (financialResults.bs.length > 4 && financialResults.bs[4].equity > 0 && debtMetrics.totalDebtResidual > financialResults.bs[4].equity * 2) { 
                score -= 0.5; 
                issues.push('  📊   Leverage alto (Debt/Equity >2x)'); 
            }
            
            return {
                score: Math.max(0, score),
                grade: score >= 8.5 ? 'A' : score >= 7 ? 'B' : score >= 5 ? 'C' : 'D',
                issues,
                isInvestable: score >= 6.5
            };
        }
        /**
         * Shows a temporary warning in the UI.
         * @param {string} message - Warning message.
         */
        function showWarning(message) {
            const existingWarning = document.getElementById('dynamic-warning');
            if (existingWarning) existingWarning.remove();
            
            const warning = document.createElement('div');
            warning.id = 'dynamic-warning';
            warning.className = 'fixed top-20 right-4 bg-amber-900 border border-amber-600 text-amber-200 px-4 py-2 rounded-lg z-50';
            warning.innerHTML = `<span class="text-sm">${message}</span>`;
            document.body.appendChild(warning);
            
            setTimeout(() => {
                if (warning && warning.parentNode) {
                    warning.parentNode.removeChild(warning);
                }
            }, 4000);
        }
        /**
         * Updates investor score dashboard
         */
        function updateInvestorScore() {
            const investorScore = calculateInvestorScore();
            let scoreContainer = document.getElementById('investor-score-card');
            
            if (!scoreContainer) {
                // Create investor score card in header
                const header = document.querySelector('header');
                const scoreCard = document.createElement('div');
                scoreCard.id = 'investor-score-card';
                header.appendChild(scoreCard);
                scoreContainer = scoreCard;
            }
            
            const gradeColor = {
                'A': 'bg-emerald-900 border-emerald-600 text-emerald-200',
                'B': 'bg-blue-900 border-blue-600 text-blue-200', 
                'C': 'bg-amber-900 border-amber-600 text-amber-200',
                'D': 'bg-red-900 border-red-600 text-red-200'
            }[investorScore.grade];
            
            scoreContainer.className = `mt-4 p-4 rounded-lg border ${gradeColor}`;
            scoreContainer.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold">  📊   Investor Health Score</h3>
                        <p class="text-sm opacity-80">Serie A Investment Readiness</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold">${investorScore.score.toFixed(1)}/10</div>
                        <div class="text-lg font-semibold">Grade ${investorScore.grade}</div>
                        <div class="text-xs">${investorScore.isInvestable ? '  ✅   Investable' : '  ❌   Needs Work'}</div>
                    </div>
                </div>
                ${investorScore.issues.length > 0 ? `
                    <div class="mt-3 pt-3 border-t border-white border-opacity-20">
                        <p class="text-sm font-medium mb-2">Key Issues:</p>
                        <ul class="text-xs space-y-1">
                            ${investorScore.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                ` : '<div class="mt-2 text-sm">  🎉   All key metrics look strong for Serie A!</div>'}
            `;
        }
        // ===== IFRS CALCULATION MODULES =====
        /**
         * Calculates the Probability of Default (PD) based on the age of the loan cohort.
         * IFRS 9: Aligns with the 3-stage model, with dynamic PDs.
         * @param {number} cohortAgeYears - Age of the loan in years.
         * @returns {number} The adjusted probability of default.
         */
        function calculatePDBasedOnAge(cohortAgeYears) {
            // Dynamic rule: PD increases 50% if loan > 2 years
            let basePD;
            if (cohortAgeYears <= 1) { // Young loans (Year 1) -> Stage 1
                basePD = modelData.pdStage1; // 12-month PD
            } else if (cohortAgeYears === 2) { // 2-year loans -> Stage 2
                basePD = modelData.pdStage2; // Lifetime PD (for Stage 2)
            } else { // 3-year or older loans -> Stage 3
                basePD = modelData.pdStage3; // Lifetime PD (for Stage 3)
                // Apply dynamic adjustment: increases 50% if loan > 2 years
                if (cohortAgeYears > 2) {
                    basePD *= 1.5;
                }
            }
            return basePD;
        }
        /**
         * Calculates the Expected Credit Loss (ECL) according to IFRS 9.
         * Process: Iterates over loan cohorts, calculates average exposure,
         * applies dynamic PD and macroeconomic adjustment factor.
         * @param {Array<Object>} loanCohorts - Array of active loan cohorts.
         * @param {number} currentYear - The current projection year (1-5).
         * @param {number} currentProvisionsBalance - Accumulated provision balance at the beginning of the year.
         * @param {number} currentYearEndReceivables - Accounts receivable balance at the end of the current year.
         * @returns {Object} Contains annual provision, accumulated balance, and details by stage.
         */
        function calculateNIIF9ECL(loanCohorts, currentYear, currentProvisionsBalance, currentYearEndReceivables) {
            const loanTermAdjustmentFactor = modelData.clientLoanTermYears === 4 ? 0.8 : 1.0;
            const adjustedPDStage1 = modelData.pdStage1 * loanTermAdjustmentFactor;
            const adjustedPDStage2 = modelData.pdStage2 * loanTermAdjustmentFactor;
            log(`     📊      NIIF 9 - Ajuste préstamos ${modelData.clientLoanTermYears} años: Factor ${loanTermAdjustmentFactor}`);
            let totalECLForYear = 0;
            let eclByStage = { stage1: 0, stage2: 0, stage3: 0 };
            
            const totalExposure = loanCohorts.reduce((sum, cohort) => sum + cohort.avgExposureDuringYear, 0);
            
            if (totalExposure > 0) {
                const stage1Exposure = totalExposure * modelData.portfolioAllocationStage1;
                const stage2Exposure = totalExposure * modelData.portfolioAllocationStage2;
                const stage3Exposure = totalExposure * modelData.portfolioAllocationStage3;
                
                eclByStage.stage1 = stage1Exposure * adjustedPDStage1 * modelData.lgd;
                eclByStage.stage2 = stage2Exposure * adjustedPDStage2 * modelData.lgd;
                eclByStage.stage3 = stage3Exposure * modelData.pdStage3 * modelData.lgd;
                totalECLForYear = eclByStage.stage1 + eclByStage.stage2 + eclByStage.stage3;
                
                log(`        📊         NIIF 9 PORTFOLIO ALLOCATIONS - Año ${currentYear}:`);
                log(`   Total exposure: ${formatCurrency(totalExposure)}`);
                log(`   Stage 1 (${(modelData.portfolioAllocationStage1*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage1)}`);
                log(`   Stage 2 (${(modelData.portfolioAllocationStage2*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage2)}`);
                log(`   Stage 3 (${(modelData.portfolioAllocationStage3*100).toFixed(0)}%): ${formatCurrency(eclByStage.stage3)}`);
            }
            
            totalECLForYear *= modelData.economicAdjustmentFactor;
            eclByStage.stage1 *= modelData.economicAdjustmentFactor;
            eclByStage.stage2 *= modelData.economicAdjustmentFactor;
            eclByStage.stage3 *= modelData.economicAdjustmentFactor;
            
            const annualProvisionExpense = totalECLForYear * (modelData.proteccionRodando ? 0.5 : 1.0);
            
            let newProvisionsBalance = currentProvisionsBalance + annualProvisionExpense;
            
            const provisionesEsperadas = currentYearEndReceivables * (adjustedPDStage1 * modelData.portfolioAllocationStage1 +
                 adjustedPDStage2 * modelData.portfolioAllocationStage2 +
                 modelData.pdStage3 * modelData.portfolioAllocationStage3) * modelData.lgd * modelData.economicAdjustmentFactor;
            
            if (Math.abs(newProvisionsBalance - provisionesEsperadas) > 10000) {
                log("IFRS 9 provisions adjustment applied for consistency");
                newProvisionsBalance = provisionesEsperadas;
            }
            
            return {
                annualProvisionExpense: annualProvisionExpense,
                newProvisionsBalance: newProvisionsBalance,
                totalECLBeforeAdjustment: totalECLForYear,
                eclByStage: eclByStage
            };
        }
        /**
         * Conceptually validates if a performance obligation is met to recognize revenue under IFRS 15.
         * @param {Object} cohort - The loan cohort to validate.
         * @returns {boolean} True if revenue can be recognized.
         */
        function validatePerformanceObligation(cohort) {
            // A simple but effective check: revenue is earned as the service (loan) is provided.
            // This is true if payments have started and the principal has been reduced.
            const isServiceBeingProvided = cohort.paymentsMadeMonths > 0 && cohort.remainingPrincipal < cohort.originalPrincipal;
            if (!isServiceBeingProvided) {
                 log(`NIIF 15 - Obligación de desempeño para la cohorte del año ${cohort.yearOriginated} aún no satisfecha. No se reconocen ingresos.`);
            }
            return isServiceBeingProvided;
        }
        /**
         * Calculates contract revenue and liabilities according to IFRS 15.
         * @param {Array<Object>} loanCohorts - Array of active loan cohorts.
         * @param {Array<Object>} fixedAssetsCohorts - Array of active fixed asset (van) cohorts.
         * @param {number} addedUnitsThisYear - New units added in the current year.
         * @param {number} currentYear - The current projection year (1-5).
         * @returns {Object} Contains recognized revenue and contract liability balance.
         */
        function calculateNIIF15Revenue(loanCohorts, fixedAssetsCohorts, addedUnitsThisYear, currentYear) {
            let annualOriginationCommissionRecognized = 0;
            let totalContractLiabilitiesBalance = 0;
            loanCohorts.forEach(cohort => {
                //     ✅     CORREGIDO: Added IFRS 15 validation for performance obligation.
                if (validatePerformanceObligation(cohort)) {
                    let monthlyInterestRateClient = cohort.monthlyInterestRate;
                    const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
                    log(`     📋      NIIF 15 - Amortización comisiones en ${totalPaymentsMonthsClient} meses (${modelData.clientLoanTermYears} años)`);
                    let currentRemainingPrincipal = cohort.startOfYearPrincipal;
                    let initialPrincipal = cohort.originalPrincipal;
                    let recognizedOriginationFromPrincipal = 0;
                    let recognizedUpfrontCommission = 0;
                    for (let m = 0; m < 12; m++) {
                        if (currentRemainingPrincipal <= 0 || cohort.paymentsMadeMonths + m >= totalPaymentsMonthsClient) {
                            break;
                        }
                        const interestThisMonth = currentRemainingPrincipal * monthlyInterestRateClient;
                        let principalThisMonth = cohort.monthlyPayment - interestThisMonth;
                        principalThisMonth = Math.min(principalThisMonth, currentRemainingPrincipal);
                        currentRemainingPrincipal -= principalThisMonth;
                        
                        if (initialPrincipal > 0) {
                            const recognitionRatioThisMonth = principalThisMonth / initialPrincipal;
                            const recognizedByPrincipal = cohort.originationCommissionInitial * recognitionRatioThisMonth;
                            recognizedOriginationFromPrincipal += Math.min(recognizedByPrincipal, cohort.remainingOriginationCommission);
                        }
                        
                        if (cohort.originalUpfrontLiability > 0) {
                            const monthlyUpfrontAmortization = cohort.originalUpfrontLiability / totalPaymentsMonthsClient;
                            recognizedUpfrontCommission += Math.min(monthlyUpfrontAmortization, cohort.remainingUpfrontLiability);
                        }
                    }
                    
                    const actualRecognizedOrigination = Math.min(recognizedOriginationFromPrincipal, cohort.remainingOriginationCommission);
                    const actualRecognizedUpfront = Math.min(recognizedUpfrontCommission, cohort.remainingUpfrontLiability);
                    annualOriginationCommissionRecognized += (actualRecognizedOrigination + actualRecognizedUpfront);
                    cohort.remainingOriginationCommission = Math.max(0, cohort.remainingOriginationCommission - actualRecognizedOrigination);
                    cohort.remainingUpfrontLiability = Math.max(0, cohort.remainingUpfrontLiability - actualRecognizedUpfront);
                }
                
                totalContractLiabilitiesBalance += cohort.remainingOriginationCommission || 0;
                totalContractLiabilitiesBalance += cohort.remainingUpfrontLiability || 0;
            });
            
            const totalActiveUnits = fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0);
            const gnvCommissions = totalActiveUnits * modelData.litrosPromedioMensualPorUnidad * 12 * modelData.precioLitroGNV * (modelData.comisionGNVPorcentaje / 100);
            
            const sparePartsCost = addedUnitsThisYear * modelData.refaccionesCostPerUnit;
            const sparePartsRevenue = sparePartsCost * (1 + modelData.margenRefacciones / 100);
            
            const marketplaceRevenue = totalActiveUnits * modelData.gmvPromedioMensualPorUnidad * 12 * (modelData.takeRateMarketplace / 100);
            
            return {
                recognizedOriginationRevenue: annualOriginationCommissionRecognized,
                gnvCommissions: gnvCommissions,
                sparePartsRevenue: sparePartsRevenue,
                sparePartsCOGS: sparePartsCost,
                marketplaceRevenue: marketplaceRevenue,
                contractLiabilitiesBalance: totalContractLiabilitiesBalance,
                // Pass these through for niifDetails
                originationContractValueInitial: loanCohorts.filter(c => c.yearOriginated === currentYear).reduce((sum, c) => sum + (c.originationCommissionInitial || 0), 0),
                upfrontCommissionInitial: loanCohorts.filter(c => c.yearOriginated === currentYear).reduce((sum, c) => sum + (c.originalUpfrontLiability || 0), 0),
            };
        }
        /**
         * Conceptually validates if an asset qualifies to be classified as Held for Sale under IFRS 5.
         * @param {Object} asset - The asset cohort to validate.
         * @returns {boolean} True if the asset qualifies.
         */
        function qualifiesForHeldForSale(asset) {
            // In a real-world scenario, these would be properties of the asset.
            // For this model, we assume all repossessed assets meet the criteria.
            const managementCommittedToSell = true;
            const availableForImmediateSale = true;
            const saleHighlyProbableWithin12Months = true;
            const qualifies = managementCommittedToSell && availableForImmediateSale && saleHighlyProbableWithin12Months;
            if (!qualifies) {
                log(`NIIF 5 - Activo de la cohorte ${asset.yearAcquired} no califica para ser Mantenido para la Venta.`);
            }
            return qualifies;
        }
        /**
         * Manages assets held for sale (IFRS 5).
         * @param {Array<Object>} fixedAssetsCohorts - Array of fixed asset cohorts (will be modified).
         * @param {Array<Object>} heldForSaleAssets - Global array of IFRS 5 assets (will be modified).
         * @param {number} currentYear - The current projection year (1-5).
         * @returns {Object} Contains this year's impairment loss and reclassification details.
         */
        function manageNIIF5Assets(fixedAssetsCohorts, heldForSaleAssets, currentYear) {
            let totalImpairmentThisYear = 0;
            const totalOperationalUnits = fixedAssetsCohorts.reduce((sum, c) => sum + c.units, 0);
            let unitsToRepossess = Math.round(totalOperationalUnits * (modelData.tasaReposicion / 100));
            let remainingUnitsToRepossess = unitsToRepossess;
            
            let valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount = 0;
            let valueOfAssetsReclassifiedToNIIF5ThisYearFairValue = 0;
            let valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell = 0;
            let valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue = 0;
            
            fixedAssetsCohorts.sort((a, b) => a.yearAcquired - b.yearAcquired);
            
            for (let i = 0; i < fixedAssetsCohorts.length && remainingUnitsToRepossess > 0; i++) {
                let cohort = fixedAssetsCohorts[i];
                //     ✅     CORREGIDO: Added IFRS 5 validation.
                if (cohort.units > 0 && qualifiesForHeldForSale(cohort)) {
                    const actualUnitsToRepossessFromThisCohort = Math.min(remainingUnitsToRepossess, cohort.units);
                    if (actualUnitsToRepossessFromThisCohort > 0) {
                        const proportionToRepossess = actualUnitsToRepossessFromThisCohort / cohort.units;
                        const repossessedOriginalCost = cohort.totalOriginalCost * proportionToRepossess;
                        const repossessedAccumulatedDepreciation = cohort.accumulatedDepreciation * proportionToRepossess;
                        const repossessedCarryingAmount = repossessedOriginalCost - repossessedAccumulatedDepreciation;
                        
                        const repossessedFairValue = repossessedOriginalCost * (modelData.fairValueVenta / 100);
                        const repossessedCostsToSell = repossessedFairValue * (modelData.costosVenta / 100);
                        const repossessedFairValueLessCosts = repossessedFairValue - repossessedCostsToSell;
                        
                        const impairmentForRepossessed = Math.max(0, repossessedCarryingAmount - repossessedFairValueLessCosts);
                        totalImpairmentThisYear += impairmentForRepossessed;
                        
                        cohort.units -= actualUnitsToRepossessFromThisCohort;
                        cohort.totalOriginalCost -= repossessedOriginalCost;
                        cohort.accumulatedDepreciation -= repossessedAccumulatedDepreciation;
                        
                        heldForSaleAssets.push({
                            units: actualUnitsToRepossessFromThisCohort,
                            originalCost: repossessedOriginalCost,
                            accumulatedDepreciation: repossessedAccumulatedDepreciation,
                            carryingAmountAtHFS: repossessedCarryingAmount,
                            currentFairValueLessCosts: repossessedFairValueLessCosts,
                            heldForSaleYear: currentYear,
                            impairmentRecorded: impairmentForRepossessed
                        });
                        remainingUnitsToRepossess -= actualUnitsToRepossessFromThisCohort;
                        
                        valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount += repossessedCarryingAmount;
                        valueOfAssetsReclassifiedToNIIF5ThisYearFairValue += repossessedFairValue;
                        valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell += repossessedCostsToSell;
                        valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue += repossessedFairValueLessCosts;
                    }
                }
            }
            
            fixedAssetsCohorts = fixedAssetsCohorts.filter(c => c.units > 0);
            
            const totalUnitsAccumulatedHeldForSale = heldForSaleAssets.reduce((sum, asset) => sum + asset.units, 0);
            const assetsHeldForSaleNet = heldForSaleAssets.reduce((sum, asset) => sum + asset.currentFairValueLessCosts, 0);
            return {
                impairmentExpense: totalImpairmentThisYear,
                niif5Details: {
                    unidadesClasificadasAnuales: unitsToRepossess - remainingUnitsToRepossess,
                    valorEnLibrosClasificado: valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount, 
                    valorRazonable: valueOfAssetsReclassifiedToNIIF5ThisYearFairValue,
                    costosDeVenta: valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell,
                    valorRazonableMenosCostos: valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue,
                    perdidaPorDeterioro: totalImpairmentThisYear,
                    saldoActivosParaVentaAcumulado: assetsHeldForSaleNet,
                    totalUnitsAccumulatedHeldForSale: totalUnitsAccumulatedHeldForSale
                },
                updatedFixedAssetsCohorts: fixedAssetsCohorts,
                updatedHeldForSaleAssets: heldForSaleAssets
            };
        }
        /**
         * Calculates a time-weighted average for balances,
         * considering capital events that occur during the year.
         * @param {number} startBalance - Balance at the beginning of the year.
         * @param {number} endBalance - Balance at the end of the year.
         * @param {Array<Object>} capitalEvents - Array of objects { month: number, amount: number }.
         * @returns {number} The time-weighted average.
         */
        function calculateTimeWeightedAverage(startBalance, endBalance, capitalEvents = []) {
            if (!capitalEvents.length || capitalEvents.length === 0) {
                // If no events, fall back to simple average for consistency
                return (startBalance + endBalance) / 2;
            }
                
            let weightedSum = 0; 
            let totalMonths = 12;
            capitalEvents.sort((a, b) => a.month - b.month);
            let currentBalance = startBalance;
            let lastMonth = 0;
            
            capitalEvents.forEach(event => {
                const monthsInPeriod = event.month - lastMonth;
                if (monthsInPeriod > 0) {
                    weightedSum += currentBalance * monthsInPeriod;
                }
                currentBalance += event.amount;
                lastMonth = event.month;
            });
            
            if (lastMonth < 12) {
                weightedSum += currentBalance * (12 - lastMonth);
            }
            
            return weightedSum / totalMonths;
        }
        /**
         * Performs the annual calculation of fixed asset depreciation.
         * IFRS 6: Do not depreciate in the year of acquisition. Adjust depreciable base for impairment.
         * @param {Array<Object>} fixedAssetsCohorts - Fixed asset cohorts.
         * @param {number} currentYear - Current projection year.
         * @returns {number} Total annual depreciation amount.
         */
        function calculateAnnualDepreciation(fixedAssetsCohorts, currentYear) {
            let annualDepreciation = 0;
            fixedAssetsCohorts.forEach(cohort => {
                const yearsHeld = currentYear - cohort.yearAcquired;
                
                if (yearsHeld > 0 && modelData.depreciationYears > 0) {
                    const depreciationRate = 1 / modelData.depreciationYears;
                    const maxDepreciationPossible = cohort.totalOriginalCost - cohort.accumulatedDepreciation;
                    const depreciationThisYear = Math.min(cohort.totalOriginalCost * depreciationRate, maxDepreciationPossible);
                    
                    cohort.accumulatedDepreciation += depreciationThisYear;
                    annualDepreciation += depreciationThisYear;
                }
            });
            return annualDepreciation;
        }
        // ===== MAIN FINANCIAL CALCULATION =====
        /**
         * Central function to calculate all financial statements of the model.
         * Process: Iterates year by year, calculating revenues, expenses, flows, and balances,
         * integrating IFRS logic and validations.
         * @returns {boolean} True if the calculation was successful, false if there was a critical error (e.g., unbalanced balance sheet).
         */
        function calculateFinancials() {
            log('🚀 calculateFinancials INICIANDO');
            try {
                financialResults = { 
                    pl: [], cf: [], bs: [], niifDetails: [], 
                    tirProyecto: 0, tirCartera: 0, tirEquity: 0, 
                    roe: [], roic: [] 
                };
                heldForSaleAssets = [];
                
                let cash = modelData.seriesA;
                let totalDebt = 0;
                let currentProvisionsBalance = 0;
                
                let endOfYearEquity = modelData.seriesA;
                let loanCohorts = [];
                let fixedAssetsCohorts = [];
                
                let equityCashFlows = [-modelData.seriesA];
                let projectCashFlows = [-modelData.seriesA]; 
                let portfolioCashFlows = []; 
                log(`Initial Series A capital: ${formatCurrency(modelData.seriesA)}`);
                
                for (let year = 0; year < 5; year++) {
                    log(`\n--- Calculating Year ${year + 1} ---`);
                    const currentYear = year + 1;
                    const addedUnits = modelData.unitsPerYear[year];
                    const startOfYearEquity = endOfYearEquity;
                    const startOfYearTotalDebt = totalDebt;
                    
                    loanCohorts.forEach(cohort => {
                        cohort.startOfYearPrincipal = cohort.remainingPrincipal;
                    });
                    
                    const capexThisYear = addedUnits * getTotalPackageCost();
                    if (addedUnits > 0) {
                        fixedAssetsCohorts.push({
                            yearAcquired: currentYear,
                            units: addedUnits,
                            totalOriginalCost: capexThisYear,
                            accumulatedDepreciation: 0
                        });
                        log(`New fixed asset cohort Year ${currentYear}: ${formatCurrency(capexThisYear)}`);
                    }
                    
                    const niif5Results = manageNIIF5Assets(fixedAssetsCohorts, heldForSaleAssets, currentYear);
                    fixedAssetsCohorts = niif5Results.updatedFixedAssetsCohorts;
                    heldForSaleAssets = niif5Results.updatedHeldForSaleAssets;
                    const impairment = niif5Results.impairmentExpense;
                    
                    const annualDepreciation = calculateAnnualDepreciation(fixedAssetsCohorts, currentYear);
                    const fixedAssetsNet = fixedAssetsCohorts.reduce((sum, c) => sum + (c.totalOriginalCost - c.accumulatedDepreciation), 0);
                    const assetsHeldForSaleNet = heldForSaleAssets.reduce((sum, a) => sum + a.currentFairValueLessCosts, 0);
                    let netLoanPrincipal = 0;
                    let downPaymentReceived = 0;
                    let upfrontCommissionReceived = 0;
                    if (addedUnits > 0) {
                        const newCohortGrossPrincipal = addedUnits * getTotalPackagePrice();
                        downPaymentReceived = newCohortGrossPrincipal * (modelData.downPaymentPercentage / 100);
                        upfrontCommissionReceived = newCohortGrossPrincipal * (modelData.upfrontCommissionPercentage / 100);
                        netLoanPrincipal = newCohortGrossPrincipal - downPaymentReceived;
                        
                        const monthlyInterestRateClient = (modelData.tasaInteres / 100) / 12;
                        const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
                        const monthlyPaymentClient = netLoanPrincipal * (monthlyInterestRateClient / (1 - Math.pow(1 + monthlyInterestRateClient, -totalPaymentsMonthsClient)));
                        
                        const originationCommissionForThisCohort = netLoanPrincipal * (modelData.margenVagoneta / 100);
                        loanCohorts.push({
                            yearOriginated: currentYear,
                            originalPrincipal: netLoanPrincipal,
                            remainingPrincipal: netLoanPrincipal, 
                            startOfYearPrincipal: netLoanPrincipal,
                            paymentsMadeMonths: 0,
                            monthlyPayment: monthlyPaymentClient,
                            monthlyInterestRate: monthlyInterestRateClient,
                            totalLoanTermMonths: totalPaymentsMonthsClient,
                            originationCommissionInitial: originationCommissionForThisCohort,
                            remainingOriginationCommission: originationCommissionForThisCohort,
                            originalUpfrontLiability: upfrontCommissionReceived,
                            remainingUpfrontLiability: upfrontCommissionReceived,
                            avgExposureDuringYear: 0,
                        });
                        log(`New loan cohort Year ${currentYear}: ${addedUnits} units, Net Principal: ${formatCurrency(netLoanPrincipal)}`);
                    }
                    
                    let annualInterestReceived = 0;
                    let annualPrincipalReceived = 0;
                    let currentYearEndReceivables = 0;
                    
                    loanCohorts.forEach(cohort => {
                        let principal = cohort.startOfYearPrincipal;
                        cohort.avgExposureDuringYear = principal; 
                        for (let m=0; m < 12; m++) {
                             if (cohort.paymentsMadeMonths >= cohort.totalLoanTermMonths) break;
                            const interest = principal * cohort.monthlyInterestRate;
                            const principalPayment = cohort.monthlyPayment - interest;
                            annualInterestReceived += interest;
                            annualPrincipalReceived += principalPayment;
                            principal -= principalPayment;
                            cohort.paymentsMadeMonths++;
                        }
                        cohort.remainingPrincipal = Math.max(0, principal);
                        currentYearEndReceivables += cohort.remainingPrincipal;
                    });
                    
                    const niif9Results = calculateNIIF9ECL(loanCohorts, currentYear, currentProvisionsBalance, currentYearEndReceivables);
                    const provisions = niif9Results.annualProvisionExpense;
                    currentProvisionsBalance = niif9Results.newProvisionsBalance;
                    
                    const niif15Results = calculateNIIF15Revenue(loanCohorts, fixedAssetsCohorts, addedUnits, currentYear);
                    
                    const totalActiveUnits = fixedAssetsCohorts.reduce((sum, c) => sum + c.units, 0);
                    const gnvCommissions = totalActiveUnits * modelData.litrosPromedioMensualPorUnidad * 12 * modelData.precioLitroGNV * (modelData.comisionGNVPorcentaje / 100);
                    const sparePartsRevenue = addedUnits * modelData.refaccionesCostPerUnit * (1 + modelData.margenRefacciones / 100);
                    const sparePartsCOGS = addedUnits * modelData.refaccionesCostPerUnit;
                    const marketplaceRevenue = totalActiveUnits * modelData.gmvPromedioMensualPorUnidad * 12 * (modelData.takeRateMarketplace / 100);
                    const totalRevenue = annualInterestReceived + niif15Results.recognizedOriginationRevenue + gnvCommissions + sparePartsRevenue + marketplaceRevenue;
                    
                    const opex = totalRevenue * (modelData.opexRates[year] / 100);
                    
                    const ebitda = totalRevenue - sparePartsCOGS - opex - provisions - impairment;
                    const ebit = ebitda - annualDepreciation;
                    // Debt calculations
                    const ventureDebtInterest = (totalDebt > 0 ? totalDebt * (modelData.ventureDebtRate / 100) : 0); 
                    const commercialDebtInterest = 0; 
                    const interestExpense = ventureDebtInterest + commercialDebtInterest;
                    const earningsBeforeTax = ebit - interestExpense;
                    const incomeTaxExpense = Math.max(0, earningsBeforeTax) * (modelData.corporateTaxRate / 100);
                    const netIncome = earningsBeforeTax - incomeTaxExpense;
                    // --- Cash Flow Calculations ---
                    const newVentureDebt = modelData[`ventureDebtYear${currentYear}`] || 0;
                    const newCommercialDebt = modelData[`commercialDebtYear${currentYear}`] || 0;
                    const newSeriesB = modelData[`seriesB_newInvestors_year${currentYear}`] || 0;
                    const newPartnerCapitalization = modelData[`partnerCapitalizationYear${currentYear}`] || 0;
                    const newEquityInjections = newSeriesB + newPartnerCapitalization;
                    
                    const deltaReceivables = currentYearEndReceivables - ((financialResults.bs[year-1]?.receivables) || 0)
                    const deltaProvisions = currentProvisionsBalance - ((financialResults.bs[year-1]?.provisions) || 0)
                    const deltaContractLiabilities = niif15Results.contractLiabilitiesBalance - ((financialResults.bs[year-1]?.contractLiabilities) || 0)
                    
                    const operatingCash = netIncome + annualDepreciation + impairment + deltaProvisions + deltaContractLiabilities;
                    const investingCash = -capexThisYear - deltaReceivables;
                    const financingCash = newEquityInjections + newVentureDebt + newCommercialDebt; 
                    const netCash = operatingCash + investingCash + financingCash;
                    cash += netCash;
                    
                    // Update Balances
                    endOfYearEquity = startOfYearEquity + netIncome + newEquityInjections;
                    totalDebt += newVentureDebt + newCommercialDebt;
                    
                    // --- Balance Sheet Sanity Check ---
                    const totalAssets = cash + currentYearEndReceivables + fixedAssetsNet + assetsHeldForSaleNet;
                    const totalLiabilities = totalDebt + currentProvisionsBalance + niif15Results.contractLiabilitiesBalance;
                    let totalLiabilitiesEquity = totalLiabilities + endOfYearEquity;
                    const balanceDiff = totalAssets - totalLiabilitiesEquity;
                    if (Math.abs(balanceDiff) > BALANCE_TOLERANCE) {
                         log(`    ⚠️     Balance adjustment in Year ${currentYear}: ${formatCurrency(balanceDiff)}`);
                         endOfYearEquity += balanceDiff; 
                         totalLiabilitiesEquity = totalLiabilities + endOfYearEquity;
                    }
                    // Store results
                    financialResults.pl.push({
                        ...niif15Results,
                        interestRevenue: annualInterestReceived,
                        totalRevenue,
                        ebitda,
                        ebit,
                        netIncome,
                        interestExpense,
                        depreciation: annualDepreciation,
                        provisions,
                        impairment,
                        totalCOGS: sparePartsCOGS,
                        grossProfit: totalRevenue - sparePartsCOGS,
                        opex,
                        earningsBeforeTax,
                        incomeTaxExpense
                    });
                    financialResults.cf.push({ operatingCash, investingCash, financingCash, netCash, deltaProvisions, deltaContractLiabilities, incomeTaxPaid: incomeTaxExpense, clientPrincipalPaymentsReceived: annualPrincipalReceived, clientInterestPaymentsReceived: annualInterestReceived, currentYearVentureDebtDraw: newVentureDebt, additionalFundingRaised: newCommercialDebt });
                    financialResults.bs.push({ cash, receivables: currentYearEndReceivables, receivablesNet: currentYearEndReceivables - currentProvisionsBalance, fixedAssets: fixedAssetsNet, assetsHeldForSale: assetsHeldForSaleNet, totalAssets: totalAssets, debt: totalDebt, equity: endOfYearEquity, totalLiabilitiesEquity: totalLiabilitiesEquity, provisions: currentProvisionsBalance, contractLiabilities: niif15Results.contractLiabilitiesBalance });
                    financialResults.niifDetails.push({ niif15: niif15Results, niif5: niif5Results.niif5Details, niif9: {...niif9Results, pdStage1: modelData.pdStage1, pdStage2: modelData.pdStage2, pdStage3: modelData.pdStage3, lgd: modelData.lgd, economicAdjustmentFactor: modelData.economicAdjustmentFactor, proteccionRodandoActiva: modelData.proteccionRodando, provisionesConProteccion: provisions, reduccionPorProteccion: niif9Results.totalECLBeforeAdjustment - provisions, saldoProvisionesAcumulado: currentProvisionsBalance } });
                    
                    // --- AJUSTE ROE y ROIC (Time-Weighted) ---
                    const equityEvents = [];
                    if (newEquityInjections > 0) equityEvents.push({ month: 6, amount: newEquityInjections }); // Asumimos inyección a mitad de año
                    const debtEvents = [];
                    if (newVentureDebt > 0) debtEvents.push({ month: 3, amount: newVentureDebt }); // Asumimos Q1 para Venture Debt
                    if (newCommercialDebt > 0) debtEvents.push({ month: 9, amount: newCommercialDebt }); // Asumimos Q3 para Deuda Comercial
                    // Cálculo del ROE Ponderado
                    const avgEquity = calculateTimeWeightedAverage(startOfYearEquity, endOfYearEquity, equityEvents);
                    financialResults.roe.push(avgEquity > 0 ? (netIncome / avgEquity) * 100 : 0);
                    // Cálculo del ROIC Ponderado
                    const nopat = ebit * (1 - modelData.corporateTaxRate / 100);
                    const avgDebt = calculateTimeWeightedAverage(startOfYearTotalDebt, totalDebt, debtEvents);
                    const avgInvestedCapital = avgEquity + avgDebt;
                    financialResults.roic.push(avgInvestedCapital > 0 ? (nopat / avgInvestedCapital) * 100 : 0);
                    // --- IRR Cash Flow Aggregation ---
                    projectCashFlows.push(ebit * (1 - modelData.corporateTaxRate/100) + annualDepreciation - capexThisYear); // FCFF
                    equityCashFlows.push(netIncome + annualDepreciation - capexThisYear + newVentureDebt + newCommercialDebt); 
                    
                    let portfolioCashFlowThisYear = -netLoanPrincipal + annualPrincipalReceived + annualInterestReceived;
                    if (year === 4) { // Add terminal value for portfolio
                        portfolioCashFlowThisYear += currentYearEndReceivables / Math.pow(1 + modelData.tasaInteres / 100, modelData.avgRemainingTermCartera);
                    }
                    portfolioCashFlows.push(portfolioCashFlowThisYear);
                }
                
                // --- FINAL IRR CALCULATIONS ---
                const year5EBITDA_final = financialResults.pl[4].ebitda;
                const terminalValueProject_final = year5EBITDA_final * modelData.ebitdaMultipleProject;
                const terminalValueEquity_final = (year5EBITDA_final * modelData.ebitdaMultipleEquity) - financialResults.bs[4].debt;
                
                projectCashFlows[projectCashFlows.length - 1] += terminalValueProject_final;
                equityCashFlows[equityCashFlows.length - 1] += terminalValueEquity_final;
                financialResults.tirProyecto = calculateIRR(projectCashFlows) || 0;
                financialResults.tirEquity = calculateIRR(equityCashFlows) || 0;
                financialResults.tirCartera = calculateIRR(portfolioCashFlows) || 0;
                
                log('✅ FINANCIAL CALCULATIONS COMPLETED CORRECTLY');
                console.log('📊 DATOS FINALES:', {
                    plLength: financialResults.pl.length,
                    cfLength: financialResults.cf.length,
                    bsLength: financialResults.bs.length,
                    seriesA: modelData.seriesA,
                    year1CF: financialResults.cf[0]
                });
                return true; 
            } catch (error) {
                log(`❌ ERROR in calculateFinancials: ${error.message}`);
                console.error('Critical error in financial calculations:', error);
                document.getElementById('balance-validation').innerHTML = `<span class="text-red-600">❌ ${error.message}</span>`;
                return false; 
            }
        }
        // ===== IRR CALCULATION FUNCTION (Internal Rate of Return) =====
        /**
         * Calculates the Internal Rate of Return (IRR) using the Newton-Raphson method.
         * Incorporates a robust method with error handling and a search range for convergence.
         * @param {number[]} cashFlows - Array of cash flows. The first element is the initial investment (negative).
         * @param {number} [maxIterations=500] - Maximum number of iterations.
         * @param {number} [tolerance=1e-7] - Tolerance for convergence.
         * @returns {number} The IRR in percentage, or 0 if it does not converge or is undefined.
         */
        function calculateIRR(cashFlows, maxIterations = 500, tolerance = 1e-7) {
            if (!cashFlows || cashFlows.length < 2) {
                log('IRR: Insufficient flows. Returning 0%.');
                return 0;
            }
            const hasPositive = cashFlows.some(cf => cf > 0);
            const hasNegative = cashFlows.some(cf => cf < 0);
            if (!hasPositive || !hasNegative) {
                log('IRR: No positive and negative flows, IRR undefined. Returning 0%.');
                return 0;
            }
            
            let guess = 0.10;
            let low = -0.99;
            let high = 5.0;
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let dNpv = 0;
                for (let t = 0; t < cashFlows.length; t++) {
                    const discountFactor = Math.pow(1 + guess, t);
                    if (discountFactor === 0) {
                        guess += 0.01;
                        npv = 1;
                        break;
                    }
                    npv += cashFlows[t] / discountFactor;
                    if (t > 0) {
                        dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                    }
                }
                if (Math.abs(npv) < tolerance) {
                    return Math.max(-99, Math.min(500, guess * 100));
                }
                if (dNpv === 0) {
                    break; 
                }
                const newGuess = guess - npv / dNpv;
                
                if (newGuess < low) {
                    guess = (guess + low) / 2;
                } else if (newGuess > high) {
                    guess = (guess + high) / 2;
                } else {
                    guess = newGuess;
                }
                
                if (npv > 0) low = guess; else high = guess;
                
                if (high - low < tolerance) {
                    guess = (low + high) / 2;
                    return Math.max(-99, Math.min(500, guess * 100));
                }
            }
            log(`IRR did not converge completely after ${maxIterations} iterations. Returning ${Math.max(-99, Math.min(500, guess * 100)).toFixed(2)}%.`);
            return Math.max(-99, Math.min(500, guess * 100));
        }
        // ===== USER INTERFACE (UI) UPDATE =====
        /**
         * Updates the key metrics in the summary cards and then the tables and charts.
         * Process: Collects data from `financialResults` and injects it into the DOM.
         */
        function updateUI() {
            log('🔄 Updating User Interface...');
            try {
                if (!financialResults.pl || financialResults.pl.length === 0) {
                    log('❌ No financial data to update UI.');
                    return;
                }
                
                const year5PL = financialResults.pl[4];
                const year5BS = financialResults.bs[4];
                const totalUnitsAcquired = modelData.unitsPerYear.reduce((acc, curr) => acc + curr, 0);
                const vagonetasOperativas = totalUnitsAcquired - (financialResults.niifDetails && financialResults.niifDetails[4]?.niif5?.totalUnitsAccumulatedHeldForSale || 0);
                
                // DYNAMIC CALCULATION: Update key metrics with actual calculated values
                if (year5PL && year5BS) {
                    document.getElementById('ebitda-year5').textContent = formatCurrency(year5PL.ebitda);
                    document.getElementById('vagonetas-operativas').textContent = Math.round(vagonetasOperativas);
                    
                    const seriesAMetrics = calculateSeriesAMetrics();
                    
                    document.getElementById('capital-per-unit').textContent = 
                        seriesAMetrics.capitalPerUnit ? '$' + seriesAMetrics.capitalPerUnit.toFixed(0) + 'K' : '$0K';
                    document.getElementById('portfolio-yield').textContent = 
                        seriesAMetrics.portfolioYield ? seriesAMetrics.portfolioYield.toFixed(1) + '%' : '0.0%';
                    document.getElementById('active-portfolio-value').textContent = 
                        formatCurrency(seriesAMetrics.activePortfolioValue || 0);
                    document.getElementById('funding-efficiency').textContent = 
                        seriesAMetrics.fundingEfficiency ? seriesAMetrics.fundingEfficiency.toFixed(1) + 'x' : '0.0x';
                    document.getElementById('cash-runway-months').textContent = 
                        seriesAMetrics.cashRunwayMonths === 999 ? '∞' : Math.round(seriesAMetrics.cashRunwayMonths);
                    document.getElementById('unit-growth-cagr').textContent = 
                        seriesAMetrics.unitCAGR ? seriesAMetrics.unitCAGR.toFixed(1) + '%' : '0%';
                    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                    document.getElementById('tir-equity').textContent = financialResults.tirEquity.toFixed(1) + '%';
                    document.getElementById('tir-cartera').textContent = (financialResults.tirCartera || 0).toFixed(1) + '%';
                    
                    const debtMetrics = calculateDebtMetricsBreakdown();
                    document.getElementById('venture-debt-residual').textContent = 
                        formatCurrency(debtMetrics.ventureDebtResidual);
                    document.getElementById('commercial-debt-residual').textContent = 
                        formatCurrency(debtMetrics.commercialDebtResidual);
                    document.getElementById('dscr-final').textContent = 
                        debtMetrics.finalDSCR === 999 ? '∞' : debtMetrics.finalDSCR.toFixed(1) + 'x';
                    // Agregar validación visual para DSCR
                    const dscrElement = document.getElementById('dscr-final');
                    dscrElement.className = 'text-2xl font-bold ' + 
                        (debtMetrics.isHealthyDSCR ? 'text-emerald-400' : 'text-amber-400');
                    let actualTotalEquity = modelData.seriesA;
                    for (let i = 1; i <= 5; i++) {
                        actualTotalEquity += (modelData[`seriesB_newInvestors_year${i}`] || 0) + (modelData[`partnerCapitalizationYear${i}`] || 0);
                    }
                    document.getElementById('total-equity-required').textContent = formatCurrency(actualTotalEquity);
                    
                    let actualFCFBreakevenYear = 0;
                    if(financialResults.cf){
                        for (let i = 0; i < financialResults.cf.length; i++) {
                            if (financialResults.cf[i].operatingCash > 0) {
                                actualFCFBreakevenYear = i + 1;
                                break;
                            }
                        }
                    }
                    document.getElementById('fcf-breakeven-year').textContent = actualFCFBreakevenYear > 0 ? `Año ${actualFCFBreakevenYear}` : 'No alcanzado';
                    
                    let actualAutosufficiencyYear = 0;
                    if(financialResults.pl){
                        for(let i = 0; i < financialResults.pl.length; i++) {
                            const plYear = financialResults.pl[i];
                            if (plYear.totalRevenue > (plYear.opex + plYear.provisions + plYear.impairment)) {
                                actualAutosufficiencyYear = i + 1;
                                break;
                            }
                        }
                    }
                    document.getElementById('autosuficiency-year').textContent = actualAutosufficiencyYear > 0 ? `Año ${actualAutosufficiencyYear}` : 'No alcanzado';
                    
                    log(`✅ Main and profitability metrics updated with DYNAMIC calculations.`);
                    
                } else {
                    log('⚠️ Year 5 data incomplete to update main metrics.');
                }
                updateTables(); 
                updateNIIFTables(); 
                updateCharts(); 
                
                const validations = validateModelComprehensively(modelData, financialResults);
                updateValidationPanel(validations);
                updateOptimizationStatus();
                updateInvestorScore(); //   ✅   NUEVO: Update investor dashboard
                
                // Debug debt metrics for validation
                const debtMetrics = calculateDebtMetricsBreakdown();
                log(`🏦 Debt Metrics Updated: VD=${formatCurrency(debtMetrics.ventureDebtResidual)}, CD=${formatCurrency(debtMetrics.commercialDebtResidual)}, DSCR=${debtMetrics.finalDSCR.toFixed(1)}x`);
            } catch (error) {
                log(`❌ Error in updateUI: ${error.message}`);
                console.error('Error updating UI:', error);
            }
        }
        /**
         * Coordinates the update of all financial tables (P&L, CF, BS).
         */
        function updateTables() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
        }
        /**
         * Updates the Profit & Loss (P&L) table.
         * Process: Iterates over predefined rows and annual data to populate the table.
         */
        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody || !financialResults.pl.length) return;
            
            tbody.innerHTML = ''; 
            
            const rows = [
                { label: 'Ingresos por Intereses', key: 'interestRevenue' },
                { label: 'Margen por Originación (NIIF 15)', key: 'recognizedOriginationRevenue' },
                { label: 'Comisiones GNV (NIIF 15)', key: 'gnvCommissions' },
                { label: 'Ingresos Refacciones (NIIF 15)', key: 'sparePartsRevenue' },
                { label: 'Ingresos Marketplace (NIIF 15)', key: 'marketplaceRevenue' },
                { label: 'Total Ingresos Operativos', key: 'totalRevenue', total: true },
                
                { label: 'COGS Refacciones', key: 'totalCOGS', negative: true, fromPL: true },
                { label: 'Utilidad Bruta', key: 'grossProfit', total: true },
                
                { label: 'Gastos Operativos (OPEX)', key: 'opex', negative: true },
                { label: 'Provisiones NIIF 9', key: 'provisions', negative: true },
                { label: 'Pérdida por Deterioro NIIF 5', key: 'impairment', negative: true },
                { label: 'EBITDA', key: 'ebitda', total: true, emphasize: true },
                { label: 'Depreciación', key: 'depreciation', negative: true },
                { label: 'EBIT', key: 'ebit', total: true },
                { label: 'Gastos por Intereses (Deuda)', key: 'interestExpense', negative: true },
                { label: 'Ganancia Antes de Impuestos (EBT)', key: 'earningsBeforeTax', total: true },
                { label: 'Impuesto sobre la Renta', key: 'incomeTaxExpense', negative: true },
                { label: 'Utilidad Neta', key: 'netIncome', total: true, emphasize: true }
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.pl.forEach(yearData => {
                    const cell = document.createElement('td');
                    let value = yearData[row.key] || 0;
                    
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (value === 0) {
                        cell.style.color = '#94a3b8';
                    }
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
            log('✅ Profit & Loss Table updated.');
        }
        /**
         * Updates the Cash Flow (CF) table.
         * Process: Iterates over predefined rows and annual data to populate the table.
         */
        function updateCashFlowTable() {
            console.log('💸 ACTUALIZANDO CASH FLOW:', {
                cfExists: !!financialResults.cf,
                cfLength: financialResults.cf?.length,
                year1Data: financialResults.cf?.[0],
                tbodyExists: !!document.getElementById('cf-table-body')
            });
            const tbody = document.getElementById('cf-table-body');
            if (!tbody || !financialResults.cf.length) return;
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'FLUJO DE EFECTIVO OPERATIVO', total: true, emphasize: true },
                { label: '  Utilidad Neta', key: 'netIncome', fromPL: true },
                { label: '  + Depreciación', key: 'depreciation', fromPL: true },
                { label: '  + Pérdida por Deterioro NIIF 5', key: 'impairment', fromPL: true },
                { label: '  + Δ Provisiones (NIIF 9)', key: 'deltaProvisions', fromCF: true, positive: true }, 
                { label: '  - Δ Cuentas por Cobrar', key: 'receivables', deltaFromBS: true, negative: true }, 
                { label: '  + Δ Pasivos Contractuales (NIIF 15)', key: 'deltaContractLiabilities', fromCF: true, positive: true }, 
                { label: '  - Impuestos Pagados', key: 'incomeTaxPaid', fromCF: true, negative: true },
                { label: 'TOTAL FLUJO DE EFECTIVO OPERATIVO', key: 'operatingCash', total: true, emphasize: true },
                { label: '  + Pagos Principal Clientes', key: 'clientPrincipalPaymentsReceived', fromCF: true, isInfo: true },
                { label: '  + Pagos Interés Clientes', key: 'clientInterestPaymentsReceived', fromCF: true, isInfo: true },
                
                { label: 'FLUJO DE EFECTIVO DE INVERSIÓN', total: true, separator: true, emphasize: true },
                { label: '  - CAPEX Vagonetas (Activos Fijos)', key: 'investingCash', negative: true, fromCF: true}, 
                { label: 'TOTAL FLUJO DE EFECTIVO DE INVERSIÓN', key: 'investingCash', total: true, emphasize: true, duplicate: true },
                
                { label: 'FLUJO DE EFECTIVO DE FINANCIACIÓN', total: true, separator: true, emphasize: true },
                { label: '  Capital Recibido', fromModelData: true, yearSpecific: true, key: 'partnerCapitalization' },
                { label: '  Venture Debt Recibido', key: 'currentYearVentureDebtDraw', fromCF: true, positive: true },
                { label: '  Deuda Comercial Recibida', key: 'additionalFundingRaised', fromCF: true, positive: true },
                { label: 'TOTAL FLUJO DE EFECTIVO DE FINANCIACIÓN', key: 'financingCash', total: true, emphasize: true, duplicate: true },
                
                { label: 'INCREMENTO NETO DE EFECTIVO', key: 'netCash', total: true, separator: true, emphasize: true },
                { label: 'SALDO DE EFECTIVO AL FINAL DEL PERIODO', key: 'cash', fromBS: true, total: true, emphasize: true }
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                if (row.separator) tr.classList.add('border-t-2', 'border-gray-200');
                if (row.isInfo) tr.style.fontStyle = 'italic';
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                const cell0 = document.createElement('td');
                if (row.label === '  Capital Recibido') {
                    cell0.textContent = formatCurrency(modelData.seriesA);
                    cell0.classList.add('positive', 'font-bold');
                }
                else if (row.key === 'netCash' || row.key === 'cash') {
                     cell0.textContent = formatCurrency(modelData.seriesA);
                     cell0.classList.add('positive', 'font-bold');
                } else {
                    cell0.textContent = '-'; 
                }
                tr.appendChild(cell0);
                
                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value;
                    if (row.fromPL) {
                        value = financialResults.pl[i][row.key] || 0;
                    } else if (row.fromBS) {
                        value = financialResults.bs[i][row.key] || 0;
                    } else if (row.fromCF) {
                        value = financialResults.cf[i][row.key] || 0;
                    } else if (row.deltaFromBS) {
                        const prevValue = (i === 0) ? 0 : financialResults.bs[i-1][row.key];
                        const currentValue = financialResults.bs[i][row.key];
                        value = currentValue - prevValue;
                    } else if (row.fromModelData && row.yearSpecific) {
                        const currentYear = i + 1;
                        if (row.key === 'partnerCapitalization') {
                             value = (modelData[`seriesB_newInvestors_year${currentYear}`] || 0) + (modelData[`partnerCapitalizationYear${currentYear}`] || 0);
                        } else {
                            value = 0;
                        }
                    } else {
                        value = financialResults.cf[i][row.key] || 0;
                    }
                    
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else if (row.positive && value > 0) {
                         cell.textContent = formatCurrency(value);
                         cell.classList.add('positive');
                    }
                    else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (value === 0) {
                        cell.style.color = '#94a3b8';
                    }
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                }
                
                tbody.appendChild(tr);
            });
            log('✅ Cash Flow Table updated.');
        }
        /**
         * Updates the Balance Sheet (BS) table.
         * Process: Iterates over predefined rows and annual data to populate the table.
         * Performs balance sheet validation and displays the result.
         */
        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody || !financialResults.bs.length) return;
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'ACTIVOS', total: true, emphasize: true },
                { label: '  Efectivo y Equivalentes', key: 'cash' },
                { label: '  Cuentas por Cobrar (Brutas)', key: 'receivables', isInfo: true },
                { label: '  (-) Provisiones NIIF 9', key: 'provisions', negative: true, isContraAsset: true },
                { label: '  Cuentas por Cobrar, Netas', key: 'receivablesNet', bold: true },
                { label: '  Activos Fijos Netos (Vagonetas)', key: 'fixedAssets' },
                { label: '  Activos Mantenidos para Venta (NIIF 5)', key: 'assetsHeldForSale' },
                { label: 'TOTAL ACTIVOS', key: 'totalAssets', total: true, emphasize: true },
                { label: 'PASIVOS Y PATRIMONIO', total: true, separator: true, emphasize: true },
                { label: '  Deuda Financiera', key: 'debt' },
                { label: '  Pasivos por Contrato (NIIF 15)', key: 'contractLiabilities' },
                { label: 'TOTAL PASIVOS', key: 'totalLiabilities', total: true }, 
                { label: '  Patrimonio', key: 'equity' },
                { label: 'TOTAL PASIVOS + PATRIMONIO', key: 'totalLiabilitiesEquity', total: true, emphasize: true }
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                if (row.separator) tr.classList.add('border-t-2', 'border-gray-200');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total || row.bold) labelCell.classList.add('font-bold');
                if (row.isInfo || row.isContraAsset) labelCell.style.paddingLeft = '2.5rem';
                tr.appendChild(labelCell);
                
                financialResults.bs.forEach(yearData => {
                    const cell = document.createElement('td');
                    let value = yearData[row.key] || 0;
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (value === 0) {
                        cell.style.color = '#94a3b8';
                    }
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
            
            const validationDiv = document.getElementById('balance-validation');
            let balanceValid = true;
            let maxDifference = 0;
            
            financialResults.bs.forEach((bsYear, index) => {
                const difference = Math.abs(bsYear.totalAssets - bsYear.totalLiabilitiesEquity); 
                maxDifference = Math.max(maxDifference, difference);
                if (difference > BALANCE_TOLERANCE) balanceValid = false; 
            });
            if (balanceValid) {
                validationDiv.innerHTML = '<span class="text-green-600">✅ Balance validated: Total Assets = Total Liabilities + Equity.</span>';
                validationDiv.classList.remove('bg-red-100', 'text-red-800');
                validationDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                validationDiv.innerHTML = `<span class="text-red-600">❌ Balance error: Difference of ${formatCurrency(maxDifference)}. Review calculations.</span>`;
                validationDiv.classList.remove('bg-green-100', 'text-red-800');
                validationDiv.classList.add('bg-red-100', 'text-red-800');
            }
            log('✅ Balance Sheet Table updated and validated.');
        }
        // ===== IFRS DETAIL TABLES =====
        /**
         * Updates the IFRS 15, IFRS 9, and IFRS 5 sections with detailed data.
         * Process: Injects dynamic HTML with specific tables and explanations for each standard.
         */
        function updateNIIFTables() {
            log('Updating IFRS detail tables...');
            if (!financialResults.niifDetails || financialResults.niifDetails.length === 0) {
                log('❌ No IFRS data to display.');
                return;
            }
            
            const container15 = document.getElementById('niif15-container');
            if (container15) {
                 container15.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Margen Originación (Inicial por Cohorte Nueva)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.originationContractValueInitial || 0)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Comisión Upfront (Inicial por Cohorte Nueva)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.upfrontCommissionInitial || 0)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Margen Originación + Upfront (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td class="positive">${formatCurrency(d.niif15.recognizedOriginationRevenue || 0)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Pasivos por Contrato (Acumulado)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.contractLiabilitiesBalance || 0)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos GNV (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.gnvCommissions || 0)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos Refacciones (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.sparePartsRevenue || 0)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>COGS Refacciones (NIIF 15)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.sparePartsCOGS || 0)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos Marketplace (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.marketplaceRevenue || 0)}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-slate-800 rounded-lg text-sm text-slate-300">
                        <h5 class="font-semibold text-base mb-1 text-white">Explicación NIIF 15 (Ingresos de Contratos con Clientes)</h5>
                        <p class="mb-1">• NIIF 15 establece un modelo de 5 pasos para reconocer ingresos. Se reconocen cuando (o a medida que) se satisfacen las <strong>obligaciones de desempeño</strong>.</p>
                        <ul class="list-disc list-inside ml-4">
                            <li><strong>Comisiones de Originación (Margen + Upfront):</strong> Se difieren como "Pasivos por Contrato" y se reconocen <strong>a lo largo del tiempo</strong> a medida que se amortiza el principal del préstamo o linealmente sobre la vida del préstamo (para upfront).</li>
                            <li><strong>Servicios GNV y Marketplace:</strong> Se reconocen <strong>al devengo</strong> (a lo largo del tiempo) a medida que los servicios se proveen por las unidades activas.</li>
                            <li><strong>Servicios de Refacciones:</strong> Se reconocen <strong>en un punto en el tiempo</strong> (al momento de la entrega, asumido en el año de adición de la unidad).</li>
                        </ul>
                        <p class="mb-1">• Los ingresos por intereses se rigen por NIIF 9, no por NIIF 15.</p>
                        <p class="mb-1">• El Balance General ahora refleja los <strong>Pasivos por Contrato</strong> para los ingresos diferidos.</p>
                    </div>
                `;
                log('✅ IFRS 15 updated.');
            }
            
            const container9 = document.getElementById('niif9-container');
            if (container9) {
                const year5NIIF9 = financialResults.niifDetails[4]?.niif9;
                if (year5NIIF9) {
                    container9.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="p-4 bg-sky-950 rounded-lg text-center text-sky-200">
                                <h5 class="font-semibold text-sky-400">ECL Etapa 1 (Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage1)}</p>
                                <p class="text-sm">PD: ${(year5NIIF9.pdStage1 * 100).toFixed(1)}%</p>
                            </div>
                            <div class="p-4 bg-amber-950 rounded-lg text-center text-amber-200">
                                <h5 class="font-semibold text-amber-400">ECL Etapa 2 (Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage2)}</p>
                                <p class="text-sm">PD: ${(year5NIIF9.pdStage2 * 100).toFixed(1)}%</p>
                            </div>
                            <div class="p-4 bg-rose-950 rounded-lg text-center text-rose-200">
                                <h5 class="font-semibold text-rose-400">ECL Etapa 3 (Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eclByStage.stage3)}</p>
                                <p class="text-sm">PD: ${(year5NIIF9.pdStage3 * 100).toFixed(1)}% (+50% si >2 años)</p>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-indigo-950 rounded-lg mb-4 text-indigo-200">
                            <h5 class="font-semibold text-indigo-400">Total Provisiones ECL Antes de Ajustes</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.totalECLBeforeAdjustment)}</p>
                            <p class="text-sm">LGD: ${(year5NIIF9.lgd * 100).toFixed(1)}%. Ajuste Económico: ${(year5NIIF9.economicAdjustmentFactor || 0).toFixed(2)}x</p>
                        </div>
                        <div class="text-center p-4 ${year5NIIF9.proteccionRodandoActiva ? 'bg-emerald-950 text-emerald-200' : 'bg-slate-800 text-slate-200'} rounded-lg">
                            <h5 class="font-semibold ${year5NIIF9.proteccionRodandoActiva ? 'text-emerald-400' : 'text-slate-400'}">Gasto por Provisiones NIIF 9 (P&L del Año 5)</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.provisionesConProteccion)}</p>
                            ${year5NIIF9.proteccionRodandoActiva ? 
                                `<p class="text-sm text-emerald-300"> <strong>✅ Reducción por Protección: ${formatCurrency(year5NIIF9.reduccionPorProteccion)}</strong></p>` : 
                                '<p class="text-sm text-slate-400">Protección Rodando inactiva</p>'}
                        </div>
                        <div class="mt-4 text-center p-4 bg-slate-900 rounded-lg text-slate-200">
                            <h5 class="font-semibold text-slate-400">Saldo Acumulado de Provisiones NIIF 9 (Balance Año 5)</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.saldoProvisionesAcumulado)}</p>
                            <p class="text-sm">Este es el saldo que aparece en el Balance General.</p>
                        </div>
                        <div class="mt-4 p-4 bg-slate-800 rounded-lg text-sm text-slate-300">
                            <h5 class="font-semibold text-base mb-1 text-white">Explicación NIIF 9 (Instrumentos Financieros)</h5>
                            <p class="mb-1">• NIIF 9 requires the recognition of expected credit loss (ECL) provisions on financial instruments (loan portfolio).</p>
                            <p class="mb-1">• <strong>Three-Stage Model:</strong> The portfolio is segmented by risk.</p>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Stage 1:</strong> Loans with low credit risk (12-month PD).</li>
                                <li><strong>Stage 2:</strong> Loans with significant increase in risk (lifetime PD).</li>
                                <li><strong>Stage 3:</strong> Loans with credit impairment (lifetime PD).</li>
                            </ul>
                            <p class="mb-1">• <strong>ECL Calculation:</strong> ECL = Average Exposure × Probability of Default (PD) × Loss Given Default (LGD).</p>
                            <p class="mb-1">• <strong>Dynamic PD:</strong> PD is adjusted according to loan age (increases 50% if > 2 years) to reflect increasing risk.</p>
                            <p class="mb-1">• <strong>Prospective Information:</strong> The economic adjustment factor allows incorporating future expectations about credit risk.</p>
                            <p class="mb-1">• "Protección Rodando" simulates a mechanism that reduces the final provision expense.</p>
                        </div>
                    `;
                log('✅ IFRS 9 updated.');
            } else {
                     log('⚠️ IFRS 9 data for Year 5 incomplete.');
                }
            }
            
            const container5 = document.getElementById('niif5-container');
            if (container5) {
                const year5NIIF5 = financialResults.niifDetails[4]?.niif5;
                if (year5NIIF5) {
                    container5.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="p-4 bg-purple-950 rounded-lg text-center text-purple-200">
                                <h5 class="font-semibold text-purple-400">Unidades Reposadas (Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.unidadesClasificadasAnuales.toFixed(0))}</p>
                                <p class="text-sm">Unidades reclasificadas como mantenidas para venta este año.</p>
                            </div>
                            <div class="p-4 bg-indigo-950 rounded-lg text-center text-indigo-200">
                                <h5 class="font-semibold text-indigo-400">Valor en Libros Original (Activos Reposedos Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorEnLibrosClasificado)}</p>
                                <p class="text-sm">Valor contable de las unidades clasificadas para venta en el Año 5.</p>
                            </div>
                            <div class="p-4 bg-blue-950 rounded-lg text-center text-blue-200">
                                <h5 class="font-semibold text-blue-400">Valor Razonable Neto (Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorRazonableMenosCostos)}</p>
                                <p class="text-sm">Valor de venta esperado menos costos de venta.</p>
                            </div>
                            <div class="p-4 ${year5NIIF5.perdidaPorDeterioro > 0 ? 'bg-rose-950 text-rose-200' : 'bg-emerald-950 text-emerald-200'} rounded-lg">
                                <h5 class="font-semibold ${year5NIIF5.perdidaPorDeterioro > 0 ? 'text-rose-400' : 'text-emerald-400'}">Pérdida por Deterioro (Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.perdidaPorDeterioro > 0 ? year5NIIF5.perdidaPorDeterioro : 0)}</p>
                                <p class="text-sm">Impacto en el Estado de Resultados por la reclasificación.</p>
                            </div>
                        </div>
                        <div class="mt-4 text-center p-4 bg-slate-900 rounded-lg text-slate-200">
                             <h5 class="font-semibold text-slate-400">Saldo Acumulado de Activos NIIF 5 (Año 5)</h5>
                             <p class="text-2xl font-bold">${formatCurrency(year5NIIF5.saldoActivosParaVentaAcumulado)}</p>
                             <p class="text-sm">Este es el saldo que aparece en el Balance General.</p>
                         </div>
                        <div class="mt-4 p-4 bg-slate-800 rounded-lg text-sm text-slate-300">
                            <h5 class="font-semibold text-base mb-1 text-white">Explicación NIIF 5 (Activos No Corrientes Mantenidos para la Venta)</h5>
                            <p class="mb-1">• Non-current assets (vans) expected to be sold in the short term are classified as "Held for Sale".</p>
                            <p class="mb-1">• These assets are measured at the lower of their carrying amount and fair value less costs to sell. Their depreciation is suspended.</p>
                            <p class="mb-1">• An impairment loss is recognized if the carrying amount exceeds the net fair value less costs to sell. Gains on reversal of impairment are limited to the original loss.</p>
                        </div>
                    `;
                log('✅ IFRS 5 updated.');
            } else {
                     log('⚠️ IFRS 5 data for Year 5 incomplete.');
                }
            }
        }
        
        // ===== CHARTS (Chart.js) =====
        /**
         * Initializes Chart.js instances for the charts.
         */
        function initializeCharts() {
            try {
                Object.keys(charts).forEach(key => {
                    if (charts[key]) {
                        charts[key].destroy();
                    }
                });
                charts = {};                                
                // Protección Rodando Impact Chart
                const ctx1 = document.getElementById('proteccionImpactChart');
                if (ctx1) {
                    charts.proteccion = new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['Evento Adverso', 'Detección IA', 'Intervención PIA', 'Flexibilidad', 'Cliente Preservado'],
                            datasets: [{
                                label: 'Sin Protección (%)',
                                data: [100, 70, 55, 47, 47],
                                backgroundColor: '#ef4444'
                            }, {
                                label: 'Con Protección Rodando™ (%)',
                                 data: [100, 85, 77, 73, 73],
                                backgroundColor: '#10b981'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'top', labels: { color: '#94a3b8' } } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { ticks: { color: '#94a3b8', callback: v => v + '%' }, max: 100 }
                            }
                        }
                    });
                }
                // Revenue Evolution Chart
                const ctx2 = document.getElementById('revenueEvolutionChart');
                if (ctx2) {
                    charts.revenue = new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                            datasets: [{
                                label: 'Intereses Financiamiento',
                                data: [85, 75, 60, 50, 45],
                                borderColor: '#0ea5e9',
                                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                                fill: true
                            }, {
                                label: 'Comisiones GNV',
                                data: [12, 18, 25, 30, 32],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true
                            }, {
                                label: 'Marketplace + PMA',
                                data: [3, 7, 15, 20, 23],
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { ticks: { color: '#94a3b8', callback: v => v + '%' } }
                            }
                        }
                    });
                }
                // Cash Flow Resilience Chart
                const ctx3 = document.getElementById('cashFlowResilienceChart');
                if (ctx3) {
                    charts.cashFlowResilienceChart = new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                            datasets: [
                                { label: 'Operativo', data: [0,0,0,0,0], backgroundColor: '#10b981' },
                                { label: 'Inversión', data: [0,0,0,0,0], backgroundColor: '#ef4444' },
                                { label: 'Financiamiento', data: [0,0,0,0,0], backgroundColor: '#3b82f6' }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { ticks: { color: '#94a3b8' } }
                            }
                        }
                    });
                }
                // Gamification Impact Chart
                const ctx4 = document.getElementById('gamificationChart');
                if (ctx4) {
                    charts.gamificationChart = new Chart(ctx4, {
                        type: 'radar',
                        data: {
                            labels: ['Retención', 'Eficiencia', 'Puntualidad', 'Satisfacción', 'Seguridad', 'Mantenimiento'],
                            datasets: [
                                {
                                    label: 'Sin Gamificación',
                                    data: [65, 70, 75, 70, 60, 65],
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                    pointBackgroundColor: '#ef4444'
                                },
                                {
                                    label: 'Con Gamificación RAG',
                                    data: [85, 88, 92, 90, 85, 90],
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                    pointBackgroundColor: '#10b981'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
                            scales: {
                                r: {
                                     beginAtZero: true,
                                     max: 100,
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                }
                            }
                        }
                    });
                }
                // Path to Leadership Chart
                const ctx5 = document.getElementById('leadershipChart');
                if (ctx5) {
                    charts.leadershipChart = new Chart(ctx5, {
                        type: 'line',
                        data: {
                            labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                            datasets: [
                                {
                                    label: 'RAG Market Share',
                                    data: [2, 5, 12, 18, 25],
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: true,
                                    tension: 0.3
                                },
                                {
                                    label: 'Competidor Tradicional',
                                    data: [25, 23, 20, 18, 16],
                                    borderColor: '#ef4444',
                                    fill: false,
                                    tension: 0.3
                                },
                                {
                                    label: 'Competidor Digital',
                                    data: [15, 16, 15, 14, 13],
                                    borderColor: '#94a3b8',
                                    fill: false,
                                    tension: 0.3
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { ticks: { color: '#94a3b8', callback: v => v + '%' }, max: 30 }
                            }
                        }
                    });
                }
                // Competitive Moat Chart
                const ctx6 = document.getElementById('moatChart');
                if (ctx6) {
                    charts.moatChart = new Chart(ctx6, {
                        type: 'bar',
                        data: {
                            labels: ['Tecnología IA', 'Red Partners', 'Data Propietaria', 'Switching Costs', 'Economías Escala'],
                            datasets: [{
                                label: 'Fortaleza del Moat (1-10)',
                                data: [9, 7, 8, 6, 5],
                                backgroundColor: [
                                    '#10b981', // IA = fuerte
                                    '#3b82f6', // Partners = bueno
                                      '#10b981', // Data = fuerte
                                    '#f59e0b', // Switching = medio
                                    '#ef4444'  // Escala = débil aún
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: '#94a3b8' } },
                                y: { ticks: { color: '#94a3b8' }, max: 10, beginAtZero: true }
                            }
                        }
                    });
                }
                // Capital Efficiency Chart
                const ctx7 = document.getElementById('capitalEfficiencyChart');
                if (ctx7) {
                    charts.capitalEfficiencyChart = new Chart(ctx7, {
                        type: 'doughnut',
                        data: {
                            labels: ['RAG Actual', 'Target Serie A', 'Industria Promedio'],
                            datasets: [{
                                data: [750, 750, 900],
                                backgroundColor: ['#10b981', '#3b82f6', '#94a3b8']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                 legend: {
                                     position: 'bottom',
                                     labels: { color: '#94a3b8', font: { size: 10 } }
                                 }
                            }
                        }
                    });
                }
                log(' ✅  New Rodando charts initialized');
            } catch (error) {
                log(` ❌  Error: ${error.message}`);
            }
        }
        
        /**
         * Updates the chart data with current financial results.
         */
        function updateCharts() {
            try {
                if (!financialResults.pl.length) return;
                // Future functions to update new charts will be called here
                // Update Capital Efficiency Chart
                if (charts.capitalEfficiencyChart) {
                    const totalUnits = modelData.unitsPerYear.reduce((sum, units) => sum + units, 0);
                    const totalCapex = totalUnits * getTotalPackageCost();
                    const capexPerUnit = totalUnits > 0 ? totalCapex / totalUnits / 1000 : 0;                                        
                    charts.capitalEfficiencyChart.data.labels = ['RAG Actual', 'Target A', 'Industria'];
                    charts.capitalEfficiencyChart.data.datasets = [{
                        data: [capexPerUnit, 750, 900],
                        backgroundColor: ['#10b981', '#3b82f6', '#94a3b8']
                    }];
                    charts.capitalEfficiencyChart.update();
                }
                // Update Cash Flow Resilience Chart
                if (charts.cashFlowResilienceChart && financialResults.cf.length >= 5) {
                    const operatingCF = financialResults.cf.map(cf => cf.operatingCash / 1000000);
                    const investingCF = financialResults.cf.map(cf => cf.investingCash / 1000000);
                    const financingCF = financialResults.cf.map(cf => cf.financingCash / 1000000);                                        
                    charts.cashFlowResilienceChart.data.labels = ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'];
                    charts.cashFlowResilienceChart.data.datasets = [
                        { label: 'Operativo', data: operatingCF, backgroundColor: '#10b981' },
                        { label: 'Inversión', data: investingCF, backgroundColor: '#ef4444' },
                        { label: 'Financiamiento', data: financingCF, backgroundColor: '#3b82f6' }
                    ];
                    charts.cashFlowResilienceChart.update();
                }
                log(' ✅  Rodando charts updated');
            } catch (error) {
                log(`Error updating charts: ${error.message}`);
            }
        }
        
        /**
         * Forces a manual recalculation of the model.
         */
        function forceCalculate() {
            log('🔄 Manual recalculation requested.');
            console.log('🔍 INTENTANDO CALCULAR...');
            if (!calculateFinancials()) {
                console.log('❌ calculateFinancials FALLÓ');
                log('❌ Manual recalculation failed.');
            } else {
                updateUI();
                log('✅ Manual recalculation completed.');
            }
        }
        // ===== USER CONTROL CONFIGURATION =====
        
        /**
         * Helper function to create and append a slider control.
         * @param {Object} config - Configuration object for the slider.
         * @param {HTMLElement} container - The DOM element to append the control to.
         */
        function createSliderControl(config, container) {
            const div = document.createElement('div');
            div.className = 'control-grid';
            const label = document.createElement('label');
            label.className = "text-sm font-medium text-slate-300";
            if (config.tooltip) {
                label.setAttribute('data-tooltip', config.tooltip);
            }
            label.textContent = config.label;
            div.appendChild(label);
            
            const sliderContainer = document.createElement('div');
            sliderContainer.className = 'slider-container';
            
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.id = `${config.id}-input`;
            slider.min = config.min;
            slider.max = config.max;
            slider.step = config.step;
            slider.value = modelData[config.id];
            slider.className = 'input-slider';
            sliderContainer.appendChild(slider);
            
            const display = document.createElement('span');
            display.id = `${config.id}-valor`;
            display.className = "font-bold text-teal-400 w-24 text-right"; // Fixed width for alignment
            display.textContent = (config.format && typeof config.format === 'function') ? config.format(modelData[config.id]) : modelData[config.id].toString();
            sliderContainer.appendChild(display);
            div.appendChild(sliderContainer);
            container.appendChild(div);
            
            slider.addEventListener('input', function() {
                let value = parseFloat(this.value);
                modelData[config.id] = value;
                display.textContent = config.format(value);
                
                this.classList.remove('validation-error', 'validation-warning', 'validation-success');
                
                if (['vanPrice', 'vanCost'].includes(config.id)) {
                    const unitEcon = evaluateUnitEconomics();
                    if (unitEcon.marginPercent < 10) {
                        this.classList.add('validation-error');
                        showWarning(`  🚨   Unit economics críticos: ${unitEcon.marginPercent.toFixed(1)}% margin. Mínimo Serie A: 15%`);
                    } else if (unitEcon.marginPercent < 15) {
                        this.classList.add('validation-warning');
                        showWarning(`  ⚠️   Unit economics bajos: ${unitEcon.marginPercent.toFixed(1)}% margin. Target Serie A: 20%+`);
                    } else {
                        this.classList.add('validation-success');
                    }
                }
                
                if (config.id === 'tasaInteres') {
                    if (value < 22) {
                        this.classList.add('validation-error');
                        showWarning(`  🚨   Tasa insostenible: ${value}%. Unit economics requieren mínimo 22% para Serie A viability`);
                    } else if (value < 25) {
                        this.classList.add('validation-warning');
                        showWarning(`  ⚠️   Tasa baja: ${value}%. Sweet spot Serie A: 25-30% para margins defendibles`);
                    } else {
                        this.classList.add('validation-success');
                    }
                }
                
                if (['ventureDebtRate', 'commercialDebtRate'].includes(config.id)) {
                    const debtService = calculateDebtServiceCoverage();
                    if (debtService.dscr < 1.2) {
                        this.classList.add('validation-error');
                        showWarning(`  🚨   DSCR crítico: ${debtService.dscr.toFixed(1)}x. Debt service: ${formatCurrency(debtService.totalDebtService)}, EBITDA est: ${formatCurrency(debtService.estimatedEBITDA)}`);
                    } else if (debtService.dscr < 1.5) {
                        this.classList.add('validation-warning');
                        showWarning(`  ⚠️   DSCR bajo: ${debtService.dscr.toFixed(1)}x. Target Serie A: >1.5x para debt comfort`);
                    } else {
                        this.classList.add('validation-success');
                    }
                }
                
                if (['pdStage1', 'pdStage2'].includes(config.id)) {
                    const configItem = controlsConfig.riesgoYSalida.find(c => c.id === config.id);
                    if (configItem && configItem.investorRange) {
                        const range = configItem.investorRange;
                        const valuePercent = value * 100;
                        if (valuePercent < range.green[0] || valuePercent > range.red[1]) {
                            this.classList.add('validation-warning');
                            showWarning(`  📊   Assumption fuera de benchmark: ${valuePercent.toFixed(1)}%. Range realista: ${range.green[0]}-${range.green[1]}%`);
                        } else if (valuePercent >= range.green[0] && valuePercent <= range.green[1]) {
                            this.classList.add('validation-success');
                        } else {
                            this.classList.add('validation-warning');
                        }
                    }
                }
                
                log(`${config.label} changed to: ${value}`);
                if (calculateFinancials()) {
                    updateUI();
                }
            });
        }
        /**
         * Helper function to create and append a number input control.
         * @param {Object} config - Configuration object for the number input.
         * @param {HTMLElement} container - The DOM element to append the control to.
         */
        function createNumberControl(config, container) {
            const div = document.createElement('div');
            div.className = 'control-grid';
            
            const label = document.createElement('label');
            label.htmlFor = `${config.id}-input`;
            label.className = "text-sm font-medium text-slate-300";
            if (config.tooltip) {
                label.setAttribute('data-tooltip', config.tooltip);
            }
            label.textContent = config.label;
            div.appendChild(label);
            const input = document.createElement('input');
            input.type = 'number';
            input.id = `${config.id}-input`;
            input.min = config.min;
            input.max = config.max;
            input.step = config.step;
            input.value = modelData[config.id];
            input.className = "p-2 border border-slate-700 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-white w-full";
            div.appendChild(input);
            container.appendChild(div);
            
            input.addEventListener('input', function() {
                let value = parseFloat(this.value);
                if (isNaN(value)) value = config.min;
                
                value = Math.max(config.min, Math.min(config.max, value));
                if (config.label.includes('Año') || config.label.includes('Años')) {
                    value = Math.round(value);
                }
                this.value = value; // Correct the input value if it's out of bounds
                modelData[config.id] = value;
                
                log(`${config.label} changed to: ${value}`);
                if (calculateFinancials()) {
                    updateUI();
                }
            });
        }
        
        /**
         * Sets up controls for a specific group/card.
         * @param {string} groupKey - The key for the control group in controlsConfig.
         * @param {string} containerId - The ID of the DOM element to append the controls to.
         */
        function setupControlGroup(groupKey, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                log(`❌ Container with ID '${containerId}' not found for control group '${groupKey}'.`);
                return;
            }
            container.innerHTML = ''; // Clear previous controls
            
            const groupConfig = controlsConfig[groupKey] || [];
            
            groupConfig.forEach(config => {
                 if (config.id === 'unitsPerYear' || (config.id === 'opexRates' && config.type === 'array')) {
                    const arrayContainer = document.createElement('div');
                    
                    const label = document.createElement('h5');
                    label.className = 'text-sm font-medium text-slate-300 mb-2';
                    label.textContent = config.label;
                    if(config.tooltip) label.setAttribute('data-tooltip', config.tooltip);
                    arrayContainer.appendChild(label);

                    const grid = document.createElement('div');
                    grid.className = 'units-grid';
                    
                    modelData[config.id].forEach((itemValue, index) => {
                        const maxVal = config.dynamicMax ? calculateMaxUnitsFinanceable() : config.max;
                        const div = document.createElement('div');
                        div.className = 'flex flex-col';
                        div.innerHTML = `
                            <label for="${config.id}-${index+1}" class="text-xs font-medium text-slate-400 mb-1">Año ${index+1}</label>
                            <input type="number" id="${config.id}-${index+1}" min="${config.min}" max="${maxVal}" step="${config.step}" value="${itemValue}" 
                                class="p-2 border border-slate-700 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-white">
                            ${config.dynamicMax ? `<span class="text-xs text-slate-400 mt-1">Máx: ${maxVal}</span>` : ''}
                        `;
                        grid.appendChild(div);
                        
                        const input = div.querySelector(`input[type="number"]`); 
                        input.addEventListener('change', function() {
                            const value = parseFloat(this.value);
                            let newValue = Math.max(config.min, Math.min(maxVal, isNaN(value) ? config.min : value));
                            this.value = newValue; 
                            modelData[config.id][index] = newValue;
                            
                            log(`${config.label} Año ${index+1} changed to: ${newValue}`);
                            forceCalculate();
                        });
                    });
                    arrayContainer.appendChild(grid);
                    container.appendChild(arrayContainer);
                } else if (config.type === 'range') {
                    createSliderControl(config, container);
                } else if (config.type === 'number') {
                    createNumberControl(config, container);
                } else if (config.type === 'checkbox') {
                     const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center mt-4 p-3 bg-slate-800/50 rounded-lg';
                    checkboxDiv.innerHTML = `
                        <input id="${config.id}-input" type="checkbox" class="h-4 w-4 rounded border-slate-600 text-sky-500 focus:ring-sky-500 bg-slate-700">
                        <label for="${config.id}-input" class="ml-3 block text-sm font-medium text-slate-200" data-tooltip="${config.tooltip}">${config.label}</label>
                    `;
                    container.appendChild(checkboxDiv);
                    const checkbox = document.getElementById(`${config.id}-input`);
                    checkbox.checked = modelData[config.id]; 
                    checkbox.addEventListener('change', function() {
                        modelData[config.id] = this.checked;
                        log(`${config.label}: ${this.checked ? 'ACTIVATED' : 'DEACTIVATED'}`);
                        if (calculateFinancials()) {
                            updateUI();
                        }
                    });
                }
            });
            log(`✅ '${groupKey}' controls configured.`);
        }
        
        function setupFinancingMatrix() {
            const container = document.getElementById('matriz-financiamiento-controls');
            container.innerHTML = ''; // Clear previous content
            // Serie A (Año 0)
            const seriesADiv = document.createElement('div');
            seriesADiv.className = 'control-grid mb-4';
            seriesADiv.innerHTML = `
                <label for="seriesA-input" class="text-sm font-medium text-slate-300" data-tooltip="Capital semilla inicial que arranca la operación.">Serie A (Año 0)</label>
                <input type="number" id="seriesA-input" min="0" step="1000000" value="${modelData.seriesA}" class="p-2 border border-slate-700 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-white w-full">
            `;
            container.appendChild(seriesADiv);
            const seriesAInput = seriesADiv.querySelector('input');
            seriesAInput.addEventListener('change', (e) => {
                modelData.seriesA = parseFloat(e.target.value) || 0;
                forceCalculate();
            });
            const table = document.createElement('table');
            table.id = 'financing-matrix-table';
            // Header
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = ['Instrumento', 'Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'];
            headers.forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            // Body
            const tbody = table.createTBody();
            const rowsData = [
                { label: 'Venture Debt', key: 'ventureDebtYear' },
                { label: 'Serie B (Nuevos)', key: 'seriesB_newInvestors_year', singleYear: 2 },
                { label: 'Capitalización Socios', key: 'partnerCapitalizationYear' },
                { label: 'Deuda Comercial', key: 'commercialDebtYear' },
            ];
            
            rowsData.forEach(rowData => {
                const row = tbody.insertRow();
                const labelCell = row.insertCell();
                labelCell.textContent = rowData.label;
                
                for (let year = 1; year <= 5; year++) {
                    const cell = row.insertCell();
                    const modelKey = `${rowData.key}${year}`;
                    
                    if (rowData.singleYear && rowData.singleYear !== year) {
                        cell.innerHTML = `&ndash;`;
                        continue;
                    }
                     if (!rowData.singleYear || rowData.singleYear === year) {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = 1000000;
                        input.min = 0;
                        input.value = modelData[modelKey] || 0;
                        input.addEventListener('change', (e) => {
                            modelData[modelKey] = parseFloat(e.target.value) || 0;
                            forceCalculate();
                        });
                        cell.appendChild(input);
                    }
                }
            });
            container.appendChild(table);
            // Add rates controls below the matrix
            const ratesDiv = document.createElement('div');
            ratesDiv.className = 'mt-4 space-y-4';
            createSliderControl({ id: 'ventureDebtRate', label: 'Tasa Venture Debt', min: 12, max: 20, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Tasa de interés anual del Venture Debt.' }, ratesDiv);
            createSliderControl({ id: 'commercialDebtRate', label: 'Tasa Deuda Comercial', min: 10, max: 18, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%', tooltip: 'Tasa de interés anual de la deuda comercial.' }, ratesDiv);
            container.appendChild(ratesDiv);
        }
        function updateOptimizationStatus() {
            const statusContainer = document.getElementById('riesgo-salida-controls');
            if (statusContainer) {
                 let statusElement = document.getElementById('optimization-status');
                 if (!statusElement) {
                    statusElement = document.createElement('div');
                    statusElement.id = 'optimization-status';
                    statusElement.className = 'mt-4 p-3 rounded-lg bg-slate-800 text-sm';
                    statusContainer.appendChild(statusElement);
                 }
                const vdRate = modelData.ventureDebtRate;
                const commRate = modelData.commercialDebtRate;
                
                let totalCapex = 0;
                for (let i = 0; i < modelData.unitsPerYear.length; i++) {
                    totalCapex += modelData.unitsPerYear[i] * getTotalPackageCost();
                }
                
                let totalFunding = modelData.seriesA;
                for (let i = 1; i <= 5; i++) {
                    totalFunding += (modelData[`partnerCapitalizationYear${i}`] || 0) + 
                                    (modelData[`ventureDebtYear${i}`] || 0) + 
                                    (modelData[`commercialDebtYear${i}`] || 0) +
                                    (modelData[`seriesB_newInvestors_year${i}`] || 0);
                }
                
                const fundingRatio = totalCapex > 0 ? totalFunding / totalCapex : 0;
                
                statusElement.innerHTML = `
                    <div class="text-slate-300">
                        <strong>   🎯    Status de Financiamiento:</strong><br>
                        • Tasa VD: ${vdRate.toFixed(1)}% ${vdRate >= 12 && vdRate <= 20 ? '   ✅   ' : '   ⚠️   '}<br>
                        • Tasa Comercial: ${commRate.toFixed(1)}% ${commRate >= 10 && commRate <= 18 ? '   ✅   ' : '   ⚠️   '}<br>
                        • Cobertura CAPEX: ${(fundingRatio * 100).toFixed(0)}% ${fundingRatio >= 1.0 ? '   ✅   ' : '   🚨   '}
                    </div>
                `;
            }
        }
        
        /**
         * Main function to set up all UI controls.
         */
        function setupControls() {
            setupControlGroup('paqueteFinanciado', 'paquete-financiado-controls');
            setupControlGroup('condicionesCredito', 'condiciones-credito-controls');
            setupControlGroup('ingresosAdicionales', 'ingresos-adicionales-controls');
            setupControlGroup('planCrecimiento', 'plan-crecimiento-controls');
            setupFinancingMatrix(); // New matrix setup
            setupControlGroup('riesgoYSalida', 'riesgo-salida-controls');
            
            updatePackageSummary();
            updateOptimizationStatus();
        }
        /**
         * Updates the automatic summary for the "Package and Prices" section.
         */
        function updatePackageSummary() {
            const totalPrice = getTotalPackagePrice();
            const totalCost = getTotalPackageCost();
            const margin = totalPrice - totalCost;
            const marginPercent = (totalPrice > 0) ? (margin / totalPrice) * 100 : 0;
            
            const summaryContainer = document.getElementById('package-summary');
            if (summaryContainer) {
                 summaryContainer.innerHTML = `
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>Precio Total Paquete:</span>
                            <span class="font-bold text-sky-400">${formatCurrency(totalPrice)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Costo Total RAG:</span>
                            <span>${formatCurrency(totalCost)}</span>
                        </div>
                        <div class="flex justify-between border-t border-slate-600 pt-1">
                            <span>Margen Bruto Unitario:</span>
                            <span class="font-bold text-emerald-400">
                                ${formatCurrency(margin)} (${marginPercent.toFixed(1)}%)
                            </span>
                        </div>
                    </div>
                `;
            }
            log('✅ Package summary updated.');
        }
        /**
         * Configures tab navigation.
         * Forces UI update when switching to financial/charts/validation tabs.
         */
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    button.classList.add('active');
                    contentSections[index].classList.add('active');
                    
                    if (button.id === 'tab-financieros' || button.id === 'tab-niif' || button.id === 'tab-graficos' || button.id === 'tab-validacion') {
                        setTimeout(() => {
                            if (calculateFinancials()) { 
                                updateUI();
                            }
                        }, 50); 
                    }
                });
            });
            log('✅ Tab navigation configured.');
        }
        // ===== COMPREHENSIVE VALIDATION FUNCTIONS =====
        /**
         * Performs a comprehensive validation of the financial model, covering inputs, outputs, and consistency.
         * Process: Calls specific validation functions for each area and accumulates the results.
         * @param {ModelData} modelData - Model input data.
         * @param {Object} financialResults - Calculated model results.
         * @returns {Object} Object with arrays of errors, warnings, info, and passed.
         */
        function validateModelComprehensively(modelData, financialResults) {
            const validations = {
                errors: [],      
                warnings: [],    
                info: [],        
                passed: []       
            };
            
            validateInputs(modelData, validations);
            
            if (financialResults.pl.length > 0 && financialResults.cf.length > 0 && financialResults.bs.length > 0) {
                validateOutputs(financialResults, validations);
                validateConsistency(financialResults, validations);
                validateTemporal(financialResults, validations);
                if (financialResults.pl.length === 5) {
                    validateIndustryBenchmarks(financialResults, validations);
                } else {
                    validations.info.push("No enough projection years to evaluate industry benchmarks.");
                }
                validateFinancingCapacity(modelData, financialResults, validations);
            } else {
                validations.errors.push("Financial results could not be calculated. Please review initial inputs.");
            }
            
            return validations;
        }
        /**
         * Validates model inputs, including ranges and cross-validations.
         * @param {ModelData} modelData - Model input data.
         * @param {Object} validations - Object where validation results are accumulated.
         */
        function validateInputs(modelData, validations) {
            if (modelData.seriesA <= 0) {
                validations.errors.push("🔴 Error: Series A Capital must be greater than 0. Adjust 'Capital Serie A' in Control.");
            }
            if (modelData.vanCost <= 0) {
                validations.errors.push("🔴 Error: Van Cost must be greater than 0. Adjust 'Costo Vagoneta (RAG)' in Control.");
            }
            if (getTotalPackagePrice() <= 0) {
                validations.errors.push(`🔴 Error: Total Package Price (${formatCurrency(getTotalPackagePrice())}) must be greater than 0. Adjust component prices or van in Control.`);
            }
            if (getTotalPackageCost() <= 0) {
                validations.errors.push(`🔴 Error: Total Package Cost (${formatCurrency(getTotalPackageCost())}) must be greater than 0. Adjust component costs or van in Control.`);
            }
            if (modelData.clientLoanTermYears <= 0 || !Number.isInteger(modelData.clientLoanTermYears)) {
                validations.errors.push("🔴 Error: Client Loan Term must be a positive integer. Adjust 'Plazo Préstamo Cliente' in Control.");
            }
            if (modelData.depreciationYears <= 0 || !Number.isInteger(modelData.depreciationYears)) {
                validations.errors.push("🔴 Error: Depreciation Years must be a positive integer. Adjust 'Años Depreciación' in Control.");
            }
            
            const percentageInputs = [
                { id: 'tasaInteres', label: 'Tasa de Interés (Clientes)' }, 
                { id: 'margenRefacciones', label: 'Margen Refacciones' },
                { id: 'margenVagoneta', label: 'Margen Originación Vagoneta' },
                { id: 'tasaReposicion', label: '% Unidades Reposición' },
                { id: 'fairValueVenta', label: '% Fair Value Venta' }, 
                { id: 'costosVenta', label: '% Costos Venta' },
                { id: 'corporateTaxRate', label: 'Tasa Impuesto Corporativo (%)' },
                { id: 'comisionGNVPorcentaje', label: 'Comisión GNV (%)' },
                { id: 'takeRateMarketplace', label: 'Take Rate Marketplace (%)' },
                { id: 'downPaymentPercentage', label: 'Down Payment Cliente (%)' },
                { id: 'upfrontCommissionPercentage', label: 'Comisión Upfront (%)' }
            ];
            percentageInputs.forEach(p => {
                if (modelData[p.id] < 0 || modelData[p.id] > 100) {
                    validations.warnings.push(`🟡 Warning: '${p.label}' (${modelData[p.id].toFixed(1)}%) is outside typical range (0-100%). Review in Control.`);
                }
            });
            
            const decimalPercentageInputs = [
                { id: 'pdStage1', label: 'PD Etapa 1 (12M)' }, 
                { id: 'pdStage2', label: 'PD Etapa 2 (Lifetime)' },
                { id: 'pdStage3', label: 'PD Etapa 3 (Lifetime)' }, 
                { id: 'lgd', label: 'LGD (Pérdida Incumplimiento)' },
                { id: 'portfolioAllocationStage1', label: 'Port. Etapa 1 (%)' },
                { id: 'portfolioAllocationStage2', label: 'Port. Etapa 2 (%)' },
                { id: 'portfolioAllocationStage3', label: 'Port. Etapa 3 (%)' }
            ];
            decimalPercentageInputs.forEach(p => {
                if (modelData[p.id] < 0 || modelData[p.id] > 1) {
                    validations.warnings.push(`🟡 Warning: '${p.label}' (${(modelData[p.id]*100).toFixed(1)}%) is outside valid range (0-100%). Review in Control.`);
                }
            });
            
            const totalAllocation = modelData.portfolioAllocationStage1 + modelData.portfolioAllocationStage2 + modelData.portfolioAllocationStage3;
            if (Math.abs(totalAllocation - 1.0) > 0.001) { 
                validations.errors.push(`🔴 Error: Sum of IFRS 9 Portfolio Allocation (${(totalAllocation*100).toFixed(1)}%) is not equal to 100%. Please adjust in Control.`);
            } else {
                validations.passed.push(`✅ Inputs: IFRS 9 Portfolio Allocation sums to 100%.`);
            }
            
            if (getTotalPackagePrice() <= getTotalPackageCost()) {
                validations.errors.push(`🔴 Input Error: 'Total Package Price' (${formatCurrency(getTotalPackagePrice())}) must be greater than 'Total Package Cost for RAG' (${formatCurrency(getTotalPackageCost())}).`);
            } else {
                validations.passed.push(`✅ Inputs: 'Total Package Price' is greater than 'Total Package Cost for RAG'.`);
            }
            
            validations.passed.push("✅ Inputs: Basic input parameters validated correctly.");
        }
        /**
         * Validates model outputs for financial sanity (e.g., cash balances, margins).
         * @param {Object} financialResults - Calculated model results.
         * @param {Object} validations - Object where validation results are accumulated.
         */
        function validateOutputs(financialResults, validations) {
            const lastYear = financialResults.pl.length - 1; 
            if (lastYear < 0) return;
            financialResults.bs.forEach((bsYear, index) => {
                if (bsYear.cash < -BALANCE_TOLERANCE) { 
                    validations.errors.push(`🔴 Error: Cash Balance at Year ${index + 1} end is significantly negative (${formatCurrency(bsYear.cash)}). The model requires more financing. Adjust Capital Series or units.`);
                } else if (bsYear.cash < 0) {
                    validations.warnings.push(`🟡 Warning: Cash Balance at Year ${index + 1} end is slightly negative (${formatCurrency(bsYear.cash)}). Consider adjusting financing.`);
                }
            });
            if (!validations.errors.some(e => e.includes("Negative cash")) && !validations.warnings.some(e => e.includes("Slightly negative cash"))) {
                 validations.passed.push("✅ Outputs: Cash balance is adequate in all years.");
            }
            const year5PL = financialResults.pl[lastYear];
            const year5BS = financialResults.bs[lastYear];
            
            if (year5PL.totalRevenue !== 0) {
                const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
                if (ebitdaMargin < 10 || ebitdaMargin > 40) {
                    validations.info.push(`🔵 Info: EBITDA Margin for Year ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) is outside typical fintech benchmark (10-40%).`);
                } else {
                    validations.passed.push(`✅ Outputs: EBITDA Margin for Year ${lastYear + 1} is realistic (${ebitdaMargin.toFixed(1)}%).`);
                }
            } else {
                validations.info.push(`🔵 Info: Total Revenue for Year ${lastYear + 1} is zero, cannot calculate EBITDA Margin.`);
            }
            
            if (financialResults.roe && financialResults.roe.length > lastYear && year5BS.equity !== 0) {
                const roe = financialResults.roe[lastYear];
                if (roe < 20 || roe > 30) {
                    validations.info.push(`🔵 Info: ROE for Year ${lastYear + 1} (${roe.toFixed(1)}%) is outside typical financial services benchmark (20-30%).`);
                } else {
                    validations.passed.push(`✅ Outputs: ROE for Year ${lastYear + 1} is realistic (${roe.toFixed(1)}%).`);
                }
            } else if (financialResults.roe && financialResults.roe.length > lastYear) { 
                validations.info.push(`🔵 Info: Equity for Year ${lastYear + 1} is zero or negative, cannot calculate significant ROE.`);
            }
            
            if (year5PL.totalRevenue !== 0) {
                const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
                if (cxcToRevenueRatio < 0.5 || cxcToRevenueRatio > 3) {
                    validations.info.push(`🔵 Info: A/R/Revenue Ratio for Year ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) is outside typical financing benchmark (0.5-3x).`);
                } else {
                    validations.passed.push(`✅ Outputs: A/R/Revenue Ratio for Year ${lastYear + 1} is realistic (${cxcToRevenueRatio.toFixed(1)}x).`);
                }
            } else {
                validations.info.push(`🔵 Info: Total Revenue for Year ${lastYear + 1} is zero, cannot compare A/R/Revenue Ratio.`);
            }
            
            if (year5BS.equity !== 0) {
                const debtToEquityRatio = year5BS.debt / year5BS.equity;
                if (debtToEquityRatio < 0 || debtToEquityRatio > 3) {
                    validations.warnings.push(`🟡 Warning: Debt/Equity Ratio for Year ${lastYear + 1} (${debtToEquityRatio.toFixed(1)}x) is unusual. Review assumptions.`);
                } else {
                    validations.passed.push(`✅ Outputs: Debt/Equity Ratio for Year ${lastYear + 1} is realistic (${debtToEquityRatio.toFixed(1)}x).`);
                }
            } else { 
                 validations.info.push(`🔵 Info: Equity for Year ${lastYear + 1} is zero or negative, cannot calculate significant Debt/Equity Ratio.`);
            }
        }
        /**
         * Validates consistency between different financial statements (P&L, CF, BS).
         * @param {Object} financialResults - Calculated model results.
         * @param {Object} validations - Object where validation results are accumulated.
         */
        function validateConsistency(financialResults, validations) {
            const tolerance = BALANCE_TOLERANCE; 
            const largeTolerance = 50000; 
            for (let i = 0; i < financialResults.pl.length; i++) {
                const pl = financialResults.pl[i];
                const cf = financialResults.cf[i];
                const bs = financialResults.bs[i];
                
                const prevBsCash = (i === 0) ? modelData.seriesA : financialResults.bs[i-1].cash;
                
                const balanceDiff = Math.abs(bs.totalAssets - bs.totalLiabilitiesEquity);
                if (balanceDiff > tolerance) {
                    validations.errors.push(`🔴 Consistency Error: Balance Sheet for Year ${i + 1} does not balance. Difference: ${formatCurrency(balanceDiff)}. Assets (${formatCurrency(bs.totalAssets)}) vs. Liabilities+Equity (${formatCurrency(bs.totalLiabilitiesEquity)}).`);
                } else {
                    validations.passed.push(`✅ Consistency: Balance Sheet for Year ${i + 1} balances.`);
                }
                
                const cashChangeCF = cf.netCash;
                const cashChangeBS = bs.cash - prevBsCash;
                if (Math.abs(cashChangeCF - cashChangeBS) > tolerance) {
                    validations.errors.push(`🔴 Consistency Error: Net Flow for Year ${i + 1} (${formatCurrency(cashChangeCF)}) differs from Cash change in Balance Sheet (${formatCurrency(cashChangeBS)}).`);
                } else {
                    validations.passed.push(`✅ Consistency: Net Flow and Cash change for Year ${i + 1} match.`);
                }
            }
        }
        /**
         * Validates the temporal evolution of key metrics (e.g., revenue growth, ratio changes).
         * @param {Object} financialResults - Calculated model results.
         * @param {Object} validations - Object where validation results are accumulated.
         */
        function validateTemporal(financialResults, validations) {
            for (let i = 1; i < financialResults.pl.length; i++) { 
                const prevPl = financialResults.pl[i-1];
                const currentPl = financialResults.pl[i];
                
                if (prevPl.totalRevenue !== 0) {
                    const revenueGrowth = (currentPl.totalRevenue / prevPl.totalRevenue - 1) * 100;
                    if (revenueGrowth > 1000) { 
                        validations.warnings.push(`🟡 Temporal Warning: Revenue Growth for Year ${i + 1} (${revenueGrowth.toFixed(1)}%) is extremely high. Review units or pricing assumptions.`);
                    }
                } else if (currentPl.totalRevenue > 0) {
                     validations.info.push(`🔵 Temporal Info: Year ${i + 1} Revenue starts ramp-up from zero/low. Percentage growth not significant.`);
                }
                
                if (prevPl.totalRevenue !== 0 && currentPl.totalRevenue !== 0) {
                    const prevEbitdaMargin = (prevPl.ebitda / prevPl.totalRevenue) * 100;
                    const currentEbitdaMargin = (currentPl.ebitda / currentPl.totalRevenue) * 100;
                    if (Math.abs(currentEbitdaMargin - prevEbitdaMargin) > 500) { 
                        validations.warnings.push(`🟡 Temporal Warning: EBITDA Margin changes drastically (${prevEbitdaMargin.toFixed(1)}% to ${currentEbitdaMargin.toFixed(1)}%) from Year ${i} to Year ${i + 1}. Review cost/revenue dynamics.`);
                    }
                }
            }
            validations.passed.push("✅ Temporal Evolution: Annual growth trends and ratios seem reasonable.");
        }
        /**
         * Compares model metrics with industry benchmarks for Year 5.
         * @param {Object} financialResults - Calculated model results.
         * @param {Object} validations - Object where validation results are accumulated.
         */
        function validateIndustryBenchmarks(financialResults, validations) {
            const lastYear = financialResults.pl.length - 1;
            if (lastYear < 4) return; 
            const year5PL = financialResults.pl[lastYear];
            const year5BS = financialResults.bs[lastYear];
            const year5ROE = financialResults.roe && financialResults.roe.length > lastYear ? financialResults.roe[lastYear] : 0;
            
            if (year5PL.totalRevenue !== 0) {
                const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
                if (ebitdaMargin < 10 || ebitdaMargin > 40) {
                    validations.info.push(`🔵 Info: EBITDA Margin for Year ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) is outside typical fintech benchmark (10-40%).`);
                } else {
                    validations.passed.push(`✅ Outputs: EBITDA Margin for Year ${lastYear + 1} is realistic (${ebitdaMargin.toFixed(1)}%).`);
                }
            } else {
                validations.info.push(`🔵 Info: Total Revenue for Year ${lastYear + 1} is zero, cannot calculate EBITDA Margin.`);
            }
            
            if (year5BS.equity !== 0) {
                if (year5ROE < 20 || year5ROE > 30) {
                    validations.info.push(`🔵 Info: ROE for Year ${lastYear + 1} (${year5ROE.toFixed(1)}%) is outside typical financial services benchmark (20-30%).`);
                } else {
                    validations.passed.push(`✅ Outputs: ROE for Year ${lastYear + 1} is realistic (${year5ROE.toFixed(1)}%).`);
                }
            } else { 
                 validations.info.push(`🔵 Info: Equity for Year ${lastYear + 1} is zero or negative, cannot compare ROE with benchmark.`);
            }
            
            if (year5PL.totalRevenue !== 0) {
                const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
                if (cxcToRevenueRatio < 0.5 || cxcToRevenueRatio > 3) {
                    validations.info.push(`🔵 Info: A/R/Revenue Ratio for Year ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) is outside typical financing benchmark (0.5-3x).`);
                } else {
                    validations.passed.push(`✅ Outputs: A/R/Revenue Ratio for Year ${lastYear + 1} is realistic (${cxcToRevenueRatio.toFixed(1)}x).`);
                }
            } else {
                validations.info.push(`🔵 Info: Total Revenue for Year ${lastYear + 1} is zero, cannot compare A/R/Revenue Ratio.`);
            }
            
            if (financialResults.tirEquity !== 0) {
                if (financialResults.tirEquity < 25 || financialResults.tirEquity > 35) {
                    validations.info.push(`🔵 Info: Equity IRR (${financialResults.tirEquity.toFixed(1)}%) is outside target range (25-35%).`);
                } else {
                    validations.passed.push(`✅ Benchmarks: Equity IRR (${financialResults.tirEquity.toFixed(1)}%) is within target range.`);
                }
            }
            
            if (financialResults.tirCartera !== 0) {
                if (financialResults.tirCartera < 20 || financialResults.tirCartera > 30) {
                    validations.info.push(`🔵 Info: Portfolio IRR (${(financialResults.tirCartera || 0).toFixed(1)}%) is outside target range (20-30%).`);
                } else {
                    validations.passed.push(`✅ Benchmarks: Portfolio IRR (${(financialResults.tirCartera || 0).toFixed(1)}%) is within target range.`);
                }
            }
            
            const roic = financialResults.roic && financialResults.roic.length > lastYear ? financialResults.roic[lastYear] : 0;
            if (roic !== 0) {
                if (roic < 15 || roic > 25) {
                    validations.info.push(`🔵 Info: ROIC for Year ${lastYear + 1} (${roic.toFixed(1)}%) is outside target range (15-25%).`);
                } else {
                    validations.passed.push(`✅ Benchmarks: ROIC for Year ${lastYear + 1} (${roic.toFixed(1)}%) is within target range.`);
                }
            } else if (financialResults.roic && financialResults.roic.length > lastYear) {
                validations.info.push(`🔵 Info: Average Invested Capital for Year ${lastYear + 1} is zero or negative, cannot compare ROIC with benchmark.`);
            }
        }
        
        function validateFinancingCapacity(modelData, financialResults, validations) {
            let totalCapex = 0;
            for (let i = 0; i < modelData.unitsPerYear.length; i++) {
                totalCapex += modelData.unitsPerYear[i] * getTotalPackageCost();
            }
            let totalFunding = modelData.seriesA;
            for (let i = 1; i <= 5; i++) {
                totalFunding += (modelData[`partnerCapitalizationYear${i}`] || 0) + 
                                (modelData[`ventureDebtYear${i}`] || 0) + 
                                (modelData[`commercialDebtYear${i}`] || 0) +
                                (modelData[`seriesB_newInvestors_year${i}`] || 0);
            }
            if (totalFunding < totalCapex) {
                validations.errors.push(`🔴 Validación Financiamiento: El financiamiento total (${formatCurrency(totalFunding)}) es INSUFICIENTE para cubrir el CAPEX total (${formatCurrency(totalCapex)}).`);
            } else {
                validations.passed.push(`✅ Validación Financiamiento: El financiamiento total (${formatCurrency(totalFunding)}) es SUFICIENTE para cubrir el CAPEX total.`);
            }
        }
        /**
         * Updates the validation panel in the UI with the results.
         * @param {Object} validations - Object with validation results.
         */
        function updateValidationPanel(validations) {
            const container = document.getElementById('validation-results-container');
            if (!container) return;
            container.innerHTML = ''; 
            
            const types = ['error', 'warning', 'info', 'passed'];
            types.forEach(type => {
                if (Array.isArray(validations[type])) {
                    validations[type].forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `validation-item ${type}`;
                        let icon = '';
                        if (type === 'error') icon = '🔴';
                        else if (type === 'warning') icon = '🟡'; 
                        else if (type === 'info') icon = '🔵';
                        else if (type === 'passed') icon = '✅';
                        div.innerHTML = `<span class="validation-icon">${icon}</span><div class="validation-message">${msg}</div>`;
                        container.appendChild(div);
                    });
                } else {
                    console.warn(`Validation type '${type}' is not an array:`, validations[type]);
                }
            });
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'validation-summary mt-4 p-2 rounded-lg';
            if (validations.errors.length > 0) {
                summaryDiv.classList.add('bg-red-200', 'text-red-800');
                summaryDiv.textContent = `🚨 ${validations.errors.length} CRITICAL ERRORS found. Please review and adjust inputs/logic.`;
            } else if (validations.warnings.length > 0) {
                summaryDiv.classList.add('bg-yellow-200', 'text-yellow-800');
                summaryDiv.textContent = `⚠️ ${validations.warnings.length} WARNINGS found. Review results with caution.`;
            } else {
                summaryDiv.classList.add('bg-green-200', 'text-green-800');
                summaryDiv.textContent = `✨ All critical validations passed. ${validations.info.length} informational notes.`;
            }
            container.appendChild(summaryDiv);
        }
        /**
         * Generates a validation report in PDF format (using the browser's print function).
         * This is a placeholder, a real implementation would require a PDF library (e.g., jsPDF).
         */
        function generateValidationReportPDF() {
            log('Generating validation PDF report...');
            const printContent = document.getElementById('validation-panel-content').outerHTML;
            const originalBody = document.body.innerHTML;
            const printWindow = window.open('', '', 'height=700,width=900');
            printWindow.document.write('<html><head><title>Reporte de Validación</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Inter', sans-serif; margin: 20px; }
                .validation-item { display: flex; align-items: flex-start; margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 0.5rem; border-left: 4px solid; }
                .validation-item.error { border-color: #ef4444; background-color: #fee2e2; }
                .validation-item.warning { border-color: #f59e0b; background-color: #fffbeb; }
                .validation-item.info { border-color: #3b82f6; background-color: #e0f2fe; }
                .validation-item.passed { border-color: #10b981; background-color: #d1fae5; }
                .validation-icon { font-size: 1.25rem; margin-right: 0.75rem; line-height: 1; }
                .validation-message { flex-grow: 1; font-size: 0.875rem; color: #374151; }
                .validation-summary { font-weight: bold; text-align: center; margin-top: 1rem; padding: 1rem; border-radius: 0.75rem; }
                .validation-summary.bg-red-200 { background-color: #fecaca; color: #b91c1c; }
                .validation-summary.bg-yellow-200 { background-color: #fef9c3; color: #b45309; }
                .validation-summary.bg-green-200 { background-color: #d1fae5; color: #065f46; }
            `);
            printWindow.document.write('</style></head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
            log('✅ Validation PDF report generated.');
        }
        /**
         * Performs a quick model integrity test.
         * @returns {boolean} True if the model's balance sheet squares, false otherwise.
         */
        function testModelIntegrity() {
            log(`Running quick model integrity test...`);
            const originalData = {...modelData};
            
            if (calculateFinancials()) {
                const balance = financialResults.bs[0];
                const balanceCheck = Math.abs(balance.totalAssets - balance.totalLiabilitiesEquity);
                
                if (balanceCheck > BALANCE_TOLERANCE) {
                    log(`❌ INTEGRITY FAILED: Balance unbalanced in Year 1 by ${formatCurrency(balanceCheck)}`);
                    Object.assign(modelData, originalData);
                    return false;
                }
                log(`✅ INTEGRITY OK: Balance balances in Year 1.`);
                Object.assign(modelData, originalData);
                return true;
            }
            Object.assign(modelData, originalData);
            return false;
        }
        function addWarningCards() {
            const container = document.querySelector('.max-w-7xl.mx-auto.p-4');
            const warningCard = document.createElement('div');
            warningCard.className = 'mb-6 p-4 bg-amber-900/30 border border-amber-600/50 rounded-xl';
            warningCard.innerHTML = `
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-amber-400 shrink-0 mt-1"></i>
                    <div>
                        <h3 class="text-amber-200 font-semibold mb-2">Disclaimer de Riesgo - Serie A</h3>
                        <ul class="text-amber-300 text-sm space-y-1">
                            <li>• Proyecciones basadas en supuestos de mercado conservadores</li>
                            <li>• PD assumptions calibrados para secured lending México</li>
                            <li>• Stress scenarios incluyen competencia bancaria y transición energética</li>
                            <li>• Modelo sujeto a validación continua con datos de piloto</li>
                        </ul>
                    </div>
                </div>
            `;
            container.insertBefore(warningCard, container.firstChild.nextSibling);
        }
        
        // ===== APPLICATION READY AND RUNNING =====
        /**
         * Runs when the DOM is fully loaded.
         * Process: Initializes the UI, configures controls, performs initial calculation, and updates UI and charts.
         */
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 STARTING FINANCIAL MODEL APPLICATION');
            
            try {
                setupTabs();
                setupControls();
                
                console.log('🔍 INTENTANDO CALCULAR...');
                if (!calculateFinancials()) {
                    console.log('❌ calculateFinancials FALLÓ');
                    log('❌ Defensive calculation failed at startup. Review initial modelData.');
                    document.getElementById('balance-validation').innerHTML = `<span class="text-red-600">❌ Error crítico al inicio. Revise los datos iniciales.</span>`;
                    document.getElementById('balance-validation').classList.add('bg-red-100', 'text-red-800');
                    return;
                }
                updateUI();
                log('✅ Initialization successful: Calculations and UI updated.');
                
                setTimeout(() => {
                    initializeCharts();
                    updateCharts();
                }, 500); 
                
                setTimeout(() => {
                    if (!testModelIntegrity()) {
                        log(`🚨 CRITICAL ERROR: Model unbalanced after initial corrections.`);
                    }
                }, 1000);
                
                log('🎉 APPLICATION READY AND RUNNING');
                
            } catch (error) {
                log(`❌ CRITICAL ERROR DURING INITIALIZATION: ${error.message}`);
                console.error('Critical error in initialization:', error);
            }
        });
    </script>
</body>
</html>
