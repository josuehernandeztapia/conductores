<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero - Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos previos... */
        .constant-control {
            margin-bottom: 12px;
        }
        .constant-control label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .unit-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .validation-error {
            color: #dc2626;
            font-weight: 500;
            background-color: #fef2f2;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Estructura HTML previa... -->

    <script>
        // Estado global con todas las constantes expuestas
        let modelData = {
            // Parámetros controlados por usuario
            tasaInteres: 25.5,
            tasaMorosidad: 8,
            proteccionRodando: true,
            margenVagoneta: 88000,
            comisionGNV: 8,
            margenRefacciones: 25,
            marketplace: 1,
            ventureDebtPct: 100,
            ventureDebtRate: 12,
            
            // Constantes expuestas como controles
            opexRate: 0.15,
            provisionRate: 0.08,
            depreciationYears: 10,
            lgd: 0.45,
            plazoFinanciamiento: 48,
            
            // Unidades por año (editables)
            unitsPerYear: [35, 70, 100, 150, 200],
            
            // Supuestos fijos
            vanCost: 641000,
            vanPrice: 729000,
            seriesA: 45000000
        };

        // Función de cálculo de TIR real
        function calculateIRR(cashFlows) {
            // Implementación Newton-Raphson para cálculo preciso de TIR
            const maxIter = 100;
            const tolerance = 1e-6;
            let guess = 0.1;  // Suposición inicial del 10%
            
            for (let i = 0; i < maxIter; i++) {
                let npv = 0.0;
                let dNpv = 0.0;
                
                for (let t = 0; t < cashFlows.length; t++) {
                    npv += cashFlows[t] / Math.pow(1 + guess, t);
                    dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                }
                
                const newGuess = guess - npv / dNpv;
                
                if (Math.abs(newGuess - guess) < tolerance) {
                    return newGuess * 100; // Convertir a porcentaje
                }
                
                guess = newGuess;
            }
            
            return guess * 100; // Devolver la mejor aproximación en porcentaje
        }

        // Lógica corregida para ingresos por intereses
        function calculateInterestRevenue(year) {
            // Base de cálculo: 60% del saldo de deuda del año anterior
            let debtBalance = 0;
            if (year > 0) {
                debtBalance = financialResults.bs[year-1].debt || 0;
            } else {
                debtBalance = modelData.seriesA * (modelData.ventureDebtPct / 100);
            }
            
            return debtBalance * (modelData.tasaInteres / 100) * 0.6;
        }

        // Lógica corregida para cuentas por cobrar
        function calculateReceivables(year) {
            return calculateInterestRevenue(year) / (modelData.tasaInteres / 100);
        }

        // Lógica corregida para activos fijos
        function calculateFixedAssets(year) {
            let totalCost = 0;
            for (let y = 0; y <= year; y++) {
                totalCost += modelData.unitsPerYear[y] * modelData.vanCost;
            }
            return totalCost;
        }

        // Función de cálculo financiero completa y corregida
        function calculateFinancials() {
            // Reset financial results
            financialResults.pl = [];
            financialResults.cf = [];
            financialResults.bs = [];
            financialResults.validation = {
                balanceCheck: true,
                niifCompliance: true
            };
            
            let accumulatedEarnings = 0;
            let cash = modelData.seriesA;
            let accumulatedDepreciation = 0;
            
            // Calcular flujos para TIR
            const cashFlows = [-modelData.seriesA]; // Inversión inicial en año 0
            
            for (let year = 0; year < 5; year++) {
                const addedUnits = modelData.unitsPerYear[year];
                
                // CALCULAR INGRESOS (NIIF 15)
                const vanSales = addedUnits * modelData.margenVagoneta;
                const interestRevenue = calculateInterestRevenue(year);
                const gnvCommissions = modelData.unitsPerYear.slice(0, year+1)
                    .reduce((sum, units) => sum + units * 12000, 0) * (modelData.comisionGNV / 100);
                const sparePartsRevenue = addedUnits * 50000 * (modelData.margenRefacciones / 100);
                const marketplaceRevenue = modelData.unitsPerYear.slice(0, year+1)
                    .reduce((sum, units) => sum + units * 5000, 0) * (modelData.marketplace / 100);
                const totalRevenue = vanSales + interestRevenue + gnvCommissions + sparePartsRevenue + marketplaceRevenue;
                
                // CALCULAR GASTOS (NIIF 9)
                const opex = totalRevenue * modelData.opexRate;
                const effectiveMorosidad = modelData.proteccionRodando ? 
                    modelData.tasaMorosidad * 0.5 : modelData.tasaMorosidad;
                const provisions = interestRevenue * (effectiveMorosidad / 100);
                
                // DEPRECIACIÓN (NIIF 16)
                const fixedAssets = calculateFixedAssets(year);
                const depreciation = fixedAssets / modelData.depreciationYears;
                accumulatedDepreciation += depreciation;
                
                // VENTURE DEBT (mantenemos constante)
                const ventureDebt = modelData.seriesA * (modelData.ventureDebtPct / 100);
                const interestExpense = ventureDebt * (modelData.ventureDebtRate / 100);
                
                // EBITDA CORRECTO (sin costos de vagonetas)
                const ebitda = totalRevenue - opex - provisions;
                const netIncome = ebitda - depreciation - interestExpense;
                accumulatedEarnings += netIncome;
                
                // FLUJO DE EFECTIVO
                const operatingCash = netIncome + depreciation + provisions;
                const investingCash = -(addedUnits * modelData.vanCost);
                const financingCash = year === 0 ? modelData.seriesA : 0;
                const netCash = operatingCash + investingCash + financingCash;
                cash += netCash;
                
                // BALANCE GENERAL
                const receivables = calculateReceivables(year);
                const fixedAssetsNet = fixedAssets - accumulatedDepreciation;
                const totalAssets = cash + receivables + fixedAssetsNet;
                const debt = ventureDebt; // Mantenemos constante (no se amortiza)
                const equity = modelData.seriesA + accumulatedEarnings;
                const totalLiabilitiesEquity = debt + equity;
                
                // VALIDACIÓN CONTABLE
                const balanceCheck = Math.abs(totalAssets - totalLiabilitiesEquity) < 1000; // Tolerancia de $1,000
                if (!balanceCheck) {
                    financialResults.validation.balanceCheck = false;
                    console.error(`Balance no cuadra en año ${year+1}:`, totalAssets, totalLiabilitiesEquity);
                }
                
                // GUARDAR RESULTADOS
                financialResults.pl.push({
                    vanSales, interestRevenue, gnvCommissions, sparePartsRevenue, marketplaceRevenue, totalRevenue,
                    opex, provisions, ebitda, depreciation, interestExpense, netIncome
                });
                
                financialResults.cf.push({
                    operatingCash, investingCash, financingCash, netCash
                });
                
                financialResults.bs.push({
                    cash, receivables, fixedAssets: fixedAssetsNet, totalAssets,
                    debt, equity, totalLiabilitiesEquity
                });
                
                // Agregar flujo para TIR (excluyendo año 0 para proyección)
                if (year >= 0) cashFlows.push(netCash);
            }
            
            // CALCULAR TIR REAL
            financialResults.tir = calculateIRR(cashFlows);
        }

        // Función para crear controles de constantes
        function createConstantControls() {
            const container = document.getElementById('constants-container');
            
            const constants = [
                {id: 'opex-rate', label: 'Tasa OPEX (%)', key: 'opexRate', min: 5, max: 30, step: 1, factor: 1},
                {id: 'provision-rate', label: 'Tasa Provisiones (%)', key: 'provisionRate', min: 5, max: 20, step: 1, factor: 1},
                {id: 'depreciation-years', label: 'Años Depreciación', key: 'depreciationYears', min: 5, max: 15, step: 1},
                {id: 'lgd', label: 'LGD (%)', key: 'lgd', min: 30, max: 70, step: 1, factor: 1},
                {id: 'plazo-financiamiento', label: 'Plazo Financiamiento (meses)', key: 'plazoFinanciamiento', min: 36, max: 60, step: 6}
            ];
            
            constants.forEach(constant => {
                const control = document.createElement('div');
                control.className = 'constant-control';
                control.innerHTML = `
                    <label for="${constant.id}">${constant.label}</label>
                    <input type="range" id="${constant.id}" 
                           min="${constant.min}" max="${constant.max}" step="${constant.step}" 
                           value="${modelData[constant.key] * (constant.factor || 1)}"
                           class="input-slider mt-1">
                    <span id="${constant.id}-value">${modelData[constant.key] * (constant.factor || 1)}</span>
                `;
                container.appendChild(control);
                
                // Event listener
                document.getElementById(constant.id).addEventListener('input', function() {
                    const value = parseFloat(this.value) / (constant.factor || 1);
                    modelData[constant.key] = value;
                    document.getElementById(`${constant.id}-value`).textContent = this.value;
                    calculateFinancials();
                    updateUI();
                });
            });
        }

        // Función para crear controles de unidades
        function createUnitControls() {
            const container = document.getElementById('units-container');
            
            modelData.unitsPerYear.forEach((units, index) => {
                const control = document.createElement('div');
                control.className = 'unit-control';
                control.innerHTML = `
                    <label for="unit-year-${index+1}">Año ${index+1}</label>
                    <input type="number" id="unit-year-${index+1}" 
                           min="0" max="500" step="10" 
                           value="${units}"
                           class="border rounded p-2 w-full">
                `;
                container.appendChild(control);
                
                // Event listener
                document.getElementById(`unit-year-${index+1}`).addEventListener('change', function() {
                    modelData.unitsPerYear[index] = parseInt(this.value) || 0;
                    calculateFinancials();
                    updateUI();
                });
            });
        }

        // Inicialización mejorada
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupControls();
            createConstantControls();
            createUnitControls();
            applyScenario('base');
            calculateFinancials();
            updateUI();
            initializeCharts();
        });

        // ... (resto de funciones: setupTabs, setupControls, applyScenario, 
        // updateUI, updatePLTable, updateCashFlowTable, updateBalanceSheetTable, 
        // formatCurrency, initializeCharts, updateCharts) ...
    </script>
</body>
</html>
