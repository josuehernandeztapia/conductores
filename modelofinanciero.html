<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Interactivo: Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Finance -->
    <!-- Application Structure Plan: A two-column dashboard layout. The left column contains all user-facing interactive controls (sliders, buttons for scenarios, unit inputs) derived from the 'Dashboard' and 'Assumptions' tabs of the source report. This empowers the user to manipulate the model's inputs easily. The right column is dedicated to outputs, dynamically displaying key metrics and visualizations that consolidate information from the P&L, Balance Sheet, and Cash Flow statements. This structure creates a clear cause-and-effect user flow: adjust on the left, see the impact on the right. This is more intuitive and engaging than navigating multiple spreadsheet tabs. -->
    <!-- Visualization & Content Choices: Key metrics are shown as prominent 'cards' for immediate feedback. Key financial trends (Revenue vs. EBITDA, Net Income, Cash Flow, Capital Structure) are visualized using Chart.js line and bar charts for easy interpretation over the 5-year period. A dedicated 'Validation' section uses icons to clearly communicate the model's health. This combination of cards, charts, and status icons translates the dense spreadsheet data into an easily digestible, at-a-glance dashboard, fulfilling the goal of user understanding. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4;
            color: #333333;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        .metric-card {
            background-color: #FFFFFF;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        .slider-value {
            font-weight: 500;
            color: #059669;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #D1D5DB;
            border-radius: 9999px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #059669;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #FFFFFF;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #059669;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #FFFFFF;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #059669;
            color: white;
        }
        .btn-primary:hover {
            background-color: #047857;
        }
        .btn-secondary {
            background-color: #E5E7EB;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #D1D5DB;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Modelo Interactivo: Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Simulador financiero para el modelo de negocio de financiamiento de vagonetas.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna de Controles -->
            <aside class="lg:col-span-1 space-y-8">
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Escenarios Predefinidos</h2>
                    <p class="text-sm text-gray-600 mb-4">Selecciona un escenario para cargar un conjunto de supuestos y ver su impacto.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <button id="btn-base" class="btn btn-secondary">Base</button>
                        <button id="btn-optimist" class="btn btn-secondary">Optimista</button>
                        <button id="btn-conservative" class="btn btn-secondary">Conservador</button>
                    </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Controles Principales</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="tasaInteres" class="slider-label">Tasa de Interés Anual <span id="tasaInteresValue" class="slider-value"></span></label>
                            <input type="range" id="tasaInteres" min="23.9" max="26.9" step="0.1" class="w-full">
                        </div>
                        <div>
                            <label for="tasaMorosidad" class="slider-label">Tasa de Morosidad <span id="tasaMorosidadValue" class="slider-value"></span></label>
                            <input type="range" id="tasaMorosidad" min="4" max="15" step="0.5" class="w-full">
                        </div>
                        <div>
                           <label for="margenVagoneta" class="slider-label">Margen por Vagoneta <span id="margenVagonetaValue" class="slider-value"></span></label>
                           <input type="range" id="margenVagoneta" min="88000" max="118000" step="1000" class="w-full">
                        </div>
                        <div>
                           <label for="ventureDebt" class="slider-label">% Venture Debt <span id="ventureDebtValue" class="slider-value"></span></label>
                           <input type="range" id="ventureDebt" min="50" max="100" step="5" class="w-full">
                        </div>
                    </div>
                </div>
                
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Unidades Financiadas por Año</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label for="unidades1">Año 1:</label>
                            <input type="number" id="unidades1" class="w-24 text-right p-1 border rounded">
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="unidades2">Año 2:</label>
                            <input type="number" id="unidades2" class="w-24 text-right p-1 border rounded">
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="unidades3">Año 3:</label>
                            <input type="number" id="unidades3" class="w-24 text-right p-1 border rounded">
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="unidades4">Año 4:</label>
                            <input type="number" id="unidades4" class="w-24 text-right p-1 border rounded">
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="unidades5">Año 5:</label>
                            <input type="number" id="unidades5" class="w-24 text-right p-1 border rounded">
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Columna de Resultados -->
            <section class="lg:col-span-2 space-y-8">
                <div>
                    <h2 class="text-2xl font-bold mb-4">Métricas Clave</h2>
                    <p class="text-base text-gray-600 mb-4">Estos son los resultados principales del modelo basados en los controles actuales. Se actualizan en tiempo real.</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="metric-card">
                            <h3 class="text-sm font-medium text-gray-500">EBITDA Año 5</h3>
                            <p id="metricEbitda" class="text-2xl font-bold mt-1"></p>
                        </div>
                        <div class="metric-card">
                            <h3 class="text-sm font-medium text-gray-500">TIR Proyectada</h3>
                            <p id="metricTir" class="text-2xl font-bold mt-1"></p>
                        </div>
                        <div class="metric-card">
                            <h3 class="text-sm font-medium text-gray-500">Patrimonio Año 5</h3>
                            <p id="metricPatrimonio" class="text-2xl font-bold mt-1"></p>
                        </div>
                        <div class="metric-card">
                            <h3 class="text-sm font-medium text-gray-500">Estado del Balance</h3>
                            <p id="metricBalance" class="text-2xl font-bold mt-1 flex items-center"></p>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold mb-4">Proyecciones Financieras (5 Años)</h2>
                    <p class="text-base text-gray-600 mb-4">Visualiza la evolución de los componentes financieros clave a lo largo del tiempo.</p>
                    <div class="space-y-8">
                        <div class="p-6 bg-white rounded-xl shadow-lg">
                           <h3 class="font-bold mb-2">Ingresos y EBITDA</h3>
                           <div class="chart-container"><canvas id="ingresosChart"></canvas></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="p-6 bg-white rounded-xl shadow-lg">
                               <h3 class="font-bold mb-2">Utilidad Neta</h3>
                               <div class="chart-container" style="height: 250px;"><canvas id="utilidadChart"></canvas></div>
                            </div>
                            <div class="p-6 bg-white rounded-xl shadow-lg">
                               <h3 class="font-bold mb-2">Flujo de Efectivo Neto</h3>
                               <div class="chart-container" style="height: 250px;"><canvas id="flujoChart"></canvas></div>
                            </div>
                        </div>
                         <div class="p-6 bg-white rounded-xl shadow-lg">
                           <h3 class="font-bold mb-2">Estructura de Capital: Patrimonio vs. Deuda</h3>
                           <div class="chart-container"><canvas id="capitalChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold mb-4">Salud y Validación del Modelo</h2>
                    <p class="text-base text-gray-600 mb-4">Estos controles verifican la coherencia contable y la viabilidad del modelo.</p>
                    <div class="p-6 bg-white rounded-xl shadow-lg grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div id="valBalance" class="p-3 rounded-lg">
                            <span class="text-lg font-bold">Balance Cuadrado</span>
                        </div>
                        <div id="valEbitda" class="p-3 rounded-lg">
                            <span class="text-lg font-bold">EBITDA Positivo</span>
                        </div>
                        <div id="valPatrimonio" class="p-3 rounded-lg">
                            <span class="text-lg font-bold">Patrimonio Positivo</span>
                        </div>
                        <div id="valTir" class="p-3 rounded-lg">
                            <span class="text-lg font-bold">TIR > 15%</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const controls = {
                tasaInteres: document.getElementById('tasaInteres'),
                tasaMorosidad: document.getElementById('tasaMorosidad'),
                margenVagoneta: document.getElementById('margenVagoneta'),
                ventureDebt: document.getElementById('ventureDebt'),
                unidades: [
                    document.getElementById('unidades1'),
                    document.getElementById('unidades2'),
                    document.getElementById('unidades3'),
                    document.getElementById('unidades4'),
                    document.getElementById('unidades5'),
                ]
            };

            const values = {
                tasaInteres: document.getElementById('tasaInteresValue'),
                tasaMorosidad: document.getElementById('tasaMorosidadValue'),
                margenVagoneta: document.getElementById('margenVagonetaValue'),
                ventureDebt: document.getElementById('ventureDebtValue'),
            };

            const metrics = {
                ebitda: document.getElementById('metricEbitda'),
                tir: document.getElementById('metricTir'),
                patrimonio: document.getElementById('metricPatrimonio'),
                balance: document.getElementById('metricBalance'),
            };
            
            const validations = {
                balance: document.getElementById('valBalance'),
                ebitda: document.getElementById('valEbitda'),
                patrimonio: document.getElementById('valPatrimonio'),
                tir: document.getElementById('valTir'),
            };

            const scenarioButtons = {
                base: document.getElementById('btn-base'),
                optimist: document.getElementById('btn-optimist'),
                conservative: document.getElementById('btn-conservative'),
            };

            let charts = {};
            const years = ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'];

            const formatCurrency = (value) => {
                if (Math.abs(value) >= 1_000_000) {
                    return `$${(value / 1_000_000).toFixed(1)}M`;
                }
                 if (Math.abs(value) >= 1_000) {
                    return `$${(value / 1_000).toFixed(0)}k`;
                }
                return `$${value.toFixed(0)}`;
            };
            
            const formatPercentage = (value) => `${value.toFixed(1)}%`;

            function createCharts() {
                const defaultOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) { return formatCurrency(value); }
                            }
                        }
                    }
                };

                charts.ingresos = new Chart(document.getElementById('ingresosChart'), {
                    type: 'line',
                    data: { labels: years, datasets: [
                        { label: 'Total Ingresos', data: [], borderColor: '#059669', tension: 0.1, fill: false },
                        { label: 'EBITDA', data: [], borderColor: '#F59E0B', tension: 0.1, fill: false }
                    ]},
                    options: defaultOptions
                });
                
                charts.utilidad = new Chart(document.getElementById('utilidadChart'), {
                    type: 'bar',
                    data: { labels: years, datasets: [{ label: 'Utilidad Neta', data: [], backgroundColor: '#3B82F6' }]},
                    options: defaultOptions
                });

                charts.flujo = new Chart(document.getElementById('flujoChart'), {
                    type: 'bar',
                    data: { labels: years, datasets: [{ label: 'Flujo Neto de Efectivo', data: [], backgroundColor: '#8B5CF6' }]},
                    options: defaultOptions
                });

                charts.capital = new Chart(document.getElementById('capitalChart'), {
                    type: 'line',
                    data: { labels: years, datasets: [
                        { label: 'Patrimonio Total', data: [], borderColor: '#10B981', tension: 0.1, fill: false },
                        { label: 'Deuda Total (Venture Debt)', data: [], borderColor: '#EF4444', tension: 0.1, fill: false }
                    ]},
                    options: defaultOptions
                });
            }

            function setScenario(scenario) {
                const scenarios = {
                    base: {
                        tasaInteres: 25.5, tasaMorosidad: 8, margenVagoneta: 88000, ventureDebt: 100,
                        unidades: [35, 70, 100, 150, 200]
                    },
                    optimist: {
                        tasaInteres: 26.9, tasaMorosidad: 5, margenVagoneta: 100000, ventureDebt: 75,
                        unidades: [40, 80, 120, 180, 250]
                    },
                    conservative: {
                        tasaInteres: 23.9, tasaMorosidad: 12, margenVagoneta: 75000, ventureDebt: 100,
                        unidades: [30, 60, 80, 120, 150]
                    }
                };
                const s = scenarios[scenario];
                controls.tasaInteres.value = s.tasaInteres;
                controls.tasaMorosidad.value = s.tasaMorosidad;
                controls.margenVagoneta.value = s.margenVagoneta;
                controls.ventureDebt.value = s.ventureDebt;
                s.unidades.forEach((u, i) => controls.unidades[i].value = u);
                
                runFullUpdate();
            }

            function runFullUpdate() {
                updateSliderValues();
                const modelResult = calculateModel();
                updateUI(modelResult);
            }
            
            function updateSliderValues() {
                values.tasaInteres.textContent = `${parseFloat(controls.tasaInteres.value).toFixed(1)}%`;
                values.tasaMorosidad.textContent = `${parseFloat(controls.tasaMorosidad.value).toFixed(1)}%`;
                values.margenVagoneta.textContent = formatCurrency(parseFloat(controls.margenVagoneta.value));
                values.ventureDebt.textContent = `${parseFloat(controls.ventureDebt.value).toFixed(0)}%`;
            }

            function calculateIRR(cashflows) {
                const min_rate = -0.99, max_rate = 1.0;
                let guess = 0.1;
                const max_iter = 50, precision = 1e-7;

                for (let i = 0; i < max_iter; i++) {
                    let npv = 0;
                    let d_npv = 0;
                    for (let t = 0; t < cashflows.length; t++) {
                        npv += cashflows[t] / Math.pow(1 + guess, t);
                        d_npv -= t * cashflows[t] / Math.pow(1 + guess, t + 1);
                    }
                    if (Math.abs(npv) < precision) return guess;
                    if (d_npv === 0) break;
                    let new_guess = guess - npv / d_npv;
                    if (new_guess <= min_rate || new_guess >= max_rate) break;
                    guess = new_guess;
                }
                return NaN;
            }

            function calculateModel() {
                const p = {
                    serieACapital: 45000000,
                    costoVagoneta: 641000,
                    opexRate: 0.15,
                    depreciacionAnos: 10,
                    tasaInteres: parseFloat(controls.tasaInteres.value) / 100,
                    tasaMorosidad: parseFloat(controls.tasaMorosidad.value) / 100,
                    margenVagoneta: parseFloat(controls.margenVagoneta.value),
                    ventureDebtPct: parseFloat(controls.ventureDebt.value) / 100,
                    tasaVentureDebt: 0.12, // Asumido constante
                    comisionGNV: 0.08, // Asumido constante
                    margenRefacciones: 0.25, // Asumido constante
                    proteccionActiva: true, // Asumido
                    unidades: controls.unidades.map(u => parseInt(u.value) || 0)
                };

                let pl = { ingresosIntereses: [], margenVagoneta: [], comisionesGNV: [], ingresosRefacciones: [], totalIngresos: [], gastosOperativos: [], depreciacion: [], provisiones: [], ebitda: [], interesesDeuda: [], utilidadNeta: [] };
                let bs = { efectivo: [], ctasPorCobrar: [], vagonetasCosto: [], depAcumulada: [], vagonetasNetas: [], totalActivos: [], ventureDebt: [], provisionesAcum: [], totalPasivos: [], capitalSocial: [], utilidadesRetenidas: [], totalCapital: [], totalPasivoCapital: [], validacion: [] };
                let cf = { utilidadNeta: [], depreciacion: [], deltaCtasPorCobrar: [], flujoOperativo: [], capex: [], flujoInversion: [], serieA: [], ventureDebtFlujo: [], servicioDeuda: [], flujoFinanciero: [], flujoNeto: [] };
                
                let flotaTotalAcumulada = 0;
                let costoTotalAcumulado = 0;

                for (let i = 0; i < 5; i++) {
                    const unidadesAnio = p.unidades[i];
                    flotaTotalAcumulada += unidadesAnio;
                    const capexAnual = unidadesAnio * p.costoVagoneta;
                    costoTotalAcumulado += capexAnual;
                    
                    const saldoDeudaAnterior = i > 0 ? bs.ventureDebt[i-1] : 0;
                    
                    pl.ingresosIntereses[i] = p.tasaInteres * (saldoDeudaAnterior * 0.8);
                    pl.margenVagoneta[i] = p.margenVagoneta * unidadesAnio;
                    pl.comisionesGNV[i] = pl.ingresosIntereses[i] * p.comisionGNV;
                    pl.ingresosRefacciones[i] = flotaTotalAcumulada * p.costoVagoneta * p.margenRefacciones * 0.1; // simplified
                    pl.totalIngresos[i] = pl.ingresosIntereses[i] + pl.margenVagoneta[i] + pl.comisionesGNV[i] + pl.ingresosRefacciones[i];
                    pl.gastosOperativos[i] = pl.totalIngresos[i] * p.opexRate;
                    pl.depreciacion[i] = capexAnual / p.depreciacionAnos;
                    pl.provisiones[i] = pl.ingresosIntereses[i] * p.tasaMorosidad * (p.proteccionActiva ? 0.5 : 1);
                    pl.ebitda[i] = pl.totalIngresos[i] - pl.gastosOperativos[i]; // EBITDA a menudo excluye provisiones, pero seguimos P&L
                    
                    const ventureDebtMonto = i == 0 ? capexAnual * p.ventureDebtPct : 0; // Solo en año 1 se toma
                    bs.ventureDebt[i] = saldoDeudaAnterior + ventureDebtMonto;
                    
                    pl.interesesDeuda[i] = bs.ventureDebt[i] * p.tasaVentureDebt;
                    
                    // Recalcular EBITDA como Ingresos - Gastos Op
                    pl.ebitda[i] = pl.totalIngresos[i] - pl.gastosOperativos[i];

                    pl.utilidadNeta[i] = pl.ebitda[i] - pl.depreciacion[i] - pl.provisiones[i] - pl.interesesDeuda[i];

                    bs.ctasPorCobrar[i] = pl.ingresosIntereses[i] > 0 ? pl.ingresosIntereses[i] / p.tasaInteres : 0;
                    bs.vagonetasCosto[i] = (i > 0 ? bs.vagonetasCosto[i-1] : 0) + capexAnual;
                    bs.depAcumulada[i] = (i > 0 ? bs.depAcumulada[i-1] : 0) + pl.depreciacion[i];
                    bs.vagonetasNetas[i] = bs.vagonetasCosto[i] - bs.depAcumulada[i];
                   
                    bs.provisionesAcum[i] = (i > 0 ? bs.provisionesAcum[i-1] : 0) + pl.provisiones[i];
                    bs.totalPasivos[i] = bs.ventureDebt[i] + bs.provisionesAcum[i];

                    bs.capitalSocial[i] = p.serieACapital;
                    bs.utilidadesRetenidas[i] = (i > 0 ? bs.utilidadesRetenidas[i-1] : 0) + pl.utilidadNeta[i];
                    bs.totalCapital[i] = bs.capitalSocial[i] + bs.utilidadesRetenidas[i];

                    cf.utilidadNeta[i] = pl.utilidadNeta[i];
                    cf.depreciacion[i] = pl.depreciacion[i];
                    cf.deltaCtasPorCobrar[i] = - (bs.ctasPorCobrar[i] - (i > 0 ? bs.ctasPorCobrar[i-1] : 0));
                    cf.flujoOperativo[i] = cf.utilidadNeta[i] + cf.depreciacion[i] + cf.deltaCtasPorCobrar[i];
                    cf.capex[i] = -capexAnual;
                    cf.flujoInversion[i] = cf.capex[i];
                    cf.serieA[i] = i == 0 ? p.serieACapital : 0;
                    cf.ventureDebtFlujo[i] = ventureDebtMonto;
                    cf.servicioDeuda[i] = 0; // Simplified, principal payment not modeled
                    cf.flujoFinanciero[i] = cf.serieA[i] + cf.ventureDebtFlujo[i] + cf.servicioDeuda[i];
                    cf.flujoNeto[i] = cf.flujoOperativo[i] + cf.flujoInversion[i] + cf.flujoFinanciero[i];

                    const efectivoAnterior = i > 0 ? bs.efectivo[i-1] : 0;
                    bs.efectivo[i] = efectivoAnterior + cf.flujoNeto[i];

                    bs.totalActivos[i] = bs.efectivo[i] + bs.ctasPorCobrar[i] + bs.vagonetasNetas[i];
                    bs.totalPasivoCapital[i] = bs.totalPasivos[i] + bs.totalCapital[i];
                    bs.validacion[i] = Math.abs(bs.totalActivos[i] - bs.totalPasivoCapital[i]) < 1;
                }

                const tirFlows = [ -p.serieACapital, ...cf.flujoNeto];
                const tir = calculateIRR(cf.flujoNeto); // IRR on yearly net flows

                return { pl, bs, cf, tir };
            }

            function updateUI(result) {
                const { pl, bs, cf, tir } = result;
                
                metrics.ebitda.textContent = formatCurrency(pl.ebitda[4]);
                metrics.tir.textContent = isNaN(tir) ? "N/A" : formatPercentage(tir * 100);
                metrics.patrimonio.textContent = formatCurrency(bs.totalCapital[4]);
                metrics.balance.innerHTML = bs.validacion[4] ? `<span class="text-green-500">✅</span><span class="ml-2">Balanceado</span>` : `<span class="text-red-500">❌</span><span class="ml-2">Error</span>`;

                const isOkClass = 'bg-green-100 text-green-800';
                const isNokClass = 'bg-red-100 text-red-800';

                validations.balance.className = bs.validacion[4] ? isOkClass : isNokClass;
                validations.ebitda.className = pl.ebitda[4] > 0 ? isOkClass : isNokClass;
                validations.patrimonio.className = bs.totalCapital[4] > 0 ? isOkClass : isNokClass;
                validations.tir.className = tir > 0.15 ? isOkClass : isNokClass;
                
                charts.ingresos.data.datasets[0].data = pl.totalIngresos;
                charts.ingresos.data.datasets[1].data = pl.ebitda;
                charts.ingresos.update();

                charts.utilidad.data.datasets[0].data = pl.utilidadNeta;
                charts.utilidad.update();

                charts.flujo.data.datasets[0].data = cf.flujoNeto;
                charts.flujo.update();

                charts.capital.data.datasets[0].data = bs.totalCapital;
                charts.capital.data.datasets[1].data = bs.ventureDebt;
                charts.capital.update();
            }
            
            Object.values(controls).flat().forEach(control => {
                control.addEventListener('input', runFullUpdate);
            });

            scenarioButtons.base.addEventListener('click', () => setScenario('base'));
            scenarioButtons.optimist.addEventListener('click', () => setScenario('optimist'));
            scenarioButtons.conservative.addEventListener('click', () => setScenario('conservative'));

            createCharts();
            setScenario('base');
        });
    </script>
</body>
</html>
