<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo - Rodando a Gas | NIIF Compliant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8f9fa; 
        }
        .tab-button { 
            transition: all 0.3s ease; 
            cursor: pointer;
        }
        .tab-button.active { 
            border-color: #2563eb; 
            color: #2563eb; 
            background-color: #eff6ff; 
        }
        .tab-button:not(.active):hover { 
            background-color: #f3f4f6; 
        }
        .content-section { 
            display: none; 
        }
        .content-section.active { 
            display: block; 
        }
        .card { 
            background-color: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem;
        }
        .input-slider { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 100%; 
            height: 8px; 
            background: #e5e7eb; 
            border-radius: 9999px; 
            outline: none; 
            transition: opacity .2s; 
        }
        .input-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 20px; 
            height: 20px; 
            background: #2563eb; 
            border-radius: 9999px; 
            cursor: pointer; 
        }
        .input-slider::-moz-range-thumb { 
            width: 20px; 
            height: 20px; 
            background: #2563eb; 
            border-radius: 9999px; 
            cursor: pointer; 
            border: none;
        }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            margin-left: auto; 
            margin-right: auto; 
            height: 350px; 
            max-height: 50vh; 
        }
        .financial-table {
            width: 100%;
            border-collapse: collapse;
        }
        .financial-table th,
        .financial-table td {
            padding: 0.75rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        .financial-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .financial-table td:first-child,
        .financial-table th:first-child {
            text-align: left;
        }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid #2563eb;
        }
        .balance-valid {
            color: #16a34a;
            font-weight: bold;
        }
        .balance-invalid {
            color: #dc2626;
            font-weight: bold;
        }
        .van-unit {
            background-color: #f0fdf4;
            border-left: 4px solid #16a34a;
        }
        .constant-control {
            margin-bottom: 12px;
        }
        .constant-control label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .unit-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .unit-control {
            display: flex;
            flex-direction: column;
        }
        .unit-control label {
            font-weight: 500;
            margin-bottom: 4px;
        }
        .unit-control input {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            width: 100%;
        }
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1f2937;
            color: #f3f4f6;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .debug-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #2563eb;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1001;
        }
        .niif-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .niif-title {
            color: #0c4a6e;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Debug Panel DevOps -->
    <button id="debug-toggle" class="debug-toggle">🔧 DevOps</button>
    <div id="debug-panel" class="debug-panel">
        <div id="debug-content"></div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero Interactivo - NIIF Compliant</h1>
            <p class="text-lg text-gray-600">Rodando a Gas: Resiliencia como Servicio</p>
            <p class="text-sm text-gray-500 mt-2">✅ NIIF 15 & NIIF 9 | ✅ Cronogramas de Amortización | ✅ DevOps Verified</p>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA Año 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
            <div class="metric-card van-unit p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas Acumuladas</div>
                <div class="text-2xl font-bold" id="vagonetas-total">0</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Deuda Residual Año 5</div>
                <div class="text-2xl font-bold" id="deuda-residual">$0M MXN</div>
            </div>
        </div>

        <main>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">🚀 Panel de Control</button>
                    <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📊 Estados Financieros</button>
                    <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📋 Cumplimiento NIIF</button>
                    <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📈 Análisis Gráfico</button>
                    <button id="tab-resumen" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📖 Resumen Estratégico</button>
                </nav>
            </div>

            <!-- Panel de Control -->
            <div id="content-control" class="content-section active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Crédito y Riesgo</h4>
                        <p class="text-xs text-gray-500 mb-4">Ajuste las condiciones del financiamiento y las provisiones por riesgo (NIIF 9).</p>
                        <div class="space-y-4">
                            <div>
                                <label for="tasa-interes" class="flex justify-between text-sm font-medium text-gray-700">Tasa de Interés Anual <span id="tasa-interes-valor" class="font-bold text-indigo-600">25.5%</span></label>
                                <input type="range" id="tasa-interes" min="23.9" max="26.9" step="0.1" value="25.5" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="tasa-morosidad" class="flex justify-between text-sm font-medium text-gray-700">Tasa de Morosidad <span id="tasa-morosidad-valor" class="font-bold text-indigo-600">8%</span></label>
                                <input type="range" id="tasa-morosidad" min="4" max="15" step="0.5" value="8" class="input-slider mt-1">
                            </div>
                            <div class="flex items-center">
                                <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Incluir "Protección Rodando"</label>
                                <span class="ml-2 text-xs text-green-600">(Reduce morosidad hasta 50%)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Operaciones y Márgenes</h4>
                        <p class="text-xs text-gray-500 mb-4">Configure los márgenes de ganancia para las líneas de ingreso.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="margen-vagoneta" class="flex justify-between text-sm font-medium text-gray-700">Margen por Vagoneta <span id="margen-vagoneta-valor" class="font-bold text-indigo-600">$88,000</span></label>
                                <input type="range" id="margen-vagoneta" min="70000" max="120000" step="2000" value="88000" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="comision-gnv" class="flex justify-between text-sm font-medium text-gray-700">Comisión GNV <span id="comision-gnv-valor" class="font-bold text-indigo-600">8%</span></label>
                                <input type="range" id="comision-gnv" min="6" max="12" step="0.5" value="8" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="margen-refacciones" class="flex justify-between text-sm font-medium text-gray-700">Margen Refacciones <span id="margen-refacciones-valor" class="font-bold text-indigo-600">25%</span></label>
                                <input type="range" id="margen-refacciones" min="20" max="40" step="1" value="25" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="marketplace" class="flex justify-between text-sm font-medium text-gray-700">Market Place <span id="marketplace-valor" class="font-bold text-indigo-600">1%</span></label>
                                <input type="range" id="marketplace" min="0.5" max="3" step="0.1" value="1" class="input-slider mt-1">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Estructura de Capital</h4>
                        <p class="text-xs text-gray-500 mb-4">Simule el impacto de la financiación con venture debt vs. equity.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="venture-debt-pct" class="flex justify-between text-sm font-medium text-gray-700">% Venture Debt <span id="venture-debt-pct-valor" class="font-bold text-indigo-600">70%</span></label>
                                <input type="range" id="venture-debt-pct" min="50" max="100" step="5" value="70" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="venture-debt-rate" class="flex justify-between text-sm font-medium text-gray-700">Tasa Venture Debt <span id="venture-debt-rate-valor" class="font-bold text-indigo-600">12%</span></label>
                                <input type="range" id="venture-debt-rate" min="10" max="16" step="0.5" value="12" class="input-slider mt-1">
                            </div>
                            <div class="van-unit p-3 rounded-md">
                                <h4 class="font-semibold text-green-800 mb-1">Distribución de Vagonetas</h4>
                                <p>Año 1: <span id="units-year1">35</span> | Año 2: <span id="units-year2">70</span> | Año 3: <span id="units-year3">100</span></p>
                                <p>Año 4: <span id="units-year4">150</span> | Año 5: <span id="units-year5">200</span></p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-md">
                                <p class="text-xs text-blue-700"><strong>Estrategia RAG:</strong> Usar venture debt para flota, preservar equity para tecnología e IA.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Constantes del Modelo -->
                    <div class="card lg:col-span-3">
                        <h3 class="text-xl font-semibold mb-4">Constantes del Modelo</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4" id="constants-container">
                            <!-- Generado dinámicamente -->
                        </div>
                    </div>

                    <!-- Unidades por Año -->
                    <div class="card lg:col-span-3">
                        <h3 class="text-xl font-semibold mb-4">Unidades por Año</h3>
                        <div class="unit-controls" id="units-container">
                            <!-- Generado dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estados Financieros -->
            <div id="content-financieros" class="content-section">
                <div class="space-y-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>Año 1</th>
                                        <th>Año 2</th>
                                        <th>Año 3</th>
                                        <th>Año 4</th>
                                        <th>Año 5</th>
                                    </tr>
                                </thead>
                                <tbody id="pl-table-body">
                                    <!-- Generado dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>Año 1</th>
                                        <th>Año 2</th>
                                        <th>Año 3</th>
                                        <th>Año 4</th>
                                        <th>Año 5</th>
                                    </tr>
                                </thead>
                                <tbody id="cf-table-body">
                                    <!-- Generado dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>Año 1</th>
                                        <th>Año 2</th>
                                        <th>Año 3</th>
                                        <th>Año 4</th>
                                        <th>Año 5</th>
                                    </tr>
                                </thead>
                                <tbody id="bs-table-body">
                                    <!-- Generado dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div id="balance-validation" class="mt-4 text-center font-semibold">
                            <!-- Validación del balance -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cumplimiento NIIF -->
            <div id="content-niif" class="content-section">
                <div class="space-y-6">
                    <!-- NIIF 15 -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos al Valor Presente</h3>
                        <div id="niif15-container">
                            <!-- Generado dinámicamente -->
                        </div>
                    </div>

                    <!-- NIIF 9 -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">NIIF 9 - Deterioro Crediticio por Etapas</h3>
                        <div id="niif9-container">
                            <!-- Generado dinámicamente -->
                        </div>
                    </div>

                    <!-- Cronogramas -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Cronogramas de Amortización</h3>
                        <div id="amortization-container">
                            <!-- Generado dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Análisis Gráfico -->
            <div id="content-graficos" class="content-section">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-2">Evolución de Ingresos y EBITDA</h4>
                        <div class="chart-container"><canvas id="ebitdaChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-2">Composición de Ingresos</h4>
                        <div class="chart-container"><canvas id="revenueMixChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-2">Análisis NIIF 9 - Distribución por Etapas</h4>
                        <div class="chart-container"><canvas id="niif9Chart"></canvas></div>
                    </div>
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-2">Evolución de Capital y Deuda</h4>
                        <div class="chart-container"><canvas id="capitalStructureChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Resumen Estratégico -->
            <div id="content-resumen" class="content-section">
                <div class="space-y-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">🎯 Propuesta de Valor: "Resiliencia como Servicio"</h3>
                        <div class="space-y-4">
                            <p class="text-gray-700">Rodando a Gas redefine el financiamiento de activos como un <strong>"Ecosistema de Resiliencia Operativa"</strong>, diseñado para asegurar la continuidad y rentabilidad del negocio del operador a largo plazo.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-blue-900">🧠 HASE</h4>
                                    <p class="text-sm text-blue-700">Hyper-Adaptive Scoring Engine: Scoring dinámico y predictivo con datos propietarios</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-900">❤️ PIA</h4>
                                    <p class="text-sm text-green-700">Proactive Intervention Agent: Comunicación empática y preventiva a escala</p>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-yellow-900">🛡️ PMA</h4>
                                    <p class="text-sm text-yellow-700">Predictive Maintenance Advisor: Mantenimiento predictivo y nuevos ingresos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">📊 Métricas Clave del Modelo</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Rentabilidad por Unidad</h4>
                                <ul class="space-y-2 text-sm">
                                    <li>💰 <strong>Costo Vagoneta:</strong> $641,000 MXN</li>
                                    <li>💲 <strong>Precio Financiado:</strong> $729,000 MXN</li>
                                    <li>📈 <strong>Margen Bruto:</strong> $88,000 MXN</li>
                                    <li>⏱️ <strong>Payback:</strong> ~36 meses</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-lg mb-2">Proyecciones Financieras</h4>
                                <ul class="space-y-2 text-sm">
                                    <li>🎯 <strong>TIR Objetivo:</strong> ≥22.8%</li>
                                    <li>🚛 <strong>Meta Año 5:</strong> 555 vagonetas</li>
                                    <li>💹 <strong>OPEX Target:</strong> 15% de ingresos</li>
                                    <li>🛡️ <strong>Provisiones:</strong> Modelo 3 etapas NIIF 9</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // ===== SISTEMA DevOps DE DEBUG Y LOGGING =====
        class DevOpsLogger {
            constructor() {
                this.logs = [];
                this.errors = [];
                this.maxLogs = 100;
                this.startTime = Date.now();
            }
            
            log(message, type = 'info', data = null) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp,
                    type: type.toUpperCase(),
                    message,
                    data,
                    elapsed: Date.now() - this.startTime
                };
                
                this.logs.unshift(logEntry);
                if (this.logs.length > this.maxLogs) this.logs.pop();
                
                if (type === 'error') {
                    this.errors.push(logEntry);
                    console.error(`[${timestamp}] ERROR: ${message}`, data);
                } else {
                    console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`, data);
                }
                
                this.updateDebugPanel();
            }
            
            error(message, data = null) { this.log(message, 'error', data); }
            warn(message, data = null) { this.log(message, 'warn', data); }
            success(message, data = null) { this.log(message, 'success', data); }
            performance(message, data = null) { this.log(message, 'perf', data); }
            
            updateDebugPanel() {
                const panel = document.getElementById('debug-content');
                if (panel) {
                    const recentLogs = this.logs.slice(0, 20);
                    panel.innerHTML = recentLogs.map(log => 
                        `<div style="color: ${this.getLogColor(log.type)}; margin-bottom: 4px;">
                            [${log.elapsed}ms] ${log.type}: ${log.message}
                            ${log.data ? `<br><small>${JSON.stringify(log.data).slice(0, 100)}</small>` : ''}
                        </div>`
                    ).join('');
                }
            }
            
            getLogColor(type) {
                const colors = {
                    'ERROR': '#ef4444',
                    'WARN': '#f59e0b',
                    'SUCCESS': '#10b981',
                    'PERF': '#8b5cf6',
                    'INFO': '#3b82f6'
                };
                return colors[type] || '#6b7280';
            }
            
            getStats() {
                return {
                    totalLogs: this.logs.length,
                    errors: this.errors.length,
                    uptime: Date.now() - this.startTime,
                    performance: this.logs.filter(l => l.type === 'PERF').slice(0, 5)
                };
            }
        }
        
        const devOps = new DevOpsLogger();

        // ===== MÓDULOS NIIF =====
        
        // NIIF 15: Reconocimiento de Ingresos al Valor Presente
        class NIIF15Calculator {
            constructor(tasaDescuentoDefault = 25.5) {
                this.tasaDescuento = tasaDescuentoDefault / 100;
                devOps.log('NIIF15Calculator inicializado', 'info', { tasa: tasaDescuentoDefault });
            }
            
            calcularValorPresente(flujos, tasaDescuento = null) {
                try {
                    const tasa = tasaDescuento || this.tasaDescuento;
                    let valorPresente = 0;
                    
                    flujos.forEach((flujo, periodo) => {
                        valorPresente += flujo / Math.pow(1 + tasa, periodo);
                    });
                    
                    devOps.performance('NIIF15 Valor Presente calculado', { valorPresente, flujos: flujos.length });
                    return valorPresente;
                } catch (error) {
                    devOps.error('Error en calcularValorPresente', error);
                    return 0;
                }
            }
            
            reconocerIngresosPorIntereses(carteraVigente, tasaInteres, plazoPromedio) {
                try {
                    const flujosMensuales = [];
                    const pagoMensual = carteraVigente * (tasaInteres / 12) / (1 - Math.pow(1 + tasaInteres / 12, -plazoPromedio));
                    
                    for (let mes = 1; mes <= plazoPromedio; mes++) {
                        flujosMensuales.push(pagoMensual);
                    }
                    
                    const valorNominal = flujosMensuales.reduce((sum, flujo) => sum + flujo, 0);
                    const valorPresente = this.calcularValorPresente(flujosMensuales, tasaInteres);
                    
                    return {
                        valorNominal,
                        valorPresente,
                        ajusteDescuento: valorNominal - valorPresente,
                        flujosMensuales
                    };
                } catch (error) {
                    devOps.error('Error en reconocerIngresosPorIntereses', error);
                    return { valorNominal: 0, valorPresente: 0, ajusteDescuento: 0, flujosMensuales: [] };
                }
            }
        }

        // NIIF 9: Modelo de Deterioro Crediticio de 3 Etapas
        class NIIF9Calculator {
            constructor() {
                this.etapas = {
                    etapa1: { provision: 0.08, descripcion: "12 meses - Riesgo normal" },
                    etapa2: { provision: 0.15, descripcion: "Vida completa - Incremento significativo" },
                    etapa3: { provision: 0.45, descripcion: "Incumplimiento - Evidencia objetiva" }
                };
                devOps.log('NIIF9Calculator inicializado', 'info', this.etapas);
            }
            
            determinarEtapaCredito(diasMora, scoreHASE, scoreInicial) {
                if (diasMora > 90 || scoreHASE < 300) {
                    return 'etapa3';
                } else if (diasMora > 30 || (scoreHASE < scoreInicial * 0.8)) {
                    return 'etapa2';
                } else {
                    return 'etapa1';
                }
            }
            
            calcularProvisionesDetalladas(cartera, year) {
                try {
                    const distribucionCartera = this.simularDistribucionRiesgo(cartera, year);
                    
                    const provisiones = {
                        etapa1: distribucionCartera.etapa1 * this.etapas.etapa1.provision,
                        etapa2: distribucionCartera.etapa2 * this.etapas.etapa2.provision,
                        etapa3: distribucionCartera.etapa3 * this.etapas.etapa3.provision
                    };
                    
                    const total = provisiones.etapa1 + provisiones.etapa2 + provisiones.etapa3;
                    
                    devOps.performance(`NIIF9 Provisiones Año ${year + 1}`, { total, provisiones });
                    
                    return {
                        ...provisiones,
                        total,
                        distribucion: distribucionCartera,
                        detalle: this.generarDetalleEtapas(provisiones)
                    };
                } catch (error) {
                    devOps.error('Error en calcularProvisionesDetalladas', error);
                    return { etapa1: 0, etapa2: 0, etapa3: 0, total: 0, distribucion: {}, detalle: [] };
                }
            }
            
            simularDistribucionRiesgo(cartera, year) {
                const factorMaduracion = Math.min(1, (year + 1) / 3);
                
                return {
                    etapa1: cartera * (0.85 - factorMaduracion * 0.1),
                    etapa2: cartera * (0.12 + factorMaduracion * 0.05),
                    etapa3: cartera * (0.03 + factorMaduracion * 0.05)
                };
            }
            
            generarDetalleEtapas(provisiones) {
                return Object.keys(this.etapas).map(etapa => ({
                    etapa: etapa.charAt(0).toUpperCase() + etapa.slice(1),
                    descripcion: this.etapas[etapa].descripcion,
                    tasaProvision: `${(this.etapas[etapa].provision * 100).toFixed(1)}%`,
                    montoProvision: provisiones[etapa]
                }));
            }
        }

        // Cronogramas de Amortización
        class AmortizationScheduler {
            constructor() {
                this.contratos = new Map();
                devOps.log('AmortizationScheduler inicializado', 'info');
            }
            
            generarAmortizacion(monto, plazo, tasa, fechaInicio = new Date()) {
                try {
                    const tasaMensual = tasa / 12;
                    const pagoMensual = monto * (tasaMensual * Math.pow(1 + tasaMensual, plazo)) / 
                                       (Math.pow(1 + tasaMensual, plazo) - 1);
                    
                    const cronograma = [];
                    let saldoCapital = monto;
                    let fecha = new Date(fechaInicio);
                    
                    for (let periodo = 1; periodo <= plazo; periodo++) {
                        const interesPeriodo = saldoCapital * tasaMensual;
                        const capitalPeriodo = pagoMensual - interesPeriodo;
                        saldoCapital -= capitalPeriodo;
                        
                        cronograma.push({
                            periodo,
                            fecha: new Date(fecha),
                            pagoTotal: pagoMensual,
                            capital: capitalPeriodo,
                            interes: interesPeriodo,
                            saldoCapital: Math.max(0, saldoCapital),
                            capitalAcumulado: monto - saldoCapital
                        });
                        
                        fecha.setMonth(fecha.getMonth() + 1);
                    }
                    
                    devOps.performance('Cronograma generado', { monto, plazo, periodos: cronograma.length });
                    return cronograma;
                } catch (error) {
                    devOps.error('Error generando cronograma', error);
                    return [];
                }
            }
            
            obtenerEstadoCartera(fechaCorte = new Date()) {
                const estadoCartera = {
                    totalContratos: this.contratos.size,
                    saldoTotal: 0,
                    interesesDevengados: 0,
                    capitalVencido: 0,
                    porEtapas: { etapa1: 0, etapa2: 0, etapa3: 0 }
                };
                
                this.contratos.forEach(contrato => {
                    estadoCartera.saldoTotal += contrato.estadoActual?.saldoPendiente || 0;
                    const etapa = contrato.estadoActual?.etapaNIIF9 || 'etapa1';
                    estadoCartera.porEtapas[etapa] += contrato.estadoActual?.saldoPendiente || 0;
                });
                
                return estadoCartera;
            }
        }

        // ===== ESTADO GLOBAL Y CONFIGURACIÓN =====
        let charts = {};
        let modelData = {
            // Parámetros controlados por usuario
            tasaInteres: 25.5,
            tasaMorosidad: 8,
            proteccionRodando: true,
            margenVagoneta: 88000,
            comisionGNV: 8,
            margenRefacciones: 25,
            marketplace: 1,
            ventureDebtPct: 70,
            ventureDebtRate: 12,
            
            // Constantes del modelo
            opexRate: 15,
            provisionRate: 8,
            depreciationYears: 10,
            lgd: 45,
            plazoFinanciamiento: 48,
            
            // Distribución corregida de unidades
            unitsPerYear: [35, 70, 100, 150, 200], // Total: 555 unidades
            
            // Supuestos fijos
            vanCost: 641000,
            vanPrice: 729000,
            seriesA: 45000000
        };

        let financialResults = {
            pl: [],
            cf: [],
            bs: [],
            tirProyecto: 0,
            tirCartera: 0,
            niifDetails: [],
            amortizationDetails: [],
            validation: {
                balanceCheck: true,
                niifCompliance: true,
                calculationErrors: []
            }
        };

        // ===== FUNCIONES DE VALIDACIÓN DevOps =====
        function validateInputs() {
            const errors = [];
            
            if (modelData.tasaInteres < 20 || modelData.tasaInteres > 30) {
                errors.push('Tasa de interés fuera de rango razonable (20-30%)');
            }
            
            if (modelData.unitsPerYear.some(u => u < 0 || u > 1000)) {
                errors.push('Unidades por año fuera de rango (0-1000)');
            }
            
            const totalUnits = modelData.unitsPerYear.reduce((sum, u) => sum + u, 0);
            if (totalUnits === 0) {
                errors.push('Debe haber al menos una unidad en la proyección');
            }
            
            if (errors.length > 0) {
                devOps.error('Errores de validación de inputs', errors);
                return false;
            }
            
            devOps.success('Validación de inputs exitosa');
            return true;
        }

        function validateBalance(year, activos, pasivosCapital) {
            const difference = Math.abs(activos - pasivosCapital);
            const tolerance = Math.max(1000, activos * 0.001); // 0.1% o $1,000 MXN
            
            if (difference > tolerance) {
                const error = `Año ${year + 1}: Balance no cuadra. Diferencia: $${difference.toLocaleString()} MXN`;
                financialResults.validation.calculationErrors.push(error);
                devOps.error('Error de balance', { year: year + 1, difference, tolerance });
                return false;
            }
            
            devOps.success(`Balance Año ${year + 1} validado`, { difference: difference.toFixed(2) });
            return true;
        }

        // ===== CÁLCULO DE TIR MEJORADO =====
        function calculateIRR(cashFlows, maxIterations = 100, tolerance = 1e-6) {
            try {
                devOps.performance('Iniciando cálculo TIR', { flujos: cashFlows.length });
                
                if (!cashFlows || cashFlows.length < 2) {
                    devOps.warn('Flujos insuficientes para TIR');
                    return 0;
                }

                const hasPositive = cashFlows.some(cf => cf > 0);
                const hasNegative = cashFlows.some(cf => cf < 0);
                
                if (!hasPositive || !hasNegative) {
                    devOps.warn('TIR requiere flujos positivos y negativos');
                    return 0;
                }

                let guess = 0.1; // 10% inicial
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;
                    let dNpv = 0;
                    
                    for (let t = 0; t < cashFlows.length; t++) {
                        const denominator = Math.pow(1 + guess, t);
                        npv += cashFlows[t] / denominator;
                        if (t > 0) {
                            dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                        }
                    }
                    
                    if (Math.abs(npv) < tolerance) {
                        const result = Math.max(0, Math.min(200, guess * 100));
                        devOps.success('TIR calculada exitosamente', { tir: result, iteraciones: i });
                        return result;
                    }
                    
                    if (Math.abs(dNpv) < tolerance) break;
                    
                    const newGuess = guess - npv / dNpv;
                    
                    if (Math.abs(newGuess - guess) < tolerance) {
                        const result = Math.max(0, Math.min(200, newGuess * 100));
                        devOps.success('TIR convergió', { tir: result, iteraciones: i });
                        return result;
                    }
                    
                    guess = Math.max(-0.99, Math.min(10, newGuess));
                }
                
                devOps.warn('TIR no convergió', { iteraciones: maxIterations });
                return Math.max(0, Math.min(200, guess * 100));
                
            } catch (error) {
                devOps.error('Error calculando TIR', error);
                return 0;
            }
        }

        // ===== FUNCIÓN PRINCIPAL DE CÁLCULO FINANCIERO =====
        function calculateFinancials() {
            const startTime = Date.now();
            devOps.log('=== INICIANDO CÁLCULOS FINANCIEROS NIIF COMPLIANT ===');
            
            try {
                if (!validateInputs()) {
                    return;
                }

                // Inicializar módulos NIIF
                const niif15 = new NIIF15Calculator(modelData.tasaInteres);
                const niif9 = new NIIF9Calculator();
                const scheduler = new AmortizationScheduler();
                
                // Reset resultados
                financialResults.pl = [];
                financialResults.cf = [];
                financialResults.bs = [];
                financialResults.niifDetails = [];
                financialResults.amortizationDetails = [];
                financialResults.validation.calculationErrors = [];
                
                let accumulatedEarnings = 0;
                let cash = modelData.seriesA; // Inicia con $45M
                let accumulatedDepreciation = 0;
                let totalDebt = 0;
                let cumulativeUnits = 0;
                
                // Flujos para TIR
                const projectCashFlows = [-modelData.seriesA]; // Inversión inicial
                const portfolioCashFlows = [];
                
                devOps.log('Procesando proyección 5 años', { serieA: modelData.seriesA });
                
                for (let year = 0; year < 5; year++) {
                    devOps.log(`--- Procesando Año ${year + 1} ---`);
                    
                    const addedUnits = modelData.unitsPerYear[year];
                    cumulativeUnits += addedUnits;
                    
                    // ===== CÁLCULO DE INGRESOS (NIIF 15) =====
                    const originationMargin = addedUnits * modelData.margenVagoneta;
                    
                    // Cartera vigente para cálculo de intereses
                    const avgPortfolioBalance = cumulativeUnits * modelData.vanPrice * 0.75; // 75% promedio vigente
                    
                    // NIIF 15: Reconocimiento al valor presente
                    const niif15Result = niif15.reconocerIngresosPorIntereses(
                        avgPortfolioBalance, 
                        modelData.tasaInteres / 100, 
                        48 // plazo promedio
                    );
                    
                    const interestRevenueVP = niif15Result.valorPresente / 12; // Anualizar
                    const discountAdjustment = niif15Result.ajusteDescuento / 12;
                    
                    // Otros ingresos
                    const gnvCommissions = cumulativeUnits * 15000 * (modelData.comisionGNV / 100);
                    const sparePartsRevenue = cumulativeUnits * 8000 * (modelData.margenRefacciones / 100);
                    const marketplaceRevenue = cumulativeUnits * 3000 * (modelData.marketplace / 100);
                    
                    const totalRevenue = originationMargin + interestRevenueVP + gnvCommissions + sparePartsRevenue + marketplaceRevenue;
                    
                    // ===== CÁLCULO DE PROVISIONES (NIIF 9) =====
                    const niif9Result = niif9.calcularProvisionesDetalladas(avgPortfolioBalance, year);
                    let provisions = niif9Result.total;
                    
                    // Protección Rodando reduce provisiones
                    if (modelData.proteccionRodando) {
                        provisions *= 0.7; // 30% de reducción
                    }
                    
                    // ===== GASTOS OPERATIVOS =====
                    const opex = totalRevenue * (modelData.opexRate / 100);
                    
                    // ===== ACTIVOS FIJOS Y DEPRECIACIÓN =====
                    const totalFixedAssetsCost = cumulativeUnits * modelData.vanCost;
                    const annualDepreciation = totalFixedAssetsCost / modelData.depreciationYears;
                    accumulatedDepreciation += annualDepreciation;
                    
                    // ===== VENTURE DEBT =====
                    const capexThisYear = addedUnits * modelData.vanCost;
                    const newDebtForCapex = capexThisYear * (modelData.ventureDebtPct / 100);
                    const principalPayment = totalDebt * 0.05; // 5% anual de amortización
                    totalDebt = totalDebt + newDebtForCapex - principalPayment;
                    const interestExpense = totalDebt * (modelData.ventureDebtRate / 100);
                    
                    // ===== EBITDA Y UTILIDAD NETA =====
                    const ebitda = totalRevenue - opex - provisions;
                    const netIncome = ebitda - annualDepreciation - interestExpense;
                    accumulatedEarnings += netIncome;
                    
                    // ===== FLUJO DE EFECTIVO =====
                    const operatingCash = netIncome + annualDepreciation + provisions;
                    const investingCash = -capexThisYear;
                    
                    let financingCash = 0;
                    if (year === 0) {
                        financingCash = modelData.seriesA + newDebtForCapex;
                    } else {
                        financingCash = newDebtForCapex - principalPayment;
                    }
                    
                    const netCash = operatingCash + investingCash + financingCash;
                    cash += netCash;
                    
                    // ===== BALANCE GENERAL =====
                    const receivables = avgPortfolioBalance * 0.8; // 80% de la cartera como CxC
                    const fixedAssetsNet = totalFixedAssetsCost - accumulatedDepreciation;
                    const totalAssets = cash + receivables + fixedAssetsNet;
                    const equity = modelData.seriesA + accumulatedEarnings;
                    const totalLiabilitiesEquity = totalDebt + provisions + equity;
                    
                    // ===== VALIDACIÓN CONTABLE =====
                    const balanceValid = validateBalance(year, totalAssets, totalLiabilitiesEquity);
                    if (!balanceValid) {
                        financialResults.validation.balanceCheck = false;
                    }
                    
                    // ===== GUARDAR RESULTADOS =====
                    financialResults.pl.push({
                        originationMargin, 
                        interestRevenueVP, 
                        discountAdjustment,
                        gnvCommissions, 
                        sparePartsRevenue, 
                        marketplaceRevenue, 
                        totalRevenue,
                        opex, 
                        provisions, 
                        ebitda, 
                        depreciation: annualDepreciation, 
                        interestExpense, 
                        netIncome
                    });
                    
                    financialResults.cf.push({
                        operatingCash, investingCash, financingCash, netCash, principalPayment
                    });
                    
                    financialResults.bs.push({
                        cash, receivables, fixedAssets: fixedAssetsNet, totalAssets,
                        debt: totalDebt, provisions, equity, totalLiabilitiesEquity,
                        cumulativeUnits
                    });
                    
                    // ===== DETALLES NIIF =====
                    financialResults.niifDetails.push({
                        niif15: {
                            valorNominal: niif15Result.valorNominal / 12,
                            valorPresente: interestRevenueVP,
                            ajusteDescuento: discountAdjustment,
                            metodologia: "Descuento de flujos futuros a tasa contractual"
                        },
                        niif9: niif9Result
                    });
                    
                    // ===== CRONOGRAMAS =====
                    const estadoCartera = {
                        year: year + 1,
                        totalContratos: cumulativeUnits,
                        saldoTotal: avgPortfolioBalance,
                        porEtapas: niif9Result.distribucion
                    };
                    financialResults.amortizationDetails.push(estadoCartera);
                    
                    // ===== FLUJOS PARA TIR =====
                    projectCashFlows.push(netCash);
                    portfolioCashFlows.push(interestRevenueVP - provisions);
                    
                    devOps.success(`Año ${year + 1} procesado`, { 
                        ebitda: ebitda / 1000000, 
                        totalAssets: totalAssets / 1000000,
                        balance: balanceValid 
                    });
                }
                
                // ===== CALCULAR TIRs =====
                financialResults.tirProyecto = calculateIRR(projectCashFlows);
                financialResults.tirCartera = calculateIRR(portfolioCashFlows);
                
                const elapsedTime = Date.now() - startTime;
                devOps.success('=== CÁLCULOS FINANCIEROS COMPLETADOS ===', {
                    tiempoEjecucion: `${elapsedTime}ms`,
                    tirProyecto: financialResults.tirProyecto.toFixed(2),
                    tirCartera: financialResults.tirCartera.toFixed(2),
                    balanceValidado: financialResults.validation.balanceCheck
                });
                
            } catch (error) {
                devOps.error('Error crítico en calculateFinancials', error);
                financialResults.validation.balanceCheck = false;
            }
        }

        // ===== FUNCIONES DE UI =====
        function updateUI() {
            try {
                const year5 = financialResults.pl[4];
                const year5BS = financialResults.bs[4];
                
                if (year5 && year5BS) {
                    document.getElementById('ebitda-year5').textContent = formatCurrency(year5.ebitda);
                    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                    document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                    
                    // Cálculo correcto de vagonetas acumuladas
                    const vagonetasTotal = modelData.unitsPerYear.reduce((total, units) => total + units, 0);
                    document.getElementById('vagonetas-total').textContent = vagonetasTotal;
                    
                    document.getElementById('deuda-residual').textContent = formatCurrency(year5BS.debt);
                }
                
                // Update unit distribution
                modelData.unitsPerYear.forEach((units, index) => {
                    const element = document.getElementById(`units-year${index+1}`);
                    if (element) element.textContent = units;
                });
                
                updatePLTable();
                updateCashFlowTable();
                updateBalanceSheetTable();
                updateNIIFTables();
                
                // Update balance validation
                const validationDiv = document.getElementById('balance-validation');
                if (financialResults.validation.balanceCheck && financialResults.validation.calculationErrors.length === 0) {
                    validationDiv.innerHTML = '<span class="balance-valid">✅ Balance General: Activo = Pasivo + Capital (NIIF Compliant)</span>';
                } else {
                    const errorMsg = financialResults.validation.calculationErrors[0] || 'Balance no cuadra';
                    validationDiv.innerHTML = `<span class="balance-invalid">❌ Error: ${errorMsg}</span>`;
                }
                
                devOps.success('UI actualizada exitosamente');
                
            } catch (error) {
                devOps.error('Error en updateUI', error);
            }
        }

        // ===== TABLAS NIIF =====
        function updateNIIFTables() {
            updateNIIF15Table();
            updateNIIF9Table();
            updateAmortizationTable();
        }

        function updateNIIF15Table() {
            const container = document.getElementById('niif15-container');
            if (!container || !financialResults.niifDetails.length) return;
            
            container.innerHTML = `
                <div class="niif-section">
                    <h4 class="niif-title">Reconocimiento de Ingresos al Valor Presente</h4>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Ingresos Nominales</td>
                                    ${financialResults.niifDetails.map(detail => 
                                        `<td>${formatCurrency(detail.niif15.valorNominal)}</td>`
                                    ).join('')}
                                </tr>
                                <tr>
                                    <td>Ajuste Descuento NIIF 15</td>
                                    ${financialResults.niifDetails.map(detail => 
                                        `<td class="negative">(${formatCurrency(detail.niif15.ajusteDescuento)})</td>`
                                    ).join('')}
                                </tr>
                                <tr class="bg-gray-50">
                                    <td><strong>Ingresos Valor Presente</strong></td>
                                    ${financialResults.niifDetails.map(detail => 
                                        `<td class="font-bold positive">${formatCurrency(detail.niif15.valorPresente)}</td>`
                                    ).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function updateNIIF9Table() {
            const container = document.getElementById('niif9-container');
            if (!container || !financialResults.niifDetails.length) return;
            
            const year5NIIF9 = financialResults.niifDetails[4]?.niif9;
            if (!year5NIIF9) return;
            
            container.innerHTML = `
                <div class="niif-section">
                    <h4 class="niif-title">Deterioro Crediticio por Etapas (Año 5)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        ${year5NIIF9.detalle.map(etapa => `
                            <div class="p-4 rounded-lg ${etapa.etapa === 'Etapa1' ? 'bg-green-50' : etapa.etapa === 'Etapa2' ? 'bg-yellow-50' : 'bg-red-50'}">
                                <h5 class="font-semibold">${etapa.etapa}</h5>
                                <p class="text-sm text-gray-600">${etapa.descripcion}</p>
                                <p class="text-lg font-bold">${formatCurrency(etapa.montoProvision)}</p>
                                <p class="text-sm">Tasa: ${etapa.tasaProvision}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <h5 class="font-semibold">Total Provisiones NIIF 9</h5>
                        <p class="text-2xl font-bold text-blue-900">${formatCurrency(year5NIIF9.total)}</p>
                    </div>
                </div>
            `;
        }

        function updateAmortizationTable() {
            const container = document.getElementById('amortization-container');
            if (!container || !financialResults.amortizationDetails.length) return;
            
            const year5Detail = financialResults.amortizationDetails[4];
            if (!year5Detail) return;
            
            container.innerHTML = `
                <div class="niif-section">
                    <h4 class="niif-title">Estado de Cartera - Cronogramas de Amortización</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="p-4 bg-blue-50 rounded-lg text-center">
                            <h5 class="font-semibold">Total Contratos</h5>
                            <p class="text-2xl font-bold">${year5Detail.totalContratos}</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg text-center">
                            <h5 class="font-semibold">Saldo Total</h5>
                            <p class="text-xl font-bold">${formatCurrency(year5Detail.saldoTotal)}</p>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg text-center">
                            <h5 class="font-semibold">Etapa 1 (Normal)</h5>
                            <p class="text-lg font-bold">${formatCurrency(year5Detail.porEtapas.etapa1)}</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg text-center">
                            <h5 class="font-semibold">Etapas 2+3 (Riesgo)</h5>
                            <p class="text-lg font-bold">${formatCurrency(year5Detail.porEtapas.etapa2 + year5Detail.porEtapas.etapa3)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== RESTO DE FUNCIONES (PL, CF, BS, Charts, etc.) =====
        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody || !financialResults.pl.length) return;
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'Margen por Originación', key: 'originationMargin', positive: true },
                { label: 'Ingresos por Intereses (VP)', key: 'interestRevenueVP', positive: true },
                { label: 'Comisiones GNV', key: 'gnvCommissions', positive: true },
                { label: 'Ingresos por Refacciones', key: 'sparePartsRevenue', positive: true },
                { label: 'Ingresos Marketplace', key: 'marketplaceRevenue', positive: true },
                { label: 'Total Ingresos', key: 'totalRevenue', total: true, positive: true },
                { label: 'Gastos Operativos', key: 'opex', negative: true },
                { label: 'Provisiones (NIIF 9)', key: 'provisions', negative: true },
                { label: 'EBITDA', key: 'ebitda', total: true, positive: true },
                { label: 'Depreciación', key: 'depreciation', negative: true },
                { label: 'Intereses Deuda', key: 'interestExpense', negative: true },
                { label: 'Utilidad Neta', key: 'netIncome', total: true, positive: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.pl.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[row.key] || 0;
                    
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(Math.abs(value));
                        if (value > 0 && row.positive) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
        }

        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody || !financialResults.cf.length) return;
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'Flujo Operativo', key: 'operatingCash' },
                { label: 'Flujo de Inversión (CAPEX)', key: 'investingCash' },
                { label: 'Flujo Financiero', key: 'financingCash' },
                { label: 'Pago Principal Deuda', key: 'principalPayment' },
                { label: 'Flujo Neto', key: 'netCash', total: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.cf.forEach(yearData => {
                    const cell = document.createElement('td');
                    let value = yearData[row.key] || 0;
                    
                    if (row.key === 'principalPayment' && value > 0) value = -value;
                    
                    if (value < 0) {
                        cell.textContent = '(' + formatCurrency(Math.abs(value)) + ')';
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(value);
                        cell.classList.add('positive');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
        }

        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody || !financialResults.bs.length) return;
            
            tbody.innerHTML = '';
            
            const rows = [
                { label: 'Efectivo', key: 'cash' },
                { label: 'Cuentas por Cobrar', key: 'receivables' },
                { label: 'Activos Fijos (Neto)', key: 'fixedAssets' },
                { label: 'Total Activos', key: 'totalAssets', total: true },
                { label: 'Deuda Venture Debt', key: 'debt' },
                { label: 'Provisiones NIIF 9', key: 'provisions' },
                { label: 'Patrimonio', key: 'equity' },
                { label: 'Total Pasivo + Capital', key: 'totalLiabilitiesEquity', total: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.bs.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[row.key] || 0;
                    cell.textContent = formatCurrency(value);
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
        }

        function formatCurrency(value) {
            if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            } else if (Math.abs(value) >= 1000) {
                return '$' + (value / 1000).toFixed(1) + 'K MXN';
            }
            return '$' + Math.round(value).toLocaleString();
        }

        // ===== CONTROLES Y EVENTOS =====
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');

            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));

                    button.classList.add('active');
                    contentSections[index].classList.add('active');

                    if (button.id === 'tab-graficos') {
                        setTimeout(updateCharts, 100);
                    }
                });
            });
        }

        function setupControls() {
            const sliders = [
                'tasa-interes', 'tasa-morosidad', 'margen-vagoneta', 
                'comision-gnv', 'margen-refacciones', 'marketplace',
                'venture-debt-pct', 'venture-debt-rate'
            ];

            sliders.forEach(sliderId => {
                const slider = document.getElementById(sliderId);
                if (slider) {
                    slider.addEventListener('input', function() {
                        updateControlValue(sliderId, this.value);
                        calculateFinancials();
                        updateUI();
                        updateCharts();
                    });
                }
            });

            const checkbox = document.getElementById('check-proteccion');
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    modelData.proteccionRodando = this.checked;
                    calculateFinancials();
                    updateUI();
                    updateCharts();
                });
            }
        }

        function updateControlValue(controlId, value) {
            const numValue = parseFloat(value);
            
            switch(controlId) {
                case 'tasa-interes':
                    modelData.tasaInteres = numValue;
                    document.getElementById('tasa-interes-valor').textContent = numValue.toFixed(1) + '%';
                    break;
                case 'tasa-morosidad':
                    modelData.tasaMorosidad = numValue;
                    document.getElementById('tasa-morosidad-valor').textContent = numValue + '%';
                    break;
                case 'margen-vagoneta':
                    modelData.margenVagoneta = numValue;
                    document.getElementById('margen-vagoneta-valor').textContent = '$' + numValue.toLocaleString();
                    break;
                case 'comision-gnv':
                    modelData.comisionGNV = numValue;
                    document.getElementById('comision-gnv-valor').textContent = numValue + '%';
                    break;
                case 'margen-refacciones':
                    modelData.margenRefacciones = numValue;
                    document.getElementById('margen-refacciones-valor').textContent = numValue + '%';
                    break;
                case 'marketplace':
                    modelData.marketplace = numValue;
                    document.getElementById('marketplace-valor').textContent = numValue + '%';
                    break;
                case 'venture-debt-pct':
                    modelData.ventureDebtPct = numValue;
                    document.getElementById('venture-debt-pct-valor').textContent = numValue + '%';
                    break;
                case 'venture-debt-rate':
                    modelData.ventureDebtRate = numValue;
                    document.getElementById('venture-debt-rate-valor').textContent = numValue + '%';
                    break;
            }
        }

        function createConstantControls() {
            const container = document.getElementById('constants-container');
            if (!container) return;
            
            const constants = [
                {id: 'opex-rate', label: 'Tasa OPEX (%)', key: 'opexRate', min: 10, max: 25, step: 1},
                {id: 'provision-rate', label: 'Tasa Provisiones (%)', key: 'provisionRate', min: 5, max: 15, step: 1},
                {id: 'depreciation-years', label: 'Años Depreciación', key: 'depreciationYears', min: 8, max: 15, step: 1},
                {id: 'lgd', label: 'LGD (%)', key: 'lgd', min: 30, max: 60, step: 5},
                {id: 'plazo-financiamiento', label: 'Plazo Financiamiento (meses)', key: 'plazoFinanciamiento', min: 36, max: 60, step: 6}
            ];
            
            constants.forEach(constant => {
                const control = document.createElement('div');
                control.className = 'constant-control';
                control.innerHTML = `
                    <label for="${constant.id}">${constant.label}</label>
                    <input type="range" id="${constant.id}" 
                           min="${constant.min}" max="${constant.max}" step="${constant.step}" 
                           value="${modelData[constant.key]}"
                           class="input-slider mt-1">
                    <span id="${constant.id}-value" class="text-sm text-gray-600">${modelData[constant.key]}</span>
                `;
                container.appendChild(control);
                
                document.getElementById(constant.id).addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    modelData[constant.key] = value;
                    document.getElementById(`${constant.id}-value`).textContent = value;
                    calculateFinancials();
                    updateUI();
                    updateCharts();
                });
            });
        }

        function createUnitControls() {
            const container = document.getElementById('units-container');
            if (!container) return;
            
            modelData.unitsPerYear.forEach((units, index) => {
                const control = document.createElement('div');
                control.className = 'unit-control';
                control.innerHTML = `
                    <label for="unit-year-${index+1}">Año ${index+1}</label>
                    <input type="number" id="unit-year-${index+1}" 
                           min="0" max="500" step="5" 
                           value="${units}">
                `;
                container.appendChild(control);
                
                document.getElementById(`unit-year-${index+1}`).addEventListener('change', function() {
                    const value = parseInt(this.value) || 0;
                    modelData.unitsPerYear[index] = Math.max(0, Math.min(500, value));
                    this.value = modelData.unitsPerYear[index];
                    calculateFinancials();
                    updateUI();
                    updateCharts();
                });
            });
        }

        // ===== GRÁFICOS =====
        function initializeCharts() {
            devOps.log('Inicializando gráficos');
            
            const ctx1 = document.getElementById('ebitdaChart');
            if (ctx1) {
                charts.ebitda = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                        datasets: [{
                            label: 'Ingresos Totales',
                            data: [],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'EBITDA',
                            data: [],
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Millones MXN' }}
                        }
                    }
                });
            }
            
            const ctx2 = document.getElementById('revenueMixChart');
            if (ctx2) {
                charts.revenueMix = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Margen Originación', 'Ingresos Intereses', 'Comisiones GNV', 'Refacciones', 'Marketplace'],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#2563eb', '#16a34a', '#d97706', '#7c3aed', '#ec4899']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            
            const ctx3 = document.getElementById('niif9Chart');
            if (ctx3) {
                charts.niif9 = new Chart(ctx3, {
                    type: 'doughnut',
                    data: {
                        labels: ['Etapa 1 (Normal)', 'Etapa 2 (Riesgo)', 'Etapa 3 (Incumplimiento)'],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            
            const ctx4 = document.getElementById('capitalStructureChart');
            if (ctx4) {
                charts.capitalStructure = new Chart(ctx4, {
                    type: 'bar',
                    data: {
                        labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                        datasets: [{
                            label: 'Capital (Equity)',
                            data: [],
                            backgroundColor: '#16a34a'
                        }, {
                            label: 'Deuda',
                            data: [],
                            backgroundColor: '#dc2626'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, title: { display: true, text: 'Millones MXN' }}
                        }
                    }
                });
            }
            
            updateCharts();
            devOps.success('Gráficos inicializados');
        }

        function updateCharts() {
            if (!financialResults.pl.length) return;
            
            try {
                // EBITDA Chart
                if (charts.ebitda && charts.ebitda.data) {
                    const revenues = financialResults.pl.map(d => d.totalRevenue / 1000000);
                    const ebitdas = financialResults.pl.map(d => d.ebitda / 1000000);
                    
                    charts.ebitda.data.datasets[0].data = revenues;
                    charts.ebitda.data.datasets[1].data = ebitdas;
                    charts.ebitda.update('none');
                }
                
                // Revenue Mix Chart
                if (charts.revenueMix && financialResults.pl[4]) {
                    const year5 = financialResults.pl[4];
                    charts.revenueMix.data.datasets[0].data = [
                        year5.originationMargin,
                        year5.interestRevenueVP,
                        year5.gnvCommissions,
                        year5.sparePartsRevenue,
                        year5.marketplaceRevenue
                    ];
                    charts.revenueMix.update('none');
                }
                
                // NIIF 9 Chart
                if (charts.niif9 && financialResults.niifDetails[4]) {
                    const niif9Data = financialResults.niifDetails[4].niif9.distribucion;
                    charts.niif9.data.datasets[0].data = [
                        niif9Data.etapa1,
                        niif9Data.etapa2,
                        niif9Data.etapa3
                    ];
                    charts.niif9.update('none');
                }
                
                // Capital Structure Chart
                if (charts.capitalStructure) {
                    const equity = financialResults.bs.map(d => d.equity / 1000000);
                    const debt = financialResults.bs.map(d => d.debt / 1000000);
                    
                    charts.capitalStructure.data.datasets[0].data = equity;
                    charts.capitalStructure.data.datasets[1].data = debt;
                    charts.capitalStructure.update('none');
                }
                
                devOps.success('Gráficos actualizados');
                
            } catch (error) {
                devOps.error('Error actualizando gráficos', error);
            }
        }

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            devOps.log('🚀 INICIANDO MODELO FINANCIERO RODANDO A GAS 🚀');
            
            // Setup debug panel
            document.getElementById('debug-toggle').addEventListener('click', function() {
                const panel = document.getElementById('debug-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
            
            setupTabs();
            setupControls();
            createConstantControls();
            createUnitControls();
            calculateFinancials();
            updateUI();
            initializeCharts();
            
            devOps.success('✅ APLICACIÓN INICIALIZADA CORRECTAMENTE');
            devOps.log('DevOps Stats:', devOps.getStats());
        });
    </script>
</body>
</html>
