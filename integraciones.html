<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arquitectura de Integraciones - Conductores</title>
  <!-- TailwindCSS (CDN oficial) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 (UMD desde unpkg) -->
  <script defer src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script defer src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel para JSX en un solo archivo -->
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://rsms.me/inter/inter.css');
    html { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    /* Fallbacks de ancho/alto din√°micos para las cards (Tailwind CDN no detecta din√°micos) */
    .node-card { position: absolute; border-radius: 1rem; backdrop-filter: blur(4px); padding: 0.75rem 0.875rem; cursor: pointer; transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease; }
    .node-card:hover { transform: scale(1.02); }
    .lane-title { height: 40px; display: flex; align-items: center; gap: 0.5rem; font-size: 12px; color: rgb(203 213 225 / 0.9); }
    .edge-path { transition: stroke .3s ease; }
  </style>
</head>
<body class="bg-slate-950">
  <div id="root">
    <!-- Fallback est√°tico simple para cuando React no carga -->
    <div id="fallback" class="min-h-screen text-slate-100">
      <div class="max-w-[1200px] mx-auto px-6 py-8">
        <div class="flex items-center gap-3 mb-4">
          <span class="text-teal-400">‚öôÔ∏è</span>
          <h1 class="text-lg font-extrabold tracking-tight">Arquitectura de Integraciones ‚Äî Conductores</h1>
        </div>
        <p class="text-slate-300 text-sm">Cargando diagrama interactivo... Si esto tarda demasiado, revisa la consola del navegador.</p>
        <ul class="mt-4 grid sm:grid-cols-2 md:grid-cols-3 gap-2 text-sm text-slate-300">
          <li>üß≠ Fronts / Canales</li>
          <li>ü™Ñ Orquestaci√≥n (iPaaS)</li>
          <li>üîå Servicios Externos</li>
          <li>üì° Telem√°tica / Operaci√≥n</li>
          <li>üè¢ Plataforma Interna (Core)</li>
          <li>üìä Datos, IA y BI</li>
        </ul>
      </div>
    </div>
  </div>
  <noscript>
    <div class="max-w-[1200px] mx-auto px-6 py-8 text-slate-100">
      Necesitas habilitar JavaScript para ver el diagrama interactivo.
    </div>
  </noscript>

  <script type="text/babel" data-presets="env,react">
    // Debug helpers
    const debug = {
      log: (...args) => console.log('[Integraciones]', ...args),
      error: (...args) => console.error('[Integraciones][ERROR]', ...args),
    };

    // Inline emoji icons (sencillos y sin dependencias)
    const EMOJI = {
      front: 'üß≠', orchestration: 'ü™Ñ', external: 'üîå', telematics: 'üì°', internal: 'üè¢', data: 'üìä',
      portal: 'üß≠', whatsapp: 'üí¨', ipaas: 'ü™Ñ', metamap: 'ü™™', kiban: 'üìà', mifiel: '‚úçÔ∏è', conekta: 'üí≥',
      gnv: '‚õΩ', samsara: '‚ö°', odoo: 'üîÅ', airtable: 'üóÇÔ∏è', hase: 'ü§ñ', pia: 'üì£', pma: 'üõ†Ô∏è', assistant: 'ü§ù',
      warehouse: 'üóÑÔ∏è', bi: 'üìä'
    };

    // Visual constants
    const UI_LARGE = { LANE_WIDTH: 320, LANE_GAP: 28, ROW_HEIGHT: 132, CARD_W: 290, CARD_H: 86, PADDING_X: 24, PADDING_Y: 96 };
    const UI_SMALL = { LANE_WIDTH: 260, LANE_GAP: 20, ROW_HEIGHT: 116, CARD_W: 240, CARD_H: 78, PADDING_X: 16, PADDING_Y: 72 };

    const COLORS = {
      external: 'from-sky-500/20 to-sky-400/10 border-sky-400/40',
      internal: 'from-emerald-500/20 to-emerald-400/10 border-emerald-400/40',
      data: 'from-fuchsia-500/20 to-fuchsia-400/10 border-fuchsia-400/40',
      orchestration: 'from-amber-500/20 to-amber-400/10 border-amber-400/40',
      telematics: 'from-cyan-500/20 to-cyan-400/10 border-cyan-400/40',
      front: 'from-teal-500/20 to-teal-400/10 border-teal-400/40',
    };

    // 1) Datos: LANES, NODES, FLOWS
    const LANES = [
      { id: 'front', title: 'Fronts / Canales', icon: EMOJI.front },
      { id: 'orchestration', title: 'Orquestaci√≥n (iPaaS)', icon: EMOJI.orchestration },
      { id: 'external', title: 'Servicios Externos (SaaS / Partners)', icon: EMOJI.external },
      { id: 'telematics', title: 'Telem√°tica / Operaci√≥n', icon: EMOJI.telematics },
      { id: 'internal', title: 'Plataforma Interna (Core)', icon: EMOJI.internal },
      { id: 'data', title: 'Datos, IA y BI', icon: EMOJI.data },
    ];

    const NODES = [
      // Fronts
      { id: 'portal', lane: 'front', row: 0, title: 'Portal Cliente (Web/App)', subtitle: 'Onboarding + Panel b√°sico', type: 'front', icon: EMOJI.portal,
        io: { in: ['Links Mifiel / Pago', 'Mensajes Asistente'], out: ['Datos KYC', 'Documentos', 'Eventos UI'] } },
      { id: 'whatsapp', lane: 'front', row: 1, title: 'WhatsApp Asistente (Flowise)', subtitle: 'Soporte y postventa', type: 'front', icon: EMOJI.whatsapp,
        io: { in: ['Alertas PMA/PIA', 'Recordatorios pago'], out: ['Respuestas cliente', 'Tickets postventa'] } },

      // Orchestration
      { id: 'ipaas', lane: 'orchestration', row: 0, title: 'Make / n8n / Zapier', subtitle: 'Flujos y conectores', type: 'orchestration', icon: EMOJI.ipaas,
        io: { in: ['Webhooks Samsara/Conekta', 'Eventos Portal'], out: ['Acciones en Odoo/Airtable', 'Notificaciones Asistente'] } },

      // External Services
      { id: 'metamap', lane: 'external', row: 0, title: 'Metamap (KYC)', subtitle: 'INE/CURP/biometr√≠a', type: 'external', icon: EMOJI.metamap,
        io: { in: ['Datos del solicitante'], out: ['Resultado KYC', 'Pruebas biom√©tricas'] } },
      { id: 'kiban', lane: 'external', row: 1, title: 'KIBAN ‚Üî C√≠rculo de Cr√©dito', subtitle: 'Consulta y Reporte', type: 'external', icon: EMOJI.kiban,
        io: { in: ['Identificadores solicitante', 'Estado de cuenta (opcional)', 'Eventos de pago'], out: ['Reporte de cr√©dito (consulta)', 'Estatus de env√≠o (reporte mensual)'] } },
      { id: 'mifiel', lane: 'external', row: 2, title: 'Mifiel', subtitle: 'Firma electr√≥nica avanzada', type: 'external', icon: EMOJI.mifiel,
        io: { in: ['Contrato generado (PDF)', 'Datos firmantes'], out: ['Evidencia y hash', 'Webhook de estatus'] } },
      { id: 'conekta', lane: 'external', row: 3, title: 'Conekta', subtitle: 'Cobros (tarjeta / OXXO)', type: 'external', icon: EMOJI.conekta,
        io: { in: ['Orden de pago', 'Referencia OXXO'], out: ['Webhook pago/fracaso/refund', 'Liquidaciones'] } },
      { id: 'gnv', lane: 'external', row: 4, title: 'APIs Estaciones GNV', subtitle: 'Consumo / Carga', type: 'external', icon: EMOJI.gnv,
        io: { in: ['ID unidad / tag'], out: ['Volumen/importe/estaci√≥n', 'Timestamp'] } },

      // Telematics
      { id: 'samsara', lane: 'telematics', row: 0, title: 'Samsara (VG55 / EI21)', subtitle: 'GPS, OBD-II, C√≥digos falla, Inmovilizador', type: 'telematics', icon: EMOJI.samsara,
        io: { in: ['Config / tags', '√ìrdenes de inmovilizaci√≥n'], out: ['Ubicaci√≥n/velocidad/RPM', 'C√≥digos DTC y DVIR', 'Webhooks eventos'] } },

      // Internal Platform
      { id: 'odoo', lane: 'internal', row: 0, title: 'Odoo (ERP / CRM / Field Service)', subtitle: 'Clientes, contratos, cartera, servicios', type: 'internal', icon: EMOJI.odoo,
        io: { in: ['Resultado KYC/Cr√©dito', 'Webhook firma y pagos', 'Alertas PMA/PIA'], out: ['Contrato (PDF)', 'Facturas / estados de cuenta', '√ìrdenes de servicio'] } },
      { id: 'airtable', lane: 'internal', row: 1, title: 'Airtable (Ops Board)', subtitle: 'Backoffice, colas, SLAs', type: 'internal', icon: EMOJI.airtable,
        io: { in: ['Eventos iPaaS', 'Datos Odoo'], out: ['Tareas y estados', 'Feeds de control'] } },

      // Data & AI
      { id: 'hase', lane: 'data', row: 0, title: 'HASE (Scoring operativo)', subtitle: 'Score hiper-adaptativo', type: 'data', icon: EMOJI.hase,
        io: { in: ['KYC Metamap', 'Consulta KIBAN', 'Colateral social'], out: ['Decisi√≥n + explicabilidad', 'Recomendaci√≥n de t√©rminos'] } },
      { id: 'pia', lane: 'data', row: 1, title: 'PIA (Intervenci√≥n proactiva)', subtitle: 'Cobranza emp√°tica', type: 'data', icon: EMOJI.pia,
        io: { in: ['Eventos de pago Conekta', 'Telem√°tica / h√°bitos'], out: ['Planes flexibles', 'Mensajes Asistente'] } },
      { id: 'pma', lane: 'data', row: 2, title: 'PMA (Mto. predictivo)', subtitle: 'Alertas y √≥rdenes', type: 'data', icon: EMOJI.pma,
        io: { in: ['DTCs / RPM / temperaturas', 'DVIR, consumo GNV'], out: ['Orden de servicio Odoo', 'Tips Asistente'] } },
      { id: 'assistant', lane: 'data', row: 3, title: 'Asistente Postventa (Flowise)', subtitle: 'WhatsApp + flujos', type: 'data', icon: EMOJI.assistant,
        io: { in: ['Alertas PIA/PMA', 'Datos de contrato'], out: ['Conversaciones', 'Confirmaciones'] } },
      { id: 'warehouse', lane: 'data', row: 4, title: 'Data Lake / Warehouse', subtitle: 'Historificaci√≥n + BI', type: 'data', icon: EMOJI.warehouse,
        io: { in: ['Batch/Streams telem√°tica', 'ERP/finanzas'], out: ['Dashboards, XAI, stress tests'] } },
      { id: 'bi', lane: 'data', row: 5, title: 'BI (Looker/Power BI)', subtitle: 'KPIs y reporting', type: 'data', icon: EMOJI.bi,
        io: { in: ['Modelos sem√°nticos'], out: ['Tableros Operaci√≥n/Finanzas/Calidad'] } },
    ];

    const FLOWS = {
      'Onboarding & Scoring': [
        ['portal', 'metamap'],
        ['metamap', 'ipaas'],
        ['ipaas', 'kiban'],
        ['kiban', 'hase'], // consulta cr√©dito ‚Üí HASE
        ['hase', 'odoo'],
        ['odoo', 'mifiel'],
        ['mifiel', 'ipaas'],
        ['ipaas', 'odoo']
      ],
      'Desembolso & Entrega': [
        ['odoo', 'conekta'],
        ['conekta', 'ipaas'],
        ['ipaas', 'odoo'],
        ['odoo', 'samsara'],
        ['odoo', 'whatsapp']
      ],
      'Operaci√≥n & PMA': [
        ['samsara', 'ipaas'],
        ['ipaas', 'pma'],
        ['pma', 'odoo'],
        ['pma', 'assistant'],
        ['gnv', 'warehouse'],
        ['samsara', 'warehouse'],
        ['warehouse', 'bi']
      ],
      'Cobranza & PIA': [
        ['conekta', 'ipaas'],
        ['ipaas', 'pia'],
        ['pia', 'assistant'],
        ['assistant', 'odoo']
      ],
      'Garant√≠as & Postventa': [
        ['samsara', 'pma'],
        ['pma', 'odoo'],
        ['assistant', 'odoo']
      ],
      'Reporte Bur√≥ (mensual)': [
        ['odoo', 'kiban'],
        ['kiban', 'odoo']
      ],
    };

    // 2) Utilidades de layout
    function computePositions(nodes, UI) {
      const laneIndex = Object.fromEntries(LANES.map((l, i) => [l.id, i]));
      const positions = {};
      nodes.forEach((n) => {
        const x = UI.PADDING_X + laneIndex[n.lane] * (UI.LANE_WIDTH + UI.LANE_GAP) + (UI.LANE_WIDTH - UI.CARD_W) / 2;
        const y = UI.PADDING_Y + n.row * UI.ROW_HEIGHT;
        positions[n.id] = { x, y };
      });
      return positions;
    }

    // 3) Componentes UI
    function Header({ flow, setFlow }) {
      return (
        <div className="sticky top-0 z-30 bg-slate-950/80 backdrop-blur border-b border-slate-800">
          <div className="max-w-[1400px] mx-auto px-6 py-4 flex items-center gap-3">
            <span className="w-5 h-5 text-teal-400">‚öôÔ∏è</span>
            <h1 className="text-lg md:text-xl font-extrabold tracking-tight">Arquitectura de Integraciones ‚Äî Conductores</h1>
            <div className="ml-auto flex items-center gap-2 overflow-x-auto">
              {Object.keys(FLOWS).map((f) => (
                <button
                  key={f}
                  className={`px-3 py-1.5 rounded-lg border text-[12px] whitespace-nowrap transition ${f === flow ? 'bg-teal-500/20 border-teal-400 text-teal-200' : 'bg-slate-900 border-slate-700 text-slate-300 hover:border-teal-500/40'}`}
                  onClick={() => { debug.log('Flow change ‚Üí', f); setFlow(f); }}
                >{f}</button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function Sidebar({ visibleLanes, setVisibleLanes }) {
      return (
        <aside className="col-span-12 lg:col-span-3 space-y-4">
          <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
            <div className="flex items-center gap-2 mb-2">
              <span className="text-slate-300">üìö</span>
              <div className="font-semibold">Capas visibles</div>
            </div>
            <div className="space-y-2">
              {LANES.map((l) => (
                <label key={l.id} className="flex items-center justify-between py-1 text-sm">
                  <span className="flex items-center gap-2 text-slate-300"><span className="text-slate-400">{l.icon}</span>{l.title}</span>
                  <input
                    type="checkbox"
                    className="accent-teal-500"
                    checked={visibleLanes[l.id]}
                    onChange={(e) => { debug.log('Lane toggle', l.id, e.target.checked); setVisibleLanes((v) => ({ ...v, [l.id]: e.target.checked })); }}
                  />
                </label>
              ))}
            </div>
            <div className="mt-3 text-[12px] text-slate-400">Consejo: Activa solo las capas que necesites para cada demo.</div>
          </div>

          <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
            <div className="flex items-center gap-2 mb-2"><span className="text-slate-300">üé®</span><div className="font-semibold">Leyenda de color</div></div>
            <ul className="space-y-1 text-sm">
              <li><span className="inline-block w-3 h-3 rounded bg-gradient-to-br from-teal-500/20 to-teal-400/10 mr-2 align-middle border border-teal-400/40"></span>Fronts / Canales</li>
              <li><span className="inline-block w-3 h-3 rounded bg-gradient-to-br from-amber-500/20 to-amber-400/10 mr-2 align-middle border border-amber-400/40"></span>Orquestaci√≥n</li>
              <li><span className="inline-block w-3 h-3 rounded bg-gradient-to-br from-sky-500/20 to-sky-400/10 mr-2 align-middle border border-sky-400/40"></span>Servicios Externos</li>
              <li><span className="inline-block w-3 h-3 rounded bg-gradient-to-br from-cyan-500/20 to-cyan-400/10 mr-2 align-middle border border-cyan-400/40"></span>Telem√°tica</li>
              <li><span className="inline-block w-3 h-3 rounded bg-gradient-to-br from-emerald-500/20 to-emerald-400/10 mr-2 align-middle border border-emerald-400/40"></span>Plataforma Interna</li>
              <li><span className="inline-block w-3 h-3 rounded bg-gradient-to-br from-fuchsia-500/20 to-fuchsia-400/10 mr-2 align-middle border border-fuchsia-400/40"></span>Datos / IA / BI</li>
            </ul>
          </div>

          <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
            <div className="flex items-center gap-2 mb-2"><span className="text-slate-300">üß≠</span><div className="font-semibold">Puntos cr√≠ticos</div></div>
            <ul className="list-disc pl-5 text-sm space-y-1 text-slate-300/90">
              <li><b>KIBAN ‚Üí C√≠rculo de Cr√©dito</b> se usa <i>siempre</i> en Onboarding (consulta) y cada mes en <b>Reporte</b>.</li>
              <li><b>Samsara</b> provee webhooks/stream para PMA/PIA y control de inmovilizador.</li>
              <li><b>Odoo</b> es la fuente operativa: contratos, cartera, OS y facturaci√≥n.</li>
              <li><b>Warehouse/BI</b> consolida hist√≥rico para XAI y stress testing.</li>
            </ul>
          </div>
        </aside>
      );
    }

    function Edge({ from, to, positions, active, UI }) {
      const a = positions[from];
      const b = positions[to];
      if (!a || !b) return null;
      const x1 = a.x + UI.CARD_W;
      const y1 = a.y + UI.CARD_H / 2;
      const x2 = b.x;
      const y2 = b.y + UI.CARD_H / 2;
      const dx = Math.max(80, (x2 - x1) * 0.5);
      const path = `M ${x1} ${y1} C ${x1 + dx} ${y1}, ${x2 - dx} ${y2}, ${x2} ${y2}`;
      return (
        <path d={path} className={`edge-path ${active ? 'stroke-teal-400/80 [filter:drop-shadow(0_0_6px_rgba(45,212,191,0.6))]' : 'stroke-slate-400/30'}`} strokeWidth={active ? 3 : 2} fill="none" />
      );
    }

    function NodeCard({ node, pos, selected, onSelect, UI }) {
      const color = COLORS[node.type];
      const style = { left: pos.x, top: pos.y, width: `${UI.CARD_W}px`, height: `${UI.CARD_H}px` };
      return (
        <div
          onClick={() => { debug.log('Node select ‚Üí', node.id); onSelect?.(node); }}
          title={node.subtitle}
          className={`node-card border bg-gradient-to-br ${color} ${selected ? 'ring-2 ring-teal-400/70' : ''}`}
          style={style}
        >
          <div className="flex items-start gap-2">
            <div className="shrink-0 mt-0.5 text-slate-300" aria-hidden>{node.icon}</div>
            <div className="min-w-0">
              <div className="text-slate-100 font-semibold leading-tight text-[13px] truncate">{node.title}</div>
              <div className="text-slate-300/80 text-[12px] truncate">{node.subtitle}</div>
            </div>
          </div>
          <div className="mt-2 grid grid-cols-2 gap-2 text-[11px] text-slate-300/90">
            <div>
              <div className="uppercase tracking-wide text-[10px] text-slate-400">IN</div>
              <div className="space-y-0.5">{node.io.in.slice(0, 2).map((t, i) => (<div key={i} className="truncate">‚Ä¢ {t}</div>))}</div>
            </div>
            <div>
              <div className="uppercase tracking-wide text-[10px] text-slate-400">OUT</div>
              <div className="space-y-0.5">{node.io.out.slice(0, 2).map((t, i) => (<div key={i} className="truncate">‚Ä¢ {t}</div>))}</div>
            </div>
          </div>
        </div>
      );
    }

    function Inspector({ flow, selected }) {
      return (
        <div className="grid md:grid-cols-2 gap-4">
          <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
            <div className="flex items-center gap-2 mb-1"><span className="text-teal-300">üîÄ</span><div className="font-semibold">Flujo activo</div></div>
            <div className="text-sm text-slate-300/90 mb-2">{flow}</div>
            <ol className="list-decimal pl-5 text-sm space-y-1 text-slate-300/90">
              {(FLOWS[flow] || []).map(([a, b], i) => (
                <li key={i}>
                  <span className="font-medium text-teal-200">{NODES.find(n => n.id === a)?.title}</span>
                  <span className="text-slate-400"> ‚Üí </span>
                  <span className="font-medium text-teal-200">{NODES.find(n => n.id === b)?.title}</span>
                </li>
              ))}
            </ol>
          </div>

          <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
            <div className="flex items-center gap-2 mb-1"><span className="text-fuchsia-300">üß©</span><div className="font-semibold">Inspector de nodo</div></div>
            {selected ? (
              <div>
                <div className="text-teal-200 font-semibold">{selected.title}</div>
                <div className="text-slate-300/80 text-sm">{selected.subtitle}</div>
                <div className="grid grid-cols-2 gap-4 mt-3">
                  <div>
                    <div className="uppercase tracking-wide text-[10px] text-slate-400">Entradas</div>
                    <ul className="mt-1 text-sm list-disc pl-4 space-y-1">{selected.io.in.map((t, i) => (<li key={i}>{t}</li>))}</ul>
                  </div>
                  <div>
                    <div className="uppercase tracking-wide text-[10px] text-slate-400">Salidas</div>
                    <ul className="mt-1 text-sm list-disc pl-4 space-y-1">{selected.io.out.map((t, i) => (<li key={i}>{t}</li>))}</ul>
                  </div>
                </div>
              </div>
            ) : (
              <div className="text-slate-400 text-sm">Selecciona un nodo en el mapa para ver detalles de entradas/salidas.</div>
            )}
          </div>
        </div>
      );
    }

    function Canvas({ UI, flow, visibleLanes, selected, setSelected, viewportWidth }) {
      const filteredNodes = React.useMemo(() => NODES.filter((n) => visibleLanes[n.lane]), [visibleLanes]);
      const positions = React.useMemo(() => computePositions(filteredNodes, UI), [filteredNodes, UI]);
      const width = UI.PADDING_X * 2 + LANES.length * (UI.LANE_WIDTH + UI.LANE_GAP);
      const maxRow = filteredNodes.length ? Math.max(...filteredNodes.map((n) => n.row)) : 0;
      const height = UI.PADDING_Y * 2 + (maxRow + 1) * UI.ROW_HEIGHT;
      const horizontalPadding = 48;
      const scale = Math.min(1, (viewportWidth - horizontalPadding) / width);

      return (
        <div className="relative rounded-2xl border border-slate-800 bg-gradient-to-b from-slate-900 to-slate-950 overflow-auto">
          <div style={{ width, height, transform: `scale(${scale})`, transformOrigin: 'top left', position: 'relative' }}>
            {/* Lane headers */}
            <div className="absolute inset-x-0 top-0 flex" style={{ left: UI.PADDING_X, right: UI.PADDING_X, height: 40 }}>
              {LANES.map((l) => (
                visibleLanes[l.id] && (
                  <div key={l.id} className="lane-title" style={{ width: UI.LANE_WIDTH, marginRight: UI.LANE_GAP }}>
                    <span className="text-slate-400" aria-hidden>{l.icon}</span>{l.title}
                  </div>
                )
              ))}
            </div>

            {/* Edges */}
            <svg width={width} height={height} className="block">
              {Object.values(FLOWS).flat().map(([a, b], i) => (
                <Edge key={`${a}-${b}-${i}`} from={a} to={b} positions={positions} active={(FLOWS[flow] || []).some(([x, y]) => x === a && y === b)} UI={UI} />
              ))}
            </svg>

            {/* Cards */}
            {filteredNodes.map((n) => (
              positions[n.id] && (
                <NodeCard key={n.id} node={n} pos={positions[n.id]} selected={selected?.id === n.id} onSelect={setSelected} UI={UI} />
              )
            ))}
          </div>
        </div>
      );
    }

    function Notes() {
      return (
        <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
          <div className="flex items-center gap-2 mb-2"><span className="text-amber-300">‚ö†Ô∏è</span><div className="font-semibold">Notas de dise√±o y siguientes pasos</div></div>
          <ul className="text-sm space-y-1 text-slate-300/90">
            <li>‚Ä¢ <b>Contrato de datos</b> del flujo Onboarding: Portal ‚áÑ Metamap ‚áÑ KIBAN ‚áÑ HASE ‚áÑ Odoo.</li>
            <li>‚Ä¢ <b>Webhooks cr√≠ticos</b>: Mifiel (firma), Conekta (pagos), Samsara (eventos/DTC), Asistente (mensajer√≠a).</li>
            <li>‚Ä¢ <b>Historificaci√≥n</b>: Telemetr√≠a y consumo GNV van a Warehouse para BI, XAI y pruebas de estr√©s.</li>
            <li>‚Ä¢ <b>Seguridad</b>: OAuth/token por partner, aislamiento por rutas (tags) y colas idempotentes en iPaaS.</li>
            <li>‚Ä¢ <b>Escala</b>: Arquitectura lista para 17 ‚Üí 1000 unidades con colas y backfill a Warehouse.</li>
          </ul>
        </div>
      );
    }

    function App() {
      const [flow, setFlow] = React.useState('Onboarding & Scoring');
      const [visibleLanes, setVisibleLanes] = React.useState(Object.fromEntries(LANES.map((l) => [l.id, true])));
      const [selected, setSelected] = React.useState(null);
      const [viewportWidth, setViewportWidth] = React.useState(window.innerWidth);

      React.useEffect(() => {
        debug.log('App mount');
        const onResize = () => { debug.log('Resize ‚Üí', window.innerWidth); setViewportWidth(window.innerWidth); };
        window.addEventListener('resize', onResize);
        return () => window.removeEventListener('resize', onResize);
      }, []);

      const UI = viewportWidth < 640 ? UI_SMALL : UI_LARGE;

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100 font-sans">
          <Header flow={flow} setFlow={(f) => { setSelected(null); setFlow(f); }} />
          <div className="max-w-[1400px] mx-auto px-6 py-6 grid grid-cols-12 gap-6">
            <Sidebar visibleLanes={visibleLanes} setVisibleLanes={setVisibleLanes} />
            <main className="col-span-12 lg:col-span-9 space-y-4">
              <Canvas UI={UI} flow={flow} visibleLanes={visibleLanes} selected={selected} setSelected={setSelected} viewportWidth={viewportWidth} />
              <Inspector flow={flow} selected={selected} />
              <Notes />
            </main>
          </div>
        </div>
      );
    }

    // 4) Render y fallbacks
    function mountReact() {
      const container = document.getElementById('root');
      if (!window.React || !window.ReactDOM) {
        debug.error('React no est√° disponible. Mostrando fallback.');
        return; // Deja el fallback est√°tico en el DOM
      }
      try {
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
      } catch (err) {
        debug.error('Fallo al renderizar React:', err);
      }
    }

    // Esperar a que las dependencias con defer est√©n listas
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(mountReact, 0);
    } else {
      window.addEventListener('DOMContentLoaded', mountReact);
    }

    // Guard against runtime errors
    window.addEventListener('error', (e) => debug.error('window.onerror', e.message));
    window.addEventListener('unhandledrejection', (e) => debug.error('unhandledrejection', e.reason));
  </script>
</body>
</html>
