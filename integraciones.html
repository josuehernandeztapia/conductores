<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arquitectura de Integraciones</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Cross-browser scroll container */
    .diagram-scroll-container {
      width: 100%;
      height: calc(100vh - 210px);
      overflow-x: scroll !important;
      overflow-y: auto;
      position: relative;

      /* Firefox */
      scrollbar-width: thin;
      scrollbar-color: #475569 #1e293b;

      /* Safari/WebKit */
      -webkit-overflow-scrolling: touch !important;
    }

    /* Chrome/Edge WebKit scrollbars */
    .diagram-scroll-container::-webkit-scrollbar {
      width: 14px;
      height: 14px;
    }
    .diagram-scroll-container::-webkit-scrollbar-track {
      background: #1e293b;
      border-radius: 4px;
    }
    .diagram-scroll-container::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 4px;
      border: 2px solid #1e293b;
    }
    .diagram-scroll-container::-webkit-scrollbar-corner {
      background: #1e293b;
    }

    /* Inner canvas to force horizontal scrolling */
    .diagram-inner-canvas {
      min-width: 2400px !important;
      width: max-content;
      padding-bottom: 10px;
      position: relative;
      display: block;
    }

    @keyframes pulse {
      0% { 
        transform: scale(1);
        opacity: 1;
      }
      50% { 
        transform: scale(1.05);
        opacity: 0.8;
      }
      100% { 
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Headers sticky mejorados */
    .column-headers {
      position: sticky;
      top: 60px;
      z-index: 25;
      background: linear-gradient(to bottom, 
        rgba(15, 23, 42, 0.98) 0%, 
        rgba(15, 23, 42, 0.95) 90%,
        transparent 100%);
      backdrop-filter: blur(10px);
    }

    /* Animaciones y transiciones para Modo Dual */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-slideIn {
      animation: slideIn 0.5s ease-out;
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }

    /* Transición suave entre vistas */
    .view-transition {
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
  </style>
  
  <style>
    /* Estilos para la Vista de Ejecución */
    .execution-container {
      width: 100%;
      height: calc(100vh - 160px);
      background: linear-gradient(135deg, #0b1220 0%, #1a1f2e 100%);
      border-radius: 24px;
      overflow: hidden;
      position: relative;
      color: #e2e8f0;
    }

    .execution-header {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
      border-bottom: 1px solid rgba(168, 85, 247, 0.3);
      padding: 24px;
      backdrop-filter: blur(10px);
      position: sticky; top: 0; z-index: 20;
    }

    .execution-filters {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .execution-filter-select,
    .execution-filter-input {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 10px 16px;
      color: #e2e8f0;
      font-size: 14px;
      transition: all 0.3s ease;
      min-width: 180px;
    }

    /* Ensure table text is readable on dark background */
    .execution-table,
    .execution-table th,
    .execution-table td { color: #e2e8f0; }
    .execution-table thead th { color: #f1f5f9; }
    .execution-week-badge { color: #e2e8f0; }
    .execution-total-label { color: #cbd5e1; }
    .execution-total-value { color: #e2e8f0; }

    .execution-filter-select:focus,
    .execution-filter-input:focus {
      outline: none;
      border-color: rgba(168, 85, 247, 0.5);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }

    .execution-grid {
      height: calc(100% - 140px);
      overflow: auto;
      padding: 20px;
      position: relative;
      scroll-behavior: smooth;
    }

    .execution-table {
      width: 100%;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .execution-table thead {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Hacer las columnas más visibles */
    .execution-table thead th:nth-child(6),
    .execution-table thead th:nth-child(7) {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05));
      border-left: 2px solid rgba(139, 92, 246, 0.3);
    }

    .execution-table th, .execution-table td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }

    .execution-table tbody tr:hover {
      background: rgba(168, 85, 247, 0.05);
    }

    .execution-week-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 8px;
      padding: 4px 12px;
      font-weight: 700;
      color: #e2e8f0;
    }

    .execution-phase-pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      border: 1px solid;
      white-space: nowrap;
    }

    .phase-1 { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1)); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .phase-2 { background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(249, 115, 22, 0.1)); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3); }
    .phase-3 { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
    .phase-4 { background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1)); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
    .phase-5 { background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.1)); color: #22d3ee; border: 1px solid rgba(6, 182, 212, 0.3); }
    .phase-6 { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
    .phase-7 { background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1)); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3); }
    .phase-8 { background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.1)); color: #a78bfa; border: 1px solid rgba(168, 85, 247, 0.3); }
    .phase-9 { background: linear-gradient(135deg, rgba(217, 70, 239, 0.2), rgba(217, 70, 239, 0.1)); color: #e879f9; border: 1px solid rgba(217, 70, 239, 0.3); }
    .phase-10 { background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(236, 72, 153, 0.1)); color: #f472b6; border: 1px solid rgba(236, 72, 153, 0.3); }
    .phase-11 { background: linear-gradient(135deg, rgba(148, 163, 184, 0.2), rgba(148, 163, 184, 0.1)); color: #cbd5e1; border: 1px solid rgba(148, 163, 184, 0.3); }

    .execution-owner-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 600;
    }

    .owner-lead { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .owner-backend { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .owner-frontend { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .owner-design { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
    .owner-qa { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .owner-mgmt { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }

    .execution-hours {
      font-variant-numeric: tabular-nums;
    }

    .execution-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      border: 1px solid;
      transition: transform 0.2s ease;
      user-select: none;
    }

    .status-pending { background: rgba(148, 163, 184, 0.15); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.3); }
    .status-progress { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
    .status-complete { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }

    .execution-status:hover {
      transform: scale(1.05);
    }

    .execution-totals {
      position: sticky;
      bottom: 0;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      backdrop-filter: blur(10px);
      border-top: 2px solid rgba(168, 85, 247, 0.3);
      padding: 20px;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .execution-total-card {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 12px 20px;
    }

    .execution-total-label {
      display: block;
      font-size: 12px;
      color: #cbd5e1;
    }

    .execution-total-value {
      font-size: 18px;
      font-weight: 800;
      color: #e2e8f0;
    }

    .execution-progress-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 8px;
      border-radius: 12px;
      width: 100%;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .execution-progress-label {
      font-weight: 700;
    }

    .execution-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #14b8a6 100%);
      transition: width 0.6s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #052e2b;
    }

    /* Animaciones para la vista de ejecución */
    @keyframes slideInFromRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .execution-container.animate-in {
      animation: slideInFromRight 0.5s ease-out;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      /* Hide Dependencia column */
      .execution-grid td:nth-child(6),
      .execution-grid th:nth-child(6) { display: none; }
    }

    @media (max-width: 768px) {
      .execution-filters {
        flex-direction: column;
      }
      
      .execution-filter-select,
      .execution-filter-input {
        width: 100%;
      }
      
      .execution-table {
        font-size: 12px;
      }
      .execution-phase-pill { font-size: 10px; }
      .execution-table th { padding: 8px; }
      .execution-table td { padding: 8px; }
      
      .execution-totals {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Collapsible Dependencia column via class */
    .hide-deps td:nth-child(6),
    .hide-deps th:nth-child(6) { display: none; }
  </style>

  <style>
/******************** Execution Plan enhanced CSS ********************/
.owner-lead { 
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1)); 
  color: #10b981; 
  border: 1px solid rgba(16, 185, 129, 0.3);
}
.owner-backend { 
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); 
  color: #3b82f6;
  border: 1px solid rgba(59, 130, 246, 0.3);
}
.owner-frontend { 
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1)); 
  color: #8b5cf6;
  border: 1px solid rgba(139, 92, 246, 0.3);
}
.owner-design { 
  background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(236, 72, 153, 0.1)); 
  color: #ec4899;
  border: 1px solid rgba(236, 72, 153, 0.3);
}
.owner-qa { 
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1)); 
  color: #fbbf24;
  border: 1px solid rgba(251, 191, 36, 0.3);
}
.owner-mgmt { 
  background: linear-gradient(135deg, rgba(156, 163, 175, 0.2), rgba(156, 163, 175, 0.1)); 
  color: #9ca3af;
  border: 1px solid rgba(156, 163, 175, 0.3);
}

.scroll-indicator {
  position: fixed;
  bottom: 100px;
  right: 20px;
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15));
  border: 1px solid rgba(139, 92, 246, 0.3);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  color: #a78bfa;
  animation: pulse 2s infinite;
  z-index: 20;
  pointer-events: none;
}

.week-separator td {
  background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
  font-size: 13px;
  padding: 8px !important;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.compact-mode { font-size: 12px; }
.compact-mode th, .compact-mode td { padding: 6px 10px !important; }
.compact-row td { padding: 4px 8px !important; }
.compact-mode .execution-phase-pill { font-size: 10px; padding: 3px 8px; }
.compact-mode .execution-owner-badge { font-size: 10px; padding: 2px 6px; }

.execution-header {
  position: sticky;
  top: 0;
  z-index: 30;
  background: linear-gradient(to bottom, rgba(15, 23, 42, 0.98) 0%, rgba(15, 23, 42, 0.95) 50%, rgba(15, 23, 42, 0.9) 100%);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(168, 85, 247, 0.2);
  padding: 20px;
  margin: -20px -20px 20px -20px;
}

@media (max-width: 1024px) {
  .hide-mobile { display: none !important; }
  .execution-table { font-size: 13px; }
  .execution-phase-pill { font-size: 11px; }
}

@media (max-width: 768px) {
  .execution-table { font-size: 11px; }
  .execution-table th, .execution-table td { padding: 6px 8px; }
  .execution-filters { gap: 8px; }
  .execution-filter-select, .execution-filter-input { min-width: unset; width: 100%; }
  .execution-totals { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .execution-progress-bar { grid-column: 1 / -1; }
}

.execution-status { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.execution-status:active { transform: scale(0.95); }

.execution-filter-select:focus-visible,
.execution-filter-input:focus-visible,
button:focus-visible {
  outline: 2px solid #a78bfa;
  outline-offset: 2px;
}

[title] { position: relative; }
[title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  white-space: nowrap;
  z-index: 1000;
  pointer-events: none;
  margin-bottom: 4px;
}

/* Columnas técnicas con mejor visibilidad */
  .tech-column {
    background: rgba(99, 102, 241, 0.02);
    border-left: 1px solid rgba(99, 102, 241, 0.2);
    border-right: 1px solid rgba(99, 102, 241, 0.2);
  }

.stack-cell, .entregable-cell {
  max-width: 250px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  cursor: help;
}

.stack-cell {
  background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
  color: #93bbfc;
  border-left: 2px solid #3b82f6;
}

.entregable-cell {
  background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent);
  color: #6ee7b7;
  border-left: 2px solid #10b981;
}

/* Tooltip nativo al hover */
.stack-cell:hover, .entregable-cell:hover {
  white-space: normal;
  word-wrap: break-word;
  max-width: 350px;
  position: absolute;
  z-index: 100;
  background: rgba(15, 23, 42, 0.98);
  padding: 12px;
  border: 1px solid rgba(99, 102, 241, 0.4);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  margin-top: -10px;
}

/* Ancho mínimo de tabla para acomodar nuevas columnas */
.execution-table {
  min-width: 1400px;
}

/* Responsive - ocultar en pantallas pequeñas */
@media (max-width: 1400px) {
  .tech-column {
    display: none !important;
  }
}
  </style>

</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState, useEffect, useRef } = React;
    // Icon placeholders (lucide-react no UMD en navegador)
    const PlaceholderIcon = ({ className }) => <span className={className} style={{ display: 'inline-block' }}>●</span>;
    const Layers = ({ className }) => <span className={className}>⬢</span>;
    const PlayCircle = ({ className }) => <span className={className}>▶</span>;
    const ArrowRightLeft = ({ className }) => <span className={className}>⇄</span>;
    const ShieldCheck = ({ className }) => <span className={className}>🛡</span>;
    const Cable = ({ className }) => <span className={className}>🔌</span>;
    const Users = ({ className }) => <span className={className}>👥</span>;
    const ServerCog = ({ className }) => <span className={className}>⚙</span>;
    const Database = ({ className }) => <span className={className}>💾</span>;
    const BarChart3 = ({ className }) => <span className={className}>📊</span>;
    const FileSignature = ({ className }) => <span className={className}>✍</span>;
    const CreditCard = ({ className }) => <span className={className}>💳</span>;
    const MessageSquare = ({ className }) => <span className={className}>💬</span>;
    const Fuel = ({ className }) => <span className={className}>⛽</span>;
    const Bot = ({ className }) => <span className={className}>🤖</span>;
    const Zap = ({ className }) => <span className={className}>⚡</span>;
    const AlertTriangle = ({ className }) => <span className={className}>⚠</span>;
    const Workflow = ({ className }) => <span className={className}>⚙</span>;
    const GitBranch = ({ className }) => <span className={className}>🔀</span>;

    const LANE_WIDTH = 320;
    const LANE_GAP = 28;
    const ROW_HEIGHT = 160;
    const CARD_W = 290;
    const CARD_H = 140;
    const PADDING_X = 24;
    const PADDING_Y = 96;

    const COLORS = {
      external: "from-sky-500/20 to-sky-400/10 border-sky-400/40",
      internal: "from-emerald-500/20 to-emerald-400/10 border-emerald-400/40",
      data: "from-fuchsia-500/20 to-fuchsia-400/10 border-fuchsia-400/40",
      orchestration: "from-amber-500/20 to-amber-400/10 border-amber-400/40",
      telematics: "from-cyan-500/20 to-cyan-400/10 border-cyan-400/40",
      front: "from-teal-500/20 to-teal-400/10 border-teal-400/40",
    };

    const LANES = [
      { id: "front", title: "Fronts / Canales", icon: <Layers className="w-4 h-4" /> },
      { id: "orchestration", title: "Orquestación (iPaaS)", icon: <Workflow className="w-4 h-4" /> },
      { id: "external", title: "Servicios Externos (SaaS / Partners)", icon: <Cable className="w-4 h-4" /> },
      { id: "telematics", title: "Telemática / Operación", icon: <ServerCog className="w-4 h-4" /> },
      { id: "internal", title: "Plataforma Interna (Core)", icon: <Users className="w-4 h-4" /> },
      { id: "data", title: "Datos, IA y BI", icon: <Database className="w-4 h-4" /> },
    ];

    const NODES = [
      {
        id: "portal",
        lane: "front",
        row: 0,
        title: "Portal Cliente (Web/App)",
        subtitle: "Onboarding + Panel básico",
        type: "front",
        icon: <PlayCircle className="w-4 h-4" />,
        io: {
          in: ["Links Mifiel / Pago", "Mensajes Asistente"],
          out: ["Datos KYC", "Documentos", "Eventos UI"],
        },
        ficha: {
          proceso: "Canal digital (Web/App) de onboarding y postventa",
          costo: "N/A (propio)",
          justificacion: "Punto de entrada del cliente; integra KYC (Metamap), pagos (Conekta) y firma (Mifiel) vía iPaaS para cerrar el contrato sin fricción."
        }
      },
      {
        id: "whatsapp",
        lane: "front",
        row: 1,
        title: "WhatsApp Asistente (Flowise)",
        subtitle: "Soporte y postventa",
        type: "front",
        icon: <MessageSquare className="w-4 h-4" />,
        io: {
          in: ["Alertas PMA/PIA", "Recordatorios pago"],
          out: ["Respuestas cliente", "Tickets postventa"],
        },
        ficha: {
          proceso: "Comunicaciones (CPaaS) & Desarrollo Low-Code de IA",
          costo: "~$0.005 USD / mensaje (Twilio) + Tarifa de Meta | Costo de Infraestructura + APIs LLM (Flowise)",
          justificacion: "Es la columna vertebral de nuestros agentes PIA y Asistente Digital. Usamos el canal nativo del operador (WhatsApp) y Flowise como la plataforma visual donde nuestro equipo construye, prueba y despliega rápidamente nuestros agentes conversacionales."
        }
      },
      {
        id: "ipaas",
        lane: "orchestration",
        row: 0,
        title: "Make / n8n / Zapier",
        subtitle: "Flujos y conectores",
        type: "orchestration",
        icon: <GitBranch className="w-4 h-4" />,
        io: {
          in: ["Webhooks Samsara/Conekta", "Eventos Portal"],
          out: ["Acciones en Odoo/Airtable", "Notificaciones Asistente"],
        },
        ficha: {
          proceso: "Orquestación y Automatización (iPaaS)",
          costo: "$30k MXN / año (Presupuestado)",
          justificacion: "El 'Pegamento Digital'. Conecta todas nuestras APIs externas (Conekta, Samsara, Mifiel) con nuestros sistemas internos (Odoo, Agentes IA). Nos permite automatizar flujos en horas, no semanas."
        }
      },
      {
        id: "metamap",
        lane: "external",
        row: 0,
        title: "Metamap (KYC)",
        subtitle: "INE/CURP/biometría",
        type: "external",
        icon: <ShieldCheck className="w-4 h-4" />,
        io: {
          in: ["Datos del solicitante"],
          out: ["Resultado KYC", "Pruebas biométricas"],
        },
        ficha: {
          proceso: "Onboarding y Verificación (KYC)",
          costo: "$1 - $2.50 USD / verificación",
          justificacion: "Prevención de Fraude. Valida la identidad del operador (INE, biometría) antes de firmar. Es nuestro primer filtro de seguridad."
        }
      },
      {
        id: "kiban",
        lane: "external",
        row: 1,
        title: "KIBAN ↔ Círculo de Crédito",
        subtitle: "Consulta y Reporte",
        type: "external",
        icon: <BarChart3 className="w-4 h-4" />,
        io: {
          in: ["Identificadores solicitante", "Estado de cuenta (opcional)", "Eventos de pago"],
          out: ["Reporte de crédito (consulta)", "Estatus de envío (reporte mensual)"]
        },
        ficha: {
          proceso: "Acelerador de Crédito y Cumplimiento",
          costo: "~$30,000 - $40,000 MXN / mes",
          justificacion: "Eficiencia Regulatoria. Lo usamos como un 'plug-in' para dos tareas complejas: consultar el historial del Buró/Círculo de Crédito (como un input para HASE) y automatizar el reporte mensual de nuestra cartera, quitándonos una carga de cumplimiento masiva."
        }
      },
      {
        id: "mifiel",
        lane: "external",
        row: 2,
        title: "Mifiel",
        subtitle: "Firma electrónica avanzada",
        type: "external",
        icon: <FileSignature className="w-4 h-4" />,
        io: {
          in: ["Contrato generado (PDF)", "Datos firmantes"],
          out: ["Evidencia y hash", "Webhook de estatus"],
        },
        ficha: {
          proceso: "Firma Electrónica de Contratos",
          costo: "~$15 - $90 MXN / contrato",
          justificacion: "Certeza Jurídica. Para firmar el contrato de arrendamiento y la dación en pago con validez legal irrefutable en México (NOM-151 y e.firma). Es el pilar de nuestra cartera de activos."
        }
      },
      {
        id: "conekta",
        lane: "external",
        row: 3,
        title: "Conekta",
        subtitle: "Cobros (tarjeta / OXXO)",
        type: "external",
        icon: <CreditCard className="w-4 h-4" />,
        io: {
          in: ["Orden de pago", "Referencia OXXO"],
          out: ["Webhook pago/fracaso/refund", "Liquidaciones"],
        },
        ficha: {
          proceso: "Procesamiento de Pagos",
          costo: "~3.4% + $3 MXN (tarjeta) | ~2.6% + $3 MXN (efectivo)",
          justificacion: "Flujo de Caja. Su red de pagos en efectivo es indispensable para nuestro mercado no bancarizado."
        }
      },
      {
        id: "gnv",
        lane: "external",
        row: 4,
        title: "APIs Estaciones GNV",
        subtitle: "Consumo / Carga",
        type: "external",
        icon: <Fuel className="w-4 h-4" />,
        io: {
          in: ["ID unidad / tag"],
          out: ["Volumen/importe/estación", "Timestamp"],
        },
        ficha: {
          proceso: "Consumo de GNV y recaudo automático",
          costo: "Variable por estación (no consolidado)",
          justificacion: "Habilita el esquema 'se paga solo' aplicando recaudo automático del ahorro de combustible y alimenta PMA/BI con hábitos de carga."
        }
      },
      {
        id: "samsara",
        lane: "telematics",
        row: 0,
        title: "Samsara (VG55 / EI21)",
        subtitle: "GPS, OBD-II, Códigos falla, Inmovilizador",
        type: "telematics",
        icon: <Zap className="w-4 h-4" />,
        io: {
          in: ["Config / tags", "Órdenes de inmovilización"],
          out: [
            "Ubicación/velocidad/RPM",
            "Códigos DTC y DVIR",
            "Webhooks eventos",
          ],
        },
        ficha: {
          proceso: "Telemática e IoT",
          costo: "$100-150 USD / hardware (único) | $20-40 USD / mes (incluye datos)",
          justificacion: "Generación de Datos. Es el 'sistema nervioso' de nuestras vagonetas. Nos provee los datos del OBD-II para alimentar a HASE y Super-PMA y la capacidad de paro de motor remoto nativa."
        }
      },
      {
        id: "odoo",
        lane: "internal",
        row: 0,
        title: "Odoo (ERP / CRM / Field Service)",
        subtitle: "Clientes, contratos, cartera, servicios",
        type: "internal",
        icon: <ArrowRightLeft className="w-4 h-4" />,
        io: {
          in: [
            "Resultado KYC/Crédito",
            "Webhook firma y pagos",
            "Alertas PMA/PIA",
          ],
          out: [
            "Contrato (PDF)",
            "Facturas / estados de cuenta",
            "Órdenes de servicio",
          ],
        },
        ficha: {
          proceso: "ERP y Core Operativo",
          costo: "~$274 MXN / usuario / mes (Plan Personalizado)",
          justificacion: "El Corazón de la Operación. Es nuestro 'sistema operativo central' con módulos nativos de Inventario, Servicios y CRM diseñados para la complejidad de nuestra postventa. Su API externa es indispensable para que nuestra IA se comunique con la operación."
        }
      },
      {
        id: "airtable",
        lane: "internal",
        row: 1,
        title: "Airtable (Ops Board)",
        subtitle: "Backoffice, colas, SLAs",
        type: "internal",
        icon: <Layers className="w-4 h-4" />,
        io: {
          in: ["Eventos iPaaS", "Datos Odoo"],
          out: ["Tareas y estados", "Feeds de control"],
        },
        ficha: {
          proceso: "Backoffice y coordinación operativa (Ops Board)",
          costo: "Depende de asientos/plan",
          justificacion: "Tablero táctico para colas, SLAs y control operativo; se integra vía iPaaS con Odoo y agentes para acelerar la operación sin desarrollar herramientas internas."
        }
      },
      {
        id: "hase",
        lane: "data",
        row: 0,
        title: "HASE (Scoring operativo)",
        subtitle: "Score hiper-adaptativo",
        type: "data",
        icon: <Bot className="w-4 h-4" />,
        io: {
          in: ["KYC Metamap", "Consulta KIBAN", "Colateral social"],
          out: ["Decisión + explicabilidad", "Recomendación de términos"],
        },
        ficha: {
          proceso: "Scoring hiper-adaptativo (IA propietaria)",
          costo: "N/A (propio)",
          justificacion: "Nuestro 'cerebro' para evaluar riesgo y proponer términos usando señales de Metamap, KIBAN y telemática; alimenta Odoo para ejecución."
        }
      },
      {
        id: "pia",
        lane: "data",
        row: 1,
        title: "PIA (Intervención proactiva)",
        subtitle: "Cobranza empática",
        type: "data",
        icon: <AlertTriangle className="w-4 h-4" />,
        io: {
          in: ["Eventos de pago Conekta", "Telemática / hábitos"],
          out: ["Planes flexibles", "Mensajes Asistente"],
        },
        ficha: {
          proceso: "Cobranza empática (IA + CPaaS)",
          costo: "Variable CPaaS (Twilio/Meta) + Infra IA",
          justificacion: "Interviene proactivamente con planes flexibles y mensajes personalizados; se orquesta con Flowise y opera en WhatsApp (Twilio)."
        }
      },
      {
        id: "pma",
        lane: "data",
        row: 2,
        title: "PMA (Mto. predictivo)",
        subtitle: "Alertas y órdenes",
        type: "data",
        icon: <ServerCog className="w-4 h-4" />,
        io: {
          in: ["DTCs / RPM / temperaturas", "DVIR, consumo GNV"],
          out: ["Orden de servicio Odoo", "Tips Asistente"],
        },
        ficha: {
          proceso: "Mantenimiento Predictivo Asistido",
          costo: "N/A (propio) + Telemetría",
          justificacion: "Detecta anomalías y genera órdenes de servicio en Odoo a partir de DTCs/telemetría (Samsara) y hábitos de consumo GNV."
        }
      },
      {
        id: "assistant",
        lane: "data",
        row: 3,
        title: "Asistente Postventa (Flowise)",
        subtitle: "WhatsApp + flujos",
        type: "data",
        icon: <MessageSquare className="w-4 h-4" />,
        io: {
          in: ["Alertas PIA/PMA", "Datos de contrato"],
          out: ["Conversaciones", "Confirmaciones"],
        },
        ficha: {
          proceso: "Comunicaciones (CPaaS) & Desarrollo Low-Code de IA",
          costo: "~$0.005 USD / mensaje (Twilio) + Tarifa de Meta | Costo de Infraestructura + APIs LLM (Flowise)",
          justificacion: "Es la columna vertebral de nuestros agentes PIA y Asistente Digital. Usamos el canal nativo del operador (WhatsApp) y Flowise como la plataforma visual donde nuestro equipo construye, prueba y despliega rápidamente nuestros agentes conversacionales."
        }
      },
      {
        id: "warehouse",
        lane: "data",
        row: 4,
        title: "Data Lake / Warehouse",
        subtitle: "Historificación + BI",
        type: "data",
        icon: <Database className="w-4 h-4" />,
        io: {
          in: ["Batch/Streams telemática", "ERP/finanzas"],
          out: ["Dashboards, XAI, stress tests"],
        },
        ficha: {
          proceso: "Historificación y analítica (SSOT)",
          costo: "Depende de stack (almacenamiento/compute)",
          justificacion: "Fuente única de verdad para BI/XAI y pruebas de estrés; ingiere streams de telemática y datos operativos para modelado y reporting."
        }
      },
      {
        id: "bi",
        lane: "data",
        row: 5,
        title: "BI (Looker/Power BI)",
        subtitle: "KPIs y reporting",
        type: "data",
        icon: <BarChart3 className="w-4 h-4" />,
        io: {
          in: ["Modelos semánticos"],
          out: ["Tableros Operación/Finanzas/Calidad"],
        },
        ficha: {
          proceso: "KPIs y reporting ejecutivo",
          costo: "Licenciamiento según herramienta (Looker/Power BI)",
          justificacion: "Tableros accionables sobre modelos semánticos del warehouse para operación, finanzas y calidad."
        }
      },
      {
        id: "twilio",
        lane: "external",
        row: 2.5,
        title: "Twilio (SMS/WhatsApp)",
        subtitle: "CPaaS para notificaciones",
        type: "external",
        icon: <MessageSquare className="w-4 h-4" />,
        io: {
          in: ["Plantillas", "Destinatarios"],
          out: ["SMS enviados", "WhatsApp entregados"],
        },
        ficha: {
          proceso: "Comunicaciones transaccionales",
          costo: "~$0.005 USD / mensaje",
          justificacion: "Canal crítico de comunicación con operadores."
        }
      },
      {
        id: "gateway",
        lane: "internal",
        row: 0.5,
        title: "API Gateway (BFF)",
        subtitle: "Orquestación y seguridad",
        type: "internal",
        icon: <GitBranch className="w-4 h-4" />,
        io: {
          in: ["Requests del Portal", "Tokens OAuth"],
          out: ["Respuestas normalizadas", "Rate limiting"],
        },
        ficha: {
          proceso: "Backend for Frontend",
          costo: "N/A (propio)",
          justificacion: "Punto único de entrada, maneja auth, rate limiting y normalización de respuestas."
        }
      },
      {
        id: "geotab",
        lane: "telematics",
        row: 1.5,
        title: "Geotab (Futuro)",
        subtitle: "Telemetría avanzada",
        type: "telematics",
        icon: <Zap className="w-4 h-4" />,
        io: {
          in: ["Config avanzada", "Plugins IOX"],
          out: ["Diagnóstico profundo", "Extensiones"],
        },
        ficha: {
          proceso: "Telemetría Enterprise",
          costo: "~$35-50 USD/mes por unidad",
          justificacion: "Upgrade futuro para flotas grandes con necesidades avanzadas de diagnóstico."
        }
      }
    ];

    function computePositions(nodes) {
      const laneIndex = Object.fromEntries(LANES.map((l, i) => [l.id, i]));
      const positions = {};
      nodes.forEach((n) => {
        const x =
          PADDING_X +
          laneIndex[n.lane] * (LANE_WIDTH + LANE_GAP) +
          (LANE_WIDTH - CARD_W) / 2;
        const y = PADDING_Y + n.row * ROW_HEIGHT;
        positions[n.id] = { x, y };
      });
      return positions;
    }

    const FLOWS = {
      "Onboarding & Scoring": [
        ["portal", "metamap"],
        ["metamap", "ipaas"],
        ["ipaas", "kiban"],
        ["kiban", "hase"],
        ["hase", "odoo"],
        ["odoo", "mifiel"],
        ["mifiel", "ipaas"],
        ["ipaas", "odoo"],
      ],
      "Desembolso & Entrega": [
        ["odoo", "conekta"],
        ["conekta", "ipaas"],
        ["ipaas", "odoo"],
        ["odoo", "samsara"],
        ["odoo", "whatsapp"],
      ],
      "Operación & PMA": [
        ["samsara", "ipaas"],
        ["ipaas", "pma"],
        ["pma", "odoo"],
        ["pma", "assistant"],
        ["gnv", "warehouse"],
        ["samsara", "warehouse"],
        ["warehouse", "bi"],
      ],
      "Cobranza & PIA": [
        ["conekta", "ipaas"],
        ["ipaas", "pia"],
        ["pia", "assistant"],
        ["assistant", "odoo"],
      ],
      "Garantías & Postventa": [
        ["samsara", "pma"],
        ["pma", "odoo"],
        ["assistant", "odoo"],
      ],
      "Reporte Buró (mensual)": [
        ["odoo", "kiban"],
        ["kiban", "odoo"],
      ],
    };

    function Edge({ from, to, positions, active }) {
      const a = positions[from];
      const b = positions[to];
      if (!a || !b) return null;
      const x1 = a.x + CARD_W;
      const y1 = a.y + CARD_H / 2;
      const x2 = b.x;
      const y2 = b.y + CARD_H / 2;
      const dx = Math.max(80, (x2 - x1) * 0.5);
      const path = `M ${x1} ${y1} C ${x1 + dx} ${y1}, ${x2 - dx} ${y2}, ${x2} ${y2}`;
      return (
        <path
          d={path}
          className={
            active
              ? "stroke-teal-400/80 [filter:drop-shadow(0_0_6px_rgba(45,212,191,0.6))]"
              : "stroke-slate-400/30"
          }
          strokeWidth={active ? 3 : 2}
          fill="none"
        />
      );
    }

    function NodeCard({ node, pos, selected, onSelect }) {
      const color = COLORS[node.type];
      return (
        <div
          onClick={() => onSelect?.(node)}
          title={node.subtitle}
          className={`absolute rounded-2xl border backdrop-blur px-3.5 py-3 cursor-pointer transition-all duration-200 hover:scale-[1.02] hover:shadow-xl hover:border-teal-400/50 bg-gradient-to-br ${color} ${
            selected ? "ring-2 ring-teal-400/70" : "ring-0"
          }`}
          style={{ left: pos.x, top: pos.y, width: CARD_W, height: CARD_H }}
        >
          <div className="flex items-start gap-2">
            <div className="shrink-0 mt-0.5 text-slate-300">{node.icon}</div>
            <div className="min-w-0">
              <div className="text-slate-100 font-extrabold leading-tight text-[16px] sm:text-[18px] truncate">
                {node.title}
              </div>
              <div className="text-slate-300/90 font-bold text-[13px] sm:text-[14px] truncate">{node.subtitle}</div>
            </div>
          </div>
          <div className="mt-2 grid grid-cols-2 gap-2 text-[13px] font-semibold text-slate-200">
            <div>
              <div className="uppercase tracking-wide text-[12px] font-bold text-slate-300">IN</div>
              <div className="space-y-0.5">
                {node.io.in.slice(0, 2).map((t, i) => (
                  <div key={i} className="truncate">• {t}</div>
                ))}
              </div>
            </div>
            <div>
              <div className="uppercase tracking-wide text-[12px] font-bold text-slate-300">OUT</div>
              <div className="space-y-0.5">
                {node.io.out.slice(0, 2).map((t, i) => (
                  <div key={i} className="truncate">• {t}</div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Componente de Vista de Ejecución
    const ExecutionPlanView = () => {
      const [viewMode, setViewMode] = useState('expanded');
      const [showScrollHint, setShowScrollHint] = useState(false);
      const [showTechnicalColumns, setShowTechnicalColumns] = useState(true);
      
      const [filters, setFilters] = useState({
        phase: '',
        owner: '',
        search: '',
        status: '',
        week: ''
      });
      
      const [tasks, setTasks] = useState(() => {
        const defaultTasks = [
          // FASE 1: Arquitectura & Setup (70h)
          {id: 1, w:1, phase:'1. Arquitectura & Setup', task:'Definir arquitectura, repos y ramas', owner:'Tech Lead', h:8, dep:'', status:'Pendiente', stack:'GitHub/GitFlow, ADRs', entregable:'ADR-001 + monorepo'},
          {id: 2, w:1, phase:'1. Arquitectura & Setup', task:'Pipelines CI/CD (build, test, deploy)', owner:'Tech Lead', h:12, dep:'Arquitectura', status:'Pendiente', stack:'GitHub Actions, Docker', entregable:'ci.yml, deploy.yml'},
          {id: 3, w:1, phase:'1. Arquitectura & Setup', task:'Provisionar DB, buckets y secretos', owner:'Tech Lead', h:12, dep:'Arquitectura', status:'Pendiente', stack:'PostgreSQL, Redis, S3/MinIO', entregable:'Infra + secretos'},
          {id: 4, w:1, phase:'1. Arquitectura & Setup', task:'Base diseño UI (tokens, componentes)', owner:'UX/UI Design', h:20, dep:'', status:'Pendiente', stack:'Tailwind, Design tokens', entregable:'Kit componentes'},
          {id: 5, w:1, phase:'1. Arquitectura & Setup', task:'Smoke tests y checklists', owner:'QA Engineer', h:10, dep:'CI/CD', status:'Pendiente', stack:'Pytest, Playwright', entregable:'Suite mínima'},
          {id: 6, w:2, phase:'1. Arquitectura & Setup', task:'CI/CD hardening', owner:'Tech Lead', h:8, dep:'CI/CD', status:'Pendiente', stack:'Cache, matrix, envs', entregable:'Pipelines robustos'},

          // FASE 2: Core Transaccional + IA Base (196h - EXPANDIDO)
          {id: 7, w:2, phase:'2. Core Transaccional', task:'Portal PWA - Setup inicial', owner:'Frontend Dev', h:16, dep:'Setup', status:'Pendiente', stack:'React, PWA, Tailwind', entregable:'Portal cliente base'},
          {id: 8, w:2, phase:'2. Core Transaccional', task:'API Gateway - Backend for Frontend', owner:'Tech Lead', h:20, dep:'Setup', status:'Pendiente', stack:'Kong/Express, JWT, Rate limit', entregable:'Gateway configurado'},
          {id: 9, w:2, phase:'2. Core Transaccional', task:'Modelado DB (usuarios, vehículos)', owner:'Tech Lead', h:16, dep:'Setup', status:'Pendiente', stack:'SQLAlchemy, Alembic', entregable:'Esquema v1'},
          {id: 10, w:2, phase:'2. Core Transaccional', task:'Odoo ERP - Setup y módulos', owner:'Tech Lead', h:24, dep:'Modelado', status:'Pendiente', stack:'Odoo Enterprise, XML-RPC', entregable:'ERP configurado'},
          {id: 11, w:2, phase:'2. Core Transaccional', task:'Airtable - Backoffice setup', owner:'Backend Dev', h:8, dep:'Setup', status:'Pendiente', stack:'Airtable API, Webhooks', entregable:'Tableros backoffice'},

          // NUEVAS TAREAS IA/RAG - MOVIDAS A SEMANA 2-3
          {id: 69, w:2, phase:'2. Core Transaccional', task:'OpenAI API - Setup Vision y Embeddings', owner:'Tech Lead', h:16, dep:'Setup', status:'Pendiente', stack:'OpenAI GPT-4o, Vision API', entregable:'API keys configuradas'},
          {id: 70, w:3, phase:'2. Core Transaccional', task:'Pinecone Vector DB - Setup SSOT', owner:'Tech Lead', h:12, dep:'OpenAI', status:'Pendiente', stack:'Pinecone, 1536 dims, cosine', entregable:'Index higer-ssot creado'},
          {id: 71, w:3, phase:'2. Core Transaccional', task:'Flowise base - Deploy en Render', owner:'Backend Dev', h:8, dep:'Setup', status:'Pendiente', stack:'Render.com, Docker, Flowise', entregable:'Flowise en producción'},

          {id: 12, w:3, phase:'2. Core Transaccional', task:'HASE - Motor scoring IA v1', owner:'Tech Lead', h:28, dep:'OpenAI', status:'Pendiente', stack:'Python, scikit-learn, FastAPI', entregable:'API scoring /hase/*'},
          {id: 13, w:3, phase:'2. Core Transaccional', task:'Logs, auditoría y métricas', owner:'Tech Lead', h:16, dep:'Servicios', status:'Pendiente', stack:'OpenTelemetry, Sentry', entregable:'Trazas + métricas'},
          {id: 14, w:3, phase:'2. Core Transaccional', task:'Tests de integración core', owner:'QA Engineer', h:16, dep:'Servicios', status:'Pendiente', stack:'Pytest, Containers', entregable:'Pruebas verdes'},
          {id: 15, w:3, phase:'2. Core Transaccional', task:'Optimización DB e índices', owner:'Tech Lead', h:12, dep:'Modelado', status:'Pendiente', stack:'EXPLAIN, Analyze', entregable:'Índices clave'},

          // FASE 3: Onboarding & Identidad + Ingesta RAG (126h - EXPANDIDO)
          {id: 16, w:3, phase:'3. Onboarding & Identidad', task:'Flujo registro y autenticación', owner:'Tech Lead', h:16, dep:'Core', status:'Pendiente', stack:'OAuth2, JWT, FastAPI', entregable:'/auth/* + roles'},
          {id: 17, w:3, phase:'3. Onboarding & Identidad', task:'UI formularios y validaciones', owner:'Frontend Dev', h:16, dep:'Auth', status:'Pendiente', stack:'React Hook Form, Zod', entregable:'Forms UX'},

          // NUEVA - Ingesta de manuales ANTES de KYC
          {id: 72, w:4, phase:'3. Onboarding & Identidad', task:'Ingesta manuales Higer a Pinecone', owner:'Backend Dev', h:16, dep:'Pinecone', status:'Pendiente', stack:'PDF parsing, Chunking, Embeddings', entregable:'Manuales vectorizados'},
          {id: 73, w:4, phase:'3. Onboarding & Identidad', task:'RAG Chain - Consulta manuales técnicos', owner:'Tech Lead', h:20, dep:'Flowise', status:'Pendiente', stack:'LangChain, Retrieval QA, Pinecone', entregable:'API consulta manuales'},

          {id: 18, w:4, phase:'3. Onboarding & Identidad', task:'Integración Metamap KYC', owner:'Tech Lead', h:26, dep:'UI', status:'Pendiente', stack:'Metamap API, Webhooks', entregable:'Flujo KYC completo'},
          {id: 19, w:4, phase:'3. Onboarding & Identidad', task:'Integración KIBAN Buró Crédito', owner:'Tech Lead', h:24, dep:'KYC', status:'Pendiente', stack:'KIBAN API, Círculo', entregable:'Consulta + reporte'},
          {id: 20, w:4, phase:'3. Onboarding & Identidad', task:'QA onboarding completo', owner:'QA Engineer', h:16, dep:'KYC', status:'Pendiente', stack:'Playwright E2E', entregable:'Casos e2e'},
          {id: 21, w:4, phase:'3. Onboarding & Identidad', task:'Edge cases y resiliencia', owner:'Tech Lead', h:8, dep:'KYC', status:'Pendiente', stack:'Retries, Idempotencia', entregable:'Flujo robusto'},

          // FASE 4: Cobranza & Pagos (98h)
          {id: 22, w:4, phase:'4. Cobranza & Pagos', task:'Backend pagos y conciliación', owner:'Tech Lead', h:20, dep:'Core', status:'Pendiente', stack:'Conekta API, HMAC', entregable:'Órdenes/referencias'},
          {id: 23, w:5, phase:'4. Cobranza & Pagos', task:'Integración Mifiel firma digital', owner:'Tech Lead', h:22, dep:'Pagos', status:'Pendiente', stack:'Mifiel API, PDF gen', entregable:'Contratos firmados'},
          {id: 24, w:5, phase:'4. Cobranza & Pagos', task:'UI referencias y estado pagos', owner:'Frontend Dev', h:16, dep:'Backend pagos', status:'Pendiente', stack:'React, Tailwind', entregable:'Pantalla pagos'},
          {id: 25, w:5, phase:'4. Cobranza & Pagos', task:'Gateway pagos Conekta', owner:'Tech Lead', h:14, dep:'Backend pagos', status:'Pendiente', stack:'Conekta Webhooks', entregable:'Gateway v1'},
          {id: 26, w:5, phase:'4. Cobranza & Pagos', task:'Pruebas fin a fin cobranza', owner:'QA Engineer', h:16, dep:'Integración', status:'Pendiente', stack:'Playwright, Sandbox', entregable:'Suite pagos'},
          {id: 27, w:5, phase:'4. Cobranza & Pagos', task:'Reintentos e idempotencia', owner:'Tech Lead', h:10, dep:'Integración', status:'Pendiente', stack:'Redis, Queues', entregable:'Pagos robustos'},

          // FASE 5: Postventa & Tickets CON RAG (83h)
          {id: 28, w:6, phase:'5. Postventa & Tickets', task:'Modelo y API de tickets', owner:'Tech Lead', h:16, dep:'Core', status:'Pendiente', stack:'FastAPI, SQLAlchemy', entregable:'/tickets API'},
          {id: 29, w:6, phase:'5. Postventa & Tickets', task:'Flowise/PIA agente IA con RAG', owner:'Tech Lead', h:22, dep:'RAG Chain', status:'Pendiente', stack:'Flowise, LangChain, GPT-4o, Pinecone', entregable:'Agente PIA v1 + RAG'},
          {id: 30, w:6, phase:'5. Postventa & Tickets', task:'UI gestor de tickets', owner:'Frontend Dev', h:12, dep:'API', status:'Pendiente', stack:'React, DataGrid', entregable:'Bandeja tickets'},
          {id: 31, w:6, phase:'5. Postventa & Tickets', task:'Automatizaciones básicas', owner:'Backend Dev', h:12, dep:'API', status:'Pendiente', stack:'Celery, Redis', entregable:'Auto-asignación'},
          {id: 32, w:6, phase:'5. Postventa & Tickets', task:'QA tickets y postventa', owner:'QA Engineer', h:12, dep:'UI', status:'Pendiente', stack:'Playwright', entregable:'Test suite'},
          {id: 33, w:6, phase:'5. Postventa & Tickets', task:'SLA y workflows avanzados', owner:'Tech Lead', h:9, dep:'Automatizaciones', status:'Pendiente', stack:'State Machine', entregable:'SLA engine'},

          // FASE 6: Notificaciones (88h)
          {id: 34, w:7, phase:'6. Notificaciones', task:'Servicio notificaciones plantillas', owner:'Tech Lead', h:12, dep:'Core', status:'Pendiente', stack:'Jinja2, Celery', entregable:'/notify API'},
          {id: 35, w:7, phase:'6. Notificaciones', task:'Integración Twilio SMS/WhatsApp', owner:'Tech Lead', h:16, dep:'Servicio notif', status:'Pendiente', stack:'Twilio API, Templates', entregable:'Canales Twilio'},
          {id: 36, w:7, phase:'6. Notificaciones', task:'Make/n8n/Zapier iPaaS central', owner:'Backend Dev', h:20, dep:'Core', status:'Pendiente', stack:'Make, n8n, Zapier', entregable:'30+ flujos auto'},
          {id: 37, w:7, phase:'6. Notificaciones', task:'WhatsApp Business API setup', owner:'Backend Dev', h:14, dep:'Twilio', status:'Pendiente', stack:'Meta Business API', entregable:'Canal WA nativo'},
          {id: 38, w:7, phase:'6. Notificaciones', task:'UI centro notificaciones', owner:'Frontend Dev', h:10, dep:'Servicio notif', status:'Pendiente', stack:'React, WebSocket', entregable:'Inbox notifs'},
          {id: 39, w:7, phase:'6. Notificaciones', task:'QA de notificaciones', owner:'QA Engineer', h:10, dep:'UI', status:'Pendiente', stack:'E2E Testing', entregable:'Test coverage'},
          {id: 40, w:7, phase:'6. Notificaciones', task:'Templates + observabilidad', owner:'Tech Lead', h:6, dep:'Servicio notif', status:'Pendiente', stack:'Grafana, Prometheus', entregable:'KPIs notifs'},

          // FASE 7: Integraciones Externas CON VISION (168h - EXPANDIDO)
          {id: 41, w:8, phase:'7. Integraciones Externas', task:'Samsara telemetría e inmovilizador', owner:'Tech Lead', h:26, dep:'Core', status:'Pendiente', stack:'Samsara API, Webhooks', entregable:'Telemetría activa'},

          // NUEVA - OCR/Vision para VIN y kilometraje
          {id: 74, w:8, phase:'7. Integraciones Externas', task:'Flujo OCR/Vision - VIN y kilometraje', owner:'Tech Lead', h:24, dep:'OpenAI', status:'Pendiente', stack:'GPT-4o Vision, OCR, JSON parse', entregable:'Extracción VIN/KM automática'},

          {id: 42, w:8, phase:'7. Integraciones Externas', task:'Super-PMA mantenimiento predictivo con RAG', owner:'Tech Lead', h:24, dep:'Samsara, RAG', status:'Pendiente', stack:'Python, ML, DTCs, Pinecone RAG', entregable:'Motor PMA v1 + diagnóstico'},
          {id: 43, w:8, phase:'7. Integraciones Externas', task:'APIs GNV consumo combustible', owner:'Backend Dev', h:16, dep:'Core', status:'Pendiente', stack:'REST APIs GNV, OAuth', entregable:'Integración GNV'},

          // NUEVA - Router de severidad/triaje
          {id: 75, w:8, phase:'7. Integraciones Externas', task:'Router severidad - Triaje automático', owner:'Backend Dev', h:16, dep:'Vision, Make', status:'Pendiente', stack:'Make routers, Severity logic', entregable:'Triaje automático activo'},

          {id: 44, w:8, phase:'7. Integraciones Externas', task:'Data Lake & BI setup', owner:'Tech Lead', h:20, dep:'Integraciones', status:'Pendiente', stack:'BigQuery, Looker, S3', entregable:'Lake + dashboards'},
          {id: 45, w:8, phase:'7. Integraciones Externas', task:'UI tiempo real mapa/eventos', owner:'Frontend Dev', h:16, dep:'Telemetría', status:'Pendiente', stack:'Leaflet, WebSocket', entregable:'Mapa en vivo'},
          {id: 46, w:8, phase:'7. Integraciones Externas', task:'Pruebas latencia y resiliencia', owner:'QA Engineer', h:16, dep:'Integraciones', status:'Pendiente', stack:'k6, Locust', entregable:'Report p50/p95'},
          {id: 47, w:8, phase:'7. Integraciones Externas', task:'Retries, backfill e idempotencia', owner:'Tech Lead', h:10, dep:'Integraciones', status:'Pendiente', stack:'Celery, Redis, Locks', entregable:'Sistema robusto'},

          // FASE 8: UI/UX Refinado (104h)
          {id: 48, w:9, phase:'8. UI/UX Refinado', task:'Componentes y estados vacíos', owner:'UX/UI Design', h:24, dep:'Módulos previos', status:'Pendiente', stack:'Figma, Tailwind', entregable:'Empty states'},
          {id: 49, w:9, phase:'8. UI/UX Refinado', task:'Accesibilidad y responsivo', owner:'UX/UI Design', h:20, dep:'Componentes', status:'Pendiente', stack:'WCAG 2.1, axe-core', entregable:'A11y compliance'},
          {id: 50, w:9, phase:'8. UI/UX Refinado', task:'Microcopys y contenido', owner:'Frontend Dev', h:16, dep:'UI/UX', status:'Pendiente', stack:'i18n, Content', entregable:'Copy final'},
          {id: 51, w:9, phase:'8. UI/UX Refinado', task:'Refactor visual y performance', owner:'Tech Lead', h:20, dep:'UI/UX', status:'Pendiente', stack:'React, Lighthouse', entregable:'UI optimizada'},
          {id: 52, w:9, phase:'8. UI/UX Refinado', task:'Design system + tokens', owner:'UX/UI Design', h:24, dep:'Componentes', status:'Pendiente', stack:'Storybook, Tokens', entregable:'DS v1.0'},

          // FASE 9: Seguridad & Roles (87h)
          {id: 53, w:10, phase:'9. Seguridad & Roles', task:'RBAC, auditoría y hardening', owner:'Tech Lead', h:24, dep:'Core', status:'Pendiente', stack:'Casbin, Headers, CSP', entregable:'Security v1'},
          {id: 54, w:10, phase:'9. Seguridad & Roles', task:'Flujos recuperación MFA', owner:'Tech Lead', h:12, dep:'RBAC', status:'Pendiente', stack:'TOTP, SMS, Backup', entregable:'MFA activo'},
          {id: 55, w:10, phase:'9. Seguridad & Roles', task:'Pentest interno y fixes', owner:'QA Engineer', h:16, dep:'Hardening', status:'Pendiente', stack:'OWASP, Burp Suite', entregable:'Vuln report'},
          {id: 56, w:10, phase:'9. Seguridad & Roles', task:'Revisión compliance básico', owner:'Tech Lead', h:20, dep:'RBAC', status:'Pendiente', stack:'GDPR, Políticas', entregable:'Compliance doc'},
          {id: 57, w:10, phase:'9. Seguridad & Roles', task:'Hardening extra y policies', owner:'Tech Lead', h:15, dep:'RBAC', status:'Pendiente', stack:'Rate limit, WAF', entregable:'Hardening v2'},

          // FASE 10: QA & Performance (130h)
          {id: 58, w:11, phase:'10. QA & Performance', task:'Pruebas fin a fin y carga', owner:'QA Engineer', h:30, dep:'Todos', status:'Pendiente', stack:'Playwright, k6', entregable:'Test report'},
          {id: 59, w:11, phase:'10. QA & Performance', task:'Optimización consultas y cachés', owner:'Tech Lead', h:20, dep:'E2E', status:'Pendiente', stack:'Redis, Índices', entregable:'<100ms p95'},
          {id: 60, w:11, phase:'10. QA & Performance', task:'Bug fixing y estabilidad', owner:'Tech Lead', h:20, dep:'E2E', status:'Pendiente', stack:'Sentry, Debug', entregable:'0 bugs críticos'},
          {id: 61, w:11, phase:'10. QA & Performance', task:'Mejoras UX tras hallazgos', owner:'UX/UI Design', h:20, dep:'E2E', status:'Pendiente', stack:'Analytics, Hotjar', entregable:'UX refinements'},
          {id: 62, w:11, phase:'10. QA & Performance', task:'Re-testing y cierre', owner:'QA Engineer', h:20, dep:'Fixes', status:'Pendiente', stack:'Regression suite', entregable:'QA sign-off'},
          {id: 63, w:11, phase:'10. QA & Performance', task:'Regresión adicional', owner:'QA Engineer', h:20, dep:'Fixes', status:'Pendiente', stack:'Full regression', entregable:'Final report'},

          // FASE 11: Gestión & Documentación (52h)
          {id: 64, w:12, phase:'11. Gestión & Documentación', task:'Manual técnico APIs/despliegue', owner:'Tech Lead', h:12, dep:'Cierre QA', status:'Pendiente', stack:'OpenAPI, MkDocs', entregable:'Docs técnicos'},
          {id: 65, w:12, phase:'11. Gestión & Documentación', task:'Guía operativa soporte/runbook', owner:'Backend Dev', h:12, dep:'Cierre QA', status:'Pendiente', stack:'Confluence', entregable:'Runbook'},
          {id: 66, w:12, phase:'11. Gestión & Documentación', task:'Geotab evaluación futura', owner:'Tech Lead', h:2, dep:'Telemetría', status:'Pendiente', stack:'Geotab GO9, MyGeotab', entregable:'POC Geotab'},
          {id: 67, w:12, phase:'11. Gestión & Documentación', task:'Procesos y handover', owner:'Tech Lead', h:16, dep:'Runbook', status:'Pendiente', stack:'Videos, Sesiones', entregable:'Handover'},
          {id: 68, w:12, phase:'11. Gestión & Documentación', task:'Minutas y retro proyecto', owner:'Management', h:10, dep:'Cierre', status:'Pendiente', stack:'Miro, Retro', entregable:'Lessons learned'}
        ];

        try {
          const saved = localStorage.getItem('executionTasks');
          if (saved) {
            const parsed = JSON.parse(saved);
            const isArray = Array.isArray(parsed);
            const hasTechFields = isArray && parsed.every(t => t && typeof t === 'object' && 'stack' in t && 'entregable' in t);
            const correctCount = isArray && parsed.length === 75;
            const totalHours = isArray ? parsed.reduce((acc, t) => acc + (t.h || 0), 0) : 0;
            const isValid = hasTechFields && correctCount && totalHours === 1110;
            if (isValid) return parsed;
          }
        } catch {}

        return defaultTasks;
      });
      
      useEffect(() => {
        localStorage.setItem('executionTasks', JSON.stringify(tasks));
      }, [tasks]);

      useEffect(() => {
        const checkScroll = () => {
          const table = document.querySelector('.execution-table-container');
          if (table) setShowScrollHint(table.scrollWidth > table.clientWidth);
        };
        checkScroll();
        window.addEventListener('resize', checkScroll);
        return () => window.removeEventListener('resize', checkScroll);
      }, []);

      useEffect(() => {
        const handleKeyPress = (e) => {
          if (e.target.tagName === 'INPUT') return;
          switch(e.key.toLowerCase()) {
            case 'f':
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                document.querySelector('.execution-filter-input')?.focus();
              }
              break;
            case 'r':
              if (e.altKey) { e.preventDefault(); handleResetFilters(); }
              break;
            case 'v':
              if (e.altKey) { e.preventDefault(); setViewMode(prev => prev === 'compact' ? 'expanded' : 'compact'); }
              break;
          }
        };
        window.addEventListener('keydown', handleKeyPress);
        return () => window.removeEventListener('keydown', handleKeyPress);
      }, []);

      const phases = [...new Set(tasks.map(t => t.phase))];
      const owners = [...new Set(tasks.map(t => t.owner))];
      const weeks = [...new Set(tasks.map(t => t.w))].sort((a, b) => a - b);

      const handleStatusToggle = (taskId) => {
        setTasks(prevTasks => prevTasks.map(task => {
          if (task.id === taskId) {
            const statusCycle = ['Pendiente', 'En Progreso', 'Completado'];
            const nextIndex = (statusCycle.indexOf(task.status) + 1) % statusCycle.length;
            return { ...task, status: statusCycle[nextIndex] };
          }
          return task;
        }));
      };

      const handleResetFilters = () => {
        setFilters({ phase: '', owner: '', search: '', status: '', week: '' });
      };

      const filteredTasks = tasks.filter(task => {
        if (filters.phase && task.phase !== filters.phase) return false;
        if (filters.owner && task.owner !== filters.owner) return false;
        if (filters.status && task.status !== filters.status) return false;
        if (filters.week && task.w !== parseInt(filters.week)) return false;
        if (filters.search) {
          const searchLower = filters.search.toLowerCase();
          return task.task.toLowerCase().includes(searchLower) ||
                 task.phase.toLowerCase().includes(searchLower) ||
                 task.owner.toLowerCase().includes(searchLower) ||
                 (task.stack && task.stack.toLowerCase().includes(searchLower)) ||
                 (task.entregable && task.entregable.toLowerCase().includes(searchLower));
        }
        return true;
      });

      const tasksByWeek = filteredTasks.reduce((acc, task) => {
        if (!acc[task.w]) acc[task.w] = [];
        acc[task.w].push(task);
        return acc;
      }, {});

      const totals = filteredTasks.reduce((acc, task) => {
        acc.total += task.h;
        if (task.owner === 'Tech Lead') acc.lead += task.h;
        if (task.owner === 'Backend Dev') acc.backend += task.h;
        if (task.owner === 'Frontend Dev') acc.frontend += task.h;
        if (task.owner === 'UX/UI Design') acc.design += task.h;
        if (task.owner === 'QA Engineer') acc.qa += task.h;
        if (task.owner === 'Management') acc.mgmt += task.h;
        return acc;
      }, { total: 0, lead: 0, backend: 0, frontend: 0, design: 0, qa: 0, mgmt: 0 });

      const completedTasks = tasks.filter(t => t.status === 'Completado').length;
      const inProgressTasks = tasks.filter(t => t.status === 'En Progreso').length;
      const progressPercentage = Math.round((completedTasks / tasks.length) * 100);

      const getPhaseClass = (phase) => {
        const phaseNum = phase.match(/^\d+/)?.[0];
        return `phase-${phaseNum}`;
      };

      const getOwnerClass = (owner) => {
        const ownerMap = {
          'Tech Lead': 'owner-lead',
          'Backend Dev': 'owner-backend',
          'Frontend Dev': 'owner-frontend',
          'UX/UI Design': 'owner-design',
          'QA Engineer': 'owner-qa',
          'Management': 'owner-mgmt'
        };
        return ownerMap[owner] || '';
      };

      const getStatusClass = (status) => {
        const statusMap = { 'Pendiente': 'status-pending', 'En Progreso': 'status-progress', 'Completado': 'status-complete' };
        return statusMap[status] || 'status-pending';
      };

      const getStatusIcon = (status) => {
        const icons = { 'Pendiente': '○', 'En Progreso': '◐', 'Completado': '●' };
        return icons[status] || '○';
      };

      return (
        <div className="execution-container animate-in">
          <div className="execution-header sticky top-0 z-30 backdrop-blur-xl bg-slate-950/80">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <h2 className="text-xl font-bold text-white flex items-center gap-3">
                  <span className="text-2xl">📊</span>
                  Plan de Ejecución • 90 Días
                </h2>
                <span className="text-sm text-purple-300 bg-purple-900/20 px-3 py-1 rounded-full">
                  {filteredTasks.length} de {tasks.length} tareas
                </span>
              </div>
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setViewMode(prev => prev === 'compact' ? 'expanded' : 'compact')}
                  className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm font-medium transition-all flex items-center gap-2"
                  title="Alt+V"
                >
                  {viewMode === 'compact' ? '⬚' : '▦'} {viewMode === 'compact' ? 'Expandir' : 'Compactar'}
                </button>
                <button
                  onClick={() => setShowTechnicalColumns(!showTechnicalColumns)}
                  title="Mostrar/Ocultar columnas técnicas"
                  className={`px-3 py-1.5 ${showTechnicalColumns 
                    ? 'bg-purple-600/30 border-purple-400' 
                    : 'bg-slate-700/30 border-slate-600'} 
                    border hover:bg-purple-700/30 text-purple-200 rounded-lg text-sm font-medium transition-all flex items-center gap-2`}
                >
                  {showTechnicalColumns ? '👁️' : '👁️‍🗨️'} {showTechnicalColumns ? 'Ocultar Stack' : 'Mostrar Stack'}
                </button>
              </div>
            </div>

            <div className="execution-filters mt-4">
              <select className="execution-filter-select" value={filters.week} onChange={(e) => setFilters({...filters, week: e.target.value})}>
                <option value="">Todas las semanas</option>
                {weeks.map(week => (<option key={week} value={week}>Semana {week}</option>))}
              </select>

              <select className="execution-filter-select" value={filters.phase} onChange={(e) => setFilters({...filters, phase: e.target.value})}>
                <option value="">Todas las fases</option>
                {phases.map(phase => (<option key={phase} value={phase}>{phase}</option>))}
              </select>

              <select className="execution-filter-select" value={filters.owner} onChange={(e) => setFilters({...filters, owner: e.target.value})}>
                <option value="">Todos los responsables</option>
                {owners.map(owner => (<option key={owner} value={owner}>{owner}</option>))}
              </select>

              <select className="execution-filter-select" value={filters.status} onChange={(e) => setFilters({...filters, status: e.target.value})}>
                <option value="">Todos los estados</option>
                <option value="Pendiente">Pendiente</option>
                <option value="En Progreso">En Progreso</option>
                <option value="Completado">Completado</option>
              </select>

              <div className="relative flex-1">
                <input
                  className="execution-filter-input w-full pr-10"
                  type="text"
                  placeholder="🔍 Buscar... (Ctrl+F)"
                  value={filters.search}
                  onChange={(e) => setFilters({...filters, search: e.target.value})}
                />
                {filters.search && (
                  <button
                    onClick={() => setFilters(f => ({...f, search: ''}))}
                    className="absolute right-0 top-0 h-full px-3 text-slate-400 hover:text-white transition-colors"
                    title="Limpiar búsqueda"
                  >
                    &#x2715;
                  </button>
                )}
              </div>

              <button onClick={handleResetFilters} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-semibold transition-all duration-300 flex items-center gap-2" title="Alt+R">↺ Reset</button>
            </div>

            <div className="flex gap-4 mt-2 text-xs text-slate-500">
              <span>⌨️ Ctrl+F: Buscar</span>
              <span>Alt+R: Reset filtros</span>
              <span>Alt+V: Toggle vista</span>
            </div>
          </div>

          <div className="execution-grid relative">
            <div className="execution-table-container" style={{ overflowX: 'auto', overflowY: 'auto' }}>
              <table className={`execution-table ${viewMode === 'compact' ? 'compact-mode' : ''}`}>
                <thead>
                  <tr>
                    <th style={{width: '60px'}}>Sem</th>
                    <th style={{width: '160px'}}>Fase</th>
                    <th style={{minWidth: '250px'}}>Tarea</th>
                    <th style={{width: '100px'}}>Responsable</th>
                    <th style={{width: '50px'}}>Hrs</th>
                    {showTechnicalColumns && (
                      <>
                        <th style={{minWidth: '180px'}} className="tech-column">Stack/Tools</th>
                        <th style={{minWidth: '180px'}} className="tech-column">Entregable</th>
                      </>
                    )}
                    <th style={{width: '100px'}}>Dependencia</th>
                    <th style={{width: '90px'}}>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.entries(tasksByWeek).map(([week, weekTasks]) => (
                    <React.Fragment key={week}>
                                              <tr className="week-separator">
                          <td colSpan={showTechnicalColumns ? 9 : 7} className="text-center py-2 bg-slate-900/50 text-purple-400 font-semibold">
                            ── Semana {week} ──
                          </td>
                      </tr>
                      {weekTasks.map(task => (
                                                 <tr key={task.id} className={viewMode === 'compact' ? 'compact-row' : ''}>
                           <td><span className="execution-week-badge">W{task.w}</span></td>
                           <td><span className={`execution-phase-pill ${getPhaseClass(task.phase)}`}>{task.phase}</span></td>
                           <td className="font-medium">{task.task}</td>
                           <td><span className={`execution-owner-badge ${getOwnerClass(task.owner)}`}>{task.owner}</span></td>
                           <td className="execution-hours">{task.h}h</td>
                           {showTechnicalColumns && (
                             <>
                               <td className="tech-column">
                                 <div className="text-xs text-blue-300 bg-blue-900/20 px-2 py-1 rounded">
                                   {task.stack}
                                 </div>
                               </td>
                               <td className="tech-column">
                                 <div className="text-xs text-emerald-300 bg-emerald-900/20 px-2 py-1 rounded">
                                   {task.entregable}
                                 </div>
                               </td>
                             </>
                           )}
                          <td className="text-slate-400 text-xs">{task.dep || '-'}</td>
                          <td>
                            <button onClick={() => handleStatusToggle(task.id)} className={`execution-status ${getStatusClass(task.status)}`}>
                              <span>{getStatusIcon(task.status)}</span>
                              <span className="ml-1">{task.status}</span>
                            </button>
                          </td>
                        </tr>
                      ))}
                    </React.Fragment>
                  ))}
                </tbody>
              </table>
            </div>

            {showScrollHint && (
              <div className="scroll-indicator"><span>← Desliza para ver más →</span></div>
            )}
          </div>

          <div className="execution-totals">
            <div className="execution-total-card"><span className="execution-total-label">Total Horas</span><span className="execution-total-value">{totals.total}h</span></div>
            <div className="execution-total-card"><span className="execution-total-label">Tech Lead</span><span className="execution-total-value">{totals.lead}h</span></div>
            <div className="execution-total-card"><span className="execution-total-label">Backend</span><span className="execution-total-value">{totals.backend}h</span></div>
            <div className="execution-total-card"><span className="execution-total-label">Frontend</span><span className="execution-total-value">{totals.frontend}h</span></div>
            <div className="execution-total-card"><span className="execution-total-label">Design</span><span className="execution-total-value">{totals.design}h</span></div>
            <div className="execution-total-card"><span className="execution-total-label">Testing</span><span className="execution-total-value">{totals.qa}h</span></div>
            <div className="flex-1 space-y-2">
              <div className="flex justify-between text-xs text-slate-400"><span>{completedTasks} de {tasks.length} completadas</span><span>{inProgressTasks} en progreso</span></div>
              <div className="execution-progress-bar">
                <div className="execution-progress-fill bg-gradient-to-r from-emerald-500 to-teal-500" style={{ width: `${progressPercentage}%`, transition: 'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)' }}>
                  {progressPercentage > 5 && `${progressPercentage}%`}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    function ConductoresIntegrationsMap() {
      // --- STATE MANAGEMENT ---
      const [flow, setFlow] = useState("Onboarding & Scoring");
      const [visibleLanes, setVisibleLanes] = useState(Object.fromEntries(LANES.map(l => [l.id, true])));
      const [selected, setSelected] = useState(null);
      const [showTimeline, setShowTimeline] = useState(false);
      const [currentPhase, setCurrentPhase] = useState(null);
      const [currentWeek, setCurrentWeek] = useState(1);
      const [hoveredWeek, setHoveredWeek] = useState(null);
      const [viewMode, setViewMode] = useState('timeline'); // 'timeline' | 'technical' | 'execution'
      const [portalLoading, setPortalLoading] = useState(true);

      // --- DATA & CONSTANTS ---
      const TIMELINE_PHASES = { /* ... Data unchanged ... */ };
      const IA_STATUS_90_DAYS = { /* ... Data unchanged ... */ };

      const filteredNodes = useMemo(() => NODES.filter(n => visibleLanes[n.lane]), [visibleLanes]);
      const positions = useMemo(() => computePositions(filteredNodes), [filteredNodes]);
      const activeEdges = FLOWS[flow] || [];
      const width = Math.max(2400, PADDING_X * 2 + LANES.length * (LANE_WIDTH + LANE_GAP));
      const maxRow = Math.max(...filteredNodes.map(n => n.row));
      const height = Math.ceil(PADDING_Y + maxRow * ROW_HEIGHT + CARD_H + 16);

      // --- SUB-COMPONENTS ---
      const AppHeader = ({ viewMode, setViewMode, flow, setFlow, showTimeline, setShowTimeline, setSelected }) => {
        const views = [
          { id: 'timeline', icon: '📅', label: 'Timeline/Blueprint' },
          { id: 'technical', icon: '🔧', label: 'Portal Técnico' },
          { id: 'execution', icon: '📊', label: 'Plan de Ejecución' },
        ];
        return (
          <div className="sticky top-0 z-30 bg-slate-950/80 backdrop-blur-md border-b border-slate-800">
            <div className="max-w-full xl:max-w-[2200px] mx-auto px-6 py-3 flex items-center justify-between gap-4">
              <div className="flex items-center gap-3 flex-shrink-0">
                <ServerCog className="w-6 h-6 text-teal-400" />
                <h1 className="text-lg md:text-xl font-extrabold tracking-tight">Arquitectura de Integraciones</h1>
              </div>
              <div className="flex-1 flex justify-center">
                <div className="flex items-center gap-2 p-1 bg-slate-900 rounded-lg border border-slate-700">
                  {views.map(view => (
                    <button
                      key={view.id}
                      onClick={() => setViewMode(view.id)}
                      className={`px-4 py-1.5 rounded-md text-sm font-semibold transition-all flex items-center gap-2 ${viewMode === view.id ? 'bg-purple-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-700/50'}`}
                    >
                      <span className="text-lg">{view.icon}</span>
                      {view.label}
                    </button>
                  ))}
                </div>
              </div>
              <div className="flex items-center gap-2 overflow-x-auto justify-end" style={{minWidth: '400px'}}>
                {viewMode === 'timeline' && (
                  <>
                    {Object.keys(FLOWS).map(f => (
                      <button key={f} title={`Resaltar flujo: ${f}`}
                        className={`px-3 py-1.5 rounded-lg border text-[12px] whitespace-nowrap transition ${f === flow ? "bg-teal-500/20 border-teal-400 text-teal-200" : "bg-slate-800 border-slate-700 text-slate-300 hover:border-teal-500/40"}`}
                        onClick={() => { setFlow(f); setShowTimeline(false); setSelected(null); }}
                      >{f}</button>
                    ))}
                    <div className="h-6 w-px bg-slate-700 mx-1" />
                    <button
                      className={`px-4 py-1.5 rounded-xl border-2 flex items-center gap-2 text-sm font-bold transition-all transform hover:scale-105 ${showTimeline ? "bg-gradient-to-r from-purple-600 to-blue-600 border-purple-400 text-white shadow-lg" : "bg-slate-800 border-purple-500/50 text-purple-200 hover:shadow-md"}`}
                      onClick={() => { setShowTimeline(!showTimeline); if (!showTimeline) setFlow(null); }}
                    ><span className="text-lg">🚀</span><span>90 Días</span></button>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      };

      const TechnicalPortalView = () => { /* ... Component unchanged ... */ };
      const LoadingOverlay = () => { /* ... Component unchanged ... */ };

      // --- MAIN RENDER ---
      return (
        <div className="min-h-screen bg-slate-950 text-slate-100">
          <AppHeader {...{ viewMode, setViewMode, flow, setFlow, showTimeline, setShowTimeline, setSelected }} />
          <div className="view-transition animate-fadeIn">
            {viewMode === 'timeline' && (
              <>
                {showTimeline && currentPhase && ( <div className="sticky top-0 z-30 mb-2"> {/* Timeline controls */} </div> )}
                <div className="max-w-full xl:max-w-[2200px] mx-auto px-6 py-6 grid grid-cols-12 gap-6">
                  <aside className="col-span-12 lg:col-span-3 space-y-4">{/* Sidebar */}</aside>
                  <main className="col-span-12 lg:col-span-9 space-y-4">
                    <div className="diagram-scroll-container rounded-2xl border bg-slate-950 transition-all duration-300 border-slate-800" style={{ width: '100%', height: 'calc(100vh - 210px)', overflowX: 'scroll', overflowY: 'auto', position: 'relative' }}>
                      <div className="diagram-inner-canvas relative" style={{ minWidth: '2400px', position: 'relative' }}>
                        <svg width={width} height={height} className="block">{/* SVG content */}</svg>
                        {filteredNodes.map(n => <NodeCard key={n.id} node={n} pos={positions[n.id]} selected={selected?.id === n.id} onSelect={setSelected} />)}
                      </div>
                    </div>
                    <div className="grid md:grid-cols-1 gap-4"><div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">{/* Inspector */}</div></div>
                  </main>
                </div>
              </>
            )}
            {viewMode === 'technical' && (
              <div className="p-4 h-[calc(100vh-80px)]">
                <TechnicalPortalView />
              </div>
            )}
            {viewMode === 'execution' && (
              <div className="p-4"><ExecutionPlanView /></div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<ConductoresIntegrationsMap />, document.getElementById('root'));
  </script>
</body>
</html>
