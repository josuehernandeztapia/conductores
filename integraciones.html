<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arquitectura de Integraciones</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/framer-motion@10.18.0/dist/framer-motion.umd.js"></script>

  <style>
    /* Cross-browser scroll container (kept for fallback only) */
    .diagram-scroll-container { width: 100%; height: calc(100vh - 250px); overflow-x: scroll !important; overflow-y: auto; position: relative; scrollbar-width: thin; scrollbar-color: #475569 #1e293b; -webkit-overflow-scrolling: touch !important; }
    .diagram-scroll-container::-webkit-scrollbar { width: 14px; height: 14px; }
    .diagram-scroll-container::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
    .diagram-scroll-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; border: 2px solid #1e293b; }
    .diagram-scroll-container::-webkit-scrollbar-corner { background: #1e293b; }
    .diagram-inner-canvas { min-width: 2400px !important; width: max-content; padding-bottom: 50px; position: relative; display: block; }

    /* Smooth transitions globally */
    * { transition: all 200ms ease-out; }

    /* Pulse glow for active nodes */
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.5); transform: scale(1); }
      50% { box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); transform: scale(1.02); }
    }
    .node-active { animation: pulseGlow 2s infinite; }

    /* Column headers overlay */
    .column-header-overlay { position: absolute; top: 0; left: 0; right: 0; height: 48px; background: linear-gradient(to bottom, rgba(2,6,23,1) 0%, rgba(2,6,23,0.85) 60%, rgba(2,6,23,0) 100%); pointer-events: none; z-index: 10; }
  </style>

</head>
<body class="bg-slate-950">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState, useEffect, useCallback, useRef } = React;
    const FM = window["framerMotion"] || {};
    const motion = FM.motion || (({ children, ...rest }) => <div {...rest}>{children}</div>);
    const AnimatePresence = FM.AnimatePresence || (({ children }) => <>{children}</>);

    // Icon placeholders (lucide-react no UMD en navegador)
    const PlaceholderIcon = ({ className }) => <span className={className} style={{ display: 'inline-block' }}>‚óè</span>;
    const Layers = ({ className }) => <span className={className}>‚¨¢</span>;
    const PlayCircle = ({ className }) => <span className={className}>‚ñ∂</span>;
    const ArrowRightLeft = ({ className }) => <span className={className}>‚áÑ</span>;
    const ShieldCheck = ({ className }) => <span className={className}>üõ°</span>;
    const Cable = ({ className }) => <span className={className}>üîå</span>;
    const Users = ({ className }) => <span className={className}>üë•</span>;
    const ServerCog = ({ className }) => <span className={className}>‚öô</span>;
    const Database = ({ className }) => <span className={className}>üíæ</span>;
    const BarChart3 = ({ className }) => <span className={className}>üìä</span>;
    const FileSignature = ({ className }) => <span className={className}>‚úç</span>;
    const CreditCard = ({ className }) => <span className={className}>üí≥</span>;
    const MessageSquare = ({ className }) => <span className={className}>üí¨</span>;
    const Fuel = ({ className }) => <span className={className}>‚õΩ</span>;
    const Bot = ({ className }) => <span className={className}>ü§ñ</span>;
    const Zap = ({ className }) => <span className={className}>‚ö°</span>;
    const AlertTriangle = ({ className }) => <span className={className}>‚ö†</span>;
    const Workflow = ({ className }) => <span className={className}>‚öô</span>;
    const GitBranch = ({ className }) => <span className={className}>üîÄ</span>;
    const ChevronRight = ({ className }) => <span className={className}>‚Ä∫</span>;

    // Layout + diagram constants (preservados)
    const LANE_WIDTH = 320;
    const LANE_GAP = 28;
    const ROW_HEIGHT = 132;
    const CARD_W = 290;
    const CARD_H = 86;
    const PADDING_X = 24;
    const PADDING_Y = 96;

    // Colores existentes por tipo de nodo (preservados)
    const COLORS = {
      external: "from-sky-500/20 to-sky-400/10 border-sky-400/40",
      internal: "from-emerald-500/20 to-emerald-400/10 border-emerald-400/40",
      data: "from-fuchsia-500/20 to-fuchsia-400/10 border-fuchsia-400/40",
      orchestration: "from-amber-500/20 to-amber-400/10 border-amber-400/40",
      telematics: "from-cyan-500/20 to-cyan-400/10 border-cyan-400/40",
      front: "from-teal-500/20 to-teal-400/10 border-teal-400/40",
    };

    // Paleta de tema consistente
    const THEME = {
      bg: {
        primary: 'bg-slate-950',
        secondary: 'bg-slate-900',
        tertiary: 'bg-slate-800',
        overlay: 'bg-slate-900/50 backdrop-blur-xl'
      },
      accent: {
        purple: 'from-purple-600 to-purple-500',
        blue: 'from-blue-600 to-blue-500',
        teal: 'from-teal-500 to-teal-400'
      },
      states: {
        mvp: '#10b981',
        phase2: '#0ea5e9',
        future: '#f59e0b',
        core: '#0d9488'
      }
    };

    // LANES
    const LANES = [
      { id: "front", title: "Fronts / Canales", icon: <Layers className="w-4 h-4" /> },
      { id: "orchestration", title: "Orquestaci√≥n (iPaaS)", icon: <Workflow className="w-4 h-4" /> },
      { id: "external", title: "Servicios Externos (SaaS / Partners)", icon: <Cable className="w-4 h-4" /> },
      { id: "telematics", title: "Telem√°tica / Operaci√≥n", icon: <ServerCog className="w-4 h-4" /> },
      { id: "internal", title: "Plataforma Interna (Core)", icon: <Users className="w-4 h-4" /> },
      { id: "data", title: "Datos, IA y BI", icon: <Database className="w-4 h-4" /> },
    ];

    // NODES (preservados 17 nodos)
    const NODES = [
      { id: "portal", lane: "front", row: 0, title: "Portal Cliente (Web/App)", subtitle: "Onboarding + Panel b√°sico", type: "front", icon: <PlayCircle className="w-4 h-4" />, io: { in: ["Links Mifiel / Pago", "Mensajes Asistente"], out: ["Datos KYC", "Documentos", "Eventos UI"] }, ficha: { proceso: "Canal digital (Web/App) de onboarding y postventa", costo: "N/A (propio)", justificacion: "Punto de entrada del cliente; integra KYC (Metamap), pagos (Conekta) y firma (Mifiel) v√≠a iPaaS para cerrar el contrato sin fricci√≥n." } },
      { id: "whatsapp", lane: "front", row: 1, title: "WhatsApp Asistente (Flowise)", subtitle: "Soporte y postventa", type: "front", icon: <MessageSquare className="w-4 h-4" />, io: { in: ["Alertas PMA/PIA", "Recordatorios pago"], out: ["Respuestas cliente", "Tickets postventa"] }, ficha: { proceso: "Comunicaciones (CPaaS) & Desarrollo Low-Code de IA", costo: "~$0.005 USD / mensaje (Twilio) + Tarifa de Meta | Costo de Infraestructura + APIs LLM (Flowise)", justificacion: "Es la columna vertebral de nuestros agentes PIA y Asistente Digital. Usamos el canal nativo del operador (WhatsApp) y Flowise como la plataforma visual donde nuestro equipo construye, prueba y despliega r√°pidamente nuestros agentes conversacionales." } },
      { id: "ipaas", lane: "orchestration", row: 0, title: "Make / n8n / Zapier", subtitle: "Flujos y conectores", type: "orchestration", icon: <GitBranch className="w-4 h-4" />, io: { in: ["Webhooks Samsara/Conekta", "Eventos Portal"], out: ["Acciones en Odoo/Airtable", "Notificaciones Asistente"] }, ficha: { proceso: "Orquestaci√≥n y Automatizaci√≥n (iPaaS)", costo: "$30k MXN / a√±o (Presupuestado)", justificacion: "El 'Pegamento Digital'. Conecta todas nuestras APIs externas (Conekta, Samsara, Mifiel) con nuestros sistemas internos (Odoo, Agentes IA). Nos permite automatizar flujos en horas, no semanas." } },
      { id: "metamap", lane: "external", row: 0, title: "Metamap (KYC)", subtitle: "INE/CURP/biometr√≠a", type: "external", icon: <ShieldCheck className="w-4 h-4" />, io: { in: ["Datos del solicitante"], out: ["Resultado KYC", "Pruebas biom√©tricas"] }, ficha: { proceso: "Onboarding y Verificaci√≥n (KYC)", costo: "$1 - $2.50 USD / verificaci√≥n", justificacion: "Prevenci√≥n de Fraude. Valida la identidad del operador (INE, biometr√≠a) antes de firmar. Es nuestro primer filtro de seguridad." } },
      { id: "kiban", lane: "external", row: 1, title: "KIBAN ‚Üî C√≠rculo de Cr√©dito", subtitle: "Consulta y Reporte", type: "external", icon: <BarChart3 className="w-4 h-4" />, io: { in: ["Identificadores solicitante", "Estado de cuenta (opcional)", "Eventos de pago"], out: ["Reporte de cr√©dito (consulta)", "Estatus de env√≠o (reporte mensual)"] }, ficha: { proceso: "Acelerador de Cr√©dito y Cumplimiento", costo: "~$30,000 - $40,000 MXN / mes", justificacion: "Eficiencia Regulatoria. Lo usamos como un 'plug-in' para dos tareas complejas: consultar el historial del Bur√≥/C√≠rculo de Cr√©dito (como un input para HASE) y automatizar el reporte mensual de nuestra cartera, quit√°ndonos una carga de cumplimiento masiva." } },
      { id: "mifiel", lane: "external", row: 2, title: "Mifiel", subtitle: "Firma electr√≥nica avanzada", type: "external", icon: <FileSignature className="w-4 h-4" />, io: { in: ["Contrato generado (PDF)", "Datos firmantes"], out: ["Evidencia y hash", "Webhook de estatus"] }, ficha: { proceso: "Firma Electr√≥nica de Contratos", costo: "~$15 - $90 MXN / contrato", justificacion: "Certeza Jur√≠dica. Para firmar el contrato de arrendamiento y la daci√≥n en pago con validez legal irrefutable en M√©xico (NOM-151 y e.firma). Es el pilar de nuestra cartera de activos." } },
      { id: "conekta", lane: "external", row: 3, title: "Conekta", subtitle: "Cobros (tarjeta / OXXO)", type: "external", icon: <CreditCard className="w-4 h-4" />, io: { in: ["Orden de pago", "Referencia OXXO"], out: ["Webhook pago/fracaso/refund", "Liquidaciones"] }, ficha: { proceso: "Procesamiento de Pagos", costo: "~3.4% + $3 MXN (tarjeta) | ~2.6% + $3 MXN (efectivo)", justificacion: "Flujo de Caja. Su red de pagos en efectivo es indispensable para nuestro mercado no bancarizado." } },
      { id: "gnv", lane: "external", row: 4, title: "APIs Estaciones GNV", subtitle: "Consumo / Carga", type: "external", icon: <Fuel className="w-4 h-4" />, io: { in: ["ID unidad / tag"], out: ["Volumen/importe/estaci√≥n", "Timestamp"] }, ficha: { proceso: "Consumo de GNV y recaudo autom√°tico", costo: "Variable por estaci√≥n (no consolidado)", justificacion: "Habilita el esquema 'se paga solo' aplicando recaudo autom√°tico del ahorro de combustible y alimenta PMA/BI con h√°bitos de carga." } },
      { id: "samsara", lane: "telematics", row: 0, title: "Samsara (VG55 / EI21)", subtitle: "GPS, OBD-II, C√≥digos falla, Inmovilizador", type: "telematics", icon: <Zap className="w-4 h-4" />, io: { in: ["Config / tags", "√ìrdenes de inmovilizaci√≥n"], out: ["Ubicaci√≥n/velocidad/RPM", "C√≥digos DTC y DVIR", "Webhooks eventos"] }, ficha: { proceso: "Telem√°tica e IoT", costo: "$100-150 USD / hardware (√∫nico) | $20-40 USD / mes (incluye datos)", justificacion: "Generaci√≥n de Datos. Es el 'sistema nervioso' de nuestras vagonetas. Nos provee los datos del OBD-II para alimentar a HASE y Super-PMA y la capacidad de paro de motor remoto nativa." } },
      { id: "odoo", lane: "internal", row: 0, title: "Odoo (ERP / CRM / Field Service)", subtitle: "Clientes, contratos, cartera, servicios", type: "internal", icon: <ArrowRightLeft className="w-4 h-4" />, io: { in: ["Resultado KYC/Cr√©dito", "Webhook firma y pagos", "Alertas PMA/PIA"], out: ["Contrato (PDF)", "Facturas / estados de cuenta", "√ìrdenes de servicio"] }, ficha: { proceso: "ERP y Core Operativo", costo: "~$274 MXN / usuario / mes (Plan Personalizado)", justificacion: "El Coraz√≥n de la Operaci√≥n. Es nuestro 'sistema operativo central' con m√≥dulos nativos de Inventario, Servicios y CRM dise√±ados para la complejidad de nuestra postventa. Su API externa es indispensable para que nuestra IA se comunique con la operaci√≥n." } },
      { id: "airtable", lane: "internal", row: 1, title: "Airtable (Ops Board)", subtitle: "Backoffice, colas, SLAs", type: "internal", icon: <Layers className="w-4 h-4" />, io: { in: ["Eventos iPaaS", "Datos Odoo"], out: ["Tareas y estados", "Feeds de control"] }, ficha: { proceso: "Backoffice y coordinaci√≥n operativa (Ops Board)", costo: "Depende de asientos/plan", justificacion: "Tablero t√°ctico para colas, SLAs y control operativo; se integra v√≠a iPaaS con Odoo y agentes para acelerar la operaci√≥n sin desarrollar herramientas internas." } },
      { id: "hase", lane: "data", row: 0, title: "HASE (Scoring operativo)", subtitle: "Score hiper-adaptativo", type: "data", icon: <Bot className="w-4 h-4" />, io: { in: ["KYC Metamap", "Consulta KIBAN", "Colateral social"], out: ["Decisi√≥n + explicabilidad", "Recomendaci√≥n de t√©rminos"] }, ficha: { proceso: "Scoring hiper-adaptativo (IA propietaria)", costo: "N/A (propio)", justificacion: "Nuestro 'cerebro' para evaluar riesgo y proponer t√©rminos usando se√±ales de Metamap, KIBAN y telem√°tica; alimenta Odoo para ejecuci√≥n." } },
      { id: "pia", lane: "data", row: 1, title: "PIA (Intervenci√≥n proactiva)", subtitle: "Cobranza emp√°tica", type: "data", icon: <AlertTriangle className="w-4 h-4" />, io: { in: ["Eventos de pago Conekta", "Telem√°tica / h√°bitos"], out: ["Planes flexibles", "Mensajes Asistente"] }, ficha: { proceso: "Cobranza emp√°tica (IA + CPaaS)", costo: "Variable CPaaS (Twilio/Meta) + Infra IA", justificacion: "Interviene proactivamente con planes flexibles y mensajes personalizados; se orquesta con Flowise y opera en WhatsApp (Twilio)." } },
      { id: "pma", lane: "data", row: 2, title: "PMA (Mto. predictivo)", subtitle: "Alertas y √≥rdenes", type: "data", icon: <ServerCog className="w-4 h-4" />, io: { in: ["DTCs / RPM / temperaturas", "DVIR, consumo GNV"], out: ["Orden de servicio Odoo", "Tips Asistente"] }, ficha: { proceso: "Mantenimiento Predictivo Asistido", costo: "N/A (propio) + Telemetr√≠a", justificacion: "Detecta anomal√≠as y genera √≥rdenes de servicio en Odoo a partir de DTCs/telemetr√≠a (Samsara) y h√°bitos de consumo GNV." } },
      { id: "assistant", lane: "data", row: 3, title: "Asistente Postventa (Flowise)", subtitle: "WhatsApp + flujos", type: "data", icon: <MessageSquare className="w-4 h-4" />, io: { in: ["Alertas PIA/PMA", "Datos de contrato"], out: ["Conversaciones", "Confirmaciones"] }, ficha: { proceso: "Comunicaciones (CPaaS) & Desarrollo Low-Code de IA", costo: "~$0.005 USD / mensaje (Twilio) + Tarifa de Meta | Costo de Infraestructura + APIs LLM (Flowise)", justificacion: "Es la columna vertebral de nuestros agentes PIA y Asistente Digital. Usamos el canal nativo del operador (WhatsApp) y Flowise como la plataforma visual donde nuestro equipo construye, prueba y despliega r√°pidamente nuestros agentes conversacionales." } },
      { id: "warehouse", lane: "data", row: 4, title: "Data Lake / Warehouse", subtitle: "Historificaci√≥n + BI", type: "data", icon: <Database className="w-4 h-4" />, io: { in: ["Batch/Streams telem√°tica", "ERP/finanzas"], out: ["Dashboards, XAI, stress tests"] }, ficha: { proceso: "Historificaci√≥n y anal√≠tica (SSOT)", costo: "Depende de stack (almacenamiento/compute)", justificacion: "Fuente √∫nica de verdad para BI/XAI y pruebas de estr√©s; ingiere streams de telem√°tica y datos operativos para modelado y reporting." } },
      { id: "bi", lane: "data", row: 5, title: "BI (Looker/Power BI)", subtitle: "KPIs y reporting", type: "data", icon: <BarChart3 className="w-4 h-4" />, io: { in: ["Modelos sem√°nticos"], out: ["Tableros Operaci√≥n/Finanzas/Calidad"] }, ficha: { proceso: "KPIs y reporting ejecutivo", costo: "Licenciamiento seg√∫n herramienta (Looker/Power BI)", justificacion: "Tableros accionables sobre modelos sem√°nticos del warehouse para operaci√≥n, finanzas y calidad." } },
    ];

    // Posiciones por lane/row
    function computePositions(nodes) {
      const laneIndex = Object.fromEntries(LANES.map((l, i) => [l.id, i]));
      const positions = {};
      nodes.forEach((n) => {
        const x = PADDING_X + laneIndex[n.lane] * (LANE_WIDTH + LANE_GAP) + (LANE_WIDTH - CARD_W) / 2;
        const y = PADDING_Y + n.row * ROW_HEIGHT;
        positions[n.id] = { x, y };
      });
      return positions;
    }

    // FLOWS (preservado)
    const FLOWS = {
      "Onboarding & Scoring": [["portal", "metamap"], ["metamap", "ipaas"], ["ipaas", "kiban"], ["kiban", "hase"], ["hase", "odoo"], ["odoo", "mifiel"], ["mifiel", "ipaas"], ["ipaas", "odoo"]],
      "Desembolso & Entrega": [["odoo", "conekta"], ["conekta", "ipaas"], ["ipaas", "odoo"], ["odoo", "samsara"], ["odoo", "whatsapp"]],
      "Operaci√≥n & PMA": [["samsara", "ipaas"], ["ipaas", "pma"], ["pma", "odoo"], ["pma", "assistant"], ["gnv", "warehouse"], ["samsara", "warehouse"], ["warehouse", "bi"]],
      "Cobranza & PIA": [["conekta", "ipaas"], ["ipaas", "pia"], ["pia", "assistant"], ["assistant", "odoo"]],
      "Garant√≠as & Postventa": [["samsara", "pma"], ["pma", "odoo"], ["assistant", "odoo"]],
      "Reporte Bur√≥ (mensual)": [["odoo", "kiban"], ["kiban", "odoo"]],
    };

    // TIMELINE_PHASES (contenido preservado, hoisted)
    const TIMELINE_PHASES = {
      "Mes 1: Ignici√≥n Inmediata": { semanas: [1, 2, 3, 4], color: "from-red-500/20 to-orange-500/10", borderColor: "border-red-400/40", nodos_activos: ["portal", "samsara", "metamap", "kiban", "conekta", "mifiel", "odoo"], detalles: [ { semana: 1, titulo: "Kick-off Hardware y Alianzas", herramientas_ids: ["portal", "samsara", "metamap"], tareas: [ "Despliegue Portal Cliente para captaci√≥n inicial", "Orden de compra 17 dispositivos Samsara (VG55 + EI21)", "Instalaci√≥n inmediata en flota Higer 17", "Firma contratos con Metamap, KIBAN, Conekta, Mifiel", "Inicio integraciones API" ], herramientas: ["Portal Cliente", "Samsara", "Metamap", "KIBAN", "Conekta", "Mifiel"], hito: "¬°Telemetr√≠a en tiempo real desde d√≠a 7!" }, { semana: 2, titulo: "Arranque T√©cnico y de Mercado", herramientas_ids: ["portal", "odoo", "metamap", "kiban"], tareas: [ "Despliegue Odoo Enterprise Plan Personalizado", "Configuraci√≥n m√≥dulos CRM y Core Bancario simplificado", "Ofertas formales a COO/PMO y Head of Growth" ], herramientas: ["Odoo Enterprise"], hito: "Plataforma interna lista para primer cliente" }, { semana: 3, titulo: "Ingesta de Datos y Entrenamiento IA", herramientas_ids: ["samsara", "gnv", "warehouse"], tareas: [ "HASE y Super-PMA en modo escucha", "Ingesta datos Samsara de flota Higer", "Construcci√≥n base de datos propietaria", "Integraci√≥n APIs estaciones GNV" ], herramientas: ["AWS/Google Cloud", "Samsara API", "APIs GNV"], hito: "Primeros datos flota y consumo correlacionados" }, { semana: 4, titulo: "Ensamble del Stack Operativo", herramientas_ids: ["odoo", "metamap", "kiban", "conekta", "mifiel"], tareas: [ "Integraci√≥n end-to-end completa", "Odoo ‚Üî Metamap ‚Üî KIBAN ‚Üî Conekta ‚Üî Mifiel", "MVP del Asistente Digital avanza", "17 operadores como cliente objetivo" ], herramientas: ["Odoo", "Metamap", "KIBAN", "Conekta", "Mifiel APIs"], hito: "Stack de originaci√≥n 100% funcional" } ] },
      "Mes 2: Validaci√≥n en Campo": { semanas: [5, 6, 7, 8], color: "from-yellow-500/20 to-green-500/10", borderColor: "border-yellow-400/40", nodos_activos: ["whatsapp", "assistant", "ipaas", "pia", "hase"], detalles: [ { semana: 5, titulo: "Lanzamiento MVP Higer 17", herramientas_ids: ["whatsapp", "assistant", "ipaas"], tareas: [ "Despliegue oficial Asistente Digital", "17 operadores flota Higer como usuarios", "Comunicaci√≥n v√≠a API Twilio" ], herramientas: ["Twilio", "Flowise", "Make/n8n"], hito: "MVP en producci√≥n" }, { semana: 6, titulo: "Medici√≥n KPIs Validaci√≥n", herramientas_ids: ["warehouse"], tareas: [ "Medici√≥n en entorno real y controlado", ">70% automatizaci√≥n", ">95% precisi√≥n OCR", "Recolecci√≥n feedback operadores" ], herramientas: ["Analytics", "Looker Studio"], hito: "Validaci√≥n tecnol√≥gica en campo iniciada" }, { semana: 7, titulo: "Evangelizaci√≥n del Pipeline", herramientas_ids: ["odoo", "warehouse"], tareas: [ "Head of Growth visita 12 rutas pipeline", "Demos funcionales Asistente IA", "Dashboards Looker con datos reales Higer", "Evidencia tangible, no promesas" ], herramientas: ["Odoo CRM", "Looker Studio"], hito: "Pipeline activado con evidencia real" }, { semana: 8, titulo: "Pre-calificaci√≥n Masiva", herramientas_ids: ["metamap", "odoo"], tareas: [ "Preparaci√≥n primeros 50 expedientes", "Flujo Manual Underwriting 1.0", "Recolecci√≥n documentaci√≥n", "KYC inicial de prospectos" ], herramientas: ["Metamap", "Odoo CRM"], hito: "50 operadores pipeline pre-calificados" } ] },
      "Mes 3: Ignici√≥n y Despliegue": { semanas: [9, 10, 11, 12], color: "from-green-500/20 to-blue-500/10", borderColor: "border-green-400/40", nodos_activos: ["odoo", "mifiel", "conekta", "samsara", "pia", "pma", "warehouse"], detalles: [ { semana: 9, titulo: "Primer Comit√© de Cr√©dito", herramientas_ids: ["metamap", "kiban", "odoo"], tareas: [ "Presentaci√≥n 20-30 expedientes", "KYC Metamap completo", "Reporte Bur√≥ v√≠a KIBAN", "Scorecard Cualitativo (HASE v0.1)" ], herramientas: ["Metamap", "KIBAN", "Odoo"], hito: "Primeras aprobaciones de cr√©dito" }, { semana: 10, titulo: "Cierre y Firma Digital", herramientas_ids: ["mifiel", "conekta"], tareas: [ "Comit√© aprueba primer lote", "Env√≠o contratos v√≠a Mifiel", "Recepci√≥n enganches v√≠a Conekta", "10-20 contratos firmados" ], herramientas: ["Mifiel", "Conekta"], hito: "20 contratos firmados digitalmente" }, { semana: 11, titulo: "Ejecuci√≥n √ìrdenes de Compra", herramientas_ids: ["samsara", "odoo"], tareas: [ "Orden de compra 10-20 vagonetas", "Instalaci√≥n Samsara pre-entrega", "Configuraci√≥n unidades", "Preparaci√≥n log√≠stica entrega" ], herramientas: ["Samsara", "Odoo"], hito: "Vagonetas listas para entrega" }, { semana: 12, titulo: "Primeras Unidades en Calle", herramientas_ids: ["samsara", "pia", "whatsapp"], tareas: [ "Entrega vagonetas a operadores", "Samsara transmitiendo en tiempo real", "PIA v1.0 activado - recordatorios pago", "Gesti√≥n comunicaci√≥n inicial" ], herramientas: ["Samsara", "PIA", "Twilio"], hito: "Flota operando y generando revenue + datos" } ] }
    };

    // Hooks
    const useKeyboardShortcuts = ({ onTogglePalette, onClosePalette, onToggleTimeline }) => {
      useEffect(() => {
        const handler = (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); onTogglePalette?.(); }
          if (e.key === 'Escape') { onClosePalette?.(); }
          if (e.key.toLowerCase() === 't') { onToggleTimeline?.(); }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, [onTogglePalette, onClosePalette, onToggleTimeline]);
    };

    const useZoomPan = (initialZoom = 1) => {
      const [zoom, setZoom] = useState(initialZoom);
      const [pan, setPan] = useState({ x: 0, y: 0 });
      const draggingRef = useRef(false);
      const lastRef = useRef({ x: 0, y: 0 });
      const rafRef = useRef(null);
      const accRef = useRef({ dx: 0, dy: 0 });

      const onWheel = useCallback((e) => {
        e.preventDefault();
        const delta = -e.deltaY;
        const factor = delta > 0 ? 1.1 : 0.9;
        setZoom((z) => Math.min(2.5, Math.max(0.4, z * factor)));
      }, []);

      const onMouseDown = useCallback((e) => {
        draggingRef.current = true;
        lastRef.current = { x: e.clientX, y: e.clientY };
      }, []);
      const onMouseMove = useCallback((e) => {
        if (!draggingRef.current) return;
        const dx = e.clientX - lastRef.current.x;
        const dy = e.clientY - lastRef.current.y;
        lastRef.current = { x: e.clientX, y: e.clientY };
        accRef.current.dx += dx;
        accRef.current.dy += dy;
        if (!rafRef.current) {
          rafRef.current = requestAnimationFrame(() => {
            setPan((p) => ({ x: p.x + accRef.current.dx, y: p.y + accRef.current.dy }));
            accRef.current = { dx: 0, dy: 0 };
            rafRef.current = null;
          });
        }
      }, []);
      const onMouseUp = useCallback(() => { draggingRef.current = false; }, []);

      useEffect(() => {
        window.addEventListener('mouseup', onMouseUp);
        return () => window.removeEventListener('mouseup', onMouseUp);
      }, [onMouseUp]);

      const reset = useCallback(() => { setZoom(1); setPan({ x: 0, y: 0 }); }, []);
      return { zoom, pan, setZoom, setPan, onWheel, onMouseDown, onMouseMove, reset };
    };

    // UI components peque√±os
    const ZoomControls = ({ onZoomIn, onZoomOut, onReset }) => (
      <div className="absolute top-4 right-4 z-30 bg-slate-900/80 border border-slate-700 rounded-xl p-1 shadow-lg">
        <div className="flex">
          <button onClick={onZoomOut} className="px-3 py-2 text-slate-200 hover:text-white">‚àí</button>
          <div className="w-px bg-slate-700 my-1" />
          <button onClick={onReset} className="px-3 py-2 text-slate-200 hover:text-white">‚ü≤</button>
          <div className="w-px bg-slate-700 my-1" />
          <button onClick={onZoomIn} className="px-3 py-2 text-slate-200 hover:text-white">Ôºã</button>
        </div>
      </div>
    );

    const MiniMap = ({ zoom, pan, diagramSize }) => (
      <div className="absolute bottom-4 right-4 w-48 h-32 bg-slate-900/80 border border-slate-700 rounded-lg z-30">
        <div className="text-[10px] text-slate-400 p-1">MiniMap</div>
        {/* Placeholder viewport indicator */}
        <div className="mx-2 h-[2px] bg-slate-700" />
      </div>
    );

    const CommandPalette = ({ open, onClose, onChooseNode, nodes }) => {
      const [query, setQuery] = useState('');
      const [index, setIndex] = useState(0);
      useEffect(() => { if (!open) { setQuery(''); setIndex(0); } }, [open]);
      useEffect(() => {
        const onKey = (e) => {
          if (!open) return;
          if (e.key === 'ArrowDown') { e.preventDefault(); setIndex((i) => Math.min(i + 1, filtered.length - 1)); }
          if (e.key === 'ArrowUp') { e.preventDefault(); setIndex((i) => Math.max(i - 1, 0)); }
          if (e.key === 'Enter') { e.preventDefault(); const n = filtered[index]; if (n) { onChooseNode(n); onClose(); } }
        };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [open, index]);
      const filtered = useMemo(() => nodes.filter(n => (n.title + ' ' + n.subtitle).toLowerCase().includes(query.toLowerCase())), [nodes, query]);
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-start justify-center pt-24 bg-black/50 backdrop-blur-sm" onClick={onClose}>
          <div className="w-full max-w-xl bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden" onClick={(e)=>e.stopPropagation()}>
            <div className="p-3 border-b border-slate-800">
              <input autoFocus placeholder="Buscar nodo o acci√≥n‚Ä¶" value={query} onChange={(e)=>setQuery(e.target.value)} className="w-full bg-transparent outline-none text-slate-100 placeholder:text-slate-500" />
            </div>
            <div className="max-h-80 overflow-y-auto">
              {filtered.map((n, i) => (
                <button key={n.id} onClick={()=>{onChooseNode(n); onClose();}} className={`w-full text-left px-4 py-2 text-sm flex items-center gap-2 ${i===index? 'bg-slate-800' : ''}`}>
                  <span className="text-slate-300">{n.icon}</span>
                  <span className="text-slate-200">{n.title}</span>
                  <span className="text-slate-400 text-xs">{n.subtitle}</span>
                </button>
              ))}
              {filtered.length === 0 && <div className="px-4 py-6 text-slate-500 text-sm">Sin resultados</div>}
            </div>
            <div className="p-2 text-[10px] text-slate-500 border-t border-slate-800">Enter para abrir ‚Ä¢ Esc para cerrar</div>
          </div>
        </div>
      );
    };

    const ViewSelector = ({ mode, setMode }) => (
      <div className="inline-flex bg-slate-800/50 rounded-xl p-1 backdrop-blur border border-slate-700">
        <button onClick={()=>setMode('strategic')} data-active={mode==='strategic'} className="px-4 py-2 rounded-lg text-sm font-medium text-slate-300 data-[active=true]:bg-gradient-to-r data-[active=true]:from-purple-600 data-[active=true]:to-blue-600 data-[active=true]:text-white">
          <Layers className="w-4 h-4 mr-2 inline-block" /> Vista Estrat√©gica
        </button>
        <button onClick={()=>setMode('technical')} data-active={mode==='technical'} className="px-4 py-2 rounded-lg text-sm font-medium text-slate-300 data-[active=true]:bg-gradient-to-r data-[active=true]:from-blue-600 data-[active=true]:to-cyan-600 data-[active=true]:text-white">
          <ServerCog className="w-4 h-4 mr-2 inline-block" /> Portal T√©cnico
        </button>
      </div>
    );

    const Breadcrumbs = ({ flow, showTimeline, currentWeek }) => (
      <div className="flex items-center gap-2 text-sm text-slate-400">
        <span>Arquitectura</span>
        <ChevronRight className="w-4 h-4" />
        <span>{flow || 'Vista General'}</span>
        {showTimeline && (
          <>
            <ChevronRight className="w-4 h-4" />
            <span>Semana {currentWeek}</span>
          </>
        )}
      </div>
    );

    // Piezas principales
    function Edge({ from, to, positions, active }) {
      const a = positions[from];
      const b = positions[to];
      if (!a || !b) return null;
      const x1 = a.x + CARD_W;
      const y1 = a.y + CARD_H / 2;
      const x2 = b.x;
      const y2 = b.y + CARD_H / 2;
      const dx = Math.max(80, (x2 - x1) * 0.5);
      const path = `M ${x1} ${y1} C ${x1 + dx} ${y1}, ${x2 - dx} ${y2}, ${x2} ${y2}`;
      return (
        <path d={path} className={active ? "stroke-teal-400/80 [filter:drop-shadow(0_0_6px_rgba(45,212,191,0.6))]" : "stroke-slate-400/30"} strokeWidth={active ? 3 : 2} fill="none" />
      );
    }

    function NodeCard({ node, pos, selected, onSelect, isActiveInWeek, isActiveInPhase }) {
      const color = COLORS[node.type];
      const activeClass = isActiveInWeek ? 'node-active ring-2 ring-purple-400/70' : (isActiveInPhase ? 'ring-2 ring-purple-400/40' : (selected ? 'ring-2 ring-teal-400/70' : 'ring-0'));
      return (
        <div onClick={() => onSelect?.(node)} title={node.subtitle} className={`absolute rounded-2xl border backdrop-blur px-3.5 py-3 cursor-pointer hover:scale-[1.02] hover:shadow-xl hover:border-teal-400/50 bg-gradient-to-br ${color} ${activeClass}`} style={{ left: pos.x, top: pos.y, width: CARD_W, height: CARD_H }}>
          <div className="flex items-start gap-2">
            <div className="shrink-0 mt-0.5 text-slate-300">{node.icon}</div>
            <div className="min-w-0">
              <div className="text-slate-100 font-semibold leading-tight text-[13px] truncate">{node.title}</div>
              <div className="text-slate-300/80 text-[12px] truncate">{node.subtitle}</div>
            </div>
          </div>
          <div className="mt-2 grid grid-cols-2 gap-2 text-[11px] text-slate-300/90">
            <div>
              <div className="uppercase tracking-wide text-[10px] text-slate-400">IN</div>
              <div className="space-y-0.5">{node.io.in.slice(0, 2).map((t, i) => (<div key={i} className="truncate">‚Ä¢ {t}</div>))}</div>
            </div>
            <div>
              <div className="uppercase tracking-wide text-[10px] text-slate-400">OUT</div>
              <div className="space-y-0.5">{node.io.out.slice(0, 2).map((t, i) => (<div key={i} className="truncate">‚Ä¢ {t}</div>))}</div>
            </div>
          </div>
        </div>
      );
    }

    const Sidebar = ({ visibleLanes, setVisibleLanes, showTimeline, flow, setFlow }) => (
      <aside className="w-80 flex-shrink-0 border-r border-slate-800 h-[calc(100vh-64px)] overflow-y-auto p-4 space-y-4">
        <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
          <div className="flex items-center gap-2 mb-2"><Layers className="w-4 h-4 text-slate-300" /><div className="font-semibold">Capas visibles</div></div>
          <div className="space-y-2">
            {LANES.map((l) => (
              <label key={l.id} className="flex items-center justify-between py-1 text-sm">
                <span className="flex items-center gap-2 text-slate-300"><span className="text-slate-400">{l.icon}</span>{l.title}</span>
                <input type="checkbox" className="accent-teal-500" checked={visibleLanes[l.id]} onChange={(e)=> setVisibleLanes((v)=> ({...v, [l.id]: e.target.checked}))} />
              </label>
            ))}
          </div>
        </div>

        {!showTimeline && (
          <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
            <div className="text-xs text-slate-400 mb-2">Blueprint Fast Track</div>
            <div className="space-y-2">
              {Object.keys(TIMELINE_PHASES).map((fase) => (
                <div key={fase} className="px-3 py-2 rounded-lg bg-slate-800/50 text-slate-300 text-sm">{fase}</div>
              ))}
            </div>
          </div>
        )}

        <div className="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
          <div className="text-xs text-slate-400 mb-2">Flujos</div>
          <div className="grid grid-cols-1 gap-2">
            {Object.keys(FLOWS).map((f) => (
              <button key={f} onClick={()=>setFlow(f)} className={`px-3 py-2 rounded-lg text-left text-[12px] border ${f===flow? 'bg-teal-500/20 border-teal-400 text-teal-200': 'bg-slate-900 border-slate-700 text-slate-300 hover:border-teal-500/40'}`}>{f}</button>
            ))}
          </div>
        </div>
      </aside>
    );

    const Inspector = ({ selected }) => (
      <aside className="w-96 h-[calc(100vh-64px)] bg-slate-900/50 backdrop-blur border-l border-slate-800 p-6 overflow-y-auto">
        <AnimatePresence mode="wait">
          {selected ? (
            <motion.div key={selected.id} initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: 20 }}>
              <div className="text-teal-200 font-semibold">{selected.title}</div>
              <div className="text-slate-300/80 text-sm mb-4">{selected.subtitle}</div>
              {selected.ficha && (
                <div className="space-y-3 text-sm">
                  <div><div className="uppercase tracking-wide text-[10px] text-slate-400">Proceso Involucrado</div><div className="text-slate-200">{selected.ficha.proceso}</div></div>
                  <div><div className="uppercase tracking-wide text-[10px] text-slate-400">Costo Estimado (Proxy)</div><div className="text-slate-200">{selected.ficha.costo}</div></div>
                  <div><div className="uppercase tracking-wide text-[10px] text-slate-400">Justificaci√≥n</div><div className="text-slate-300/90">{selected.ficha.justificacion}</div></div>
                </div>
              )}
              <div className="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-slate-800">
                <div>
                  <div className="uppercase tracking-wide text-[10px] text-slate-400">Entradas</div>
                  <ul className="mt-1 text-sm list-disc pl-4 space-y-1">{selected.io.in.map((t, i) => (<li key={i}>{t}</li>))}</ul>
                </div>
                <div>
                  <div className="uppercase tracking-wide text-[10px] text-slate-400">Salidas</div>
                  <ul className="mt-1 text-sm list-disc pl-4 space-y-1">{selected.io.out.map((t, i) => (<li key={i}>{t}</li>))}</ul>
                </div>
              </div>
            </motion.div>
          ) : (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="text-slate-400 text-sm">Selecciona un nodo en el mapa para ver detalles.</motion.div>
          )}
        </AnimatePresence>
      </aside>
    );

    const TimelineSheet = ({ open, currentPhase, currentWeek, setCurrentPhase, setCurrentWeek }) => (
      <AnimatePresence>
        {open && (
          <motion.div initial={{ y: '100%' }} animate={{ y: 0 }} exit={{ y: '100%' }} transition={{ type: 'tween', duration: 0.25 }} className="fixed bottom-0 left-0 right-0 z-50 h-64 bg-gradient-to-t from-slate-950 via-slate-900/98 to-transparent border-t border-slate-800">
            <div className="max-w-[1400px] mx-auto px-6 py-3">
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2">
                  <h3 className="text-sm font-bold text-purple-200">{currentPhase}</h3>
                  <span className="text-xs text-purple-300">S{currentWeek}/12</span>
                </div>
                <div className="flex-1 flex gap-0.5">
                  {[...Array(12)].map((_, i) => (
                    <button key={i} onClick={()=>{ const week=i+1; setCurrentWeek(week); const newPhase = Object.entries(TIMELINE_PHASES).find(([_, data]) => data.semanas.includes(week)); if (newPhase) setCurrentPhase(newPhase[0]); }} className={`flex-1 h-6 rounded transition-all flex items-center justify-center text-[10px] font-bold ${i+1===currentWeek? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white' : i+1<currentWeek? 'bg-purple-600/50 text-purple-200' : 'bg-slate-700/50 text-slate-400 hover:bg-slate-600/50'}`}>{i+1}</button>
                  ))}
                </div>
                <div className="text-xs text-purple-400">
                  {(TIMELINE_PHASES[currentPhase].detalles.find(d=>d.semana===currentWeek)?.herramientas_ids?.length ?? 0)} herramientas activas
                </div>
              </div>
              <div className="mt-3 grid grid-cols-3 gap-3">
                {TIMELINE_PHASES[currentPhase].detalles.filter(d=>d.semana===currentWeek).map(detalle => (
                  <div key={detalle.semana} className="bg-slate-900/60 rounded-lg p-3 border border-slate-800">
                    <div className="font-semibold text-sm text-purple-200 mb-1">Semana {detalle.semana}: {detalle.titulo}</div>
                    <div className="text-[10px] uppercase tracking-wide text-slate-400 mb-1">Tareas</div>
                    <ul className="text-[11px] text-slate-300 space-y-0.5">{detalle.tareas.map((t,i)=>(<li key={i}>‚Ä¢ {t}</li>))}</ul>
                    <div className="text-[10px] uppercase tracking-wide text-slate-400 mt-2 mb-1">Stack</div>
                    <div className="flex flex-wrap gap-1">{detalle.herramientas.map(h => (<span key={h} className="px-2 py-0.5 bg-purple-500/20 border border-purple-400/30 rounded text-[10px] text-purple-300">{h}</span>))}</div>
                  </div>
                ))}
                <div className="col-span-1 bg-slate-900/60 rounded-lg p-3 border border-slate-800">
                  <div className="text-xs font-bold text-purple-200 mb-2">ü§ñ Estado IAs (D√≠a 90)</div>
                  <div className="space-y-2 text-[11px]">
                    {Object.entries({
                      HASE: { estado: "Cerebro Dual Activo", progreso: 75, descripcion: "3 meses datos operativos flota Higer + nueva flota propia" },
                      PIA: { estado: "v1.0 en Producci√≥n", progreso: 60, descripcion: "Recordatorios automatizados v√≠a Twilio con referencias Conekta" },
                      "Super-PMA": { estado: "Modo Escucha Avanzado", progreso: 40, descripcion: "Base de datos rica, iniciando modelos predictivos" }
                    }).map(([ia, s]) => (
                      <div key={ia}>
                        <div className="flex justify-between"><span className="text-purple-300">{ia}</span><span className="text-slate-400">{s.progreso}%</span></div>
                        <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-purple-500 to-blue-500" style={{ width: `${s.progreso}%` }} /></div>
                        <div className="text-slate-500 mt-0.5">{s.descripcion}</div>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="col-span-1 bg-slate-900/60 rounded-lg p-3 border border-slate-800">
                  <div className="text-xs font-bold text-green-300 mb-2">üéØ KPIs al D√≠a 90</div>
                  <div className="grid grid-cols-2 gap-1 text-[11px] text-green-200">
                    <div>‚Ä¢ 20-30 unidades</div><div>‚Ä¢ 3 meses datos</div><div>‚Ä¢ Pipeline 50+</div><div>‚Ä¢ Stack 100%</div>
                  </div>
                </div>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    );

    const DiagramCanvas = ({ nodes, flows, flow, visibleLanes, positions, selected, setSelected, showTimeline, currentPhase, currentWeek }) => {
      const { zoom, pan, setZoom, setPan, onWheel, onMouseDown, onMouseMove, reset } = useZoomPan(1);
      const width = Math.max(2400, PADDING_X * 2 + LANES.length * (LANE_WIDTH + LANE_GAP));
      const maxRow = Math.max(...nodes.map((n) => n.row));
      const height = PADDING_Y * 2 + (maxRow + 1) * ROW_HEIGHT;

      const activeEdges = flows[flow] || [];
      const phaseData = showTimeline && currentPhase ? TIMELINE_PHASES[currentPhase] : null;
      const weekData = phaseData ? phaseData.detalles.find(d => d.semana === currentWeek) : null;

      return (
        <div className="flex-1 relative h-[calc(100vh-64px)] overflow-hidden" onWheel={onWheel} onMouseMove={onMouseMove} onMouseDown={onMouseDown}>
          <ZoomControls onZoomIn={()=>setZoom(z=>Math.min(2.5, z*1.1))} onZoomOut={()=>setZoom(z=>Math.max(0.4, z*0.9))} onReset={reset} />
          <div className="column-header-overlay">
            {LANES.map((lane, idx) => {
              if (!visibleLanes[lane.id]) return null;
              const xPosition = PADDING_X + idx * (LANE_WIDTH + LANE_GAP) + (LANE_WIDTH / 2);
              return (
                <div key={lane.id} className="absolute top-2 text-slate-300 text-sm font-semibold flex items-center gap-2" style={{ left: xPosition - (LANE_WIDTH/2) + 8 }}>
                  <span className="text-slate-400">{lane.icon}</span>
                  <span>{lane.title}</span>
                </div>
              );
            })}
          </div>
          <div className="absolute inset-0" style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`, transformOrigin: '0 0' }}>
            <svg width={width} height={height} className="block">
              {LANES.map((lane, idx) => {
                if (!visibleLanes[lane.id]) return null;
                const xPosition = PADDING_X + idx * (LANE_WIDTH + LANE_GAP) + (LANE_WIDTH / 2);
                return (
                  <g key={lane.id}>
                    <rect x={xPosition - LANE_WIDTH/2} y={45} width={LANE_WIDTH} height={35} fill="rgba(30, 41, 59, 0.8)" stroke="rgba(100, 116, 139, 0.3)" strokeWidth="1" rx="8" />
                    <text x={xPosition} y={67} textAnchor="middle" className="fill-slate-200" fontSize="15" fontWeight="600"></text>
                  </g>
                );
              })}

              {Object.values(flows).flat().map(([a, b], i) => (
                <Edge key={i} from={a} to={b} positions={positions} active={!!flow && flows[flow]?.some(([x, y]) => x === a && y === b)} />
              ))}
            </svg>

            {nodes.map((n) => {
              const isActiveInPhase = !!phaseData && phaseData.nodos_activos.includes(n.id);
              const isActiveInWeek = !!weekData && weekData.herramientas_ids?.includes(n.id);
              return (
                <NodeCard key={n.id} node={n} pos={positions[n.id]} selected={selected?.id === n.id} onSelect={setSelected} isActiveInWeek={isActiveInWeek} isActiveInPhase={isActiveInPhase} />
              );
            })}
          </div>
          <MiniMap zoom={zoom} pan={pan} diagramSize={{ width, height }} />
        </div>
      );
    };

    const PortalTecnicoImpl = () => (
      <div className="flex-1 h-[calc(100vh-64px)] bg-slate-950 p-6 overflow-y-auto">
        <div className="max-w-7xl mx-auto space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold">Portal T√©cnico</h2>
            <div className="flex items-center gap-3 text-sm text-slate-400">
              <span><span className="inline-block w-2 h-2 rounded-full" style={{background: THEME.states.core}}></span> N√∫cleo</span>
              <span><span className="inline-block w-2 h-2 rounded-full" style={{background: THEME.states.mvp}}></span> MVP</span>
              <span><span className="inline-block w-2 h-2 rounded-full" style={{background: THEME.states.phase2}}></span> Fase 2</span>
              <span><span className="inline-block w-2 h-2 rounded-full" style={{background: THEME.states.future}}></span> Futuro</span>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-12 gap-4">
            <section className="lg:col-span-8 rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
              <div className="font-semibold mb-2">Mapa de Integraciones (resumen)</div>
              <div className="grid sm:grid-cols-2 gap-3">
                {NODES.map(n => (
                  <div key={n.id} className="rounded-lg border border-slate-800 bg-slate-900 p-3">
                    <div className="flex items-center gap-2">
                      <span className="text-slate-300">{n.icon}</span>
                      <div className="font-semibold text-sm text-slate-200">{n.title}</div>
                      <span className="ml-auto text-[10px] px-2 py-0.5 rounded-full border border-slate-700 text-slate-400">{n.type}</span>
                    </div>
                    <div className="text-slate-400 text-xs mt-1">{n.subtitle}</div>
                    <div className="mt-2 grid grid-cols-2 gap-2 text-[11px] text-slate-300">
                      <div>
                        <div className="text-slate-500 uppercase text-[10px]">IN</div>
                        {n.io.in.slice(0,2).map((t,i)=>(<div key={i}>‚Ä¢ {t}</div>))}
                      </div>
                      <div>
                        <div className="text-slate-500 uppercase text-[10px]">OUT</div>
                        {n.io.out.slice(0,2).map((t,i)=>(<div key={i}>‚Ä¢ {t}</div>))}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
            <aside className="lg:col-span-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
              <div className="font-semibold mb-2">APIs y Endpoints sugeridos</div>
              <div className="text-[11px] text-slate-400">Selecciona un nodo en la vista estrat√©gica para ver endpoints detallados.</div>
              <div className="mt-3 grid grid-cols-2 gap-2 text-[11px]">
                <div className="p-2 rounded border border-slate-800 bg-slate-900">Autenticaci√≥n OTP (Twilio)</div>
                <div className="p-2 rounded border border-slate-800 bg-slate-900">Webhook firma (Mifiel)</div>
                <div className="p-2 rounded border border-slate-800 bg-slate-900">Pagos (Conekta)</div>
                <div className="p-2 rounded border border-slate-800 bg-slate-900">Telemetr√≠a (Samsara)</div>
              </div>
            </aside>
          </div>
        </div>
      </div>
    );

    // Lazy load PortalTecnico for performance
    const PortalTecnico = React.lazy(() => Promise.resolve({ default: PortalTecnicoImpl }));

    function ConductoresIntegrationsMap() {
      const [flow, setFlow] = useState("Onboarding & Scoring");
      const [visibleLanes, setVisibleLanes] = useState(Object.fromEntries(LANES.map((l) => [l.id, true])));
      const [selected, setSelected] = useState(null);

      const [showTimeline, setShowTimeline] = useState(false);
      const [currentPhase, setCurrentPhase] = useState("Mes 1: Ignici√≥n Inmediata");
      const [currentWeek, setCurrentWeek] = useState(1);

      const [viewMode, setViewMode] = useState('strategic'); // 'strategic' | 'technical'
      const [commandPaletteOpen, setCommandPaletteOpen] = useState(false);

      useKeyboardShortcuts({ onTogglePalette: ()=>setCommandPaletteOpen(v=>!v), onClosePalette: ()=>setCommandPaletteOpen(false), onToggleTimeline: ()=> setShowTimeline(v=>!v) });

      const filteredNodes = useMemo(() => NODES.filter((n) => visibleLanes[n.lane]), [visibleLanes]);
      const positions = useMemo(() => computePositions(filteredNodes), [filteredNodes]);

      const width = Math.max(2400, PADDING_X * 2 + LANES.length * (LANE_WIDTH + LANE_GAP));
      const maxRow = Math.max(...filteredNodes.map((n) => n.row));
      const height = PADDING_Y * 2 + (maxRow + 1) * ROW_HEIGHT;

      useEffect(() => { if (showTimeline) { setFlow(null); } }, [showTimeline]);

      return (
        <div className="h-screen flex flex-col bg-slate-950 text-slate-100">
          <header className="fixed top-0 left-0 right-0 h-16 z-40 bg-slate-950/80 backdrop-blur border-b border-slate-800">
            <div className="h-full max-w-[1400px] mx-auto px-6 flex items-center gap-4">
              <ServerCog className="w-5 h-5 text-teal-400" />
              <div className="font-extrabold tracking-tight">Arquitectura de Integraciones ‚Äî Conductores</div>
              <div className="ml-auto flex items-center gap-3">
                <ViewSelector mode={viewMode} setMode={(m)=>{ setViewMode(m); setShowTimeline(false); }} />
                <div className="hidden md:block"><Breadcrumbs flow={flow} showTimeline={showTimeline} currentWeek={currentWeek} /></div>
                <button onClick={()=> setShowTimeline(v=>!v)} className={`px-4 py-2 rounded-xl border-2 text-sm font-bold ${showTimeline? 'bg-gradient-to-r from-purple-600 to-blue-600 border-purple-400 text-white shadow-xl shadow-purple-500/30 ring-2 ring-purple-400/50' : 'bg-gradient-to-r from-purple-900/50 to-blue-900/50 border-purple-500 text-purple-200 hover:shadow-lg hover:shadow-purple-500/20'}`}>Blueprint 90 D√≠as {showTimeline && <span className="ml-2 text-xs bg-white/20 px-2 py-0.5 rounded-full">ACTIVO</span>}</button>
              </div>
            </div>
          </header>

          <div className="flex w-full h-full pt-16">
            <Sidebar visibleLanes={visibleLanes} setVisibleLanes={setVisibleLanes} showTimeline={showTimeline} flow={flow} setFlow={setFlow} />

            <main className="flex-1 flex">
              {viewMode === 'strategic' ? (
                <>
                  <DiagramCanvas nodes={filteredNodes} flows={FLOWS} flow={flow} visibleLanes={visibleLanes} positions={positions} selected={selected} setSelected={setSelected} showTimeline={showTimeline} currentPhase={currentPhase} currentWeek={currentWeek} />
                  <Inspector selected={selected} />
                </>
              ) : (
                <React.Suspense fallback={<div className=\"flex-1 grid place-items-center text-slate-400\">Cargando Portal T√©cnico‚Ä¶</div>}>
                  <PortalTecnico />
                </React.Suspense>
              )}
            </main>
          </div>

          <TimelineSheet open={showTimeline} currentPhase={currentPhase} currentWeek={currentWeek} setCurrentPhase={setCurrentPhase} setCurrentWeek={setCurrentWeek} />

          <CommandPalette open={commandPaletteOpen} onClose={()=>setCommandPaletteOpen(false)} nodes={NODES} onChooseNode={(n)=>{ setViewMode('strategic'); setSelected(n); }} />
        </div>
      );
    }

    ReactDOM.render(<ConductoresIntegrationsMap />, document.getElementById('root'));
  </script>
</body>
</html>
