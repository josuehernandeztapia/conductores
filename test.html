<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo - Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">\
    
    <style>
        /* Estilos base */
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; } /* Verde para valores positivos */
        .negative { color: #dc2626; } /* Rojo para valores negativos */
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .debug-info { position: fixed; top: 10px; right: 10px; background: #1f2937; color: white; padding: 10px; border-radius: 6px; font-size: 12px; max-width: 300px; z-index: 1000; display: none; }
        .niif-compliant { border-left: 4px solid #10b981; background-color: #f0fdf4; }
        /* Estilos para el panel de validaciÃ³n */
        #validation-panel-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .validation-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .validation-item.error { background-color: #fee2e2; border-left: 4px solid #ef4444; } /* red-200 / red-500 */
        .validation-item.warning { background-color: #fffbeb; border-left: 4px solid #f59e0b; } /* amber-100 / amber-500 */
        .validation-item.info { background-color: #e0f2fe; border-left: 44px solid #3b82f6; } /* light-blue-100 / blue-500 */
        .validation-item.passed { background-color: #d1fae5; border-left: 4px solid #10b981; } /* green-100 / green-500 */
        .validation-icon {
            font-size: 1.25rem; /* 20px */
            margin-right: 0.75rem; /* 12px */
            line-height: 1;
        }
        .validation-item.error .validation-icon { color: #ef4444; }
        .validation-item.warning .validation-icon { color: #f59e0b; }
        .validation-item.info .validation-icon { color: #3b82f6; }
        .validation-item.passed .validation-icon { color: #10b981; }
        .validation-message {
            flex-grow: 1;
            font-size: 0.875rem; /* 14px */
            color: #374151; /* gray-700 */
        }
        .validation-message strong { font-weight: 600; }
        .validation-message ul { list-style: disc; padding-left: 1.25rem; margin-top: 0.25rem; }
        .validation-summary {
            font-weight: bold;
            text-align: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Debug Panel -->
    <div id="debug-info" class="debug-info">
        <div id="debug-content"></div>
        <button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
    </div>
    
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header and Key Metrics -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Resiliencia como Servicio</p>
            <button onclick="toggleDebug()" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-300">Debug</button>
        </header>
        <!-- Key Metrics Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA AÃ±o 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
             <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Equity</div>
                <div class="text-2xl font-bold" id="tir-equity">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas Operativas (AÃ±o 5)</div>
                <div class="text-2xl font-bold" id="vagonetas-operativas">0</div>
            </div>
           
        </div>
        <!-- Additional row for ROE and ROIC -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
             <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">ROE (AÃ±o 5)</div>
                <div class="text-2xl font-bold" id="roe-year5">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">ROIC (AÃ±o 5)</div>
                <div class="text-2xl font-bold" id="roic-year5">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Deuda Residual AÃ±o 5</div>
                <div class="text-2xl font-bold" id="deuda-residual">$0M MXN</div>
            </div>
        </div>
        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  ðŸš€  Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  ðŸ“Š  Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  ðŸ“‹  NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  ðŸ“ˆ  GrÃ¡ficos</button>
                <button id="tab-validacion" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  âœ…  ValidaciÃ³n</button>
            </nav>
        </div>
        <!-- Tab Content: Control -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Credit and Risk Parameters Section -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">CrÃ©dito y Riesgo <span class="text-sm text-gray-500">(ParÃ¡metros clave para el riesgo y el retorno del financiamiento)</span></h4>
                    <div class="space-y-4" id="credit-risk-controls">
                        <!-- Inputs will be dynamically generated here -->
                    </div>
                    <div class="flex items-center mt-4">
                        <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">ProtecciÃ³n Rodando (<span class="font-bold">-50% en provisiones de morosidad</span>)</label>
                    </div>
                </div>
                <!-- Operations and Debt Parameters Section -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Operaciones y Deuda <span class="text-sm text-gray-500">(Eficiencia operativa y estructura de capital)</span></h4>
                    <div class="space-y-4" id="operations-debt-controls">
                        <!-- Inputs will be dynamically generated here -->
                    </div>
                </div>
                <!-- Units per Year and Model Constants Section -->
                <div class="card lg:col-span-3">
                    <h3 class="text-xl font-semibold mb-4">Unidades por AÃ±o y Constantes del Modelo <span class="text-sm text-gray-500">(Definiciones base del negocio)</span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6" id="units-container">
                        <!-- Unit inputs will be dynamically generated here -->
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="constants-container">
                        <!-- Constant inputs will be dynamically generated here -->
                    </div>
                    <button onclick="forceCalculate()" class="mt-6 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-medium transition duration-300">  ðŸ”„  Recalcular Modelo</button>
                </div>
            </div>
        </div>
        <!-- Tab Content: Financials -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>AÃ±o 1</th>
                                    <th>AÃ±o 2</th>
                                    <th>AÃ±o 3</th>
                                    <th>AÃ±o 4</th>
                                    <th>AÃ±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>AÃ±o 0</th>
                                    <th>AÃ±o 1</th>
                                    <th>AÃ±o 2</th>
                                    <th>AÃ±o 3</th>
                                    <th>AÃ±o 4</th>
                                    <th>AÃ±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>AÃ±o 1</th>
                                    <th>AÃ±o 2</th>
                                    <th>AÃ±o 3</th>
                                    <th>AÃ±o 4</th>
                                    <th>AÃ±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body"></tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4 text-center font-semibold p-2 rounded-lg bg-gray-50"></div>
                </div>
            </div>
        </div>
        <!-- Tab Content: NIIF -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos <span class="text-sm text-gray-600">(CÃ³mo se reconocen los ingresos del negocio de financiamiento)</span></h3>
                    <div id="niif15-container">Calculando datos NIIF 15...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 9 - Provisiones Crediticias <span class="text-sm text-gray-600">(Impacto de la morosidad y las pÃ©rdidas esperadas)</span></h3>
                    <div id="niif9-container">Calculando datos NIIF 9...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos Mantenidos para Venta <span class="text-sm text-gray-600">(Tratamiento contable de vagonetas reposedas)</span></h3>
                    <div id="niif5-container">Calculando datos NIIF 5...</div>
                </div>
            </div>
        </div>
        <!-- Tab Content: Charts -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">EvoluciÃ³n de EBITDA</h4>
                    <div style="height: 300px;"><canvas id="ebitdaChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">ComposiciÃ³n de Ingresos (AÃ±o 5)</h4>
                    <div style="height: 300px;"><canvas id="revenueMixChart"></canvas></div>
                </div>
                 <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Activos Totales vs Pasivos + Patrimonio</h4>
                    <div style="height: 300px;"><canvas id="balanceValidationChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Flujo de Efectivo Neto Anual</h4>
                    <div style="height: 300px;"><canvas id="netCashFlowChart"></canvas></div>
                </div>
            </div>
        </div>
        <!-- Tab Content: Validation -->
        <div id="content-validacion" class="content-section">
            <div id="validation-panel-content">
                <h3 class="text-xl font-semibold mb-4">Resultados de ValidaciÃ³n del Modelo</h3>
                <div id="validation-results-container">
                    <!-- Validation results will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    <script>
        // ===== GLOBAL MODEL VARIABLES =====
        let debugLogs = []; // Array to store debug logs
        let charts = {}; // Object to store Chart.js instances
        
        // Financial model data, initial values and control ranges
        let modelData = {
            // Credit and Risk Parameters
            tasaInteres: 25.5,      // Tasa de interÃ©s anual de los financiamientos a clientes
            tasaMorosidad: 8,       // Porcentaje de ingresos por intereses que se considera moroso (para la antigua lÃ³gica)
            proteccionRodando: true,// Booleano para activar/desactivar reducciÃ³n de provisiones
            // ParÃ¡metros IFRS 9 (nuevos)
            pdStage1: 0.005, // 0.5% Probability of Default (12-month) for Stage 1 loans
            pdStage2: 0.08,  // 8% Probability of Default (lifetime) for Stage 2 loans
            pdStage3: 0.40,  // 40% Probability of Default (lifetime) for Stage 3 loans (Credit-impaired)
            lgd: 0.50,       // Loss Given Default (percentage of exposure lost if default occurs)
            portfolioAllocationStage1: 0.85, // 85% of active portfolio in Stage 1
            portfolioAllocationStage2: 0.10, // 10% of active portfolio in Stage 2
            portfolioAllocationStage3: 0.05, // 5% of active portfolio in Stage 3
            economicAdjustmentFactor: 1.0, // Factor para ajustes prospectivos macroeconÃ³micos (1.0 = sin ajuste)
            // ParÃ¡metros de Operaciones y Deuda
            comisionGNV: 8,         // Porcentaje de comisiÃ³n por servicios de GNV
            margenRefacciones: 25,  // Margen de ganancia en refacciones
            ventureDebtPct: 70,     // Porcentaje del capital inicial (Serie A) que se obtiene como Venture Debt (adicional a Serie A)
            ventureDebtRate: 12,    // Tasa de interÃ©s anual del Venture Debt
            periodoAmortizacionDeuda: 5, // AÃ±os para amortizar la deuda inicial de Venture Debt
            // Unidades por AÃ±o (inputs dinÃ¡micos)
            unitsPerYear: [200, 250, 300, 350, 400], // Unidades (vagonetas) aÃ±adidas cada aÃ±o
            // Constantes del Modelo
            vanCost: 641000,        // Costo de adquisiciÃ³n de cada vagoneta (Activo Fijo)
            vanPrice: 729000,       // Precio de venta/financiamiento al cliente (para cÃ¡lculo de monto del prÃ©stamo)
            seriesA: 45000000,      // InversiÃ³n inicial de Serie A (Equity)
            seriesB_funding: 0,     // Monto de financiamiento de Serie B
            seriesB_year: 3,        // AÃ±o en que se recibe la Serie B (AÃ±o 1 a AÃ±o 5)
            seriesC_funding: 0,     // Monto de financiamiento de Serie C
            seriesC_year: 5,        // AÃ±o en que se recibe la Serie C (AÃ±o 1 a AÃ±o 5)
            clientLoanTermYears: 5, // Plazo de amortizaciÃ³n de los prÃ©stamos a clientes (en aÃ±os)
            depreciationYears: 10,  // AÃ±os de depreciaciÃ³n lineal de las vagonetas (activos de RAG)
            opexRate: 15,           // Porcentaje de los ingresos operativos destinado a OPEX
            margenVagoneta: 5,      // Porcentaje de comisiÃ³n por la originaciÃ³n de cada vagoneta financiada
            gnvRevPerUnit: 15000,   // Ingreso base por unidad por servicios de GNV
            refaccionesRevPerUnit: 8000, // Ingreso base por unidad por servicios de refacciones
            marketplaceRevPerUnit: 5000, // Ingreso base por unidad por servicios de Marketplace
            marketplace: 3,         // Porcentaje de comisiÃ³n por servicios de Marketplace
            tasaReposicion: 5,      // Porcentaje de unidades que se reponen/clasifican como Activos para Venta anualmente
            fairValueVenta: 85,     // Porcentaje del valor razonable de las vagonetas reposedas
            costosVenta: 5,          // Porcentaje de costos asociados a la venta de vagonetas reposedas
            corporateTaxRate: 25   // Tasa de impuesto corporativo (%)
        };
        
        // Rangos para los inputs deslizables (sliders)
        const sliderConfigs = [
            { id: 'tasaInteres', label: 'Tasa de InterÃ©s (Clientes)', min: 10, max: 35, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'tasaMorosidad', label: 'Tasa Morosidad (Antigua LÃ³gica)', min: 4, max: 15, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'comisionGNV', label: 'ComisiÃ³n GNV', min: 6, max: 20, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'margenRefacciones', label: 'Margen Refacciones', min: 20, max: 40, step: 1, type: 'range', format: val => val.toFixed(0) + '%' },
            { id: 'ventureDebtPct', label: '% Venture Debt', min: 50, max: 100, step: 5, type: 'range', format: val => val.toFixed(0) + '%' },
            { id: 'ventureDebtRate', label: 'Tasa Venture Debt', min: 10, max: 16, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' }
        ];
        
        // Rangos para las constantes del modelo (inputs numÃ©ricos)
        const constantConfigs = [
            { id: 'vanCost', label: 'Costo Vagoneta (RAG)', min: 500000, max: 800000, step: 1000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'vanPrice', label: 'Precio PrÃ©stamo Cliente', min: 600000, max: 900000, step: 1000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesA', label: 'Capital Serie A', min: 30000000, max: 60000000, step: 1000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesB_funding', label: 'Funding Serie B', min: 0, max: 200000000, step: 5000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesB_year', label: 'AÃ±o Serie B', min: 1, max: 5, step: 1, type: 'number', format: val => val.toFixed(0) + ' ' + (val == 1 ? 'aÃ±o' : 'aÃ±os') },
            { id: 'seriesC_funding', label: 'Funding Serie C', min: 0, max: 300000000, step: 5000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesC_year', label: 'AÃ±o Serie C', min: 1, max: 5, step: 1, type: 'number', format: val => val.toFixed(0) + ' ' + (val == 1 ? 'aÃ±o' : 'aÃ±os') },
            { id: 'clientLoanTermYears', label: 'Plazo PrÃ©stamo Cliente (AÃ±os)', min: 1, max: 10, step: 1, type: 'number', format: val => val.toFixed(0) + ' aÃ±os' },
            { id: 'depreciationYears', label: 'AÃ±os DepreciaciÃ³n (Vagoneta)', min: 5, max: 15, step: 1, type: 'number', format: val => val.toFixed(0) + ' aÃ±os' },
            { id: 'opexRate', label: 'Tasa OPEX (% Ingresos)', min: 10, max: 30, step: 1, type: 'number', format: val => val.toFixed(0) + '%' },
            { id: 'margenVagoneta', label: 'Margen OriginaciÃ³n Vagoneta', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'gnvRevPerUnit', label: 'Ingreso GNV/Unidad', min: 10000, max: 20000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'refaccionesRevPerUnit', label: 'Ingreso Refacciones/Unidad', min: 5000, max: 15000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'marketplaceRevPerUnit', label: 'Ingreso Marketplace/Unidad', min: 3000, max: 10000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'marketplace', label: '% ComisiÃ³n Marketplace', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'tasaReposicion', label: '% Unidades ReposiciÃ³n', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'fairValueVenta', label: '% Fair Value Venta', min: 70, max: 95, step: 1, type: 'number', format: val => val.toFixed(0) + '%' },
            { id: 'costosVenta', label: '% Costos Venta', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            // Nuevos Controles NIIF 9 y Tax Rate
            { id: 'pdStage1', label: 'PD Etapa 1 (12M)', min: 0.001, max: 0.05, step: 0.001, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'pdStage2', label: 'PD Etapa 2 (Lifetime)', min: 0.05, max: 0.20, step: 0.005, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'pdStage3', label: 'PD Etapa 3 (Lifetime)', min: 0.20, max: 0.60, step: 0.01, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'lgd', label: 'LGD (RecuperaciÃ³n %)', min: 0.1, max: 0.9, step: 0.01, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'portfolioAllocationStage1', label: 'Port. Etapa 1 (%)', min: 0.70, max: 0.95, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'portfolioAllocationStage2', label: 'Port. Etapa 2 (%)', min: 0.03, max: 0.20, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'portfolioAllocationStage3', label: 'Port. Etapa 3 (%)', min: 0.01, max: 0.10, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'economicAdjustmentFactor', label: 'Ajuste EconÃ³mico (x)', min: 0.8, max: 1.2, step: 0.01, type: 'number', format: val => val.toFixed(2) + 'x' },
            { id: 'corporateTaxRate', label: 'Tasa Impuesto Corporativo (%)', min: 0, max: 40, step: 1, type: 'number', format: val => val.toFixed(0) + '%' }
        ];
        
        // Objeto para almacenar los resultados financieros calculados
        let financialResults = {
            pl: [],             // Profit & Loss (Estado de Resultados)
            cf: [],             // Cash Flow (Flujo de Efectivo)
            bs: [],             // Balance Sheet (Balance General)
            niifDetails: [],    // Detalles de aplicaciÃ³n de NIIF
            tirProyecto: 0,     // Tasa Interna de Retorno del Proyecto
            tirCartera: 0,      // Tasa Interna de Retorno de la Cartera de Clientes
            tirEquity: 0,       // Tasa Interna de Retorno del Equity
            roe: [],            // Return on Equity anual
            roic: []            // Return on Invested Capital anual
        };
        
        // New global array for IFRS 5 assets
        let heldForSaleAssets = [];

        // ===== FUNCIONES DE DEBUG =====
        // Registra mensajes en la consola y en el panel de depuraciÃ³n de la UI
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.unshift(logEntry); // AÃ±adir al principio
            if (debugLogs.length > 20) debugLogs.pop(); // Mantener solo los Ãºltimos 20 logs
            
            console.log(logEntry, data);
            updateDebugPanel();
        }
        
        // Actualiza el contenido del panel de depuraciÃ³n en la UI
        function updateDebugPanel() {
            const panel = document.getElementById('debug-content');
            if (panel) {
                panel.innerHTML = debugLogs.map(log => `<div style="margin-bottom: 2px; font-size: 10px; border-bottom: 1px dotted #4b5563; padding-bottom: 2px;">${log}</div>`).join('');
            }
        }
        
        // Muestra/oculta el panel de depuraciÃ³n
        function toggleDebug() {
            const panel = document.getElementById('debug-info');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // Function to calculate Probability of Default based on cohort age for IFRS 9
        function calculatePDBasedOnAge(cohortAge) {
            // Simplified mapping for demonstration. In a real model, this would be more complex.
            if (cohortAge === 0) { // Year 1 of the loan (first year after origination)
                return modelData.pdStage1; // 12-month PD
            } else if (cohortAge >= 1 && cohortAge <= 2) { // Year 2 and 3 of the loan
                return modelData.pdStage2; // Lifetime PD for Stage 2
            } else { // Year 4+ of the loan (or older)
                return modelData.pdStage3; // Lifetime PD for Stage 3
            }
        }

        // ===== CÃLCULO FINANCIERO PRINCIPAL =====
        // FunciÃ³n central para calcular todos los estados financieros
        function calculateFinancials() {
            log('  ðŸš€  INICIANDO CÃLCULOS FINANCIEROS...');
            try {
                // Reiniciar resultados antes de cada cÃ¡lculo
                financialResults = { 
                    pl: [], cf: [], bs: [], niifDetails: [], 
                    tirProyecto: 0, tirCartera: 0, tirEquity: 0, 
                    roe: [], roic: [] 
                };
                heldForSaleAssets = []; // Reset IFRS 5 assets for recalculation
                
                // Variables iniciales de financiamiento para el modelo (fuera del loop anual para persistencia)
                const initialEquityInvestment = modelData.seriesA;
                const initialVentureDebtAmount = initialEquityInvestment * (modelData.ventureDebtPct / 100);
                
                // Inicializar variables de estado antes del bucle anual
                let accumulatedEarnings = 0; // Utilidades retenidas acumuladas
                let cash = initialEquityInvestment + initialVentureDebtAmount; // El efectivo inicial proviene de Serie A + Venture Debt inicial
                let totalDebt = initialVentureDebtAmount; // El saldo inicial de deuda es el Venture Debt inicial
                let currentProvisionsBalance = 0; // Saldo acumulado de provisiones NIIF 9 en Balance General
                let totalUnitsAccumulatedHeldForSale = 0; // Para el cÃ¡lculo de Vagonetas Operativas (derivado de heldForSaleAssets)
                
                // Declara endOfYearEquity fuera del loop para que sea accesible despuÃ©s del loop
                let endOfYearEquity = initialEquityInvestment; // Inicializa con el capital inicial. Se actualizarÃ¡ en el loop.

                // Array para almacenar las cohortes de prÃ©stamos a clientes
                // loanCohorts = [{ yearOriginated: Y, originalPrincipal: P, remainingPrincipal: P, paymentsMadeMonths: 0, monthlyPayment: M, monthlyInterestRate: r, totalLoanTermMonths: N, originationCommissionInitial: OCI, remainingOriginationCommission: ROC, startOfYearPrincipal: SOP }]
                let loanCohorts = [];
                
                // Array para almacenar las cohortes de activos fijos (vagonetas)
                // fixedAssetsCohorts = [{ yearAcquired: X, units: Y, originalCostPerUnit: C, totalOriginalCost: Y*C, accumulatedDepreciation: D }]
                let fixedAssetsCohorts = [];
                
                // Arrays para el cÃ¡lculo de TIRs
                const projectCashFlows = [-(initialEquityInvestment + initialVentureDebtAmount)]; // TIR Proyecto: InversiÃ³n inicial total
                const equityCashFlows = [-initialEquityInvestment]; // TIR Equity: InversiÃ³n inicial de Equity
                let totalPrincipalOriginatedAcrossAllYears = 0; // Para la inversiÃ³n inicial de TIR Cartera
                
                // Para los flujos de la TIR Cartera (la inversiÃ³n inicial se aÃ±ade despuÃ©s del loop)
                const portfolioCashFlowsForIRR = []; 
                
                log(`Capital Serie A inicial: ${formatCurrency(modelData.seriesA)}`);
                log(`Venture Debt inicial (parte de Serie A y ADICIONAL): ${formatCurrency(initialVentureDebtAmount)}`);
                log(`Efectivo inicial total (Serie A + Venture Debt): ${formatCurrency(cash)}`);
                
                // Ciclo Anual: desde AÃ±o 0 (representando el inicio del AÃ±o 1) hasta AÃ±o 4 (representando el final del AÃ±o 5)
                for (let year = 0; year < 5; year++) {
                    log(`\n--- Calculando AÃ±o ${year + 1} ---`);
                    const addedUnits = modelData.unitsPerYear[year];
                    
                    // Guardar los saldos iniciales de Equity y Deuda para el cÃ¡lculo de promedio anual de ROIC/ROE
                    const startOfYearEquity = endOfYearEquity; // Usa el endOfYearEquity del aÃ±o anterior como inicio del aÃ±o actual
                    const startOfYearTotalDebt = totalDebt;

                    // Set startOfYearPrincipal for existing loan cohorts for average exposure calculation in IFRS 9
                    loanCohorts.forEach(cohort => {
                        cohort.startOfYearPrincipal = cohort.remainingPrincipal;
                    });

                    // --- INVERSIONES (Activos Fijos) - AdquisiciÃ³n de nuevas vagonetas ---
                    const capexThisYear = addedUnits * modelData.vanCost; // InversiÃ³n en vagonetas (CAPEX)
                    if (addedUnits > 0) {
                        fixedAssetsCohorts.push({
                            yearAcquired: year + 1,
                            units: addedUnits,
                            originalCostPerUnit: modelData.vanCost,
                            totalOriginalCost: addedUnits * modelData.vanCost,
                            accumulatedDepreciation: 0 // DepreciaciÃ³n inicial en 0 para la cohorte
                        });
                        log(` Nueva cohorte de activos fijos AÃ±o ${year+1}: ${addedUnits} unidades por ${formatCurrency(capexThisYear)}`);
                    }
                    
                    // --- NIIF 5: RECLASIFICACIÃ“N DE ACTIVOS Y CÃLCULO DE DETERIORO ---
                    let totalImpairmentThisYear = 0;
                    // Calculate units to repossess from actively operating vans
                    let unitsToRepossess = Math.round((fixedAssetsCohorts.filter(c => c.units > 0).reduce((sum, c) => sum + c.units, 0)) * (modelData.tasaReposicion / 100));
                    let remainingUnitsToRepossess = unitsToRepossess;
                    
                    // Variables para acumular los valores de los activos reclasificados este aÃ±o para el detalle NIIF
                    let valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearFairValue = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue = 0;

                    // Sort cohorts to repossess the oldest first (FIFO conceptual) - crucial for depreciation tracking
                    fixedAssetsCohorts.sort((a, b) => a.yearAcquired - b.yearAcquired);
                    
                    // Iterate over a *copy* of fixedAssetsCohorts to avoid issues during modification
                    for (let i = 0; i < fixedAssetsCohorts.length && remainingUnitsToRepossess > 0; i++) {
                        let cohort = fixedAssetsCohorts[i]; // Get reference to the actual cohort object

                        if (cohort.units > 0) { // Only consider active units in this cohort
                            const actualUnitsToRepossessFromThisCohort = Math.min(remainingUnitsToRepossess, cohort.units);

                            if (actualUnitsToRepossessFromThisCohort > 0) {
                                const proportionToRepossess = actualUnitsToRepossessFromThisCohort / cohort.units;
                                const repossessedOriginalCost = cohort.totalOriginalCost * proportionToRepossess;
                                const repossessedAccumulatedDepreciation = cohort.accumulatedDepreciation * proportionToRepossess;
                                const repossessedCarryingAmount = repossessedOriginalCost - repossessedAccumulatedDepreciation;

                                // Calculate Fair Value less costs to sell for the repossessed portion
                                const repossessedFairValueLessCosts = repossessedCarryingAmount * (modelData.fairValueVenta / 100) * (1 - (modelData.costosVenta / 100));

                                // Calculate impairment for this repossessed portion
                                const impairmentForRepossessed = Math.max(0, repossessedCarryingAmount - repossessedFairValueLessCosts);
                                totalImpairmentThisYear += impairmentForRepossessed; // Accumulate impairment for P&L

                                // Net value after impairment for the repossessed portion
                                const netValueAfterImpairment = repossessedCarryingAmount - impairmentForRepossessed;

                                // Update the original cohort (remaining portion) - adjust its values
                                cohort.units -= actualUnitsToRepossessFromThisCohort;
                                cohort.totalOriginalCost -= repossessedOriginalCost;
                                cohort.accumulatedDepreciation -= repossessedAccumulatedDepreciation;
                                // If cohort.units becomes 0, it means the entire cohort was repossessed and will be filtered out.

                                // Add the repossessed portion to heldForSaleAssets (separate tracking for IFRS 5)
                                heldForSaleAssets.push({
                                    units: actualUnitsToRepossessFromThisCohort,
                                    originalCost: repossessedOriginalCost,
                                    accumulatedDepreciation: repossessedAccumulatedDepreciation,
                                    carryingAmountAtHFS: repossessedCarryingAmount,
                                    currentFairValueLessCosts: netValueAfterImpairment,
                                    heldForSaleYear: year + 1
                                });
                                log(` Reclasificadas ${actualUnitsToRepossessFromThisCohort} unidades de cohorte AÃ±o ${cohort.yearAcquired} a NIIF 5. VL al reclasificar: ${formatCurrency(repossessedCarryingAmount)}, Deterioro: ${formatCurrency(impairmentForRepossessed)}`);

                                remainingUnitsToRepossess -= actualUnitsToRepossessFromThisCohort;
                                // Accumulate for NIIF details of this year
                                valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount += repossessedCarryingAmount;
                                valueOfAssetsReclassifiedToNIIF5ThisYearFairValue += repossessedCarryingAmount * (modelData.fairValueVenta / 100);
                                valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell += repossessedCarryingAmount * (modelData.fairValueVenta / 100) * (modelData.costosVenta / 100);
                                valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue += repossessedFairValueLessCosts;
                            }
                        }
                    }
                    // Filter out cohorts that became fully repossessed (units = 0) to ensure only active PP&E remain
                    fixedAssetsCohorts = fixedAssetsCohorts.filter(c => c.units > 0);

                    // Recalculate totalUnitsAccumulatedHeldForSale from the dedicated array
                    totalUnitsAccumulatedHeldForSale = heldForSaleAssets.reduce((sum, asset) => sum + asset.units, 0);

                    const impairment = totalImpairmentThisYear; // Impairment for P&L

                    // --- DEPRECIACIÃ“N DE ACTIVOS FIJOS (Vagonetas) ---
                    // La depreciaciÃ³n solo aplica a los activos que aÃºn estÃ¡n operando (no clasificados como NIIF 5)
                    let annualDepreciation = 0;
                    fixedAssetsCohorts.forEach(cohort => { // fixedAssetsCohorts now only contains active PP&E
                        const yearsDepreciated = (year + 1) - cohort.yearAcquired; // AÃ±os transcurridos desde la adquisiciÃ³n
                        const remainingDepreciableLife = modelData.depreciationYears - yearsDepreciated;

                        // Solo deprecia si la vida Ãºtil restante es positiva y no estÃ¡ completamente depreciado
                        if (remainingDepreciableLife > 0 && cohort.accumulatedDepreciation < cohort.totalOriginalCost && cohort.units > 0) {
                            const depreciationRate = 1 / modelData.depreciationYears;
                            // La depreciaciÃ³n se basa en el costo original total restante de las unidades aÃºn en esta cohorte
                            const depreciationThisYear = cohort.totalOriginalCost * depreciationRate;
                            
                            // Asegurar que la depreciaciÃ³n no exceda el valor no depreciado restante de la cohorte
                            const remainingValueInCohort = cohort.totalOriginalCost - cohort.accumulatedDepreciation;
                            const actualDepreciationForCohort = Math.min(depreciationThisYear, remainingValueInCohort);
                            
                            cohort.accumulatedDepreciation += actualDepreciationForCohort;
                            annualDepreciation += actualDepreciationForCohort;
                        }
                    });

                    // --- ORIGINACIÃ“N DE NUEVA COHORTE DE PRÃ‰STAMOS A CLIENTES ---
                    let totalPrincipalOriginatedThisYear = 0; // Total principal de prÃ©stamos nuevos este aÃ±o
                    let currentYearOriginationContractValue = 0; // Margen de originaciÃ³n inicial para los nuevos prÃ©stamos de este aÃ±o
                    
                    if (addedUnits > 0) {
                        const newCohortPrincipal = addedUnits * modelData.vanPrice;
                        totalPrincipalOriginatedThisYear = newCohortPrincipal; // Esta es la inversiÃ³n real en el prÃ©stamo al cliente
                        totalPrincipalOriginatedAcrossAllYears += newCohortPrincipal; // Acumular para TIR Cartera
                        const monthlyInterestRateClient = (modelData.tasaInteres / 100) / 12;
                        const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
                        
                        let monthlyPaymentClient = 0;
                        if (monthlyInterestRateClient > 0) {
                            monthlyPaymentClient = newCohortPrincipal * (monthlyInterestRateClient / (1 - Math.pow(1 + monthlyInterestRateClient, -totalPaymentsMonthsClient)));
                        } else {
                            // Si la tasa de interÃ©s es 0, el pago mensual es simplemente principal / nÃºmero de meses
                            monthlyPaymentClient = newCohortPrincipal / totalPaymentsMonthsClient;
                        }

                        const originationCommissionForThisCohort = newCohortPrincipal * (modelData.margenVagoneta / 100); // Calcular el margen de originaciÃ³n para esta cohorte
                        currentYearOriginationContractValue = originationCommissionForThisCohort; // Asignar al acumulador anual
                        
                        loanCohorts.push({
                            yearOriginated: year + 1,
                            originalPrincipal: newCohortPrincipal,
                            remainingPrincipal: newCohortPrincipal, // Al inicio del aÃ±o, este es el total
                            startOfYearPrincipal: newCohortPrincipal, // Para nueva cohorte, el inicio es el principal original
                            paymentsMadeMonths: 0, // No se han hecho pagos aÃºn para esta cohorte
                            monthlyPayment: monthlyPaymentClient,
                            monthlyInterestRate: monthlyInterestRateClient,
                            totalLoanTermMonths: totalPaymentsMonthsClient,
                            originationCommissionInitial: originationCommissionForThisCohort, // Nuevo campo
                            remainingOriginationCommission: originationCommissionForThisCohort // Nuevo campo, se reducirÃ¡ a medida que se reconozca el ingreso
                        });
                        log(` Cohorte nueva AÃ±o ${year+1}: ${addedUnits} unidades, Principal: ${formatCurrency(newCohortPrincipal)}. Esta es una INVERSIÃ“N.`);
                    }
                    
                    // --- AMORTIZACIÃ“N Y RECONOCIMIENTO DE INGRESOS POR COHORTES (Clientes) ---
                    let annualInterestReceived = 0; // Ingresos por intereses devengados este aÃ±o de todas las cohortes
                    let annualPrincipalReceived = 0; // Pagos de principal recibidos este aÃ±o de todas las cohortes
                    let annualOriginationCommissionRecognized = 0; // Acumulador de margen de originaciÃ³n reconocido este aÃ±o
                    let currentYearEndReceivables = 0; // Saldo total de CxC al final de este aÃ±o
                    
                    // Iterar sobre todas las cohortes activas (las que aÃºn tienen saldo pendiente)
                    loanCohorts.forEach(cohort => {
                        // Simulate 12 months of payments for each cohort
                        for (let m = 0; m < 12; m++) {
                            if (cohort.remainingPrincipal <= 0 || cohort.paymentsMadeMonths >= cohort.totalLoanTermMonths) {
                                break; // Cohorte totalmente amortizada
                            }
                            
                            const interestThisMonth = cohort.remainingPrincipal * cohort.monthlyInterestRate;
                            let principalThisMonth = cohort.monthlyPayment - interestThisMonth;
                            // Asegurar que el principal a pagar no exceda el saldo restante
                            principalThisMonth = Math.min(principalThisMonth, cohort.remainingPrincipal);
                            
                            annualInterestReceived += interestThisMonth;
                            annualPrincipalReceived += principalThisMonth;
                            cohort.remainingPrincipal -= principalThisMonth;
                            cohort.paymentsMadeMonths++;

                            // NIIF 15: Reconocimiento de Margen por OriginaciÃ³n basado en amortizaciÃ³n de principal
                            if (cohort.originalPrincipal > 0) { // Evitar divisiÃ³n por cero
                                const recognitionRatioThisMonth = principalThisMonth / cohort.originalPrincipal;
                                const recognizedRevenueThisMonthFromOrigination = cohort.originationCommissionInitial * recognitionRatioThisMonth;
                                
                                annualOriginationCommissionRecognized += recognizedRevenueThisMonthFromOrigination;
                                
                                cohort.remainingOriginationCommission -= recognizedRevenueThisMonthFromOrigination;
                                cohort.remainingOriginationCommission = Math.max(0, cohort.remainingOriginationCommission); // Asegurar que no sea negativo
                            }
                        }
                        // Sumar el saldo restante de esta cohorte al total de CxC al final del aÃ±o
                        currentYearEndReceivables += Math.max(0, cohort.remainingPrincipal);
                    });
                    
                    // Calculate total ECL for the year based on average exposure per cohort (IFRS 9)
                    let totalECLForYear = 0;
                    let totalContractLiabilitiesBalance = 0; // Accumulate contract liabilities for BS

                    loanCohorts.forEach(cohort => {
                        // Only calculate ECL for cohorts that are active (have remaining principal or had at start of year)
                        if (cohort.remainingPrincipal > 0 || cohort.startOfYearPrincipal > 0) {
                            const avgExposureDuringYear = (cohort.startOfYearPrincipal + cohort.remainingPrincipal) / 2;
                            const cohortAge = (year + 1) - cohort.yearOriginated;
                            const adjustedPD = calculatePDBasedOnAge(cohortAge);

                            const cohortECL = avgExposureDuringYear * adjustedPD * modelData.lgd;
                            totalECLForYear += cohortECL;
                        }
                        // Accumulate remaining contract liabilities for the Balance Sheet from all cohorts
                        totalContractLiabilitiesBalance += cohort.remainingOriginationCommission;
                    });

                    let annualECLProvision = totalECLForYear;
                    annualECLProvision *= modelData.economicAdjustmentFactor; // Apply economic adjustment factor
                    const provisions = annualECLProvision * (modelData.proteccionRodando ? 0.5 : 1.0); // Apply "ProtecciÃ³n Rodando"
                    currentProvisionsBalance += provisions; // Accumulate for Balance Sheet
                    log(` Provisiones NIIF 9 (ECL) este aÃ±o: ${formatCurrency(provisions)}. Base outstanding: ${formatCurrency(currentYearEndReceivables)}`); // Corrected variable
                    
                    // --- ESTADO DE RESULTADOS (P&L) ---
                    const interestRevenue = annualInterestReceived;
                    const originationCommission = annualOriginationCommissionRecognized; // Ingreso reconocido en P&L
                    
                    // Calculate total active units (not Held For Sale)
                    const totalActiveUnits = fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0);
                    
                    const gnvCommissions = totalActiveUnits * modelData.gnvRevPerUnit * (modelData.comisionGNV / 100);
                    const sparePartsRevenue = addedUnits * modelData.refaccionesRevPerUnit * (modelData.margenRefacciones / 100);
                    const marketplaceRevenue = totalActiveUnits * modelData.marketplaceRevPerUnit * (modelData.marketplace / 100);
                    const totalRevenue = interestRevenue + originationCommission + gnvCommissions + sparePartsRevenue + marketplaceRevenue;
                    log(`Ingresos: Intereses=${formatCurrency(interestRevenue)}, OriginaciÃ³n=${formatCurrency(originationCommission)}, GNV=${formatCurrency(gnvCommissions)}, Refacciones=${formatCurrency(sparePartsRevenue)}, Marketplace=${formatCurrency(marketplaceRevenue)}`);
                    log(`TOTAL INGRESOS OPERATIVOS: ${formatCurrency(totalRevenue)}`);
                    
                    // Operating Expenses (OPEX)
                    const opex = totalRevenue * (modelData.opexRate / 100);
                    
                    const grossProfit = totalRevenue; // No COGS defined separately
                    const opexTotal = opex + provisions + impairment; // Group operating expenses including IFRS 9 & 5 for EBITDA calculation
                    const ebitda = grossProfit - opexTotal; // This EBITDA is Revenue - all operating expenses (incl. non-cash IFRS)
                    
                    const ebit = ebitda - annualDepreciation; // EBIT = EBITDA - Depreciation

                    const interestExpense = (year === 0 ? initialVentureDebtAmount : totalDebt) * (modelData.ventureDebtRate / 100);
                    const earningsBeforeTax = ebit - interestExpense; // EBT = EBIT - Interest Expense
                    const incomeTaxExpense = Math.max(0, earningsBeforeTax) * (modelData.corporateTaxRate / 100); // Taxes only on positive EBT
                    const netIncome = earningsBeforeTax - incomeTaxExpense; // Net Income
                    accumulatedEarnings += netIncome; // Accumulate earnings for Equity

                    // --- FLUJO DE EFECTIVO (CF) ---
                    // Delta Cuentas por Cobrar (Change in non-cash working capital)
                    const prevReceivablesBalance = (year === 0) ? 0 : financialResults.bs[year-1].receivables;
                    const deltaReceivables = currentYearEndReceivables - prevReceivablesBalance;

                    // Operating Cash Flow (Indirect Method):
                    // Net Income + Non-Cash Expenses (Depreciation, Provisions, Impairment) - Change in Working Capital (Receivables)
                    const operatingCash = netIncome + annualDepreciation + provisions + impairment - deltaReceivables;
                    
                    // Investing Cash Flow: Only includes CAPEX of vans. Loan origination handled in Op. Cash Flow via deltaReceivables.
                    const investingCash = -capexThisYear; // Corrected: Removed totalPrincipalOriginatedThisYear to avoid double counting.
                    log(` Flujo de InversiÃ³n (CAPEX vagonetas): ${formatCurrency(investingCash)}`);
                    
                    let financingCashThisPeriod = 0; // Represents net financing activities for *this* period
                    let principalPaymentVentureDebtThisPeriod = 0; // To store in CF results
                    let newEquityRaisedThisPeriod = 0; // Accumulates Series B, C, and liquidity plug
                    let additionalFundingRaised = 0; // Declared here to ensure its scope

                    // Staggered capital contributions (Series B and C)
                    if (year + 1 === modelData.seriesB_year) {
                        financingCashThisPeriod += modelData.seriesB_funding;
                        newEquityRaisedThisPeriod += modelData.seriesB_funding;
                        log(`  ðŸŽ‰  Recibido funding Serie B en AÃ±o ${year+1}: ${formatCurrency(modelData.seriesB_funding)}`);
                    }
                    if (year + 1 === modelData.seriesC_year) {
                        financingCashThisPeriod += modelData.seriesC_funding;
                        newEquityRaisedThisPeriod += modelData.seriesC_funding;
                        log(`  ðŸŽ‰  Recibido funding Serie C en AÃ±o ${year+1}: ${formatCurrency(modelData.seriesC_funding)}`);
                    }
                    
                    // Principal payment for initial Venture Debt
                    if (totalDebt > 0 && modelData.periodoAmortizacionDeuda > 0) {
                        const annualPrincipalPaymentFixed = initialVentureDebtAmount / modelData.periodoAmortizacionDeuda;
                        principalPaymentVentureDebtThisPeriod = Math.min(annualPrincipalPaymentFixed, totalDebt); // Ensure payment does not exceed remaining debt
                        totalDebt = Math.max(0, totalDebt - principalPaymentVentureDebtThisPeriod); // Reduce remaining debt balance
                        financingCashThisPeriod -= principalPaymentVentureDebtThisPeriod; // El pago es una salida de efectivo
                    }
                    
                    // Calculate provisional net cash for the period BEFORE liquidity plug
                    let netCashBeforePlug = operatingCash + investingCash + financingCashThisPeriod;
                    
                    // PLUG DE LIQUIDEZ: Si el efectivo cae por debajo de cero, asumir financiaciÃ³n adicional
                    const prospectiveCash = cash + netCashBeforePlug;
                    if (prospectiveCash < 0) {
                        additionalFundingRaised = -prospectiveCash; // Monto para llevar el efectivo a cero
                        financingCashThisPeriod += additionalFundingRaised;
                        newEquityRaisedThisPeriod += additionalFundingRaised; // El plug se considera equity adicional
                    }
                    // Final Net Cash flow for the period
                    let netCash = operatingCash + investingCash + financingCashThisPeriod;
                    cash += netCash; // Actualizar el saldo de efectivo total

                    // Update `contractLiabilitiesBalance` for Balance Sheet with the accumulated value
                    const contractLiabilitiesBalance = totalContractLiabilitiesBalance; 
                    
                    // --- BALANCE GENERAL (BS) ---
                    // Activos Fijos Netos: Suma de costos originales menos depreciaciÃ³n acumulada de activos activos
                    let totalOriginalCostPPandE = fixedAssetsCohorts.reduce((sum, c) => sum + c.totalOriginalCost, 0);
                    let totalAccumulatedDepreciationPPandE = fixedAssetsCohorts.reduce((sum, c) => sum + c.accumulatedDepreciation, 0);
                    const fixedAssetsNet = totalOriginalCostPPandE - totalAccumulatedDepreciationPPandE;

                    // Valor total de activos clasificados como NIIF 5 para el Balance
                    const assetsHeldForSaleNet = heldForSaleAssets.reduce((sum, asset) => sum + asset.currentFairValueLessCosts, 0);
                    
                    // Total Activos
                    const totalAssets = cash + currentYearEndReceivables + fixedAssetsNet + assetsHeldForSaleNet; // currentYearEndReceivables es el saldo de CxC
                    
                    // Total Pasivos + Patrimonio
                    const totalLiabilitiesEquity = totalDebt + currentProvisionsBalance + contractLiabilitiesBalance + endOfYearEquity; // AÃ±adir contractLiabilitiesBalance
                    
                    // ValidaciÃ³n de Balance: Compara Total Activos y Total Pasivos + Patrimonio
                    const balanceDiff = Math.abs(totalAssets - totalLiabilitiesEquity);
                    log(`Diferencia de Balance AÃ±o ${year + 1}: ${formatCurrency(balanceDiff)}`);
                    
                    // --- CÃLCULO DE MÃ‰TRICAS ANUALES (ROE, ROIC) ---
                    const averageEquity = (startOfYearEquity + endOfYearEquity) / 2;
                    const averageInvestedCapital = (startOfYearEquity + startOfYearTotalDebt + endOfYearEquity + totalDebt) / 2; // Average Equity + Average Debt
                    
                    let annualROE = 0;
                    if (averageEquity !== 0) annualROE = (netIncome / averageEquity) * 100;
                    
                    let annualROIC = 0;
                    // NOPAT = EBIT * (1 - Tax Rate)
                    const nopat = ebit * (1 - (modelData.corporateTaxRate / 100)); // Using `ebit` which is after operating expenses, before interest.
                    if (averageInvestedCapital !== 0) annualROIC = (nopat / averageInvestedCapital) * 100;
                    financialResults.roe.push(annualROE);
                    financialResults.roic.push(annualROIC);
                    
                    // --- ALMACENAMIENTO DE RESULTADOS ANUALES ---
                    financialResults.pl.push({
                        interestRevenue, originationCommission, gnvCommissions, sparePartsRevenue, marketplaceRevenue, totalRevenue,
                        opex, provisions, impairment, ebitda, ebit,
                        depreciation: annualDepreciation, interestExpense, earningsBeforeTax, incomeTaxExpense, netIncome,
                        cumulativeUnits: fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0) // Total de unidades para la TIR Cartera
                    });
                    financialResults.cf.push({
                        operatingCash, investingCash, financingCash: financingCashThisPeriod, netCash,
                        principalPaymentVentureDebt: principalPaymentVentureDebtThisPeriod, // Pago de principal de Venture Debt
                        clientPrincipalPaymentsReceived: annualPrincipalReceived, // Pagos de principal de clientes
                        additionalFundingRaised: additionalFundingRaised // Plug de liquidez
                    });
                    financialResults.bs.push({
                        cash, receivables: currentYearEndReceivables, fixedAssets: fixedAssetsNet, 
                        assetsHeldForSale: assetsHeldForSaleNet, totalAssets,
                        debt: totalDebt, provisions: currentProvisionsBalance, contractLiabilities: contractLiabilitiesBalance, equity: endOfYearEquity, totalLiabilitiesEquity
                    });
                    
                    // --- DETALLES NIIF ---
                    financialResults.niifDetails.push({
                        niif15: {
                            // Total potencial de ingresos del contrato por obligaciones de desempeÃ±o este aÃ±o (excluyendo intereses NIIF 9)
                            totalContractValueFromPerformanceObligations: currentYearOriginationContractValue + gnvCommissions + sparePartsRevenue + marketplaceRevenue,
                            // Margen de originaciÃ³n inicial para los nuevos prÃ©stamos de este aÃ±o (el valor que se diferirÃ¡)
                            originationContractValueInitial: currentYearOriginationContractValue,
                            // Margen de originaciÃ³n reconocido en P&L este aÃ±o (basado en amortizaciÃ³n)
                            recognizedOriginationRevenue: originationCommission, 
                            // Saldo acumulado de pasivos por contrato al final del aÃ±o
                            contractLiabilitiesBalance: contractLiabilitiesBalance, 
                            // Otros ingresos NIIF 15 reconocidos en P&L este aÃ±o
                            gnvCommissions: gnvCommissions,
                            sparePartsRevenue: sparePartsRevenue,
                            marketplaceRevenue: marketplaceRevenue
                        },
                        niif9: {
                            // Datos NIIF 9 basados en la nueva lÃ³gica de ECL
                            totalOutstandingPrincipal: currentYearEndReceivables, // Total de cuentas por cobrar al final del aÃ±o (exposiciÃ³n)
                            totalECLBeforeAdjustment: totalECLForYear, // ECL total calculado anualmente antes de ajustes
                            economicAdjustmentFactor: modelData.economicAdjustmentFactor,
                            provisionesSinProteccion: annualECLProvision, 
                            provisionesConProteccion: provisions, 
                            reduccionPorProteccion: annualECLProvision - provisions,
                            saldoProvisionesAcumulado: currentProvisionsBalance, 
                            proteccionRodandoActiva: modelData.proteccionRodando,
                            // ParÃ¡metros de la lÃ³gica ECL (para referencia)
                            pdStage1: modelData.pdStage1,
                            pdStage2: modelData.pdStage2,
                            pdStage3: modelData.pdStage3,
                            lgd: modelData.lgd
                        },
                        niif5: {
                            unidadesClasificadasAnuales: unitsToRepossess, 
                            valorEnLibrosClasificado: valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount, 
                            valorRazonable: valueOfAssetsReclassifiedToNIIF5ThisYearFairValue,
                            costosDeVenta: valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell,
                            valorRazonableMenosCostos: valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue,
                            perdidaPorDeterioro: totalImpairmentThisYear, 
                            saldoActivosParaVentaAcumulado: assetsHeldForSaleNet, 
                            totalUnitsAccumulatedHeldForSale: totalUnitsAccumulatedHeldForSale 
                        }
                    });
                    
                    // Flujo para TIR Cartera
                    portfolioCashFlowsForIRR.push(interestRevenue - provisions - (interestRevenue * 0.05)); // Incluir 5% de costo operativo de cartera
                    
                    // Flujo para TIR Equity (despuÃ©s de impuestos y ajuste de financiamiento)
                    equityCashFlows.push(netCash); // `netCash` represents FCFE in this model.

                    // Flujo para TIR Proyecto (FCFF)
                    // FCFF = NOPAT + Non-Cash D&A and Provisions - CAPEX - Change in WC
                    const fcffThisYear = nopat + annualDepreciation + provisions + impairment - capexThisYear - deltaReceivables;
                    projectCashFlows.push(fcffThisYear);
                }
                
                // ===== VALOR RESIDUAL DE ACTIVOS (Para TIR Proyecto) =====
                // Se calcula el valor de los activos al final del periodo de proyecciÃ³n (AÃ±o 5)
                const totalFixedAssetsAtEnd = fixedAssetsCohorts.reduce((sum, cohort) => sum + (cohort.totalOriginalCost - cohort.accumulatedDepreciation), 0);
                const totalReceivablesAtEnd = financialResults.bs[4].receivables;
                const totalAssetsHeldForSaleAtEnd = financialResults.bs[4].assetsHeldForSale;
                const terminalValue = totalFixedAssetsAtEnd + totalReceivablesAtEnd + totalAssetsHeldForSaleAtEnd;
                projectCashFlows[projectCashFlows.length - 1] += terminalValue; // AÃ±adir al Ãºltimo flujo de projectCashFlows
                log(` Valor Residual de Activos (AÃ±o 5): ${formatCurrency(terminalValue)} (aÃ±adido a TIR Proyecto)`);
                // ===== CÃLCULO DE TIRs FINALES (despuÃ©s del bucle anual) =====
                log('\nCalculando TIR Proyecto...');
                financialResults.tirProyecto = calculateIRR(projectCashFlows);
                log(`TIR Proyecto calculada: ${financialResults.tirProyecto.toFixed(2)}%`);
                
                log('Calculando TIR Cartera...');
                if (portfolioCashFlowsForIRR.length > 0) {
                    // TIR Cartera: InversiÃ³n inicial es el total principal originado por prÃ©stamos a clientes.
                    const carteraInitialInvestment = totalPrincipalOriginatedAcrossAllYears;
                    
                    const carteraCashFlows = [-carteraInitialInvestment, ...portfolioCashFlowsForIRR];
                    financialResults.tirCartera = calculateIRR(carteraCashFlows);
                } else {
                    financialResults.tirCartera = 0; // Si no hay flujos, TIR es 0
                }
                log(`TIR Cartera calculada: ${financialResults.tirCartera.toFixed(2)}%`);
                log('Calculando TIR Equity...');
                financialResults.tirEquity = calculateIRR(equityCashFlows);
                log(`TIR Equity calculada: ${financialResults.tirEquity.toFixed(2)}%`);
                log('  âœ…  CÃLCULOS FINANCIEROS COMPLETADOS CORRECTAMENTE');
                return true; // Indica que el cÃ¡lculo fue exitoso
                
            } catch (error) {
                log(`  âŒ  ERROR en calculateFinancials: ${error.message}`);
                console.error('Error crÃ­tico en cÃ¡lculos financieros:', error);
                return false; // Indica que hubo un error
            }
        }
        // ===== FUNCIÃ“N DE CÃLCULO DE TIR (Tasa Interna de Retorno) =====
        // ImplementaciÃ³n del mÃ©todo Newton-Raphson para calcular la TIR
        function calculateIRR(cashFlows, maxIterations = 100, tolerance = 1e-6) {
            try {
                // ValidaciÃ³n bÃ¡sica de los flujos de efectivo
                if (!cashFlows || cashFlows.length < 2) {
                    log('TIR: Flujos insuficientes.');
                    return 0;
                }
                
                // Debe haber al menos un flujo positivo y uno negativo para que una TIR sea significativa
                const hasPositive = cashFlows.some(cf => cf > 0);
                const hasNegative = cashFlows.some(cf => cf < 0);
                if (!hasPositive || !hasNegative) {
                    log('TIR: No hay flujos positivos y negativos, TIR indefinida.');
                    return 0;
                }
                
                let guess = 0.1; // EstimaciÃ³n inicial de la TIR (10%)
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;    // Valor Presente Neto
                    let dNpv = 0;   // Derivada del NPV (para Newton-Raphson)
                    
                    for (let t = 0; t < cashFlows.length; t++) {
                        const denominator = Math.pow(1 + guess, t);
                        npv += cashFlows[t] / denominator;
                        if (t > 0) { // La derivada solo aplica a tÃ©rminos futuros
                            dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                        }
                    }
                    
                    // Si el NPV es cercano a cero, hemos encontrado la TIR
                    if (Math.abs(npv) < tolerance) {
                        // Retorna el resultado como porcentaje, limitado a un rango razonable
                        const result = Math.max(-99, Math.min(200, guess * 100)); 
                        log(`TIR convergiÃ³ en ${i} iteraciones: ${result.toFixed(2)}%`);
                        return result;
                    }
                    
                    // Evitar divisiÃ³n por cero si la derivada es muy pequeÃ±a
                    if (Math.abs(dNpv) < tolerance) {
                         log('TIR: Derivada cercana a cero, no se puede mejorar mÃ¡s.');
                         break;
                    }
                   
                    // Nuevo intento usando la fÃ³rmula de Newton-Raphson
                    const newGuess = guess - npv / dNpv;
                    // Si la mejora es mÃ­nima, detener la iteraciÃ³n
                    if (Math.abs(newGuess - guess) < tolerance) { 
                        const result = Math.max(-99, Math.min(200, newGuess * 100));
                        log(`TIR: Convergencia mÃ­nima, finalizando en ${i} iteraciones: ${result.toFixed(2)}%`);
                        return result;
                    }
                    
                    // Actualizar el intento, asegurando que 1 + guess sea siempre positivo para evitar NaN
                    guess = Math.max(-0.99, Math.min(5, newGuess)); 
                }
                
                // Si no se converge despuÃ©s de maxIterations, retornar el mejor intento
                const result = Math.max(-99, Math.min(200, guess * 100));
                log(`TIR no convergiÃ³ completamente (Max iteraciones): ${result.toFixed(2)}%`);
                return result; 
                
            } catch (error) {
                log(`Error inesperado calculando TIR: ${error.message}`);
                return 0; // En caso de cualquier error, retornar 0
            }
        }
        // ===== ACTUALIZACIÃ“N DE INTERFAZ DE USUARIO (UI) =====
        // Actualiza las mÃ©tricas clave en las tarjetas de resumen y luego las tablas y grÃ¡ficos
        function updateUI() {
            log('  ðŸ”„  Actualizando Interfaz de Usuario...');
            try {
                if (!financialResults.pl || financialResults.pl.length === 0) {
                    log('  âŒ  No hay datos financieros para actualizar la UI.');
                    return;
                }
                
                // Actualizar las tarjetas de resumen
                const year5PL = financialResults.pl[4];
                const year5BS = financialResults.bs[4];
                // Calcular total de unidades financiadas sumando todos los aÃ±os
                // Nota: totalUnitsAcquired es el total de unidades compradas a lo largo de los 5 aÃ±os.
                const totalUnitsAcquired = modelData.unitsPerYear.reduce((acc, curr) => acc + curr, 0);
                // Vagonetas operativas: total de unidades adquiridas - total acumulado de unidades clasificadas NIIF5
                const vagonetasOperativas = totalUnitsAcquired - (financialResults.niifDetails[4]?.niif5?.totalUnitsAccumulatedHeldForSale || 0);
                if (year5PL && year5BS) {
                    document.getElementById('ebitda-year5').textContent = formatCurrency(year5PL.ebitda);
                    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                    document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                    document.getElementById('tir-equity').textContent = financialResults.tirEquity.toFixed(1) + '%';
                    document.getElementById('deuda-residual').textContent = formatCurrency(year5BS.debt);
                    document.getElementById('vagonetas-operativas').textContent = Math.round(vagonetasOperativas);
                    
                    // Display ROE and ROIC for Year 5
                    document.getElementById('roe-year5').textContent = financialResults.roe[4].toFixed(1) + '%';
                    document.getElementById('roic-year5').textContent = financialResults.roic[4].toFixed(1) + '%';
                    log(`  âœ…  MÃ©tricas principales y de rentabilidad actualizadas.`);
                    // Benchmarking al log de debug
                    log(` --- Benchmarking de Rentabilidad (AÃ±o 5) ---`);
                    log(` TIR Equity: ${financialResults.tirEquity.toFixed(1)}% (Target Industria: 20-30%)`);
                    log(` TIR Proyecto: ${financialResults.tirProyecto.toFixed(1)}% (Target Industria: 15-20%)`);
                    log(` TIR Cartera: ${financialResults.tirCartera.toFixed(1)}% (Target Industria: 25-35%)`);
                    log(` ROE: ${financialResults.roe[4].toFixed(1)}% (Target Industria: 25-35%)`);
                    log(` ROIC: ${financialResults.roic[4].toFixed(1)}% (Target Industria: 12-18%)`);
                } else {
                    log('  âš ï¸  Datos de AÃ±o 5 incompletos para actualizar mÃ©tricas principales.');
                }
                
                updateTables(); // Actualiza tablas P&L, CF, BS
                updateNIIFTables(); // Actualiza tablas de detalles NIIF
                updateCharts(); // Actualiza grÃ¡ficos
                // Ejecutar y mostrar validaciones despuÃ©s de actualizar la UI
                const validations = validateModelComprehensively(modelData, financialResults);
                updateValidationPanel(validations);
                
            } catch (error) {
                log(`  âŒ  Error en updateUI: ${error.message}`);
                console.error('Error al actualizar UI:', error);
            }
        }
        // FunciÃ³n que coordina la actualizaciÃ³n de todas las tablas financieras
        function updateTables() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
        }
        // Actualiza la tabla del Estado de Resultados (P&L)
        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody || !financialResults.pl.length) return;
            
            tbody.innerHTML = ''; // Limpiar tabla
            
            // DefiniciÃ³n de las filas del P&L
            const rows = [
                { label: 'Ingresos por Intereses', key: 'interestRevenue' },
                { label: 'Margen por OriginaciÃ³n', key: 'originationCommission' },
                { label: 'Comisiones GNV', key: 'gnvCommissions' },
                { label: 'Ingresos Refacciones', key: 'sparePartsRevenue' },
                { label: 'Ingresos Marketplace', key: 'marketplaceRevenue' },
                { label: 'Total Ingresos Operativos', key: 'totalRevenue', total: true },
                { label: 'Gastos Operativos (OPEX)', key: 'opex', negative: true },
                { label: 'Provisiones NIIF 9', key: 'provisions', negative: true },
                { label: 'PÃ©rdida por Deterioro NIIF 5', key: 'impairment', negative: true },
                { label: 'EBITDA', key: 'ebitda', total: true, emphasize: true },
                { label: 'DepreciaciÃ³n', key: 'depreciation', negative: true },
                { label: 'EBIT', key: 'ebit', total: true }, // Nuevo EBIT
                { label: 'Gastos por Intereses (Deuda)', key: 'interestExpense', negative: true },
                { label: 'Ganancia Antes de Impuestos (EBT)', key: 'earningsBeforeTax', total: true }, // Nuevo EBT
                { label: 'Impuesto sobre la Renta', key: 'incomeTaxExpense', negative: true }, // Nuevo Impuesto
                { label: 'Utilidad Neta', key: 'netIncome', total: true, emphasize: true }
            ];
            // Rellenar la tabla dinÃ¡micamente
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50'); // Fondo para totales
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900'); // Negrita para EBITDA y Utilidad Neta
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.pl.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[row.key] || 0; // Obtener el valor, o 0 si es undefined
                    
                    // Formatear y aplicar clases de color
                    if (row.negative && value > 0) { // Si es un gasto y el valor es positivo, mostrar entre parÃ©ntesis y en rojo
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else { // Si no es un gasto o el valor es negativo, mostrar directamente
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
            log('  âœ…  Tabla de Estado de Resultados actualizada.');
        }
        // Actualiza la tabla del Flujo de Efectivo (CF)
        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody || !financialResults.cf.length) return;
            
            tbody.innerHTML = ''; // Limpiar tabla
            
            // DefiniciÃ³n de las filas del Flujo de Efectivo
            const rows = [
                { label: 'Flujo de Efectivo Operativo', total: true },
                { label: '  Utilidad Neta', key: 'netIncome', fromPL: true },
                { label: '  + DepreciaciÃ³n', key: 'depreciation', fromPL: true },
                { label: '  + Provisiones NIIF 9', key: 'provisions', fromPL: true },
                { label: '  + PÃ©rdida por Deterioro NIIF 5', key: 'impairment', fromPL: true },
                { label: '  - Î” Cuentas por Cobrar', key: 'deltaReceivables', negative: true, calculateDelta: true },
                { label: 'Total Flujo de Efectivo Operativo', key: 'operatingCash', total: true, emphasize: true },
                { label: 'Flujo de Efectivo de InversiÃ³n', total: true, separator: true },
                { label: '  - CAPEX Vagonetas (Activos Fijos)', key: 'investingCash_capex', negative: true }, // Detalle de CAPEX
                // { label: '  - OriginaciÃ³n de PrÃ©stamos Clientes', key: 'investingCash_loans', negative: true }, // Ya no se muestra aquÃ­
                { label: 'Total Flujo de Efectivo de InversiÃ³n', key: 'investingCash', total: true, emphasize: true, duplicate: true },
                
                { label: 'Flujo de Efectivo de FinanciaciÃ³n', total: true, separator: true },
                { label: '  Serie A Recibida', year0: modelData.seriesA },
                { label: '  Venture Debt Inicial Recibido', year0: modelData.seriesA * (modelData.ventureDebtPct / 100) },
                { label: '  Serie B Funding Recibido', key: 'seriesB_funding', fromModelData: true, yearSpecific: true },
                { label: '  Serie C Funding Recibido', key: 'seriesC_funding', fromModelData: true, yearSpecific: true },
                { label: '  - Pago Capital Venture Debt', key: 'principalPaymentVentureDebt', negative: true },
                { label: '  + Funding Adicional (Plug de Liquidez)', key: 'additionalFundingRaised', positive: true }, // Nueva lÃ­nea para plug
                { label: 'Total Flujo de Efectivo de FinanciaciÃ³n', key: 'financingCash', total: true, emphasize: true, duplicate: true },
                
                { label: 'Incremento Neto de Efectivo', key: 'netCash', total: true, separator: true, emphasize: true },
                { label: 'Saldo de Efectivo al Final del Periodo', key: 'cash', fromBS: true, total: true, emphasize: true }
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                if (row.separator) tr.classList.add('border-t-2', 'border-gray-200'); // Separador para secciones de flujo
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                // Celda para AÃ±o 0
                const cell0 = document.createElement('td');
                if (row.year0 !== undefined) {
                    cell0.textContent = formatCurrency(row.year0);
                    cell0.classList.add('positive', 'font-bold');
                } else if (row.key === 'netCash' && financialResults.cf.length > 0) { // Net cash year 0 should be total Series A + Venture Debt received
                     const initialTotalFunding = modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100));
                     cell0.textContent = formatCurrency(initialTotalFunding);
                     cell0.classList.add('positive', 'font-bold');
                } else if (row.key === 'cash' && financialResults.cf.length > 0) { // Cash balance year 0 should be total Series A + Venture Debt
                     const initialTotalFunding = modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100));
                     cell0.textContent = formatCurrency(initialTotalFunding);
                     cell0.classList.add('positive', 'font-bold');
                }
                else {
                    cell0.textContent = '-'; // No hay valores para AÃ±o 0 en otras filas
                }
                tr.appendChild(cell0);
                
                // Celdas para AÃ±os 1-5
                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value;
                    if (row.fromPL) {
                        value = financialResults.pl[i][row.key] || 0;
                    } else if (row.fromBS) {
                        value = financialResults.bs[i][row.key] || 0;
                    } else if (row.key === 'principalPaymentVentureDebt') { 
                         value = financialResults.cf[i].principalPaymentVentureDebt || 0;
                    } else if (row.key === 'clientPrincipalPaymentsReceived') {
                        value = financialResults.cf[i].clientPrincipalPaymentsReceived || 0;
                    } else if (row.key === 'additionalFundingRaised') {
                        value = financialResults.cf[i].additionalFundingRaised || 0;
                    } else if (row.key === 'investingCash_capex') {
                        value = modelData.unitsPerYear[i] * modelData.vanCost; // CAPEX de vagonetas para este aÃ±o
                    } else if (row.key === 'investingCash_loans') {
                        value = 0; // Se elimina el detalle de originaciÃ³n de prÃ©stamos aquÃ­ ya que no es un flujo separado en este punto
                    }
                    else if (row.key === 'deltaReceivables') {
                        // Delta de CxC es especial porque se calcula de aÃ±o a aÃ±o.
                        const prevReceivables = (i === 0) ? 0 : financialResults.bs[i-1].receivables;
                        const currentReceivables = financialResults.bs[i].receivables;
                        value = currentReceivables - prevReceivables;
                    } else if (row.fromModelData && row.yearSpecific) {
                        // Handle Series B and C funding
                        const currentYear = i + 1;
                        if (row.key === 'seriesB_funding' && currentYear === modelData.seriesB_year) {
                            value = modelData.seriesB_funding;
                        } else if (row.key === 'seriesC_funding' && currentYear === modelData.seriesC_year) {
                            value = modelData.seriesC_funding;
                        } else {
                            value = 0; // No funding in this year for this series
                        }
                    }
                     else {
                        value = financialResults.cf[i][row.key] || 0;
                    }
                    
                    // Formato y color
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else if (row.positive && value > 0) {
                         cell.textContent = formatCurrency(value);
                         cell.classList.add('positive');
                    }
                    else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                }
                
                tbody.appendChild(tr);
            });
            log('  âœ…  Tabla de Flujo de Efectivo actualizada.');
        }
        // Actualiza la tabla del Balance General (BS)
        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody || !financialResults.bs.length) return;
            
            tbody.innerHTML = ''; // Limpiar tabla
            
            // DefiniciÃ³n de las filas del Balance General
            const rows = [
                { label: 'ACTIVOS', total: true, emphasize: true },
                { label: '  Efectivo y Equivalentes', key: 'cash' },
                { label: '  Cuentas por Cobrar (Principal)', key: 'receivables' },
                { label: '  Activos Fijos Netos (Vagonetas)', key: 'fixedAssets' },
                { label: '  Activos Mantenidos para Venta (NIIF 5)', key: 'assetsHeldForSale' },
                { label: 'TOTAL ACTIVOS', key: 'totalAssets', total: true, emphasize: true },
                { label: 'PASIVOS Y PATRIMONIO', total: true, separator: true, emphasize: true },
                { label: '  Deuda Venture', key: 'debt' },
                { label: '  Provisiones NIIF 9 (Acumuladas)', key: 'provisions' },
                { label: '  Pasivos por Contrato (NIIF 15)', key: 'contractLiabilities' }, // Nueva lÃ­nea para pasivos por contrato
                { label: 'TOTAL PASIVOS', key: 'totalLiabilities', total: true }, 
                { label: '  Patrimonio', key: 'equity' },
                { label: 'TOTAL PASIVOS + PATRIMONIO', key: 'totalLiabilitiesEquity', total: true, emphasize: true }
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                if (row.separator) tr.classList.add('border-t-2', 'border-gray-200');
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.bs.forEach(yearData => {
                    const cell = document.createElement('td');
                    let value;
                    if (row.key === 'totalLiabilities') { // CÃ¡lculo especÃ­fico para Total Pasivos
                        value = yearData.debt + yearData.provisions + yearData.contractLiabilities;
                    } else {
                        value = yearData[row.key] || 0;
                    }
                    
                    // Formato y color
                    if (value > 0 && !row.negative) cell.classList.add('positive');
                    if (value < 0) cell.classList.add('negative');
                    cell.textContent = formatCurrency(value);
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
            // Validar Balance (Activos = Pasivos + Patrimonio)
            // Note: This basic balance validation is now part of the comprehensive validation system.
            // Keeping it here for quick reference but `updateValidationPanel` will show the detailed result.
            const validationDiv = document.getElementById('balance-validation');
            let balanceValid = true;
            let maxDifference = 0;
            
            financialResults.bs.forEach(yearData => {
                const difference = Math.abs(yearData.totalAssets - yearData.totalLiabilitiesEquity);
                maxDifference = Math.max(maxDifference, difference);
                if (difference > 1000) balanceValid = false; // Tolerancia de $1,000 para la validaciÃ³n
            });
            if (balanceValid) {
                validationDiv.innerHTML = '<span class="text-green-600">  âœ…  Balance validado: Total Activos = Total Pasivos + Patrimonio.</span>';
                validationDiv.classList.remove('bg-red-100', 'text-red-800');
                validationDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                validationDiv.innerHTML = `<span class="text-red-600">  âŒ  Error en balance: Diferencia de ${formatCurrency(maxDifference)}. Revise cÃ¡lculos.</span>`;
                validationDiv.classList.remove('bg-green-100', 'text-green-800');
                validationDiv.classList.add('bg-red-100', 'text-red-800');
            }
            log('  âœ…  Tabla de Balance General actualizada y validada.');
        }
        // ===== TABLAS DE DETALLES NIIF =====
        // Actualiza las secciones de NIIF 15, NIIF 9 y NIIF 5
        function updateNIIFTables() {
            log('Actualizando tablas de detalles NIIF...');
            if (!financialResults.niifDetails || financialResults.niifDetails.length === 0) {
                log('  âŒ  No hay datos NIIF para mostrar.');
                return;
            }
            
            // --- NIIF 15: Reconocimiento de Ingresos ---
            const container15 = document.getElementById('niif15-container');
            if (container15) {
                container15.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>AÃ±o 1</th>
                                    <th>AÃ±o 2</th>
                                    <th>AÃ±o 3</th>
                                    <th>AÃ±o 4</th>
                                    <th>AÃ±o 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Total Ingresos por Obl. de DesempeÃ±o (Contrato)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.totalContractValueFromPerformanceObligations)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Margen OriginaciÃ³n (Inicial por Cohorte Nueva)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.originationContractValueInitial)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Margen OriginaciÃ³n (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td class="positive">${formatCurrency(d.niif15.recognizedOriginationRevenue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Pasivos por Contrato (Acumulado)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.contractLiabilitiesBalance)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos GNV (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.gnvCommissions)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos Refacciones (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.sparePartsRevenue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos Marketplace (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.marketplaceRevenue)}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                        <h5 class="font-semibold text-base mb-1">ExplicaciÃ³n NIIF 15 (Ingresos Ordinarios)</h5>
                        <p class="mb-1">â€¢ NIIF 15 establece un modelo de 5 pasos para reconocer ingresos que provienen de contratos con clientes. La clave es reconocer los ingresos cuando (o a medida que) se satisfacen las **obligaciones de desempeÃ±o**.</p>
                        <p class="mb-1">â€¢ Para Rodando a Gas, se identifican las siguientes obligaciones de desempeÃ±o:</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>**Margen por OriginaciÃ³n (comisiÃ³n inicial):** Se reconoce **a lo largo del tiempo** durante la vida del prÃ©stamo al cliente, proporcionalmente a la amortizaciÃ³n del capital. El efectivo se puede recibir upfront, pero contablemente se difiere como un "Pasivo por Contrato" y se reconoce como ingreso gradualmente.</li>
                            <li>**Servicios GNV y Marketplace:** Se reconocen **a lo largo del tiempo** a medida que los servicios se proveen anualmente por las unidades activas en la cartera.</li>
                            <li>**Servicios de Refacciones:** Se reconoce **en un punto en el tiempo** (al momento de la entrega del servicio/producto de refacciÃ³n, asumido en el aÃ±o de adiciÃ³n de la unidad).</li>
                        </ul>
                        <p class="mb-1">â€¢ Los ingresos por intereses se rigen por NIIF 9 (Instrumentos Financieros), no por NIIF 15.</p>
                        <p class="mb-1">â€¢ El Balance General ahora refleja los **Pasivos por Contrato** para los ingresos de originaciÃ³n que han sido cobrados pero aÃºn no reconocidos.</p>
                    </div>
                `;
                log('  âœ…  NIIF 15 actualizada.');
            }
            
            // --- NIIF 9: Provisiones Crediticias ---
            const container9 = document.getElementById('niif9-container');
            if (container9) {
                const year5NIIF9 = financialResults.niifDetails[4]?.niif9; // Obtener datos del AÃ±o 5 para el resumen
                if (year5NIIF9) {
                    container9.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="p-4 bg-blue-100 rounded-lg text-center">
                                <h5 class="font-semibold text-blue-800">ExposiciÃ³n Promedio Etapa 1</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.totalOutstandingPrincipal * modelData.portfolioAllocationStage1)}</p>
                                <p class="text-sm">PD: ${(year5NIIF9.pdStage1 * 100).toFixed(1)}%</p>
                                <p class="text-lg font-bold text-blue-900">${formatCurrency(year5NIIF9.totalECLBeforeAdjustment * modelData.portfolioAllocationStage1)} (ECL)</p>
                            </div>
                            <div class="p-4 bg-yellow-100 rounded-lg text-center">
                                <h5 class="font-semibold text-yellow-800">ExposiciÃ³n Promedio Etapa 2</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.totalOutstandingPrincipal * modelData.portfolioAllocationStage2)}</p>
                                <p class="text-sm">PD: ${(year5NIIF9.pdStage2 * 100).toFixed(1)}%</p>
                                <p class="text-lg font-bold text-yellow-900">${formatCurrency(year5NIIF9.totalECLBeforeAdjustment * modelData.portfolioAllocationStage2)} (ECL)</p>
                            </div>
                            <div class="p-4 bg-red-100 rounded-lg text-center">
                                <h5 class="font-semibold text-red-800">ExposiciÃ³n Promedio Etapa 3</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.totalOutstandingPrincipal * modelData.portfolioAllocationStage3)}</p>
                                <p class="text-sm">PD: ${(year5NIIF9.pdStage3 * 100).toFixed(1)}%</p>
                                <p class="text-lg font-bold text-red-900">${formatCurrency(year5NIIF9.totalECLBeforeAdjustment * modelData.portfolioAllocationStage3)} (ECL)</p>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-indigo-50 rounded-lg mb-4">
                            <h5 class="font-semibold text-indigo-900">Total Provisiones ECL Antes de Ajustes</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.totalECLBeforeAdjustment)}</p>
                            <p class="text-sm">LGD: ${(year5NIIF9.lgd * 100).toFixed(1)}%. Ajuste EconÃ³mico: ${year5NIIF9.economicAdjustmentFactor.toFixed(2)}x</p>
                        </div>
                        <div class="text-center p-4 ${year5NIIF9.proteccionRodandoActiva ? 'bg-green-50' : 'bg-gray-200'} rounded-lg">
                            <h5 class="font-semibold ${year5NIIF9.proteccionRodandoActiva ? 'text-green-900' : 'text-gray-900'}">Gasto por Provisiones NIIF 9 (P&L del AÃ±o 5)</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.provisionesConProteccion)}</p>
                            ${year5NIIF9.proteccionRodandoActiva ? 
                                `<p class="text-sm text-green-700">  âœ…  ReducciÃ³n: ${formatCurrency(year5NIIF9.reduccionPorProteccion)}</p>` : 
                                '<p class="text-sm text-gray-700">ProtecciÃ³n Rodando inactiva</p>'}
                        </div>
                        <div class="mt-4 text-center p-4 bg-gray-300 rounded-lg">
                            <h5 class="font-semibold text-gray-900">Saldo Acumulado de Provisiones NIIF 9 (Balance AÃ±o 5)</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.saldoProvisionesAcumulado)}</p>
                            <p class="text-sm">Este es el pasivo acumulado que aparece en el Balance General.</p>
                        </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                            <h5 class="font-semibold text-base mb-1">ExplicaciÃ³n NIIF 9 (Instrumentos Financieros)</h5>
                            <p class="mb-1">â€¢ NIIF 9 requiere el reconocimiento de provisiones por pÃ©rdidas crediticias esperadas (ECL) sobre los instrumentos financieros (cartera de prÃ©stamos).</p>
                            <p class="mb-1">â€¢ **Modelo de Tres Etapas:** La cartera se segmenta por riesgo (aunque aquÃ­ simplificado por antigÃ¼edad del prÃ©stamo).</p>
                            <p class="mb-1">â€¢ **CÃ¡lculo de ECL:** ECL = ExposiciÃ³n Promedio Ã— Probabilidad de Incumplimiento (PD) Ã— PÃ©rdida Dado Incumplimiento (LGD).</p>
                            <p class="mb-1">â€¢ **InformaciÃ³n Prospectiva:** El factor de ajuste econÃ³mico permite incorporar expectativas futuras sobre el riesgo de crÃ©dito.</p>
                            <p class="mb-1">â€¢ "ProtecciÃ³n Rodando" simula un mecanismo que reduce el gasto final por provisiones.</p>
                            <p class="mt-2 text-red-700 font-bold">Nota: En este modelo, la asignaciÃ³n a etapas se simula mediante PDs que varÃ­an por antigÃ¼edad, lo cual es una simplificaciÃ³n comÃºn para modelos agregados de alto nivel, en lugar de un seguimiento individual de cada prÃ©stamo.</p>
                        </div>
                    `;
                    log('  âœ…  NIIF 9 actualizada.');
                } else {
                     log('  âš ï¸  Datos de NIIF 9 para AÃ±o 5 incompletos.');
                }
            }
            
            // --- NIIF 5: Activos Mantenidos para Venta ---
            const container5 = document.getElementById('niif5-container');
            if (container5) {
                const year5NIIF5 = financialResults.niifDetails[4]?.niif5; // Obtener datos del AÃ±o 5 para el resumen
                if (year5NIIF5) {
                    container5.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <h5 class="font-semibold text-purple-900">Unidades Reposadas (AÃ±o 5)</h5>
                                <p class="text-xl font-bold">${year5NIIF5.unidadesClasificadasAnuales.toFixed(0)}</p>
                                <p class="text-sm">Unidades clasificadas como mantenidas para venta este aÃ±o.</p>
                            </div>
                            <div class="p-4 bg-indigo-50 rounded-lg">
                                <h5 class="font-semibold text-indigo-900">Valor en Libros Original (Activos Reposedos AÃ±o 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorEnLibrosClasificado)}</p>
                                <p class="text-sm">Costo histÃ³rico de las unidades clasificadas para venta en el AÃ±o 5.</p>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h5 class="font-semibold text-blue-900">Valor Razonable Neto (AÃ±o 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorRazonableMenosCostos)}</p>
                                <p class="text-sm">Valor de venta esperado menos costos.</p>
                            </div>
                            <div class="p-4 ${year5NIIF5.perdidaPorDeterioro > 0 ? 'bg-red-50' : 'bg-green-50'} rounded-lg">
                                <h5 class="font-semibold ${year5NIIF5.perdidaPorDeterioro > 0 ? 'text-red-900' : 'text-green-900'}">PÃ©rdida por Deterioro (AÃ±o 5)</h5>
                                <p class="text-xl font-bold">${year5NIIF5.perdidaPorDeterioro > 0 ? formatCurrency(year5NIIF5.perdidaPorDeterioro) : 'Ninguna'}</p>
                                <p class="text-sm">Impacto en el Estado de Resultados.</p>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-gray-200 rounded-lg">
                             <h5 class="font-semibold text-gray-800">Saldo Acumulado de Activos NIIF 5 (AÃ±o 5)</h5>
                             <p class="text-2xl font-bold">${formatCurrency(year5NIIF5.saldoActivosParaVentaAcumulado)}</p>
                             <p class="text-sm">Este es el saldo que aparece en el Balance General.</p>
                         </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                            <h5 class="font-semibold text-base mb-1">ExplicaciÃ³n NIIF 5 (Activos No Corrientes Mantenidos para la Venta)</h5>
                            <p class="mb-1">â€¢ Los activos no corrientes (vagonetas) que se esperan vender en un corto plazo se clasifican como "Mantenidos para la Venta".</p>
                            <p class="mb-1">â€¢ Estos activos se valoran al menor entre su valor en libros y su valor razonable menos los costos de venta. Se suspende su depreciaciÃ³n.</p>
                            <p class="mb-1">â€¢ Se reconoce una pÃ©rdida por deterioro si el valor en libros excede el valor razonable neto de venta. Las ganancias por reversiÃ³n de deterioro estÃ¡n limitadas a la pÃ©rdida original.</p>
                        </div>
                    `;
                    log('  âœ…  NIIF 5 actualizada.');
                } else {
                    log('  âš ï¸  Datos de NIIF 5 para AÃ±o 5 incompletos.');
                }
            }
        }
        
        // ===== GRÃFICOS (Chart.js) =====
        // Inicializa las instancias de los grÃ¡ficos
        function initializeCharts() {
            try {
                // GrÃ¡fico de EBITDA
                const ctxEbitda = document.getElementById('ebitdaChart');
                if (ctxEbitda) {
                    charts.ebitda = new Chart(ctxEbitda, {
                        type: 'line',
                        data: {
                            labels: ['AÃ±o 1', 'AÃ±o 2', 'AÃ±o 3', 'AÃ±o 4', 'AÃ±o 5'],
                            datasets: [{
                                label: 'EBITDA (M MXN)',
                                data: [],
                                borderColor: '#3b82f6', // blue-500
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.3 // Suavizar la lÃ­nea
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'AÃ±o Fiscal' } }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
                
                // GrÃ¡fico de ComposiciÃ³n de Ingresos
                const ctxRevenueMix = document.getElementById('revenueMixChart');
                if (ctxRevenueMix) {
                    charts.revenueMix = new Chart(ctxRevenueMix, {
                        type: 'doughnut',
                        data: {
                            labels: ['Intereses', 'OriginaciÃ³n', 'GNV', 'Refacciones', 'Marketplace'],
                            datasets: [{
                                data: [],
                                backgroundColor: ['#34D399', '#FBBF24', '#60A5FA', '#8B5CF6', '#EC4899'] // Colores Tailwind: green, amber, blue, violet, pink
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right' },
                                title: { display: true, text: 'ComposiciÃ³n de Ingresos (AÃ±o 5)' }
                            }
                        }
                    });
                }
                // GrÃ¡fico de ValidaciÃ³n de Balance
                const ctxBalanceValidation = document.getElementById('balanceValidationChart');
                if (ctxBalanceValidation) {
                    charts.balanceValidation = new Chart(ctxBalanceValidation, {
                        type: 'bar',
                        data: {
                            labels: ['AÃ±o 1', 'AÃ±o 2', 'AÃ±o 3', 'AÃ±o 4', 'AÃ±o 5'],
                            datasets: [
                                {
                                    label: 'Total Activos',
                                    data: [],
                                    backgroundColor: '#3b82f6', // blue-500
                                },
                                {
                                    label: 'Total Pasivos + Patrimonio',
                                    data: [],
                                    backgroundColor: '#ef4444', // red-500
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'AÃ±o Fiscal' } }
                            },
                            plugins: {
                                legend: { position: 'top' }
                            }
                        }
                    });
                }
                // GrÃ¡fico de Flujo de Efectivo Neto Anual
                const ctxNetCashFlow = document.getElementById('netCashFlowChart');
                if (ctxNetCashFlow) {
                    charts.netCashFlow = new Chart(ctxNetCashFlow, {
                        type: 'bar',
                        data: {
                            labels: ['AÃ±o 1', 'AÃ±o 2', 'AÃ±o 3', 'AÃ±o 4', 'AÃ±o 5'],
                            datasets: [{
                                label: 'Flujo Neto de Efectivo (M MXN)',
                                backgroundColor: (context) => {
                                    // Verificar si context.parsed y context.parsed.y existen
                                    if (context.parsed && typeof context.parsed.y === 'number') {
                                        const value = context.parsed.y;
                                        return value >= 0 ? '#10b981' : '#ef4444'; // green-500 for positive, red-500 for negative
                                    }
                                    return '#6b7280'; // Default color if data is not yet available or invalid
                                }
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'AÃ±o Fiscal' } }
                            },
                             plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
                log('  âœ…  GrÃ¡ficos inicializados.');
            } catch (error) {
                log(`Error inicializando grÃ¡ficos: ${error.message}`);
                console.error('Error inicializando grÃ¡ficos:', error);
            }
        }
        
        // Actualiza los datos de los grÃ¡ficos con los resultados financieros actuales
        function updateCharts() {
            try {
                if (!financialResults.pl.length) return;
                
                // Actualizar GrÃ¡fico de EBITDA
                if (charts.ebitda) {
                    const ebitdas = financialResults.pl.map(d => d.ebitda / 1000000); // En Millones para el grÃ¡fico
                    charts.ebitda.data.datasets[0].data = ebitdas;
                    charts.ebitda.update();
                }
                
                // Actualizar GrÃ¡fico de ComposiciÃ³n de Ingresos (AÃ±o 5)
                if (charts.revenueMix && financialResults.pl[4]) { 
                    const year5 = financialResults.pl[4];
                    charts.revenueMix.data.datasets[0].data = [
                        year5.interestRevenue,
                        year5.originationCommission,
                        year5.gnvCommissions,
                        year5.sparePartsRevenue,
                        year5.marketplaceRevenue
                    ];
                    charts.revenueMix.update();
                }
                // Actualizar GrÃ¡fico de ValidaciÃ³n de Balance
                if (charts.balanceValidation) {
                    const totalAssetsData = financialResults.bs.map(d => d.totalAssets / 1000000);
                    const totalLiabilitiesEquityData = financialResults.bs.map(d => d.totalLiabilitiesEquity / 1000000);
                    charts.balanceValidation.data.datasets[0].data = totalAssetsData;
                    charts.balanceValidation.data.datasets[1].data = totalLiabilitiesEquityData;
                    charts.balanceValidation.update();
                }
                // Actualizar GrÃ¡fico de Flujo de Efectivo Neto Anual
                if (charts.netCashFlow) {
                    const netCashFlows = financialResults.cf.map(d => d.netCash / 1000000);
                    charts.netCashFlow.data.datasets[0].data = netCashFlows;
                    charts.netCashFlow.update();
                }
                
                log('  âœ…  GrÃ¡ficos actualizados.');
            }
            catch (error) {
                log(`Error actualizando grÃ¡ficos: ${error.message}`);
                console.error('Error actualizando grÃ¡ficos:', error);
            }
        }
        
        // ===== FUNCIONES AUXILIARES =====
        // Formatea un valor numÃ©rico a formato de moneda (millones, miles o sin prefijo)
        function formatCurrency(value, full = false) {
            if (value === null || value === undefined) return '$0 MXN';
            value = parseFloat(value);
            if (isNaN(value)) return '$0 MXN';
            if (full) { // Formato completo con comas
                return '$' + value.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' MXN';
            } else if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            } else if (Math.abs(value) >= 1000) {
                return '$' + (value / 1000).toFixed(1) + 'K MXN';
            }
            return '$' + Math.round(value).toLocaleString() + ' MXN';
        }
        // Fuerza un recÃ¡lculo manual del modelo
        function forceCalculate() {
            log('  ðŸ”„  RecÃ¡lculo manual solicitado.');
            if (calculateFinancials()) {
                updateUI();
                log('  âœ…  RecÃ¡lculo manual completado.');
            } else {
                log('  âŒ  Fallo en el recÃ¡lculo manual.');
            }
        }
        // ===== CONFIGURACIÃ“N DE CONTROLES DE USUARIO =====
        // Genera y vincula los inputs de tipo "range" (sliders)
        function setupSliderControls() {
            const container = document.getElementById('credit-risk-controls');
            const operationsContainer = document.getElementById('operations-debt-controls');
            sliderConfigs.forEach(config => {
                const parentDiv = document.createElement('div');
                parentDiv.innerHTML = `
                    <label class="flex justify-between text-sm font-medium text-gray-700">
                        ${config.label} 
                        <span id="${config.id}-valor" class="font-bold text-indigo-600">${config.format(modelData[config.id])}</span>
                    </label>
                    <input type="range" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}" class="input-slider mt-1">
                `;
                
                if (['tasaInteres', 'tasaMorosidad'].includes(config.id)) {
                    container.appendChild(parentDiv);
                } else {
                    operationsContainer.appendChild(parentDiv);
                }
                const slider = parentDiv.querySelector(`#${config.id}-input`);
                const display = parentDiv.querySelector(`#${config.id}-valor`); 
                
                slider.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    modelData[config.id] = value;
                    display.textContent = config.format(value);
                    log(`${config.label} cambiado a: ${value}`);
                    // Recalcular y actualizar UI en cada cambio de slider
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
            // Checkbox para ProtecciÃ³n Rodando
            const checkbox = document.getElementById('check-proteccion');
            if (checkbox) {
                checkbox.checked = modelData.proteccionRodando; // Establecer estado inicial
                checkbox.addEventListener('change', function() {
                    modelData.proteccionRodando = this.checked;
                    log(`ProtecciÃ³n Rodando: ${this.checked ? 'ACTIVADA' : 'DESACTIVADA'}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            }
            log('  âœ…  Controles deslizables (sliders) configurados.');
        }
        // Genera y vincula los inputs numÃ©ricos (constantes del modelo y unidades por aÃ±o)
        function setupNumberControls() {
            const unitsContainer = document.getElementById('units-container');
            const constantsContainer = document.getElementById('constants-container');
            // Inputs para Unidades por AÃ±o
            modelData.unitsPerYear.forEach((units, index) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label for="unit-year-${index+1}" class="text-sm font-medium text-gray-700 mb-1">Unidades AÃ±o ${index+1}</label>
                    <input type="number" id="unit-year-${index+1}" min="0" max="1000" value="${units}" 
                           class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                `;
                unitsContainer.appendChild(div);
                
                const input = document.getElementById(`unit-year-${index+1}`);
                input.addEventListener('change', function() {
                    const value = parseInt(this.value) || 0;
                    // Asegurar que el valor estÃ© dentro de los lÃ­mites
                    modelData.unitsPerYear[index] = Math.max(0, Math.min(1000, value)); 
                    this.value = modelData.unitsPerYear[index]; // Actualizar input si se ajustÃ³
                    
                    log(`Unidades AÃ±o ${index+1} cambiado a: ${modelData.unitsPerYear[index]}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
            // Inputs para Constantes del Modelo
            constantConfigs.forEach(config => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label for="${config.id}-input" class="text-sm font-medium text-gray-700 mb-1">${config.label}</label>
                    <input type="${config.type}" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}"
                           class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <span class="text-xs text-gray-500 mt-1" id="${config.id}-display">${config.format(modelData[config.id])}</span>
                `;
                constantsContainer.appendChild(div);
                const input = div.querySelector(`#${config.id}-input`);
                const display = div.querySelector(`#${config.id}-display`);
                input.addEventListener('input', function() {
                    let value = parseFloat(this.value);
                    if (isNaN(value)) value = 0; // Default to 0 if input is not a number
                    // Ensure value is within min/max, especially for percentages
                    if (config.type === 'number') {
                         if (value < config.min) value = config.min;
                         if (value > config.max) value = config.max;
                         this.value = value; // Update the input field
                    }
                    modelData[config.id] = value;
                    display.textContent = config.format(value);
                    log(`${config.label} cambiado a: ${value}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
            log('  âœ…  Controles numÃ©ricos (constantes y unidades) configurados.');
        }
        // Configura la navegaciÃ³n entre pestaÃ±as
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // Remover la clase 'active' de todos los botones y secciones
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    button.classList.add('active');
                    contentSections[index].classList.add('active');
                    
                    // Forzar actualizaciÃ³n de tablas y grÃ¡ficos al cambiar de pestaÃ±a
                    // Esto es Ãºtil si los datos se cargan lentamente o si se requiere un re-render
                    if (button.id === 'tab-financieros' || button.id === 'tab-niif' || button.id === 'tab-graficos' || button.id === 'tab-validacion') {
                        setTimeout(() => {
                            if (calculateFinancials()) { // Recalcular antes de actualizar UI
                                updateUI();
                            }
                        }, 50); // PequeÃ±o retraso para asegurar que la pestaÃ±a estÃ© visible
                    }
                });
            });
            log('  âœ…  NavegaciÃ³n por pestaÃ±as configurada.');
        }
        // ===== FUNCIONES DE VALIDACIÃ“N INTEGRAL =====
        // Objeto para almacenar los resultados de la validaciÃ³n
        // { errors: [], warnings: [], info: [], passed: [] }
        function validateModelComprehensively(modelData, financialResults) {
            const validations = {
                errors: [],      //  ðŸ”´  CrÃ­ticos - Requieren correcciÃ³n, el modelo es inviable
                warnings: [],    //  ðŸŸ¡  Importantes - Indican posibles problemas o resultados inusuales
                info: [],        //  ðŸ”µ  Informativos - Sugerencias o datos interesantes
                passed: []       //  âœ…  Exitosos - Cumplen con las expectativas
            };
            
            // Nivel 1: ValidaciÃ³n de Inputs BÃ¡sicos
            validateInputs(modelData, validations);
            
            // Solo si los resultados financieros existen y son vÃ¡lidos para continuar
            if (financialResults.pl.length > 0 && financialResults.cf.length > 0 && financialResults.bs.length > 0) {
                // Nivel 2: ValidaciÃ³n de Outputs y Cordura
                validateOutputs(financialResults, validations);
                // Nivel 3: Consistencia entre Estados Financieros
                validateConsistency(financialResults, validations);
                // Nivel 4: EvoluciÃ³n Temporal
                validateTemporal(financialResults, validations);
                // Nivel 5: Benchmarks de Industria (si hay datos suficientes para el aÃ±o 5)
                if (financialResults.pl.length === 5) {
                    validateIndustryBenchmarks(financialResults, validations);
                } else {
                    validations.info.push("No hay suficientes aÃ±os de proyecciÃ³n para evaluar los benchmarks de industria.");
                }
            } else {
                validations.errors.push("No se pudieron calcular los resultados financieros. Por favor, revise los inputs iniciales.");
            }
            
            return validations;
        }
        // Nivel 1: Validar Inputs BÃ¡sicos
        function validateInputs(modelData, validations) {
            // Check basic non-negativity for key inputs
            if (modelData.seriesA <= 0) {
                validations.errors.push(" ðŸ”´  Error: El Capital de Serie A debe ser mayor que 0. Ajuste 'Capital Serie A' en Control.");
            }
            if (modelData.vanCost <= 0) {
                validations.errors.push(" ðŸ”´  Error: El Costo de Vagoneta debe ser mayor que 0. Ajuste 'Costo Vagoneta (RAG)' en Control.");
            }
            if (modelData.vanPrice <= 0) {
                validations.errors.push(" ðŸ”´  Error: El Precio de PrÃ©stamo al Cliente debe ser mayor que 0. Ajuste 'Precio PrÃ©stamo Cliente' en Control.");
            }
            if (modelData.clientLoanTermYears <= 0) {
                validations.errors.push(" ðŸ”´  Error: El Plazo del PrÃ©stamo al Cliente debe ser mayor que 0. Ajuste 'Plazo PrÃ©stamo Cliente' en Control.");
            }
            if (modelData.depreciationYears <= 0) {
                validations.errors.push(" ðŸ”´  Error: Los AÃ±os de DepreciaciÃ³n deben ser mayor que 0. Ajuste 'AÃ±os DepreciaciÃ³n' en Control.");
            }
            if (modelData.periodoAmortizacionDeuda <= 0) {
                validations.errors.push(" ðŸ”´  Error: El Plazo de AmortizaciÃ³n de Deuda debe ser mayor que 0. Ajuste 'Plazo Amort. Deuda' en Control.");
            }
            // Check percentage inputs for reasonable range (0-100%, or 0-1 for decimals)
            const percentageInputs = [
                { id: 'tasaInteres', min: 0, max: 100, label: 'Tasa de InterÃ©s (Clientes)' }, 
                { id: 'tasaMorosidad', min: 0, max: 100, label: 'Tasa Morosidad (Antigua LÃ³gica)' },
                { id: 'comisionGNV', min: 0, max: 100, label: 'ComisiÃ³n GNV' }, 
                { id: 'margenRefacciones', min: 0, max: 100, label: 'Margen Refacciones' },
                { id: 'ventureDebtPct', min: 0, max: 100, label: '% Venture Debt' }, 
                { id: 'ventureDebtRate', min: 0, max: 100, label: 'Tasa Venture Debt' },
                { id: 'opexRate', min: 0, max: 100, label: 'Tasa OPEX (% Ingresos)' }, 
                { id: 'margenVagoneta', min: 0, max: 100, label: 'Margen OriginaciÃ³n Vagoneta' },
                { id: 'marketplace', min: 0, max: 100, label: '% ComisiÃ³n Marketplace' }, 
                { id: 'tasaReposicion', min: 0, max: 100, label: '% Unidades ReposiciÃ³n' },
                { id: 'fairValueVenta', min: 0, max: 100, label: '% Fair Value Venta' }, 
                { id: 'costosVenta', min: 0, max: 100, label: '% Costos Venta' },
                { id: 'corporateTaxRate', min: 0, max: 100, label: 'Tasa Impuesto Corporativo (%)' }
            ];
            percentageInputs.forEach(p => {
                if (modelData[p.id] < p.min || modelData[p.id] > p.max) {
                    validations.warnings.push(` ðŸŸ¡  Advertencia: '${p.label}' (${modelData[p.id]}%) estÃ¡ fuera del rango tÃ­pico (${p.min}-${p.max}%). Revise en Control.`);
                }
            });
            // Check PD and LGD (which are decimals) for reasonable range
            const decimalPercentageInputs = [
                { id: 'pdStage1', min: 0, max: 0.1, label: 'PD Etapa 1 (12M)' }, 
                { id: 'pdStage2', min: 0.01, max: 0.5, label: 'PD Etapa 2 (Lifetime)' },
                { id: 'pdStage3', min: 0.1, max: 0.9, label: 'PD Etapa 3 (Lifetime)' }, 
                { id: 'lgd', min: 0, max: 1, label: 'LGD (RecuperaciÃ³n %)' }
            ];
            decimalPercentageInputs.forEach(p => {
                if (modelData[p.id] < p.min || modelData[p.id] > p.max) {
                    validations.warnings.push(` ðŸŸ¡  Advertencia: '${p.label}' (${(modelData[p.id]*100).toFixed(1)}%) estÃ¡ fuera del rango tÃ­pico. Revise en Control.`);
                }
            });
            // Check portfolio allocation sums to 100%
            const totalAllocation = modelData.portfolioAllocationStage1 + modelData.portfolioAllocationStage2 + modelData.portfolioAllocationStage3;
            if (Math.abs(totalAllocation - 1.0) > 0.001) { // Allow for small floating point inaccuracies
                validations.errors.push(` ðŸ”´  Error: La suma de la AsignaciÃ³n de Portafolio NIIF 9 (${(totalAllocation*100).toFixed(1)}%) no es igual a 100%. Por favor, ajuste en Control.`);
            } else {
                validations.passed.push(` âœ…  Inputs: AsignaciÃ³n de Portafolio NIIF 9 suma 100%.`);
            }
            // Check that units per year are not negative
            modelData.unitsPerYear.forEach((units, index) => {
                if (units < 0) {
                    validations.errors.push(` ðŸ”´  Error: Las Unidades para el AÃ±o ${index + 1} son negativas (${units}). Ajuste en Control.`);
                }
            });
            validations.passed.push(" âœ…  Inputs: ParÃ¡metros bÃ¡sicos de entrada validados correctamente.");
        }
        // Nivel 2: Validar Outputs y Cordura Financiera
        function validateOutputs(financialResults, validations) {
            const lastYear = financialResults.pl.length - 1; // Assuming 5 years, this will be 4
            if (lastYear < 0) return; // No data to validate
            // Check cash balance for all years
            financialResults.bs.forEach((bsYear, index) => {
                if (bsYear.cash < -100) { // Allow for very small negative cash, but alert for significant
                    validations.errors.push(` ðŸ”´  Error: El Saldo de Efectivo al final del AÃ±o ${index + 1} es negativo (${formatCurrency(bsYear.cash)}). El modelo requiere mÃ¡s financiaciÃ³n. Ajuste las Series de Capital o las unidades.`);
                } else if (bsYear.cash < 0) { // Small negative cash is a warning
                    validations.warnings.push(` ðŸŸ¡  Advertencia: El Saldo de Efectivo al final del AÃ±o ${index + 1} es ligeramente negativo (${formatCurrency(bsYear.cash)}). Considere ajustar la financiaciÃ³n.`);
                }
            });
            // Only add passed if no critical errors found for cash
            if (!validations.errors.some(e => e.includes("Efectivo negativo")) && !validations.warnings.some(e => e.includes("Efectivo ligeramente negativo"))) {
                 validations.passed.push(" âœ…  Outputs: Saldo de efectivo es positivo en todos los aÃ±os.");
            }
            const year5PL = financialResults.pl[lastYear];
            const year5BS = financialResults.bs[lastYear];
            // Margen EBITDA: -50% to +100% (as percentage of revenue)
            if (year5PL.totalRevenue !== 0) {
                const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
                if (ebitdaMargin < -50 || ebitdaMargin > 100) {
                    validations.warnings.push(` ðŸŸ¡  Advertencia: Margen EBITDA del AÃ±o ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) es inusual. Revise supuestos. (Rango tÃ­pico: -50% a +100%).`);
                } else {
                    validations.passed.push(` âœ…  Outputs: Margen EBITDA del AÃ±o ${lastYear + 1} es realista (${ebitdaMargin.toFixed(1)}%).`);
                }
            } else {
                 validations.info.push(` ðŸ”µ  Info: Ingresos Totales del AÃ±o ${lastYear + 1} son cero, no se puede calcular Margen EBITDA.`);
            }
            // ROE: -100% a +200%
            if (financialResults.roe.length > lastYear && year5BS.equity !== 0) {
                const roe = financialResults.roe[lastYear];
                if (roe < -100 || roe > 200) {
                    validations.warnings.push(` ðŸŸ¡  Advertencia: ROE del AÃ±o ${lastYear + 1} (${roe.toFixed(1)}%) es extremadamente alto/bajo. Revise supuestos. (Rango tÃ­pico: -100% a +200%).`);
                } else {
                    validations.passed.push(` âœ…  Outputs: ROE del AÃ±o ${lastYear + 1} es realista (${roe.toFixed(1)}%).`);
                }
            } else if (financialResults.roe.length > lastYear) { // If equity is zero
                validations.warnings.push(` ðŸŸ¡  Advertencia: Patrimonio del AÃ±o ${lastYear + 1} es cero o negativo, no se puede calcular ROE significativo.`);
            }
            // CxC/Ingresos: 0.1x a 5x
            if (year5PL.totalRevenue !== 0) {
                const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
                if (cxcToRevenueRatio < 0.1 || cxcToRevenueRatio > 5) {
                    validations.warnings.push(` ðŸŸ¡  Advertencia: Ratio CxC/Ingresos del AÃ±o ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) es inusual. Revise supuestos. (Rango tÃ­pico: 0.1x a 5x para financiamiento).`);
                } else {
                    validations.passed.push(` âœ…  Outputs: Ratio CxC/Ingresos del AÃ±o ${lastYear + 1} es realista (${cxcToRevenueRatio.toFixed(1)}x).`);
                }
            } else {
                validations.info.push(` ðŸ”µ  Info: Ingresos Totales del AÃ±o ${lastYear + 1} son cero, no se puede calcular Ratio CxC/Ingresos.`);
            }
            // Debt/Equity: 0x a 20x
            if (year5BS.equity !== 0) {
                const debtToEquityRatio = year5BS.debt / year5BS.equity;
                if (debtToEquityRatio < 0 || debtToEquityRatio > 20) {
                    validations.warnings.push(` ðŸŸ¡  Advertencia: Ratio Deuda/Patrimonio del AÃ±o ${lastYear + 1} (${debtToEquityRatio.toFixed(1)}x) es inusual. Revise supuestos. (Rango tÃ­pico: 0x a 20x).`);
                } else {
                    validations.passed.push(` âœ…  Outputs: Ratio Deuda/Patrimonio del AÃ±o ${lastYear + 1} es realista (${debtToEquityRatio.toFixed(1)}x).`);
                }
            } else { // If equity is zero
                 validations.info.push(` ðŸ”µ  Info: Patrimonio del AÃ±o ${lastYear + 1} es cero o negativo, no se puede calcular Ratio Deuda/Patrimonio significativo.`);
            }
        }
        // Nivel 3: Consistencia entre Estados Financieros
        function validateConsistency(financialResults, validations) {
            const tolerance = 1000; // Tolerance for monetary differences ($1,000 MXN)
            const largeTolerance = 50000; // A larger tolerance for some calculated vs accumulated fields that might drift
            for (let i = 0; i < financialResults.pl.length; i++) {
                const pl = financialResults.pl[i];
                const cf = financialResults.cf[i];
                const bs = financialResults.bs[i];
                // For Year 1 (index 0), previous BS values are initial fundings
                const prevBsCash = (i === 0) ? (modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100))) : financialResults.bs[i-1].cash;
                const prevBsEquity = (i === 0) ? modelData.seriesA : financialResults.bs[i-1].equity;
                // Check Balance Sheet equation A = P + E
                const balanceDiff = Math.abs(bs.totalAssets - bs.totalLiabilitiesEquity);
                if (balanceDiff > tolerance) {
                    validations.errors.push(` ðŸ”´  Error de Consistencia: Balance General del AÃ±o ${i + 1} no cuadra. Diferencia: ${formatCurrency(balanceDiff)}. Activos (${formatCurrency(bs.totalAssets)}) vs. Pasivos+Patrimonio (${formatCurrency(bs.totalLiabilitiesEquity)}).`);
                } else {
                    validations.passed.push(` âœ…  Consistencia: Balance General del AÃ±o ${i + 1} cuadra.`);
                }
                // Flujo neto = Cambio en efectivo
                const cashChangeCF = cf.netCash;
                const cashChangeBS = bs.cash - prevBsCash;
                if (Math.abs(cashChangeCF - cashChangeBS) > tolerance) {
                    validations.errors.push(` ðŸ”´  Error de Consistencia: Flujo Neto del AÃ±o ${i + 1} (${formatCurrency(cashChangeCF)}) difiere del cambio en Efectivo del Balance (${formatCurrency(cashChangeBS)}).`);
                } else {
                    validations.passed.push(` âœ…  Consistencia: Flujo Neto y cambio en Efectivo del AÃ±o ${i + 1} concuerdan.`);
                }
                // DepreciaciÃ³n P&L = DepreciaciÃ³n CF (como ajuste no monetario)
                if (pl.depreciation !== undefined && financialResults.cf[i].depreciation !== undefined) { // Check if keys exist in both
                    if (Math.abs(pl.depreciation - financialResults.cf[i].depreciation) > tolerance) { // Assuming CF contains depreciation from PL for simplicity here
                        validations.warnings.push(` ðŸŸ¡  Advertencia de Consistencia: DepreciaciÃ³n en P&L (${formatCurrency(pl.depreciation)}) no coincide con el ajuste en Flujo de Efectivo (${formatCurrency(financialResults.cf[i].depreciation)}) para el AÃ±o ${i + 1}.`);
                    } else {
                        validations.passed.push(` âœ…  Consistencia: DepreciaciÃ³n en P&L y Flujo de Efectivo del AÃ±o ${i + 1} concuerdan.`);
                    }
                }
                // Utilidad neta = Delta utilidades retenidas (considerando nuevo capital y dividendos si los hubiera)
                const deltaEquity = bs.equity - prevBsEquity;
                // Suma la utilidad neta, mÃ¡s el funding adicional del plug de liquidez, mÃ¡s las series B y C del aÃ±o correspondiente
                const netIncomePlusNewEquity = pl.netIncome + (financialResults.cf[i].additionalFundingRaised || 0) + 
                                               (i + 1 === modelData.seriesB_year ? modelData.seriesB_funding : 0) + 
                                               (i + 1 === modelData.seriesC_year ? modelData.seriesC_funding : 0);
                
                // Use a larger tolerance for this check due to potential compounding of floating point errors over years and multiple complex calculations
                if (Math.abs(deltaEquity - netIncomePlusNewEquity) > largeTolerance) {
                    validations.warnings.push(` ðŸŸ¡  Advertencia de Consistencia: Cambio en Patrimonio del AÃ±o ${i + 1} (${formatCurrency(deltaEquity)}) no coincide con Utilidad Neta + Nuevos Aportes de Capital (${formatCurrency(netIncomePlusNewEquity)}). Esto puede ser debido a redondeos acumulados.`);
                } else {
                    validations.passed.push(` âœ…  Consistencia: Utilidad Neta y cambios en Patrimonio del AÃ±o ${i + 1} concuerdan.`);
                }
            }
        }
        // Nivel 4: EvoluciÃ³n Temporal
        function validateTemporal(financialResults, validations) {
            for (let i = 1; i < financialResults.pl.length; i++) { // Start from Year 2 to compare with Year 1
                const prevPl = financialResults.pl[i-1];
                const currentPl = financialResults.pl[i];
                const prevBs = financialResults.bs[i-1];
                const currentBs = financialResults.bs[i];
                // Crecimiento ingresos <1000% anual
                if (prevPl.totalRevenue !== 0) {
                    const revenueGrowth = (currentPl.totalRevenue / prevPl.totalRevenue - 1) * 100;
                    if (revenueGrowth > 1000) { // If revenue grows more than 1000% (10x) in a year
                        validations.warnings.push(` ðŸŸ¡  Advertencia Temporal: Crecimiento de Ingresos del AÃ±o ${i + 1} (${revenueGrowth.toFixed(1)}%) es extremadamente alto. Revise las unidades o supuestos de precio.`);
                    }
                } else if (currentPl.totalRevenue > 0) { // If prev year revenue was 0 but current is positive, it's a new ramp-up, not an "explosive" growth anomaly
                     validations.info.push(` ðŸ”µ  Info Temporal: Ingresos de AÃ±o ${i + 1} inician ramp-up desde cero/bajo. Crecimiento porcentual no significativo.`);
                }
                // Ratios no cambian >500% entre aÃ±os (ej. Margen EBITDA)
                if (prevPl.totalRevenue !== 0 && currentPl.totalRevenue !== 0) {
                    const prevEbitdaMargin = (prevPl.ebitda / prevPl.totalRevenue) * 100;
                    const currentEbitdaMargin = (currentPl.ebitda / currentPl.totalRevenue) * 100;
                    if (Math.abs(currentEbitdaMargin - prevEbitdaMargin) > 500) { // If margin changes by more than 500 percentage points
                        validations.warnings.push(` ðŸŸ¡  Advertencia Temporal: Margen EBITDA cambia drÃ¡sticamente (${prevEbitdaMargin.toFixed(1)}% a ${currentEbitdaMargin.toFixed(1)}%) del AÃ±o ${i} al AÃ±o ${i + 1}. Revise las dinÃ¡micas de costos/ingresos.`);
                    }
                }
            }
            validations.passed.push(" âœ…  EvoluciÃ³n Temporal: Tendencias de crecimiento y ratios anuales parecen razonables.");
        }
        // Nivel 5: Benchmarks de Industria
        function validateIndustryBenchmarks(financialResults, validations) {
            const lastYear = financialResults.pl.length - 1;
            if (lastYear < 4) return; // Need at least 5 years of data for year 5 benchmarks
            const year5PL = financialResults.pl[lastYear];
            const year5BS = financialResults.bs[lastYear];
            const year5ROE = financialResults.roe[lastYear];
            const year5ROIC = financialResults.roic[lastYear];
            // Margen EBITDA fintech: 10-40%
            if (year5PL.totalRevenue !== 0) {
                const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
                if (ebitdaMargin < 10 || ebitdaMargin > 40) {
                    validations.info.push(` ðŸ”µ  Info: Margen EBITDA del AÃ±o ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) estÃ¡ fuera del benchmark tÃ­pico de fintech (10-40%).`);
                } else {
                    validations.passed.push(` âœ…  Benchmarks: Margen EBITDA del AÃ±o ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) estÃ¡ en lÃ­nea con el benchmark.`);
                }
            }
            // ROE servicios financieros: 15-35%
            if (year5BS.equity !== 0) {
                if (year5ROE < 15 || year5ROE > 35) {
                    validations.info.push(` ðŸ”µ  Info: ROE del AÃ±o ${lastYear + 1} (${year5ROE.toFixed(1)}%) estÃ¡ fuera del benchmark tÃ­pico de servicios financieros (15-35%).`);
                } else {
                    validations.passed.push(` âœ…  Benchmarks: ROE del AÃ±o ${lastYear + 1} (${year5ROE.toFixed(1)}%) estÃ¡ en lÃ­nea con el benchmark.`);
                }
            } else {
                 validations.info.push(` ðŸ”µ  Info: Patrimonio del AÃ±o ${lastYear + 1} es cero o negativo, no se puede comparar ROE con benchmark.`);
            }
            // CxC/Ingresos financiamiento: 0.5-3x
            if (year5PL.totalRevenue !== 0) {
                const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
                if (cxcToRevenueRatio < 0.5 || cxcToRevenueRatio > 3) {
                    validations.info.push(` ðŸ”µ  Info: Ratio CxC/Ingresos del AÃ±o ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) estÃ¡ fuera del benchmark tÃ­pico de financiamiento (0.5-3x).`);
                } else {
                    validations.passed.push(` âœ…  Benchmarks: Ratio CxC/Ingresos del AÃ±o ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) estÃ¡ en lÃ­nea con el benchmark.`);
                }
            } else {
                validations.info.push(` ðŸ”µ  Info: Ingresos Totales del AÃ±o ${lastYear + 1} son cero, no se puede comparar Ratio CxC/Ingresos con benchmark.`);
            }
        }
        // FunciÃ³n para actualizar el panel de validaciÃ³n en la UI
        function updateValidationPanel(validations) {
            const container = document.getElementById('validation-results-container');
            if (!container) return;
            container.innerHTML = ''; // Clear previous results
            // Display messages by type, ensuring errors/warnings are prominent
            const types = ['error', 'warning', 'info', 'passed'];
            types.forEach(type => {
                // Defensive check: ensure validations[type] is an array
                if (Array.isArray(validations[type])) {
                    validations[type].forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `validation-item ${type}`;
                        let icon = '';
                        if (type === 'error') icon = ' âŒ ';
                        else if (type === 'warning') icon = ' ðŸŸ¡ '; 
                        else if (type === 'info') icon = ' ðŸ”µ ';
                        else if (type === 'passed') icon = ' âœ… ';
                        div.innerHTML = `<span class="validation-icon">${icon}</span><div class="validation-message">${msg}</div>`;
                        container.appendChild(div);
                    });
                } else {
                    console.warn(`Validation type '${type}' is not an array:`, validations[type]);
                }
            });
            // Add a summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'validation-summary mt-4 p-2 rounded-lg';
            if (validations.errors.length > 0) {
                summaryDiv.classList.add('bg-red-200', 'text-red-800');
                summaryDiv.textContent = ` ðŸš¨  ${validations.errors.length} ERRORES CRÃTICOS encontrados. Por favor, revise y ajuste los inputs/lÃ³gica.`;
            } else if (validations.warnings.length > 0) {
                summaryDiv.classList.add('bg-yellow-200', 'text-yellow-800');
                summaryDiv.textContent = ` âš ï¸  ${validations.warnings.length} ADVERTENCIAS encontradas. Revise los resultados con precauciÃ³n.`;
            } else {
                summaryDiv.classList.add('bg-green-200', 'text-green-800');
                summaryDiv.textContent = ` âœ¨  Todas las validaciones crÃ­ticas superadas. ${validations.info.length} notas informativas.`;
            }
            container.appendChild(summaryDiv);
        }
        // ===== APLICACIÃ“N LISTA Y FUNCIONANDO =====
        // Se ejecuta cuando el DOM estÃ¡ completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            log('  ðŸš€  INICIANDO APLICACIÃ“N DEL MODELO FINANCIERO');
            
            try {
                // Configurar todos los elementos interactivos y la UI
                setupTabs();
                setupSliderControls(); // Configurar sliders
                setupNumberControls(); // Configurar inputs numÃ©ricos (constantes y unidades)
                
                // Realizar el cÃ¡lculo inicial del modelo y actualizar la UI
                if (calculateFinancials()) {
                    updateUI();
                    log('  âœ…  InicializaciÃ³n exitosa: CÃ¡lculos y UI actualizados.');
                } else {
                    log('  âŒ  Error durante la inicializaciÃ³n: Fallo en los cÃ¡lculos iniciales.');
                }
                
                // Inicializar y actualizar grÃ¡ficos despuÃ©s de un breve retraso
                // Esto asegura que el canvas estÃ© listo en el DOM
                setTimeout(() => {
                    initializeCharts();
                    updateCharts();
                }, 500); // Retraso de 500ms
                
                log('  ðŸŽ‰  APLICACIÃ“N LISTA Y FUNCIONANDO');
                
            } catch (error) {
                log(`  âŒ  ERROR CRÃTICO DURANTE LA INICIALIZACIÃ“N: ${error.message}`);
                console.error('Error crÃ­tico en inicializaciÃ³n:', error);
            }
        });
    </script>
</body>
</html>
