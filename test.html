<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rodando a Gas - Modelo Estrat√©gico (Fuente de la Verdad)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script> 
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; }
        h1, h2, h3, h4 { color: #f8fafc; font-weight: 700; }
        .highlight-text { background: -webkit-linear-gradient(45deg, #22d3ee, #0ea5e9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; padding: 1rem 1.5rem; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: 500; margin-right: 0.5rem; border-radius: 0.5rem 0.5rem 0 0; display: inline-flex; align-items: center; gap: 0.5rem; }
        .tab-button.active { border-color: #0ea5e9; color: #f8fafc; background-color: #0f172a; font-weight: 600; }
        .tab-button:hover:not(.active) { color: #cbd5e1; background-color: #0f172a; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: #0f172a; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #1e293b; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #1e293b; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #0ea5e9; border-radius: 9999px; cursor: pointer; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3); }
        .financial-table { width: 100%; border-collapse: collapse; background-color: #0f172a; border-radius: 0.75rem; overflow: hidden; }
        .financial-table th, .financial-table td { padding: 1rem; text-align: right; border-bottom: 1px solid #1e293b; font-size: 0.95rem; }
        .financial-table th { background-color: #1a233b; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; color: #e2e8f0; }
        .financial-table tr:last-child td { border-bottom: none; }
        .total-row { background-color: #1e293b !important; color: #f8fafc; font-weight: 700; }
        .positive { color: #34d399; } 
        .negative { color: #f43f5e; }
        .metric-card { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-left: 4px solid #0ea5e9; padding: 1.25rem; border-radius: 0.75rem; }
        input[type="number"] { background-color: #1a233b; border-color: #334155; color: #e2e8f0; border-radius: 0.375rem; }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl lg:text-5xl font-black mb-2">Modelo de Negocio - Rodando a <span class="highlight-text">Gas</span></h1>
            <p class="text-xl text-slate-400 mt-2">Fuente √önica de Verdad</p>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="metric-card"><div class="text-sm text-slate-400">EBITDA A√±o 5</div><div class="text-2xl font-bold" id="ebitda-year5">$0M</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">TIR Proyecto</div><div class="text-2xl font-bold" id="tir-proyecto">0%</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">TIR Cartera</div><div class="text-2xl font-bold" id="tir-cartera">0%</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">TIR Equity</div><div class="text-2xl font-bold" id="tir-equity">0%</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">Unidades Totales (A√±o 5)</div><div class="text-2xl font-bold" id="unidades-totales">0</div></div>
        </div>

        <div class="mb-6 border-b border-slate-800">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active"> <i data-lucide="sliders-horizontal" class="w-5 h-5"></i> Control Estrat√©gico</button>
                <button id="tab-financieros" class="tab-button"> <i data-lucide="wallet" class="w-5 h-5"></i> Estados Financieros</button>
            </nav>
        </div>

        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">üìà Plan de Negocio y Crecimiento</h4>
                        <div id="business-plan-controls" class="space-y-4"></div>
                    </div>
                     <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">‚öôÔ∏è Supuestos Operativos y de Mercado</h4>
                        <div id="operations-controls" class="space-y-4"></div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">üí∞ Estructura de Capital</h4>
                        <div id="capital-structure-controls" class="space-y-4"></div>
                    </div>
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">üéØ Rentabilidad y Valuaci√≥n</h4>
                        <div id="valuation-controls" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card"><h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3><div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody id="pl-table-body"></tbody></table></div></div>
                <div class="card"><h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3><div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 0</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody id="cf-table-body"></tbody></table></div></div>
                <div class="card"><h3 class="text-xl font-semibold mb-4">Balance General</h3><div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody id="bs-table-body"></tbody></table></div><div id="balance-validation" class="mt-4 text-center font-semibold p-2 rounded-lg"></div></div>
            </div>
        </div>
    </div>

<script>
// ===== INICIO DEL SCRIPT: Versi√≥n Estrat√©gica "Fuente de la Verdad" =====
let financialResults = {};
const BALANCE_TOLERANCE = 1000;

// Supuestos centrales basados en el documento "Fuente √önica de Verdad"
let modelData = {
    // Plan de Crecimiento
    unitsPerYear: [40, 100, 120, 120, 120],  // AJUSTE: Nuevo plan de crecimiento
    
    // Econom√≠a Unitaria
    vanCost: 641000,
    vanPrice: 729000,
    downPaymentPercentage: 15, // Promedio del 12-18% mencionado en el documento
    
    // Supuestos Operativos y de Mercado
    tasaInteres: 25.5,
    opexRate: 15,
    provisionRate: 8, // Provision para p√©rdidas como 8% de ingresos por intereses
    clientLoanTermYears: 4, // Payback a 36 meses (3 a√±os) implica un plazo algo mayor
    
    // Nuevas Fuentes de Ingreso (por veh√≠culo, por a√±o)
    marketplaceRevenuePerCar: 2500, // Promedio de $2k-$3k
    marketplaceMargin: 17.5, // Promedio de 15-20%
    
    // Valuaci√≥n
    ebitdaMultiple: 9,
};

// Estructura de capital para soportar el plan
let capitalStructure = {
    seriesA: 45000000,
    ventureDebt: { year1: 20000000, year2: 40000000, year3: 50000000, year4: 0, year5: 0 },
    commercialDebt: { year1: 0, year2: 0, year3: 60000000, year4: 100000000, year5: 100000000 }
};

// Nueva configuraci√≥n de controles para la UI
const controlsConfig = {
    'business-plan': [
        { id: 'unitsPerYear', label: 'Unidades Nuevas por A√±o', type: 'array_input' },
        { id: 'downPaymentPercentage', label: 'Enganche Cliente (%)', type: 'range', min: 10, max: 20, step: 1, format: val => `${val}%` },
    ],
    'operations': [
        { id: 'tasaInteres', label: 'Tasa Inter√©s Clientes', min: 22, max: 30, step: 0.5, type: 'range', format: val => `${val.toFixed(1)}%` },
        { id: 'opexRate', label: 'Tasa OPEX (% de Ingresos)', type: 'range', min: 10, max: 20, step: 1, format: val => `${val}%` },
        { id: 'provisionRate', label: 'Tasa Provisi√≥n (% Ing. Intereses)', type: 'range', min: 5, max: 12, step: 0.5, format: val => `${val.toFixed(1)}%` },
        { id: 'marketplaceMargin', label: 'Margen Marketplace (%)', type: 'range', min: 10, max: 25, step: 0.5, format: val => `${val.toFixed(1)}%` },
    ],
    'capital-structure': [
        { id: 'seriesA', label: 'Capital Serie A', type: 'number', structure: 'seriesA' },
        { id: 'ventureDebt', label: 'Venture Debt', type: 'capital_structure', structure: 'ventureDebt' },
        { id: 'commercialDebt', label: 'Deuda Comercial', type: 'capital_structure', structure: 'commercialDebt' },
    ],
    'valuation': [ 
        { id: 'ebitdaMultiple', label: 'M√∫ltiplo EBITDA Salida', min: 7, max: 12, step: 0.5, type: 'range', format: val => `${val.toFixed(1)}X` },
    ],
};

function formatCurrency(value) {
    if (isNaN(value)) return '$0';
    if (Math.abs(value) >= 1e6) return '$' + (value / 1e6).toFixed(1) + 'M';
    if (Math.abs(value) >= 1e3) return '$' + (value / 1e3).toFixed(1) + 'K';
    return '$' + Math.round(value).toLocaleString('es-MX');
}

// ===== MOTOR DE C√ÅLCULO ESTRAT√âGICO =====
function calculateFinancials() {
    try {
        let loanPortfolio = [], cumulativeUnits = 0, totalDebt = 0;
        let cash = capitalStructure.seriesA;
        
        financialResults = { pl: [], cf: [], bs: [] };
        let projectCashFlows = [-capitalStructure.seriesA];
        let equityCashFlows = [-capitalStructure.seriesA];
        let portfolioCashFlows = [0];

        for (let year = 1; year <= 5; year++) {
            const newUnits = modelData.unitsPerYear[year - 1];
            cumulativeUnits += newUnits;
            
            // 1. Nuevos Pr√©stamos y CAPEX
            const initialMargin = (modelData.vanPrice - modelData.vanCost) * newUnits;
            const downPayment = modelData.vanPrice * newUnits * (modelData.downPaymentPercentage / 100);
            const capex = modelData.vanCost * newUnits;
            const newLoanPrincipal = (modelData.vanPrice * newUnits) - downPayment;
            if (newUnits > 0) {
                loanPortfolio.push({ principal: newLoanPrincipal, term: modelData.clientLoanTermYears, interestRate: modelData.tasaInteres / 100 });
            }
            
            // 2. Ingresos
            let interestRevenue = 0;
            loanPortfolio.forEach(loan => {
                interestRevenue += loan.principal * loan.interestRate;
            });
            const marketplaceGrossRevenue = cumulativeUnits * modelData.marketplaceRevenuePerCar;
            const marketplaceNetRevenue = marketplaceGrossRevenue * (modelData.marketplaceMargin / 100);
            const totalRevenue = interestRevenue + initialMargin + marketplaceNetRevenue;
            
            // 3. Gastos y EBITDA
            const opex = totalRevenue * (modelData.opexRate / 100);
            const provisions = interestRevenue * (modelData.provisionRate / 100);
            const ebitda = totalRevenue - opex - provisions;
            
            // Amortizar portafolio para el siguiente a√±o
            loanPortfolio.forEach(loan => {
                loan.principal *= (1 - 1/loan.term); // Simplificaci√≥n de amortizaci√≥n
            });
            
            // 4. Deuda e Intereses
            const interestExpense = totalDebt * 0.12; // Tasa promedio ponderada de deuda
            const ebit = ebitda - interestExpense; // Simplificado, sin depreciaci√≥n
            
            // 5. Flujos de Efectivo
            const netIncome = ebit * (1 - 0.31); // Tasa de impuesto fija
            const newVentureDebt = capitalStructure.ventureDebt[`year${year}`] || 0;
            const newCommercialDebt = capitalStructure.commercialDebt[`year${year}`] || 0;
            const financingCash = newVentureDebt + newCommercialDebt;
            
            const operatingCash = ebitda - interestExpense - (ebit * 0.31); // Proxy de FCF Operativo
            const investingCash = -capex;
            const netCashFlow = operatingCash + investingCash + financingCash;
            cash += netCashFlow;
            
            // Actualizar deuda total
            totalDebt += newVentureDebt + newCommercialDebt;
            
            // 6. Balance General Simplificado
            const receivables = loanPortfolio.reduce((sum, loan) => sum + loan.principal, 0);
            const assets = cash + receivables; // No se consideran activos fijos para simplicidad
            const equity = assets - totalDebt;
            
            financialResults.pl.push({ totalRevenue, initialMargin, interestRevenue, marketplaceNetRevenue, opex, provisions, ebitda });
            financialResults.cf.push({ operatingCash, investingCash, financingCash, netCashFlow });
            financialResults.bs.push({ cash, receivables, assets, debt: totalDebt, equity });

            // 7. Flujos para TIR
            projectCashFlows.push(operatingCash + investingCash);
            equityCashFlows.push(operatingCash + investingCash + financingCash);
            portfolioCashFlows.push(-newLoanPrincipal + (newLoanPrincipal / modelData.clientLoanTermYears) + interestRevenue);
        }
        
        // Terminal Value y c√°lculo de TIR
        const terminalValue = financialResults.pl[4].ebitda * modelData.ebitdaMultiple;
        projectCashFlows[5] += terminalValue;
        equityCashFlows[5] += terminalValue; // Simplificado
        portfolioCashFlows[5] += financialResults.bs[4].receivables;

        financialResults.tirProyecto = calculateIRR(projectCashFlows);
        financialResults.tirEquity = calculateIRR(equityCashFlows);
        financialResults.tirCartera = calculateIRR(portfolioCashFlows);
        
        return true;
    } catch (error) {
        console.error("Error en calculateFinancials:", error);
        return false;
    }
}


function calculateIRR(cashFlows, maxIter = 100, tolerance = 1e-7) {
    let guess = 0.1;
    for(let i=0; i < maxIter; i++) {
        let npv = 0, dNpv = 0;
        for(let t=0; t < cashFlows.length; t++) {
            npv += cashFlows[t] / Math.pow(1 + guess, t);
            if (t > 0) dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
        }
        if(Math.abs(npv) < tolerance) return guess * 100;
        if(dNpv === 0) break;
        guess -= npv / dNpv;
    }
    return 0; // No se encontr√≥
}

// ===== SECCI√ìN DE UI Y MANEJO DE EVENTOS =====
function updateUI() {
    if (!financialResults.pl || financialResults.pl.length < 5) return;
    const year5PL = financialResults.pl[4];
    const cumulativeUnits = modelData.unitsPerYear.reduce((a, b) => a + b, 0);

    document.getElementById('ebitda-year5').textContent = formatCurrency(year5PL.ebitda);
    document.getElementById('tir-proyecto').textContent = (financialResults.tirProyecto || 0).toFixed(1) + '%';
    document.getElementById('tir-cartera').textContent = (financialResults.tirCartera || 0).toFixed(1) + '%';
    document.getElementById('tir-equity').textContent = (financialResults.tirEquity || 0).toFixed(1) + '%';
    document.getElementById('unidades-totales').textContent = cumulativeUnits;
    updateTables();
}

function updateTables() {
    const plBody = document.getElementById('pl-table-body');
    const cfBody = document.getElementById('cf-table-body');
    const bsBody = document.getElementById('bs-table-body');
    if (!plBody || !cfBody || !bsBody) return;
    
    plBody.innerHTML = ''; cfBody.innerHTML = ''; bsBody.innerHTML = '';

    const plRows = [{l:'Ingresos por Venta Inicial', k:'initialMargin'}, {l:'Ingresos por Intereses', k:'interestRevenue'}, {l:'Ingresos Marketplace', k:'marketplaceNetRevenue'}, {l:'Total Ingresos', k:'totalRevenue', t:1}, {l:'Gastos Operativos (OPEX)', k:'opex', n:1}, {l:'Provisiones para P√©rdidas', k:'provisions', n:1}, {l:'EBITDA', k:'ebitda', t:1}];
    plRows.forEach(r => {
        const tr = document.createElement('tr'); if(r.t) tr.className = 'total-row';
        tr.innerHTML = `<td>${r.l}</td>` + financialResults.pl.map(d => `<td class="${r.n ? 'negative' : 'positive'}">${r.n ? '('+formatCurrency(d[r.k])+')' : formatCurrency(d[r.k])}</td>`).join('');
        plBody.appendChild(tr);
    });

    const cfRows = [{l:'Flujo Operativo', k:'operatingCash'}, {l:'Flujo de Inversi√≥n (CAPEX)', k:'investingCash'}, {l:'Flujo de Financiamiento', k:'financingCash'}, {l:'Flujo Neto de Efectivo', k:'netCashFlow', t:1}];
    cfRows.forEach(r => {
        const tr = document.createElement('tr'); if(r.t) tr.className = 'total-row';
        tr.innerHTML = `<td>${r.l}</td><td class="positive">${r.l === 'Flujo Neto de Efectivo' ? formatCurrency(capitalStructure.seriesA) : '-'}</td>` + financialResults.cf.map(d => `<td class="${d[r.k] > 0 ? 'positive' : 'negative'}">${formatCurrency(d[r.k])}</td>`).join('');
        cfBody.appendChild(tr);
    });

    const bsRows = [{l:'Efectivo', k:'cash'}, {l:'Cuentas por Cobrar', k:'receivables'}, {l:'Total Activos', k:'assets', t:1}, {l:'Deuda Financiera', k:'debt'}, {l:'Patrimonio', k:'equity'}, {l:'Total Pasivos + Patrimonio', k:'assets', t:1}];
    bsRows.forEach(r => {
        const tr = document.createElement('tr'); if(r.t) tr.className = 'total-row';
        tr.innerHTML = `<td>${r.l}</td>` + financialResults.bs.map(d => `<td class="positive">${formatCurrency(d[r.k])}</td>`).join('');
        bsBody.appendChild(tr);
    });
    
    document.getElementById('balance-validation').innerHTML = '<span class="text-green-400">‚úÖ Modelo Estrat√©gico Simplificado</span>';
}

function createSliderControl(config, container) {
    const parentDiv = document.createElement('div');
    parentDiv.className = 'flex flex-col mb-4';
    parentDiv.innerHTML = `<label class="flex justify-between text-sm font-medium text-slate-300">${config.label} <span id="${config.id}-valor" class="font-bold text-teal-400">${config.format(modelData[config.id])}</span></label><input type="range" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}" class="input-slider mt-1">`;
    container.appendChild(parentDiv);
    const slider = parentDiv.querySelector('input'), display = parentDiv.querySelector(`#${config.id}-valor`);
    slider.addEventListener('input', () => {
        modelData[config.id] = parseFloat(slider.value);
        display.textContent = config.format(modelData[config.id]);
        forceCalculate();
    });
}

function createNumberControl(config, container) {
     const div = document.createElement('div');
     div.className = 'flex flex-col mb-2';
     div.innerHTML = `<label for="${config.id}" class="text-sm font-medium text-slate-400">${config.label}</label><input id="${config.id}" type="number" step="1000000" value="${capitalStructure[config.id]}" class="p-2 border border-slate-700 rounded-md bg-slate-800 text-white w-full">`;
     container.appendChild(div);
     div.querySelector('input').addEventListener('change', (e) => {
         capitalStructure[config.id] = parseFloat(e.target.value) || 0;
         forceCalculate();
     });
}

function createCapitalStructureControls(config, container) {
    const parentDiv = document.createElement('div');
    parentDiv.innerHTML = `<label class="text-sm font-medium text-slate-400 mb-2 block">${config.label}</label>`;
    const gridDiv = document.createElement('div');
    gridDiv.className = 'grid grid-cols-5 gap-2';
    for (let i = 1; i <= 5; i++) {
        const div = document.createElement('div');
        div.innerHTML = `<label class="text-xs text-slate-400">A√±o ${i}</label><input type="number" value="${capitalStructure[config.structure][`year${i}`]}" class="p-2 w-full border border-slate-700 rounded-md bg-slate-800 text-white">`;
        div.querySelector('input').addEventListener('change', (e) => {
            capitalStructure[config.structure][`year${i}`] = parseInt(e.target.value) || 0;
            forceCalculate();
        });
        gridDiv.appendChild(div);
    }
    parentDiv.appendChild(gridDiv);
    container.appendChild(parentDiv);
}

function setupControls() {
    Object.keys(controlsConfig).forEach(sectionKey => {
        const container = document.getElementById(`${sectionKey}-controls`);
        if (container) {
            container.innerHTML = '';
            controlsConfig[sectionKey].forEach(config => {
                if (config.type === 'array_input') {
                    const parentDiv = document.createElement('div');
                    parentDiv.innerHTML = `<label class="text-sm font-medium text-slate-400 mb-2 block">${config.label}</label>`;
                    const unitsContainer = document.createElement('div');
                    unitsContainer.className = 'grid grid-cols-5 gap-2';
                    modelData.unitsPerYear.forEach((units, index) => {
                        const div = document.createElement('div');
                        div.innerHTML = `<label class="text-xs text-slate-400">A√±o ${index+1}</label><input type="number" value="${units}" class="p-2 w-full border border-slate-700 rounded-md bg-slate-800 text-white">`;
                        unitsContainer.appendChild(div);
                        div.querySelector('input').addEventListener('change', (e) => {
                            modelData.unitsPerYear[index] = parseInt(e.target.value) || 0;
                            forceCalculate();
                        });
                    });
                    parentDiv.appendChild(unitsContainer);
                    container.appendChild(parentDiv);
                } else if(config.type === 'range') {
                    createSliderControl(config, container);
                } else if (config.type === 'number') {
                    createNumberControl(config, container);
                } else if (config.type === 'capital_structure') {
                    createCapitalStructureControls(config, container);
                }
            });
        }
    });
}
        
function setupTabs() { 
     const tabButtons = document.querySelectorAll('.tab-button');
     const contentSections = document.querySelectorAll('.content-section');
     tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            contentSections.forEach(section => section.classList.remove('active'));
            button.classList.add('active');
            const tabName = button.id.split('-')[1];
            document.getElementById(`content-${tabName}`).classList.add('active');
        });
     });
}

function forceCalculate() {
    if (calculateFinancials()) {
        updateUI();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    try {
        setupTabs();
        setupControls();
        forceCalculate();
    } catch (error) {
        console.error(`‚ùå CRITICAL ERROR: ${error.message}`);
    }
});
</script>
</body>
</html>
