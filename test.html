<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo - Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos base */
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; } /* Verde para valores positivos */
        .negative { color: #dc2626; } /* Rojo para valores negativos */
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .debug-info { position: fixed; top: 10px; right: 10px; background: #1f2937; color: white; padding: 10px; border-radius: 6px; font-size: 12px; max-width: 300px; z-index: 1000; display: none; }
        .niif-compliant { border-left: 4px solid #10b981; background-color: #f0fdf4; }
        /* Estilos para el panel de validación */
        #validation-panel-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .validation-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .validation-item.error { background-color: #fee2e2; border-left: 4px solid #ef4444; } /* red-200 / red-500 */
        .validation-item.warning { background-color: #fffbeb; border-left: 4px solid #f59e0b; } /* amber-100 / amber-500 */
        .validation-item.info { background-color: #e0f2fe; border-left: 44px solid #3b82f6; } /* light-blue-100 / blue-500 */
        .validation-item.passed { background-color: #d1fae5; border-left: 4px solid #10b981; } /* green-100 / green-500 */
        .validation-icon {
            font-size: 1.25rem; /* 20px */
            margin-right: 0.75rem; /* 12px */
            line-height: 1;
        }
        .validation-item.error .validation-icon { color: #ef4444; }
        .validation-item.warning .validation-icon { color: #f59e0b; }
        .validation-item.info .validation-icon { color: #3b82f6; }
        .validation-item.passed .validation-icon { color: #10b981; }
        .validation-message {
            flex-grow: 1;
            font-size: 0.875rem; /* 14px */
            color: #374151; /* gray-700 */
        }
        .validation-message strong { font-weight: 600; }
        .validation-message ul { list-style: disc; padding-left: 1.25rem; margin-top: 0.25rem; }
        .validation-summary {
            font-weight: bold;
            text-align: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Debug Panel -->
    <div id="debug-info" class="debug-info">
        <div id="debug-content"></div>
        <button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
    </div>
    
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header and Key Metrics -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Resiliencia como Servicio</p>
            <button onclick="toggleDebug()" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-300">Debug</button>
        </header>
        <!-- Key Metrics Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA Año 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
             <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Equity</div>
                <div class="text-2xl font-bold" id="tir-equity">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas Operativas (Año 5)</div>
                <div class="text-2xl font-bold" id="vagonetas-operativas">0</div>
            </div>
           
        </div>
        <!-- Additional row for ROE and ROIC -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
             <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">ROE (Año 5)</div>
                <div class="text-2xl font-bold" id="roe-year5">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">ROIC (Año 5)</div>
                <div class="text-2xl font-bold" id="roic-year5">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Deuda Residual Año 5</div>
                <div class="text-2xl font-bold" id="deuda-residual">$0M MXN</div>
            </div>
        </div>
        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  🚀  Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  📊  Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  📋  NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  📈  Gráficos</button>
                <button id="tab-validacion" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">  ✅  Validación</button>
            </nav>
        </div>
        <!-- Tab Content: Control -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Credit and Risk Parameters Section -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Crédito y Riesgo <span class="text-sm text-gray-500">(Parámetros clave para el riesgo y el retorno del financiamiento)</span></h4>
                    <div class="space-y-4" id="credit-risk-controls">
                        <!-- Inputs will be dynamically generated here -->
                    </div>
                    <div class="flex items-center mt-4">
                        <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Protección Rodando (<span class="font-bold">-50% en provisiones de morosidad</span>)</label>
                    </div>
                </div>
                <!-- Operations and Debt Parameters Section -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Operaciones y Deuda <span class="text-sm text-gray-500">(Eficiencia operativa y estructura de capital)</span></h4>
                    <div class="space-y-4" id="operations-debt-controls">
                        <!-- Inputs will be dynamically generated here -->
                    </div>
                </div>
                <!-- Units per Year and Model Constants Section -->
                <div class="card lg:col-span-3">
                    <h3 class="text-xl font-semibold mb-4">Unidades por Año y Constantes del Modelo <span class="text-sm text-gray-500">(Definiciones base del negocio)</span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6" id="units-container">
                        <!-- Unit inputs will be dynamically generated here -->
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="constants-container">
                        <!-- Constant inputs will be dynamically generated here -->
                    </div>
                    <button onclick="forceCalculate()" class="mt-6 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-medium transition duration-300">  🔄  Recalcular Modelo</button>
                </div>
            </div>
        </div>
        <!-- Tab Content: Financials -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 0</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body"></tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4 text-center font-semibold p-2 rounded-lg bg-gray-50"></div>
                </div>
            </div>
        </div>
        <!-- Tab Content: NIIF -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos <span class="text-sm text-gray-600">(Cómo se reconocen los ingresos del negocio de financiamiento)</span></h3>
                    <div id="niif15-container">Calculando datos NIIF 15...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 9 - Provisiones Crediticias <span class="text-sm text-gray-600">(Impacto de la morosidad y las pérdidas esperadas)</span></h3>
                    <div id="niif9-container">Calculando datos NIIF 9...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos Mantenidos para Venta <span class="text-sm text-gray-600">(Tratamiento contable de vagonetas reposedas)</span></h3>
                    <div id="niif5-container">Calculando datos NIIF 5...</div>
                </div>
            </div>
        </div>
        <!-- Tab Content: Charts -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evolución de EBITDA</h4>
                    <div style="height: 300px;"><canvas id="ebitdaChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Composición de Ingresos (Año 5)</h4>
                    <div style="height: 300px;"><canvas id="revenueMixChart"></canvas></div>
                </div>
                 <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Activos Totales vs Pasivos + Patrimonio</h4>
                    <div style="height: 300px;"><canvas id="balanceValidationChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Flujo de Efectivo Neto Anual</h4>
                    <div style="height: 300px;"><canvas id="netCashFlowChart"></canvas></div>
                </div>
            </div>
        </div>
        <!-- Tab Content: Validation -->
        <div id="content-validacion" class="content-section">
            <div id="validation-panel-content">
                <h3 class="text-xl font-semibold mb-4">Resultados de Validación del Modelo</h3>
                <div id="validation-results-container">
                    <!-- Validation results will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    <script>
        // ===== GLOBAL MODEL VARIABLES =====
        let debugLogs = []; // Array to store debug logs
        let charts = {}; // Object to store Chart.js instances
        
        // Financial model data, initial values and control ranges
        let modelData = {
            // Credit and Risk Parameters
            tasaInteres: 25.5,      // Annual interest rate of client financing
            tasaMorosidad: 8,       // Percentage of interest income considered delinquent (for old logic)
            proteccionRodando: true,// Boolean to activate/deactivate provision reduction
            // IFRS 9 Parameters (new)
            pdStage1: 0.005, // 0.5% Probability of Default (12-month) for Stage 1 loans
            pdStage2: 0.08,  // 8% Probability of Default (lifetime) for Stage 2 loans
            pdStage3: 0.40,  // 40% Probability of Default (lifetime) for Stage 3 loans (Credit-impaired)
            lgd: 0.50,       // Loss Given Default (percentage of exposure lost if default occurs)
            portfolioAllocationStage1: 0.85, // 85% of active portfolio in Stage 1
            portfolioAllocationStage2: 0.10, // 10% of active portfolio in Stage 2
            portfolioAllocationStage3: 0.05, // 5% of active portfolio in Stage 3
            economicAdjustmentFactor: 1.0, // Factor for forward-looking macroeconomic adjustments (1.0 = no adjustment)
            // Operations and Debt Parameters
            comisionGNV: 8,         // Percentage commission for GNV services
            margenRefacciones: 25,  // Profit margin on spare parts
            ventureDebtPct: 70,     // Percentage of initial capital (Series A) obtained as Venture Debt (additional to Series A)
            ventureDebtRate: 12,    // Annual interest rate of Venture Debt
            periodoAmortizacionDeuda: 5, // Years to amortize initial Venture Debt
            // Units per Year (dynamic inputs)
            unitsPerYear: [200, 250, 300, 350, 400], // Units (vans) added each year
            // Model Constants
            vanCost: 641000,        // Acquisition cost of each van (Fixed Asset)
            vanPrice: 729000,       // Selling/financing price to client (for loan amount calculation)
            seriesA: 45000000,      // Initial Series A investment (Equity)
            seriesB_funding: 0,     // Amount of Series B funding
            seriesB_year: 3,        // Year Series B is received (Year 1 to Year 5)
            seriesC_funding: 0,     // Amount of Series C funding
            seriesC_year: 5,        // Year Series C is received (Year 1 to Year 5)
            clientLoanTermYears: 5, // Amortization period of client loans (in years)
            depreciationYears: 10,  // Years of straight-line depreciation for vans (RAG assets)
            opexRate: 15,           // Percentage of operating revenue allocated to OPEX
            margenVagoneta: 5,      // Percentage commission for originating each financed van
            gnvRevPerUnit: 15000,   // Base revenue per unit for GNV services
            refaccionesRevPerUnit: 8000, // Base revenue per unit for spare parts services
            marketplaceRevPerUnit: 5000, // Base revenue per unit for Marketplace services
            marketplace: 3,         // Percentage commission for Marketplace services
            tasaReposicion: 5,      // Percentage of units repossessed/classified as Assets Held for Sale annually
            fairValueVenta: 85,     // Percentage of fair value of repossessed vans
            costosVenta: 5,          // Percentage of costs associated with selling repossessed vans
            corporateTaxRate: 25   // Corporate tax rate (%)
        };
        
        // Ranges for slider inputs
        const sliderConfigs = [
            { id: 'tasaInteres', label: 'Tasa de Interés (Clientes)', min: 10, max: 35, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'tasaMorosidad', label: 'Tasa Morosidad (Antigua Lógica)', min: 4, max: 15, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'comisionGNV', label: 'Comisión GNV', min: 6, max: 20, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'margenRefacciones', label: 'Margen Refacciones', min: 20, max: 40, step: 1, type: 'range', format: val => val.toFixed(0) + '%' },
            { id: 'ventureDebtPct', label: '% Venture Debt', min: 50, max: 100, step: 5, type: 'range', format: val => val.toFixed(0) + '%' },
            { id: 'ventureDebtRate', label: 'Tasa Venture Debt', min: 10, max: 16, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' }
        ];
        
        // Ranges for model constants (number inputs)
        const constantConfigs = [
            { id: 'vanCost', label: 'Costo Vagoneta (RAG)', min: 500000, max: 800000, step: 1000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'vanPrice', label: 'Precio Préstamo Cliente', min: 600000, max: 900000, step: 1000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesA', label: 'Capital Serie A', min: 30000000, max: 60000000, step: 1000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesB_funding', label: 'Funding Serie B', min: 0, max: 200000000, step: 5000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesB_year', label: 'Año Serie B', min: 1, max: 5, step: 1, type: 'number', format: val => val.toFixed(0) + ' ' + (val == 1 ? 'año' : 'años') },
            { id: 'seriesC_funding', label: 'Funding Serie C', min: 0, max: 300000000, step: 5000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesC_year', label: 'Año Serie C', min: 1, max: 5, step: 1, type: 'number', format: val => val.toFixed(0) + ' ' + (val == 1 ? 'año' : 'años') },
            { id: 'clientLoanTermYears', label: 'Plazo Préstamo Cliente (Años)', min: 1, max: 10, step: 1, type: 'number', format: val => val.toFixed(0) + ' años' },
            { id: 'depreciationYears', label: 'Años Depreciación (Vagoneta)', min: 5, max: 15, step: 1, type: 'number', format: val => val.toFixed(0) + ' años' },
            { id: 'opexRate', label: 'Tasa OPEX (% Ingresos)', min: 10, max: 30, step: 1, type: 'number', format: val => val.toFixed(0) + '%' },
            { id: 'margenVagoneta', label: 'Margen Originación Vagoneta', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'gnvRevPerUnit', label: 'Ingreso GNV/Unidad', min: 10000, max: 20000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'refaccionesRevPerUnit', label: 'Ingreso Refacciones/Unidad', min: 5000, max: 15000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'marketplaceRevPerUnit', label: 'Ingreso Marketplace/Unidad', min: 3000, max: 10000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'marketplace', label: '% Comisión Marketplace', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'tasaReposicion', label: '% Unidades Reposición', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'fairValueVenta', label: '% Fair Value Venta', min: 70, max: 95, step: 1, type: 'number', format: val => val.toFixed(0) + '%' },
            { id: 'costosVenta', label: '% Costos Venta', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            // New IFRS 9 and Tax Rate Controls
            { id: 'pdStage1', label: 'PD Etapa 1 (12M)', min: 0.001, max: 0.05, step: 0.001, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'pdStage2', label: 'PD Etapa 2 (Lifetime)', min: 0.05, max: 0.20, step: 0.005, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'pdStage3', label: 'PD Etapa 3 (Lifetime)', min: 0.20, max: 0.60, step: 0.01, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'lgd', label: 'LGD (Recuperación %)', min: 0.1, max: 0.9, step: 0.01, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'portfolioAllocationStage1', label: 'Port. Etapa 1 (%)', min: 0.70, max: 0.95, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'portfolioAllocationStage2', label: 'Port. Etapa 2 (%)', min: 0.03, max: 0.20, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'portfolioAllocationStage3', label: 'Port. Etapa 3 (%)', min: 0.01, max: 0.10, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'economicAdjustmentFactor', label: 'Ajuste Económico (x)', min: 0.8, max: 1.2, step: 0.01, type: 'number', format: val => val.toFixed(2) + 'x' },
            { id: 'corporateTaxRate', label: 'Tasa Impuesto Corporativo (%)', min: 0, max: 40, step: 1, type: 'number', format: val => val.toFixed(0) + '%' }
        ];
        
        // Object to store calculated financial results
        let financialResults = {
            pl: [],             // Profit & Loss
            cf: [],             // Cash Flow
            bs: [],             // Balance Sheet
            niifDetails: [],    // IFRS application details
            tirProyecto: 0,     // Project Internal Rate of Return
            tirCartera: 0,      // Client Portfolio Internal Rate of Return
            tirEquity: 0,       // Equity Internal Rate of Return
            roe: [],            // Annual Return on Equity
            roic: []            // Annual Return on Invested Capital
        };
        
        // ===== DEBUG FUNCTIONS =====
        // Logs messages to the console and the UI debug panel
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.unshift(logEntry); // Add to the beginning
            if (debugLogs.length > 20) debugLogs.pop(); // Keep only the last 20 logs
            
            console.log(logEntry, data);
            updateDebugPanel();
        }
        
        // Updates the content of the debug panel in the UI
        function updateDebugPanel() {
            const panel = document.getElementById('debug-content');
            if (panel) {
                panel.innerHTML = debugLogs.map(log => `<div style="margin-bottom: 2px; font-size: 10px; border-bottom: 1px dotted #4b5563; padding-bottom: 2px;">${log}</div>`).join('');
            }
        }
        
        // Shows/hides the debug panel
        function toggleDebug() {
            const panel = document.getElementById('debug-info');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // ===== MAIN FINANCIAL CALCULATION =====
        // Central function to calculate all financial statements
        function calculateFinancials() {
            log('  🚀  INITIATING FINANCIAL CALCULATIONS...');
            try {
                // Reset results before each calculation
                financialResults = { 
                    pl: [], cf: [], bs: [], niifDetails: [], 
                    tirProyecto: 0, tirCartera: 0, tirEquity: 0, 
                    roe: [], roic: [] 
                };
                
                // Initial funding variables for the model (outside the annual loop for persistence)
                const initialEquityInvestment = modelData.seriesA;
                const initialVentureDebtAmount = initialEquityInvestment * (modelData.ventureDebtPct / 100);
                
                // Initialize state variables before the annual loop
                let accumulatedEarnings = 0; // Accumulated retained earnings
                let cash = initialEquityInvestment + initialVentureDebtAmount; // Initial cash comes from Series A + initial Venture Debt
                let totalDebt = initialVentureDebtAmount; // Initial debt balance is initial Venture Debt
                let currentProvisionsBalance = 0; // Accumulated balance of IFRS 9 provisions in Balance Sheet
                let contractLiabilitiesBalance = 0; // Accumulated balance of contract liabilities (IFRS 15)
                let totalUnitsAccumulatedHeldForSale = 0; // For calculation of Operating Vans
                
                // Array to store client loan cohorts
                // loanCohorts = [{ yearOriginated: Y, originalPrincipal: P, remainingPrincipal: P, paymentsMadeMonths: 0, monthlyPayment: M, monthlyInterestRate: r, totalLoanTermMonths: N }]
                let loanCohorts = [];
                
                // Array to store fixed asset (van) cohorts
                // fixedAssetsCohorts = [{ yearAcquired: X, units: Y, originalCostPerUnit: C, totalOriginalCost: Y*C, accumulatedDepreciation: D, isHeldForSale: false, heldForSaleYear: null, carryingAmountAtHFS: 0, currentFairValueLessCosts: 0 }]
                let fixedAssetsCohorts = [];
                
                // Arrays for IRR calculation
                const projectCashFlows = [-(initialEquityInvestment + initialVentureDebtAmount)]; // Project IRR: Total initial investment
                const equityCashFlows = [-initialEquityInvestment]; // Equity IRR: Initial Equity investment
                let totalPrincipalOriginatedAcrossAllYears = 0; // For the initial investment of Portfolio IRR
                
                // For Portfolio IRR flows (initial investment added after the loop)
                const portfolioCashFlowsForIRR = []; 
                
                log(`Initial Series A Capital: ${formatCurrency(modelData.seriesA)}`);
                log(`Initial Venture Debt (part of Series A AND ADDITIONAL): ${formatCurrency(initialVentureDebtAmount)}`);
                log(`Total initial cash (Series A + Venture Debt): ${formatCurrency(cash)}`);
                
                // Annual Cycle: from Year 0 (representing the start of Year 1) to Year 4 (representing the end of Year 5)
                for (let year = 0; year < 5; year++) {
                    log(`\n--- Calculating Year ${year + 1} ---`);
                    const addedUnits = modelData.unitsPerYear[year];
                    
                    // Save initial Equity and Debt balances for annual average ROIC/ROE calculation
                    const startOfYearEquity = initialEquityInvestment + accumulatedEarnings;
                    const startOfYearTotalDebt = totalDebt;

                    // --- INVESTMENTS (Fixed Assets) - Acquisition of new vans ---
                    const capexThisYear = addedUnits * modelData.vanCost; // Investment in vans (CAPEX)
                    if (addedUnits > 0) {
                        fixedAssetsCohorts.push({
                            yearAcquired: year + 1,
                            units: addedUnits,
                            originalCostPerUnit: modelData.vanCost,
                            totalOriginalCost: addedUnits * modelData.vanCost,
                            accumulatedDepreciation: 0, // Initial depreciation at 0 for the cohort
                            isHeldForSale: false,
                            heldForSaleYear: null,
                            carryingAmountAtHFS: 0, // Book value at the time of classification as HFS
                            currentFairValueLessCosts: 0 // Value for the balance sheet after IFRS 5 impairment
                        });
                        log(` New fixed asset cohort Year ${year+1}: ${addedUnits} units for ${formatCurrency(capexThisYear)}`);
                    }
                    
                    // --- DEPRECIATION OF FIXED ASSETS (Vans) ---
                    // Depreciation only applies to assets NOT classified as "Held for Sale" (IFRS 5)
                    let annualDepreciation = 0;
                    fixedAssetsCohorts.forEach(cohort => {
                        if (!cohort.isHeldForSale) { // Only depreciate assets not classified as IFRS 5
                            const yearsDepreciated = (year + 1) - cohort.yearAcquired; // Years elapsed since acquisition
                            const remainingDepreciableLife = modelData.depreciationYears - yearsDepreciated;
                            if (remainingDepreciableLife > 0 && cohort.accumulatedDepreciation < cohort.totalOriginalCost) {
                                const depreciationRate = 1 / modelData.depreciationYears;
                                const depreciationThisYear = cohort.totalOriginalCost * depreciationRate;
                                
                                // Ensure that depreciation does not exceed the remaining undepreciated value
                                const remainingValue = cohort.totalOriginalCost - cohort.accumulatedDepreciation;
                                cohort.depreciationThisYear = Math.min(depreciationThisYear, remainingValue);
                                cohort.accumulatedDepreciation += cohort.depreciationThisYear;
                                annualDepreciation += cohort.depreciationThisYear;
                            } else {
                                cohort.depreciationThisYear = 0;
                            }
                        } else {
                            cohort.depreciationThisYear = 0; // IFRS 5 assets are not depreciated
                        }
                    });

                    // --- IFRS 5: ASSET RECLASSIFICATION AND IMPAIRMENT CALCULATION ---
                    // The repossession rate is applied to active units and reallocated to IFRS 5
                    let totalImpairmentThisYear = 0;
                    let unitsToRepossess = Math.round((fixedAssetsCohorts.filter(c => !c.isHeldForSale).reduce((sum, c) => sum + c.units, 0)) * (modelData.tasaReposicion / 100));
                    let remainingUnitsToRepossess = unitsToRepossess;
                    
                    // Variables to accumulate the values of assets reclassified this year for IFRS detail
                    let valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearFairValue = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue = 0;
                    
                    // Sort cohorts to repossess the oldest first (conceptual FIFO)
                    fixedAssetsCohorts.sort((a, b) => a.yearAcquired - b.yearAcquired);
                    fixedAssetsCohorts.forEach(cohort => {
                        if (!cohort.isHeldForSale && remainingUnitsToRepossess > 0) {
                            const unitsFromCohort = Math.min(remainingUnitsToRepossess, cohort.units);
                            if (unitsFromCohort > 0) {
                                // Calculate the book value of the repossessed units at the time of reclassification
                                const proportionToRepossess = unitsFromCohort / cohort.units;
                                const carryingAmountAtClassification = (cohort.totalOriginalCost - cohort.accumulatedDepreciation) * proportionToRepossess;
                                cohort.isHeldForSale = true; // Mark the cohort as IFRS 5 (simplification)
                                cohort.heldForSaleYear = year + 1;
                                cohort.carryingAmountAtHFS = carryingAmountAtClassification; // Book value at the time of reclassification
                                
                                // Calculation of Fair Value less costs to sell
                                const fairValueLessCosts = carryingAmountAtClassification * (modelData.fairValueVenta / 100) * (1 - (modelData.costosVenta / 100));
                                
                                // Impairment calculation
                                const impairmentForTheseUnits = Math.max(0, carryingAmountAtClassification - fairValueLessCosts);
                                totalImpairmentThisYear += impairmentForTheseUnits; // Add to annual P&L impairment
                                
                                // Value for the Balance Sheet after impairment
                                cohort.currentFairValueLessCosts = carryingAmountAtClassification - impairmentForTheseUnits;
                                
                                remainingUnitsToRepossess -= unitsFromCohort;
                                totalUnitsAccumulatedHeldForSale += unitsFromCohort; // ACCUMULATE units classified as IFRS 5
                                
                                // Accumulate for this year's IFRS details
                                valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount += carryingAmountAtClassification;
                                valueOfAssetsReclassifiedToNIIF5ThisYearFairValue += carryingAmountAtClassification * (modelData.fairValueVenta / 100);
                                valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell += carryingAmountAtClassification * (modelData.fairValueVenta / 100) * (modelData.costosVenta / 100);
                                valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue += fairValueLessCosts;
                                log(` Reclassified ${unitsFromCohort} units from cohort Year ${cohort.yearAcquired} to IFRS 5. BV at reclassification: ${formatCurrency(carryingAmountAtClassification)}, Impairment: ${formatCurrency(impairmentForTheseUnits)}`);
                            }
                        }
                    });
                    const impairment = totalImpairmentThisYear; // Impairment for P&L

                    // --- ORIGINATION OF NEW CLIENT LOAN COHORT ---
                    let totalPrincipalOriginatedThisYear = 0; // Total principal of new loans this year
                    if (addedUnits > 0) {
                        const newCohortPrincipal = addedUnits * modelData.vanPrice;
                        totalPrincipalOriginatedThisYear = newCohortPrincipal; // This is the actual investment in the client loan
                        totalPrincipalOriginatedAcrossAllYears += newCohortPrincipal; // Accumulate for Portfolio IRR
                        const monthlyInterestRateClient = (modelData.tasaInteres / 100) / 12;
                        const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
                        
                        let monthlyPaymentClient = 0;
                        if (monthlyInterestRateClient > 0) {
                            monthlyPaymentClient = newCohortPrincipal * (monthlyInterestRateClient / (1 - Math.pow(1 + monthlyInterestRateClient, -totalPaymentsMonthsClient)));
                        } else {
                            // If the interest rate is 0, the monthly payment is simply principal / number of months
                            monthlyPaymentClient = newCohortPrincipal / totalPaymentsMonthsClient;
                        }
                        loanCohorts.push({
                            yearOriginated: year + 1,
                            originalPrincipal: newCohortPrincipal,
                            remainingPrincipal: newCohortPrincipal, // At the beginning of the year, this is the total
                            paymentsMadeMonths: 0, // No payments made yet for this cohort
                            monthlyPayment: monthlyPaymentClient,
                            monthlyInterestRate: monthlyInterestRateClient,
                            totalLoanTermMonths: totalPaymentsMonthsClient
                        });
                        log(` New cohort Year ${year+1}: ${addedUnits} units, Principal: ${formatCurrency(newCohortPrincipal)}. This is an INVESTMENT.`);
                    }
                    
                    // --- AMORTIZATION AND REVENUE RECOGNITION BY COHORTS (Clients) ---
                    let annualInterestReceived = 0; // Accrued interest income this year from all cohorts
                    let annualPrincipalReceived = 0; // Principal payments received this year from all cohorts
                    let currentYearEndReceivables = 0; // Total A/R balance at the end of this year
                    
                    // Iterate over all active cohorts (those that still have an outstanding balance)
                    loanCohorts.forEach(cohort => {
                        if (cohort.remainingPrincipal > 0 && cohort.paymentsMadeMonths < cohort.totalLoanTermMonths) {
                            for (let m = 0; m < 12; m++) { // Simulate 12 months of payments for each cohort
                                if (cohort.remainingPrincipal <= 0 || cohort.paymentsMadeMonths >= cohort.totalLoanTermMonths) {
                                    break; // Cohort fully amortized
                                }
                                
                                const interestThisMonth = cohort.remainingPrincipal * cohort.monthlyInterestRate;
                                let principalThisMonth = cohort.monthlyPayment - interestThisMonth;
                                // Ensure that the principal to be paid does not exceed the remaining balance
                                principalThisMonth = Math.min(principalThisMonth, cohort.remainingPrincipal);
                                
                                annualInterestReceived += interestThisMonth;
                                annualPrincipalReceived += principalThisMonth;
                                cohort.remainingPrincipal -= principalThisMonth;
                                cohort.paymentsMadeMonths++;
                            }
                        }
                        // Add the remaining balance of this cohort to the total A/R at year-end
                        currentYearEndReceivables += Math.max(0, cohort.remainingPrincipal);
                    });
                    
                    // --- PROFIT & LOSS STATEMENT (P&L) ---
                    // Operating Income
                    // Interest Income: now comes from the sum of accrued interest from all cohorts
                    const interestRevenue = annualInterestReceived;
                    
                    // IFRS 15: ORIGINATION MARGIN (Deferred over time)
                    const totalOriginationContractValueThisYear = addedUnits * modelData.vanPrice * (modelData.margenVagoneta / 100);
                    contractLiabilitiesBalance += totalOriginationContractValueThisYear;
                    
                    // Calculate the amount to be recognized this year
                    let recognizedOriginationRevenueThisYear = totalOriginationContractValueThisYear / modelData.clientLoanTermYears;
                    // Critical adjustment: Ensure recognition does not exceed accumulated contract liability
                    if (recognizedOriginationRevenueThisYear > contractLiabilitiesBalance) {
                        log(`  ⚠️  IFRS 15 Adjustment: Origination recognition (${formatCurrency(recognizedOriginationRevenueThisYear)}) exceeds accumulated contract liability (${formatCurrency(contractLiabilitiesBalance)}). Adjusting.`);
                        recognizedOriginationRevenueThisYear = contractLiabilitiesBalance; // Only recognize what is available
                    }
                    contractLiabilitiesBalance -= recognizedOriginationRevenueThisYear; // Reduce contract liability by the amount *actually* recognized
                    const originationCommission = recognizedOriginationRevenueThisYear; // Income recognized in P&L
                    
                    // Calculate total active units (not Held For Sale)
                    // **CORRECTION:** Sum of units from fixedAssets cohorts that are NOT marked as isHeldForSale
                    const totalActiveUnits = fixedAssetsCohorts.filter(c => !c.isHeldForSale).reduce((sum, cohort) => sum + cohort.units, 0);
                    
                    // IFRS 15: GNV COMMISSIONS (Recognized over time / in the year the service is provided)
                    // Assumed that `gnvRevPerUnit` is an annual value per active unit (not HFS).
                    const gnvCommissions = totalActiveUnits * modelData.gnvRevPerUnit * (modelData.comisionGNV / 100);
                    
                    // IFRS 15: SPARE PARTS REVENUE (Recognized at a point in time)
                    // Assumed that spare parts sales occur in the year of unit addition.
                    const sparePartsRevenue = addedUnits * modelData.refaccionesRevPerUnit * (modelData.margenRefacciones / 100);
                    
                    // IFRS 15: MARKETPLACE REVENUE (Recognized over time / in the year the service is provided)
                    // Similar to GNV, assumed that `marketplaceRevPerUnit` is an annual value per active unit (not HFS).
                    const marketplaceRevenue = totalActiveUnits * modelData.marketplaceRevPerUnit * (modelData.marketplace / 100);
                    
                    const totalRevenue = interestRevenue + originationCommission + gnvCommissions + sparePartsRevenue + marketplaceRevenue;
                    log(`Revenue: Interest=${formatCurrency(interestRevenue)}, Origination=${formatCurrency(originationCommission)}, GNV=${formatCurrency(gnvCommissions)}, Spare Parts=${formatCurrency(sparePartsRevenue)}, Marketplace=${formatCurrency(marketplaceRevenue)}`);
                    log(`TOTAL OPERATING REVENUE: ${formatCurrency(totalRevenue)}`);
                    
                    // Operating Expenses (OPEX)
                    const opex = totalRevenue * (modelData.opexRate / 100);
                    
                    // --- IFRS 9: CREDIT PROVISIONS (Expected Credit Losses - ECL) ---
                    // Exposure at Default (EAD) = Outstanding balance of the loan portfolio at period end
                    let totalOutstandingPrincipalForECL = currentYearEndReceivables; // Use A/R balance at year-end
                    
                    // Portfolio distribution by stages (simplification for this aggregated model)
                    // No individual migration simulated, assumes fixed percentages of total portfolio in each stage.
                    const eadStage1 = totalOutstandingPrincipalForECL * modelData.portfolioAllocationStage1;
                    const eadStage2 = totalOutstandingPrincipalForECL * modelData.portfolioAllocationStage2;
                    const eadStage3 = totalOutstandingPrincipalForECL * modelData.portfolioAllocationStage3;
                    
                    // Calculate Expected Credit Losses (ECL = EAD * PD * LGD)
                    const eclStage1Amount = eadStage1 * modelData.pdStage1 * modelData.lgd;
                    const eclStage2Amount = eadStage2 * modelData.pdStage2 * modelData.lgd;
                    const eclStage3Amount = eadStage3 * modelData.pdStage3 * modelData.lgd;
                    
                    let annualECLProvision = eclStage1Amount + eclStage2Amount + eclStage3Amount;
                    // Apply adjustment for forward-looking information
                    annualECLProvision *= modelData.economicAdjustmentFactor;
                    
                    // Apply "Protección Rodando" if active (reduces final provision expense)
                    const provisions = annualECLProvision * (modelData.proteccionRodando ? 0.5 : 1.0); // Period provision expense (adjusted by Protección Rodando)
                    currentProvisionsBalance += provisions; // Accumulate for Balance Sheet
                    log(` IFRS 9 Provisions (ECL) this year: ${formatCurrency(provisions)}. Base outstanding: ${formatCurrency(totalOutstandingPrincipalForECL)}`);
                    
                    // Interest Expense on Debt (Venture Debt)
                    const interestExpense = (year === 0 ? initialVentureDebtAmount : totalDebt) * (modelData.ventureDebtRate / 100);
                    
                    // P&L Results
                    const ebitda = totalRevenue - opex - provisions - impairment; // EBITDA includes provisions and IFRS 5 impairment as operating expenses
                    const netIncome = ebitda - annualDepreciation - interestExpense; // Net Income
                    accumulatedEarnings += netIncome; // Accumulate earnings for Equity
                    
                    // --- CASH FLOW STATEMENT (CF) ---
                    
                    // `deltaReceivables` is the change in the A/R balance from the Balance Sheet
                    const prevReceivablesBalance = (year === 0) ? 0 : financialResults.bs[year-1].receivables;
                    const deltaReceivables = currentYearEndReceivables - prevReceivablesBalance;
                    
                    // Operating Cash Flow (Indirect Method): Net Income adjusted for non-cash items and changes in working capital (A/R)
                    const operatingCash = netIncome + annualDepreciation + provisions + impairment - deltaReceivables;
                    
                    // Investing Cash Flow: Includes van CAPEX AND CLIENT LOAN ORIGINATION
                    const investingCash = -capexThisYear - totalPrincipalOriginatedThisYear; // CRITICAL: Correction of the critical error!
                    log(` Investing Cash Flow (van CAPEX + Loan Origination): ${formatCurrency(investingCash)}`);
                    
                    let financingCashThisPeriod = 0; // Represents net financing activities for *this* period
                    let principalPaymentVentureDebtThisPeriod = 0; // To store in CF results
                    let newEquityRaisedThisPeriod = 0; // Accumulates Series B, C, and liquidity plug
                    let additionalFundingRaised = 0; // Declared here to ensure its scope
                    
                    // Staggered capital contributions (Series B and C)
                    if (year + 1 === modelData.seriesB_year) {
                        financingCashThisPeriod += modelData.seriesB_funding;
                        newEquityRaisedThisPeriod += modelData.seriesB_funding;
                        log(`  🎉  Series B funding received in Year ${year+1}: ${formatCurrency(modelData.seriesB_funding)}`);
                    }
                    if (year + 1 === modelData.seriesC_year) {
                        financingCashThisPeriod += modelData.seriesC_funding;
                        newEquityRaisedThisPeriod += modelData.seriesC_funding;
                        log(`  🎉  Series C funding received in Year ${year+1}: ${formatCurrency(modelData.seriesC_funding)}`);
                    }
                    
                    // Principal payment for initial Venture Debt
                    if (totalDebt > 0 && modelData.periodoAmortizacionDeuda > 0) {
                        const annualPrincipalPaymentFixed = initialVentureDebtAmount / modelData.periodoAmortizacionDeuda;
                        principalPaymentVentureDebtThisPeriod = Math.min(annualPrincipalPaymentFixed, totalDebt); // Ensure payment does not exceed remaining debt
                        totalDebt = Math.max(0, totalDebt - principalPaymentVentureDebtThisPeriod); // Reduce remaining debt balance
                        financingCashThisPeriod -= principalPaymentVentureDebtThisPeriod; // Payment is a cash outflow
                    }
                    
                    // Calculate provisional net cash for the period
                    let netCash = operatingCash + investingCash + financingCashThisPeriod;
                    
                    // LIQUIDITY PLUG: If cash falls below zero, assume additional funding
                    const prospectiveCash = cash + netCash;
                    if (prospectiveCash < 0) {
                        additionalFundingRaised = -prospectiveCash; // Amount to bring cash to zero
                        financingCashThisPeriod += additionalFundingRaised;
                        newEquityRaisedThisPeriod += additionalFundingRaised; // The plug is considered additional equity
                        netCash += additionalFundingRaised; // Recalculate netCash to reflect new funding
                        log(`  ⚠️  Cash deficit in Year ${year+1}. Assuming ADDITIONAL funding (Liquidity Plug): ${formatCurrency(additionalFundingRaised)}`);
                    }
                    
                    // Update total cash balance
                    cash += netCash; 
                    
                    // Update Equity for the balance sheet (before calculating metrics based on final balance)
                    // Equity: Initial Series A capital + accumulated earnings + new equity raised this period
                    let endOfYearEquity = initialEquityInvestment + accumulatedEarnings + newEquityRaisedThisPeriod;
                    
                    // --- BALANCE SHEET (BS) ---
                    // Net Fixed Assets: Sum original costs and subtract accumulated depreciation ONLY for assets NOT classified as IFRS 5
                    let totalOriginalCostPPandE = 0;
                    let totalAccumulatedDepreciationPPandE = 0;
                    let totalNIIF5AssetsBS = 0; // Total value of assets classified as IFRS 5 for the Balance Sheet
                    fixedAssetsCohorts.forEach(cohort => {
                        if (cohort.isHeldForSale) {
                            totalNIIF5AssetsBS += cohort.currentFairValueLessCosts; // Use post-impairment value for IFRS 5 in Balance
                        } else {
                            totalOriginalCostPPandE += cohort.totalOriginalCost;
                            totalAccumulatedDepreciationPPandE += cohort.accumulatedDepreciation;
                        }
                    });
                    
                    const fixedAssetsNet = totalOriginalCostPPandE - totalAccumulatedDepreciationPPandE;
                    const assetsHeldForSaleNet = totalNIIF5AssetsBS; // It's the accumulated balance of IFRS 5 values in Balance
                    
                    // Total Assets
                    const totalAssets = cash + currentYearEndReceivables + fixedAssetsNet + assetsHeldForSaleNet; // currentYearEndReceivables is the A/R balance
                    
                    // Total Liabilities + Equity
                    const totalLiabilitiesEquity = totalDebt + currentProvisionsBalance + contractLiabilitiesBalance + endOfYearEquity; // Add contractLiabilitiesBalance
                    
                    // Balance Sheet Validation: Compares Total Assets and Total Liabilities + Equity
                    const balanceDiff = Math.abs(totalAssets - totalLiabilitiesEquity);
                    log(`Balance Difference Year ${year + 1}: ${formatCurrency(balanceDiff)}`);
                    
                    // --- ANNUAL METRIC CALCULATION (ROE, ROIC) ---
                    const averageEquity = (startOfYearEquity + endOfYearEquity) / 2;
                    const averageInvestedCapital = (startOfYearEquity + startOfYearTotalDebt + endOfYearEquity + totalDebt) / 2; // Average Equity + Average Debt
                    
                    let annualROE = 0;
                    if (averageEquity !== 0) annualROE = (netIncome / averageEquity) * 100;
                    
                    let annualROIC = 0;
                    // NOPAT = EBIT * (1 - Tax Rate)
                    const ebit = ebitda - annualDepreciation;
                    const nopat = ebit * (1 - (modelData.corporateTaxRate / 100));
                    if (averageInvestedCapital !== 0) annualROIC = (nopat / averageInvestedCapital) * 100;
                    
                    financialResults.roe.push(annualROE);
                    financialResults.roic.push(annualROIC);

                    // --- ANNUAL RESULTS STORAGE ---
                    financialResults.pl.push({
                        interestRevenue, originationCommission, gnvCommissions, sparePartsRevenue, marketplaceRevenue, totalRevenue,
                        opex, provisions, impairment, ebitda, 
                        depreciation: annualDepreciation, interestExpense, netIncome,
                        cumulativeUnits: fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0) // Total units for Portfolio IRR
                    });
                    financialResults.cf.push({
                        operatingCash, investingCash, financingCash: financingCashThisPeriod, netCash,
                        principalPaymentVentureDebt: principalPaymentVentureDebtThisPeriod, // Venture Debt principal payment
                        clientPrincipalPaymentsReceived: annualPrincipalReceived, // Client principal payments
                        additionalFundingRaised: additionalFundingRaised // Liquidity plug
                    });
                    financialResults.bs.push({
                        cash, receivables: currentYearEndReceivables, fixedAssets: fixedAssetsNet, 
                        assetsHeldForSale: assetsHeldForSaleNet, totalAssets,
                        debt: totalDebt, provisions: currentProvisionsBalance, contractLiabilities: contractLiabilitiesBalance, equity: endOfYearEquity, totalLiabilitiesEquity
                    });
                    
                    // --- IFRS DETAILS ---
                    financialResults.niifDetails.push({
                        niif15: {
                            // Total contract revenue (for IFRS 15 disclosure)
                            totalContractValue: totalOriginationContractValueThisYear + gnvCommissions + sparePartsRevenue + marketplaceRevenue + interestRevenue,
                            // Origination margin
                            recognizedOriginationRevenue: recognizedOriginationRevenueThisYear,
                            totalOriginationContractValue: totalOriginationContractValueThisYear,
                            contractLiabilitiesBalance: contractLiabilitiesBalance,
                            // Other revenues recognized this year
                            interestRevenue: interestRevenue, // From IFRS 9
                            gnvCommissions: gnvCommissions,
                            sparePartsRevenue: sparePartsRevenue,
                            marketplaceRevenue: marketplaceRevenue
                        },
                        niif9: {
                            // IFRS 9 data based on new ECL logic
                            totalOutstandingPrincipal: totalOutstandingPrincipalForECL,
                            eadStage1: eadStage1,
                            eclStage1Amount: eclStage1Amount,
                            pdStage1: modelData.pdStage1,
                            eadStage2: eadStage2,
                            eclStage2Amount: eclStage2Amount,
                            pdStage2: modelData.pdStage2,
                            eadStage3: eadStage3,
                            eclStage3Amount: eclStage3Amount,
                            pdStage3: modelData.pdStage3,
                            lgd: modelData.lgd,
                            totalECLBeforeAdjustment: eclStage1Amount + eclStage2Amount + eclStage3Amount,
                            economicAdjustmentFactor: modelData.economicAdjustmentFactor,
                            provisionesSinProteccion: annualECLProvision, // This is total ECL with economic adjustment, before Protección Rodando
                            provisionesConProteccion: provisions, // This is the actual expense in P&L
                            reduccionPorProteccion: annualECLProvision - provisions,
                            saldoProvisionesAcumulado: currentProvisionsBalance, // Accumulated balance for Balance Sheet
                            proteccionRodandoActiva: modelData.proteccionRodando
                        },
                        niif5: {
                            unidadesClasificadasAnuales: unitsToRepossess, // Units repossessed this year
                            valorEnLibrosClasificado: valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount, // Original BV of reclassified assets
                            valorRazonable: valueOfAssetsReclassifiedToNIIF5ThisYearFairValue,
                            costosDeVenta: valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell,
                            valorRazonableMenosCostos: valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue,
                            perdidaPorDeterioro: totalImpairmentThisYear, // Impairment loss this year
                            saldoActivosParaVentaAcumulado: assetsHeldForSaleNet, // Accumulated balance for Balance Sheet
                            totalUnitsAccumulatedHeldForSale: totalUnitsAccumulatedHeldForSale // New property to store the total accumulated
                        }
                    });
                    
                    // Cash flow for Portfolio IRR
                    portfolioCashFlowsForIRR.push(interestRevenue - provisions - (interestRevenue * 0.05)); // Include 5% operating cost of portfolio
                    
                    // Cash flow for Equity IRR (after tax and financing adjustment)
                    // Free Cash Flow to Equity (FCFE) = OCF - Capex + Net Borrowing (Principal Received - Principal Paid) + New Equity
                    const fcfes = operatingCash + investingCash + (newEquityRaisedThisPeriod - principalPaymentVentureDebtThisPeriod);
                    equityCashFlows.push(fcfes);
                }
                
                // ===== RESIDUAL ASSET VALUE (For Project IRR) =====
                // The value of assets at the end of the projection period (Year 5) is calculated
                // **CORRECTION:** The calculation base for totalFixedAssetsOriginalCost for Portfolio IRR now uses totalPrincipalOriginatedAcrossAllYears for better accuracy.
                const totalFixedAssetsAtEnd = fixedAssetsCohorts.reduce((sum, cohort) => sum + (cohort.totalOriginalCost - cohort.accumulatedDepreciation), 0);
                const totalReceivablesAtEnd = financialResults.bs[4].receivables;
                const totalAssetsHeldForSaleAtEnd = financialResults.bs[4].assetsHeldForSale;
                const terminalValue = totalFixedAssetsAtEnd + totalReceivablesAtEnd + totalAssetsHeldForSaleAtEnd;
                projectCashFlows[projectCashFlows.length - 1] += terminalValue; // Add to the last projectCashFlows flow
                log(` Residual Asset Value (Year 5): ${formatCurrency(terminalValue)} (added to Project IRR)`);

                // ===== FINAL IRR CALCULATION (after annual loop) =====
                log('\nCalculating Project IRR...');
                financialResults.tirProyecto = calculateIRR(projectCashFlows);
                log(`Calculated Project IRR: ${financialResults.tirProyecto.toFixed(2)}%`);
                
                log('Calculating Portfolio IRR...');
                if (portfolioCashFlowsForIRR.length > 0) {
                    // Portfolio IRR: Initial investment is the total principal originated by client loans.
                    const carteraInitialInvestment = totalPrincipalOriginatedAcrossAllYears;
                    
                    const carteraCashFlows = [-carteraInitialInvestment, ...portfolioCashFlowsForIRR];
                    financialResults.tirCartera = calculateIRR(carteraCashFlows);
                } else {
                    financialResults.tirCartera = 0; // If no flows, IRR is 0
                }
                log(`Calculated Portfolio IRR: ${financialResults.tirCartera.toFixed(2)}%`);
                
                log('Calculating Equity IRR...');
                financialResults.tirEquity = calculateIRR(equityCashFlows);
                log(`Calculated Equity IRR: ${financialResults.tirEquity.toFixed(2)}%`);
                
                log('  ✅  FINANCIAL CALCULATIONS COMPLETED SUCCESSFULLY');
                return true; // Indicates that the calculation was successful
                
            } catch (error) {
                log(`  ❌  ERROR in calculateFinancials: ${error.message}`);
                console.error('Critical error in financial calculations:', error);
                return false; // Indicates that there was an error
            }
        }
        
        // ===== IRR (Internal Rate of Return) CALCULATION FUNCTION =====
        // Newton-Raphson method implementation to calculate IRR
        function calculateIRR(cashFlows, maxIterations = 100, tolerance = 1e-6) {
            try {
                // Basic validation of cash flows
                if (!cashFlows || cashFlows.length < 2) {
                    log('IRR: Insufficient cash flows.');
                    return 0;
                }
                
                // Must have at least one positive and one negative cash flow for a meaningful IRR
                const hasPositive = cashFlows.some(cf => cf > 0);
                const hasNegative = cashFlows.some(cf => cf < 0);
                if (!hasPositive || !hasNegative) {
                    log('IRR: No positive and negative cash flows, IRR undefined.');
                    return 0;
                }
                
                let guess = 0.1; // Initial IRR estimate (10%)
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;    // Net Present Value
                    let dNpv = 0;   // Derivative of NPV (for Newton-Raphson)
                    
                    for (let t = 0; t < cashFlows.length; t++) {
                        const denominator = Math.pow(1 + guess, t);
                        npv += cashFlows[t] / denominator;
                        if (t > 0) { // Derivative only applies to future terms
                            dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                        }
                    }
                    
                    // If NPV is close to zero, we have found the IRR
                    if (Math.abs(npv) < tolerance) {
                        // Return the result as a percentage, limited to a reasonable range
                        const result = Math.max(-99, Math.min(200, guess * 100)); 
                        log(`IRR converged in ${i} iterations: ${result.toFixed(2)}%`);
                        return result;
                    }
                    
                    // Avoid division by zero if derivative is very small
                    if (Math.abs(dNpv) < tolerance) {
                         log('IRR: Derivative close to zero, cannot improve further.');
                         break;
                    }
                   
                    // New guess using Newton-Raphson formula
                    const newGuess = guess - npv / dNpv;
                    // If improvement is minimal, stop iteration
                    if (Math.abs(newGuess - guess) < tolerance) { 
                        const result = Math.max(-99, Math.min(200, newGuess * 100));
                        log(`IRR: Minimal convergence, ending in ${i} iterations: ${result.toFixed(2)}%`);
                        return result;
                    }
                    
                    // Update the guess, ensuring 1 + guess is always positive to avoid NaN
                    guess = Math.max(-0.99, Math.min(5, newGuess)); 
                }
                
                // If not converged after maxIterations, return the best guess
                const result = Math.max(-99, Math.min(200, guess * 100));
                log(`IRR did not fully converge (Max iterations): ${result.toFixed(2)}%`);
                return result; 
                
            } catch (error) {
                log(`Unexpected error calculating IRR: ${error.message}`);
                return 0; // In case of any error, return 0
            }
        }
        
        // ===== USER INTERFACE (UI) UPDATE =====
        // Updates key metrics in summary cards and then tables and charts
        function updateUI() {
            log('  🔄  Updating User Interface...');
            try {
                if (!financialResults.pl || financialResults.pl.length === 0) {
                    log('  ❌  No financial data to update UI.');
                    return;
                }
                
                // Update summary cards
                const year5PL = financialResults.pl[4];
                const year5BS = financialResults.bs[4];
                
                // Calculate total financed units by summing all years
                const totalUnitsAcquired = modelData.unitsPerYear.reduce((acc, curr) => acc + curr, 0);
                
                // Operating vans: total units acquired - total accumulated units classified as IFRS5
                const vagonetasOperativas = totalUnitsAcquired - (financialResults.niifDetails[4]?.niif5?.totalUnitsAccumulatedHeldForSale || 0);

                if (year5PL && year5BS) {
                    document.getElementById('ebitda-year5').textContent = formatCurrency(year5PL.ebitda);
                    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                    document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                    document.getElementById('tir-equity').textContent = financialResults.tirEquity.toFixed(1) + '%';
                    document.getElementById('deuda-residual').textContent = formatCurrency(year5BS.debt);
                    document.getElementById('vagonetas-operativas').textContent = Math.round(vagonetasOperativas);
                    
                    // Display ROE and ROIC for Year 5
                    document.getElementById('roe-year5').textContent = financialResults.roe[4].toFixed(1) + '%';
                    document.getElementById('roic-year5').textContent = financialResults.roic[4].toFixed(1) + '%';
                    log(`  ✅  Main and profitability metrics updated.`);
                    
                    // Benchmarking to debug log
                    log(` --- Profitability Benchmarking (Year 5) ---`);
                    log(` Equity IRR: ${financialResults.tirEquity.toFixed(1)}% (Industry Target: 20-30%)`);
                    log(` Project IRR: ${financialResults.tirProyecto.toFixed(1)}% (Industry Target: 15-20%)`);
                    log(` Portfolio IRR: ${financialResults.tirCartera.toFixed(1)}% (Industry Target: 25-35%)`);
                    log(` ROE: ${financialResults.roe[4].toFixed(1)}% (Industry Target: 25-35%)`);
                    log(` ROIC: ${financialResults.roic[4].toFixed(1)}% (Industry Target: 12-18%)`);
                } else {
                    log('  ⚠️  Year 5 data incomplete to update main metrics.');
                }
                
                updateTables(); // Updates P&L, CF, BS tables
                updateNIIFTables(); // Updates IFRS detail tables
                updateCharts(); // Updates charts
                
                // Run and display validations after UI update
                const validations = validateModelComprehensively(modelData, financialResults);
                updateValidationPanel(validations);
                
            } catch (error) {
                log(`  ❌  Error in updateUI: ${error.message}`);
                console.error('Error updating UI:', error);
            }
        }
        
        // Function that coordinates the update of all financial tables
        function updateTables() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
        }
        
        // Updates the Profit & Loss (P&L) table
        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody || !financialResults.pl.length) return;
            
            tbody.innerHTML = ''; // Clear table
            
            // P&L row definition
            const rows = [
                { label: 'Ingresos por Intereses', key: 'interestRevenue' },
                { label: 'Margen por Originación', key: 'originationCommission' },
                { label: 'Comisiones GNV', key: 'gnvCommissions' },
                { label: 'Ingresos Refacciones', key: 'sparePartsRevenue' },
                { label: 'Ingresos Marketplace', key: 'marketplaceRevenue' },
                { label: 'Total Ingresos Operativos', key: 'totalRevenue', total: true },
                { label: 'Gastos Operativos (OPEX)', key: 'opex', negative: true },
                { label: 'Provisiones NIIF 9', key: 'provisions', negative: true },
                { label: 'Pérdida por Deterioro NIIF 5', key: 'impairment', negative: true },
                { label: 'EBITDA', key: 'ebitda', total: true, emphasize: true },
                { label: 'Depreciación', key: 'depreciation', negative: true },
                { label: 'Gastos por Intereses (Deuda)', key: 'interestExpense', negative: true },
                { label: 'Utilidad Neta', key: 'netIncome', total: true, emphasize: true }
            ];
            
            // Populate the table dynamically
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50'); // Background for totals
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900'); // Bold for EBITDA and Net Income
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.pl.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[row.key] || 0; // Get the value, or 0 if undefined
                    
                    // Format and apply color classes
                    if (row.negative && value > 0) { // If it's an expense and the value is positive, show in parentheses and red
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else { // If not an expense or the value is negative, show directly
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
            log('  ✅  Profit & Loss Statement table updated.');
        }
        
        // Updates the Cash Flow (CF) table
        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody || !financialResults.cf.length) return;
            
            tbody.innerHTML = ''; // Clear table
            
            // Cash Flow row definition
            const rows = [
                { label: 'Flujo de Efectivo Operativo', total: true },
                { label: '  Utilidad Neta', key: 'netIncome', fromPL: true },
                { label: '  + Depreciación', key: 'depreciation', fromPL: true },
                { label: '  + Provisiones NIIF 9', key: 'provisions', fromPL: true },
                { label: '  + Pérdida por Deterioro NIIF 5', key: 'impairment', fromPL: true },
                { label: '  - Δ Cuentas por Cobrar', key: 'deltaReceivables', negative: true, calculateDelta: true },
                { label: 'Total Flujo de Efectivo Operativo', key: 'operatingCash', total: true, emphasize: true },
                { label: 'Flujo de Efectivo de Inversión', total: true, separator: true },
                { label: '  - CAPEX Vagonetas (Activos Fijos)', key: 'investingCash_capex', negative: true }, // CAPEX detail
                { label: '  - Originación de Préstamos Clientes', key: 'investingCash_loans', negative: true }, // Origination detail
                { label: 'Total Flujo de Efectivo de Inversión', key: 'investingCash', total: true, emphasize: true, duplicate: true },
                
                { label: 'Flujo de Efectivo de Financiación', total: true, separator: true },
                { label: '  Serie A Recibida', year0: modelData.seriesA },
                { label: '  Venture Debt Inicial Recibido', year0: modelData.seriesA * (modelData.ventureDebtPct / 100) },
                { label: '  Serie B Funding Recibido', key: 'seriesB_funding', fromModelData: true, yearSpecific: true },
                { label: '  Serie C Funding Recibido', key: 'seriesC_funding', fromModelData: true, yearSpecific: true },
                { label: '  - Pago Capital Venture Debt', key: 'principalPaymentVentureDebt', negative: true },
                { label: '  + Funding Adicional (Plug de Liquidez)', key: 'additionalFundingRaised', positive: true }, // New line for plug
                { label: 'Total Flujo de Efectivo de Financiación', key: 'financingCash', total: true, emphasize: true, duplicate: true },
                
                { label: 'Incremento Neto de Efectivo', key: 'netCash', total: true, separator: true, emphasize: true },
                { label: 'Saldo de Efectivo al Final del Periodo', key: 'cash', fromBS: true, total: true, emphasize: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                if (row.separator) tr.classList.add('border-t-2', 'border-gray-200'); // Separator for flow sections
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                // Cell for Year 0
                const cell0 = document.createElement('td');
                if (row.year0 !== undefined) {
                    cell0.textContent = formatCurrency(row.year0);
                    cell0.classList.add('positive', 'font-bold');
                } else if (row.key === 'netCash' && financialResults.cf.length > 0) { // Net cash year 0 should be total Series A + Venture Debt received
                     const initialTotalFunding = modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100));
                     cell0.textContent = formatCurrency(initialTotalFunding);
                     cell0.classList.add('positive', 'font-bold');
                } else if (row.key === 'cash' && financialResults.cf.length > 0) { // Cash balance year 0 should be total Series A + Venture Debt
                     const initialTotalFunding = modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100));
                     cell0.textContent = formatCurrency(initialTotalFunding);
                     cell0.classList.add('positive', 'font-bold');
                }
                else {
                    cell0.textContent = '-'; // No values for Year 0 in other rows
                }
                tr.appendChild(cell0);
                
                // Cells for Years 1-5
                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value;
                    if (row.fromPL) {
                        value = financialResults.pl[i][row.key] || 0;
                    } else if (row.fromBS) {
                        value = financialResults.bs[i][row.key] || 0;
                    } else if (row.key === 'principalPaymentVentureDebt') { 
                         value = financialResults.cf[i].principalPaymentVentureDebt || 0;
                    } else if (row.key === 'clientPrincipalPaymentsReceived') {
                        value = financialResults.cf[i].clientPrincipalPaymentsReceived || 0;
                    } else if (row.key === 'additionalFundingRaised') {
                        value = financialResults.cf[i].additionalFundingRaised || 0;
                    } else if (row.key === 'investingCash_capex') {
                        value = modelData.unitsPerYear[i] * modelData.vanCost; // Van CAPEX for this year
                    } else if (row.key === 'investingCash_loans') {
                        // totalPrincipalOriginatedThisYear is not stored annually in cf, calculate it
                        value = modelData.unitsPerYear[i] * modelData.vanPrice; // Loan origination for this year
                    }
                    else if (row.key === 'deltaReceivables') {
                        // Delta A/R is special because it's calculated year-over-year.
                        const prevReceivables = (i === 0) ? 0 : financialResults.bs[i-1].receivables;
                        const currentReceivables = financialResults.bs[i].receivables;
                        value = currentReceivables - prevReceivables;
                    } else if (row.fromModelData && row.yearSpecific) {
                        // Handle Series B and C funding
                        const currentYear = i + 1;
                        if (row.key === 'seriesB_funding' && currentYear === modelData.seriesB_year) {
                            value = modelData.seriesB_funding;
                        } else if (row.key === 'seriesC_funding' && currentYear === modelData.seriesC_year) {
                            value = modelData.seriesC_funding;
                        } else {
                            value = 0; // No funding in this year for this series
                        }
                    }
                     else {
                        value = financialResults.cf[i][row.key] || 0;
                    }
                    
                    // Format and color
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else if (row.positive && value > 0) {
                         cell.textContent = formatCurrency(value);
                         cell.classList.add('positive');
                    }
                    else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                }
                
                tbody.appendChild(tr);
            });
            log('  ✅  Cash Flow Statement table updated.');
        }
        
        // Updates the Balance Sheet (BS) table
        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody || !financialResults.bs.length) return;
            
            tbody.innerHTML = ''; // Clear table
            
            // Balance Sheet row definition
            const rows = [
                { label: 'ACTIVOS', total: true, emphasize: true },
                { label: '  Efectivo y Equivalentes', key: 'cash' },
                { label: '  Cuentas por Cobrar (Principal)', key: 'receivables' },
                { label: '  Activos Fijos Netos (Vagonetas)', key: 'fixedAssets' },
                { label: '  Activos Mantenidos para Venta (NIIF 5)', key: 'assetsHeldForSale' },
                { label: 'TOTAL ACTIVOS', key: 'totalAssets', total: true, emphasize: true },
                { label: 'PASIVOS Y PATRIMONIO', total: true, separator: true, emphasize: true },
                { label: '  Deuda Venture', key: 'debt' },
                { label: '  Provisiones NIIF 9 (Acumuladas)', key: 'provisions' },
                { label: '  Pasivos por Contrato (NIIF 15)', key: 'contractLiabilities' }, // New line for contract liabilities
                { label: 'TOTAL PASIVOS', key: 'totalLiabilities', total: true }, 
                { label: '  Patrimonio', key: 'equity' },
                { label: 'TOTAL PASIVOS + PATRIMONIO', key: 'totalLiabilitiesEquity', total: true, emphasize: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                if (row.separator) tr.classList.add('border-t-2', 'border-gray-200');
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.bs.forEach(yearData => {
                    const cell = document.createElement('td');
                    let value;
                    if (row.key === 'totalLiabilities') { // Specific calculation for Total Liabilities
                        value = yearData.debt + yearData.provisions + yearData.contractLiabilities;
                    } else {
                        value = yearData[row.key] || 0;
                    }
                    
                    // Format and color
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
            
            // Validate Balance (Assets = Liabilities + Equity)
            // Note: This basic balance validation is now part of the comprehensive validation system.
            // Keeping it here for quick reference but `updateValidationPanel` will show the detailed result.
            const validationDiv = document.getElementById('balance-validation');
            let balanceValid = true;
            let maxDifference = 0;
            
            financialResults.bs.forEach(yearData => {
                const difference = Math.abs(yearData.totalAssets - yearData.totalLiabilitiesEquity);
                maxDifference = Math.max(maxDifference, difference);
                if (difference > 1000) balanceValid = false; // Tolerance of $1,000 for validation
            });
            
            if (balanceValid) {
                validationDiv.innerHTML = '<span class="text-green-600">  ✅  Balance validated: Total Assets = Total Liabilities + Equity.</span>';
                validationDiv.classList.remove('bg-red-100', 'text-red-800');
                validationDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                validationDiv.innerHTML = `<span class="text-red-600">  ❌  Balance error: Difference of ${formatCurrency(maxDifference)}. Review calculations.</span>`;
                validationDiv.classList.remove('bg-green-100', 'text-green-800');
                validationDiv.classList.add('bg-red-100', 'text-red-800');
            }
            log('  ✅  Balance Sheet table updated and validated.');
        }
        
        // ===== IFRS DETAIL TABLES =====
        // Updates IFRS 15, IFRS 9, and IFRS 5 sections
        function updateNIIFTables() {
            log('Updating IFRS detail tables...');
            if (!financialResults.niifDetails || financialResults.niifDetails.length === 0) {
                log('  ❌  No IFRS data to display.');
                return;
            }
            
            // --- IFRS 15: Revenue Recognition ---
            const container15 = document.getElementById('niif15-container');
            if (container15) {
                container15.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Ingresos Operativos Totales (Contrato)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.totalOriginationContractValue + d.niif15.gnvCommissions + d.niif15.sparePartsRevenue + d.niif15.marketplaceRevenue + d.niif15.interestRevenue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Margen Originación (Contrato)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.totalOriginationContractValue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Margen Originación (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td class="positive">${formatCurrency(d.niif15.recognizedOriginationRevenue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Pasivos por Contrato (Acumulado)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.contractLiabilitiesBalance)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos GNV (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.gnvCommissions)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos Refacciones (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.sparePartsRevenue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos Marketplace (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.marketplaceRevenue)}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                        <h5 class="font-semibold text-base mb-1">Explicación NIIF 15 (Ingresos Ordinarios)</h5>
                        <p class="mb-1">• NIIF 15 establece un modelo de 5 pasos para reconocer ingresos que provienen de contratos con clientes. La clave es reconocer los ingresos cuando (o a medida que) se satisfacen las **obligaciones de desempeño**.</p>
                        <p class="mb-1">• Para Rodando a Gas, se identifican las siguientes obligaciones de desempeño:</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>**Margen por Originación (comisión inicial):** Se reconoce **a lo largo del tiempo** durante la vida del préstamo al cliente. El efectivo se recibe upfront, pero contablemente se difiere como un "Pasivo por Contrato" y se reconoce como ingreso gradualmente.</li>
                            <li>**Servicios GNV y Marketplace:** Se reconocen **a lo largo del tiempo** a medida que los servicios se proveen anualmente por las unidades activas en la cartera.</li>
                            <li>**Servicios de Refacciones:** Se reconoce **en un punto en el tiempo** (al momento de la entrega del servicio/producto de refación, asumido en el año de adición de la unidad).</li>
                        </ul>
                        <p class="mb-1">• Los ingresos por intereses se rigen por NIIF 9 (Instrumentos Financieros), no por NIIF 15.</p>
                        <p class="mb-1">• El Balance General ahora refleja los **Pasivos por Contrato** para los ingresos de originación que han sido cobrados pero aún no reconocidos.</p>
                    </div>
                `;
                log('  ✅  IFRS 15 updated.');
            }
            
            // --- IFRS 9: Credit Provisions ---
            const container9 = document.getElementById('niif9-container');
            if (container9) {
                const year5NIIF9 = financialResults.niifDetails[4]?.niif9; // Get Year 5 data for summary
                if (year5NIIF9) {
                    container9.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="p-4 bg-blue-100 rounded-lg text-center">
                                <h5 class="font-semibold text-blue-800">Exposición Etapa 1</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eadStage1)}</p>
                                <p class="text-sm">ECL 12 meses (PD: ${(year5NIIF9.pdStage1 * 100).toFixed(1)}%)</p>
                                <p class="text-lg font-bold text-blue-900">${formatCurrency(year5NIIF9.eclStage1Amount)}</p>
                            </div>
                            <div class="p-4 bg-yellow-100 rounded-lg text-center">
                                <h5 class="font-semibold text-yellow-800">Exposición Etapa 2</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eadStage2)}</p>
                                <p class="text-sm">ECL Lifetime (PD: ${(year5NIIF9.pdStage2 * 100).toFixed(1)}%)</p>
                                <p class="text-lg font-bold text-yellow-900">${formatCurrency(year5NIIF9.eclStage2Amount)}</p>
                            </div>
                            <div class="p-4 bg-red-100 rounded-lg text-center">
                                <h5 class="font-semibold text-red-800">Exposición Etapa 3</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eadStage3)}</p>
                                <p class="text-sm">ECL Lifetime (PD: ${(year5NIIF9.pdStage3 * 100).toFixed(1)}%)</p>
                                <p class="text-lg font-bold text-red-900">${formatCurrency(year5NIIF9.eclStage3Amount)}</p>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-indigo-50 rounded-lg mb-4">
                            <h5 class="font-semibold text-indigo-900">Total Provisiones ECL Antes de Ajustes</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.totalECLBeforeAdjustment)}</p>
                            <p class="text-sm">LGD: ${(year5NIIF9.lgd * 100).toFixed(1)}%. Ajuste Económico: ${year5NIIF9.economicAdjustmentFactor.toFixed(2)}x</p>
                        </div>
                        <div class="text-center p-4 ${year5NIIF9.proteccionRodandoActiva ? 'bg-green-50' : 'bg-gray-200'} rounded-lg">
                            <h5 class="font-semibold ${year5NIIF9.proteccionRodandoActiva ? 'text-green-900' : 'text-gray-900'}">Gasto por Provisiones NIIF 9 (P&L del Año 5)</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.provisionesConProteccion)}</p>
                            ${year5NIIF9.proteccionRodandoActiva ? 
                                `<p class="text-sm text-green-700">  ✅  Reducción: ${formatCurrency(year5NIIF9.reduccionPorProteccion)}</p>` : 
                                '<p class="text-sm text-gray-700">Protección Rodando inactiva</p>'}
                        </div>
                        <div class="mt-4 text-center p-4 bg-gray-300 rounded-lg">
                            <h5 class="font-semibold text-gray-900">Saldo Acumulado de Provisiones NIIF 9 (Balance Año 5)</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.saldoProvisionesAcumulado)}</p>
                            <p class="text-sm">Este es el pasivo acumulado que aparece en el Balance General.</p>
                        </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                            <h5 class="font-semibold text-base mb-1">Explicación NIIF 9 (Instrumentos Financieros)</h5>
                            <p class="mb-1">• NIIF 9 requiere el reconocimiento de provisiones por pérdidas crediticias esperadas (ECL) sobre los instrumentos financieros (cartera de préstamos).</p>
                            <p class="mb-1">• **Modelo de Tres Etapas:** La cartera se segmenta por riesgo.</p>
                            <ul class="list-disc list-inside ml-4">
                                <li>**Etapa 1:** Activos con bajo riesgo de crédito (ECL a 12 meses).</li>
                                <li>**Etapa 2:** Activos con un aumento significativo en el riesgo de crédito (ECL de por vida).</li>
                                <li>**Etapa 3:** Activos con deterioro de crédito (ECL de por vida).</li>
                            </ul>
                            <p class="mb-1">• **Cálculo de ECL:** ECL = Exposición a Incumplimiento (EAD) × Probabilidad de Incumplimiento (PD) × Pérdida Dado Incumplimiento (LGD).</p>
                            <p class="mb-1">• **Información Prospectiva:** El factor de ajuste económico permite incorporar expectativas futuras sobre el riesgo de crédito.</p>
                            <p class="mb-1">• "Protección Rodando" simula un mecanismo que reduce el gasto final por provisiones.</p>
                            <p class="mt-2 text-red-700 font-bold">Nota: En este modelo, la migración entre etapas se simula mediante una distribución porcentual fija de la cartera total para cada año, lo cual es una simplificación común para modelos agregados de alto nivel, en lugar de un seguimiento individual de cada préstamo.</p>
                        </div>
                    `;
                    log('  ✅  IFRS 9 updated.');
                } else {
                     log('  ⚠️  IFRS 9 data for Year 5 incomplete.');
                }
            }
            
            // --- IFRS 5: Assets Held for Sale ---
            const container5 = document.getElementById('niif5-container');
            if (container5) {
                const year5NIIF5 = financialResults.niifDetails[4]?.niif5; // Get Year 5 data for summary
                if (year5NIIF5) {
                    container5.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <h5 class="font-semibold text-purple-900">Unidades Reposadas (Año 5)</h5>
                                <p class="text-xl font-bold">${year5NIIF5.unidadesClasificadasAnuales.toFixed(0)}</p>
                                <p class="text-sm">Unidades clasificadas como mantenidas para venta este año.</p>
                            </div>
                            <div class="p-4 bg-indigo-50 rounded-lg">
                                <h5 class="font-semibold text-indigo-900">Valor en Libros (Activos Reposedos Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorEnLibrosClasificado)}</p>
                                <p class="text-sm">Costo histórico de las unidades clasificadas para venta en el Año 5.</p>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h5 class="font-semibold text-blue-900">Valor Razonable Neto (Año 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorRazonableMenosCostos)}</p>
                                <p class="text-sm">Valor de venta esperado menos costos.</p>
                            </div>
                            <div class="p-4 ${year5NIIF5.perdidaPorDeterioro > 0 ? 'bg-red-50' : 'bg-green-50'} rounded-lg">
                                <h5 class="font-semibold ${year5NIIF5.perdidaPorDeterioro > 0 ? 'text-red-900' : 'text-green-900'}">Pérdida por Deterioro (Año 5)</h5>
                                <p class="text-xl font-bold">${year5NIIF5.perdidaPorDeterioro > 0 ? formatCurrency(year5NIIF5.perdidaPorDeterioro) : 'Ninguna'}</p>
                                <p class="text-sm">Impacto en el Estado de Resultados.</p>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-gray-200 rounded-lg">
                             <h5 class="font-semibold text-gray-800">Saldo Acumulado de Activos NIIF 5 (Año 5)</h5>
                             <p class="text-2xl font-bold">${formatCurrency(year5NIIF5.saldoActivosParaVentaAcumulado)}</p>
                             <p class="text-sm">Este es el saldo que aparece en el Balance General.</p>
                         </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                            <h5 class="font-semibold text-base mb-1">Explicación NIIF 5 (Activos No Corrientes Mantenidos para la Venta)</h5>
                            <p class="mb-1">• Los activos no corrientes (vagonetas) que se esperan vender en un corto plazo se clasifican como "Mantenidos para la Venta".</p>
                            <p class="mb-1">• Estos activos se valoran al menor entre su valor en libros y su valor razonable menos los costos de venta. Se suspende su depreciación.</p>
                            <p class="mb-1">• Se reconoce una pérdida por deterioro si el valor en libros excede el valor razonable neto de venta. Las ganancias por reversión de deterioro están limitadas a la pérdida original.</p>
                        </div>
                    `;
                    log('  ✅  IFRS 5 updated.');
                } else {
                    log('  ⚠️  IFRS 5 data for Year 5 incomplete.');
                }
            }
        }
        
        // ===== CHARTS (Chart.js) =====
        // Initializes chart instances
        function initializeCharts() {
            try {
                // EBITDA Chart
                const ctxEbitda = document.getElementById('ebitdaChart');
                if (ctxEbitda) {
                    charts.ebitda = new Chart(ctxEbitda, {
                        type: 'line',
                        data: {
                            labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                            datasets: [{
                                label: 'EBITDA (M MXN)',
                                data: [],
                                borderColor: '#3b82f6', // blue-500
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.3 // Smooth line
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'Año Fiscal' } }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
                
                // Revenue Mix Chart
                const ctxRevenueMix = document.getElementById('revenueMixChart');
                if (ctxRevenueMix) {
                    charts.revenueMix = new Chart(ctxRevenueMix, {
                        type: 'doughnut',
                        data: {
                            labels: ['Intereses', 'Originación', 'GNV', 'Refacciones', 'Marketplace'],
                            datasets: [{
                                data: [],
                                backgroundColor: ['#34D399', '#FBBF24', '#60A5FA', '#8B5CF6', '#EC4899'] // Tailwind colors: green, amber, blue, violet, pink
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right' },
                                title: { display: true, text: 'Composición de Ingresos (Año 5)' }
                            }
                        }
                    });
                }
                // Balance Validation Chart
                const ctxBalanceValidation = document.getElementById('balanceValidationChart');
                if (ctxBalanceValidation) {
                    charts.balanceValidation = new Chart(ctxBalanceValidation, {
                        type: 'bar',
                        data: {
                            labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                            datasets: [
                                {
                                    label: 'Total Activos',
                                    data: [],
                                    backgroundColor: '#3b82f6', // blue-500
                                },
                                {
                                    label: 'Total Pasivos + Patrimonio',
                                    data: [],
                                    backgroundColor: '#ef4444', // red-500
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'Año Fiscal' } }
                            },
                            plugins: {
                                legend: { position: 'top' }
                            }
                        }
                    });
                }
                // Annual Net Cash Flow Chart
                const ctxNetCashFlow = document.getElementById('netCashFlowChart');
                if (ctxNetCashFlow) {
                    charts.netCashFlow = new Chart(ctxNetCashFlow, {
                        type: 'bar',
                        data: {
                            labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                            datasets: [{
                                label: 'Flujo Neto de Efectivo (M MXN)',
                                backgroundColor: (context) => {
                                    // Check if context.parsed and context.parsed.y exist
                                    if (context.parsed && typeof context.parsed.y === 'number') {
                                        const value = context.parsed.y;
                                        return value >= 0 ? '#10b981' : '#ef4444'; // green-500 for positive, red-500 for negative
                                    }
                                    return '#6b7280'; // Default color if data is not yet available or invalid
                                }
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'Año Fiscal' } }
                            },
                             plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
                log('  ✅  Charts initialized.');
            } catch (error) {
                log(`Error initializing charts: ${error.message}`);
                console.error('Error initializing charts:', error);
            }
        }
        
        // Updates chart data with current financial results
        function updateCharts() {
            try {
                if (!financialResults.pl.length) return;
                
                // Update EBITDA Chart
                if (charts.ebitda) {
                    const ebitdas = financialResults.pl.map(d => d.ebitda / 1000000); // In Millions for the chart
                    charts.ebitda.data.datasets[0].data = ebitdas;
                    charts.ebitda.update();
                }
                
                // Update Revenue Mix Chart (Year 5)
                if (charts.revenueMix && financialResults.pl[4]) { 
                    const year5 = financialResults.pl[4];
                    charts.revenueMix.data.datasets[0].data = [
                        year5.interestRevenue,
                        year5.originationCommission,
                        year5.gnvCommissions,
                        year5.sparePartsRevenue,
                        year5.marketplaceRevenue
                    ];
                    charts.revenueMix.update();
                }
                // Update Balance Validation Chart
                if (charts.balanceValidation) {
                    const totalAssetsData = financialResults.bs.map(d => d.totalAssets / 1000000);
                    const totalLiabilitiesEquityData = financialResults.bs.map(d => d.totalLiabilitiesEquity / 1000000);
                    charts.balanceValidation.data.datasets[0].data = totalAssetsData;
                    charts.balanceValidation.data.datasets[1].data = totalLiabilitiesEquityData;
                    charts.balanceValidation.update();
                }
                // Update Annual Net Cash Flow Chart
                if (charts.netCashFlow) {
                    const netCashFlows = financialResults.cf.map(d => d.netCash / 1000000);
                    charts.netCashFlow.data.datasets[0].data = netCashFlows;
                    charts.netCashFlow.update();
                }
                
                log('  ✅  Charts updated.');
            }
            catch (error) {
                log(`Error updating charts: ${error.message}`);
                console.error('Error updating charts:', error);
            }
        }
        
        // ===== HELPER FUNCTIONS =====
        // Formats a numeric value to currency format (millions, thousands, or no prefix)
        function formatCurrency(value, full = false) {
            if (value === null || value === undefined) return '$0 MXN';
            value = parseFloat(value);
            if (isNaN(value)) return '$0 MXN';
            if (full) { // Full format with commas
                return '$' + value.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' MXN';
            } else if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            } else if (Math.abs(value) >= 1000) {
                return '$' + (value / 1000).toFixed(1) + 'K MXN';
            }
            return '$' + Math.round(value).toLocaleString() + ' MXN';
        }
        
        // Forces a manual recalculation of the model
        function forceCalculate() {
            log('  🔄  Manual recalculation requested.');
            if (calculateFinancials()) {
                updateUI();
                log('  ✅  Manual recalculation completed.');
            } else {
                log('  ❌  Manual recalculation failed.');
            }
        }
        
        // ===== USER CONTROL SETUP =====
        // Generates and links "range" type inputs (sliders)
        function setupSliderControls() {
            const container = document.getElementById('credit-risk-controls');
            const operationsContainer = document.getElementById('operations-debt-controls');
            sliderConfigs.forEach(config => {
                const parentDiv = document.createElement('div');
                parentDiv.innerHTML = `
                    <label class="flex justify-between text-sm font-medium text-gray-700">
                        ${config.label} 
                        <span id="${config.id}-valor" class="font-bold text-indigo-600">${config.format(modelData[config.id])}</span>
                    </label>
                    <input type="range" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}" class="input-slider mt-1">
                `;
                
                if (['tasaInteres', 'tasaMorosidad'].includes(config.id)) {
                    container.appendChild(parentDiv);
                } else {
                    operationsContainer.appendChild(parentDiv);
                }
                const slider = parentDiv.querySelector(`#${config.id}-input`);
                const display = parentDiv.querySelector(`#${config.id}-valor`); // Corrected from parentVaria
                
                slider.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    modelData[config.id] = value;
                    display.textContent = config.format(value);
                    log(`${config.label} changed to: ${value}`);
                    // Recalculate and update UI on each slider change
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
            // Checkbox for Protección Rodando
            const checkbox = document.getElementById('check-proteccion');
            if (checkbox) {
                checkbox.checked = modelData.proteccionRodando; // Set initial state
                checkbox.addEventListener('change', function() {
                    modelData.proteccionRodando = this.checked;
                    log(`Protección Rodando: ${this.checked ? 'ACTIVATED' : 'DEACTIVATED'}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            }
            log('  ✅  Slider controls configured.');
        }
        
        // Generates and links number inputs (model constants and units per year)
        function setupNumberControls() {
            const unitsContainer = document.getElementById('units-container');
            const constantsContainer = document.getElementById('constants-container');
            
            // Inputs for Units per Year
            modelData.unitsPerYear.forEach((units, index) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label for="unit-year-${index+1}" class="text-sm font-medium text-gray-700 mb-1">Unidades Año ${index+1}</label>
                    <input type="number" id="unit-year-${index+1}" min="0" max="1000" value="${units}" 
                           class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                `;
                unitsContainer.appendChild(div);
                
                const input = document.getElementById(`unit-year-${index+1}`);
                input.addEventListener('change', function() {
                    const value = parseInt(this.value) || 0;
                    // Ensure value is within limits
                    modelData.unitsPerYear[index] = Math.max(0, Math.min(1000, value)); 
                    this.value = modelData.unitsPerYear[index]; // Update input if adjusted
                    
                    log(`Units Year ${index+1} changed to: ${modelData.unitsPerYear[index]}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
            
            // Inputs for Model Constants
            constantConfigs.forEach(config => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label for="${config.id}-input" class="text-sm font-medium text-gray-700 mb-1">${config.label}</label>
                    <input type="${config.type}" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}"
                           class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <span class="text-xs text-gray-500 mt-1" id="${config.id}-display">${config.format(modelData[config.id])}</span>
                `;
                constantsContainer.appendChild(div);
                
                const input = div.querySelector(`#${config.id}-input`); // Corrected from div.getElementById
                const display = div.querySelector(`#${config.id}-display`); // Corrected from div.getElementById
                
                input.addEventListener('input', function() {
                    let value = parseFloat(this.value);
                    if (isNaN(value)) value = 0; // Default to 0 if input is not a number
                    // Ensure value is within min/max, especially for percentages
                    if (config.type === 'number') {
                         if (value < config.min) value = config.min;
                         if (value > config.max) value = config.max;
                         this.value = value; // Update the input field
                    }
                    modelData[config.id] = value;
                    display.textContent = config.format(value);
                    log(`${config.label} changed to: ${value}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
            log('  ✅  Number controls (constants and units) configured.');
        }
        
        // Configures tab navigation
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // Remove 'active' class from all buttons and sections
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    button.classList.add('active');
                    contentSections[index].classList.add('active');
                    
                    // Force update of tables and charts when changing tabs
                    // This is useful if data loads slowly or a re-render is required
                    if (button.id === 'tab-financieros' || button.id === 'tab-niif' || button.id === 'tab-graficos' || button.id === 'tab-validacion') {
                        setTimeout(() => {
                            if (calculateFinancials()) { // Recalculate before updating UI
                                updateUI();
                            }
                        }, 50); // Small delay to ensure tab is visible
                    }
                });
            });
            log('  ✅  Tab navigation configured.');
        }
        
        // ===== COMPREHENSIVE VALIDATION FUNCTIONS =====
        // Object to store validation results
        // { errors: [], warnings: [], info: [], passed: [] }
        function validateModelComprehensively(modelData, financialResults) {
            const validations = {
                errors: [],      //  🔴  Critical - Require correction, model is unviable
                warnings: [],    //  🟡  Important - Indicate possible problems or unusual results
                info: [],        //  🔵  Informative - Suggestions or interesting data
                passed: []       //  ✅  Successful - Meet expectations
            };
            
            // Level 1: Basic Input Validation
            validateInputs(modelData, validations);
            
            // Only if financial results exist and are valid to continue
            if (financialResults.pl.length > 0 && financialResults.cf.length > 0 && financialResults.bs.length > 0) {
                // Level 2: Output Validation and Sanity Check
                validateOutputs(financialResults, validations);
                // Level 3: Consistency between Financial Statements
                validateConsistency(financialResults, validations);
                // Level 4: Temporal Evolution
                validateTemporal(financialResults, validations);
                // Level 5: Industry Benchmarks (if enough data for year 5)
                if (financialResults.pl.length === 5) {
                    validateIndustryBenchmarks(financialResults, validations);
                } else {
                    validations.info.push("No hay suficientes años de proyección para evaluar los benchmarks de industria.");
                }
            } else {
                validations.errors.push("No se pudieron calcular los resultados financieros. Por favor, revise los inputs iniciales.");
            }
            
            return validations;
        }
        
        // Level 1: Validate Basic Inputs
        function validateInputs(modelData, validations) {
            // Check basic non-negativity for key inputs
            if (modelData.seriesA <= 0) {
                validations.errors.push(" 🔴  Error: El Capital de Serie A debe ser mayor que 0. Ajuste 'Capital Serie A' en Control.");
            }
            if (modelData.vanCost <= 0) {
                validations.errors.push(" 🔴  Error: El Costo de Vagoneta debe ser mayor que 0. Ajuste 'Costo Vagoneta (RAG)' en Control.");
            }
            if (modelData.vanPrice <= 0) {
                validations.errors.push(" 🔴  Error: El Precio de Préstamo al Cliente debe ser mayor que 0. Ajuste 'Precio Préstamo Cliente' en Control.");
            }
            if (modelData.clientLoanTermYears <= 0) {
                validations.errors.push(" 🔴  Error: El Plazo del Préstamo al Cliente debe ser mayor que 0. Ajuste 'Plazo Préstamo Cliente' en Control.");
            }
            if (modelData.depreciationYears <= 0) {
                validations.errors.push(" 🔴  Error: Los Años de Depreciación deben ser mayor que 0. Ajuste 'Años Depreciación' en Control.");
            }
            if (modelData.periodoAmortizacionDeuda <= 0) {
                validations.errors.push(" 🔴  Error: El Plazo de Amortización de Deuda debe ser mayor que 0. Ajuste 'Plazo Amort. Deuda' en Control.");
            }
            
            // Check percentage inputs for reasonable range (0-100%, or 0-1 for decimals)
            const percentageInputs = [
                { id: 'tasaInteres', min: 0, max: 100, label: 'Tasa de Interés (Clientes)' }, 
                { id: 'tasaMorosidad', min: 0, max: 100, label: 'Tasa Morosidad (Antigua Lógica)' },
                { id: 'comisionGNV', min: 0, max: 100, label: 'Comisión GNV' }, 
                { id: 'margenRefacciones', min: 0, max: 100, label: 'Margen Refacciones' },
                { id: 'ventureDebtPct', min: 0, max: 100, label: '% Venture Debt' }, 
                { id: 'ventureDebtRate', min: 0, max: 100, label: 'Tasa Venture Debt' },
                { id: 'opexRate', min: 0, max: 100, label: 'Tasa OPEX (% Ingresos)' }, 
                { id: 'margenVagoneta', min: 0, max: 100, label: 'Margen Originación Vagoneta' },
                { id: 'marketplace', min: 0, max: 100, label: '% Comisión Marketplace' }, 
                { id: 'tasaReposicion', min: 0, max: 100, label: '% Unidades Reposición' },
                { id: 'fairValueVenta', min: 0, max: 100, label: '% Fair Value Venta' }, 
                { id: 'costosVenta', min: 0, max: 100, label: '% Costos Venta' },
                { id: 'corporateTaxRate', min: 0, max: 100, label: 'Tasa Impuesto Corporativo (%)' }
            ];
            percentageInputs.forEach(p => {
                if (modelData[p.id] < p.min || modelData[p.id] > p.max) {
                    validations.warnings.push(` 🟡  Advertencia: '${p.label}' (${modelData[p.id]}%) está fuera del rango típico (${p.min}-${p.max}%). Revise en Control.`);
                }
            });
            
            // Check PD and LGD (which are decimals) for reasonable range
            const decimalPercentageInputs = [
                { id: 'pdStage1', min: 0, max: 0.1, label: 'PD Etapa 1 (12M)' }, 
                { id: 'pdStage2', min: 0.01, max: 0.5, label: 'PD Etapa 2 (Lifetime)' },
                { id: 'pdStage3', min: 0.1, max: 0.9, label: 'PD Etapa 3 (Lifetime)' }, 
                { id: 'lgd', min: 0, max: 1, label: 'LGD (Recuperación %)' }
            ];
            decimalPercentageInputs.forEach(p => {
                if (modelData[p.id] < p.min || modelData[p.id] > p.max) {
                    validations.warnings.push(` 🟡  Advertencia: '${p.label}' (${(modelData[p.id]*100).toFixed(1)}%) está fuera del rango típico. Revise en Control.`);
                }
            });
            
            // Check portfolio allocation sums to 100%
            const totalAllocation = modelData.portfolioAllocationStage1 + modelData.portfolioAllocationStage2 + modelData.portfolioAllocationStage3;
            if (Math.abs(totalAllocation - 1.0) > 0.001) { // Allow for small floating point inaccuracies
                validations.errors.push(` 🔴  Error: La suma de la Asignación de Portafolio NIIF 9 (${(totalAllocation*100).toFixed(1)}%) no es igual a 100%. Por favor, ajuste en Control.`);
            } else {
                validations.passed.push(` ✅  Inputs: Asignación de Portafolio NIIF 9 suma 100%.`);
            }
            
            // Check that units per year are not negative
            modelData.unitsPerYear.forEach((units, index) => {
                if (units < 0) {
                    validations.errors.push(` 🔴  Error: Las Unidades para el Año ${index + 1} son negativas (${units}). Ajuste en Control.`);
                }
            });
            validations.passed.push(" ✅  Inputs: Parámetros básicos de entrada validados correctamente.");
        }
        
        // Level 2: Validate Outputs and Financial Sanity
        function validateOutputs(financialResults, validations) {
            const lastYear = financialResults.pl.length - 1; // Assuming 5 years, this will be 4
            if (lastYear < 0) return; // No data to validate
            
            // Check cash balance for all years
            financialResults.bs.forEach((bsYear, index) => {
                if (bsYear.cash < -100) { // Allow for very small negative cash, but alert for significant
                    validations.errors.push(` 🔴  Error: El Saldo de Efectivo al final del Año ${index + 1} es negativo (${formatCurrency(bsYear.cash)}). El modelo requiere más financiación. Ajuste las Series de Capital o las unidades.`);
                } else if (bsYear.cash < 0) { // Small negative cash is a warning
                    validations.warnings.push(` 🟡  Advertencia: El Saldo de Efectivo al final del Año ${index + 1} es ligeramente negativo (${formatCurrency(bsYear.cash)}). Considere ajustar la financiación.`);
                }
            });
            
            // Only add passed if no critical errors found for cash
            if (!validations.errors.some(e => e.includes("Efectivo negativo")) && !validations.warnings.some(e => e.includes("Efectivo ligeramente negativo"))) {
                 validations.passed.push(" ✅  Outputs: Saldo de efectivo es positivo en todos los años.");
            }
            
            const year5PL = financialResults.pl[lastYear];
            const year5BS = financialResults.bs[lastYear];
            
            // EBITDA Margin: -50% to +100% (as percentage of revenue)
            if (year5PL.totalRevenue !== 0) {
                const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
                if (ebitdaMargin < -50 || ebitdaMargin > 100) {
                    validations.warnings.push(` 🟡  Advertencia: Margen EBITDA del Año ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) es inusual. Revise supuestos. (Rango típico: -50% a +100%).`);
                } else {
                    validations.passed.push(` ✅  Outputs: Margen EBITDA del Año ${lastYear + 1} es realista (${ebitdaMargin.toFixed(1)}%).`);
                }
            } else {
                 validations.info.push(` 🔵  Info: Ingresos Totales del Año ${lastYear + 1} son cero, no se puede calcular Margen EBITDA.`);
            }
            
            // ROE: -100% to +200%
            if (financialResults.roe.length > lastYear && year5BS.equity !== 0) {
                const roe = financialResults.roe[lastYear];
                if (roe < -100 || roe > 200) {
                    validations.warnings.push(` 🟡  Advertencia: ROE del Año ${lastYear + 1} (${roe.toFixed(1)}%) es extremadamente alto/bajo. Revise supuestos. (Rango típico: -100% a +200%).`);
                } else {
                    validations.passed.push(` ✅  Outputs: ROE del Año ${lastYear + 1} es realista (${roe.toFixed(1)}%).`);
                }
            } else if (financialResults.roe.length > lastYear) { // If equity is zero
                validations.warnings.push(` 🟡  Advertencia: Patrimonio del Año ${lastYear + 1} es cero o negativo, no se puede calcular ROE significativo.`);
            }
            
            // A/R / Revenue: 0.1x to 5x
            if (year5PL.totalRevenue !== 0) {
                const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
                if (cxcToRevenueRatio < 0.1 || cxcToRevenueRatio > 5) {
                    validations.warnings.push(` 🟡  Advertencia: Ratio CxC/Ingresos del Año ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) es inusual. Revise supuestos. (Rango típico: 0.1x a 5x para financiamiento).`);
                } else {
                    validations.passed.push(` ✅  Outputs: Ratio CxC/Ingresos del Año ${lastYear + 1} es realista (${cxcToRevenueRatio.toFixed(1)}x).`);
                }
            } else {
                validations.info.push(` 🔵  Info: Ingresos Totales del Año ${lastYear + 1} son cero, no se puede calcular Ratio CxC/Ingresos.`);
            }
            
            // Debt/Equity: 0x to 20x
            if (year5BS.equity !== 0) {
                const debtToEquityRatio = year5BS.debt / year5BS.equity;
                if (debtToEquityRatio < 0 || debtToEquityRatio > 20) {
                    validations.warnings.push(` 🟡  Advertencia: Ratio Deuda/Patrimonio del Año ${lastYear + 1} (${debtToEquityRatio.toFixed(1)}x) es inusual. Revise supuestos. (Rango típico: 0x a 20x).`);
                } else {
                    validations.passed.push(` ✅  Outputs: Ratio Deuda/Patrimonio del Año ${lastYear + 1} es realista (${debtToEquityRatio.toFixed(1)}x).`);
                }
            } else { // If equity is zero
                 validations.info.push(` 🔵  Info: Patrimonio del Año ${lastYear + 1} es cero o negativo, no se puede calcular Ratio Deuda/Patrimonio significativo.`);
            }
        }
        
        // Level 3: Consistency between Financial Statements
        function validateConsistency(financialResults, validations) {
            const tolerance = 1000; // Tolerance for monetary differences ($1,000 MXN)
            const largeTolerance = 50000; // A larger tolerance for some calculated vs accumulated fields that might drift
            for (let i = 0; i < financialResults.pl.length; i++) {
                const pl = financialResults.pl[i];
                const cf = financialResults.cf[i];
                const bs = financialResults.bs[i];
                
                // For Year 1 (index 0), previous BS values are initial fundings
                const prevBsCash = (i === 0) ? (modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100))) : financialResults.bs[i-1].cash;
                const prevBsEquity = (i === 0) ? modelData.seriesA : financialResults.bs[i-1].equity;

                // Check Balance Sheet equation A = P + E
                const balanceDiff = Math.abs(bs.totalAssets - bs.totalLiabilitiesEquity);
                if (balanceDiff > tolerance) {
                    validations.errors.push(` 🔴  Error de Consistencia: Balance General del Año ${i + 1} no cuadra. Diferencia: ${formatCurrency(balanceDiff)}. Activos (${formatCurrency(bs.totalAssets)}) vs. Pasivos+Patrimonio (${formatCurrency(bs.totalLiabilitiesEquity)}).`);
                } else {
                    validations.passed.push(` ✅  Consistencia: Balance General del Año ${i + 1} cuadra.`);
                }
                
                // Net Cash Flow = Change in Cash
                const cashChangeCF = cf.netCash;
                const cashChangeBS = bs.cash - prevBsCash;
                if (Math.abs(cashChangeCF - cashChangeBS) > tolerance) {
                    validations.errors.push(` 🔴  Error de Consistencia: Flujo Neto del Año ${i + 1} (${formatCurrency(cashChangeCF)}) difiere del cambio en Efectivo del Balance (${formatCurrency(cashChangeBS)}).`);
                } else {
                    validations.passed.push(` ✅  Consistencia: Flujo Neto y cambio en Efectivo del Año ${i + 1} concuerdan.`);
                }
                
                // Depreciation P&L = Depreciation CF (as non-cash adjustment)
                // Note: The CF table currently uses the PL depreciation directly. This check ensures the source value is consistent.
                if (pl.depreciation !== undefined && financialResults.cf[i].depreciation !== undefined) { // Check if keys exist in both
                    if (Math.abs(pl.depreciation - financialResults.cf[i].depreciation) > tolerance) { // Assuming CF contains depreciation from PL for simplicity here
                        validations.warnings.push(` 🟡  Advertencia de Consistencia: Depreciación en P&L (${formatCurrency(pl.depreciation)}) no coincide con el ajuste en Flujo de Efectivo (${formatCurrency(financialResults.cf[i].depreciation)}) para el Año ${i + 1}.`);
                    } else {
                        validations.passed.push(` ✅  Consistencia: Depreciación en P&L y Flujo de Efectivo del Año ${i + 1} concuerdan.`);
                    }
                }

                // Net Income = Delta Retained Earnings (considering new capital and dividends if any)
                const deltaEquity = bs.equity - prevBsEquity;
                // Sum net income, plus additional funding from liquidity plug, plus Series B and C for the corresponding year
                const netIncomePlusNewEquity = pl.netIncome + (financialResults.cf[i].additionalFundingRaised || 0) + 
                                               (i + 1 === modelData.seriesB_year ? modelData.seriesB_funding : 0) + 
                                               (i + 1 === modelData.seriesC_year ? modelData.seriesC_funding : 0);
                
                // Use a larger tolerance for this check due to potential compounding of floating point errors over years and multiple complex calculations
                if (Math.abs(deltaEquity - netIncomePlusNewEquity) > largeTolerance) {
                    validations.warnings.push(` 🟡  Advertencia de Consistencia: Cambio en Patrimonio del Año ${i + 1} (${formatCurrency(deltaEquity)}) no coincide con Utilidad Neta + Nuevos Aportes de Capital (${formatCurrency(netIncomePlusNewEquity)}). Esto puede ser debido a redondeos acumulados.`);
                } else {
                    validations.passed.push(` ✅  Consistencia: Utilidad Neta y cambios en Patrimonio del Año ${i + 1} concuerdan.`);
                }
            }
        }
        
        // Level 4: Temporal Evolution
        function validateTemporal(financialResults, validations) {
            for (let i = 1; i < financialResults.pl.length; i++) { // Start from Year 2 to compare with Year 1
                const prevPl = financialResults.pl[i-1];
                const currentPl = financialResults.pl[i];
                const prevBs = financialResults.bs[i-1];
                const currentBs = financialResults.bs[i];
                
                // Revenue growth <1000% annually
                if (prevPl.totalRevenue !== 0) {
                    const revenueGrowth = (currentPl.totalRevenue / prevPl.totalRevenue - 1) * 100;
                    if (revenueGrowth > 1000) { // If revenue grows more than 1000% (10x) in a year
                        validations.warnings.push(` 🟡  Advertencia Temporal: Crecimiento de Ingresos del Año ${i + 1} (${revenueGrowth.toFixed(1)}%) es extremadamente alto. Revise las unidades o supuestos de precio.`);
                    }
                } else if (currentPl.totalRevenue > 0) { // If prev year revenue was 0 but current is positive, it's a new ramp-up, not an "explosive" growth anomaly
                     validations.info.push(` 🔵  Info Temporal: Ingresos de Año ${i + 1} inician ramp-up desde cero/bajo. Crecimiento porcentual no significativo.`);
                }
                
                // Ratios do not change >500% between years (e.g., EBITDA Margin)
                if (prevPl.totalRevenue !== 0 && currentPl.totalRevenue !== 0) {
                    const prevEbitdaMargin = (prevPl.ebitda / prevPl.totalRevenue) * 100;
                    const currentEbitdaMargin = (currentPl.ebitda / currentPl.totalRevenue) * 100;
                    if (Math.abs(currentEbitdaMargin - prevEbitdaMargin) > 500) { // If margin changes by more than 500 percentage points
                        validations.warnings.push(` 🟡  Advertencia Temporal: Margen EBITDA cambia drásticamente (${prevEbitdaMargin.toFixed(1)}% a ${currentEbitdaMargin.toFixed(1)}%) del Año ${i} al Año ${i + 1}. Revise las dinámicas de costos/ingresos.`);
                    }
                }
            }
            validations.passed.push(" ✅  Evolución Temporal: Tendencias de crecimiento y ratios anuales parecen razonables.");
        }
        
        // Level 5: Industry Benchmarks
        function validateIndustryBenchmarks(financialResults, validations) {
            const lastYear = financialResults.pl.length - 1;
            if (lastYear < 4) return; // Need at least 5 years of data for year 5 benchmarks
            
            const year5PL = financialResults.pl[lastYear];
            const year5BS = financialResults.bs[lastYear];
            const year5ROE = financialResults.roe[lastYear];
            const year5ROIC = financialResults.roic[lastYear];
            
            // Fintech EBITDA Margin: 10-40%
            if (year5PL.totalRevenue !== 0) {
                const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
                if (ebitdaMargin < 10 || ebitdaMargin > 40) {
                    validations.info.push(` 🔵  Info: Margen EBITDA del Año ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) está fuera del benchmark típico de fintech (10-40%).`);
                } else {
                    validations.passed.push(` ✅  Benchmarks: Margen EBITDA del Año ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) está en línea con el benchmark.`);
                }
            }
            
            // Financial Services ROE: 15-35%
            if (year5BS.equity !== 0) {
                if (year5ROE < 15 || year5ROE > 35) {
                    validations.info.push(` 🔵  Info: ROE del Año ${lastYear + 1} (${year5ROE.toFixed(1)}%) está fuera del benchmark típico de servicios financieros (15-35%).`);
                } else {
                    validations.passed.push(` ✅  Benchmarks: ROE del Año ${lastYear + 1} (${year5ROE.toFixed(1)}%) está en línea con el benchmark.`);
                }
            } else {
                 validations.info.push(` 🔵  Info: Patrimonio del Año ${lastYear + 1} es cero o negativo, no se puede comparar ROE con benchmark.`);
            }
            
            // A/R / Revenue financing: 0.5-3x
            if (year5PL.totalRevenue !== 0) {
                const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
                if (cxcToRevenueRatio < 0.5 || cxcToRevenueRatio > 3) {
                    validations.info.push(` 🔵  Info: Ratio CxC/Ingresos del Año ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) está fuera del benchmark típico de financiamiento (0.5-3x).`);
                } else {
                    validations.passed.push(` ✅  Benchmarks: Ratio CxC/Ingresos del Año ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) está en línea con el benchmark.`);
                }
            } else {
                validations.info.push(` 🔵  Info: Ingresos Totales del Año ${lastYear + 1} son cero, no se puede comparar Ratio CxC/Ingresos con benchmark.`);
            }
        }
        
        // Function to update the validation panel in the UI
        function updateValidationPanel(validations) {
            const container = document.getElementById('validation-results-container');
            if (!container) return;
            container.innerHTML = ''; // Clear previous results
            
            // Display messages by type, ensuring errors/warnings are prominent
            const types = ['error', 'warning', 'info', 'passed'];
            types.forEach(type => {
                // Defensive check: ensure validations[type] is an array
                if (Array.isArray(validations[type])) {
                    validations[type].forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `validation-item ${type}`;
                        let icon = '';
                        if (type === 'error') icon = ' ❌ ';
                        else if (type === 'warning') icon = ' 🟡 '; 
                        else if (type === 'info') icon = ' 🔵 ';
                        else if (type === 'passed') icon = ' ✅ ';
                        div.innerHTML = `<span class="validation-icon">${icon}</span><div class="validation-message">${msg}</div>`;
                        container.appendChild(div);
                    });
                } else {
                    console.warn(`Validation type '${type}' is not an array:`, validations[type]);
                }
            });
            
            // Add a summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'validation-summary mt-4 p-2 rounded-lg';
            if (validations.errors.length > 0) {
                summaryDiv.classList.add('bg-red-200', 'text-red-800');
                summaryDiv.textContent = ` 🚨  ${validations.errors.length} ERRORES CRÍTICOS encontrados. Por favor, revise y ajuste los inputs/lógica.`;
            } else if (validations.warnings.length > 0) {
                summaryDiv.classList.add('bg-yellow-200', 'text-yellow-800');
                summaryDiv.textContent = ` ⚠️  ${validations.warnings.length} ADVERTENCIAS encontradas. Revise los resultados con precaución.`;
            } else {
                summaryDiv.classList.add('bg-green-200', 'text-green-800');
                summaryDiv.textContent = ` ✨  Todas las validaciones críticas superadas. ${validations.info.length} notas informativas.`;
            }
            container.appendChild(summaryDiv);
        }
        
        // ===== APPLICATION INITIALIZATION =====
        // Executes when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            log('  🚀  INITIATING FINANCIAL MODEL APPLICATION');
            
            try {
                // Set up all interactive elements and UI
                setupTabs();
                setupSliderControls(); // Configure sliders
                setupNumberControls(); // Configure number inputs (constants and units)
                
                // Perform initial model calculation and update UI
                if (calculateFinancials()) {
                    updateUI();
                    log('  ✅  Initialization successful: Calculations and UI updated.');
                } else {
                    log('  ❌  Error during initialization: Initial calculations failed.');
                }
                
                // Initialize and update charts after a brief delay
                // This ensures the canvas is ready in the DOM
                setTimeout(() => {
                    initializeCharts();
                    updateCharts();
                }, 500); // 500ms delay
                
                log('  🎉  APPLICATION READY AND RUNNING');
                
            } catch (error) {
                log(`  ❌  CRITICAL ERROR DURING INITIALIZATION: ${error.message}`);
                console.error('Critical error in initialization:', error);
            }
        });
    </script>
</body>
</html>
