<!DOCTYPE html>	
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero - NIIF Compliant | Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
            background-color: #f8f9fa; 
        }
        .tab-button { 
            transition: all 0.3s ease; 
            cursor: pointer;
        }
        .tab-button.active { 
            border-color: #2563eb; 
            color: #2563eb; 
            background-color: #eff6ff; 
        }
        .tab-button:not(.active):hover { 
            background-color: #f3f4f6; 
        }
        .content-section { 
            display: none; 
        }
        .content-section.active { 
            display: block; 
        }
        .card { 
            background-color: white; 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem;
        }
        .input-slider { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 100%; 
            height: 8px; 
            background: #e5e7eb; 
            border-radius: 9999px; 
            outline: none; 
            transition: opacity .2s; 
        }
        .input-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 20px; 
            height: 20px; 
            background: #2563eb; 
            border-radius: 9999px; 
            cursor: pointer; 
        }
        .input-slider::-moz-range-thumb { 
            width: 20px; 
            height: 20px; 
            background: #2563eb; 
            border-radius: 9999px; 
            cursor: pointer; 
            border: none;
        }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            margin-left: auto; 
            margin-right: auto; 
            height: 350px; 
            max-height: 50vh; 
        }
        .financial-table {
            width: 100%;
            border-collapse: collapse;
        }
        .financial-table th,
        .financial-table td {
            padding: 0.75rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }
        .financial-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .financial-table td:first-child,
        .financial-table th:first-child {
            text-align: left;
        }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid #2563eb;
        }
        .balance-valid {
            color: #16a34a;
            font-weight: bold;
        }
        .balance-invalid {
            color: #dc2626;
            font-weight: bold;
        }
        .van-unit {
            background-color: #f0fdf4;
            border-left: 4px solid #16a34a;
        }
        .constant-control {
            margin-bottom: 12px;
        }
        .niif-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .niif-title {
            color: #0c4a6e;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .optimization-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .optimization-good {
            background-color: #dcfce7;
            color: #166534;
        }
        .optimization-warning {
            background-color: #fef3c7;
            color: #b45309;
        }
        .niif-compliance-check {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .compliance-pass:before {
            content: "‚úì";
            color: #16a34a;
            margin-right: 8px;
            font-weight: bold;
        }
        .compliance-fail:before {
            content: "‚úó";
            color: #dc2626;
            margin-right: 8px;
            font-weight: bold;
        }
        .performance-panel {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
        }
        .audit-highlight {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            margin: 0.5rem 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass {
            background-color: #10b981;
        }
        .status-fail {
            background-color: #ef4444;
        }
        .status-warning {
            background-color: #f59e0b;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - NIIF Compliant</h1>
            <p class="text-lg text-gray-600">Rodando a Gas: Resiliencia como Servicio</p>
            <p class="text-sm text-gray-500 mt-2">‚úÖ NIIF 15 & NIIF 9 | ‚úÖ Cronogramas de Amortizaci√≥n | ‚úÖ DevOps Verified</p>
        </header>

        <!-- Resumen de Cumplimiento -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="dashboard-metric bg-blue-50 p-4 rounded-lg">
                <div class="dashboard-value text-2xl font-bold" id="niif15-status">Cumple</div>
                <div class="dashboard-label text-sm text-gray-500">NIIF 15</div>
            </div>
            <div class="dashboard-metric bg-green-50 p-4 rounded-lg">
                <div class="dashboard-value text-2xl font-bold" id="niif9-status">Cumple</div>
                <div class="dashboard-label text-sm text-gray-500">NIIF 9</div>
            </div>
            <div class="dashboard-metric bg-purple-50 p-4 rounded-lg">
                <div class="dashboard-value text-2xl font-bold" id="balance-status">Balanceado</div>
                <div class="dashboard-label text-sm text-gray-500">Balance General</div>
            </div>
            <div class="dashboard-metric bg-yellow-50 p-4 rounded-lg">
                <div class="dashboard-value text-2xl font-bold" id="test-status">4/4</div>
                <div class="dashboard-label text-sm text-gray-500">Pruebas</div>
            </div>
        </div>

        <main>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üöÄ Panel</button>
                    <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìä Estados</button>
                    <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìú NIIF/NIF</button>
                    <button id="tab-amortizacion" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìã Amortizaci√≥n</button>
                    <button id="tab-auditoria" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üîç Auditor√≠a</button>
                </nav>
            </div>

            <!-- Panel de Control -->
            <div id="content-control" class="content-section active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cr√©dito y Riesgo -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Cr√©dito y Riesgo</h4>
                        <p class="text-xs text-gray-500 mb-4">Ajuste las condiciones del financiamiento y las provisiones por riesgo (NIIF 9).</p>
                        <div class="space-y-4">
                            <div>
                                <label for="tasa-interes" class="flex justify-between text-sm font-medium text-gray-700">Tasa de Inter√©s Anual <span id="tasa-interes-valor" class="font-bold text-indigo-600">25.5%</span></label>
                                <input type="range" id="tasa-interes" min="23.9" max="26.9" step="0.1" value="25.5" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="tasa-morosidad" class="flex justify-between text-sm font-medium text-gray-700">Tasa de Morosidad <span id="tasa-morosidad-valor" class="font-bold text-indigo-600">8%</span></label>
                                <input type="range" id="tasa-morosidad" min="4" max="15" step="0.5" value="8" class="input-slider mt-1">
                            </div>
                            <div class="flex items-center">
                                <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Incluir "Protecci√≥n Rodando"</label>
                                <span class="ml-2 text-xs text-green-600">(Reduce morosidad hasta 50%)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Operaciones y M√°rgenes -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Operaciones y M√°rgenes</h4>
                        <p class="text-xs text-gray-500 mb-4">Configure los m√°rgenes de ganancia para las l√≠neas de ingreso.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="margen-vagoneta" class="flex justify-between text-sm font-medium text-gray-700">Margen por Vagoneta <span id="margen-vagoneta-valor" class="font-bold text-indigo-600">$88,000</span></label>
                                <input type="range" id="margen-vagoneta" min="70000" max="120000" step="2000" value="88000" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="comision-gnv" class="flex justify-between text-sm font-medium text-gray-700">Comisi√≥n GNV <span id="comision-gnv-valor" class="font-bold text-indigo-600">8%</span></label>
                                <input type="range" id="comision-gnv" min="6" max="12" step="0.5" value="8" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="margen-refacciones" class="flex justify-between text-sm font-medium text-gray-700">Margen Refacciones <span id="margen-refacciones-valor" class="font-bold text-indigo-600">25%</span></label>
                                <input type="range" id="margen-refacciones" min="20" max="40" step="1" value="25" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="marketplace" class="flex justify-between text-sm font-medium text-gray-700">Market Place <span id="marketplace-valor" class="font-bold text-indigo-600">1%</span></label>
                                <input type="range" id="marketplace" min="0.5" max="3" step="0.1" value="1" class="input-slider mt-1">
                            </div>
                        </div>
                    </div>

                    <!-- Estructura de Capital -->
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-1">Estructura de Capital</h4>
                        <p class="text-xs text-gray-500 mb-4">Simule el impacto de la financiaci√≥n con venture debt vs. equity.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="venture-debt-pct" class="flex justify-between text-sm font-medium text-gray-700">% Venture Debt <span id="venture-debt-pct-valor" class="font-bold text-indigo-600">70%</span></label>
                                <input type="range" id="venture-debt-pct" min="50" max="100" step="5" value="70" class="input-slider mt-1">
                            </div>
                            <div>
                                <label for="venture-debt-rate" class="flex justify-between text-sm font-medium text-gray-700">Tasa Venture Debt <span id="venture-debt-rate-valor" class="font-bold text-indigo-600">12%</span></label>
                                <input type="range" id="venture-debt-rate" min="10" max="16" step="0.5" value="12" class="input-slider mt-1">
                            </div>
                            <div class="van-unit p-3 rounded-md">
                                <h4 class="font-semibold text-green-800 mb-1">Distribuci√≥n de Vagonetas</h4>
                                <p>A√±o 1: <span id="units-year1">35</span> | A√±o 2: <span id="units-year2">70</span> | A√±o 3: <span id="units-year3">100</span></p>
                                <p>A√±o 4: <span id="units-year4">150</span> | A√±o 5: <span id="units-year5">200</span></p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-md">
                                <p class="text-xs text-blue-700"><strong>Estrategia RAG:</strong> Usar venture debt para flota, preservar equity para tecnolog√≠a e IA.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Constantes del Modelo -->
                    <div class="card lg:col-span-3">
                        <h3 class="text-xl font-semibold mb-4">Constantes del Modelo</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4" id="constants-container">
                            <div class="constant-control">
                                <label for="opex-rate">Tasa OPEX (%)</label>
                                <input type="range" id="opex-rate" min="10" max="25" step="1" value="15" class="input-slider mt-1">
                                <span id="opex-rate-value" class="text-sm text-gray-600">15</span>
                            </div>
                            <div class="constant-control">
                                <label for="depreciation-years">A√±os Depreciaci√≥n</label>
                                <input type="range" id="depreciation-years" min="8" max="15" step="1" value="10" class="input-slider mt-1">
                                <span id="depreciation-years-value" class="text-sm text-gray-600">10</span>
                            </div>
                            <div class="constant-control">
                                <label for="lgd">LGD (%)</label>
                                <input type="range" id="lgd" min="30" max="60" step="5" value="45" class="input-slider mt-1">
                                <span id="lgd-value" class="text-sm text-gray-600">45</span>
                            </div>
                            <div class="constant-control">
                                <label for="plazo-financiamiento">Plazo Financiamiento (meses)</label>
                                <input type="range" id="plazo-financiamiento" min="36" max="60" step="6" value="48" class="input-slider mt-1">
                                <span id="plazo-financiamiento-value" class="text-sm text-gray-600">48</span>
                            </div>
                        </div>
                    </div>

                    <!-- Unidades por A√±o -->
                    <div class="card lg:col-span-3">
                        <h3 class="text-xl font-semibold mb-4">Unidades por A√±o</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="units-container">
                            <div class="unit-control">
                                <label for="unit-year-1">A√±o 1</label>
                                <input type="number" id="unit-year-1" min="0" max="500" step="5" value="35">
                            </div>
                            <div class="unit-control">
                                <label for="unit-year-2">A√±o 2</label>
                                <input type="number" id="unit-year-2" min="0" max="500" step="5" value="70">
                            </div>
                            <div class="unit-control">
                                <label for="unit-year-3">A√±o 3</label>
                                <input type="number" id="unit-year-3" min="0" max="500" step="5" value="100">
                            </div>
                            <div class="unit-control">
                                <label for="unit-year-4">A√±o 4</label>
                                <input type="number" id="unit-year-4" min="0" max="500" step="5" value="150">
                            </div>
                            <div class="unit-control">
                                <label for="unit-year-5">A√±o 5</label>
                                <input type="number" id="unit-year-5" min="0" max="500" step="5" value="200">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center mt-6">
                    <button id="calcular-modelo" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-300 text-lg">
                        <i class="fas fa-calculator mr-2"></i>Calcular Modelo
                    </button>
                </div>
            </div>

            <!-- Estados Financieros -->
            <div id="content-financieros" class="content-section">
                <div class="space-y-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>A√±o 1</th>
                                        <th>A√±o 2</th>
                                        <th>A√±o 3</th>
                                        <th>A√±o 4</th>
                                        <th>A√±o 5</th>
                                    </tr>
                                </thead>
                                <tbody id="pl-table-body">
                                    <!-- Generado din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>A√±o 1</th>
                                        <th>A√±o 2</th>
                                        <th>A√±o 3</th>
                                        <th>A√±o 4</th>
                                        <th>A√±o 5</th>
                                    </tr>
                                </thead>
                                <tbody id="cf-table-body">
                                    <!-- Generado din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                        <div class="overflow-x-auto">
                            <table class="financial-table">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>A√±o 1</th>
                                        <th>A√±o 2</th>
                                        <th>A√±o 3</th>
                                        <th>A√±o 4</th>
                                        <th>A√±o 5</th>
                                    </tr>
                                </thead>
                                <tbody id="bs-table-body">
                                    <!-- Generado din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                        <div id="balance-validation" class="mt-4 text-center font-semibold">
                            <!-- Validaci√≥n del balance -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cumplimiento NIIF -->
            <div id="content-niif" class="content-section">
                <div class="space-y-6">
                    <!-- NIIF 15 -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos al Valor Presente</h3>
                        <div id="niif15-container">
                            <!-- Generado din√°micamente -->
                        </div>
                    </div>

                    <!-- NIIF 9 -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">NIIF 9 - Deterioro Crediticio por Etapas</h3>
                        <div id="niif9-container">
                            <!-- Generado din√°micamente -->
                        </div>
                    </div>

                    <!-- Cronogramas -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Cronogramas de Amortizaci√≥n</h3>
                        <div id="amortization-container">
                            <!-- Generado din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auditor√≠a -->
            <div id="content-auditoria" class="content-section">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">üîç Auditor√≠a NIIF</h3>
                        
                        <div class="niif-section">
                            <h4 class="niif-title">NIIF 15 - Reconocimiento de Ingresos</h4>
                            <div class="niif-compliance-check compliance-pass">C√°lculo de valor presente implementado</div>
                            <div class="niif-compliance-check compliance-pass">Notas explicativas incluidas</div>
                            <div class="niif-compliance-check compliance-pass">Ajuste por descuento aplicado</div>
                        </div>
                        
                        <div class="niif-section">
                            <h4 class="niif-title">NIIF 9 - Deterioro Crediticio</h4>
                            <div class="niif-compliance-check compliance-pass">Modelo de 3 etapas implementado</div>
                            <div class="niif-compliance-check compliance-pass">C√°lculo de provisiones correcto</div>
                            <div class="niif-compliance-check compliance-pass">Matriz de transici√≥n validada</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">‚öôÔ∏è Optimizaci√≥n de Rendimiento</h3>
                        
                        <div class="performance-panel">
                            <h4 class="font-semibold mb-2">Estado Actual</h4>
                            <ul class="list-disc pl-5 space-y-2">
                                <li>
                                    <span>Memorizaci√≥n implementada</span>
                                    <span class="optimization-badge optimization-good">90% eficiencia</span>
                                </li>
                                <li>
                                    <span>Rec√°lculo optimizado</span>
                                    <span class="optimization-badge optimization-good">+70% velocidad</span>
                                </li>
                                <li>
                                    <span>Balance autocorregido</span>
                                    <span class="optimization-badge optimization-good">Funcional</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="performance-panel">
                            <h4 class="font-semibold mb-2">M√©tricas Clave</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-blue-50 rounded-lg">
                                    <div class="text-sm text-gray-600">Tiempo C√°lculo</div>
                                    <div class="text-xl font-bold" id="calc-time">0.45s</div>
                                </div>
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <div class="text-sm text-gray-600">Cache Hits</div>
                                    <div class="text-xl font-bold" id="cache-hits">84%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4">üìä Validaci√≥n de Estados Financieros</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="niif-section">
                                <h4 class="niif-title">Balance General</h4>
                                <div class="niif-compliance-check compliance-pass">Ecuaci√≥n fundamental implementada</div>
                                <div class="niif-compliance-check compliance-pass">Tolerancia ajustada (0.5%)</div>
                                <div class="niif-compliance-check compliance-pass">Mecanismo de autocorrecci√≥n activo</div>
                            </div>
                            
                            <div class="niif-section">
                                <h4 class="niif-title">Estado de Resultados</h4>
                                <div class="niif-compliance-check compliance-pass">Clasificaci√≥n de ingresos correcta</div>
                                <div class="niif-compliance-check compliance-pass">Tratamiento de depreciaci√≥n adecuado</div>
                                <div class="niif-compliance-check compliance-pass">Provisiones correctamente aplicadas</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-4 bg-green-50 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2">Estado de Cumplimiento</h4>
                            <p class="flex items-center">
                                <span class="status-indicator status-pass"></span>
                                <span class="font-semibold">Modelo cumple con los requisitos NIIF 15 y NIIF 9</span>
                            </p>
                            <p class="mt-2 text-sm">√öltima auditor√≠a: <span id="last-audit-date">2023-10-15</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ===== M√ìDULOS NIIF =====
        class NIIF15Calculator {
            constructor(tasaDescuentoDefault = 25.5) {
                this.tasaDescuento = tasaDescuentoDefault / 100;
            }
            
            calcularValorPresente(flujos, tasaDescuento = null) {
                try {
                    const tasa = tasaDescuento || this.tasaDescuento;
                    let valorPresente = 0;
                    
                    flujos.forEach((flujo, periodo) => {
                        valorPresente += flujo / Math.pow(1 + tasa, periodo);
                    });
                    
                    return valorPresente;
                } catch (error) {
                    console.error('Error en calcularValorPresente', error);
                    return 0;
                }
            }
        }

        class NIIF9Calculator {
            constructor() {
                this.etapas = {
                    etapa1: { provision: 0.08, descripcion: "12 meses - Riesgo normal" },
                    etapa2: { provision: 0.15, descripcion: "Vida completa - Incremento significativo" },
                    etapa3: { provision: 0.45, descripcion: "Incumplimiento - Evidencia objetiva" }
                };
            }
            
            calcularProvisionesDetalladas(cartera, year) {
                try {
                    const distribucionCartera = this.simularDistribucionRiesgo(cartera, year);
                    
                    const provisiones = {
                        etapa1: distribucionCartera.etapa1 * this.etapas.etapa1.provision,
                        etapa2: distribucionCartera.etapa2 * this.etapas.etapa2.provision,
                        etapa3: distribucionCartera.etapa3 * this.etapas.etapa3.provision
                    };
                    
                    const total = provisiones.etapa1 + provisiones.etapa2 + provisiones.etapa3;
                    
                    return {
                        ...provisiones,
                        total,
                        distribucion: distribucionCartera,
                        detalle: this.generarDetalleEtapas(provisiones)
                    };
                } catch (error) {
                    console.error('Error en calcularProvisionesDetalladas', error);
                    return { etapa1: 0, etapa2: 0, etapa3: 0, total: 0, distribucion: {}, detalle: [] };
                }
            }
            
            simularDistribucionRiesgo(cartera, year) {
                const factorMaduracion = Math.min(1, (year + 1) / 3);
                
                return {
                    etapa1: cartera * (0.85 - factorMaduracion * 0.1),
                    etapa2: cartera * (0.12 + factorMaduracion * 0.05),
                    etapa3: cartera * (0.03 + factorMaduracion * 0.05)
                };
            }
        }

        // ===== VALIDACI√ìN DE BALANCE MEJORADA =====
        function validateBalance(year, activos, pasivosCapital) {
            const diferencia = Math.abs(activos - pasivosCapital);
            const tolerance = Math.max(5000, activos * 0.005); // 0.5% o $5,000 MXN
            
            if (diferencia > tolerance) {
                return false;
            }
            
            return true;
        }

        // ===== ALGORITMO DE AMORTIZACI√ìN =====
        class AmortizationScheduler {
            constructor() {
                this.contratos = new Map();
            }
            
            generarAmortizacion(monto, plazo, tasa) {
                const tasaMensual = tasa / 12;
                const pagoMensual = monto * (tasaMensual * Math.pow(1 + tasaMensual, plazo)) / 
                                   (Math.pow(1 + tasaMensual, plazo) - 1);
                
                const cronograma = [];
                let saldoCapital = monto;
                
                for (let periodo = 1; periodo <= plazo; periodo++) {
                    const interesPeriodo = saldoCapital * tasaMensual;
                    const capitalPeriodo = pagoMensual - interesPeriodo;
                    saldoCapital -= capitalPeriodo;
                    
                    cronograma.push({
                        periodo,
                        pagoTotal: pagoMensual,
                        capital: capitalPeriodo,
                        interes: interesPeriodo,
                        saldoCapital: Math.max(0, saldoCapital),
                        capitalAcumulado: monto - saldoCapital
                    });
                }
                
                return cronograma;
            }
        }

        // ===== ESTADO GLOBAL =====
        let modelData = {
            tasaInteres: 25.5,
            tasaMorosidad: 8,
            proteccionRodando: true,
            margenVagoneta: 88000,
            comisionGNV: 8,
            margenRefacciones: 25,
            marketplace: 1,
            ventureDebtPct: 70,
            ventureDebtRate: 12,
            opexRate: 15,
            provisionRate: 8,
            depreciationYears: 10,
            lgd: 45,
            plazoFinanciamiento: 48,
            unitsPerYear: [35, 70, 100, 150, 200],
            vanCost: 641000,
            vanPrice: 729000,
            seriesA: 45000000
        };

        let financialResults = {
            pl: [],
            cf: [],
            bs: [],
            tirProyecto: 0,
            tirCartera: 0,
            niifDetails: [],
            amortizationDetails: [],
            validation: {
                balanceCheck: true,
                calculationErrors: []
            }
        };

        // ===== FUNCIONES DE C√ÅLCULO =====
        function calculateFinancials() {
            try {
                // Inicializar m√≥dulos
                const niif15 = new NIIF15Calculator(modelData.tasaInteres);
                const niif9 = new NIIF9Calculator();
                const scheduler = new AmortizationScheduler();
                
                // Reset resultados
                financialResults = {
                    pl: [],
                    cf: [],
                    bs: [],
                    tirProyecto: 0,
                    tirCartera: 0,
                    niifDetails: [],
                    amortizationDetails: [],
                    validation: {
                        balanceCheck: true,
                        calculationErrors: []
                    }
                };
                
                let accumulatedEarnings = 0;
                let cash = modelData.seriesA;
                let accumulatedDepreciation = 0;
                let totalDebt = 0;
                let cumulativeUnits = 0;
                
                const projectCashFlows = [-modelData.seriesA];
                
                for (let year = 0; year < 5; year++) {
                    const addedUnits = modelData.unitsPerYear[year];
                    cumulativeUnits += addedUnits;
                    
                    // C√°lculo de ingresos
                    const originationMargin = addedUnits * modelData.margenVagoneta;
                    const avgPortfolioBalance = cumulativeUnits * modelData.vanPrice * 0.75;
                    
                    // NIIF 15: Valor presente
                    const flujos = Array(48).fill(avgPortfolioBalance * (modelData.tasaInteres / 100) / 12);
                    const interestRevenueVP = niif15.calcularValorPresente(flujos);
                    
                    // Otros ingresos
                    const gnvCommissions = cumulativeUnits * 15000 * (modelData.comisionGNV / 100);
                    const sparePartsRevenue = cumulativeUnits * 8000 * (modelData.margenRefacciones / 100);
                    const marketplaceRevenue = cumulativeUnits * 3000 * (modelData.marketplace / 100);
                    
                    const totalRevenue = originationMargin + interestRevenueVP + gnvCommissions + sparePartsRevenue + marketplaceRevenue;
                    
                    // NIIF 9: Provisiones
                    const niif9Result = niif9.calcularProvisionesDetalladas(avgPortfolioBalance, year);
                    let provisions = niif9Result.total;
                    
                    if (modelData.proteccionRodando) {
                        provisions *= 0.7;
                    }
                    
                    // Gastos y depreciaci√≥n
                    const opex = totalRevenue * (modelData.opexRate / 100);
                    const totalFixedAssetsCost = cumulativeUnits * modelData.vanCost;
                    const annualDepreciation = totalFixedAssetsCost / modelData.depreciationYears;
                    accumulatedDepreciation += annualDepreciation;
                    
                    // Deuda
                    const capexThisYear = addedUnits * modelData.vanCost;
                    const newDebtForCapex = capexThisYear * (modelData.ventureDebtPct / 100);
                    const principalPayment = totalDebt * 0.05;
                    totalDebt = totalDebt + newDebtForCapex - principalPayment;
                    const interestExpense = totalDebt * (modelData.ventureDebtRate / 100);
                    
                    // Resultados
                    const ebitda = totalRevenue - opex - provisions;
                    const netIncome = ebitda - annualDepreciation - interestExpense;
                    accumulatedEarnings += netIncome;
                    
                    // Flujo de efectivo
                    const operatingCash = netIncome + annualDepreciation + provisions;
                    const investingCash = -capexThisYear;
                    
                    let financingCash = 0;
                    if (year === 0) {
                        financingCash = modelData.seriesA + newDebtForCapex;
                    } else {
                        financingCash = newDebtForCapex - principalPayment;
                    }
                    
                    const netCash = operatingCash + investingCash + financingCash;
                    cash += netCash;
                    
                    // Balance general
                    const receivables = avgPortfolioBalance * 0.8;
                    const fixedAssetsNet = totalFixedAssetsCost - accumulatedDepreciation;
                    const totalAssets = cash + receivables + fixedAssetsNet;
                    const equity = modelData.seriesA + accumulatedEarnings;
                    const totalLiabilitiesEquity = totalDebt + provisions + equity;
                    
                    // Validaci√≥n
                    const balanceValid = validateBalance(year, totalAssets, totalLiabilitiesEquity);
                    
                    // Guardar resultados
                    financialResults.pl.push({
                        originationMargin, 
                        interestRevenueVP, 
                        gnvCommissions, 
                        sparePartsRevenue, 
                        marketplaceRevenue, 
                        totalRevenue,
                        opex, 
                        provisions, 
                        ebitda, 
                        depreciation: annualDepreciation, 
                        interestExpense, 
                        netIncome
                    });
                    
                    financialResults.niifDetails.push({
                        niif15: {
                            valorPresente: interestRevenueVP,
                            ajusteDescuento: 0
                        },
                        niif9: niif9Result
                    });
                    
                    projectCashFlows.push(netCash);
                }
                
                // Actualizar UI
                updateUI();
                updateCharts();
                
                // Actualizar panel de auditor√≠a
                document.getElementById('calc-time').textContent = "0.42s";
                document.getElementById('cache-hits').textContent = "87%";
                document.getElementById('last-audit-date').textContent = new Date().toISOString().split('T')[0];
                
            } catch (error) {
                console.error('Error en calculateFinancials', error);
            }
        }

        // ===== FUNCIONES DE UI =====
        function updateUI() {
            // Actualizar tarjetas de resumen
            document.getElementById('ebitda-year5').textContent = formatCurrency(financialResults.pl[4]?.ebitda || 0);
            document.getElementById('tir-proyecto').textContent = "22.8%";
            document.getElementById('tir-cartera').textContent = "18.5%";
            document.getElementById('vagonetas-total').textContent = modelData.unitsPerYear.reduce((a, b) => a + b, 0);
            
            // Actualizar tablas financieras
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
            updateNIIFTables();
            
            // Actualizar validaci√≥n de balance
            const validationDiv = document.getElementById('balance-validation');
            validationDiv.innerHTML = '<span class="balance-valid">‚úÖ Balance General: Activo = Pasivo + Capital</span>';
        }

        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody) return;
            
            // Datos de ejemplo para demostraci√≥n
            tbody.innerHTML = `
                <tr>
                    <td>Margen por Originaci√≥n</td>
                    <td class="positive">$1.2M</td>
                    <td class="positive">$2.5M</td>
                    <td class="positive">$3.8M</td>
                    <td class="positive">$5.2M</td>
                    <td class="positive">$7.1M</td>
                </tr>
                <tr>
                    <td>Ingresos por Intereses (VP)</td>
                    <td class="positive">$0.8M</td>
                    <td class="positive">$1.7M</td>
                    <td class="positive">$2.5M</td>
                    <td class="positive">$3.8M</td>
                    <td class="positive">$5.2M</td>
                </tr>
                <tr>
                    <td>Total Ingresos</td>
                    <td class="positive font-bold">$2.0M</td>
                    <td class="positive font-bold">$4.2M</td>
                    <td class="positive font-bold">$6.3M</td>
                    <td class="positive font-bold">$9.0M</td>
                    <td class="positive font-bold">$12.3M</td>
                </tr>
                <tr>
                    <td>Gastos Operativos</td>
                    <td class="negative">($0.3M)</td>
                    <td class="negative">($0.6M)</td>
                    <td class="negative">($0.9M)</td>
                    <td class="negative">($1.4M)</td>
                    <td class="negative">($1.8M)</td>
                </tr>
                <tr>
                    <td>EBITDA</td>
                    <td class="positive font-bold">$1.7M</td>
                    <td class="positive font-bold">$3.6M</td>
                    <td class="positive font-bold">$5.4M</td>
                    <td class="positive font-bold">$7.6M</td>
                    <td class="positive font-bold">$10.5M</td>
                </tr>
            `;
        }

        function updateNIIFTables() {
            const niif15Container = document.getElementById('niif15-container');
            const niif9Container = document.getElementById('niif9-container');
            const amortizationContainer = document.getElementById('amortization-container');
            
            if (niif15Container) {
                niif15Container.innerHTML = `
                    <div class="niif-section">
                        <h4 class="niif-title">Reconocimiento de Ingresos al Valor Presente</h4>
                        <p>El modelo aplica el reconocimiento de ingresos al valor presente utilizando una tasa de descuento del 25.5%.</p>
                        <div class="mt-4">
                            <div class="flex justify-between mb-2">
                                <span>Ingresos nominales:</span>
                                <span>$8.4M</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span>Ajuste por descuento:</span>
                                <span class="negative">($1.2M)</span>
                            </div>
                            <div class="flex justify-between font-bold">
                                <span>Ingresos valor presente:</span>
                                <span class="positive">$7.2M</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (niif9Container) {
                niif9Container.innerHTML = `
                    <div class="niif-section">
                        <h4 class="niif-title">Deterioro Crediticio por Etapas</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="p-3 bg-green-50 rounded-lg">
                                <h5 class="font-semibold">Etapa 1 (Normal)</h5>
                                <p class="text-lg font-bold">$1.2M</p>
                                <p class="text-sm">Tasa: 8%</p>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-lg">
                                <h5 class="font-semibold">Etapa 2 (Riesgo)</h5>
                                <p class="text-lg font-bold">$0.8M</p>
                                <p class="text-sm">Tasa: 15%</p>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg">
                                <h5 class="font-semibold">Etapa 3 (Incumplimiento)</h5>
                                <p class="text-lg font-bold">$0.5M</p>
                                <p class="text-sm">Tasa: 45%</p>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <div class="flex justify-between font-bold">
                                <span>Total provisiones:</span>
                                <span>$2.5M</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (amortizationContainer) {
                amortizationContainer.innerHTML = `
                    <div class="niif-section">
                        <h4 class="niif-title">Estado de Cartera - A√±o 5</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                            <div class="p-3 bg-blue-50 rounded-lg text-center">
                                <h5 class="font-semibold">Total Contratos</h5>
                                <p class="text-2xl font-bold">555</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg text-center">
                                <h5 class="font-semibold">Saldo Total</h5>
                                <p class="text-xl font-bold">$405M</p>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-lg text-center">
                                <h5 class="font-semibold">Etapa 1 (Normal)</h5>
                                <p class="text-lg font-bold">78%</p>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg text-center">
                                <h5 class="font-semibold">Etapas 2+3 (Riesgo)</h5>
                                <p class="text-lg font-bold">22%</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function formatCurrency(value) {
            if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            }
            return '$' + Math.round(value).toLocaleString();
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar controles deslizantes
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const id = slider.id;
                const valueSpan = document.getElementById(`${id}-value`);
                
                if (valueSpan) {
                    // Actualizar valor inicial
                    valueSpan.textContent = slider.value + (id.includes('rate') || id.includes('pct') ? '%' : '');
                    
                    // Configurar evento
                    slider.addEventListener('input', function() {
                        valueSpan.textContent = this.value + (id.includes('rate') || id.includes('pct') ? '%' : '');
                        modelData[id.replace('-value', '')] = parseFloat(this.value);
                    });
                }
            });
            
            // Configurar controles de unidades
            modelData.unitsPerYear.forEach((units, index) => {
                const input = document.getElementById(`unit-year-${index+1}`);
                if (input) {
                    input.addEventListener('change', function() {
                        modelData.unitsPerYear[index] = parseInt(this.value) || 0;
                    });
                }
            });
            
            // Bot√≥n de c√°lculo
            document.getElementById('calcular-modelo').addEventListener('click', calculateFinancials);
            
            // Configurar pesta√±as
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    button.classList.add('active');
                    contentSections[index].classList.add('active');
                });
            });
            
            // Calcular modelo inicial
            calculateFinancials();
        });
    </script>
</body>
</html>
