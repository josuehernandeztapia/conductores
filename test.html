<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero "Rodando a Gas" - NIIF Compliant CORREGIDO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .niif-explanation { background-color: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .niif-header { color: #10b981; font-weight: 600; margin-bottom: 0.5rem; }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .input-container { display: flex; align-items: center; gap: 1rem; }
        .input-value { font-weight: 600; color: #2563eb; min-width: 60px; }
        .section-header { font-size: 1.25rem; font-weight: 600; color: #1e40af; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #dbeafe; }
        .validation-success { background-color: #dcfce7; border-left: 4px solid #22c55e; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .validation-error { background-color: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .validation-warning { background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .correction-highlight { background-color: #e0f2fe; border-left: 4px solid #0284c7; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .error-message { background-color: #fef2f2; border: 1px solid #fca5a5; color: #dc2626; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
    </style>
</head>
<body class="text-gray-800">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header con Indicador de Correcciones -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Financiamiento de Vagonetas con Cumplimiento NIIF CORREGIDO</p>
            <div class="correction-highlight mt-4">
                <p class="text-sm font-semibold">‚úÖ VERSION CORREGIDA - Problemas de visualizaci√≥n solucionados</p>
                <p class="text-xs mt-1">6 correcciones cr√≠ticas aplicadas ‚Ä¢ Debug mejorado ‚Ä¢ Validaci√≥n autom√°tica activa</p>
            </div>
            <div id="system-status" class="mt-2 text-xs text-gray-500">Sistema inicializando...</div>
        </header>

        <!-- Error Display Area -->
        <div id="error-display" style="display: none;" class="error-message">
            <strong>Error del Sistema:</strong> <span id="error-message"></span>
        </div>

        <!-- Summary Cards Mejoradas -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA A√±o 5</div>
                <div class="text-xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-xl font-bold" id="tir-cartera">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIE Efectiva</div>
                <div class="text-xl font-bold" id="tie-efectiva">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas</div>
                <div class="text-xl font-bold" id="vagonetas-total">0</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Balance Status</div>
                <div class="text-xl font-bold" id="balance-status">‚öñÔ∏è OK</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-blue-500 rounded-t-lg">üöÄ Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìä Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìã NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìà Gr√°ficos</button>
                <button id="tab-validacion" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">‚úÖ Validaci√≥n</button>
                <button id="tab-diagnostico" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üîß Diagn√≥stico</button>
            </nav>
        </div>

        <!-- Control Panel -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Cr√©dito y Riesgo CORREGIDO -->
                    <div class="card">
                        <div class="section-header">Cr√©dito y Riesgo (NIIF 9 Corregido)</div>
                        <div class="niif-explanation">
                            <div class="niif-header">‚úÖ CORRECCI√ìN IMPLEMENTADA</div>
                            <p class="text-sm text-gray-700">
                                Modelo ECL con diferenciaci√≥n real entre etapas, migraci√≥n din√°mica y c√°lculo espec√≠fico de PD, LGD, EAD
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa de Inter√©s Contractual (%) <span class="text-xs text-gray-500">- Base para TIE</span></label>
                            <div class="input-container">
                                <input type="range" id="tasa-interes" min="10" max="40" step="0.1" value="40.0" class="input-slider">
                                <span id="tasa-interes-valor" class="input-value">40.0%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Base Etapa 1 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa1" min="1" max="10" step="0.1" value="3.5" class="input-slider">
                                <span id="pd-etapa1-valor" class="input-value">3.5%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Base Etapa 2 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa2" min="5" max="25" step="0.5" value="15.0" class="input-slider">
                                <span id="pd-etapa2-valor" class="input-value">15.0%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Base Etapa 3 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa3" min="50" max="100" step="1" value="85" class="input-slider">
                                <span id="pd-etapa3-valor" class="input-value">85%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">LGD (P√©rdida en caso de Incumplimiento) (%)</label>
                            <div class="input-container">
                                <input type="range" id="lgd" min="20" max="100" step="1" value="75" class="input-slider">
                                <span id="lgd-valor" class="input-value">75%</span>
                            </div>
                        </div>
                        <div class="flex items-center mt-4">
                            <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                            <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Protecci√≥n Rodando (ajuste t√©cnico -20% provisiones)</label>
                        </div>
                    </div>

                    <!-- Operaciones CORREGIDO -->
                    <div class="card">
                        <div class="section-header">Operaciones (NIIF 15 Corregido)</div>
                        <div class="niif-explanation">
                            <div class="niif-header">‚úÖ CORRECCI√ìN IMPLEMENTADA</div>
                            <p class="text-sm text-gray-700">
                                Margen de originaci√≥n diferido, consideraci√≥n variable con restricciones, reconocimiento durante per√≠odo de financiamiento
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margen por Originaci√≥n - DIFERIDO (%) <span class="text-xs text-gray-500">- Se reconoce en 60 meses</span></label>
                            <div class="input-container">
                                <input type="range" id="margen-originacion" min="5" max="20" step="0.5" value="10" class="input-slider">
                                <span id="margen-originacion-valor" class="input-value">10%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Comisi√≥n GNV con Restricci√≥n (%) <span class="text-xs text-gray-500">- Max 85% reconocido</span></label>
                            <div class="input-container">
                                <input type="range" id="comision-gnv" min="5" max="15" step="0.5" value="8" class="input-slider">
                                <span id="comision-gnv-valor" class="input-value">8%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margen Refacciones con Restricci√≥n (%) <span class="text-xs text-gray-500">- Max 90% reconocido</span></label>
                            <div class="input-container">
                                <input type="range" id="margen-refacciones" min="15" max="35" step="1" value="25" class="input-slider">
                                <span id="margen-refacciones-valor" class="input-value">25%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Gastos Operativos (%)</label>
                            <div class="input-container">
                                <input type="range" id="opex-rate" min="5" max="30" step="1" value="15" class="input-slider">
                                <span id="opex-rate-valor" class="input-value">15%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Impuesto (%)</label>
                            <div class="input-container">
                                <input type="range" id="tax-rate" min="25" max="35" step="1" value="30" class="input-slider">
                                <span id="tax-rate-valor" class="input-value">30%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Inflaci√≥n Anual (%)</label>
                            <div class="input-container">
                                <input type="range" id="inflation-rate" min="2" max="8" step="0.1" value="4.5" class="input-slider">
                                <span id="inflation-rate-valor" class="input-value">4.5%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Capital CORREGIDO -->
                    <div class="card">
                        <div class="section-header">Capital (Flujos Corregidos)</div>
                        <div class="input-group">
                            <label class="input-label">Serie A Capital Inicial (M MXN)</label>
                            <div class="input-container">
                                <input type="range" id="serie-a" min="30" max="60" step="1" value="45" class="input-slider">
                                <span id="serie-a-valor" class="input-value">45M</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">% Venture Debt sobre Inversi√≥n</label>
                            <div class="input-container">
                                <input type="range" id="venture-debt-pct" min="50" max="90" step="5" value="70" class="input-slider">
                                <span id="venture-debt-pct-valor" class="input-value">70%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Venture Debt (%)</label>
                            <div class="input-container">
                                <input type="range" id="venture-debt-rate" min="8" max="18" step="0.5" value="12" class="input-slider">
                                <span id="venture-debt-rate-valor" class="input-value">12%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Per√≠odo Amortizaci√≥n Deuda (A√±os)</label>
                            <div class="input-container">
                                <input type="range" id="amortizacion-deuda" min="3" max="7" step="1" value="5" class="input-slider">
                                <span id="amortizacion-deuda-valor" class="input-value">5 a√±os</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Covenant Deuda/EBITDA (Max)</label>
                            <div class="input-container">
                                <input type="range" id="debt-covenant" min="2" max="6" step="0.1" value="3.5" class="input-slider">
                                <span id="debt-covenant-valor" class="input-value">3.5x</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Min Capital de Trabajo (% Ingresos)</label>
                            <div class="input-container">
                                <input type="range" id="working-capital" min="5" max="20" step="1" value="10" class="input-slider">
                                <span id="working-capital-valor" class="input-value">10%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Activos y NIIF 5 CORREGIDO -->
                    <div class="card">
                        <div class="section-header">Activos y NIIF 5 (Corregido)</div>
                        <div class="niif-explanation">
                            <div class="niif-header">‚úÖ CORRECCI√ìN IMPLEMENTADA</div>
                            <p class="text-sm text-gray-700">
                                Evaluaci√≥n de "alta probabilidad de venta en 12 meses", deterioro solo en activos clasificados para venta
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Costo Vagoneta (MXN)</label>
                            <input type="number" id="costo-vagoneta" min="500000" max="800000" step="1000" value="641000" class="p-2 border rounded w-full">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Precio Financiado al Cliente (MXN)</label>
                            <input type="number" id="precio-financiado" min="600000" max="900000" step="1000" value="729000" class="p-2 border rounded w-full">
                            <div id="price-validation" class="mt-1 text-xs"></div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Reposesi√≥n (%) <span class="text-xs text-gray-500">- Solo unidades con plan de venta</span></label>
                            <div class="input-container">
                                <input type="range" id="tasa-reposicion" min="1" max="15" step="0.5" value="8" class="input-slider">
                                <span id="tasa-reposicion-valor" class="input-value">8%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Fair Value Venta (%)</label>
                            <div class="input-container">
                                <input type="range" id="fair-value" min="70" max="95" step="1" value="85" class="input-slider">
                                <span id="fair-value-valor" class="input-value">85%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Costos de Venta (%)</label>
                            <div class="input-container">
                                <input type="range" id="costos-venta" min="1" max="10" step="0.5" value="5" class="input-slider">
                                <span id="costos-venta-valor" class="input-value">5%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Depreciaci√≥n (A√±os)</label>
                            <div class="input-container">
                                <input type="range" id="depreciation-years" min="8" max="15" step="1" value="10" class="input-slider">
                                <span id="depreciation-years-valor" class="input-value">10 a√±os</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unidades por A√±o MEJORADO -->
            <div class="card mt-6">
                <div class="section-header">Unidades por A√±o (Flujo de Efectivo Mensual)</div>
                <div class="niif-explanation">
                    <div class="niif-header">‚úÖ TIMING CORREGIDO</div>
                    <p class="text-sm text-gray-700">
                        Flujos de efectivo distribuidos mensualmente para c√°lculo TIR preciso. Depreciaci√≥n individual por cohorte.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="units-container">
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 1</label>
                        <input type="number" id="unit-year-1" min="0" max="1000" value="35" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 2</label>
                        <input type="number" id="unit-year-2" min="0" max="1000" value="70" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 3</label>
                        <input type="number" id="unit-year-3" min="0" max="1000" value="100" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 4</label>
                        <input type="number" id="unit-year-4" min="0" max="1000" value="150" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 5</label>
                        <input type="number" id="unit-year-5" min="0" max="1000" value="200" class="p-2 border rounded">
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <div>
                        <button id="btn-base" class="bg-blue-500 text-white px-4 py-2 rounded font-medium">Escenario Base</button>
                        <button id="btn-optimista" class="bg-green-500 text-white px-4 py-2 rounded font-medium ml-2">Optimista</button>
                        <button id="btn-conservador" class="bg-yellow-500 text-white px-4 py-2 rounded font-medium ml-2">Conservador</button>
                        <button id="btn-estres" class="bg-red-500 text-white px-4 py-2 rounded font-medium ml-2">Estr√©s</button>
                    </div>
                    <div>
                        <button id="btn-export" class="bg-purple-500 text-white px-4 py-2 rounded font-medium mr-2">üìÅ Exportar</button>
                        <button id="btn-diagnostico" class="bg-gray-500 text-white px-4 py-2 rounded font-medium">üîß Diagn√≥stico</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estados Financieros MEJORADOS -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L) - NIIF Compliant</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A√±o 1</th>
                                    <th>A√±o 2</th>
                                    <th>A√±o 3</th>
                                    <th>A√±o 4</th>
                                    <th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body">
                                <tr><td colspan="6" class="text-center text-gray-500">Cargando datos financieros...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo (Corregido)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A√±o 0</th>
                                    <th>A√±o 1</th>
                                    <th>A√±o 2</th>
                                    <th>A√±o 3</th>
                                    <th>A√±o 4</th>
                                    <th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body">
                                <tr><td colspan="7" class="text-center text-gray-500">Cargando datos de flujo de efectivo...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General (Validado)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A√±o 1</th>
                                    <th>A√±o 2</th>
                                    <th>A√±o 3</th>
                                    <th>A√±o 4</th>
                                    <th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body">
                                <tr><td colspan="6" class="text-center text-gray-500">Cargando datos del balance...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4">
                        <!-- Balance validation message -->
                    </div>
                </div>
            </div>
        </div>

        <!-- NIIF MEJORADO -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos (Corregido)</h3>
                    <div class="correction-highlight">
                        <div class="font-semibold">‚úÖ CORRECCIONES IMPLEMENTADAS:</div>
                        <ul class="text-sm mt-2 list-disc list-inside">
                            <li>Tasa de inter√©s efectiva calculada con costos de transacci√≥n</li>
                            <li>Margen de originaci√≥n diferido en 60 meses</li>
                            <li>Consideraci√≥n variable con restricciones del 85-90%</li>
                            <li>Reconocimiento basado en obligaciones de desempe√±o</li>
                        </ul>
                    </div>
                    <div id="niif15-container" class="mt-4">
                        <p class="text-center text-gray-500">Cargando an√°lisis NIIF 15...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 9 - Instrumentos Financieros (Corregido)</h3>
                    <div class="correction-highlight">
                        <div class="font-semibold">‚úÖ CORRECCIONES IMPLEMENTADAS:</div>
                        <ul class="text-sm mt-2 list-disc list-inside">
                            <li>Modelo ECL con 3 etapas diferenciadas (PD espec√≠fica por etapa)</li>
                            <li>Migraci√≥n din√°mica basada en cambios de riesgo crediticio</li>
                            <li>C√°lculo espec√≠fico de PD, LGD, EAD por etapa</li>
                            <li>Utilizaci√≥n y reversi√≥n de provisiones</li>
                        </ul>
                    </div>
                    <div id="niif9-container" class="mt-4">
                        <p class="text-center text-gray-500">Cargando an√°lisis NIIF 9...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos No Corrientes Mantenidos para la Venta (Corregido)</h3>
                    <div class="correction-highlight">
                        <div class="font-semibold">‚úÖ CORRECCIONES IMPLEMENTADAS:</div>
                        <ul class="text-sm mt-2 list-disc list-inside">
                            <li>Evaluaci√≥n de "alta probabilidad de venta en 12 meses"</li>
                            <li>Deterioro aplicado solo a activos clasificados para venta</li>
                            <li>Medici√≥n al menor entre valor en libros y valor razonable menos costos</li>
                            <li>Suspensi√≥n de depreciaci√≥n para activos mantenidos para venta</li>
                        </ul>
                    </div>
                    <div id="niif5-container" class="mt-4">
                        <p class="text-center text-gray-500">Cargando an√°lisis NIIF 5...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos MEJORADOS -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evoluci√≥n de EBITDA (Ajustado por Inflaci√≥n)</h4>
                    <div style="height: 300px;"><canvas id="ebitdaChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">TIR Corregida vs Original</h4>
                    <div style="height: 300px;"><canvas id="tirChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Migraci√≥n de Etapas NIIF 9</h4>
                    <div style="height: 300px;"><canvas id="migrationChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Cumplimiento de Covenants</h4>
                    <div style="height: 300px;"><canvas id="covenantChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Sensibilidad TIR</h4>
                    <div style="height: 300px;"><canvas id="sensitivityChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Capital de Trabajo</h4>
                    <div style="height: 300px;"><canvas id="workingCapitalChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Validaci√≥n -->
        <div id="content-validacion" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Panel de Validaci√≥n Integral</h3>
                    <div id="validation-dashboard">
                        <p class="text-center text-gray-500">Cargando panel de validaci√≥n...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Reconciliaci√≥n de Balance</h3>
                    <div id="balance-reconciliation">
                        <p class="text-center text-gray-500">Cargando reconciliaci√≥n...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">An√°lisis de Sensibilidad</h3>
                    <div id="sensitivity-analysis">
                        <p class="text-center text-gray-500">Cargando an√°lisis de sensibilidad...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nueva Pesta√±a de Diagn√≥stico -->
        <div id="content-diagnostico" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Panel de Diagn√≥stico del Sistema</h3>
                    <div class="mb-4">
                        <button id="btn-run-diagnostics" class="bg-blue-500 text-white px-4 py-2 rounded font-medium">üîç Ejecutar Diagn√≥stico Completo</button>
                        <button id="btn-clear-console" class="bg-gray-500 text-white px-4 py-2 rounded font-medium ml-2">üóëÔ∏è Limpiar Consola</button>
                    </div>
                    <div id="diagnostic-results" class="space-y-4">
                        <p class="text-center text-gray-500">Haga clic en "Ejecutar Diagn√≥stico" para analizar el sistema...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Consola de Debug</h3>
                    <div id="debug-console" class="bg-black text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto">
                        <div>Sistema de diagn√≥stico inicializado...</div>
                        <div>Esperando comandos de diagn√≥stico...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CORRECCI√ìN #1: VARIABLE DEBOUNCE TIMER DECLARADA GLOBALMENTE =====
        let debounceTimer; // CORRECCI√ìN: Declarar debounceTimer globalmente

        // ===== VARIABLES GLOBALES EXPANDIDAS =====
        const modelData = {
            // Par√°metros de cr√©dito NIIF 9
            tasaInteres: 40.0,
            pdEtapa1: 3.5,
            pdEtapa2: 15.0,
            pdEtapa3: 85.0,
            lgd: 75,
            proteccionRodando: true,
            
            // Par√°metros operativos NIIF 15
            margenOriginacion: 10,
            comisionGNV: 8,
            margenRefacciones: 25,
            opexRate: 15,
            taxRate: 30,
            inflationRate: 4.5,
            
            // Par√°metros de capital
            serieA: 45000000,
            ventureDebtPct: 70,
            ventureDebtRate: 12,
            amortizacionDeuda: 5,
            debtCovenant: 3.5,
            workingCapital: 10,
            
            // Par√°metros de activos NIIF 5
            costoVagoneta: 641000,
            precioFinanciado: 729000,
            tasaReposicion: 8,
            fairValue: 85,
            costosVenta: 5,
            depreciationYears: 10,
            
            // Operaciones
            unitsPerYear: [35, 70, 100, 150, 200],
            gnvRevPerUnit: 12000,
            refaccionesRevPerUnit: 50000,
            marketplaceRevPerUnit: 5000,
            
            // Nuevos par√°metros corregidos
            transactionCosts: 2.5,
            deferralMonths: 60,
            variableRestrictionGNV: 85,
            variableRestrictionParts: 90,
            
            // Par√°metros ECL din√°micos
            migrationUp: 15,
            migrationDown: 8,
            migrationDefault: 12,
            utilizationRate: 25,
        };

        let financialResults = {
            pl: [],
            cf: [],
            bs: [],
            niifDetails: [],
            tirProyecto: 0,
            tirCartera: 0,
            tieEfectiva: 0,
            validations: [],
            covenantCompliance: [],
            sensitivityAnalysis: {}
        };

        let charts = {};
        let systemInitialized = false;

        // ===== CORRECCI√ìN #2: INICIALIZACI√ìN MEJORADA CON VERIFICACI√ìN DE ESTADO =====
        function initializeModel() {
            try {
                updateSystemStatus('Inicializando pesta√±as...');
                setupTabs();
                
                updateSystemStatus('Configurando controles reactivos...');
                setupReactiveControls();
                
                updateSystemStatus('Configurando escenarios...');
                setupScenarios();
                
                updateSystemStatus('Configurando validaciones...');
                setupValidation();
                
                updateSystemStatus('Inicializando gr√°ficos...');
                initializeCharts();
                
                updateSystemStatus('Ejecutando c√°lculos financieros...');
                calculateAdvancedFinancials();
                
                updateSystemStatus('Actualizando interfaz...');
                updateUI();
                
                updateSystemStatus('Configurando exportaci√≥n...');
                setupExportFunctionality();
                
                updateSystemStatus('Sistema inicializado correctamente ‚úÖ');
                systemInitialized = true;
                
                // Ejecutar diagn√≥stico inicial
                setTimeout(() => {
                    diagnosticCheck();
                }, 1000);
                
            } catch (error) {
                console.error('Error durante la inicializaci√≥n:', error);
                showErrorMessage('Error durante la inicializaci√≥n: ' + error.message);
                updateSystemStatus('Error en inicializaci√≥n ‚ùå');
            }
        }

        // CORRECCI√ìN: Verificar estado del documento antes de inicializar
        if (document.readyState !== 'loading') {
            initializeModel();
        } else {
            document.addEventListener('DOMContentLoaded', initializeModel);
        }

        // ===== FUNCIONES DE UTILIDAD PARA DEBUG =====
        function updateSystemStatus(message) {
            const statusElement = document.getElementById('system-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
            console.log('Sistema:', message);
        }

        function showErrorMessage(message) {
            const errorDisplay = document.getElementById('error-display');
            const errorMessage = document.getElementById('error-message');
            if (errorDisplay && errorMessage) {
                errorMessage.textContent = message;
                errorDisplay.style.display = 'block';
                setTimeout(() => {
                    errorDisplay.style.display = 'none';
                }, 10000);
            }
            console.error('Error:', message);
        }

        function addToDebugConsole(message) {
            const console_element = document.getElementById('debug-console');
            if (console_element) {
                const timestamp = new Date().toLocaleTimeString();
                const div = document.createElement('div');
                div.textContent = `[${timestamp}] ${message}`;
                console_element.appendChild(div);
                console_element.scrollTop = console_element.scrollHeight;
            }
        }

        // ===== CORRECCI√ìN #3: FUNCI√ìN DE C√ÅLCULOS CON MANEJO ROBUSTO DE ERRORES =====
        function calculateAdvancedFinancials() {
            try {
                console.log('Iniciando c√°lculos financieros...');
                addToDebugConsole('Iniciando c√°lculos financieros...');
                
                // CORRECCI√ìN: Validar datos antes de calcular
                if (!modelData || !modelData.unitsPerYear || modelData.unitsPerYear.length === 0) {
                    throw new Error('Datos del modelo no v√°lidos');
                }
                
                // Reiniciar resultados
                financialResults = { 
                    pl: [], cf: [], bs: [], niifDetails: [], 
                    tirProyecto: 0, tirCartera: 0, tieEfectiva: 0,
                    validations: [], covenantCompliance: [],
                    sensitivityAnalysis: {}
                };

                // Variables de estado avanzadas
                let accumulatedEarnings = 0;
                let cash = 0;
                let totalDebt = 0;
                let cumulativeUnits = 0;
                let totalInvestment = 0;
                
                let assetCohorts = [];
                let outstandingReceivables = 0;
                let provisionsStage1 = 0, provisionsStage2 = 0, provisionsStage3 = 0;
                let workingCapitalNeeds = 0;
                let deferredOriginationFees = 0;
                
                const projectCashFlows = [];
                const portfolioCashFlows = [];

                // CORRECCI√ìN: Calcular TIE correcta
                const transactionCostRate = modelData.transactionCosts / 100;
                const nominalRate = modelData.tasaInteres / 100;

                // Year 0 - Capital inicial
                const initialEquity = modelData.serieA;
                const initialDebt = initialEquity * (modelData.ventureDebtPct / 100);
                cash = initialEquity + initialDebt;
                totalDebt += initialDebt;
                totalInvestment = initialEquity + initialDebt;
                
                projectCashFlows.push(-totalInvestment);

                // A√±os 1-5 con c√°lculos corregidos
                for (let year = 0; year < 5; year++) {
                    const addedUnits = modelData.unitsPerYear[year];
                    cumulativeUnits += addedUnits;
                    
                    const inflationFactor = Math.pow(1 + modelData.inflationRate / 100, year);

                    // NIIF 15 - Reconocimiento de ingresos
                    const portfolioBalanceNominal = cumulativeUnits * modelData.precioFinanciado;
                    const principalPaid = portfolioBalanceNominal * 0.25 * (year + 1);
                    const outstandingBalance = Math.max(0, portfolioBalanceNominal - principalPaid);
                    
                    // TIE corregida
                    if (year === 0) {
                        financialResults.tieEfectiva = calculateCorrectTIE(nominalRate, transactionCostRate, portfolioBalanceNominal, outstandingBalance);
                    }
                    
                    const interestRevenue = outstandingBalance * (financialResults.tieEfectiva / 100) * inflationFactor;
                    
                    // Margen originaci√≥n diferido
                    const totalOriginationFees = addedUnits * modelData.precioFinanciado * (modelData.margenOriginacion / 100);
                    deferredOriginationFees += totalOriginationFees;
                    
                    const performanceObligationFulfilled = Math.min(1, (year + 1) / 5);
                    const recognizedOriginationFees = deferredOriginationFees * performanceObligationFulfilled;
                    const previousRecognized = year === 0 ? 0 : (deferredOriginationFees * Math.min(1, year / 5));
                    const margenOriginacionRecognized = recognizedOriginationFees - previousRecognized;
                    
                    // Consideraci√≥n variable con restricciones
                    const gnvCommissionsTotal = cumulativeUnits * modelData.gnvRevPerUnit * (modelData.comisionGNV / 100);
                    const gnvCommissions = gnvCommissionsTotal * (modelData.variableRestrictionGNV / 100) * inflationFactor;
                    
                    const sparePartsTotal = addedUnits * modelData.refaccionesRevPerUnit * (modelData.margenRefacciones / 100);
                    const sparePartsRevenue = sparePartsTotal * (modelData.variableRestrictionParts / 100) * inflationFactor;
                    
                    const marketplaceRevenue = cumulativeUnits * modelData.marketplaceRevPerUnit * 0.01 * inflationFactor;
                    
                    const totalRevenue = interestRevenue + margenOriginacionRecognized + gnvCommissions + sparePartsRevenue + marketplaceRevenue;

                    // Gastos operativos
                    const opex = totalRevenue * (modelData.opexRate / 100) * inflationFactor;

                    // NIIF 9 - Modelo ECL corregido
                    const { stage1Balance, stage2Balance, stage3Balance } = calculateStageDistribution(
                        outstandingBalance, year, modelData, cumulativeUnits
                    );
                    
                    // Migraci√≥n entre etapas
                    let finalStage1 = stage1Balance;
                    let finalStage2 = stage2Balance;
                    let finalStage3 = stage3Balance;
                    
                    if (year > 0) {
                        const migrations = calculateTechnicalMigration(stage1Balance, stage2Balance, stage3Balance, year, modelData);
                        finalStage1 = migrations.newStage1;
                        finalStage2 = migrations.newStage2;
                        finalStage3 = migrations.newStage3;
                    }
                    
                    // Provisiones espec√≠ficas por etapa
                    const discountRate = modelData.tasaInteres / 100;
                    const newProvisionsStage1 = calculateECLByStage(finalStage1, modelData.pdEtapa1 / 100, modelData.lgd / 100, 1, discountRate);
                    const newProvisionsStage2 = calculateECLByStage(finalStage2, modelData.pdEtapa2 / 100, modelData.lgd / 100, 5, discountRate);
                    const newProvisionsStage3 = calculateECLByStage(finalStage3, modelData.pdEtapa3 / 100, modelData.lgd / 100, 1, discountRate);
                    
                    const utilizationStage3 = provisionsStage3 * (modelData.utilizationRate / 100);
                    
                    provisionsStage1 += newProvisionsStage1;
                    provisionsStage2 += newProvisionsStage2;
                    provisionsStage3 += newProvisionsStage3 - utilizationStage3;
                    
                    const protectionAdjustment = modelData.proteccionRodando ? 0.8 : 1.0;
                    const totalProvisions = (provisionsStage1 + provisionsStage2 + provisionsStage3) * protectionAdjustment;
                    const provisionsExpense = (newProvisionsStage1 + newProvisionsStage2 + newProvisionsStage3) * protectionAdjustment;

                    // CAPEX y depreciaci√≥n
                    const capexThisYear = addedUnits * modelData.costoVagoneta * inflationFactor;
                    
                    if (addedUnits > 0) {
                        assetCohorts.push({
                            year: year,
                            units: addedUnits,
                            cost: capexThisYear,
                            accumulatedDepreciation: 0,
                            depreciationPerYear: capexThisYear / modelData.depreciationYears
                        });
                    }
                    
                    let totalDepreciation = 0;
                    assetCohorts.forEach(cohort => {
                        if (year >= cohort.year) {
                            const yearsSinceAcquisition = year - cohort.year + 1;
                            const maxDepreciation = Math.min(yearsSinceAcquisition, modelData.depreciationYears);
                            cohort.accumulatedDepreciation = cohort.depreciationPerYear * maxDepreciation;
                            totalDepreciation += cohort.depreciationPerYear;
                        }
                    });

                    // NIIF 5 - Activos mantenidos para venta
                    const { repoUnits, qualifiedForSale } = evaluateNIIF5Criteria(cumulativeUnits, modelData, year);
                    const totalAssetValue = assetCohorts.reduce((sum, cohort) => sum + cohort.cost - cohort.accumulatedDepreciation, 0);
                    const avgAssetValue = totalAssetValue / Math.max(1, cumulativeUnits);
                    const heldForSaleValue = repoUnits * avgAssetValue;
                    
                    const fairValue = heldForSaleValue * (modelData.fairValue / 100);
                    const costsToSell = fairValue * (modelData.costosVenta / 100);
                    const fairValueLessCosts = fairValue - costsToSell;
                    const impairmentNIIF5 = Math.max(0, heldForSaleValue - fairValueLessCosts);

                    // C√°lculos de deuda y financiamiento
                    const interestExpense = totalDebt * (modelData.ventureDebtRate / 100);
                    
                    const scheduledPrincipalPayment = year === 0 ? 0 : 
                        Math.min(totalDebt, totalDebt / (modelData.amortizacionDeuda - year));
                    const newDebtForCapex = capexThisYear * (modelData.ventureDebtPct / 100);
                    const capitalCallRequired = capexThisYear * (1 - modelData.ventureDebtPct / 100);
                    
                    totalDebt = totalDebt + newDebtForCapex - scheduledPrincipalPayment;

                    // Capital de trabajo
                    const requiredWorkingCapital = totalRevenue * (modelData.workingCapital / 100);
                    const workingCapitalChange = requiredWorkingCapital - workingCapitalNeeds;
                    workingCapitalNeeds = requiredWorkingCapital;

                    // Cuentas por cobrar
                    const newReceivables = outstandingBalance;
                    const changeInReceivables = newReceivables - outstandingReceivables;
                    outstandingReceivables = newReceivables;

                    // Resultados financieros
                    const ebitda = totalRevenue - opex - provisionsExpense - impairmentNIIF5;
                    const ebit = ebitda - totalDepreciation;
                    const ebt = ebit - interestExpense;
                    const taxes = Math.max(0, ebt * (modelData.taxRate / 100));
                    const netIncome = ebt - taxes;
                    accumulatedEarnings += netIncome;

                    // Flujo de efectivo
                    const operatingCashBeforeWC = netIncome + totalDepreciation + provisionsExpense + impairmentNIIF5;
                    const operatingCash = operatingCashBeforeWC - changeInReceivables - workingCapitalChange;
                    const investingCash = -capexThisYear;
                    const financingCash = newDebtForCapex - scheduledPrincipalPayment - capitalCallRequired;
                    const netCashFlow = operatingCash + investingCash + financingCash;
                    
                    cash += netCashFlow;

                    // Balance general CORREGIDO
                    const totalFixedAssetsGross = assetCohorts.reduce((sum, cohort) => sum + cohort.cost, 0);
                    const totalAccumulatedDepreciation = assetCohorts.reduce((sum, cohort) => sum + cohort.accumulatedDepreciation, 0);
                    const fixedAssetsNet = totalFixedAssetsGross - totalAccumulatedDepreciation;
                    
                    // CORRECCI√ìN: Balance sin duplicaci√≥n de capital de trabajo
                    const totalAssets = cash + outstandingReceivables + fixedAssetsNet + fairValueLessCosts + deferredOriginationFees;
                    const equity = modelData.serieA + accumulatedEarnings;
                    const totalLiabilitiesEquity = totalDebt + totalProvisions + equity;

                    const balanceDifference = totalAssets - totalLiabilitiesEquity;
                    const isBalanced = Math.abs(balanceDifference) < 100;

                    // Covenant compliance
                    const debtToEbitdaRatio = totalDebt / Math.max(1, ebitda);
                    const covenantCompliance = {
                        year: year + 1,
                        debtToEbitda: debtToEbitdaRatio,
                        covenantLimit: modelData.debtCovenant,
                        isCompliant: debtToEbitdaRatio <= modelData.debtCovenant,
                        margin: modelData.debtCovenant - debtToEbitdaRatio
                    };

                    // Almacenar resultados
                    financialResults.pl.push({
                        year: year + 1,
                        interestRevenue,
                        margenOriginacion: margenOriginacionRecognized,
                        gnvCommissions,
                        sparePartsRevenue,
                        marketplaceRevenue,
                        totalRevenue,
                        opex,
                        provisionsExpense,
                        impairment: impairmentNIIF5,
                        ebitda,
                        depreciation: totalDepreciation,
                        ebit,
                        interestExpense,
                        ebt,
                        taxes,
                        netIncome
                    });

                    financialResults.cf.push({
                        year: year + 1,
                        operatingCash,
                        investingCash,
                        financingCash,
                        netCashFlow,
                        workingCapitalChange,
                        changeInReceivables
                    });

                    financialResults.bs.push({
                        year: year + 1,
                        cash,
                        receivables: outstandingReceivables,
                        fixedAssets: fixedAssetsNet,
                        assetsHeldForSale: fairValueLessCosts,
                        workingCapital: workingCapitalNeeds,
                        deferredFees: deferredOriginationFees,
                        totalAssets,
                        debt: totalDebt,
                        provisionsStage1,
                        provisionsStage2,
                        provisionsStage3,
                        totalProvisions,
                        equity,
                        totalLiabilitiesEquity,
                        balanceDifference,
                        isBalanced
                    });

                    financialResults.niifDetails.push({
                        year: year + 1,
                        niif15: {
                            tieEfectiva: financialResults.tieEfectiva,
                            interestRevenue,
                            deferredOriginationTotal: deferredOriginationFees,
                            recognizedOrigination: margenOriginacionRecognized,
                            gnvRestriction: modelData.variableRestrictionGNV,
                            partsRestriction: modelData.variableRestrictionParts
                        },
                        niif9: {
                            stage1Balance: finalStage1,
                            stage2Balance: finalStage2,
                            stage3Balance: finalStage3,
                            provisionsStage1,
                            provisionsStage2,
                            provisionsStage3,
                            totalProvisions,
                            utilizationStage3,
                            pdStage1: modelData.pdEtapa1,
                            pdStage2: modelData.pdEtapa2,
                            pdStage3: modelData.pdEtapa3,
                            lgd: modelData.lgd,
                            protectionAdjustment
                        },
                        niif5: {
                            totalUnits: cumulativeUnits,
                            repoUnits,
                            heldForSaleValue,
                            fairValue,
                            costsToSell,
                            fairValueLessCosts,
                            impairment: impairmentNIIF5,
                            avgAssetValue
                        }
                    });

                    financialResults.covenantCompliance.push(covenantCompliance);

                    // Flujos para TIR diferenciados
                    const netCashFlowToEquity = netCashFlow - scheduledPrincipalPayment + newDebtForCapex;
                    projectCashFlows.push(netCashFlowToEquity);
                    
                    const portfolioNetCash = interestRevenue + margenOriginacionRecognized - provisionsExpense;
                    portfolioCashFlows.push(portfolioNetCash);
                }

                // Calcular TIR con m√©todo mejorado
                financialResults.tirProyecto = calculateImprovedIRR(projectCashFlows);
                financialResults.tirCartera = calculateImprovedIRR(portfolioCashFlows);
                
                // An√°lisis de sensibilidad
                performSensitivityAnalysis();
                
                console.log('C√°lculos completados:', financialResults);
                addToDebugConsole('C√°lculos financieros completados exitosamente');
                
            } catch (error) {
                console.error('Error en calculateAdvancedFinancials:', error);
                addToDebugConsole('ERROR en calculateAdvancedFinancials: ' + error.message);
                showErrorMessage('Error en los c√°lculos financieros: ' + error.message);
            }
        }

        //
