<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero "Rodando a Gas" - NIIF Compliant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .niif-explanation { background-color: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .niif-header { color: #10b981; font-weight: 600; margin-bottom: 0.5rem; }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .input-container { display: flex; align-items: center; gap: 1rem; }
        .input-value { font-weight: 600; color: #2563eb; min-width: 60px; }
        .section-header { font-size: 1.25rem; font-weight: 600; color: #1e40af; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #dbeafe; }
        .info-tooltip { display: inline-block; width: 16px; height: 16px; background-color: #9ca3af; color: white; border-radius: 50%; text-align: center; font-size: 12px; line-height: 16px; cursor: help; margin-left: 0.25rem; vertical-align: middle; }
        .validation-success { background-color: #dcfce7; border-left: 4px solid #22c55e; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .validation-error { background-color: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .error-message { color: #ef4444; font-weight: 500; margin-top: 0.5rem; }
        .balance-error { background-color: #ffebee; padding: 0.5rem; margin: 0.25rem 0; border-radius: 0.25rem; }
    </style>
</head>
<body class="text-gray-800">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Financiamiento de Vagonetas con Cumplimiento NIIF</p>
            <div class="mt-4">
                <p class="text-gray-600">
                    RAG no vende vagonetas, las financia. Las vagonetas son activos fijos y
                    los ingresos provienen principalmente de intereses del financiamiento y servicios auxiliares.
                </p>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA Año 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas</div>
                <div class="text-2xl font-bold" id="vagonetas-total">0</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Deuda Residual</div>
                <div class="text-2xl font-bold" id="deuda-residual">$0M MXN</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-blue-500 rounded-t-lg">🚀 Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📊 Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📋 NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">📈 Gráficos</button>
            </nav>
        </div>

        <!-- Control Panel -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Crédito y Riesgo -->
                    <div class="card">
                        <div class="section-header">Crédito y Riesgo</div>
                        <div class="niif-explanation">
                            <div class="niif-header">NIIF 9 - Instrumentos Financieros</div>
                            <p class="text-sm text-gray-700">
                                Establece cómo las entidades deben clasificar, medir y realizar pruebas
                                de deterioro de activos financieros. Requiere reconocimiento de pérdidas crediticias esperadas.
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa de Interés Efectiva (%)</label>
                            <div class="input-container">
                                <input type="range" id="tasa-interes" min="10" max="40" step="0.1" value="40.0" class="input-slider">
                                <span id="tasa-interes-valor" class="input-value">40.0%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa de Morosidad (%)</label>
                            <div class="input-container">
                                <input type="range" id="tasa-morosidad" min="1" max="30" step="0.5" value="19.5" class="input-slider">
                                <span id="tasa-morosidad-valor" class="input-value">19.5%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">LGD (Pérdida en caso de Incumplimiento) (%)</label>
                            <div class="input-container">
                                <input type="range" id="lgd" min="20" max="100" step="1" value="80" class="input-slider">
                                <span id="lgd-valor" class="input-value">80%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Etapa 2 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa2" min="1" max="30" step="0.5" value="12" class="input-slider">
                                <span id="pd-etapa2-valor" class="input-value">12%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Etapa 3 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa3" min="1" max="100" step="1" value="30" class="input-slider">
                                <span id="pd-etapa3-valor" class="input-value">30%</span>
                            </div>
                        </div>
                        <div class="flex items-center mt-4">
                            <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                            <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Protección Rodando (-50% provisiones)</label>
                        </div>
                    </div>

                    <!-- Operaciones -->
                    <div class="card">
                        <div class="section-header">Operaciones</div>
                        <div class="niif-explanation">
                            <div class="niif-header">NIIF 15 - Ingresos de Actividades Ordinarias</div>
                            <p class="text-sm text-gray-700">
                                Establece los principios para el reconocimiento de ingresos por la venta
                                de bienes, prestación de servicios y contratos con clientes.
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margen por Originación (%)</label>
                            <div class="input-container">
                                <input type="range" id="margen-originacion" min="5" max="20" step="0.5" value="10" class="input-slider">
                                <span id="margen-originacion-valor" class="input-value">10%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Comisión GNV (%)</label>
                            <div class="input-container">
                                <input type="range" id="comision-gnv" min="5" max="15" step="0.5" value="8" class="input-slider">
                                <span id="comision-gnv-valor" class="input-value">8%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margen Refacciones (%)</label>
                            <div class="input-container">
                                <input type="range" id="margen-refacciones" min="15" max="35" step="1" value="25" class="input-slider">
                                <span id="margen-refacciones-valor" class="input-value">25%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Gastos Operativos (%)</label>
                            <div class="input-container">
                                <input type="range" id="opex-rate" min="5" max="30" step="1" value="15" class="input-slider">
                                <span id="opex-rate-valor" class="input-value">15%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Capital -->
                    <div class="card">
                        <div class="section-header">Capital</div>
                        <div class="input-group">
                            <label class="input-label">Serie A Capital Inicial (M MXN)</label>
                            <div class="input-container">
                                <input type="range" id="serie-a" min="30" max="60" step="1" value="45" class="input-slider">
                                <span id="serie-a-valor" class="input-value">45M</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">% Venture Debt sobre Inversión</label>
                            <div class="input-container">
                                <input type="range" id="venture-debt-pct" min="50" max="90" step="5" value="70" class="input-slider">
                                <span id="venture-debt-pct-valor" class="input-value">70%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Venture Debt (%)</label>
                            <div class="input-container">
                                <input type="range" id="venture-debt-rate" min="8" max="18" step="0.5" value="12" class="input-slider">
                                <span id="venture-debt-rate-valor" class="input-value">12%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Período Amortización Deuda (Años)</label>
                            <div class="input-container">
                                <input type="range" id="amortizacion-deuda" min="3" max="7" step="1" value="5" class="input-slider">
                                <span id="amortizacion-deuda-valor" class="input-value">5 años</span>
                            </div>
                        </div>
                    </div>

                    <!-- Activos y NIIF 5 -->
                    <div class="card">
                        <div class="section-header">Activos y NIIF 5</div>
                        <div class="niif-explanation">
                            <div class="niif-header">NIIF 5 - Activos No Corrientes Mantenidos para la Venta</div>
                            <p class="text-sm text-gray-700">
                                Establece el tratamiento contable para activos que se mantienen para su
                                venta, incluyendo medición, presentación e información a revelar.
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Costo Vagoneta (MXN)</label>
                            <input type="number" id="costo-vagoneta" min="500000" max="800000" step="1000" value="641000" class="p-2 border rounded w-full">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Precio Financiado al Cliente (MXN)</label>
                            <input type="number" id="precio-financiado" min="600000" max="900000" step="1000" value="729000" class="p-2 border rounded w-full">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Reposesión (%)</label>
                            <div class="input-container">
                                <input type="range" id="tasa-reposicion" min="1" max="15" step="0.5" value="15" class="input-slider">
                                <span id="tasa-reposicion-valor" class="input-value">15%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Fair Value Venta (%)</label>
                            <div class="input-container">
                                <input type="range" id="fair-value" min="70" max="95" step="1" value="85" class="input-slider">
                                <span id="fair-value-valor" class="input-value">85%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Costos de Venta (%)</label>
                            <div class="input-container">
                                <input type="range" id="costos-venta" min="1" max="10" step="0.5" value="5" class="input-slider">
                                <span id="costos-venta-valor" class="input-value">5%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unidades por Año -->
            <div class="card mt-6">
                <div class="section-header">Unidades por Año</div>
                <div class="niif-explanation">
                    <p class="text-sm text-gray-700">
                        Las vagonetas son activos fijos en el balance de RAG. Los ingresos
                        provienen de intereses del financiamiento y servicios auxiliares,
                        no de la venta de las vagonetas.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="units-container">
                    <div class="flex flex-col">
                        <label class="input-label">Año 1</label>
                        <input type="number" id="unit-year-1" min="0" max="1000" value="35" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">Año 2</label>
                        <input type="number" id="unit-year-2" min="0" max="1000" value="70" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">Año 3</label>
                        <input type="number" id="unit-year-3" min="0" max="1000" value="100" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">Año 4</label>
                        <input type="number" id="unit-year-4" min="0" max="1000" value="150" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">Año 5</label>
                        <input type="number" id="unit-year-5" min="0" max="1000" value="200" class="p-2 border rounded">
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <div>
                        <button id="btn-base" class="bg-blue-500 text-white px-4 py-2 rounded font-medium">Escenario Base</button>
                        <button id="btn-optimista" class="bg-green-500 text-white px-4 py-2 rounded font-medium ml-2">Optimista</button>
                        <button id="btn-conservador" class="bg-yellow-500 text-white px-4 py-2 rounded font-medium ml-2">Conservador</button>
                    </div>
                    <button id="btn-recalcular" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">🔄 Recalcular Modelo</button>
                </div>
                <div id="error-messages" class="mt-4"></div>
            </div>
        </div>

        <!-- Estados Financieros -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 0</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4">
                        <!-- Balance validation message -->
                    </div>
                </div>
            </div>
        </div>

        <!-- NIIF -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos</h3>
                    <div class="niif-explanation">
                        <p>
                            <strong>Objetivo:</strong> Establecer los principios que una entidad
                            aplicará al reportar información sobre la naturaleza, importe,
                            momento y incertidumbre de los ingresos de actividades ordinarias
                            procedentes de contratos con clientes.
                        </p>
                        <p class="mt-2">
                            <strong>Aplicación en RAG:</strong> Los ingresos por intereses se
                            reconocen en función del tiempo transcurrido utilizando el método
                            del interés efectivo. El margen por originación se reconoce como
                            un servicio al momento de formalizar el contrato de financiamiento.
                        </p>
                    </div>
                    <div id="niif15-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 9 - Instrumentos Financieros</h3>
                    <div class="niif-explanation">
                        <p>
                            <strong>Objetivo:</strong> Establecer los requisitos para el
                            reconocimiento y medición de activos financieros,
                            pasivos financieros y algunos contratos de compra o venta de artivos no
                            financieros.
                        </p>
                        <p class="mt-2">
                            <strong>Aplicación en RAG:</strong> Las cuentas por cobrar se
                            clasifican como activos financieros medidos al costo amortizado.
                            Se aplica un modelo de deterioro crediticio en tres etapas basado en el
                            riesgo de incumplimiento.
                        </p>
                    </div>
                    <div id="niif9-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos No Corrientes Mantenidos para la Venta</h3>
                    <div class="niif-explanation">
                        <p>
                            <strong>Objetivo:</strong> Especificar el tratamiento contable para
                            los activos no corrientes mantenidos para la venta,
                            y la presentación e información a revelar sobre las operaciones
                            discontinuadas.
                        </p>
                        <p class="mt-2">
                            <strong>Aplicación en RAG:</strong> Las vagonetas repossessadas se
                            reclasifican como activos mantenidos para la venta.
                            Se miden al menor valor entre su valor en libros y su valor razonable
                            menos los costos de venta.
                        </p>
                    </div>
                    <div id="niif5-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evolución de EBITDA</h4>
                    <div style="height: 300px;"><canvas id="ebitdaChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Composición de Ingresos (Año 5)</h4>
                    <div style="height: 300px;"><canvas id="revenueMixChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evolución del Patrimonio</h4>
                    <div style="height: 300px;"><canvas id="equityChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Deterioro Crediticio por Etapas (NIIF 9)</h4>
                    <div style="height: 300px;"><canvas id="provisionChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES =====
        const modelData = {
            tasaInteres: 40.0,
            tasaMorosidad: 19.5,
            lgd: 80,
            pdEtapa2: 12,
            pdEtapa3: 30,
            proteccionRodando: true,
            margenOriginacion: 10,
            comisionGNV: 8,
            margenRefacciones: 25,
            opexRate: 15,
            serieA: 45000000,
            ventureDebtPct: 70,
            ventureDebtRate: 12,
            amortizacionDeuda: 5,
            costoVagoneta: 641000,
            precioFinanciado: 729000,
            tasaReposicion: 15,
            fairValue: 85,
            costosVenta: 5,
            depreciationYears: 10,
            unitsPerYear: [35, 70, 100, 150, 200],
            gnvRevPerUnit: 12000,
            refaccionesRevPerUnit: 50000,
            marketplaceRevPerUnit: 5000,
            marketplace: 1
        };

        let financialResults = {
            pl: [],
            cf: [],
            bs: [],
            niifDetails: [],
            tirProyecto: 0,
            tirCartera: 0,
            loanPortfolios: [] // Para seguimiento de carteras por año
        };

        let charts = {};
        let recalculationTimeout;
        let recalculationInProgress = false;

        // ===== INICIALIZACIÓN DE LA INTERFAZ =====
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupControls();
            setupScenarios();
            initializeCharts();
            calculateFinancials();
            updateUI();
        });

        // ===== CONFIGURACIÓN DE PESTAÑAS =====
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));

                    this.classList.add('active');
                    
                    const tabId = this.id;
                    let contentId;
                    switch(tabId) {
                        case 'tab-control': contentId = 'content-control'; break;
                        case 'tab-financieros': contentId = 'content-financieros'; break;
                        case 'tab-niif': contentId = 'content-niif'; break;
                        case 'tab-graficos': contentId = 'content-graficos'; break;
                    }
                    
                    if (contentId) {
                        document.getElementById(contentId).classList.add('active');
                    }
                });
            });
        }

        // ===== CONFIGURACIÓN DE CONTROLES =====
        function setupControls() {
            // Configurar controles deslizantes
            const sliders = [
                { id: 'tasa-interes', prop: 'tasaInteres', format: v => v.toFixed(1) + '%' },
                { id: 'tasa-morosidad', prop: 'tasaMorosidad', format: v => v + '%' },
                { id: 'lgd', prop: 'lgd', format: v => v + '%' },
                { id: 'pd-etapa2', prop: 'pdEtapa2', format: v => v + '%' },
                { id: 'pd-etapa3', prop: 'pdEtapa3', format: v => v + '%' },
                { id: 'margen-originacion', prop: 'margenOriginacion', format: v => v + '%' },
                { id: 'comision-gnv', prop: 'comisionGNV', format: v => v + '%' },
                { id: 'margen-refacciones', prop: 'margenRefacciones', format: v => v + '%' },
                { id: 'opex-rate', prop: 'opexRate', format: v => v + '%' },
                { id: 'serie-a', prop: 'serieA', format: v => (v/1000000).toFixed(0) + 'M' },
                { id: 'venture-debt-pct', prop: 'ventureDebtPct', format: v => v + '%' },
                { id: 'venture-debt-rate', prop: 'ventureDebtRate', format: v => v + '%' },
                { id: 'amortizacion-deuda', prop: 'amortizacionDeuda', format: v => v + ' años' },
                { id: 'tasa-reposicion', prop: 'tasaReposicion', format: v => v + '%' },
                { id: 'fair-value', prop: 'fairValue', format: v => v + '%' },
                { id: 'costos-venta', prop: 'costosVenta', format: v => v + '%' }
            ];

            sliders.forEach(config => {
                const slider = document.getElementById(config.id);
                const display = document.getElementById(`${config.id}-valor`);
                if (slider && display) {
                    slider.value = modelData[config.prop];
                    display.textContent = config.format(modelData[config.prop]);
                    
                    // Actualización en tiempo real con debounce
                    slider.addEventListener('input', function() {
                        const value = parseFloat(this.value);
                        modelData[config.prop] = value;
                        display.textContent = config.format(value);
                        debouncedRecalculate();
                    });
                }
            });

            // Configurar campos numéricos
            const numberInputs = [
                { id: 'costo-vagoneta', prop: 'costoVagoneta' },
                { id: 'precio-financiado', prop: 'precioFinanciado' }
            ];

            numberInputs.forEach(input => {
                const element = document.getElementById(input.id);
                if (element) {
                    element.value = modelData[input.prop];
                    element.addEventListener('change', function() {
                        modelData[input.prop] = parseInt(this.value) || 0;
                        debouncedRecalculate();
                    });
                }
            });

            // Configurar checkbox
            const checkbox = document.getElementById('check-proteccion');
            if (checkbox) {
                checkbox.checked = modelData.proteccionRodando;
                checkbox.addEventListener('change', function() {
                    modelData.proteccionRodando = this.checked;
                    debouncedRecalculate();
                });
            }

            // Configurar unidades por año
            for (let year = 1; year <= 5; year++) {
                const input = document.getElementById(`unit-year-${year}`);
                if (input) {
                    input.addEventListener('change', function() {
                        const value = parseInt(this.value) || 0;
                        modelData.unitsPerYear[year-1] = Math.max(0, Math.min(1000, value));
                        debouncedRecalculate();
                    });
                }
            }

            // Configurar botón de recalcular
            const btnRecalcular = document.getElementById('btn-recalcular');
            if (btnRecalcular) {
                btnRecalcular.addEventListener('click', function() {
                    calculateFinancials();
                    updateUI();
                });
            }
        }

        // Debounce para recálculos
        function debouncedRecalculate() {
            clearTimeout(recalculationTimeout);
            recalculationTimeout = setTimeout(() => {
                if (!recalculationInProgress) {
                    recalculationInProgress = true;
                    calculateFinancials();
                    updateUI();
                    recalculationInProgress = false;
                }
            }, 500);
        }

        // ===== CONFIGURACIÓN DE ESCENARIOS =====
        function setupScenarios() {
            const scenarios = {
                base: {
                    tasaInteres: 40.0,
                    tasaMorosidad: 19.5,
                    lgd: 80,
                    pdEtapa2: 12,
                    pdEtapa3: 30,
                    proteccionRodando: true,
                    margenOriginacion: 10,
                    comisionGNV: 8,
                    margenRefacciones: 25,
                    opexRate: 15,
                    ventureDebtPct: 70,
                    ventureDebtRate: 12,
                    unitsPerYear: [35, 70, 100, 150, 200]
                },
                optimista: {
                    tasaInteres: 42.5,
                    tasaMorosidad: 15,
                    lgd: 70,
                    pdEtapa2: 8,
                    pdEtapa3: 20,
                    proteccionRodando: true,
                    margenOriginacion: 12,
                    comisionGNV: 10,
                    margenRefacciones: 28,
                    opexRate: 14,
                    ventureDebtPct: 75,
                    ventureDebtRate: 10,
                    unitsPerYear: [40, 80, 120, 180, 250]
                },
                conservador: {
                    tasaInteres: 37.5,
                    tasaMorosidad: 25,
                    lgd: 90,
                    pdEtapa2: 18,
                    pdEtapa3: 45,
                    proteccionRodando: false,
                    margenOriginacion: 8,
                    comisionGNV: 7,
                    margenRefacciones: 22,
                    opexRate: 18,
                    ventureDebtPct: 65,
                    ventureDebtRate: 14,
                    unitsPerYear: [30, 60, 80, 120, 150]
                }
            };

            // Configurar botones de escenarios
            document.getElementById('btn-base').addEventListener('click', () => applyScenario(scenarios.base));
            document.getElementById('btn-optimista').addEventListener('click', () => applyScenario(scenarios.optimista));
            document.getElementById('btn-conservador').addEventListener('click', () => applyScenario(scenarios.conservador));
        }

        function applyScenario(scenario) {
            Object.keys(scenario).forEach(key => {
                if (modelData.hasOwnProperty(key)) {
                    modelData[key] = scenario[key];
                }
            });
            updateControlsUI();
            calculateFinancials();
            updateUI();
        }

        function updateControlsUI() {
            // Actualizar controles deslizantes
            document.getElementById('tasa-interes').value = modelData.tasaInteres;
            document.getElementById('tasa-interes-valor').textContent = modelData.tasaInteres.toFixed(1) + '%';
            document.getElementById('tasa-morosidad').value = modelData.tasaMorosidad;
            document.getElementById('tasa-morosidad-valor').textContent = modelData.tasaMorosidad + '%';
            document.getElementById('lgd').value = modelData.lgd;
            document.getElementById('lgd-valor').textContent = modelData.lgd + '%';
            document.getElementById('pd-etapa2').value = modelData.pdEtapa2;
            document.getElementById('pd-etapa2-valor').textContent = modelData.pdEtapa2 + '%';
            document.getElementById('pd-etapa3').value = modelData.pdEtapa3;
            document.getElementById('pd-etapa3-valor').textContent = modelData.pdEtapa3 + '%';
            document.getElementById('opex-rate').value = modelData.opexRate;
            document.getElementById('opex-rate-valor').textContent = modelData.opexRate + '%';

            // Actualizar unidades
            for (let year = 1; year <= 5; year++) {
                const input = document.getElementById(`unit-year-${year}`);
                if (input) {
                    input.value = modelData.unitsPerYear[year-1];
                }
            }

            // Actualizar checkbox
            document.getElementById('check-proteccion').checked = modelData.proteccionRodando;
        }

        // ===== LÓGICA FINANCIERA (NIIF COMPLIANT) =====
        function calculateFinancials() {
            // Reiniciar resultados
            financialResults = { pl: [], cf: [], bs: [], niifDetails: [], tirProyecto: 0, tirCartera: 0, loanPortfolios: [] };
            const errorContainer = document.getElementById('error-messages');
            errorContainer.innerHTML = '';

            // Validar unidades por año
            modelData.unitsPerYear = modelData.unitsPerYear.map(units => {
                return Math.max(0, Math.min(1000, parseInt(units) || 0));
            });

            // Variables de estado
            let accumulatedEarnings = 0;
            let cash = 0;
            let accumulatedDepreciation = 0;
            let totalDebt = 0;
            let cumulativeUnits = 0;
            let currentProvisionsBalance = 0;
            const projectCashFlows = [];
            const portfolioCashFlows = [];
            let totalInvestment = 0;
            let loanPortfolioBalance = 0;
            let loanPortfolio = []; // [{ amount, year }]
            
            // Precalcular amortización para un préstamo
            function calculateAmortizationSchedule(principal, rate, term) {
                const r = rate / 100;
                const payment = principal * r / (1 - Math.pow(1 + r, -term));
                let balance = principal;
                const schedule = [];
                
                for (let i = 0; i < term; i++) {
                    const interest = balance * r;
                    const principalPayment = payment - interest;
                    balance -= principalPayment;
                    schedule.push({
                        interest,
                        principal: principalPayment,
                        balance
                    });
                }
                
                return schedule;
            }

            // Year 0 - Capital inicial
            const initialEquity = modelData.serieA;
            const initialDebt = initialEquity * (modelData.ventureDebtPct / 100);
            cash = initialEquity + initialDebt;
            totalDebt += initialDebt;
            
            projectCashFlows.push(-initialEquity); // Inversión inicial de equity

            // Precalcular amortización para préstamos a clientes
            const loanSchedule = calculateAmortizationSchedule(
                modelData.precioFinanciado, 
                modelData.tasaInteres, 
                5
            );
            
            // Precalcular amortización para deuda venture
            const ventureDebtSchedule = calculateAmortizationSchedule(
                totalDebt,
                modelData.ventureDebtRate,
                modelData.amortizacionDeuda
            );

            // Años 1-5
            for (let year = 0; year < 5; year++) {
                const addedUnits = modelData.unitsPerYear[year];
                cumulativeUnits += addedUnits;

                // --- CÁLCULO DE INGRESOS (NIIF 15) ---
                // Método de interés efectivo para cada cartera de préstamos
                let interestRevenue = 0;
                let principalPayments = 0;
                
                // Procesar carteras existentes
                const newLoanPortfolio = [];
                for (const portfolio of loanPortfolio) {
                    const age = year - portfolio.year;
                    if (age < 5) { // Préstamo aún activo
                        const schedule = loanSchedule[age];
                        interestRevenue += portfolio.units * schedule.interest;
                        principalPayments += portfolio.units * schedule.principal;
                        
                        // Mantener préstamos activos
                        if (schedule.balance > 0) {
                            newLoanPortfolio.push({
                                units: portfolio.units,
                                amount: portfolio.units * schedule.balance,
                                year: portfolio.year
                            });
                        }
                    }
                }
                
                // Agregar nuevos préstamos
                if (addedUnits > 0) {
                    newLoanPortfolio.push({
                        units: addedUnits,
                        amount: addedUnits * modelData.precioFinanciado,
                        year: year
                    });
                    interestRevenue += addedUnits * loanSchedule[0].interest;
                }
                
                loanPortfolio = newLoanPortfolio;
                loanPortfolioBalance = loanPortfolio.reduce((sum, p) => sum + p.amount, 0);
                financialResults.loanPortfolios[year] = [...loanPortfolio];
                
                // --- INGRESOS ADICIONALES (NIIF 15) ---
                // Distribuir el margen durante la vida del préstamo (5 años)
                const margenOriginacionAnual = (addedUnits * modelData.precioFinanciado * (modelData.margenOriginacion / 100)) / 5;
                const gnvCommissions = cumulativeUnits * modelData.gnvRevPerUnit * (modelData.comisionGNV / 100);
                const sparePartsRevenue = addedUnits * modelData.refaccionesRevPerUnit * (modelData.margenRefacciones / 100);
                const marketplaceRevenue = cumulativeUnits * modelData.marketplaceRevPerUnit * (modelData.marketplace / 100);
                const totalRevenue = interestRevenue + margenOriginacionAnual + gnvCommissions + sparePartsRevenue + marketplaceRevenue;

                // --- GASTOS OPERATIVOS ---
                const opex = totalRevenue * (modelData.opexRate / 100);

                // --- PROVISIONES NIIF 9 (MODELO DE 3 ETAPAS) ---
                // Calcular exposición por antigüedad
                let exposureStage1 = 0;
                let exposureStage2 = 0;
                let exposureStage3 = 0;

                loanPortfolio.forEach(portfolio => {
                    const age = year - portfolio.year;
                    if (age < 1) exposureStage1 += portfolio.amount;
                    else if (age < 3) exposureStage2 += portfolio.amount;
                    else exposureStage3 += portfolio.amount;
                });
                
                // Calcular pérdidas esperadas por etapa
                const eclStage1 = exposureStage1 * (modelData.tasaMorosidad / 100) * (modelData.lgd / 100);
                const eclStage2 = exposureStage2 * (modelData.pdEtapa2 / 100) * (modelData.lgd / 100);
                const eclStage3 = exposureStage3 * (modelData.pdEtapa3 / 100) * (modelData.lgd / 100);
                
                let provisions = eclStage1 + eclStage2 + eclStage3;
                
                // Aplicar protección rodante si está activa
                if (modelData.proteccionRodando) {
                    provisions *= 0.5;
                }
                
                currentProvisionsBalance += provisions;

                // --- CAPEX Y DEPRECIACIÓN ---
                const capexThisYear = addedUnits * modelData.costoVagoneta;
                totalInvestment += capexThisYear;
                
                // Depreciar cada cohorte por separado
                const annualDepreciation = modelData.unitsPerYear
                    .slice(0, year + 1)
                    .reduce((sum, units, y) => {
                        const cohortDepreciation = units * modelData.costoVagoneta / modelData.depreciationYears;
                        return sum + cohortDepreciation * Math.min(1, year - y + 1);
                    }, 0);
                    
                accumulatedDepreciation += annualDepreciation;

                // --- NIIF 5: ACTIVOS MANTENIDOS PARA VENTA ---
                const heldForSaleUnits = cumulativeUnits * (modelData.tasaReposicion / 100);
                // Calcular depreciación acumulada por unidad específica
                const carryingAmountPerVan = modelData.costoVagoneta * (1 - (year + 1) / modelData.depreciationYears);
                const carryingAmountHeldForSale = heldForSaleUnits * carryingAmountPerVan;
                const fairValue = carryingAmountHeldForSale * (modelData.fairValue / 100);
                const costsToSell = fairValue * (modelData.costosVenta / 100);
                const fairValueLessCosts = fairValue - costsToSell;
                const impairment = Math.max(0, carryingAmountHeldForSale - fairValueLessCosts);

                // --- DEUDA VENTURE ---
                const interestExpense = totalDebt * (modelData.ventureDebtRate / 100);
                const principalPayment = (year === 0) ? 0 : totalDebt / modelData.amortizacionDeuda;
                const newDebt = capexThisYear * (modelData.ventureDebtPct / 100);
                const capitalCall = capexThisYear * (1 - modelData.ventureDebtPct / 100);
                totalDebt = totalDebt + newDebt - principalPayment;

                // --- RESULTADOS ---
                const ebitda = totalRevenue - opex - provisions - impairment;
                const netIncome = ebitda - annualDepreciation - interestExpense;
                accumulatedEarnings += netIncome;

                // --- FLUJO DE EFECTIVO ---
                const operatingCash = netIncome + annualDepreciation + provisions + impairment + principalPayments;
                const investingCash = -capexThisYear;
                const financingCash = (year === 0) ? 
                    initialEquity + initialDebt : 
                    newDebt - principalPayment + capitalCall;

                const netCash = operatingCash + investingCash + financingCash;
                cash += netCash;

                // --- BALANCE GENERAL ---
                const fixedAssetsNet = (cumulativeUnits * modelData.costoVagoneta) - accumulatedDepreciation - carryingAmountHeldForSale;
                const totalAssets = cash + loanPortfolioBalance + fixedAssetsNet + fairValueLessCosts;
                const equity = initialEquity + accumulatedEarnings;
                const totalLiabilitiesEquity = totalDebt + currentProvisionsBalance + equity;

                // Almacenar resultados
                financialResults.pl.push({
                    year: year + 1,
                    interestRevenue,
                    margenOriginacion: margenOriginacionAnual,
                    gnvCommissions,
                    sparePartsRevenue,
                    marketplaceRevenue,
                    totalRevenue,
                    opex,
                    provisions,
                    impairment,
                    ebitda,
                    annualDepreciation,
                    interestExpense,
                    netIncome
                });

                financialResults.cf.push({
                    operatingCash,
                    investingCash,
                    financingCash,
                    netCash
                });

                financialResults.bs.push({
                    cash,
                    receivables: loanPortfolioBalance,
                    fixedAssets: fixedAssetsNet,
                    assetsHeldForSale: fairValueLessCosts,
                    totalAssets,
                    debt: totalDebt,
                    provisions: currentProvisionsBalance,
                    equity,
                    totalLiabilitiesEquity
                });

                // Almacenar detalles NIIF
                financialResults.niifDetails.push({
                    niif15: {
                        valorNominal: interestRevenue,
                        valorPresente: interestRevenue * 0.92,
                        margenOriginacion: margenOriginacionAnual
                    },
                    niif9: {
                        etapa1: eclStage1,
                        etapa2: eclStage2,
                        etapa3: eclStage3,
                        total: provisions,
                        proteccionRodando: modelData.proteccionRodando
                    },
                    niif5: {
                        carryingAmount: carryingAmountHeldForSale,
                        fairValue,
                        costsToSell,
                        fairValueLessCosts,
                        impairment,
                        unitsHeldForSale: heldForSaleUnits
                    }
                });

                // Flujos para TIR
                projectCashFlows.push(netCash);
                
                // Flujos de cartera con desembolso inicial
                const portfolioCashFlow = (year === 0) 
                    ? -addedUnits * modelData.costoVagoneta 
                    : interestRevenue - provisions;
                portfolioCashFlows.push(portfolioCashFlow);
            }

            // Calcular TIR Proyecto
            financialResults.tirProyecto = calculateIRR(projectCashFlows);

            // Calcular TIR Cartera
            financialResults.tirCartera = calculateIRR(portfolioCashFlows);
        }

        // ===== FUNCIÓN PARA CALCULAR TIR =====
        function calculateIRR(cashFlows, maxIter = 100, tol = 0.0001) {
            if (!cashFlows || cashFlows.length < 2) return 0;
            const hasPositive = cashFlows.some(cf => cf > 0);
            const hasNegative = cashFlows.some(cf => cf < 0);
            if (!hasPositive || !hasNegative) return 0;

            let rate = 0.1; // Tasa inicial estimada
            
            for (let i = 0; i < maxIter; i++) {
                let npv = 0;
                let derivative = 0;
                
                for (let t = 0; t < cashFlows.length; t++) {
                    npv += cashFlows[t] / Math.pow(1 + rate, t);
                    derivative -= t * cashFlows[t] / Math.pow(1 + rate, t + 1);
                }
                
                if (Math.abs(npv) < tol) break;
                
                const newRate = rate - npv / derivative;
                if (Math.abs(newRate - rate) < tol) break;
                
                rate = newRate;
            }
            
            return Math.min(100, Math.max(-100, rate * 100));
        }

        // ===== ACTUALIZACIÓN DE LA INTERFAZ =====
        function updateUI() {
            // Actualizar tarjetas resumen
            if (financialResults.pl.length >= 5) {
                document.getElementById('ebitda-year5').textContent = formatCurrency(financialResults.pl[4].ebitda);
                document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                document.getElementById('vagonetas-total').textContent = modelData.unitsPerYear.reduce((a, b) => a + b, 0);
                document.getElementById('deuda-residual').textContent = formatCurrency(financialResults.bs[4].debt);
            }

            // Actualizar tablas
            updateTables();
            updateNIIFTables();
            updateCharts(); // Actualizar gráficos siempre
        }

        function formatCurrency(value) {
            if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K MXN';
            return '$' + Math.round(value).toLocaleString();
        }

        function updateTables() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
        }

        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            // Encabezados
            const headers = [
                'Ingresos por Intereses',
                'Margen por Originación',
                'Comisiones GNV',
                'Ingresos Refacciones',
                'Ingresos Marketplace',
                'Total Ingresos',
                'Gastos Operativos',
                'Provisiones NIIF 9',
                'Pérdida Deterioro NIIF 5',
                'EBITDA',
                'Depreciación',
                'Intereses Deuda',
                'Utilidad Neta'
            ];

            headers.forEach(header => {
                const row = document.createElement('tr');
                const headerCell = document.createElement('td');
                headerCell.textContent = header;
                headerCell.classList.add('font-medium');
                row.appendChild(headerCell);

                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value = 0;
                    if (financialResults.pl[i]) {
                        switch(header) {
                            case 'Ingresos por Intereses': value = financialResults.pl[i].interestRevenue; break;
                            case 'Margen por Originación': value = financialResults.pl[i].margenOriginacion; break;
                            case 'Comisiones GNV': value = financialResults.pl[i].gnvCommissions; break;
                            case 'Ingresos Refacciones': value = financialResults.pl[i].sparePartsRevenue; break;
                            case 'Ingresos Marketplace': value = financialResults.pl[i].marketplaceRevenue; break;
                            case 'Total Ingresos': value = financialResults.pl[i].totalRevenue; break;
                            case 'Gastos Operativos': value = financialResults.pl[i].opex; break;
                            case 'Provisiones NIIF 9': value = financialResults.pl[i].provisions; break;
                            case 'Pérdida Deterioro NIIF 5': value = financialResults.pl[i].impairment; break;
                            case 'EBITDA': value = financialResults.pl[i].ebitda; break;
                            case 'Depreciación': value = financialResults.pl[i].annualDepreciation; break;
                            case 'Intereses Deuda': value = financialResults.pl[i].interestExpense; break;
                            case 'Utilidad Neta': value = financialResults.pl[i].netIncome; break;
                        }
                    }
                    cell.textContent = formatCurrency(value);

                    // Resaltar totales
                    if (header === 'Total Ingresos' || header === 'EBITDA' || header === 'Utilidad Neta') {
                        cell.classList.add('font-bold');
                    }

                    // Resaltar valores positivos/negativos
                    if (value > 0 && !header.includes('Gastos') && 
                        !header.includes('Provisiones') && !header.includes('Pérdida')) {
                        cell.classList.add('positive');
                    } else if (value < 0) {
                        cell.classList.add('negative');
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            });
        }

        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            // Encabezados
            const headers = [
                'Serie A Recibida',
                'Venture Debt Recibido',
                'Capital Calls',
                'Flujo Operativo',
                'Flujo Inversión',
                'Flujo Financiero',
                'Flujo Neto'
            ];

            headers.forEach(header => {
                const row = document.createElement('tr');
                const headerCell = document.createElement('td');
                headerCell.textContent = header;
                headerCell.classList.add('font-medium');
                row.appendChild(headerCell);

                for (let year = 0; year <= 5; year++) {
                    const cell = document.createElement('td');
                    let value = 0;

                    if (year === 0) {
                        if (header === 'Serie A Recibida') {
                            value = modelData.serieA * (1 - modelData.ventureDebtPct / 100);
                        } else if (header === 'Venture Debt Recibido') {
                            value = modelData.serieA * (modelData.ventureDebtPct / 100);
                        } else if (header === 'Capital Calls') {
                            value = 0;
                        }
                    } else {
                        const idx = year - 1;
                        if (financialResults.cf[idx]) {
                            switch(header) {
                                case 'Flujo Operativo': value = financialResults.cf[idx].operatingCash; break;
                                case 'Flujo Inversión': value = financialResults.cf[idx].investingCash; break;
                                case 'Flujo Financiero': value = financialResults.cf[idx].financingCash; break;
                                case 'Flujo Neto': value = financialResults.cf[idx].netCash; break;
                                case 'Capital Calls': 
                                    // Calcular capital call para este año
                                    const capexThisYear = modelData.unitsPerYear[idx] * modelData.costoVagoneta;
                                    value = capexThisYear * (1 - modelData.ventureDebtPct / 100);
                                    break;
                            }
                        }
                    }
                    cell.textContent = formatCurrency(value);

                    // Resaltar flujo neto
                    if (header === 'Flujo Neto') {
                        cell.classList.add('font-bold');
                    }

                    // Resaltar valores positivos/negativos
                    if (value > 0) {
                        cell.classList.add('positive');
                    } else if (value < 0) {
                        cell.classList.add('negative');
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            });
        }

        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            const validationDiv = document.getElementById('balance-validation');
            validationDiv.innerHTML = '';

            // Encabezados
            const headers = [
                'Efectivo',
                'Cuentas por Cobrar',
                'Activos Fijos (Neto)',
                'Activos para Venta (NIIF 5)',
                'Total Activos',
                'Deuda Venture',
                'Provisiones NIIF 9',
                'Patrimonio',
                'Total Pasivo + Patrimonio'
            ];

            headers.forEach(header => {
                const row = document.createElement('tr');
                const headerCell = document.createElement('td');
                headerCell.textContent = header;
                headerCell.classList.add('font-medium');
                row.appendChild(headerCell);

                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value = 0;
                    if (financialResults.bs[i]) {
                        switch(header) {
                            case 'Efectivo': value = financialResults.bs[i].cash; break;
                            case 'Cuentas por Cobrar': value = financialResults.bs[i].receivables; break;
                            case 'Activos Fijos (Neto)': value = financialResults.bs[i].fixedAssets; break;
                            case 'Activos para Venta (NIIF 5)': value = financialResults.bs[i].assetsHeldForSale; break;
                            case 'Total Activos': value = financialResults.bs[i].totalAssets; break;
                            case 'Deuda Venture': value = financialResults.bs[i].debt; break;
                            case 'Provisiones NIIF 9': value = financialResults.bs[i].provisions; break;
                            case 'Patrimonio': value = financialResults.bs[i].equity; break;
                            case 'Total Pasivo + Patrimonio': value = financialResults.bs[i].totalLiabilitiesEquity; break;
                        }
                    }
                    cell.textContent = formatCurrency(value);

                    // Resaltar totales
                    if (header === 'Total Activos' || header === 'Total Pasivo + Patrimonio') {
                        cell.classList.add('font-bold');
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            });

            // Validar balance para todos los años
            let validationHTML = '';
            financialResults.bs.forEach((balance, index) => {
                const diff = Math.abs(balance.totalAssets - balance.totalLiabilitiesEquity);
                if (diff > 1000) {
                    validationHTML += `
                        <div class="balance-error">
                            <p>❌ Desequilibrio en año ${index + 1}: ${formatCurrency(diff)}</p>
                        </div>
                    `;
                }
            });
            
            if (validationHTML) {
                validationDiv.innerHTML = `
                    <div class="validation-error">
                        <p>Se encontraron desequilibrios contables:</p>
                        ${validationHTML}
                        <p class="text-sm mt-2">Revisar cálculos de activos, pasivos y patrimonio</p>
                    </div>
                `;
            } else if (financialResults.bs.length > 0) {
                validationDiv.innerHTML = `
                    <div class="validation-success">
                        <p>✅ Balance validado para todos los años (Activo = Pasivo + Patrimonio)</p>
                    </div>
                `;
            }
        }

        function updateNIIFTables() {
            if (financialResults.niifDetails.length < 5) return;

            // NIIF 15
            const niif15Container = document.getElementById('niif15-container');
            if (niif15Container) {
                niif15Container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Año 1</th>
                                    <th>Año 2</th>
                                    <th>Año 3</th>
                                    <th>Año 4</th>
                                    <th>Año 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Ingresos por Intereses (Valor Nominal)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.valorNominal)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos por Intereses (Valor Presente)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.valorPresente)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Margen por Originación (NIIF 15)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.margenOriginacion)}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // NIIF 9
            const niif9Container = document.getElementById('niif9-container');
            if (niif9Container) {
                const lastYear = financialResults.niifDetails[4].niif9;
                niif9Container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="p-4 bg-green-50 rounded-lg text-center">
                            <h5 class="font-semibold">Etapa 1 - Riesgo Bajo</h5>
                            <p class="text-lg font-bold">${formatCurrency(lastYear.etapa1)}</p>
                            <p class="text-sm">12 meses de pérdidas esperadas</p>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg text-center">
                            <h5 class="font-semibold">Etapa 2 - Riesgo Significativo</h5>
                            <p class="text-lg font-bold">${formatCurrency(lastYear.etapa2)}</p>
                            <p class="text-sm">Pérdidas de vida completa</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg text-center">
                            <h5 class="font-semibold">Etapa 3 - Deteriorado</h5>
                            <p class="text-lg font-bold">${formatCurrency(lastYear.etapa3)}</p>
                            <p class="text-sm">Pérdidas esperadas con colateral</p>
                        </div>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h5 class="font-semibold text-center">Total Provisiones NIIF 9: ${formatCurrency(lastYear.total)}</h5>
                        <p class="text-center mt-2">
                            ${lastYear.proteccionRodando ? 
                              '✅ Protección Rodando activa (reducción del 50% en provisiones)' : 
                              '❌ Protección Rodando inactiva'}
                        </p>
                    </div>
                `;
            }

            // NIIF 5
            const niif5Container = document.getElementById('niif5-container');
            if (niif5Container) {
                const lastYear = financialResults.niifDetails[4].niif5;
                niif5Container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <h5 class="font-semibold">Activos para Venta</h5>
                            <p class="text-lg">${Math.round(lastYear.unitsHeldForSale)} unidades</p>
                        </div>
                        <div class="p-4 bg-indigo-50 rounded-lg">
                            <h5 class="font-semibold">Valor en Libros</h5>
                            <p class="text-lg">${formatCurrency(lastYear.carryingAmount)}</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h5 class="font-semibold">Valor Razonable Neto</h5>
                            <p class="text-lg">${formatCurrency(lastYear.fairValueLessCosts)}</p>
                        </div>
                        <div class="p-4 ${lastYear.impairment > 0 ? 'bg-red-50' : 'bg-green-50'} rounded-lg">
                            <h5 class="font-semibold">Pérdida por Deterioro</h5>
                            <p class="text-lg">${lastYear.impairment > 0 ? formatCurrency(lastYear.impairment) : 'Ninguna'}</p>
                        </div>
                    </div>
                `;
            }
        }

        // ===== GRÁFICOS =====
        function initializeCharts() {
            const ctx1 = document.getElementById('ebitdaChart');
            if (ctx1) {
                charts.ebitda = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                        datasets: [{
                            label: 'EBITDA (M MXN)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Evolución del EBITDA'
                            }
                        }
                    }
                });
            }

            const ctx2 = document.getElementById('revenueMixChart');
            if (ctx2) {
                charts.revenueMix = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Intereses', 'Margen Originación', 'Comisiones GNV', 'Refacciones', 'Marketplace'],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            const ctx3 = document.getElementById('equityChart');
            if (ctx3) {
                charts.equity = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                        datasets: [{
                            label: 'Patrimonio (M MXN)',
                            data: [],
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Evolución del Patrimonio'
                            }
                        }
                    }
                });
            }

            const ctx4 = document.getElementById('provisionChart');
            if (ctx4) {
                charts.provision = new Chart(ctx4, {
                    type: 'bar',
                    data: {
                        labels: ['Año 1', 'Año 2', 'Año 3', 'Año 4', 'Año 5'],
                        datasets: [
                            {
                                label: 'Etapa 1',
                                data: [],
                                backgroundColor: '#10b981'
                            },
                            {
                                label: 'Etapa 2',
                                data: [],
                                backgroundColor: '#f59e0b'
                            },
                            {
                                label: 'Etapa 3',
                                data: [],
                                backgroundColor: '#ef4444'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Evolución de Provisiones por Etapas (NIIF 9)'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true
                            }
                        }
                    }
                });
            }
        }

        function updateCharts() {
            // Actualizar gráfico de EBITDA
            if (charts.ebitda && financialResults.pl.length >= 5) {
                const ebitdaData = financialResults.pl.map(p => p.ebitda / 1000000);
                charts.ebitda.data.datasets[0].data = ebitdaData;
                charts.ebitda.update();
            }

            // Actualizar gráfico de composición de ingresos
            if (charts.revenueMix && financialResults.pl.length >= 5) {
                const lastYear = financialResults.pl[4];
                const revenueData = [
                    lastYear.interestRevenue,
                    lastYear.margenOriginacion,
                    lastYear.gnvCommissions,
                    lastYear.sparePartsRevenue,
                    lastYear.marketplaceRevenue
                ];
                charts.revenueMix.data.datasets[0].data = revenueData;
                charts.revenueMix.update();
            }

            // Actualizar gráfico de patrimonio
            if (charts.equity && financialResults.bs.length >= 5) {
                const equityData = financialResults.bs.map(b => b.equity / 1000000);
                charts.equity.data.datasets[0].data = equityData;
                charts.equity.update();
            }

            // Actualizar gráfico de provisiones
            if (charts.provision && financialResults.niifDetails.length >= 5) {
                const etapa1Data = financialResults.niifDetails.map(n => n.niif9.etapa1 / 1000);
                const etapa2Data = financialResults.niifDetails.map(n => n.niif9.etapa2 / 1000);
                const etapa3Data = financialResults.niifDetails.map(n => n.niif9.etapa3 / 1000);
                charts.provision.data.datasets[0].data = etapa1Data;
                charts.provision.data.datasets[1].data = etapa2Data;
                charts.provision.data.datasets[2].data = etapa3Data;
                charts.provision.update();
            }
        }
    </script>
</body>
</html>
