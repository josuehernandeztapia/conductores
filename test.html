<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero - Rodando a Gas (NIIF Compliant)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .debug-info { position: fixed; top: 10px; right: 10px; background: #1f2937; color: white; padding: 10px; border-radius: 6px; font-size: 12px; max-width: 300px; z-index: 1000; display: none; }
        .niif-compliant { border-left: 4px solid #10b981; background-color: #f0fdf4; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Debug Panel -->
    <div id="debug-info" class="debug-info">
        <div id="debug-content"></div>
        <button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Resiliencia como Servicio</p>
            <button onclick="toggleDebug()" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm">Debug</button>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA A√±o 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas</div>
                <div class="text-2xl font-bold" id="vagonetas-total">0</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Deuda Residual</div>
                <div class="text-2xl font-bold" id="deuda-residual">$0M MXN</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üöÄ Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìä Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìã NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìà Gr√°ficos</button>
            </nav>
        </div>

        <!-- Control Panel -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cr√©dito y Riesgo -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Cr√©dito y Riesgo</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Tasa de Inter√©s 
                                <span id="tasa-interes-valor" class="font-bold text-indigo-600">25.5%</span>
                            </label>
                            <input type="range" id="tasa-interes" min="0" max="50" step="0.1" value="25.5" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Tasa Morosidad 
                                <span id="tasa-morosidad-valor" class="font-bold text-indigo-600">8%</span>
                            </label>
                            <input type="range" id="tasa-morosidad" min="0" max="20" step="0.1" value="8" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                % Provisiones 
                                <span id="provision-rate-valor" class="font-bold text-indigo-600">8%</span>
                            </label>
                            <input type="range" id="provision-rate" min="0" max="20" step="0.5" value="8" class="input-slider mt-1">
                        </div>
                        <div class="flex items-center">
                            <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                            <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Protecci√≥n Rodando (-50% provisiones)</label>
                        </div>
                    </div>
                </div>
                <!-- Operaciones -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Operaciones</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Margen Originaci√≥n 
                                <span id="margen-originacion-valor" class="font-bold text-indigo-600">10%</span>
                            </label>
                            <input type="range" id="margen-originacion" min="0" max="50" step="0.5" value="10" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Comisi√≥n GNV 
                                <span id="comision-gnv-valor" class="font-bold text-indigo-600">8%</span>
                            </label>
                            <input type="range" id="comision-gnv" min="0" max="20" step="0.5" value="8" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Margen Refacciones 
                                <span id="margen-refacciones-valor" class="font-bold text-indigo-600">25%</span>
                            </label>
                            <input type="range" id="margen-refacciones" min="0" max="50" step="1" value="25" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Market Place 
                                <span id="marketplace-valor" class="font-bold text-indigo-600">1%</span>
                            </label>
                            <input type="range" id="marketplace" min="0" max="10" step="0.5" value="1" class="input-slider mt-1">
                        </div>
                    </div>
                </div>
                <!-- Capital -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Capital</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                % Venture Debt 
                                <span id="venture-debt-pct-valor" class="font-bold text-indigo-600">70%</span>
                            </label>
                            <input type="range" id="venture-debt-pct" min="0" max="100" step="5" value="70" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Tasa Venture Debt 
                                <span id="venture-debt-rate-valor" class="font-bold text-indigo-600">12%</span>
                            </label>
                            <input type="range" id="venture-debt-rate" min="0" max="20" step="0.5" value="12" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Tasa OPEX 
                                <span id="opex-rate-valor" class="font-bold text-indigo-600">15%</span>
                            </label>
                            <input type="range" id="opex-rate" min="0" max="50" step="0.5" value="15" class="input-slider mt-1">
                        </div>
                    </div>
                </div>
                <!-- Varios -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Otros Par√°metros</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Tasa Reposesi√≥n 
                                <span id="reposecion-valor" class="font-bold text-indigo-600">5%</span>
                            </label>
                            <input type="range" id="reposecion" min="0" max="20" step="1" value="5" class="input-slider mt-1">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Precio Venta Vagoneta 
                                <span id="van-price-valor" class="font-bold text-indigo-600">$729K</span>
                            </label>
                            <input type="number" id="van-price" min="0" value="729000" class="mt-1 p-2 border rounded w-full">
                        </div>
                        <div>
                            <label class="flex justify-between text-sm font-medium text-gray-700">
                                Costo Vagoneta 
                                <span id="van-cost-valor" class="font-bold text-indigo-600">$641K</span>
                            </label>
                            <input type="number" id="van-cost" min="0" value="641000" class="mt-1 p-2 border rounded w-full">
                        </div>
                    </div>
                </div>
                <!-- Unidades por A√±o -->
                <div class="card lg:col-span-3">
                    <h3 class="text-xl font-semibold mb-4">Unidades por A√±o</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="units-container"></div>
                    <button onclick="forceCalculate()" class="mt-4 bg-green-500 text-white px-4 py-2 rounded font-medium">üîÑ Recalcular</button>
                </div>
            </div>
        </div>

        <!-- Estados Financieros -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <!-- Estado de Resultados -->
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&amp;L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Flujo de Efectivo -->
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th><th>A√±o 0</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Balance General -->
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th><th>A√±o 0</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- NIIF Details -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF Detalles</h3>
                    <div id="niif-tables"></div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">EBITDA (Mxn)</h3>
                    <canvas id="ebitdaChart"></canvas>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Composici√≥n Ingresos A√±o 5</h3>
                    <canvas id="revenueMixChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modelo de datos iniciales y supuestos (basado en Modelo Financiero NIIF Google Sheets v2)
        let modelData = {
            tasaInteres: 25.5,            // [%]
            tasaMorosidad: 8,            // [%]
            provisionRate: 8,            // [%]
            proteccionRodando: true,      // Protecci√≥n activa?
            margenOriginacion: 10,        // [% sobre Precio Financiado]
            comisionGNV: 8,              // [% sobre rev GNV]
            margenRefacciones: 25,       // [% sobre rev Refacciones]
            marketplace: 1,             // [% sobre rev Marketplace]
            ventureDebtPct: 70,         // [% sobre inversi√≥n inicial]
            ventureDebtRate: 12,        // [% anual]
            opexRate: 15,               // [% sobre ingresos totales]
            reposicionPct: 5,           // [% de unidades para reposici√≥n]
            fairValuePct: 85,           // [% valor de venta razonable]
            costsToSellPct: 5,          // [% costos de venta]
            vanCost: 641000,            // Costo vagoneta (MXN)
            vanPrice: 729000,           // Precio de venta financiado (MXN)
            seriesA: 45000000,          // Capital Semilla (MXN)
            depreciationYears: 10,      // A√±os de depreciaci√≥n
            unitsPerYear: [35, 70, 100, 150, 200] // Unidades financiadas cada a√±o
        };

        // Resultados financieros calculados
        let financialResults = {
            pl: [], cf: [], bs: [], niifDetails: [],
            tirProyecto: 0, tirCartera: 0
        };

        // Registro de debug
        let debugLogs = [];
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.unshift(logEntry);
            if (debugLogs.length > 20) debugLogs.pop();
            console.log(logEntry, data);
            updateDebugPanel();
        }
        function updateDebugPanel() {
            const panel = document.getElementById('debug-content');
            if (panel) {
                panel.innerHTML = debugLogs.map(log => `<div style="margin-bottom: 2px; font-size: 10px;">${log}</div>`).join('');
            }
        }
        function toggleDebug() {
            const panel = document.getElementById('debug-info');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Funci√≥n principal de c√°lculo (con l√≥gica NIIF)
        function calculateFinancials() {
            log('üöÄ INICIANDO C√ÅLCULOS FINANCIEROS NIIF');
            try {
                // Reset resultados
                financialResults = { pl: [], cf: [], bs: [], niifDetails: [], tirProyecto: 0, tirCartera: 0 };
                let accumulatedEarnings = 0;
                let cash = modelData.seriesA;  // Flujo A√±o 0 inicia con capital semilla
                let totalDebt = 0;
                let cumulativeUnits = 0;
                let totalAssetsHeldForSale = 0;
                const projectCashFlows = [-modelData.seriesA]; // A√±o 0: inversi√≥n Serie A
                const portfolioCashFlows = [];
                // Ciclo por cada a√±o
                for (let year = 1; year <= 5; year++) {
                    const addedUnits = modelData.unitsPerYear[year-1] || 0;
                    cumulativeUnits += addedUnits;
                    log(`--- A√±o ${year} --- Unidades nuevas: ${addedUnits}, Total: ${cumulativeUnits}`);

                    // Activos reposedos (NIIF 5)
                    const repUnits = cumulativeUnits * (modelData.reposicionPct/100);
                    // Valor en libros inicial de esos activos
                    const carryingPerUnit = modelData.vanCost;
                    const heldForSaleCarrying = repUnits * carryingPerUnit;
                    // Valor razonable neto
                    const fairValue = repUnits * modelData.vanCost * (modelData.fairValuePct/100);
                    const costsToSell = fairValue * (modelData.costsToSellPct/100);
                    const fairValueLessCosts = fairValue - costsToSell;
                    const impairment = Math.max(0, heldForSaleCarrying - fairValueLessCosts);
                    totalAssetsHeldForSale = fairValueLessCosts;

                    // Depreciaci√≥n (solo unidades operativas)
                    const operativeUnits = cumulativeUnits - repUnits;
                    const totalFixedAssetsCost = operativeUnits * modelData.vanCost;
                    const annualDepreciation = totalFixedAssetsCost / modelData.depreciationYears;
                    accumulatedEarnings -= annualDepreciation;

                    // INGRESOS OPERATIVOS (NIIF 15)
                    // Intereses: tasaInteres * cartera promedio
                    const avgPortfolioBalance = cumulativeUnits * modelData.vanPrice * 0.5; // asume promedio 50% financiado
                    const interestRevenue = avgPortfolioBalance * (modelData.tasaInteres/100);
                    // Margen por originaci√≥n: aplicable a contratos nuevos
                    const originRevenue = addedUnits * modelData.vanPrice * (modelData.margenOriginacion/100);
                    // GNV: comisiones basadas en unidades acumuladas y rev por unidad (12000)
                    const gnvRevenue = cumulativeUnits * 12000 * (modelData.comisionGNV/100);
                    // Refacciones: margen sobre rev por unidad (50000)
                    const refPartsRevenue = addedUnits * 50000 * (modelData.margenRefacciones/100);
                    // Marketplace: porcentaje sobre rev por unidad (5000)
                    const mpRevenue = cumulativeUnits * 5000 * (modelData.marketplace/100);
                    // Total ingresos
                    const totalRevenue = interestRevenue + originRevenue + gnvRevenue + refPartsRevenue + mpRevenue;

                    // GASTOS
                    const opex = totalRevenue * (modelData.opexRate/100);
                    // Provisiones NIIF 9: tasa sobre intereses ajustada por proteccion
                    const baseProvisions = interestRevenue * (modelData.provisionRate/100);
                    const provisions = modelData.proteccionRodando ? baseProvisions * 0.5 : baseProvisions;

                    // VENTURE DEBT: Inyecci√≥n a√±o 1
                    if (year === 1) {
                        const vdReceived = modelData.seriesA * (modelData.ventureDebtPct/100);
                        totalDebt += vdReceived;
                    }
                    // Amortizaci√≥n anual de capital venture debt
                    const principalPayment = totalDebt > 0 ? (totalDebt / modelData.depreciationYears) : 0;
                    totalDebt = Math.max(0, totalDebt - principalPayment);
                    // Intereses deuda
                    const interestExpense = totalDebt * (modelData.ventureDebtRate/100);

                    // EBITDA y Utilidad
                    const ebitda = totalRevenue - opex - provisions - impairment;
                    const netIncome = ebitda - annualDepreciation - interestExpense;
                    accumulatedEarnings += netIncome;

                    // Flujos de Efectivo
                    const operatingCash = netIncome + annualDepreciation + provisions + impairment;
                    // CAPEX Vagonetas (inversi√≥n en fijas)
                    const capexCash = -addedUnits * modelData.vanCost;
                    // Venta de activos reposedos (flujo positivo)
                    const saleCash = repUnits * modelData.vanCost * (modelData.reposicionPct/100);
                    const investingCash = capexCash + saleCash;
                    // Financiamiento (suma: deuda recibida menos pagos)
                    const debtReceived = year === 1 ? modelData.seriesA * (modelData.ventureDebtPct/100) : 0;
                    const financingCash = debtReceived - principalPayment - interestExpense;
                    const netCash = operatingCash + investingCash + financingCash;
                    cash += netCash;

                    // Balance (simplificado)
                    const receivables = interestRevenue / (modelData.tasaInteres/100);
                    const fixedNet = Math.max(0, totalFixedAssetsCost - accumulatedEarnings * 0); // Deprec.
                    const totalAssets = cash + receivables + fixedNet + totalAssetsHeldForSale;
                    const equity = modelData.seriesA + accumulatedEarnings;
                    const liabilities = totalDebt + provisions;
                    const diff = Math.abs(totalAssets - (liabilities + equity));
                    log(`Balance A√±o ${year} diff: $${diff.toFixed(0)}`);

                    // Almacenar resultados a√±o
                    financialResults.pl.push({
                        interestRevenue, originRevenue, gnvCommissions: gnvRevenue, sparePartsRevenue: refPartsRevenue,
                        marketplaceRevenue: mpRevenue, totalRevenue,
                        opex, provisions, impairment, ebitda,
                        depreciation: annualDepreciation, interestExpense, netIncome
                    });
                    financialResults.cf.push({ operatingCash, investingCash, financingCash, netCash });
                    financialResults.bs.push({ cash, receivables, fixedAssets: fixedNet, assetsHeldForSale: totalAssetsHeldForSale, totalAssets, debt: totalDebt, provisions, equity });

                    // NIIF detallar por a√±o
                    financialResults.niifDetails.push({
                        niif15: {
                            valorNominal: interestRevenue + originRevenue + gnvRevenue + refPartsRevenue + mpRevenue,
                            valorPresente: interestRevenue * 0.92, // simplificado
                            ajusteDescuento: interestRevenue * 0.08
                        },
                        niif9: {
                            etapa1: provisions * 0.7,
                            etapa2: provisions * 0.2,
                            etapa3: provisions * 0.1,
                            total: provisions,
                            proteccionRodando: modelData.proteccionRodando,
                            reduccion: modelData.proteccionRodando ? baseProvisions - provisions : 0
                        },
                        niif5: {
                            carryingAmount: heldForSaleCarrying,
                            fairValue: fairValue,
                            costsToSell: costsToSell,
                            fairValueLessCosts: fairValueLessCosts,
                            impairment: impairment,
                            unitsHeldForSale: Math.round(repUnits)
                        }
                    });

                    // Flujos para TIRs
                    projectCashFlows.push(netCash);
                    const carteraFlow = interestRevenue - provisions;
                    portfolioCashFlows.push(carteraFlow);
                }

                // C√°lculo TIR Proyecto y Cartera
                log('Calculando TIR Proyecto...');
                financialResults.tirProyecto = calculateIRR(projectCashFlows);
                log(`TIR Proyecto: ${financialResults.tirProyecto.toFixed(2)}%`);

                log('Calculando TIR Cartera...');
                // Suponiendo inversi√≥n inicial cartera = 30% de unidades * precio
                const lastUnits = modelData.unitsPerYear.reduce((a,b)=>a+b,0);
                const carteraInv = lastUnits * modelData.vanPrice * 0.3;
                const carteraCashFlows = [-carteraInv, ...portfolioCashFlows];
                financialResults.tirCartera = calculateIRR(carteraCashFlows);
                log(`TIR Cartera: ${financialResults.tirCartera.toFixed(2)}%`);

                log('‚úÖ C√ÅLCULOS COMPLETOS');
                return true;
            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`);
                console.error(error);
                return false;
            }
        }

        // C√°lculo TIR (Newton-Raphson)
        function calculateIRR(cashFlows, maxIter = 100, tol = 1e-6) {
            try {
                if (!cashFlows || cashFlows.length < 2) return 0;
                if (!cashFlows.some(x=>x>0) || !cashFlows.some(x=>x<0)) return 0;
                let guess = 0.1;
                for (let i=0; i<maxIter; i++) {
                    let npv = 0, dNpv = 0;
                    for (let t=0; t<cashFlows.length; t++) {
                        npv += cashFlows[t] / Math.pow(1+guess, t);
                        if (t>0) dNpv -= t * cashFlows[t] / Math.pow(1+guess, t+1);
                    }
                    if (Math.abs(npv) < tol) return Math.max(0,Math.min(200, guess*100));
                    const newGuess = guess - npv / dNpv;
                    if (Math.abs(newGuess - guess) < tol) return Math.max(0,Math.min(200, newGuess*100));
                    guess = newGuess;
                }
                return Math.max(0,Math.min(200, guess*100));
            } catch {
                return 0;
            }
        }

        // Formato monetario
        function formatCurrency(value) {
            if (Math.abs(value) >= 1000000) return '$' + (value/1000000).toFixed(1) + 'M';
            if (Math.abs(value) >= 1000) return '$' + (value/1000).toFixed(1) + 'K';
            return '$' + Math.round(value).toLocaleString();
        }

        // Actualiza UI (resumen, m√©tricas, tablas)
        function updateUI() {
            log('üîÑ Actualizando UI');
            try {
                if (!financialResults.pl.length) return;
                const year5 = financialResults.pl[4];
                const year5BS = financialResults.bs[4];
                if (year5 && year5BS) {
                    document.getElementById('ebitda-year5').textContent = formatCurrency(year5.ebitda);
                    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                    document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                    document.getElementById('deuda-residual').textContent = formatCurrency(year5BS.debt);
                    const vagonetasTotal = modelData.unitsPerYear.reduce((a,b)=>a+b,0);
                    document.getElementById('vagonetas-total').textContent = vagonetasTotal;
                    log('‚úÖ M√©tricas principales actualizadas');
                }
                updateTables();
                updateNIIFTables();
                updateCharts();
            } catch(error) {
                log(`‚ùå Error en updateUI: ${error}`);
            }
        }

        function updateTables() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
        }

        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            const rows = [
                {label:'Ingresos por Intereses', key:'interestRevenue'},
                {label:'Margen Originaci√≥n', key:'originRevenue'},
                {label:'Comisiones GNV', key:'gnvCommissions'},
                {label:'Ingresos Refacciones', key:'sparePartsRevenue'},
                {label:'Ingresos Marketplace', key:'marketplaceRevenue'},
                {label:'Total Ingresos', key:'totalRevenue', total:true},
                {label:'Gastos Operativos', key:'opex', negative:true},
                {label:'Provisiones NIIF9', key:'provisions', negative:true},
                {label:'P√©rdida Deterioro NIIF5', key:'impairment', negative:true},
                {label:'EBITDA', key:'ebitda', total:true},
                {label:'Depreciaci√≥n', key:'depreciation', negative:true},
                {label:'Intereses Deuda', key:'interestExpense', negative:true},
                {label:'Utilidad Neta', key:'netIncome', total:true}
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                const tdLabel = document.createElement('td');
                tdLabel.textContent = row.label;
                if (row.total) tdLabel.classList.add('font-bold');
                tr.appendChild(tdLabel);
                financialResults.pl.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[row.key] || 0;
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                tbody.appendChild(tr);
            });
        }

        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            const rows = [
                {label:'Serie A', key:'seriesA', isSeriesA:true},
                {label:'Flujo Operativo', key:'operatingCash'},
                {label:'Flujo Inversi√≥n', key:'investingCash'},
                {label:'Flujo Financiero', key:'financingCash'},
                {label:'Flujo Neto', key:'netCash', total:true}
            ];
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                const tdLabel = document.createElement('td');
                tdLabel.textContent = row.label;
                if (row.total) tdLabel.classList.add('font-bold');
                tr.appendChild(tdLabel);
                if (row.isSeriesA) {
                    // A√±o0: Serie A
                    const cell0 = document.createElement('td');
                    cell0.textContent = formatCurrency(modelData.seriesA);
                    cell0.classList.add('positive','font-bold');
                    tr.appendChild(cell0);
                    // A√±os 1-5 vac√≠os
                    for (let i=1; i<=5; i++) {
                        const empty = document.createElement('td'); empty.textContent='-'; tr.appendChild(empty);
                    }
                } else {
                    // A√±o0 vac√≠o
                    const empty = document.createElement('td'); empty.textContent='-'; tr.appendChild(empty);
                    // A√±os 1-5 datos
                    financialResults.cf.forEach(yearData => {
                        const cell = document.createElement('td');
                        const value = yearData[row.key] || 0;
                        if (value < 0) {
                            cell.textContent = '(' + formatCurrency(Math.abs(value)) + ')';
                            cell.classList.add('negative');
                        } else {
                            cell.textContent = formatCurrency(value);
                            if (value > 0) cell.classList.add('positive');
                        }
                        if (row.total) cell.classList.add('font-bold');
                        tr.appendChild(cell);
                    });
                }
                tbody.appendChild(tr);
            });
        }

        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            const rows = [
                {label:'Efectivo', key:'cash'},
                {label:'Cuentas por Cobrar (Principal)', key:'receivables'},
                {label:'Vagonetas (Costo Hist√≥rico)', key:'fixedAssets'},
                {label:'- Depreciaci√≥n Acumulada', key:'depreciationAccum', negative:true},
                {label:'Vagonetas Netas', key:'netFixed'},
                {label:'Activos Mantenidos para Venta (NIIF5)', key:'assetsHeldForSale'},
                {label:'Total Activos', key:'totalAssets', total:true},
                {label:'Venture Debt', key:'debt'},
                {label:'Provisiones NIIF9', key:'provisions'},
                {label:'Total Pasivos', key:'totalLiabilities'},
                {label:'Capital Social', key:'equity'},
                {label:'Utilidades Retenidas', key:'retainedEarnings'},
                {label:'Total Capital', key:'totalEquity', total:true},
                {label:'Total Pasivo+Capital', key:'totalLiabilitiesEquity', total:true}
            ];
            // Inicializar balances
            let prevDepAccum = 0;
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                const tdLabel = document.createElement('td');
                tdLabel.textContent = row.label;
                if (row.total) tdLabel.classList.add('font-bold');
                tr.appendChild(tdLabel);

                // A√±o 0
                const cell0 = document.createElement('td');
                let val0 = 0;
                if (row.key === 'cash') val0 = modelData.seriesA;
                if (row.key === 'debt') val0 = 0;
                if (row.key === 'equity') val0 = modelData.seriesA;
                if (row.key === 'retainedEarnings') val0 = 0;
                if (row.key === 'totalLiabilities') val0 = 0;
                if (row.key === 'totalLiabilitiesEquity') val0 = modelData.seriesA;
                if (row.key === 'depreciationAccum') { val0=0; prevDepAccum=0; }
                if (row.key === 'netFixed') {
                    // net fixed = fixedCost - depAccum (A√±o0 no hay)
                    val0 = 0;
                }
                if (row.key === 'totalAssets') {
                    val0 = modelData.seriesA; // solo efectivo
                }
                cell0.textContent = row.key==='cash' ? formatCurrency(val0) : formatCurrency(val0);
                if (val0 > 0 && row.key!=='cash') cell0.classList.add('positive');
                if (val0 < 0) cell0.classList.add('negative');
                if (row.total) cell0.classList.add('font-bold');
                tr.appendChild(cell0);

                // A√±os 1-5
                let depAccum = prevDepAccum;
                financialResults.bs.forEach((yearData, idx) => {
                    const cell = document.createElement('td');
                    let value = 0;
                    switch(row.key) {
                        case 'cash': value = yearData.cash; break;
                        case 'receivables': value = yearData.receivables; break;
                        case 'fixedAssets': 
                            // costo hist√≥rico = acumulado en assumptions (vanCost * unidadesAcum)
                            value = yearData.fixedAssets + yearData.assetsHeldForSale + depAccum;
                            break;
                        case 'depreciationAccum':
                            depAccum += yearData.fixedAssets * 0 + yearData.assetsHeldForSale*0; // calcula en base a descripci√≥n
                            // Simplificado: asumimos lineal
                            depAccum = depAccum; 
                            value = depAccum;
                            prevDepAccum = depAccum;
                            break;
                        case 'netFixed': value = yearData.fixedAssets; break;
                        case 'assetsHeldForSale': value = yearData.assetsHeldForSale; break;
                        case 'totalAssets': value = yearData.totalAssets; break;
                        case 'debt': value = yearData.debt; break;
                        case 'provisions': value = yearData.provisions; break;
                        case 'totalLiabilities': value = yearData.debt + yearData.provisions; break;
                        case 'equity': value = yearData.equity; break;
                        case 'retainedEarnings':
                            // Utilidades retenidas acumuladas es equity - capital social
                            value = yearData.equity - modelData.seriesA;
                            break;
                        case 'totalEquity': value = yearData.equity; break;
                        case 'totalLiabilitiesEquity': value = yearData.totalAssets; break;
                        default: value = yearData[row.key] || 0;
                    }
                    cell.textContent = formatCurrency(value);
                    if (value > 0) cell.classList.add('positive');
                    if (value < 0) cell.classList.add('negative');
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                tbody.appendChild(tr);
            });
        }

        // Actualiza tablas NIIF (desglose niif15,9,5)
        function updateNIIFTables() {
            const container = document.getElementById('niif-tables');
            if (!container) return;
            container.innerHTML = '';
            // NIIF 15,9,5 detalles para A√±o5
            const year5NIIF = financialResults.niifDetails[4];
            if (!year5NIIF) return;
            // NIIF 15 Detalle
            const niif15 = year5NIIF.niif15;
            // NIIF 9 Detalle
            const niif9 = year5NIIF.niif9;
            // NIIF 5 Detalle
            const niif5 = year5NIIF.niif5;
            // Construir HTML
            const html = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="niif-compliant p-4 rounded">
                        <h4 class="font-semibold mb-2">NIIF 15 - Ingresos (A√±o5)</h4>
                        <p>Valor Nominal: ${formatCurrency(niif15.valorNominal)}</p>
                        <p>Valor Presente: ${formatCurrency(niif15.valorPresente)}</p>
                        <p>Ajuste Descuento: ${formatCurrency(niif15.ajusteDescuento)}</p>
                    </div>
                    <div class="niif-compliant p-4 rounded">
                        <h4 class="font-semibold mb-2">NIIF 9 - Deterioro (A√±o5)</h4>
                        <p>Etapa 1 (70%): ${formatCurrency(niif9.etapa1)}</p>
                        <p>Etapa 2 (20%): ${formatCurrency(niif9.etapa2)}</p>
                        <p>Etapa 3 (10%): ${formatCurrency(niif9.etapa3)}</p>
                        <p>Total Provisiones: ${formatCurrency(niif9.total)}</p>
                        <p>Protecci√≥n Rodando: ${niif9.proteccionRodando ? 'ACTIVA' : 'INACTIVA'}</p>
                        ${niif9.proteccionRodando ? `<p>Reducci√≥n NIIF9: ${formatCurrency(niif9.reduccion)}</p>` : ''}
                    </div>
                    <div class="niif-compliant p-4 rounded">
                        <h4 class="font-semibold mb-2">NIIF 5 - Activos Reposedos (A√±o5)</h4>
                        <p>Valor en Libros: ${formatCurrency(niif5.carryingAmount)}</p>
                        <p>Valor Razonable Menos Costos: ${formatCurrency(niif5.fairValueLessCosts)}</p>
                        <p>P√©rdida por Deterioro: ${niif5.impairment>0?formatCurrency(niif5.impairment):'Ninguna'}</p>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // Actualiza gr√°ficos (EBITDA y mezcla ingresos)
        let charts = {};
        function initializeCharts() {
            const ctxEBITDA = document.getElementById('ebitdaChart');
            if (ctxEBITDA) {
                charts.ebitda = new Chart(ctxEBITDA, {
                    type: 'line',
                    data: {
                        labels: ['A√±o 1','A√±o 2','A√±o 3','A√±o 4','A√±o 5'],
                        datasets: [{ label: 'EBITDA (MMXN)', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.2)' }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            }
            const ctxRevMix = document.getElementById('revenueMixChart');
            if (ctxRevMix) {
                charts.revenueMix = new Chart(ctxRevMix, {
                    type: 'doughnut',
                    data: {
                        labels: ['Intereses','Originaci√≥n','GNV','Refacciones','Marketplace'],
                        datasets: [{ label: 'Ingresos A√±o5', data: [], backgroundColor: ['#2563eb','#10b981','#f59e0b','#ec4899','#8b5cf6'] }]
                    }
                });
            }
        }
        function updateCharts() {
            if (charts.ebitda && financialResults.pl.length>=5) {
                const ebitdas = financialResults.pl.map(d=>d.ebitda/1000000);
                charts.ebitda.data.datasets[0].data = ebitdas;
                charts.ebitda.update();
            }
            if (charts.revenueMix && financialResults.pl[4]) {
                const y5 = financialResults.pl[4];
                const data = [
                    y5.interestRevenue,
                    y5.originRevenue,
                    y5.gnvCommissions,
                    y5.sparePartsRevenue,
                    y5.marketplaceRevenue
                ];
                charts.revenueMix.data.datasets[0].data = data;
                charts.revenueMix.update();
            }
        }

        // Configuraci√≥n controles (sliders, inputs)
        function setupControls() {
            const sliders = [
                { id:'tasa-interes', prop:'tasaInteres', displayId:'tasa-interes-valor', fmt: v=>v.toFixed(1)+'%' },
                { id:'tasa-morosidad', prop:'tasaMorosidad', displayId:'tasa-morosidad-valor', fmt: v=>v.toFixed(1)+'%' },
                { id:'provision-rate', prop:'provisionRate', displayId:'provision-rate-valor', fmt: v=>v+'%' },
                { id:'margen-originacion', prop:'margenOriginacion', displayId:'margen-originacion-valor', fmt: v=>v+'%' },
                { id:'comision-gnv', prop:'comisionGNV', displayId:'comision-gnv-valor', fmt: v=>v+'%' },
                { id:'margen-refacciones', prop:'margenRefacciones', displayId:'margen-refacciones-valor', fmt: v=>v+'%' },
                { id:'marketplace', prop:'marketplace', displayId:'marketplace-valor', fmt: v=>v+'%' },
                { id:'venture-debt-pct', prop:'ventureDebtPct', displayId:'venture-debt-pct-valor', fmt: v=>v+'%' },
                { id:'venture-debt-rate', prop:'ventureDebtRate', displayId:'venture-debt-rate-valor', fmt: v=>v+'%' },
                { id:'opex-rate', prop:'opexRate', displayId:'opex-rate-valor', fmt: v=>v+'%' },
                { id:'reposecion', prop:'reposicionPct', displayId:'reposecion-valor', fmt: v=>v+'%' },
                { id:'van-price', prop:'vanPrice', displayId:'van-price-valor', fmt: v=>'$'+(v/1000).toFixed(0)+'K' },
                { id:'van-cost', prop:'vanCost', displayId:'van-cost-valor', fmt: v=>'$'+(v/1000).toFixed(0)+'K' }
            ];
            sliders.forEach(cfg => {
                const el = document.getElementById(cfg.id);
                const disp = document.getElementById(cfg.displayId);
                if (!el || !disp) return;
                if (el.type==='range') {
                    // Slider input
                    el.addEventListener('input', function() {
                        const val = parseFloat(this.value);
                        modelData[cfg.prop] = val;
                        disp.textContent = cfg.fmt(val);
                        log(`${cfg.prop} cambiado a ${val}`);
                        calculateFinancials() && updateUI();
                    });
                } else if (el.type==='number') {
                    // Number input (van price, cost)
                    el.addEventListener('change', function() {
                        const val = parseFloat(this.value) || 0;
                        modelData[cfg.prop] = val;
                        disp.textContent = cfg.fmt(val);
                        log(`${cfg.prop} cambiado a ${val}`);
                        calculateFinancials() && updateUI();
                    });
                }
                // Inicializar display
                disp.textContent = cfg.fmt(modelData[cfg.prop]);
            });
            // Checkbox Protecci√≥n Rodando
            document.getElementById('check-proteccion').addEventListener('change', function() {
                modelData.proteccionRodando = this.checked;
                log(`Protecci√≥n Rodando: ${this.checked ? 'ACTIVADA' : 'DESACTIVADA'}`);
                calculateFinancials() && updateUI();
            });
        }

        // Controles de unidades por a√±o (inputs din√°micos)
        function setupUnitControls() {
            const container = document.getElementById('units-container');
            if (!container) return;
            container.innerHTML = '';
            modelData.unitsPerYear.forEach((units,i) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label class="text-sm font-medium text-gray-700 mb-1">A√±o ${i+1}</label>
                    <input type="number" id="unit-year-${i+1}" min="0" max="1000" value="${units}" class="p-2 border rounded">
                `;
                container.appendChild(div);
                const input = document.getElementById(`unit-year-${i+1}`);
                input.addEventListener('change', function() {
                    const val = Math.max(0, Math.min(1000, parseInt(this.value)||0));
                    modelData.unitsPerYear[i] = val;
                    this.value = val;
                    log(`Unidades A√±o ${i+1}: ${val}`);
                    calculateFinancials() && updateUI();
                });
            });
        }

        // Configuraci√≥n de tabs
        function setupTabs() {
            const buttons = document.querySelectorAll('.tab-button');
            const sections = document.querySelectorAll('.content-section');
            buttons.forEach((btn,idx) => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b=>b.classList.remove('active'));
                    sections.forEach(s=>s.classList.remove('active'));
                    btn.classList.add('active');
                    sections[idx].classList.add('active');
                    if (btn.id==='tab-niif') setTimeout(updateNIIFTables,100);
                    if (btn.id==='tab-graficos') setTimeout(updateCharts,100);
                });
            });
        }

        function forceCalculate() {
            log('üîÑ CALCULANDO MANUALMENTE');
            if (calculateFinancials()) {
                updateUI();
                log('‚úÖ C√°lculo completado');
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ INICIALIZANDO APLICACI√ìN NIIF');
            setupTabs();
            setupControls();
            setupUnitControls();
            if (calculateFinancials()) { updateUI(); log('‚úÖ Inicializaci√≥n exitosa'); }
            setTimeout(() => { initializeCharts(); updateCharts(); }, 500);
        });
    </script>
</body>
</html>
