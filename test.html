<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero Interactivo - Rodando a Gas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos base */
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; } /* Verde para valores positivos */
        .negative { color: #dc2626; } /* Rojo para valores negativos */
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .debug-info { position: fixed; top: 10px; right: 10px; background: #1f2937; color: white; padding: 10px; border-radius: 6px; font-size: 12px; max-width: 300px; z-index: 1000; display: none; }
        .niif-compliant { border-left: 4px solid #10b981; background-color: #f0fdf4; }

        /* Estilos para el panel de validaci칩n */
        #validation-panel {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .validation-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .validation-item.error { background-color: #fee2e2; border-left: 4px solid #ef4444; } /* red-200 / red-500 */
        .validation-item.warning { background-color: #fffbeb; border-left: 4px solid #f59e0b; } /* amber-100 / amber-500 */
        .validation-item.info { background-color: #e0f2fe; border-left: 4px solid #3b82f6; } /* light-blue-100 / blue-500 */
        .validation-item.passed { background-color: #d1fae5; border-left: 4px solid #10b981; } /* green-100 / green-500 */
        .validation-icon {
            font-size: 1.25rem; /* 20px */
            margin-right: 0.75rem; /* 12px */
            line-height: 1;
        }
        .validation-item.error .validation-icon { color: #ef4444; }
        .validation-item.warning .validation-icon { color: #f59e0b; }
        .validation-item.info .validation-icon { color: #3b82f6; }
        .validation-item.passed .validation-icon { color: #10b981; }
        .validation-message {
            flex-grow: 1;
            font-size: 0.875rem; /* 14px */
            color: #374151; /* gray-700 */
        }
        .validation-message strong { font-weight: 600; }
        .validation-message ul { list-style: disc; padding-left: 1.25rem; margin-top: 0.25rem; }
        .validation-summary {
            font-weight: bold;
            text-align: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="text-gray-800">
    
    <!-- Panel de Depuraci칩n (Debug) -->
    <div id="debug-info" class="debug-info">
        <div id="debug-content"></div>
        <button onclick="toggleDebug()" class="bg-red-500 text-white px-2 py-1 rounded mt-2 text-xs">Cerrar</button>
    </div>
    
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Encabezado y M칠tricas Clave -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Resiliencia como Servicio</p>
            <button onclick="toggleDebug()" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-300">Debug</button>
        </header>

        <!-- Tarjetas de Resumen de M칠tricas Clave -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA A침o 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
             <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Equity</div>
                <div class="text-2xl font-bold" id="tir-equity">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas Operativas (A침o 5)</div>
                <div class="text-2xl font-bold" id="vagonetas-operativas">0</div>
            </div>
           
        </div>

        <!-- Fila adicional para ROE y ROIC -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
             <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">ROE (A침o 5)</div>
                <div class="text-2xl font-bold" id="roe-year5">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">ROIC (A침o 5)</div>
                <div class="text-2xl font-bold" id="roic-year5">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Deuda Residual A침o 5</div>
                <div class="text-2xl font-bold" id="deuda-residual">$0M MXN</div>
            </div>
        </div>

        <!-- Panel de Validaci칩n de Errores -->
        <div id="validation-panel">
            <h3 class="text-xl font-semibold mb-4">Resultados de Validaci칩n del Modelo</h3>
            <div id="validation-results-container">
                <!-- Los resultados de la validaci칩n se insertar치n aqu칤 -->
            </div>
        </div>

        <!-- Navegaci칩n por Pesta침as -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg"> 游 Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg"> 游늵 Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg"> 游늶 NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg"> 游늳 Gr치ficos</button>
            </nav>
        </div>

        <!-- Contenido de la Pesta침a: Control -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Secci칩n de Par치metros de Cr칠dito y Riesgo -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Cr칠dito y Riesgo <span class="text-sm text-gray-500">(Par치metros clave para el riesgo y el retorno del financiamiento)</span></h4>
                    <div class="space-y-4" id="credit-risk-controls">
                        <!-- Inputs se generar치n din치micamente aqu칤 -->
                    </div>
                    <div class="flex items-center mt-4">
                        <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Protecci칩n Rodando (<span class="font-bold">-50% en provisiones de morosidad</span>)</label>
                    </div>
                </div>

                <!-- Secci칩n de Par치metros de Operaciones -->
                <div class="card">
                    <h4 class="font-semibold text-lg mb-4">Operaciones y Deuda <span class="text-sm text-gray-500">(Eficiencia operativa y estructura de capital)</span></h4>
                    <div class="space-y-4" id="operations-debt-controls">
                        <!-- Inputs se generar치n din치micamente aqu칤 -->
                    </div>
                </div>

                <!-- Secci칩n de Unidades por A침o y Constantes del Modelo -->
                <div class="card lg:col-span-3">
                    <h3 class="text-xl font-semibold mb-4">Unidades por A침o y Constantes del Modelo <span class="text-sm text-gray-500">(Definiciones base del negocio)</span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6" id="units-container">
                        <!-- Inputs de unidades se generar치n din치micamente aqu칤 -->
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="constants-container">
                        <!-- Inputs de constantes se generar치n din치micamente aqu칤 -->
                    </div>
                    <button onclick="forceCalculate()" class="mt-6 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-medium transition duration-300"> 游댃 Recalcular Modelo</button>
                </div>
            </div>
        </div>

        <!-- Contenido de la Pesta침a: Financieros -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A침o 1</th>
                                    <th>A침o 2</th>
                                    <th>A침o 3</th>
                                    <th>A침o 4</th>
                                    <th>A침o 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A침o 0</th>
                                    <th>A침o 1</th>
                                    <th>A침o 2</th>
                                    <th>A침o 3</th>
                                    <th>A침o 4</th>
                                    <th>A침o 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A침o 1</th>
                                    <th>A침o 2</th>
                                    <th>A침o 3</th>
                                    <th>A침o 4</th>
                                    <th>A침o 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body"></tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4 text-center font-semibold p-2 rounded-lg bg-gray-50"></div>
                </div>
            </div>
        </div>

        <!-- Contenido de la Pesta침a: NIIF -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos <span class="text-sm text-gray-600">(C칩mo se reconocen los ingresos del negocio de financiamiento)</span></h3>
                    <div id="niif15-container">Calculando datos NIIF 15...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 9 - Provisiones Crediticias <span class="text-sm text-gray-600">(Impacto de la morosidad y las p칠rdidas esperadas)</span></h3>
                    <div id="niif9-container">Calculando datos NIIF 9...</div>
                </div>
                <div class="card niif-compliant">
                    <h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos Mantenidos para Venta <span class="text-sm text-gray-600">(Tratamiento contable de vagonetas reposedas)</span></h3>
                    <div id="niif5-container">Calculando datos NIIF 5...</div>
                </div>
            </div>
        </div>

        <!-- Contenido de la Pesta침a: Gr치ficos -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evoluci칩n de EBITDA</h4>
                    <div style="height: 300px;"><canvas id="ebitdaChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Composici칩n de Ingresos (A침o 5)</h4>
                    <div style="height: 300px;"><canvas id="revenueMixChart"></canvas></div>
                </div>
                 <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Activos Totales vs Pasivos + Patrimonio</h4>
                    <div style="height: 300px;"><canvas id="balanceValidationChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Flujo de Efectivo Neto Anual</h4>
                    <div style="height: 300px;"><canvas id="netCashFlowChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES DEL MODELO =====
        let debugLogs = []; // Array para almacenar los logs de depuraci칩n
        let charts = {}; // Objeto para almacenar las instancias de Chart.js

        // Datos del modelo financiero, valores iniciales y rangos de control
        let modelData = {
            // Par치metros de Cr칠dito y Riesgo
            tasaInteres: 25.5,      // Tasa de inter칠s anual de los financiamientos a clientes
            tasaMorosidad: 8,       // Porcentaje de ingresos por intereses que se considera moroso (para la antigua l칩gica)
            proteccionRodando: true,// Booleano para activar/desactivar reducci칩n de provisiones

            // Par치metros IFRS 9 (nuevos)
            pdStage1: 0.005, // 0.5% Probability of Default (12-month) for Stage 1 loans
            pdStage2: 0.08,  // 8% Probability of Default (lifetime) for Stage 2 loans
            pdStage3: 0.40,  // 40% Probability of Default (lifetime) for Stage 3 loans (Credit-impaired)
            lgd: 0.50,       // Loss Given Default (percentage of exposure lost if default occurs)
            portfolioAllocationStage1: 0.85, // 85% of active portfolio in Stage 1
            portfolioAllocationStage2: 0.10, // 10% of active portfolio in Stage 2
            portfolioAllocationStage3: 0.05, // 5% of active portfolio in Stage 3
            economicAdjustmentFactor: 1.0, // Factor para ajustes prospectivos macroecon칩micos (1.0 = sin ajuste)


            // Par치metros de Operaciones y Deuda
            comisionGNV: 8,         // Porcentaje de comisi칩n por servicios de GNV
            margenRefacciones: 25,  // Margen de ganancia en refacciones
            ventureDebtPct: 70,     // Porcentaje del capital inicial (Serie A) que se obtiene como Venture Debt (adicional a Serie A)
            ventureDebtRate: 12,    // Tasa de inter칠s anual del Venture Debt
            periodoAmortizacionDeuda: 5, // A침os para amortizar la deuda inicial de Venture Debt

            // Unidades por A침o (inputs din치micos)
            unitsPerYear: [200, 250, 300, 350, 400], // Unidades (vagonetas) a침adidas cada a침o

            // Constantes del Modelo
            vanCost: 641000,        // Costo de adquisici칩n de cada vagoneta (Activo Fijo)
            vanPrice: 729000,       // Precio de venta/financiamiento al cliente (para c치lculo de monto del pr칠stamo)
            seriesA: 45000000,      // Inversi칩n inicial de Serie A (Equity)
            seriesB_funding: 0,     // Monto de financiamiento de Serie B
            seriesB_year: 3,        // A침o en que se recibe la Serie B (A침o 1 a A침o 5)
            seriesC_funding: 0,     // Monto de financiamiento de Serie C
            seriesC_year: 5,        // A침o en que se recibe la Serie C (A침o 1 a A침o 5)
            clientLoanTermYears: 5, // Plazo de amortizaci칩n de los pr칠stamos a clientes (en a침os)
            depreciationYears: 10,  // A침os de depreciaci칩n lineal de las vagonetas (activos de RAG)
            opexRate: 15,           // Porcentaje de los ingresos operativos destinado a OPEX
            margenVagoneta: 5,      // Porcentaje de comisi칩n por la originaci칩n de cada vagoneta financiada
            gnvRevPerUnit: 15000,   // Ingreso base por unidad por servicios de GNV
            refaccionesRevPerUnit: 8000, // Ingreso base por unidad por servicios de refacciones
            marketplaceRevPerUnit: 5000, // Ingreso base por unidad por servicios de Marketplace
            marketplace: 3,         // Porcentaje de comisi칩n por servicios de Marketplace
            tasaReposicion: 5,      // Porcentaje de unidades que se reponen/clasifican como Activos para Venta anualmente
            fairValueVenta: 85,     // Porcentaje del valor razonable de las vagonetas reposedas
            costosVenta: 5,          // Porcentaje de costos asociados a la venta de vagonetas reposedas
            corporateTaxRate: 25   // Tasa de impuesto corporativo (%)
        }; // Cierre del objeto modelData

        // Rangos para los inputs deslizables (sliders)
        const sliderConfigs = [
            { id: 'tasaInteres', label: 'Tasa de Inter칠s (Clientes)', min: 10, max: 35, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'tasaMorosidad', label: 'Tasa Morosidad (Antigua L칩gica)', min: 4, max: 15, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'comisionGNV', label: 'Comisi칩n GNV', min: 6, max: 20, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' },
            { id: 'margenRefacciones', label: 'Margen Refacciones', min: 20, max: 40, step: 1, type: 'range', format: val => val.toFixed(0) + '%' },
            { id: 'ventureDebtPct', label: '% Venture Debt', min: 50, max: 100, step: 5, type: 'range', format: val => val.toFixed(0) + '%' },
            { id: 'ventureDebtRate', label: 'Tasa Venture Debt', min: 10, max: 16, step: 0.5, type: 'range', format: val => val.toFixed(1) + '%' }
        ];

        // Rangos para las constantes del modelo (inputs num칠ricos)
        const constantConfigs = [
            { id: 'vanCost', label: 'Costo Vagoneta (RAG)', min: 500000, max: 800000, step: 1000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'vanPrice', label: 'Precio Pr칠stamo Cliente', min: 600000, max: 900000, step: 1000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesA', label: 'Capital Serie A', min: 30000000, max: 60000000, step: 1000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesB_funding', label: 'Funding Serie B', min: 0, max: 200000000, step: 5000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesB_year', label: 'A침o Serie B', min: 1, max: 5, step: 1, type: 'number', format: val => val.toFixed(0) + ' ' + (val == 1 ? 'a침o' : 'a침os') },
            { id: 'seriesC_funding', label: 'Funding Serie C', min: 0, max: 300000000, step: 5000000, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'seriesC_year', label: 'A침o Serie C', min: 1, max: 5, step: 1, type: 'number', format: val => val.toFixed(0) + ' ' + (val == 1 ? 'a침o' : 'a침os') },
            { id: 'clientLoanTermYears', label: 'Plazo Pr칠stamo Cliente (A침os)', min: 1, max: 10, step: 1, type: 'number', format: val => val.toFixed(0) + ' a침os' },
            { id: 'depreciationYears', label: 'A침os Depreciaci칩n (Vagoneta)', min: 5, max: 15, step: 1, type: 'number', format: val => val.toFixed(0) + ' a침os' },
            { id: 'opexRate', label: 'Tasa OPEX (% Ingresos)', min: 10, max: 30, step: 1, type: 'number', format: val => val.toFixed(0) + '%' },
            { id: 'margenVagoneta', label: 'Margen Originaci칩n Vagoneta', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'gnvRevPerUnit', label: 'Ingreso GNV/Unidad', min: 10000, max: 20000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'refaccionesRevPerUnit', label: 'Ingreso Refacciones/Unidad', min: 5000, max: 15000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'marketplaceRevPerUnit', label: 'Ingreso Marketplace/Unidad', min: 3000, max: 10000, step: 500, type: 'number', format: val => formatCurrency(val, true) },
            { id: 'marketplace', label: '% Comisi칩n Marketplace', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'tasaReposicion', label: '% Unidades Reposici칩n', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            { id: 'fairValueVenta', label: '% Fair Value Venta', min: 70, max: 95, step: 1, type: 'number', format: val => val.toFixed(0) + '%' },
            { id: 'costosVenta', label: '% Costos Venta', min: 1, max: 10, step: 0.5, type: 'number', format: val => val.toFixed(1) + '%' },
            // Nuevos Controles NIIF 9 y Tax Rate
            { id: 'pdStage1', label: 'PD Etapa 1 (12M)', min: 0.001, max: 0.05, step: 0.001, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'pdStage2', label: 'PD Etapa 2 (Lifetime)', min: 0.05, max: 0.20, step: 0.005, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'pdStage3', label: 'PD Etapa 3 (Lifetime)', min: 0.20, max: 0.60, step: 0.01, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'lgd', label: 'LGD (Recuperaci칩n %)', min: 0.1, max: 0.9, step: 0.01, type: 'number', format: val => (val * 100).toFixed(1) + '%' },
            { id: 'portfolioAllocationStage1', label: 'Port. Etapa 1 (%)', min: 0.70, max: 0.95, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'portfolioAllocationStage2', label: 'Port. Etapa 2 (%)', min: 0.03, max: 0.20, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'portfolioAllocationStage3', label: 'Port. Etapa 3 (%)', min: 0.01, max: 0.10, step: 0.01, type: 'number', format: val => (val * 100).toFixed(0) + '%' },
            { id: 'economicAdjustmentFactor', label: 'Ajuste Econ칩mico (x)', min: 0.8, max: 1.2, step: 0.01, type: 'number', format: val => val.toFixed(2) + 'x' },
            { id: 'corporateTaxRate', label: 'Tasa Impuesto Corporativo (%)', min: 0, max: 40, step: 1, type: 'number', format: val => val.toFixed(0) + '%' }
        ];


        // Objeto para almacenar los resultados financieros calculados
        let financialResults = {
            pl: [],             // Profit & Loss (Estado de Resultados)
            cf: [],             // Cash Flow (Flujo de Efectivo)
            bs: [],             // Balance Sheet (Balance General)
            niifDetails: [],    // Detalles de aplicaci칩n de NIIF
            tirProyecto: 0,     // Tasa Interna de Retorno del Proyecto
            tirCartera: 0,      // Tasa Interna de Retorno de la Cartera de Clientes
            tirEquity: 0,       // Tasa Interna de Retorno del Equity
            roe: [],            // Return on Equity anual
            roic: []            // Return on Invested Capital anual
        };

        // ===== FUNCIONES DE DEBUG =====
        // Registra mensajes en la consola y en el panel de depuraci칩n de la UI
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.unshift(logEntry); // A침adir al principio
            if (debugLogs.length > 20) debugLogs.pop(); // Mantener solo los 칰ltimos 20 logs
            
            console.log(logEntry, data);
            updateDebugPanel();
        }
        
        // Actualiza el contenido del panel de depuraci칩n en la UI
        function updateDebugPanel() {
            const panel = document.getElementById('debug-content');
            if (panel) {
                panel.innerHTML = debugLogs.map(log => `<div style="margin-bottom: 2px; font-size: 10px; border-bottom: 1px dotted #4b5563; padding-bottom: 2px;">${log}</div>`).join('');
            }
        }
        
        // Muestra/oculta el panel de depuraci칩n
        function toggleDebug() {
            const panel = document.getElementById('debug-info');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // ===== C츼LCULO FINANCIERO PRINCIPAL =====
        // Funci칩n central para calcular todos los estados financieros
        function calculateFinancials() {
            log(' 游 INICIANDO C츼LCULOS FINANCIEROS...');
            try {
                // Reiniciar resultados antes de cada c치lculo
                financialResults = { 
                    pl: [], cf: [], bs: [], niifDetails: [], 
                    tirProyecto: 0, tirCartera: 0, tirEquity: 0, 
                    roe: [], roic: [] 
                };

                // Variables iniciales de financiamiento para el modelo (fuera del loop anual para persistencia)
                const initialEquityInvestment = modelData.seriesA;
                const initialVentureDebtAmount = initialEquityInvestment * (modelData.ventureDebtPct / 100);

                // Inicializar variables de estado antes del bucle anual
                let accumulatedEarnings = 0; // Utilidades retenidas acumuladas
                let cash = initialEquityInvestment + initialVentureDebtAmount; // El efectivo inicial proviene de Serie A + Venture Debt inicial
                let totalDebt = initialVentureDebtAmount; // El saldo inicial de deuda es el Venture Debt inicial
                let currentProvisionsBalance = 0; // Saldo acumulado de provisiones NIIF 9 en Balance General
                let contractLiabilitiesBalance = 0; // Saldo acumulado de pasivos por contrato (NIIF 15)

                // Array para almacenar las cohortes de pr칠stamos a clientes
                // loanCohorts = [{ yearOriginated: Y, originalPrincipal: P, remainingPrincipal: P, paymentsMadeMonths: 0, monthlyPayment: M, monthlyInterestRate: r, totalLoanTermMonths: N }]
                let loanCohorts = [];

                // Array para almacenar las cohortes de activos fijos (vagonetas)
                // fixedAssetsCohorts = [{ yearAcquired: X, units: Y, originalCostPerUnit: C, totalOriginalCost: Y*C, accumulatedDepreciation: D, isHeldForSale: false, heldForSaleYear: null, carryingAmountAtHFS: 0, currentFairValueLessCosts: 0 }]
                let fixedAssetsCohorts = [];

                // Arrays para el c치lculo de TIRs
                const projectCashFlows = [-(initialEquityInvestment + initialVentureDebtAmount)]; // TIR Proyecto: Inversi칩n inicial total
                const equityCashFlows = [-initialEquityInvestment]; // TIR Equity: Inversi칩n inicial de Equity
                const portfolioCashFlowsForIRR = []; // Para los flujos de la TIR Cartera (la inversi칩n inicial se a침ade despu칠s del loop)

                log(`Capital Serie A inicial: ${formatCurrency(modelData.seriesA)}`);
                log(`Venture Debt inicial (parte de Serie A y ADICIONAL): ${formatCurrency(initialVentureDebtAmount)}`);
                log(`Efectivo inicial total (Serie A + Venture Debt): ${formatCurrency(cash)}`);
                
                // Ciclo Anual: desde A침o 0 (representando el inicio del A침o 1) hasta A침o 4 (representando el final del A침o 5)
                for (let year = 0; year < 5; year++) {
                    log(`\n--- Calculando A침o ${year + 1} ---`);

                    const addedUnits = modelData.unitsPerYear[year];
                    // Guardar los saldos iniciales de Equity y Deuda para el c치lculo de promedio anual de ROIC/ROE
                    const startOfYearEquity = initialEquityInvestment + accumulatedEarnings;
                    const startOfYearTotalDebt = totalDebt;


                    // --- INVERSIONES (Activos Fijos) - Adquisici칩n de nuevas vagonetas ---
                    const capexThisYear = addedUnits * modelData.vanCost; // Inversi칩n en vagonetas (CAPEX)
                    if (addedUnits > 0) {
                        fixedAssetsCohorts.push({
                            yearAcquired: year + 1,
                            units: addedUnits,
                            originalCostPerUnit: modelData.vanCost,
                            totalOriginalCost: addedUnits * modelData.vanCost,
                            accumulatedDepreciation: 0, // Depreciaci칩n inicial en 0 para la cohorte
                            isHeldForSale: false,
                            heldForSaleYear: null,
                            carryingAmountAtHFS: 0, // Valor en libros al momento de clasificar como HFS
                            currentFairValueLessCosts: 0 // Valor para el balance despu칠s de deterioro NIIF 5
                        });
                        log(` Nueva cohorte de activos fijos A침o ${year+1}: ${addedUnits} unidades por ${formatCurrency(capexThisYear)}`);
                    }

                    // --- DEPRECIACI칍N DE ACTIVOS FIJOS (Vagonetas) ---
                    // La depreciaci칩n solo aplica a los activos que NO est치n clasificados como "Mantenidos para Venta" (NIIF 5)
                    let annualDepreciation = 0;
                    fixedAssetsCohorts.forEach(cohort => {
                        if (!cohort.isHeldForSale) { // Solo deprecia activos no clasificados como NIIF 5
                            const yearsDepreciated = (year + 1) - cohort.yearAcquired; // A침os transcurridos desde la adquisici칩n
                            const remainingDepreciableLife = modelData.depreciationYears - yearsDepreciated;

                            if (remainingDepreciableLife > 0 && cohort.accumulatedDepreciation < cohort.totalOriginalCost) {
                                const depreciationRate = 1 / modelData.depreciationYears;
                                const depreciationThisYear = cohort.totalOriginalCost * depreciationRate;
                                
                                // Asegurar que la depreciaci칩n no exceda el valor no depreciado restante
                                const remainingValue = cohort.totalOriginalCost - cohort.accumulatedDepreciation;
                                cohort.depreciationThisYear = Math.min(depreciationThisYear, remainingValue);

                                cohort.accumulatedDepreciation += cohort.depreciationThisYear;
                                annualDepreciation += cohort.depreciationThisYear;
                            } else {
                                cohort.depreciationThisYear = 0;
                            }
                        } else {
                            cohort.depreciationThisYear = 0; // Activos NIIF 5 no se deprecian
                        }
                    });

                    // --- NIIF 5: RECLASIFICACI칍N DE ACTIVOS Y C츼LCULO DE DETERIORO ---
                    // Se aplica la tasa de reposici칩n a las unidades activas y se reasignan a NIIF 5
                    let totalImpairmentThisYear = 0;
                    let unitsToRepossess = Math.round((fixedAssetsCohorts.filter(c => !c.isHeldForSale).reduce((sum, c) => sum + c.units, 0)) * (modelData.tasaReposicion / 100));
                    let remainingUnitsToRepossess = unitsToRepossess;

                    // Variables para acumular los valores de los activos reclasificados este a침o para el detalle NIIF
                    let valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearFairValue = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell = 0;
                    let valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue = 0;


                    // Ordenar cohortes para reponer las m치s antiguas primero (FIFO conceptual)
                    fixedAssetsCohorts.sort((a, b) => a.yearAcquired - b.yearAcquired);

                    fixedAssetsCohorts.forEach(cohort => {
                        if (!cohort.isHeldForSale && remainingUnitsToRepossess > 0) {
                            const unitsFromCohort = Math.min(remainingUnitsToRepossess, cohort.units);
                            if (unitsFromCohort > 0) {
                                // Calcular el valor en libros de las unidades reposedas al momento de la reclasificaci칩n
                                const proportionToRepossess = unitsFromCohort / cohort.units;
                                const carryingAmountAtClassification = (cohort.totalOriginalCost - cohort.accumulatedDepreciation) * proportionToRepossess;

                                cohort.isHeldForSale = true; // Marcar la cohorte como NIIF 5 (simplificaci칩n)
                                cohort.heldForSaleYear = year + 1;
                                cohort.carryingAmountAtHFS = carryingAmountAtClassification; // Valor en libros en el momento de reclasificaci칩n

                                // C치lculo de Fair Value menos costos de venta
                                const fairValueLessCosts = carryingAmountAtClassification * (modelData.fairValueVenta / 100) * (1 - (modelData.costosVenta / 100));
                                
                                // C치lculo del deterioro
                                const impairmentForTheseUnits = Math.max(0, carryingAmountAtClassification - fairValueLessCosts);
                                totalImpairmentThisYear += impairmentForTheseUnits; // Sumar al deterioro anual del P&L
                                
                                // Valor para el Balance General despu칠s del deterioro
                                cohort.currentFairValueLessCosts = carryingAmountAtClassification - impairmentForTheseUnits;
                                
                                remainingUnitsToRepossess -= unitsFromCohort;

                                // Acumular para los detalles NIIF de este a침o
                                valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount += carryingAmountAtClassification;
                                valueOfAssetsReclassifiedToNIIF5ThisYearFairValue += carryingAmountAtClassification * (modelData.fairValueVenta / 100);
                                valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell += carryingAmountAtClassification * (modelData.fairValueVenta / 100) * (modelData.costosVenta / 100);
                                valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue += fairValueLessCosts;


                                log(` Reclasificadas ${unitsFromCohort} unidades de cohorte A침o ${cohort.yearAcquired} a NIIF 5. VL al reclasificar: ${formatCurrency(carryingAmountAtClassification)}, Deterioro: ${formatCurrency(impairmentForTheseUnits)}`);
                            }
                        }
                    });
                    const impairment = totalImpairmentThisYear; // Impairment para el P&L


                    // --- ORIGINACI칍N DE NUEVA COHORTE DE PR칄STAMOS A CLIENTES ---
                    let totalPrincipalOriginatedThisYear = 0; // Total principal de pr칠stamos nuevos este a침o
                    if (addedUnits > 0) {
                        const newCohortPrincipal = addedUnits * modelData.vanPrice;
                        totalPrincipalOriginatedThisYear = newCohortPrincipal; // Esta es la inversi칩n real en el pr칠stamo al cliente
                        const monthlyInterestRateClient = (modelData.tasaInteres / 100) / 12;
                        const totalPaymentsMonthsClient = modelData.clientLoanTermYears * 12;
                        
                        let monthlyPaymentClient = 0;
                        if (monthlyInterestRateClient > 0) {
                            monthlyPaymentClient = newCohortPrincipal * (monthlyInterestRateClient / (1 - Math.pow(1 + monthlyInterestRateClient, -totalPaymentsMonthsClient)));
                        } else {
                            // Si la tasa de inter칠s es 0, el pago mensual es simplemente principal / n칰mero de meses
                            monthlyPaymentClient = newCohortPrincipal / totalPaymentsMonthsClient;
                        }

                        loanCohorts.push({
                            yearOriginated: year + 1,
                            originalPrincipal: newCohortPrincipal,
                            remainingPrincipal: newCohortPrincipal, // Al inicio del a침o, este es el total
                            paymentsMadeMonths: 0, // No se han hecho pagos a칰n para esta cohorte
                            monthlyPayment: monthlyPaymentClient,
                            monthlyInterestRate: monthlyInterestRateClient,
                            totalLoanTermMonths: totalPaymentsMonthsClient
                        });
                        log(` Cohorte nueva A침o ${year+1}: ${addedUnits} unidades, Principal: ${formatCurrency(newCohortPrincipal)}. Esta es una INVERSI칍N.`);
                    }

                    // --- AMORTIZACI칍N Y RECONOCIMIENTO DE INGRESOS POR COHORTES (Clientes) ---
                    let annualInterestReceived = 0; // Ingresos por intereses devengados este a침o de todas las cohortes
                    let annualPrincipalReceived = 0; // Pagos de principal recibidos este a침o de todas las cohortes
                    let currentYearEndReceivables = 0; // Saldo total de CxC al final de este a침o

                    // Iterar sobre todas las cohortes activas (las que a칰n tienen saldo pendiente)
                    loanCohorts.forEach(cohort => {
                        if (cohort.remainingPrincipal > 0 && cohort.paymentsMadeMonths < cohort.totalLoanTermMonths) {
                            for (let m = 0; m < 12; m++) { // Simular 12 meses de pagos para cada cohorte
                                if (cohort.remainingPrincipal <= 0 || cohort.paymentsMadeMonths >= cohort.totalLoanTermMonths) {
                                    break; // Cohorte totalmente amortizada
                                }
                                
                                const interestThisMonth = cohort.remainingPrincipal * cohort.monthlyInterestRate;
                                let principalThisMonth = cohort.monthlyPayment - interestThisMonth;

                                // Asegurar que el principal a pagar no exceda el saldo restante
                                principalThisMonth = Math.min(principalThisMonth, cohort.remainingPrincipal);
                                
                                annualInterestReceived += interestThisMonth;
                                annualPrincipalReceived += principalThisMonth;
                                cohort.remainingPrincipal -= principalThisMonth;
                                cohort.paymentsMadeMonths++;
                            }
                        }
                        // Sumar el saldo restante de esta cohorte al total de CxC al final del a침o
                        currentYearEndReceivables += Math.max(0, cohort.remainingPrincipal);
                    });

                    // --- ESTADO DE RESULTADOS (P&L) ---

                    // Ingresos Operativos
                    // Ingreso por Intereses: ahora viene de la suma de intereses devengados de todas las cohortes
                    const interestRevenue = annualInterestReceived;
                    
                    // NIIF 15: MARGEN POR ORIGINACI칍N (Diferido a lo largo del tiempo)
                    // totalOriginationContractValueThisYear es el valor del contrato de servicio de originaci칩n este a침o
                    const totalOriginationContractValueThisYear = addedUnits * modelData.vanPrice * (modelData.margenVagoneta / 100);
                    // A침adir el valor total del contrato al pasivo por contrato
                    contractLiabilitiesBalance += totalOriginationContractValueThisYear;
                    
                    // Reconocimiento anual del ingreso de originaci칩n diferido
                    // Se asume reconocimiento lineal sobre el plazo del pr칠stamo del cliente
                    const recognizedOriginationRevenueThisYear = totalOriginationContractValueThisYear / modelData.clientLoanTermYears;
                    // Reducir el pasivo por contrato por el monto reconocido
                    contractLiabilitiesBalance -= recognizedOriginationRevenueThisYear;

                    const originationCommission = recognizedOriginationRevenueThisYear; // Ingreso reconocido en P&L


                    // NIIF 15: COMISIONES GNV (Reconocidas a lo largo del tiempo / en el a침o que se provee el servicio)
                    // Se asume que el `gnvRevPerUnit` es un valor anual por unidad activa.
                    // fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0) obtiene el total de unidades ACUMULADAS.
                    const gnvCommissions = fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0) * modelData.gnvRevPerUnit * (modelData.comisionGNV / 100);
                    
                    // NIIF 15: INGRESOS POR REFACCIONES (Reconocidos en un punto en el tiempo)
                    // Se asume que la venta de refacciones ocurre en el a침o de adici칩n de unidades.
                    const sparePartsRevenue = addedUnits * modelData.refaccionesRevPerUnit * (modelData.margenRefacciones / 100);
                    
                    // NIIF 15: INGRESOS POR MARKETPLACE (Reconocidas a lo largo del tiempo / en el a침o que se provee el servicio)
                    // Similar a GNV, se asume que el `marketplaceRevPerUnit` es un valor anual.
                    const marketplaceRevenue = fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0) * modelData.marketplaceRevPerUnit * (modelData.marketplace / 100);

                    const totalRevenue = interestRevenue + originationCommission + gnvCommissions + sparePartsRevenue + marketplaceRevenue;

                    log(`Ingresos: Intereses=${formatCurrency(interestRevenue)}, Originaci칩n=${formatCurrency(originationCommission)}, GNV=${formatCurrency(gnvCommissions)}, Refacciones=${formatCurrency(sparePartsRevenue)}, Marketplace=${formatCurrency(marketplaceRevenue)}`);
                    log(`TOTAL INGRESOS OPERATIVOS: ${formatCurrency(totalRevenue)}`);

                    // Gastos Operativos (OPEX)
                    const opex = totalRevenue * (modelData.opexRate / 100);

                    // --- NIIF 9: PROVISIONES CREDITICIAS (Expected Credit Losses - ECL) ---
                    // Exposici칩n a Incumplimiento (EAD) = Saldo pendiente de la cartera de pr칠stamos al final del periodo
                    let totalOutstandingPrincipalForECL = currentYearEndReceivables; // Usamos el saldo de CxC al final del a침o

                    // Distribuci칩n del portafolio por etapas (simplificaci칩n para este modelo agregado)
                    // No se simula migraci칩n individual, se asumen porcentajes de la cartera total en cada etapa.
                    const eadStage1 = totalOutstandingPrincipalForECL * modelData.portfolioAllocationStage1;
                    const eadStage2 = totalOutstandingPrincipalForECL * modelData.portfolioAllocationStage2;
                    const eadStage3 = totalOutstandingPrincipalForECL * modelData.portfolioAllocationStage3;

                    // Calcular Expected Credit Losses (ECL = EAD * PD * LGD)
                    const eclStage1Amount = eadStage1 * modelData.pdStage1 * modelData.lgd;
                    const eclStage2Amount = eadStage2 * modelData.pdStage2 * modelData.lgd;
                    const eclStage3Amount = eadStage3 * modelData.pdStage3 * modelData.lgd;

                    let annualECLProvision = eclStage1Amount + eclStage2Amount + eclStage3Amount;

                    // Aplicar ajuste por forward-looking information
                    annualECLProvision *= modelData.economicAdjustmentFactor;

                    // Aplicar "Protecci칩n Rodando" si est치 activa (reduce el gasto de provisi칩n final)
                    const provisions = annualECLProvision * (modelData.proteccionRodando ? 0.5 : 1.0); // Gasto por provisiones del periodo (ajustado por Protecci칩n Rodando)
                    currentProvisionsBalance += provisions; // Acumular para el Balance General
                    log(` Provisiones NIIF 9 (ECL) este a침o: ${formatCurrency(provisions)}. Base outstanding: ${formatCurrency(totalOutstandingPrincipalForECL)}`);


                    // Gasto por Intereses de Deuda (Venture Debt)
                    const interestExpense = (year === 0 ? initialVentureDebtAmount : totalDebt) * (modelData.ventureDebtRate / 100);

                    // Resultados del P&L
                    const ebitda = totalRevenue - opex - provisions - impairment; // EBITDA incluye provisiones e impairment NIIF 5 como gastos operativos
                    const netIncome = ebitda - annualDepreciation - interestExpense; // Utilidad Neta
                    accumulatedEarnings += netIncome; // Acumular utilidades para Patrimonio

                    // --- FLUJO DE EFECTIVO (CF) ---
                    
                    // El `deltaReceivables` es el cambio en el saldo de CxC del Balance General
                    const prevReceivablesBalance = (year === 0) ? 0 : financialResults.bs[year-1].receivables;
                    const deltaReceivables = currentYearEndReceivables - prevReceivablesBalance;

                    // Flujo Operativo (M칠todo Indirecto): Utilidad Neta ajustada por partidas no monetarias y cambios en capital de trabajo (CxC)
                    const operatingCash = netIncome + annualDepreciation + provisions + impairment - deltaReceivables;
                    
                    // Flujo de Inversi칩n: Incluye CAPEX de vagonetas Y LA ORIGINACI칍N DE PR칄STAMOS A CLIENTES
                    const investingCash = -capexThisYear - totalPrincipalOriginatedThisYear; // 춰CLAVE: Correcci칩n del error cr칤tico!
                    log(` Flujo de Inversi칩n (CAPEX vagonetas + Originaci칩n pr칠stamos): ${formatCurrency(investingCash)}`);

                    let financingCashThisPeriod = 0; // Representa las actividades de financiaci칩n netas para *este* periodo
                    let principalPaymentVentureDebtThisPeriod = 0; // Para almacenar en los resultados de CF
                    let newEquityRaisedThisPeriod = 0; // Acumula Serie B, C, y el plug de liquidez
                    let additionalFundingRaised = 0; // Declarar aqu칤 al inicio del loop

                    // Aportaciones de capital escalonado (Serie B y C)
                    if (year + 1 === modelData.seriesB_year) {
                        financingCashThisPeriod += modelData.seriesB_funding;
                        newEquityRaisedThisPeriod += modelData.seriesB_funding;
                        log(` 游꿀 Recibido funding Serie B en A침o ${year+1}: ${formatCurrency(modelData.seriesB_funding)}`);
                    }
                    if (year + 1 === modelData.seriesC_year) {
                        financingCashThisPeriod += modelData.seriesC_funding;
                        newEquityRaisedThisPeriod += modelData.seriesC_funding;
                        log(` 游꿀 Recibido funding Serie C en A침o ${year+1}: ${formatCurrency(modelData.seriesC_funding)}`);
                    }

                    // Pago de principal para el Venture Debt inicial
                    if (totalDebt > 0 && modelData.periodoAmortizacionDeuda > 0) {
                        const annualPrincipalPaymentFixed = initialVentureDebtAmount / modelData.periodoAmortizacionDeuda;
                        principalPaymentVentureDebtThisPeriod = Math.min(annualPrincipalPaymentFixed, totalDebt); // Asegurar que el pago no exceda la deuda remanente
                        totalDebt = Math.max(0, totalDebt - principalPaymentVentureDebtThisPeriod); // Reducir el saldo de deuda restante
                        financingCashThisPeriod -= principalPaymentVentureDebtThisPeriod; // El pago es una salida de efectivo
                    }
                    
                    // Calcular el efectivo neto provisional para el per칤odo
                    let netCash = operatingCash + investingCash + financingCashThisPeriod;
                    
                    // PLUG DE LIQUIDEZ: Si el efectivo cae por debajo de cero, asumir financiaci칩n adicional
                    const prospectiveCash = cash + netCash;
                    if (prospectiveCash < 0) {
                        additionalFundingRaised = -prospectiveCash; // Monto para llevar el efectivo a cero
                        financingCashThisPeriod += additionalFundingRaised;
                        newEquityRaisedThisPeriod += additionalFundingRaised; // El plug se considera equity adicional
                        netCash += additionalFundingRaised; // Recalcular netCash para reflejar el nuevo funding
                        log(` 丘멆잺 D칠ficit de efectivo en A침o ${year+1}. Se asume funding ADICIONAL (Plug de Liquidez): ${formatCurrency(additionalFundingRaised)}`);
                    }

                    // Actualizar el saldo de efectivo total
                    cash += netCash; 
                    
                    // Actualizar Equity para el balance (antes de calcular m칠tricas basadas en saldo final)
                    // Patrimonio: Capital inicial de Serie A + utilidades acumuladas + nuevo equity raised este periodo
                    let endOfYearEquity = initialEquityInvestment + accumulatedEarnings + newEquityRaisedThisPeriod;
                    
                    // --- BALANCE GENERAL (BS) ---
                    // Activos Fijos Netos: Se suman los costos originales y se resta la depreciaci칩n acumulada SOLO para activos NO clasificados NIIF 5
                    let totalOriginalCostPPandE = 0;
                    let totalAccumulatedDepreciationPPandE = 0;
                    let totalNIIF5AssetsBS = 0; // Valor total de activos clasificados como NIIF 5 para el Balance

                    fixedAssetsCohorts.forEach(cohort => {
                        if (cohort.isHeldForSale) {
                            totalNIIF5AssetsBS += cohort.currentFairValueLessCosts; // Usar el valor post-deterioro para NIIF 5 en Balance
                        } else {
                            totalOriginalCostPPandE += cohort.totalOriginalCost;
                            totalAccumulatedDepreciationPPandE += cohort.accumulatedDepreciation;
                        }
                    });
                    
                    const fixedAssetsNet = totalOriginalCostPPandE - totalAccumulatedDepreciationPPandE;
                    const assetsHeldForSaleNet = totalNIIF5AssetsBS; // Es el acumulado de valores NIIF 5 en Balance

                    // Total Activos
                    const totalAssets = cash + currentYearEndReceivables + fixedAssetsNet + assetsHeldForSaleNet; // currentYearEndReceivables es el saldo de CxC
                    
                    // Total Pasivos + Patrimonio
                    const totalLiabilitiesEquity = totalDebt + currentProvisionsBalance + contractLiabilitiesBalance + endOfYearEquity; // A침adir contractLiabilitiesBalance
                    

                    // Validaci칩n de Balance: Compara Total Activos y Total Pasivos + Patrimonio
                    const balanceDiff = Math.abs(totalAssets - totalLiabilitiesEquity);
                    log(`Diferencia de Balance A침o ${year + 1}: ${formatCurrency(balanceDiff)}`);
                    
                    // --- C츼LCULO DE M칄TRICAS ANUALES (ROE, ROIC) ---
                    const averageEquity = (startOfYearEquity + endOfYearEquity) / 2;
                    const averageInvestedCapital = (startOfYearEquity + startOfYearTotalDebt + endOfYearEquity + totalDebt) / 2; // Average Equity + Average Debt
                    
                    let annualROE = 0;
                    if (averageEquity !== 0) annualROE = (netIncome / averageEquity) * 100;
                    
                    let annualROIC = 0;
                    // NOPAT = EBIT * (1 - Tax Rate)
                    const ebit = ebitda - annualDepreciation;
                    const nopat = ebit * (1 - (modelData.corporateTaxRate / 100));

                    if (averageInvestedCapital !== 0) annualROIC = (nopat / averageInvestedCapital) * 100;

                    financialResults.roe.push(annualROE);
                    financialResults.roic.push(annualROIC);

                    // --- ALMACENAMIENTO DE RESULTADOS ANUALES ---
                    financialResults.pl.push({
                        interestRevenue, originationCommission, gnvCommissions, sparePartsRevenue, marketplaceRevenue, totalRevenue,
                        opex, provisions, impairment, ebitda, 
                        depreciation: annualDepreciation, interestExpense, netIncome,
                        cumulativeUnits: fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0) // Total de unidades para la TIR Cartera
                    });
                    financialResults.cf.push({
                        operatingCash, investingCash, financingCash: financingCashThisPeriod, netCash,
                        principalPaymentVentureDebt: principalPaymentVentureDebtThisPeriod, // Pago de principal de Venture Debt
                        clientPrincipalPaymentsReceived: annualPrincipalReceived, // Pagos de principal de clientes
                        additionalFundingRaised: additionalFundingRaised // Plug de liquidez
                    });
                    financialResults.bs.push({
                        cash, receivables: currentYearEndReceivables, fixedAssets: fixedAssetsNet, 
                        assetsHeldForSale: assetsHeldForSaleNet, totalAssets,
                        debt: totalDebt, provisions: currentProvisionsBalance, contractLiabilities: contractLiabilitiesBalance, equity: endOfYearEquity, totalLiabilitiesEquity
                    });
                    
                    // --- DETALLES NIIF ---
                    financialResults.niifDetails.push({
                        niif15: {
                            valorNominal: totalRevenue, // Total revenue before deferral adjustments for display
                            recognizedOriginationRevenue: recognizedOriginationRevenueThisYear,
                            totalOriginationContractValue: totalOriginationContractValueThisYear,
                            contractLiabilitiesBalance: contractLiabilitiesBalance,
                            // Simplified for display:
                            valorPresente: interestRevenue + recognizedOriginationRevenueThisYear + gnvCommissions + sparePartsRevenue + marketplaceRevenue, 
                            ajusteDescuento: (interestRevenue + totalOriginationContractValueThisYear + gnvCommissions + sparePartsRevenue + marketplaceRevenue) - (interestRevenue + recognizedOriginationRevenueThisYear + gnvCommissions + sparePartsRevenue + marketplaceRevenue),
                            // Other POBs are recognized in the year they are earned/provided, no long-term deferral shown here.
                        },
                        niif9: {
                            // Datos NIIF 9 basados en la nueva l칩gica de ECL
                            totalOutstandingPrincipal: totalOutstandingPrincipalForECL,
                            eadStage1: eadStage1,
                            eclStage1Amount: eclStage1Amount,
                            pdStage1: modelData.pdStage1,
                            eadStage2: eadStage2,
                            eclStage2Amount: eclStage2Amount,
                            pdStage2: modelData.pdStage2,
                            eadStage3: eadStage3,
                            eclStage3Amount: eclStage3Amount,
                            pdStage3: modelData.pdStage3,
                            lgd: modelData.lgd,
                            totalECLBeforeAdjustment: eclStage1Amount + eclStage2Amount + eclStage3Amount,
                            economicAdjustmentFactor: modelData.economicAdjustmentFactor,
                            provisionesSinProteccion: annualECLProvision, // Este es el ECL total con ajuste econ칩mico, antes de Protecci칩n Rodando
                            provisionesConProteccion: provisions, // Este es el gasto real en P&L
                            reduccionPorProteccion: annualECLProvision - provisions,
                            saldoProvisionesAcumulado: currentProvisionsBalance, // Saldo acumulado para Balance
                            proteccionRodandoActiva: modelData.proteccionRodando
                        },
                        niif5: {
                            unidadesClasificadasAnuales: unitsToRepossess, // Unidades reposedas este a침o
                            valorEnLibrosClasificado: valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount, // VL original de los reclassified
                            valorRazonable: valueOfAssetsReclassifiedToNIIF5ThisYearFairValue,
                            costosDeVenta: valueOfAssetsReclassifiedToNIIF5ThisYearCostsToSell,
                            valorRazonableMenosCostos: valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue,
                            perdidaPorDeterioro: totalImpairmentThisYear, // P칠rdida de deterioro este a침o
                            saldoActivosParaVentaAcumulado: assetsHeldForSaleNet // Saldo acumulado para Balance
                        }
                    });

                    // Flujo para TIR Cartera
                    portfolioCashFlowsForIRR.push(interestRevenue - provisions - (interestRevenue * 0.05)); // Incluir 5% de costo operativo de cartera
                    
                    // Flujo para TIR Equity (despu칠s de impuestos y ajuste de financiamiento)
                    // Cash Flow to Equity (FCFE) = OCF - Capex + Net Borrowing (Principal Received - Principal Paid) + New Equity
                    const fcfes = operatingCash + investingCash + (newEquityRaisedThisPeriod - principalPaymentVentureDebtThisPeriod);
                    equityCashFlows.push(fcfes);
                }
                
                // ===== VALOR RESIDUAL DE ACTIVOS (Para TIR Proyecto) =====
                // Se calcula el valor de los activos al final del periodo de proyecci칩n (A침o 5)
                const terminalValue = financialResults.bs[4].fixedAssets + 
                                     financialResults.bs[4].receivables + 
                                     financialResults.bs[4].assetsHeldForSale;
                projectCashFlows[projectCashFlows.length - 1] += terminalValue; // A침adir al 칰ltimo flujo de projectCashFlows
                log(` Valor Residual de Activos (A침o 5): ${formatCurrency(terminalValue)} (a침adido a TIR Proyecto)`);


                // ===== C츼LCULO DE TIRs FINALES (despu칠s del bucle anual) =====
                log('\nCalculando TIR Proyecto...');
                financialResults.tirProyecto = calculateIRR(projectCashFlows);
                log(`TIR Proyecto calculada: ${financialResults.tirProyecto.toFixed(2)}%`);
                
                log('Calculando TIR Cartera...');
                if (portfolioCashFlowsForIRR.length > 0) {
                    // TIR Cartera: Inversi칩n inicial es la parte del costo total de vagonetas financiada con equity (al final del periodo)
                    const finalCumulativeUnits = fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0);
                    const finalTotalFixedAssetsOriginalCost = finalCumulativeUnits * modelData.vanCost;
                    const carteraInitialInvestment = finalTotalFixedAssetsOriginalCost * (1 - (modelData.ventureDebtPct / 100));
                    
                    const carteraCashFlows = [-carteraInitialInvestment, ...portfolioCashFlowsForIRR];
                    financialResults.tirCartera = calculateIRR(carteraCashFlows);
                } else {
                    financialResults.tirCartera = 0; // Si no hay flujos, TIR es 0
                }
                log(`TIR Cartera calculada: ${financialResults.tirCartera.toFixed(2)}%`);

                log('Calculando TIR Equity...');
                financialResults.tirEquity = calculateIRR(equityCashFlows);
                log(`TIR Equity calculada: ${financialResults.tirEquity.toFixed(2)}%`);

                log(' 九 C츼LCULOS FINANCIEROS COMPLETADOS CORRECTAMENTE');
                return true; // Indica que el c치lculo fue exitoso
                
            } catch (error) {
                log(` 仇 ERROR en calculateFinancials: ${error.message}`);
                console.error('Error cr칤tico en c치lculos financieros:', error);
                return false; // Indica que hubo un error
            }
        }

        // ===== FUNCI칍N DE C츼LCULO DE TIR (Tasa Interna de Retorno) =====
        // Implementaci칩n del m칠todo Newton-Raphson para calcular la TIR
        function calculateIRR(cashFlows, maxIterations = 100, tolerance = 1e-6) {
            try {
                // Validaci칩n b치sica de los flujos de efectivo
                if (!cashFlows || cashFlows.length < 2) {
                    log('TIR: Flujos insuficientes.');
                    return 0;
                }
                
                // Debe haber al menos un flujo positivo y uno negativo para que una TIR sea significativa
                const hasPositive = cashFlows.some(cf => cf > 0);
                const hasNegative = cashFlows.some(cf => cf < 0);
                if (!hasPositive || !hasNegative) {
                    log('TIR: No hay flujos positivos y negativos, TIR indefinida.');
                    return 0;
                }
                
                let guess = 0.1; // Estimaci칩n inicial de la TIR (10%)
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;    // Valor Presente Neto
                    let dNpv = 0;   // Derivada del NPV (para Newton-Raphson)
                    
                    for (let t = 0; t < cashFlows.length; t++) {
                        const denominator = Math.pow(1 + guess, t);
                        npv += cashFlows[t] / denominator;
                        if (t > 0) { // La derivada solo aplica a t칠rminos futuros
                            dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                        }
                    }
                    
                    // Si el NPV es cercano a cero, hemos encontrado la TIR
                    if (Math.abs(npv) < tolerance) {
                        // Retorna el resultado como porcentaje, limitado a un rango razonable
                        const result = Math.max(-99, Math.min(200, guess * 100)); 
                        log(`TIR convergi칩 en ${i} iteraciones: ${result.toFixed(2)}%`);
                        return result;
                    }
                    
                    // Evitar divisi칩n por cero si la derivada es muy peque침a
                    if (Math.abs(dNpv) < tolerance) {
                         log('TIR: Derivada cercana a cero, no se puede mejorar m치s.');
                         break;
                    }
                   
                    // Nuevo intento usando la f칩rmula de Newton-Raphson
                    const newGuess = guess - npv / dNpv;

                    // Si la mejora es m칤nima, detener la iteraci칩n
                    if (Math.abs(newGuess - guess) < tolerance) { 
                        const result = Math.max(-99, Math.min(200, newGuess * 100));
                        log(`TIR: Convergencia m칤nima, finalizando en ${i} iteraciones: ${result.toFixed(2)}%`);
                        return result;
                    }
                    
                    // Actualizar el intento, asegurando que 1 + guess sea siempre positivo para evitar NaN
                    guess = Math.max(-0.99, Math.min(5, newGuess)); 
                }
                
                // Si no se converge despu칠s de maxIterations, retornar el mejor intento
                const result = Math.max(-99, Math.min(200, guess * 100));
                log(`TIR no convergi칩 completamente (Max iteraciones): ${result.toFixed(2)}%`);
                return result; 
                
            } catch (error) {
                log(`Error inesperado calculando TIR: ${error.message}`);
                return 0; // En caso de cualquier error, retornar 0
            }
        }

        // ===== ACTUALIZACI칍N DE INTERFAZ DE USUARIO (UI) =====
        // Actualiza las m칠tricas clave en las tarjetas de resumen y luego las tablas y gr치ficos
        function updateUI() {
            log(' 游댃 Actualizando Interfaz de Usuario...');
            try {
                if (!financialResults.pl || financialResults.pl.length === 0) {
                    log(' 仇 No hay datos financieros para actualizar la UI.');
                    return;
                }
                
                // Actualizar las tarjetas de resumen
                const year5PL = financialResults.pl[4];
                const year5BS = financialResults.bs[4];
                // Calcular total de unidades financiadas sumando todos los a침os
                const totalUnitsAcquired = modelData.unitsPerYear.reduce((acc, curr) => acc + curr, 0);
                // Vagonetas operativas: total de unidades adquiridas - unidades clasificadas NIIF5 (acumuladas)
                const vagonetasOperativas = totalUnitsAcquired - (financialResults.niifDetails.reduce((sum, d) => sum + (d.niif5?.unidadesClasificadasAnuales || 0), 0));


                if (year5PL && year5BS) {
                    document.getElementById('ebitda-year5').textContent = formatCurrency(year5PL.ebitda);
                    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                    document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                    document.getElementById('tir-equity').textContent = financialResults.tirEquity.toFixed(1) + '%';
                    document.getElementById('deuda-residual').textContent = formatCurrency(year5BS.debt);
                    document.getElementById('vagonetas-operativas').textContent = Math.round(vagonetasOperativas);
                    
                    // Display ROE and ROIC for Year 5
                    document.getElementById('roe-year5').textContent = financialResults.roe[4].toFixed(1) + '%';
                    document.getElementById('roic-year5').textContent = financialResults.roic[4].toFixed(1) + '%';

                    log(` 九 M칠tricas principales y de rentabilidad actualizadas.`);

                    // Benchmarking al log de debug
                    log(` --- Benchmarking de Rentabilidad (A침o 5) ---`);
                    log(` TIR Equity: ${financialResults.tirEquity.toFixed(1)}% (Target Industria: 20-30%)`);
                    log(` TIR Proyecto: ${financialResults.tirProyecto.toFixed(1)}% (Target Industria: 15-20%)`);
                    log(` TIR Cartera: ${financialResults.tirCartera.toFixed(1)}% (Target Industria: 25-35%)`);
                    log(` ROE: ${financialResults.roe[4].toFixed(1)}% (Target Industria: 25-35%)`);
                    log(` ROIC: ${financialResults.roic[4].toFixed(1)}% (Target Industria: 12-18%)`);

                } else {
                    log(' 丘멆잺 Datos de A침o 5 incompletos para actualizar m칠tricas principales.');
                }
                
                updateTables(); // Actualiza tablas P&L, CF, BS
                updateNIIFTables(); // Actualiza tablas de detalles NIIF
                updateCharts(); // Actualiza gr치ficos

                // Ejecutar y mostrar validaciones despu칠s de actualizar la UI
                const validations = validateModelComprehensively(modelData, financialResults);
                updateValidationPanel(validations);
                
            } catch (error) {
                log(` 仇 Error en updateUI: ${error.message}`);
                console.error('Error al actualizar UI:', error);
            }
        }

        // Funci칩n que coordina la actualizaci칩n de todas las tablas financieras
        function updateTables() {
            updatePLTable();
            updateCashFlowTable();
            updateBalanceSheetTable();
        }

        // Actualiza la tabla del Estado de Resultados (P&L)
        function updatePLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody || !financialResults.pl.length) return;
            
            tbody.innerHTML = ''; // Limpiar tabla
            
            // Definici칩n de las filas del P&L
            const rows = [
                { label: 'Ingresos por Intereses', key: 'interestRevenue' },
                { label: 'Margen por Originaci칩n', key: 'originationCommission' },
                { label: 'Comisiones GNV', key: 'gnvCommissions' },
                { label: 'Ingresos Refacciones', key: 'sparePartsRevenue' },
                { label: 'Ingresos Marketplace', key: 'marketplaceRevenue' },
                { label: 'Total Ingresos Operativos', key: 'totalRevenue', total: true },
                { label: 'Gastos Operativos (OPEX)', key: 'opex', negative: true },
                { label: 'Provisiones NIIF 9', key: 'provisions', negative: true },
                { label: 'P칠rdida por Deterioro NIIF 5', key: 'impairment', negative: true },
                { label: 'EBITDA', key: 'ebitda', total: true, emphasize: true },
                { label: 'Depreciaci칩n', key: 'depreciation', negative: true },
                { label: 'Gastos por Intereses (Deuda)', key: 'interestExpense', negative: true },
                { label: 'Utilidad Neta', key: 'netIncome', total: true, emphasize: true }
            ];

            // Rellenar la tabla din치micamente
            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50'); // Fondo para totales
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900'); // Negrita para EBITDA y Utilidad Neta
                
                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.pl.forEach(yearData => {
                    const cell = document.createElement('td');
                    const value = yearData[row.key] || 0; // Obtener el valor, o 0 si es undefined
                    
                    // Formatear y aplicar clases de color
                    if (row.negative && value > 0) { // Si es un gasto y el valor es positivo, mostrar entre par칠ntesis y en rojo
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else { // Si no es un gasto o el valor es negativo, mostrar directamente
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });
            log(' 九 Tabla de Estado de Resultados actualizada.');
        }

        // Actualiza la tabla del Flujo de Efectivo (CF)
        function updateCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody || !financialResults.cf.length) return;
            
            tbody.innerHTML = ''; // Limpiar tabla
            
            // Definici칩n de las filas del Flujo de Efectivo
            const rows = [
                { label: 'Flujo de Efectivo Operativo', total: true },
                { label: '  Utilidad Neta', key: 'netIncome', fromPL: true },
                { label: '  + Depreciaci칩n', key: 'depreciation', fromPL: true },
                { label: '  + Provisiones NIIF 9', key: 'provisions', fromPL: true },
                { label: '  + P칠rdida por Deterioro NIIF 5', key: 'impairment', fromPL: true },
                { label: '  - 풊 Cuentas por Cobrar', key: 'deltaReceivables', negative: true, calculateDelta: true },
                { label: 'Total Flujo de Efectivo Operativo', key: 'operatingCash', total: true, emphasize: true },

                { label: 'Flujo de Efectivo de Inversi칩n', total: true, separator: true },
                { label: '  - CAPEX Vagonetas (Activos Fijos)', key: 'investingCash_capex', negative: true }, // Detalle de CAPEX
                { label: '  - Originaci칩n de Pr칠stamos Clientes', key: 'investingCash_loans', negative: true }, // Detalle de originaci칩n
                { label: 'Total Flujo de Efectivo de Inversi칩n', key: 'investingCash', total: true, emphasize: true, duplicate: true },
                
                { label: 'Flujo de Efectivo de Financiaci칩n', total: true, separator: true },
                { label: '  Serie A Recibida', year0: modelData.seriesA },
                { label: '  Venture Debt Inicial Recibido', year0: modelData.seriesA * (modelData.ventureDebtPct / 100) },
                { label: '  Serie B Funding Recibido', key: 'seriesB_funding', fromModelData: true, yearSpecific: true },
                { label: '  Serie C Funding Recibido', key: 'seriesC_funding', fromModelData: true, yearSpecific: true },
                { label: '  - Pago Capital Venture Debt', key: 'principalPaymentVentureDebt', negative: true },
                { label: '  + Funding Adicional (Plug de Liquidez)', key: 'additionalFundingRaised', positive: true }, // Nueva l칤nea para plug
                { label: 'Total Flujo de Efectivo de Financiaci칩n', key: 'financingCash', total: true, emphasize: true, duplicate: true },
                
                { label: 'Incremento Neto de Efectivo', key: 'netCash', total: true, separator: true, emphasize: true },
                { label: 'Saldo de Efectivo al Final del Periodo', key: 'cash', fromBS: true, total: true, emphasize: true }
            ];

            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                if (row.separator) tr.classList.add('border-t-2', 'border-gray-200'); // Separador para secciones de flujo

                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                // Celda para A침o 0
                const cell0 = document.createElement('td');
                if (row.year0 !== undefined) {
                    cell0.textContent = formatCurrency(row.year0);
                    cell0.classList.add('positive', 'font-bold');
                } else if (row.key === 'netCash' && financialResults.cf.length > 0) { // Net cash year 0 should be total Series A + Venture Debt received
                     const initialTotalFunding = modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100));
                     cell0.textContent = formatCurrency(initialTotalFunding);
                     cell0.classList.add('positive', 'font-bold');
                } else if (row.key === 'cash' && financialResults.cf.length > 0) { // Cash balance year 0 should be total Series A + Venture Debt
                     const initialTotalFunding = modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100));
                     cell0.textContent = formatCurrency(initialTotalFunding);
                     cell0.classList.add('positive', 'font-bold');
                }
                else {
                    cell0.textContent = '-'; // No hay valores para A침o 0 en otras filas
                }
                tr.appendChild(cell0);
                
                // Celdas para A침os 1-5
                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value;

                    if (row.fromPL) {
                        value = financialResults.pl[i][row.key] || 0;
                    } else if (row.fromBS) {
                        value = financialResults.bs[i][row.key] || 0;
                    } else if (row.key === 'principalPaymentVentureDebt') { 
                         value = financialResults.cf[i].principalPaymentVentureDebt || 0;
                    } else if (row.key === 'clientPrincipalPaymentsReceived') {
                        value = financialResults.cf[i].clientPrincipalPaymentsReceived || 0;
                    } else if (row.key === 'additionalFundingRaised') {
                        value = financialResults.cf[i].additionalFundingRaised || 0;
                    } else if (row.key === 'investingCash_capex') {
                        value = modelData.unitsPerYear[i] * modelData.vanCost; // CAPEX de vagonetas para este a침o
                    } else if (row.key === 'investingCash_loans') {
                        // totalPrincipalOriginatedThisYear no est치 almacenado anualmente en cf, calcularlo
                        value = modelData.unitsPerYear[i] * modelData.vanPrice; // Originaci칩n de pr칠stamos para este a침o
                    }
                    else if (row.key === 'deltaReceivables') {
                        // Delta de CxC es especial porque se calcula de a침o a a침o.
                        const prevReceivables = (i === 0) ? 0 : financialResults.bs[i-1].receivables;
                        const currentReceivables = financialResults.bs[i].receivables;
                        value = currentReceivables - prevReceivables;
                    } else if (row.fromModelData && row.yearSpecific) {
                        // Handle Series B and C funding
                        const currentYear = i + 1;
                        if (row.key === 'seriesB_funding' && currentYear === modelData.seriesB_year) {
                            value = modelData.seriesB_funding;
                        } else if (row.key === 'seriesC_funding' && currentYear === modelData.seriesC_year) {
                            value = modelData.seriesC_funding;
                        } else {
                            value = 0; // No funding in this year for this series
                        }
                    }
                     else {
                        value = financialResults.cf[i][row.key] || 0;
                    }
                    
                    // Formato y color
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else if (row.positive && value > 0) {
                         cell.textContent = formatCurrency(value);
                         cell.classList.add('positive');
                    }
                    else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                }
                
                tbody.appendChild(tr);
            });
            log(' 九 Tabla de Flujo de Efectivo actualizada.');
        }

        // Actualiza la tabla del Balance General (BS)
        function updateBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody || !financialResults.bs.length) return;
            
            tbody.innerHTML = ''; // Limpiar tabla
            
            // Definici칩n de las filas del Balance General
            const rows = [
                { label: 'ACTIVOS', total: true, emphasize: true },
                { label: '  Efectivo y Equivalentes', key: 'cash' },
                { label: '  Cuentas por Cobrar (Principal)', key: 'receivables' },
                { label: '  Activos Fijos Netos (Vagonetas)', key: 'fixedAssets' },
                { label: '  Activos Mantenidos para Venta (NIIF 5)', key: 'assetsHeldForSale' },
                { label: 'TOTAL ACTIVOS', key: 'totalAssets', total: true, emphasize: true },

                { label: 'PASIVOS Y PATRIMONIO', total: true, separator: true, emphasize: true },
                { label: '  Deuda Venture', key: 'debt' },
                { label: '  Provisiones NIIF 9 (Acumuladas)', key: 'provisions' },
                { label: '  Pasivos por Contrato (NIIF 15)', key: 'contractLiabilities' }, // Nueva l칤nea para pasivos por contrato
                { label: 'TOTAL PASIVOS', key: 'totalLiabilities', total: true }, 
                { label: '  Patrimonio', key: 'equity' },
                { label: 'TOTAL PASIVOS + PATRIMONIO', key: 'totalLiabilitiesEquity', total: true, emphasize: true }
            ];

            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.total) tr.classList.add('bg-gray-50');
                if (row.emphasize) tr.classList.add('font-bold', 'text-gray-900');
                if (row.separator) tr.classList.add('border-t-2', 'border-gray-200');

                const labelCell = document.createElement('td');
                labelCell.textContent = row.label;
                if (row.total) labelCell.classList.add('font-bold');
                tr.appendChild(labelCell);
                
                financialResults.bs.forEach(yearData => {
                    const cell = document.createElement('td');
                    let value;
                    if (row.key === 'totalLiabilities') { // C치lculo espec칤fico para Total Pasivos
                        value = yearData.debt + yearData.provisions + yearData.contractLiabilities;
                    } else {
                        value = yearData[row.key] || 0;
                    }
                    
                    // Formato y color
                    if (row.negative && value > 0) {
                        cell.textContent = '(' + formatCurrency(value) + ')';
                        cell.classList.add('negative');
                    } else {
                        cell.textContent = formatCurrency(value);
                        if (value > 0 && !row.negative) cell.classList.add('positive');
                        if (value < 0) cell.classList.add('negative');
                    }
                    
                    if (row.total) cell.classList.add('font-bold');
                    tr.appendChild(cell);
                });
                
                tbody.appendChild(tr);
            });

            // Validar Balance (Activos = Pasivos + Patrimonio)
            // Note: This basic balance validation is now part of the comprehensive validation system.
            // Keeping it here for quick reference but `updateValidationPanel` will show the detailed result.
            const validationDiv = document.getElementById('balance-validation');
            let balanceValid = true;
            let maxDifference = 0;
            
            financialResults.bs.forEach(yearData => {
                const difference = Math.abs(yearData.totalAssets - yearData.totalLiabilitiesEquity);
                maxDifference = Math.max(maxDifference, difference);
                if (difference > 1000) balanceValid = false; // Tolerancia de $1,000 para la validaci칩n
            });
            if (balanceValid) {
                validationDiv.innerHTML = '<span class="text-green-600"> 九 Balance validado: Total Activos = Total Pasivos + Patrimonio.</span>';
                validationDiv.classList.remove('bg-red-100', 'text-red-800');
                validationDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                validationDiv.innerHTML = `<span class="text-red-600"> 仇 Error en balance: Diferencia de ${formatCurrency(maxDifference)}. Revisa c치lculos.</span>`;
                validationDiv.classList.remove('bg-green-100', 'text-green-800');
                validationDiv.classList.add('bg-red-100', 'text-red-800');
            }
            log(' 九 Tabla de Balance General actualizada y validada.');
        }

        // ===== TABLAS DE DETALLES NIIF =====
        // Actualiza las secciones de NIIF 15, NIIF 9 y NIIF 5
        function updateNIIFTables() {
            log('Actualizando tablas de detalles NIIF...');
            if (!financialResults.niifDetails || financialResults.niifDetails.length === 0) {
                log(' 仇 No hay datos NIIF para mostrar.');
                return;
            }
            
            // --- NIIF 15: Reconocimiento de Ingresos ---
            const container15 = document.getElementById('niif15-container');
            if (container15) {
                container15.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A침o 1</th>
                                    <th>A침o 2</th>
                                    <th>A침o 3</th>
                                    <th>A침o 4</th>
                                    <th>A침o 5</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Ingresos Operativos Totales (Contrato)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.totalOriginationContractValue + d.niif15.gnvCommissions + d.niif15.sparePartsRevenue + d.niif15.marketplaceRevenue + d.niif15.interestRevenue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Margen Originaci칩n (Contrato)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.totalOriginationContractValue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Margen Originaci칩n (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td class="positive">${formatCurrency(d.niif15.recognizedOriginationRevenue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Pasivos por Contrato (Acumulado)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.contractLiabilitiesBalance)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos GNV (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.gnvCommissions)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos Refacciones (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.sparePartsRevenue)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>Ingresos Marketplace (Reconocido P&L)</td>
                                    ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.marketplaceRevenue)}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                        <h5 class="font-semibold text-base mb-1">Explicaci칩n NIIF 15 (Ingresos Ordinarios)</h5>
                        <p class="mb-1"> NIIF 15 establece un modelo de 5 pasos para reconocer ingresos que provienen de contratos con clientes. La clave es reconocer los ingresos cuando (o a medida que) se satisfacen las **obligaciones de desempe침o**.</p>
                        <p class="mb-1"> Para Rodando a Gas, se identifican las siguientes obligaciones de desempe침o:</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>**Margen por Originaci칩n (comisi칩n inicial):** Se reconoce **a lo largo del tiempo** durante la vida del pr칠stamo al cliente. El efectivo se recibe upfront, pero contablemente se difiere como un "Pasivo por Contrato" y se reconoce como ingreso gradualmente.</li>
                            <li>**Servicios GNV y Marketplace:** Se reconocen **a lo largo del tiempo** a medida que los servicios se proveen anualmente por las unidades activas en la cartera.</li>
                            <li>**Servicios de Refacciones:** Se reconoce **en un punto en el tiempo** (al momento de la entrega del servicio/producto de refacci칩n, asumido en el a침o de adici칩n de la unidad).</li>
                        </ul>
                        <p class="mb-1"> Los ingresos por intereses se rigen por NIIF 9 (Instrumentos Financieros), no por NIIF 15.</p>
                        <p class="mb-1"> El Balance General ahora refleja los **Pasivos por Contrato** para los ingresos de originaci칩n que han sido cobrados pero a칰n no reconocidos.</p>
                    </div>
                `;
                log(' 九 NIIF 15 actualizada.');
            }
            
            // --- NIIF 9: Provisiones Crediticias ---
            const container9 = document.getElementById('niif9-container');
            if (container9) {
                const year5NIIF9 = financialResults.niifDetails[4]?.niif9; // Obtener datos del A침o 5 para el resumen
                if (year5NIIF9) {
                    container9.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="p-4 bg-blue-100 rounded-lg text-center">
                                <h5 class="font-semibold text-blue-800">Exposici칩n Etapa 1</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eadStage1)}</p>
                                <p class="text-sm">ECL 12 meses (PD: ${(year5NIIF9.pdStage1 * 100).toFixed(1)}%)</p>
                                <p class="text-lg font-bold text-blue-900">${formatCurrency(year5NIIF9.eclStage1Amount)}</p>
                            </div>
                            <div class="p-4 bg-yellow-100 rounded-lg text-center">
                                <h5 class="font-semibold text-yellow-800">Exposici칩n Etapa 2</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eadStage2)}</p>
                                <p class="text-sm">ECL Lifetime (PD: ${(year5NIIF9.pdStage2 * 100).toFixed(1)}%)</p>
                                <p class="text-lg font-bold text-yellow-900">${formatCurrency(year5NIIF9.eclStage2Amount)}</p>
                            </div>
                            <div class="p-4 bg-red-100 rounded-lg text-center">
                                <h5 class="font-semibold text-red-800">Exposici칩n Etapa 3</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF9.eadStage3)}</p>
                                <p class="text-sm">ECL Lifetime (PD: ${(year5NIIF9.pdStage3 * 100).toFixed(1)}%)</p>
                                <p class="text-lg font-bold text-red-900">${formatCurrency(year5NIIF9.eclStage3Amount)}</p>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-indigo-50 rounded-lg mb-4">
                            <h5 class="font-semibold text-indigo-900">Total Provisiones ECL Antes de Ajustes</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.totalECLBeforeAdjustment)}</p>
                            <p class="text-sm">LGD: ${(year5NIIF9.lgd * 100).toFixed(1)}%. Ajuste Econ칩mico: ${year5NIIF9.economicAdjustmentFactor.toFixed(2)}x</p>
                        </div>
                        <div class="text-center p-4 ${year5NIIF9.proteccionRodandoActiva ? 'bg-green-50' : 'bg-gray-200'} rounded-lg">
                            <h5 class="font-semibold ${year5NIIF9.proteccionRodandoActiva ? 'text-green-900' : 'text-gray-900'}">Gasto por Provisiones NIIF 9 (P&L del A침o 5)</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.provisionesConProteccion)}</p>
                            ${year5NIIF9.proteccionRodandoActiva ? 
                                `<p class="text-sm text-green-700"> 九 Reducci칩n: ${formatCurrency(year5NIIF9.reduccionPorProteccion)}</p>` : 
                                '<p class="text-sm text-gray-700">Protecci칩n Rodando inactiva</p>'}
                        </div>
                        <div class="mt-4 text-center p-4 bg-gray-300 rounded-lg">
                            <h5 class="font-semibold text-gray-900">Saldo Acumulado de Provisiones NIIF 9 (Balance A침o 5)</h5>
                            <p class="text-2xl font-bold">${formatCurrency(year5NIIF9.saldoProvisionesAcumulado)}</p>
                            <p class="text-sm">Este es el pasivo acumulado que aparece en el Balance General.</p>
                        </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                            <h5 class="font-semibold text-base mb-1">Explicaci칩n NIIF 9 (Instrumentos Financieros)</h5>
                            <p class="mb-1"> NIIF 9 requiere el reconocimiento de provisiones por p칠rdidas crediticias esperadas (ECL) sobre los instrumentos financieros (cartera de pr칠stamos).</p>
                            <p class="mb-1"> **Modelo de Tres Etapas:** La cartera se segmenta por riesgo.</p>
                            <ul class="list-disc list-inside ml-4">
                                <li>**Etapa 1:** Activos con bajo riesgo de cr칠dito (ECL a 12 meses).</li>
                                <li>**Etapa 2:** Activos con un aumento significativo en el riesgo de cr칠dito (ECL de por vida).</li>
                                <li>**Etapa 3:** Activos con deterioro de cr칠dito (ECL de por vida).</li>
                            </ul>
                            <p class="mb-1"> **C치lculo de ECL:** ECL = Exposici칩n a Incumplimiento (EAD) 칑 Probabilidad de Incumplimiento (PD) 칑 P칠rdida Dado Incumplimiento (LGD).</p>
                            <p class="mb-1"> **Informaci칩n Prospectiva:** El factor de ajuste econ칩mico permite incorporar expectativas futuras sobre el riesgo de cr칠dito.</p>
                            <p class="mb-1"> "Protecci칩n Rodando" simula un mecanismo que reduce el gasto final por provisiones.</p>
                            <p class="mt-2 text-red-700 font-bold">Nota: En este modelo, la migraci칩n entre etapas se simula mediante una distribuci칩n porcentual fija de la cartera total para cada a침o, lo cual es una simplificaci칩n com칰n para modelos agregados de alto nivel, en lugar de un seguimiento individual de cada pr칠stamo.</p>
                        </div>
                    `;
                    log(' 九 NIIF 9 actualizada.');
                } else {
                     log(' 丘멆잺 Datos de NIIF 9 para A침o 5 incompletos.');
                }
            }
            
            // --- NIIF 5: Activos Mantenidos para Venta ---
            const container5 = document.getElementById('niif5-container');
            if (container5) {
                const year5NIIF5 = financialResults.niifDetails[4]?.niif5; // Obtener datos del A침o 5 para el resumen
                if (year5NIIF5) {
                    container5.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <h5 class="font-semibold text-purple-900">Unidades Reposadas (A침o 5)</h5>
                                <p class="text-xl font-bold">${year5NIIF5.unidadesClasificadasAnuales.toFixed(0)}</p>
                                <p class="text-sm">Unidades clasificadas como mantenidas para venta este a침o.</p>
                            </div>
                            <div class="p-4 bg-indigo-50 rounded-lg">
                                <h5 class="font-semibold text-indigo-900">Valor en Libros (Activos Reposedos A침o 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorEnLibrosClasificado)}</p>
                                <p class="text-sm">Costo hist칩rico de las unidades clasificadas para venta en el A침o 5.</p>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h5 class="font-semibold text-blue-900">Valor Razonable Neto (A침o 5)</h5>
                                <p class="text-xl font-bold">${formatCurrency(year5NIIF5.valorRazonableMenosCostos)}</p>
                                <p class="text-sm">Valor de venta esperado menos costos.</p>
                            </div>
                            <div class="p-4 ${year5NIIF5.perdidaPorDeterioro > 0 ? 'bg-red-50' : 'bg-green-50'} rounded-lg">
                                <h5 class="font-semibold ${year5NIIF5.perdidaPorDeterioro > 0 ? 'text-red-900' : 'text-green-900'}">P칠rdida por Deterioro (A침o 5)</h5>
                                <p class="text-xl font-bold">${year5NIIF5.perdidaPorDeterioro > 0 ? formatCurrency(year5NIIF5.perdidaPorDeterioro) : 'Ninguna'}</p>
                                <p class="text-sm">Impacto en el Estado de Resultados.</p>
                            </div>
                        </div>
                        <div class="text-center p-4 bg-gray-200 rounded-lg">
                             <h5 class="font-semibold text-gray-800">Saldo Acumulado de Activos NIIF 5 (A침o 5)</h5>
                             <p class="text-2xl font-bold">${formatCurrency(year5NIIF5.saldoActivosParaVentaAcumulado)}</p>
                             <p class="text-sm">Este es el saldo que aparece en el Balance General.</p>
                         </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm">
                            <h5 class="font-semibold text-base mb-1">Explicaci칩n NIIF 5 (Activos No Corrientes Mantenidos para la Venta)</h5>
                            <p class="mb-1"> Los activos no corrientes (vagonetas) que se esperan vender en un corto plazo se clasifican como "Mantenidos para la Venta".</p>
                            <p class="mb-1"> Estos activos se valoran al menor entre su valor en libros y su valor razonable menos los costos de venta. Se suspende su depreciaci칩n.</p>
                            <p class="mb-1"> Se reconoce una p칠rdida por deterioro si el valor en libros excede el valor razonable neto de venta. Las ganancias por reversi칩n de deterioro est치n limitadas a la p칠rdida original.</p>
                        </div>
                    `;
                    log(' 九 NIIF 5 actualizada.');
                } else {
                    log(' 丘멆잺 Datos de NIIF 5 para A침o 5 incompletos.');
                }
            }
        }

        // ===== GR츼FICOS (Chart.js) =====
        // Inicializa las instancias de los gr치ficos
        function initializeCharts() {
            try {
                // Gr치fico de EBITDA
                const ctxEbitda = document.getElementById('ebitdaChart');
                if (ctxEbitda) {
                    charts.ebitda = new Chart(ctxEbitda, {
                        type: 'line',
                        data: {
                            labels: ['A침o 1', 'A침o 2', 'A침o 3', 'A침o 4', 'A침o 5'],
                            datasets: [{
                                label: 'EBITDA (M MXN)',
                                data: [],
                                borderColor: '#3b82f6', // blue-500
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.3 // Suavizar la l칤nea
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'A침o Fiscal' } }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
                
                // Gr치fico de Composici칩n de Ingresos
                const ctxRevenueMix = document.getElementById('revenueMixChart');
                if (ctxRevenueMix) {
                    charts.revenueMix = new Chart(ctxRevenueMix, {
                        type: 'doughnut',
                        data: {
                            labels: ['Intereses', 'Originaci칩n', 'GNV', 'Refacciones', 'Marketplace'],
                            datasets: [{
                                data: [],
                                backgroundColor: ['#34D399', '#FBBF24', '#60A5FA', '#8B5CF6', '#EC4899'] // Colores Tailwind: green, amber, blue, violet, pink
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right' },
                                title: { display: true, text: 'Composici칩n de Ingresos (A침o 5)' }
                            }
                        }
                    });
                }

                // Gr치fico de Validaci칩n de Balance
                const ctxBalanceValidation = document.getElementById('balanceValidationChart');
                if (ctxBalanceValidation) {
                    charts.balanceValidation = new Chart(ctxBalanceValidation, {
                        type: 'bar',
                        data: {
                            labels: ['A침o 1', 'A침o 2', 'A침o 3', 'A침o 4', 'A침o 5'],
                            datasets: [
                                {
                                    label: 'Total Activos',
                                    data: [],
                                    backgroundColor: '#3b82f6', // blue-500
                                },
                                {
                                    label: 'Total Pasivos + Patrimonio',
                                    data: [],
                                    backgroundColor: '#ef4444', // red-500
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'A침o Fiscal' } }
                            },
                            plugins: {
                                legend: { position: 'top' }
                            }
                        }
                    });
                }

                // Gr치fico de Flujo de Efectivo Neto Anual
                const ctxNetCashFlow = document.getElementById('netCashFlowChart');
                if (ctxNetCashFlow) {
                    charts.netCashFlow = new Chart(ctxNetCashFlow, {
                        type: 'bar',
                        data: {
                            labels: ['A침o 1', 'A침o 2', 'A침o 3', 'A침o 4', 'A침o 5'],
                            datasets: [{
                                label: 'Flujo Neto de Efectivo (M MXN)',
                                data: [],
                                backgroundColor: (context) => {
                                    // Verificar si context.parsed y context.parsed.y existen
                                    if (context.parsed && typeof context.parsed.y === 'number') {
                                        const value = context.parsed.y;
                                        return value >= 0 ? '#10b981' : '#ef4444'; // green-500 for positive, red-500 for negative
                                    }
                                    return '#6b7280'; // Default color if data is not yet available or invalid
                                }
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                                x: { title: { display: true, text: 'A침o Fiscal' } }
                            },
                             plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }

                log(' 九 Gr치ficos inicializados.');
            } catch (error) {
                log(`Error inicializando gr치ficos: ${error.message}`);
                console.error('Error inicializando gr치ficos:', error);
            }
        }
        
        // Actualiza los datos de los gr치ficos con los resultados financieros actuales
        function updateCharts() {
            try {
                if (!financialResults.pl.length) return;
                
                // Actualizar Gr치fico de EBITDA
                if (charts.ebitda) {
                    const ebitdas = financialResults.pl.map(d => d.ebitda / 1000000); // En Millones para el gr치fico
                    charts.ebitda.data.datasets[0].data = ebitdas;
                    charts.ebitda.update();
                }
                
                // Actualizar Gr치fico de Composici칩n de Ingresos (A침o 5)
                if (charts.revenueMix && financialResults.pl[4]) { 
                    const year5 = financialResults.pl[4];
                    charts.revenueMix.data.datasets[0].data = [
                        year5.interestRevenue,
                        year5.originationCommission,
                        year5.gnvCommissions,
                        year5.sparePartsRevenue,
                        year5.marketplaceRevenue
                    ];
                    charts.revenueMix.update();
                }

                // Actualizar Gr치fico de Validaci칩n de Balance
                if (charts.balanceValidation) {
                    const totalAssetsData = financialResults.bs.map(d => d.totalAssets / 1000000);
                    const totalLiabilitiesEquityData = financialResults.bs.map(d => d.totalLiabilitiesEquity / 1000000);
                    charts.balanceValidation.data.datasets[0].data = totalAssetsData;
                    charts.balanceValidation.data.datasets[1].data = totalLiabilitiesEquityData;
                    charts.balanceValidation.update();
                }

                // Actualizar Gr치fico de Flujo de Efectivo Neto Anual
                if (charts.netCashFlow) {
                    const netCashFlows = financialResults.cf.map(d => d.netCash / 1000000);
                    charts.netCashFlow.data.datasets[0].data = netCashFlows;
                    charts.netCashFlow.update();
                }
                
                log(' 九 Gr치ficos actualizados.');
            } catch (error) {
                log(`Error actualizando gr치ficos: ${error.message}`);
                console.error('Error actualizando gr치ficos:', error);
            }
        }

        // ===== FUNCIONES AUXILIARES =====
        // Formatea un valor num칠rico a formato de moneda (millones, miles o sin prefijo)
        function formatCurrency(value, full = false) {
            if (value === null || value === undefined) return '$0 MXN';
            value = parseFloat(value);
            if (isNaN(value)) return '$0 MXN';

            if (full) { // Formato completo con comas
                return '$' + value.toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' MXN';
            } else if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            } else if (Math.abs(value) >= 1000) {
                return '$' + (value / 1000).toFixed(1) + 'K MXN';
            }
            return '$' + Math.round(value).toLocaleString() + ' MXN';
        }

        // Fuerza un rec치lculo manual del modelo
        function forceCalculate() {
            log(' 游댃 Rec치lculo manual solicitado.');
            if (calculateFinancials()) {
                updateUI();
                log(' 九 Rec치lculo manual completado.');
            } else {
                log(' 仇 Fallo en el rec치lculo manual.');
            }
        }

        // ===== CONFIGURACI칍N DE CONTROLES DE USUARIO =====
        // Genera y vincula los inputs de tipo "range" (sliders)
        function setupSliderControls() {
            const container = document.getElementById('credit-risk-controls');
            const operationsContainer = document.getElementById('operations-debt-controls');

            sliderConfigs.forEach(config => {
                const parentDiv = document.createElement('div');
                parentDiv.innerHTML = `
                    <label class="flex justify-between text-sm font-medium text-gray-700">
                        ${config.label} 
                        <span id="${config.id}-valor" class="font-bold text-indigo-600">${config.format(modelData[config.id])}</span>
                    </label>
                    <input type="range" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}" class="input-slider mt-1">
                `;
                
                if (['tasaInteres', 'tasaMorosidad'].includes(config.id)) {
                    container.appendChild(parentDiv);
                } else {
                    operationsContainer.appendChild(parentDiv);
                }

                const slider = parentDiv.querySelector(`#${config.id}-input`);
                const display = parentDiv.querySelector(`#${config.id}-valor`);
                
                slider.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    modelData[config.id] = value;
                    display.textContent = config.format(value);
                    log(`${config.label} cambiado a: ${value}`);
                    // Recalcular y actualizar UI en cada cambio de slider
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });

            // Checkbox para Protecci칩n Rodando
            const checkbox = document.getElementById('check-proteccion');
            if (checkbox) {
                checkbox.checked = modelData.proteccionRodando; // Establecer estado inicial
                checkbox.addEventListener('change', function() {
                    modelData.proteccionRodando = this.checked;
                    log(`Protecci칩n Rodando: ${this.checked ? 'ACTIVADA' : 'DESACTIVADA'}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            }
            log(' 九 Controles deslizables (sliders) configurados.');
        }

        // Genera y vincula los inputs num칠ricos (constantes del modelo y unidades por a침o)
        function setupNumberControls() {
            const unitsContainer = document.getElementById('units-container');
            const constantsContainer = document.getElementById('constants-container');

            // Inputs para Unidades por A침o
            modelData.unitsPerYear.forEach((units, index) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label for="unit-year-${index+1}" class="text-sm font-medium text-gray-700 mb-1">Unidades A침o ${index+1}</label>
                    <input type="number" id="unit-year-${index+1}" min="0" max="1000" value="${units}" 
                           class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                `;
                unitsContainer.appendChild(div);
                
                const input = document.getElementById(`unit-year-${index+1}`);
                input.addEventListener('change', function() {
                    const value = parseInt(this.value) || 0;
                    // Asegurar que el valor est칠 dentro de los l칤mites
                    modelData.unitsPerYear[index] = Math.max(0, Math.min(1000, value)); 
                    this.value = modelData.unitsPerYear[index]; // Actualizar input si se ajust칩
                    
                    log(`Unidades A침o ${index+1} cambiado a: ${modelData.unitsPerYear[index]}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });

            // Inputs para Constantes del Modelo
            constantConfigs.forEach(config => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label for="${config.id}-input" class="text-sm font-medium text-gray-700 mb-1">${config.label}</label>
                    <input type="${config.type}" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}"
                           class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <span class="text-xs text-gray-500 mt-1" id="${config.id}-display">${config.format(modelData[config.id])}</span>
                `;
                constantsContainer.appendChild(div);

                const input = div.querySelector(`#${config.id}-input`);
                const display = div.querySelector(`#${config.id}-display`);

                input.addEventListener('input', function() {
                    let value = parseFloat(this.value);
                    if (isNaN(value)) value = 0; // Default to 0 if input is not a number

                    // Ensure value is within min/max, especially for percentages
                    if (config.type === 'number') {
                         if (value < config.min) value = config.min;
                         if (value > config.max) value = config.max;
                         this.value = value; // Update the input field
                    }

                    modelData[config.id] = value;
                    display.textContent = config.format(value);
                    log(`${config.label} cambiado a: ${value}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
            log(' 九 Controles num칠ricos (constantes y unidades) configurados.');
        }


        // Configura la navegaci칩n entre pesta침as
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // Remover la clase 'active' de todos los botones y secciones
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    // A침adir la clase 'active' al bot칩n y secci칩n actuales
                    button.classList.add('active');
                    contentSections[index].classList.add('active');
                    
                    // Forzar actualizaci칩n de tablas y gr치ficos al cambiar de pesta침a
                    // Esto es 칰til si los datos se cargan lentamente o si se requiere un re-render
                    if (button.id === 'tab-financieros' || button.id === 'tab-niif' || button.id === 'tab-graficos') {
                        setTimeout(() => {
                            if (calculateFinancials()) { // Recalcular antes de actualizar UI
                                updateUI();
                            }
                        }, 50); // Peque침o retraso para asegurar que la pesta침a est칠 visible
                    }
                });
            });
            log(' 九 Navegaci칩n por pesta침as configurada.');
        }

        // ===== FUNCIONES DE VALIDACI칍N INTEGRAL =====

        // Objeto para almacenar los resultados de la validaci칩n
        // { errors: [], warnings: [], info: [], passed: [] }
        function validateModelComprehensively(modelData, financialResults) {
            const validations = {
                errors: [],      // 游댮 Cr칤ticos - Requieren correcci칩n, el modelo es inviable
                warnings: [],    // 游리 Importantes - Indican posibles problemas o resultados inusuales
                info: [],        // 游댯 Informativos - Sugerencias o datos interesantes
                passed: []       // 九 Exitosos - Cumplen con las expectativas
            };
            
            // Nivel 1: Validaci칩n de Inputs B치sicos
            validateInputs(modelData, validations);
            
            // Solo si los resultados financieros existen y son v치lidos para continuar
            if (financialResults.pl.length > 0 && financialResults.cf.length > 0 && financialResults.bs.length > 0) {
                // Nivel 2: Validaci칩n de Outputs y Cordura
                validateOutputs(financialResults, validations);
                // Nivel 3: Consistencia entre Estados Financieros
                validateConsistency(financialResults, validations);
                // Nivel 4: Evoluci칩n Temporal
                validateTemporal(financialResults, validations);
                // Nivel 5: Benchmarks de Industria (si hay datos suficientes para el a침o 5)
                if (financialResults.pl.length === 5) {
                    validateIndustryBenchmarks(financialResults, validations);
                } else {
                    validations.info.push("No hay suficientes a침os de proyecci칩n para evaluar los benchmarks de industria.");
                }
            } else {
                validations.errors.push("No se pudieron calcular los resultados financieros. Por favor, revise los inputs iniciales.");
            }
            
            return validations;
        }

        // Nivel 1: Validar Inputs B치sicos
        function validateInputs(modelData, validations) {
            // Check basic non-negativity for key inputs
            if (modelData.seriesA <= 0) {
                validations.errors.push("游댮 Error: El Capital de Serie A debe ser mayor que 0. Ajuste 'Capital Serie A' en Control.");
            }
            if (modelData.vanCost <= 0) {
                validations.errors.push("游댮 Error: El Costo de Vagoneta debe ser mayor que 0. Ajuste 'Costo Vagoneta (RAG)' en Control.");
            }
            if (modelData.vanPrice <= 0) {
                validations.errors.push("游댮 Error: El Precio de Pr칠stamo al Cliente debe ser mayor que 0. Ajuste 'Precio Pr칠stamo Cliente' en Control.");
            }
            if (modelData.clientLoanTermYears <= 0) {
                validations.errors.push("游댮 Error: El Plazo del Pr칠stamo al Cliente debe ser mayor que 0. Ajuste 'Plazo Pr칠stamo Cliente' en Control.");
            }
            if (modelData.depreciationYears <= 0) {
                validations.errors.push("游댮 Error: Los A침os de Depreciaci칩n deben ser mayor que 0. Ajuste 'A침os Depreciaci칩n' en Control.");
            }
            if (modelData.periodoAmortizacionDeuda <= 0) {
                validations.errors.push("游댮 Error: El Plazo de Amortizaci칩n de Deuda debe ser mayor que 0. Ajuste 'Plazo Amort. Deuda' en Control.");
            }

            // Check percentage inputs for reasonable range (0-100%, or 0-1 for decimals)
            const percentageInputs = [
                { id: 'tasaInteres', min: 0, max: 100 }, { id: 'tasaMorosidad', min: 0, max: 100 },
                { id: 'comisionGNV', min: 0, max: 100 }, { id: 'margenRefacciones', min: 0, max: 100 },
                { id: 'ventureDebtPct', min: 0, max: 100 }, { id: 'ventureDebtRate', min: 0, max: 100 },
                { id: 'opexRate', min: 0, max: 100 }, { id: 'margenVagoneta', min: 0, max: 100 },
                { id: 'marketplace', min: 0, max: 100 }, { id: 'tasaReposicion', min: 0, max: 100 },
                { id: 'fairValueVenta', min: 0, max: 100 }, { id: 'costosVenta', min: 0, max: 100 },
                { id: 'corporateTaxRate', min: 0, max: 100 }
            ];
            percentageInputs.forEach(p => {
                if (modelData[p.id] < p.min || modelData[p.id] > p.max) {
                    validations.warnings.push(`游리 Advertencia: '${p.label}' (${modelData[p.id]}%) est치 fuera del rango t칤pico (${p.min}-${p.max}%). Revise en Control.`);
                }
            });

            // Check PD and LGD (which are decimals) for reasonable range
            const decimalPercentageInputs = [
                { id: 'pdStage1', min: 0, max: 0.1 }, { id: 'pdStage2', min: 0.01, max: 0.5 },
                { id: 'pdStage3', min: 0.1, max: 0.9 }, { id: 'lgd', min: 0, max: 1 }
            ];
            decimalPercentageInputs.forEach(p => {
                if (modelData[p.id] < p.min || modelData[p.id] > p.max) {
                    validations.warnings.push(`游리 Advertencia: '${p.label}' (${(modelData[p.id]*100).toFixed(1)}%) est치 fuera del rango t칤pico. Revise en Control.`);
                }
            });

            // Check portfolio allocation sums to 100%
            const totalAllocation = modelData.portfolioAllocationStage1 + modelData.portfolioAllocationStage2 + modelData.portfolioAllocationStage3;
            if (Math.abs(totalAllocation - 1.0) > 0.001) { // Allow for small floating point inaccuracies
                validations.errors.push(`游댮 Error: La suma de la Asignaci칩n de Portafolio NIIF 9 (${(totalAllocation*100).toFixed(1)}%) no es igual a 100%. Por favor, ajuste en Control.`);
            } else {
                validations.passed.push(`九 Inputs: Asignaci칩n de Portafolio NIIF 9 suma 100%.`);
            }

            // Check that units per year are not negative
            modelData.unitsPerYear.forEach((units, index) => {
                if (units < 0) {
                    validations.errors.push(`游댮 Error: Las Unidades para el A침o ${index + 1} son negativas (${units}). Ajuste en Control.`);
                }
            });

            validations.passed.push("九 Inputs: Par치metros b치sicos de entrada validados correctamente.");
        }

        // Nivel 2: Validar Outputs y Cordura Financiera
        function validateOutputs(financialResults, validations) {
            const lastYear = financialResults.pl.length - 1; // Assuming 5 years, this will be 4
            if (lastYear < 0) return; // No data to validate

            // Check cash balance for all years
            financialResults.bs.forEach((bsYear, index) => {
                if (bsYear.cash < 0) {
                    validations.errors.push(`游댮 Error: El Saldo de Efectivo al final del A침o ${index + 1} es negativo (${formatCurrency(bsYear.cash)}). El modelo requiere m치s financiaci칩n.`);
                }
            });
            if (validations.errors.filter(e => e.includes("Efectivo")).length === 0) {
                 validations.passed.push("九 Outputs: Saldo de efectivo es positivo en todos los a침os.");
            }

            const year5PL = financialResults.pl[lastYear];
            const year5BS = financialResults.bs[lastYear];

            // Margen EBITDA: -50% to +100% (as percentage of revenue)
            if (year5PL.totalRevenue !== 0) {
                const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
                if (ebitdaMargin < -50 || ebitdaMargin > 100) {
                    validations.warnings.push(`游리 Advertencia: Margen EBITDA del A침o ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) es inusual. Revise supuestos. (Rango t칤pico: -50% a +100%).`);
                } else {
                    validations.passed.push(`九 Outputs: Margen EBITDA del A침o ${lastYear + 1} es realista (${ebitdaMargin.toFixed(1)}%).`);
                }
            }

            // ROE: -100% a +200%
            if (financialResults.roe.length > lastYear && year5BS.equity !== 0) {
                const roe = financialResults.roe[lastYear];
                if (roe < -100 || roe > 200) {
                    validations.warnings.push(`游리 Advertencia: ROE del A침o ${lastYear + 1} (${roe.toFixed(1)}%) es extremadamente alto/bajo. Revise supuestos. (Rango t칤pico: -100% a +200%).`);
                } else {
                    validations.passed.push(`九 Outputs: ROE del A침o ${lastYear + 1} es realista (${roe.toFixed(1)}%).`);
                }
            }

            // CxC/Ingresos: 0.1x a 5x
            if (year5PL.totalRevenue !== 0) {
                const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
                if (cxcToRevenueRatio < 0.1 || cxcToRevenueRatio > 5) {
                    validations.warnings.push(`游리 Advertencia: Ratio CxC/Ingresos del A침o ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) es inusual. Revise supuestos. (Rango t칤pico: 0.1x a 5x para financiamiento).`);
                } else {
                    validations.passed.push(`九 Outputs: Ratio CxC/Ingresos del A침o ${lastYear + 1} es realista (${cxcToRevenueRatio.toFixed(1)}x).`);
                }
            }

            // Debt/Equity: 0x a 20x
            if (year5BS.equity !== 0) {
                const debtToEquityRatio = year5BS.debt / year5BS.equity;
                if (debtToEquityRatio < 0 || debtToEquityRatio > 20) {
                    validations.warnings.push(`游리 Advertencia: Ratio Deuda/Patrimonio del A침o ${lastYear + 1} (${debtToEquityRatio.toFixed(1)}x) es inusual. Revise supuestos. (Rango t칤pico: 0x a 20x).`);
                } else {
                    validations.passed.push(`九 Outputs: Ratio Deuda/Patrimonio del A침o ${lastYear + 1} es realista (${debtToEquityRatio.toFixed(1)}x).`);
                }
            }
        }

        // Nivel 3: Consistencia entre Estados Financieros
        function validateConsistency(financialResults, validations) {
            const tolerance = 1000; // Tolerance for monetary differences ($1,000 MXN)

            for (let i = 0; i < financialResults.pl.length; i++) {
                const pl = financialResults.pl[i];
                const cf = financialResults.cf[i];
                const bs = financialResults.bs[i];
                const prevBs = (i === 0) ? { cash: modelData.seriesA + (modelData.seriesA * (modelData.ventureDebtPct / 100)), equity: modelData.seriesA } : financialResults.bs[i-1];

                // Check Balance Sheet equation A = P + E
                const balanceDiff = Math.abs(bs.totalAssets - bs.totalLiabilitiesEquity);
                if (balanceDiff > tolerance) {
                    validations.errors.push(`游댮 Error de Consistencia: Balance General del A침o ${i + 1} no cuadra. Diferencia: ${formatCurrency(balanceDiff)}. Activos (${formatCurrency(bs.totalAssets)}) vs. Pasivos+Patrimonio (${formatCurrency(bs.totalLiabilitiesEquity)}).`);
                } else {
                    validations.passed.push(`九 Consistencia: Balance General del A침o ${i + 1} cuadra.`);
                }

                // Flujo neto = Cambio en efectivo
                const cashChangeCF = cf.netCash;
                const cashChangeBS = bs.cash - prevBs.cash;
                if (Math.abs(cashChangeCF - cashChangeBS) > tolerance) {
                    validations.errors.push(`游댮 Error de Consistencia: Flujo Neto del A침o ${i + 1} (${formatCurrency(cashChangeCF)}) difiere del cambio en Efectivo del Balance (${formatCurrency(cashChangeBS)}).`);
                } else {
                    validations.passed.push(`九 Consistencia: Flujo Neto y cambio en Efectivo del A침o ${i + 1} concuerdan.`);
                }

                // Depreciaci칩n P&L = Depreciaci칩n CF (como ajuste no monetario)
                if (Math.abs(pl.depreciation - cf.depreciation) > tolerance) {
                    validations.warnings.push(`游리 Advertencia de Consistencia: Depreciaci칩n en P&L (${formatCurrency(pl.depreciation)}) no coincide con el ajuste en Flujo de Efectivo (${formatCurrency(cf.depreciation)}) para el A침o ${i + 1}.`);
                }

                // Utilidad neta = Delta utilidades retenidas (considerando nuevo capital y dividendos si los hubiera)
                // Assuming `equity` in BS is `initialEquity + accumulatedEarnings + newEquityRaisedThisPeriod`
                // `accumulatedEarnings` is tracked. The check should be:
                // `bs.equity - prevBs.equity` (change in total equity)
                // should equal `pl.netIncome + newEquityRaisedThisPeriod` (net income + new capital, assuming no dividends)
                const deltaEquity = bs.equity - prevBs.equity;
                const netIncomePlusNewEquity = pl.netIncome + (financialResults.cf[i].additionalFundingRaised || 0) + (i + 1 === modelData.seriesB_year ? modelData.seriesB_funding : 0) + (i + 1 === modelData.seriesC_year ? modelData.seriesC_funding : 0);
                if (Math.abs(deltaEquity - netIncomePlusNewEquity) > tolerance) {
                    validations.warnings.push(`游리 Advertencia de Consistencia: Cambio en Patrimonio del A침o ${i + 1} (${formatCurrency(deltaEquity)}) no coincide con Utilidad Neta + Nuevos Aportes de Capital (${formatCurrency(netIncomePlusNewEquity)}).`);
                } else {
                    validations.passed.push(`九 Consistencia: Utilidad Neta y cambios en Patrimonio del A침o ${i + 1} concuerdan.`);
                }
            }
        }

        // Nivel 4: Evoluci칩n Temporal
        function validateTemporal(financialResults, validations) {
            for (let i = 1; i < financialResults.pl.length; i++) { // Start from Year 2 to compare with Year 1
                const prevPl = financialResults.pl[i-1];
                const currentPl = financialResults.pl[i];
                const prevBs = financialResults.bs[i-1];
                const currentBs = financialResults.bs[i];

                // Crecimiento ingresos <1000% anual
                if (prevPl.totalRevenue !== 0) {
                    const revenueGrowth = (currentPl.totalRevenue / prevPl.totalRevenue - 1) * 100;
                    if (revenueGrowth > 1000) { // If revenue grows more than 1000% (10x) in a year
                        validations.warnings.push(`游리 Advertencia Temporal: Crecimiento de Ingresos del A침o ${i + 1} (${revenueGrowth.toFixed(1)}%) es extremadamente alto. Revise las unidades o supuestos de precio.`);
                    }
                }

                // Ratios no cambian >500% entre a침os (ej. Margen EBITDA)
                if (prevPl.totalRevenue !== 0 && currentPl.totalRevenue !== 0) {
                    const prevEbitdaMargin = (prevPl.ebitda / prevPl.totalRevenue) * 100;
                    const currentEbitdaMargin = (currentPl.ebitda / currentPl.totalRevenue) * 100;
                    if (Math.abs(currentEbitdaMargin - prevEbitdaMargin) > 500) { // If margin changes by more than 500 percentage points
                        validations.warnings.push(`游리 Advertencia Temporal: Margen EBITDA cambia dr치sticamente (${prevEbitdaMargin.toFixed(1)}% a ${currentEbitdaMargin.toFixed(1)}%) del A침o ${i} al A침o ${i + 1}. Revise las din치micas de costos/ingresos.`);
                    }
                }
            }
            validations.passed.push("九 Evoluci칩n Temporal: Tendencias de crecimiento y ratios anuales parecen razonables.");
        }

        // Nivel 5: Benchmarks de Industria
        function validateIndustryBenchmarks(financialResults, validations) {
            const lastYear = financialResults.pl.length - 1;
            if (lastYear < 4) return; // Need at least 5 years of data for year 5 benchmarks

            const year5PL = financialResults.pl[lastYear];
            const year5BS = financialResults.bs[lastYear];
            const year5ROE = financialResults.roe[lastYear];
            const year5ROIC = financialResults.roic[lastYear];

            // Margen EBITDA fintech: 10-40%
            if (year5PL.totalRevenue !== 0) {
                const ebitdaMargin = (year5PL.ebitda / year5PL.totalRevenue) * 100;
                if (ebitdaMargin < 10 || ebitdaMargin > 40) {
                    validations.info.push(`游댯 Info: Margen EBITDA del A침o ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) est치 fuera del benchmark t칤pico de fintech (10-40%).`);
                } else {
                    validations.passed.push(`九 Benchmarks: Margen EBITDA del A침o ${lastYear + 1} (${ebitdaMargin.toFixed(1)}%) est치 en l칤nea con el benchmark.`);
                }
            }

            // ROE servicios financieros: 15-35%
            if (year5BS.equity !== 0) {
                if (year5ROE < 15 || year5ROE > 35) {
                    validations.info.push(`游댯 Info: ROE del A침o ${lastYear + 1} (${year5ROE.toFixed(1)}%) est치 fuera del benchmark t칤pico de servicios financieros (15-35%).`);
                } else {
                    validations.passed.push(`九 Benchmarks: ROE del A침o ${lastYear + 1} (${year5ROE.toFixed(1)}%) est치 en l칤nea con el benchmark.`);
                }
            }

            // CxC/Ingresos financiamiento: 0.5-3x
            if (year5PL.totalRevenue !== 0) {
                const cxcToRevenueRatio = year5BS.receivables / year5PL.totalRevenue;
                if (cxcToRevenueRatio < 0.5 || cxcToRevenueRatio > 3) {
                    validations.info.push(`游댯 Info: Ratio CxC/Ingresos del A침o ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) est치 fuera del benchmark t칤pico de financiamiento (0.5-3x).`);
                } else {
                    validations.passed.push(`九 Benchmarks: Ratio CxC/Ingresos del A침o ${lastYear + 1} (${cxcToRevenueRatio.toFixed(1)}x) est치 en l칤nea con el benchmark.`);
                }
            }
        }

        // Funci칩n para actualizar el panel de validaci칩n en la UI
        function updateValidationPanel(validations) {
            const container = document.getElementById('validation-results-container');
            if (!container) return;

            container.innerHTML = ''; // Clear previous results

            const allMessages = [
                ...validations.errors.map(msg => ({ type: 'error', message: msg, icon: '仇' })),
                ...validations.warnings.map(msg => ({ type: 'warning', message: msg, icon: '游리' })),
                ...validations.info.map(msg => ({ type: 'info', message: msg, icon: '游댯' })),
                ...validations.passed.map(msg => ({ type: 'passed', message: msg, icon: '九' }))
            ];

            if (allMessages.length === 0) {
                container.innerHTML = '<div class="validation-summary passed">九 Todas las validaciones completadas.</div>';
                return;
            }

            allMessages.forEach(item => {
                const div = document.createElement('div');
                div.className = `validation-item ${item.type}`;
                div.innerHTML = `<span class="validation-icon">${item.icon}</span><div class="validation-message">${item.message}</div>`;
                container.appendChild(div);
            });

            // Add a summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'validation-summary mt-4 p-2 rounded-lg';
            if (validations.errors.length > 0) {
                summaryDiv.classList.add('bg-red-200', 'text-red-800');
                summaryDiv.textContent = `游뚿 ${validations.errors.length} ERRORES CR칈TICOS encontrados. Por favor, revise y ajuste los inputs/l칩gica.`;
            } else if (validations.warnings.length > 0) {
                summaryDiv.classList.add('bg-yellow-200', 'text-yellow-800');
                summaryDiv.textContent = `丘멆잺 ${validations.warnings.length} ADVERTENCIAS encontradas. Revise los resultados con precauci칩n.`;
            } else {
                summaryDiv.classList.add('bg-green-200', 'text-green-800');
                summaryDiv.textContent = `九 Todas las validaciones cr칤ticas superadas. ${validations.info.length} notas informativas.`;
            }
            container.appendChild(summaryDiv);
        }


        // ===== CONFIGURACI칍N DE CONTROLES DE USUARIO =====
        // Genera y vincula los inputs de tipo "range" (sliders)
        function setupSliderControls() {
            const container = document.getElementById('credit-risk-controls');
            const operationsContainer = document.getElementById('operations-debt-controls');

            sliderConfigs.forEach(config => {
                const parentDiv = document.createElement('div');
                parentDiv.innerHTML = `
                    <label class="flex justify-between text-sm font-medium text-gray-700">
                        ${config.label} 
                        <span id="${config.id}-valor" class="font-bold text-indigo-600">${config.format(modelData[config.id])}</span>
                    </label>
                    <input type="range" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}" class="input-slider mt-1">
                `;
                
                if (['tasaInteres', 'tasaMorosidad'].includes(config.id)) {
                    container.appendChild(parentDiv);
                } else {
                    operationsContainer.appendChild(parentDiv);
                }

                const slider = parentDiv.querySelector(`#${config.id}-input`);
                const display = parentDiv.querySelector(`#${config.id}-valor`);
                
                slider.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    modelData[config.id] = value;
                    display.textContent = config.format(value);
                    log(`${config.label} cambiado a: ${value}`);
                    // Recalcular y actualizar UI en cada cambio de slider
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });

            // Checkbox para Protecci칩n Rodando
            const checkbox = document.getElementById('check-proteccion');
            if (checkbox) {
                checkbox.checked = modelData.proteccionRodando; // Establecer estado inicial
                checkbox.addEventListener('change', function() {
                    modelData.proteccionRodando = this.checked;
                    log(`Protecci칩n Rodando: ${this.checked ? 'ACTIVADA' : 'DESACTIVADA'}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            }
            log(' 九 Controles deslizables (sliders) configurados.');
        }

        // Genera y vincula los inputs num칠ricos (constantes del modelo y unidades por a침o)
        function setupNumberControls() {
            const unitsContainer = document.getElementById('units-container');
            const constantsContainer = document.getElementById('constants-container');

            // Inputs para Unidades por A침o
            modelData.unitsPerYear.forEach((units, index) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label for="unit-year-${index+1}" class="text-sm font-medium text-gray-700 mb-1">Unidades A침o ${index+1}</label>
                    <input type="number" id="unit-year-${index+1}" min="0" max="1000" value="${units}" 
                           class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                `;
                unitsContainer.appendChild(div);
                
                const input = document.getElementById(`unit-year-${index+1}`);
                input.addEventListener('change', function() {
                    const value = parseInt(this.value) || 0;
                    // Asegurar que el valor est칠 dentro de los l칤mites
                    modelData.unitsPerYear[index] = Math.max(0, Math.min(1000, value)); 
                    this.value = modelData.unitsPerYear[index]; // Actualizar input si se ajust칩
                    
                    log(`Unidades A침o ${index+1} cambiado a: ${modelData.unitsPerYear[index]}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });

            // Inputs para Constantes del Modelo
            constantConfigs.forEach(config => {
                const div = document.createElement('div');
                div.className = 'flex flex-col';
                div.innerHTML = `
                    <label for="${config.id}-input" class="text-sm font-medium text-gray-700 mb-1">${config.label}</label>
                    <input type="${config.type}" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}"
                           class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <span class="text-xs text-gray-500 mt-1" id="${config.id}-display">${config.format(modelData[config.id])}</span>
                `;
                constantsContainer.appendChild(div);

                const input = div.querySelector(`#${config.id}-input`);
                const display = div.querySelector(`#${config.id}-display`);

                input.addEventListener('input', function() {
                    let value = parseFloat(this.value);
                    if (isNaN(value)) value = 0; // Default to 0 if input is not a number

                    // Ensure value is within min/max, especially for percentages
                    if (config.type === 'number') {
                         if (value < config.min) value = config.min;
                         if (value > config.max) value = config.max;
                         this.value = value; // Update the input field
                    }

                    modelData[config.id] = value;
                    display.textContent = config.format(value);
                    log(`${config.label} cambiado a: ${value}`);
                    if (calculateFinancials()) {
                        updateUI();
                    }
                });
            });
            log(' 九 Controles num칠ricos (constantes y unidades) configurados.');
        }


        // Configura la navegaci칩n entre pesta침as
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            tabButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // Remover la clase 'active' de todos los botones y secciones
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    button.classList.add('active');
                    contentSections[index].classList.add('active');
                    
                    // Forzar actualizaci칩n de tablas y gr치ficos al cambiar de pesta침a
                    // Esto es 칰til si los datos se cargan lentamente o si se requiere un re-render
                    if (button.id === 'tab-financieros' || button.id === 'tab-niif' || button.id === 'tab-graficos') {
                        setTimeout(() => {
                            if (calculateFinancials()) { // Recalcular antes de actualizar UI
                                updateUI();
                            }
                        }, 50); // Peque침o retraso para asegurar que la pesta침a est칠 visible
                    }
                });
            });
            log(' 九 Navegaci칩n por pesta침as configurada.');
        }

        // ===== INICIALIZACI칍N DE LA APLICACI칍N =====
        // Se ejecuta cuando el DOM est치 completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            log(' 游 INICIANDO APLICACI칍N DEL MODELO FINANCIERO');
            
            try {
                // Configurar todos los elementos interactivos y la UI
                setupTabs();
                setupSliderControls(); // Configurar sliders
                setupNumberControls(); // Configurar inputs num칠ricos (constantes y unidades)
                
                // Realizar el c치lculo inicial del modelo y actualizar la UI
                if (calculateFinancials()) {
                    updateUI();
                    log(' 九 Inicializaci칩n exitosa: C치lculos y UI actualizados.');
                } else {
                    log(' 仇 Error durante la inicializaci칩n: Fallo en los c치lculos iniciales.');
                }
                
                // Inicializar y actualizar gr치ficos despu칠s de un breve retraso
                // Esto asegura que el canvas est칠 listo en el DOM
                setTimeout(() => {
                    initializeCharts();
                    updateCharts();
                }, 500); // Retraso de 500ms
                
                log(' 游꿀 APLICACI칍N LISTA Y FUNCIONANDO');
                
            } catch (error) {
                log(` 仇 ERROR CR칈TICO DURANTE LA INICIALIZACI칍N: ${error.message}`);
                console.error('Error cr칤tico en inicializaci칩n:', error);
            }
        });
    </script>
</body>
</html>
