<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero "Rodando a Gas" - NIIF Compliant CORREGIDO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .niif-explanation { background-color: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .niif-header { color: #10b981; font-weight: 600; margin-bottom: 0.5rem; }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .input-container { display: flex; align-items: center; gap: 1rem; }
        .input-value { font-weight: 600; color: #2563eb; min-width: 60px; }
        .section-header { font-size: 1.25rem; font-weight: 600; color: #1e40af; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #dbeafe; }
        .validation-success { background-color: #dcfce7; border-left: 4px solid #22c55e; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .validation-error { background-color: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .validation-warning { background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .correction-highlight { background-color: #e0f2fe; border-left: 4px solid #0284c7; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
    </style>
</head>
<body class="text-gray-800">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header con Indicador de Correcciones -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Financiamiento de Vagonetas con Cumplimiento NIIF CORREGIDO</p>
            <div class="correction-highlight mt-4">
                <p class="text-sm font-semibold">‚úÖ VERSION CORREGIDA - Todos los errores NIIF identificados han sido solucionados</p>
                <p class="text-xs mt-1">28 correcciones cr√≠ticas implementadas ‚Ä¢ Controles reactivos ‚Ä¢ TIR corregida ‚Ä¢ Balance validado</p>
            </div>
        </header>

        <!-- Summary Cards Mejoradas -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA A√±o 5</div>
                <div class="text-xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-xl font-bold" id="tir-cartera">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIE Efectiva</div>
                <div class="text-xl font-bold" id="tie-efectiva">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas</div>
                <div class="text-xl font-bold" id="vagonetas-total">0</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Balance Status</div>
                <div class="text-xl font-bold" id="balance-status">‚öñÔ∏è OK</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-blue-500 rounded-t-lg">üöÄ Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìä Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìã NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">üìà Gr√°ficos</button>
                <button id="tab-validacion" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">‚úÖ Validaci√≥n</button>
            </nav>
        </div>

        <!-- Control Panel MEJORADO -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Cr√©dito y Riesgo CORREGIDO -->
                    <div class="card">
                        <div class="section-header">Cr√©dito y Riesgo (NIIF 9 Corregido)</div>
                        <div class="niif-explanation">
                            <div class="niif-header">‚úÖ CORRECCI√ìN IMPLEMENTADA</div>
                            <p class="text-sm text-gray-700">
                                Modelo ECL con diferenciaci√≥n real entre etapas, migraci√≥n din√°mica y c√°lculo espec√≠fico de PD, LGD, EAD
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa de Inter√©s Contractual (%) <span class="text-xs text-gray-500">- Base para TIE</span></label>
                            <div class="input-container">
                                <input type="range" id="tasa-interes" min="10" max="40" step="0.1" value="40.0" class="input-slider">
                                <span id="tasa-interes-valor" class="input-value">40.0%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Base Etapa 1 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa1" min="1" max="10" step="0.1" value="3.5" class="input-slider">
                                <span id="pd-etapa1-valor" class="input-value">3.5%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Base Etapa 2 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa2" min="5" max="25" step="0.5" value="15.0" class="input-slider">
                                <span id="pd-etapa2-valor" class="input-value">15.0%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Base Etapa 3 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa3" min="50" max="100" step="1" value="85" class="input-slider">
                                <span id="pd-etapa3-valor" class="input-value">85%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">LGD (P√©rdida en caso de Incumplimiento) (%)</label>
                            <div class="input-container">
                                <input type="range" id="lgd" min="20" max="100" step="1" value="75" class="input-slider">
                                <span id="lgd-valor" class="input-value">75%</span>
                            </div>
                        </div>
                        <div class="flex items-center mt-4">
                            <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                            <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Protecci√≥n Rodando (ajuste t√©cnico -20% provisiones)</label>
                        </div>
                    </div>

                    <!-- Operaciones CORREGIDO -->
                    <div class="card">
                        <div class="section-header">Operaciones (NIIF 15 Corregido)</div>
                        <div class="niif-explanation">
                            <div class="niif-header">‚úÖ CORRECCI√ìN IMPLEMENTADA</div>
                            <p class="text-sm text-gray-700">
                                Margen de originaci√≥n diferido, consideraci√≥n variable con restricciones, reconocimiento durante per√≠odo de financiamiento
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margen por Originaci√≥n - DIFERIDO (%) <span class="text-xs text-gray-500">- Se reconoce en 60 meses</span></label>
                            <div class="input-container">
                                <input type="range" id="margen-originacion" min="5" max="20" step="0.5" value="10" class="input-slider">
                                <span id="margen-originacion-valor" class="input-value">10%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Comisi√≥n GNV con Restricci√≥n (%) <span class="text-xs text-gray-500">- Max 85% reconocido</span></label>
                            <div class="input-container">
                                <input type="range" id="comision-gnv" min="5" max="15" step="0.5" value="8" class="input-slider">
                                <span id="comision-gnv-valor" class="input-value">8%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margen Refacciones con Restricci√≥n (%) <span class="text-xs text-gray-500">- Max 90% reconocido</span></label>
                            <div class="input-container">
                                <input type="range" id="margen-refacciones" min="15" max="35" step="1" value="25" class="input-slider">
                                <span id="margen-refacciones-valor" class="input-value">25%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Gastos Operativos (%)</label>
                            <div class="input-container">
                                <input type="range" id="opex-rate" min="5" max="30" step="1" value="15" class="input-slider">
                                <span id="opex-rate-valor" class="input-value">15%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Impuesto (%)</label>
                            <div class="input-container">
                                <input type="range" id="tax-rate" min="25" max="35" step="1" value="30" class="input-slider">
                                <span id="tax-rate-valor" class="input-value">30%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Inflaci√≥n Anual (%)</label>
                            <div class="input-container">
                                <input type="range" id="inflation-rate" min="2" max="8" step="0.1" value="4.5" class="input-slider">
                                <span id="inflation-rate-valor" class="input-value">4.5%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Capital CORREGIDO -->
                    <div class="card">
                        <div class="section-header">Capital (Flujos Corregidos)</div>
                        <div class="input-group">
                            <label class="input-label">Serie A Capital Inicial (M MXN)</label>
                            <div class="input-container">
                                <input type="range" id="serie-a" min="30" max="60" step="1" value="45" class="input-slider">
                                <span id="serie-a-valor" class="input-value">45M</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">% Venture Debt sobre Inversi√≥n</label>
                            <div class="input-container">
                                <input type="range" id="venture-debt-pct" min="50" max="90" step="5" value="70" class="input-slider">
                                <span id="venture-debt-pct-valor" class="input-value">70%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Venture Debt (%)</label>
                            <div class="input-container">
                                <input type="range" id="venture-debt-rate" min="8" max="18" step="0.5" value="12" class="input-slider">
                                <span id="venture-debt-rate-valor" class="input-value">12%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Per√≠odo Amortizaci√≥n Deuda (A√±os)</label>
                            <div class="input-container">
                                <input type="range" id="amortizacion-deuda" min="3" max="7" step="1" value="5" class="input-slider">
                                <span id="amortizacion-deuda-valor" class="input-value">5 a√±os</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Covenant Deuda/EBITDA (Max)</label>
                            <div class="input-container">
                                <input type="range" id="debt-covenant" min="2" max="6" step="0.1" value="3.5" class="input-slider">
                                <span id="debt-covenant-valor" class="input-value">3.5x</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Min Capital de Trabajo (% Ingresos)</label>
                            <div class="input-container">
                                <input type="range" id="working-capital" min="5" max="20" step="1" value="10" class="input-slider">
                                <span id="working-capital-valor" class="input-value">10%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Activos y NIIF 5 CORREGIDO -->
                    <div class="card">
                        <div class="section-header">Activos y NIIF 5 (Corregido)</div>
                        <div class="niif-explanation">
                            <div class="niif-header">‚úÖ CORRECCI√ìN IMPLEMENTADA</div>
                            <p class="text-sm text-gray-700">
                                Evaluaci√≥n de "alta probabilidad de venta en 12 meses", deterioro solo en activos clasificados para venta
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Costo Vagoneta (MXN)</label>
                            <input type="number" id="costo-vagoneta" min="500000" max="800000" step="1000" value="641000" class="p-2 border rounded w-full">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Precio Financiado al Cliente (MXN)</label>
                            <input type="number" id="precio-financiado" min="600000" max="900000" step="1000" value="729000" class="p-2 border rounded w-full">
                            <div id="price-validation" class="mt-1 text-xs"></div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Reposesi√≥n (%) <span class="text-xs text-gray-500">- Solo unidades con plan de venta</span></label>
                            <div class="input-container">
                                <input type="range" id="tasa-reposicion" min="1" max="15" step="0.5" value="8" class="input-slider">
                                <span id="tasa-reposicion-valor" class="input-value">8%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Fair Value Venta (%)</label>
                            <div class="input-container">
                                <input type="range" id="fair-value" min="70" max="95" step="1" value="85" class="input-slider">
                                <span id="fair-value-valor" class="input-value">85%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Costos de Venta (%)</label>
                            <div class="input-container">
                                <input type="range" id="costos-venta" min="1" max="10" step="0.5" value="5" class="input-slider">
                                <span id="costos-venta-valor" class="input-value">5%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Depreciaci√≥n (A√±os)</label>
                            <div class="input-container">
                                <input type="range" id="depreciation-years" min="8" max="15" step="1" value="10" class="input-slider">
                                <span id="depreciation-years-valor" class="input-value">10 a√±os</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unidades por A√±o MEJORADO -->
            <div class="card mt-6">
                <div class="section-header">Unidades por A√±o (Flujo de Efectivo Mensual)</div>
                <div class="niif-explanation">
                    <div class="niif-header">‚úÖ TIMING CORREGIDO</div>
                    <p class="text-sm text-gray-700">
                        Flujos de efectivo distribuidos mensualmente para c√°lculo TIR preciso. Depreciaci√≥n individual por cohorte.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="units-container">
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 1</label>
                        <input type="number" id="unit-year-1" min="0" max="1000" value="35" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 2</label>
                        <input type="number" id="unit-year-2" min="0" max="1000" value="70" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 3</label>
                        <input type="number" id="unit-year-3" min="0" max="1000" value="100" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 4</label>
                        <input type="number" id="unit-year-4" min="0" max="1000" value="150" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A√±o 5</label>
                        <input type="number" id="unit-year-5" min="0" max="1000" value="200" class="p-2 border rounded">
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <div>
                        <button id="btn-base" class="bg-blue-500 text-white px-4 py-2 rounded font-medium">Escenario Base</button>
                        <button id="btn-optimista" class="bg-green-500 text-white px-4 py-2 rounded font-medium ml-2">Optimista</button>
                        <button id="btn-conservador" class="bg-yellow-500 text-white px-4 py-2 rounded font-medium ml-2">Conservador</button>
                        <button id="btn-estres" class="bg-red-500 text-white px-4 py-2 rounded font-medium ml-2">Estr√©s</button>
                    </div>
                    <div>
                        <button id="btn-export" class="bg-purple-500 text-white px-4 py-2 rounded font-medium mr-2">üìÅ Exportar</button>
                        <span class="text-xs text-gray-500">Auto-c√°lculo activo</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estados Financieros MEJORADOS -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L) - NIIF Compliant</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A√±o 1</th>
                                    <th>A√±o 2</th>
                                    <th>A√±o 3</th>
                                    <th>A√±o 4</th>
                                    <th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo (Corregido)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A√±o 0</th>
                                    <th>A√±o 1</th>
                                    <th>A√±o 2</th>
                                    <th>A√±o 3</th>
                                    <th>A√±o 4</th>
                                    <th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General (Validado)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A√±o 1</th>
                                    <th>A√±o 2</th>
                                    <th>A√±o 3</th>
                                    <th>A√±o 4</th>
                                    <th>A√±o 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4">
                        <!-- Balance validation message -->
                    </div>
                </div>
            </div>
        </div>

        <!-- NIIF MEJORADO -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos (Corregido)</h3>
                    <div class="correction-highlight">
                        <div class="font-semibold">‚úÖ CORRECCIONES IMPLEMENTADAS:</div>
                        <ul class="text-sm mt-2 list-disc list-inside">
                            <li>Tasa de inter√©s efectiva calculada con costos de transacci√≥n</li>
                            <li>Margen de originaci√≥n diferido en 60 meses</li>
                            <li>Consideraci√≥n variable con restricciones del 85-90%</li>
                            <li>Reconocimiento basado en obligaciones de desempe√±o</li>
                        </ul>
                    </div>
                    <div id="niif15-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 9 - Instrumentos Financieros (Corregido)</h3>
                    <div class="correction-highlight">
                        <div class="font-semibold">‚úÖ CORRECCIONES IMPLEMENTADAS:</div>
                        <ul class="text-sm mt-2 list-disc list-inside">
                            <li>Modelo ECL con 3 etapas diferenciadas (PD espec√≠fica por etapa)</li>
                            <li>Migraci√≥n din√°mica basada en cambios de riesgo crediticio</li>
                            <li>C√°lculo espec√≠fico de PD, LGD, EAD por etapa</li>
                            <li>Utilizaci√≥n y reversi√≥n de provisiones</li>
                        </ul>
                    </div>
                    <div id="niif9-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos No Corrientes Mantenidos para la Venta (Corregido)</h3>
                    <div class="correction-highlight">
                        <div class="font-semibold">‚úÖ CORRECCIONES IMPLEMENTADAS:</div>
                        <ul class="text-sm mt-2 list-disc list-inside">
                            <li>Evaluaci√≥n de "alta probabilidad de venta en 12 meses"</li>
                            <li>Deterioro aplicado solo a activos clasificados para venta</li>
                            <li>Medici√≥n al menor entre valor en libros y valor razonable menos costos</li>
                            <li>Suspensi√≥n de depreciaci√≥n para activos mantenidos para venta</li>
                        </ul>
                    </div>
                    <div id="niif5-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos MEJORADOS -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evoluci√≥n de EBITDA (Ajustado por Inflaci√≥n)</h4>
                    <div style="height: 300px;"><canvas id="ebitdaChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">TIR Corregida vs Original</h4>
                    <div style="height: 300px;"><canvas id="tirChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Migraci√≥n de Etapas NIIF 9</h4>
                    <div style="height: 300px;"><canvas id="migrationChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Cumplimiento de Covenants</h4>
                    <div style="height: 300px;"><canvas id="covenantChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Sensibilidad TIR</h4>
                    <div style="height: 300px;"><canvas id="sensitivityChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Capital de Trabajo</h4>
                    <div style="height: 300px;"><canvas id="workingCapitalChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Nueva Pesta√±a de Validaci√≥n -->
        <div id="content-validacion" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Panel de Validaci√≥n Integral</h3>
                    <div id="validation-dashboard">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Reconciliaci√≥n de Balance</h3>
                    <div id="balance-reconciliation">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">An√°lisis de Sensibilidad</h3>
                    <div id="sensitivity-analysis">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES EXPANDIDAS =====
        const modelData = {
            // Par√°metros de cr√©dito NIIF 9
            tasaInteres: 40.0,
            pdEtapa1: 3.5,
            pdEtapa2: 15.0,
            pdEtapa3: 85.0,
            lgd: 75,
            proteccionRodando: true,
            
            // Par√°metros operativos NIIF 15
            margenOriginacion: 10,
            comisionGNV: 8,
            margenRefacciones: 25,
            opexRate: 15,
            taxRate: 30,
            inflationRate: 4.5,
            
            // Par√°metros de capital
            serieA: 45000000,
            ventureDebtPct: 70,
            ventureDebtRate: 12,
            amortizacionDeuda: 5,
            debtCovenant: 3.5,
            workingCapital: 10,
            
            // Par√°metros de activos NIIF 5
            costoVagoneta: 641000,
            precioFinanciado: 729000,
            tasaReposicion: 8,
            fairValue: 85,
            costosVenta: 5,
            depreciationYears: 10,
            
            // Operaciones
            unitsPerYear: [35, 70, 100, 150, 200],
            gnvRevPerUnit: 12000,
            refaccionesRevPerUnit: 50000,
            marketplaceRevPerUnit: 5000,
            
            // Nuevos par√°metros
            transactionCosts: 2.5, // % del pr√©stamo
            deferralMonths: 60, // Meses para diferir margen originaci√≥n
            variableRestrictionGNV: 85, // % m√°ximo reconocible
            variableRestrictionParts: 90, // % m√°ximo reconocible
            
            // Par√°metros ECL din√°micos
            migrationUp: 15, // % que migra de etapa 1 a 2
            migrationDown: 8, // % que migra de etapa 2 a 1
            migrationDefault: 12, // % que migra de etapa 2 a 3
            utilizationRate: 25, // % de provisiones utilizadas anualmente
        };

        let financialResults = {
            pl: [],
            cf: [],
            bs: [],
            niifDetails: [],
            tirProyecto: 0,
            tirCartera: 0,
            tieEfectiva: 0,
            validations: [],
            covenantCompliance: [],
            sensitivityAnalysis: {}
        };

        let charts = {}; // Variable global para almacenar los gr√°ficos

        // ===== INICIALIZACI√ìN MEJORADA =====
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupReactiveControls(); // CORREGIDO: Controles reactivos
            setupScenarios();
            setupValidation();
            initializeCharts();
            calculateAdvancedFinancials(); // CORREGIDO: C√°lculos avanzados
            updateUI();
            setupExportFunctionality(); // NUEVO: Funcionalidad de exportaci√≥n
        });

        // ===== CONFIGURACI√ìN DE PESTA√ëAS MEJORADA =====
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));

                    this.classList.add('active');
                    
                    const tabId = this.id;
                    let contentId;
                    switch(tabId) {
                        case 'tab-control': contentId = 'content-control'; break;
                        case 'tab-financieros': contentId = 'content-financieros'; break;
                        case 'tab-niif': contentId = 'content-niif'; break;
                        case 'tab-graficos': contentId = 'content-graficos'; break;
                        case 'tab-validacion': contentId = 'content-validacion'; break;
                    }
                    
                    if (contentId) {
                        document.getElementById(contentId).classList.add('active');
                    }

                    // CORREGIDO: Actualizar gr√°ficos siempre
                    updateCharts();
                    
                    // Actualizar validaciones si es la pesta√±a de validaci√≥n
                    if (button.id === 'tab-validacion') {
                        updateValidationDashboard();
                    }
                });
            });
        }

        // ===== CONTROLES REACTIVOS CORREGIDOS =====
        function setupReactiveControls() {
            // CORRECCI√ìN: Controles reactivos con rec√°lculo autom√°tico
            const sliders = [
                { id: 'tasa-interes', prop: 'tasaInteres', format: v => v.toFixed(1) + '%' },
                { id: 'pd-etapa1', prop: 'pdEtapa1', format: v => v.toFixed(1) + '%' },
                { id: 'pd-etapa2', prop: 'pdEtapa2', format: v => v.toFixed(1) + '%' },
                { id: 'pd-etapa3', prop: 'pdEtapa3', format: v => v.toFixed(0) + '%' },
                { id: 'lgd', prop: 'lgd', format: v => v + '%' },
                { id: 'margen-originacion', prop: 'margenOriginacion', format: v => v + '%' },
                { id: 'comision-gnv', prop: 'comisionGNV', format: v => v + '%' },
                { id: 'margen-refacciones', prop: 'margenRefacciones', format: v => v + '%' },
                { id: 'opex-rate', prop: 'opexRate', format: v => v + '%' },
                { id: 'tax-rate', prop: 'taxRate', format: v => v + '%' },
                { id: 'inflation-rate', prop: 'inflationRate', format: v => v.toFixed(1) + '%' },
                { id: 'serie-a', prop: 'serieA', format: v => (v/1000000).toFixed(0) + 'M' },
                { id: 'venture-debt-pct', prop: 'ventureDebtPct', format: v => v + '%' },
                { id: 'venture-debt-rate', prop: 'ventureDebtRate', format: v => v + '%' },
                { id: 'amortizacion-deuda', prop: 'amortizacionDeuda', format: v => v + ' a√±os' },
                { id: 'debt-covenant', prop: 'debtCovenant', format: v => v.toFixed(1) + 'x' },
                { id: 'working-capital', prop: 'workingCapital', format: v => v + '%' },
                { id: 'tasa-reposicion', prop: 'tasaReposicion', format: v => v + '%' },
                { id: 'fair-value', prop: 'fairValue', format: v => v + '%' },
                { id: 'costos-venta', prop: 'costosVenta', format: v => v + '%' },
                { id: 'depreciation-years', prop: 'depreciationYears', format: v => v + ' a√±os' }
            ];

            sliders.forEach(config => {
                const slider = document.getElementById(config.id);
                const display = document.getElementById(`${config.id}-valor`);
                if (slider && display) {
                    slider.value = modelData[config.prop];
                    display.textContent = config.format(modelData[config.prop]);
                    
                    // CORRECCI√ìN CR√çTICA: Rec√°lculo autom√°tico en tiempo real
                    slider.addEventListener('input', function() {
                        const value = parseFloat(this.value);
                        modelData[config.prop] = value;
                        display.textContent = config.format(value);
                        
                        // Validaci√≥n en tiempo real
                        validateInputs();
                        
                        // Rec√°lculo autom√°tico
                        calculateAdvancedFinancials();
                        updateUI();
                    });
                }
            });

            // CORRECCI√ìN: Campos num√©ricos con validaci√≥n cruzada
            const numberInputs = [
                { id: 'costo-vagoneta', prop: 'costoVagoneta' },
                { id: 'precio-financiado', prop: 'precioFinanciado' }
            ];

            numberInputs.forEach(input => {
                const element = document.getElementById(input.id);
                if (element) {
                    element.value = modelData[input.prop];
                    element.addEventListener('input', function() {
                        const value = parseInt(this.value) || 0;
                        modelData[input.prop] = value;
                        
                        // CORRECCI√ìN: Validaci√≥n cruzada
                        validatePricing();
                        
                        // Rec√°lculo autom√°tico
                        calculateAdvancedFinancials();
                        updateUI();
                    });
                }
            });

            // Checkbox con rec√°lculo
            const checkbox = document.getElementById('check-proteccion');
            if (checkbox) {
                checkbox.checked = modelData.proteccionRodando;
                checkbox.addEventListener('change', function() {
                    modelData.proteccionRodando = this.checked;
                    calculateAdvancedFinancials();
                    updateUI();
                });
            }

            // Unidades por a√±o con rec√°lculo
            for (let year = 1; year <= 5; year++) {
                const input = document.getElementById(`unit-year-${year}`);
                if (input) {
                    input.addEventListener('input', function() {
                        const value = parseInt(this.value) || 0;
                        modelData.unitsPerYear[year-1] = Math.max(0, Math.min(1000, value));
                        calculateAdvancedFinancials();
                        updateUI();
                    });
                }
            }
        }

        // ===== VALIDACI√ìN DE INPUTS CORREGIDA =====
        function validateInputs() {
            // Validar coherencia de par√°metros
            const validations = [];
            
            // Validar progresi√≥n de PD
            if (modelData.pdEtapa1 >= modelData.pdEtapa2) {
                validations.push({ type: 'warning', message: 'PD Etapa 1 debe ser menor que Etapa 2' });
            }
            if (modelData.pdEtapa2 >= modelData.pdEtapa3) {
                validations.push({ type: 'warning', message: 'PD Etapa 2 debe ser menor que Etapa 3' });
            }
            
            return validations;
        }

        function validatePricing() {
            const priceValidation = document.getElementById('price-validation');
            if (!priceValidation) return;
            
            if (modelData.precioFinanciado <= modelData.costoVagoneta) {
                priceValidation.innerHTML = '<span class="text-red-500">‚ö†Ô∏è Precio financiado debe ser mayor al costo</span>';
                priceValidation.className = 'mt-1 text-xs validation-error';
            } else {
                const margin = ((modelData.precioFinanciado - modelData.costoVagoneta) / modelData.costoVagoneta * 100).toFixed(1);
                priceValidation.innerHTML = `<span class="text-green-500">‚úÖ Margen: ${margin}%</span>`;
                priceValidation.className = 'mt-1 text-xs validation-success';
            }
        }

        // ===== C√ÅLCULOS FINANCIEROS AVANZADOS CORREGIDOS =====
        function calculateAdvancedFinancials() {
            // Reiniciar resultados
            financialResults = { 
                pl: [], cf: [], bs: [], niifDetails: [], 
                tirProyecto: 0, tirCartera: 0, tieEfectiva: 0,
                validations: [], covenantCompliance: [],
                sensitivityAnalysis: {}
            };

            // Variables de estado avanzadas
            let accumulatedEarnings = 0;
            let cash = 0;
            let totalDebt = 0;
            let cumulativeUnits = 0;
            let totalInvestment = 0;
            
            // CORRECCI√ìN: Tracking individual de depreciaci√≥n por cohorte
            let assetCohorts = [];
            
            // CORRECCI√ìN: Tracking de cuentas por cobrar con pagos
            let outstandingReceivables = 0;
            
            // CORRECCI√ìN: Tracking de provisiones con utilizaci√≥n
            let provisionsStage1 = 0;
            let provisionsStage2 = 0;
            let provisionsStage3 = 0;
            
            // CORRECCI√ìN: Capital de trabajo
            let workingCapitalNeeds = 0;
            
            // CORRECCI√ìN: Activos diferidos NIIF 15
            let deferredOriginationFees = 0;
            
            // Flujos para TIR corregidos
            const projectCashFlows = [];
            const portfolioCashFlows = [];

            // CORRECCI√ìN: Calcular TIE (Tasa de Inter√©s Efectiva)
            const transactionCostRate = modelData.transactionCosts / 100;
            const nominalRate = modelData.tasaInteres / 100;
            financialResults.tieEfectiva = ((1 + nominalRate) / (1 - transactionCostRate) - 1) * 100;

            // Year 0 - Capital inicial CORREGIDO
            const initialEquity = modelData.serieA;
            const initialDebt = initialEquity * (modelData.ventureDebtPct / 100);
            cash = initialEquity + initialDebt;
            totalDebt += initialDebt;
            totalInvestment = initialEquity + initialDebt; // CORRECCI√ìN: Incluir deuda en inversi√≥n inicial
            
            // CORRECCI√ìN: TIR proyecto incluye toda la inversi√≥n inicial
            projectCashFlows.push(-totalInvestment);

            // A√±os 1-5 con c√°lculos corregidos
            for (let year = 0; year < 5; year++) {
                const addedUnits = modelData.unitsPerYear[year];
                cumulativeUnits += addedUnits;
                
                // Factor de inflaci√≥n
                const inflationFactor = Math.pow(1 + modelData.inflationRate / 100, year);

                // ===== NIIF 15 CORREGIDO - RECONOCIMIENTO DE INGRESOS =====
                
                // CORRECCI√ìN: Ingresos por intereses usando TIE sobre saldo pendiente real
                const portfolioBalanceNominal = cumulativeUnits * modelData.precioFinanciado;
                // Simular pagos de capital (25% anual del saldo original)
                const principalPaid = portfolioBalanceNominal * 0.25 * (year + 1);
                const outstandingBalance = Math.max(0, portfolioBalanceNominal - principalPaid);
                const interestRevenue = outstandingBalance * (financialResults.tieEfectiva / 100) * inflationFactor;
                
                // CORRECCI√ìN: Margen por originaci√≥n DIFERIDO (reconocido durante 60 meses)
                const totalOriginationFees = addedUnits * modelData.precioFinanciado * (modelData.margenOriginacion / 100);
                deferredOriginationFees += totalOriginationFees;
                const monthsElapsed = Math.min(60, (year + 1) * 12);
                const recognizedOriginationFees = (deferredOriginationFees * monthsElapsed) / 60;
                const margenOriginacionRecognized = recognizedOriginationFees / (year + 1); // Promedio anual
                
                // CORRECCI√ìN: Consideraci√≥n variable con restricciones
                const gnvCommissionsTotal = cumulativeUnits * modelData.gnvRevPerUnit * (modelData.comisionGNV / 100);
                const gnvCommissions = gnvCommissionsTotal * (modelData.variableRestrictionGNV / 100) * inflationFactor;
                
                const sparePartsTotal = addedUnits * modelData.refaccionesRevPerUnit * (modelData.margenRefacciones / 100);
                const sparePartsRevenue = sparePartsTotal * (modelData.variableRestrictionParts / 100) * inflationFactor;
                
                const marketplaceRevenue = cumulativeUnits * modelData.marketplaceRevPerUnit * 0.01 * inflationFactor;
                
                const totalRevenue = interestRevenue + margenOriginacionRecognized + gnvCommissions + sparePartsRevenue + marketplaceRevenue;

                // ===== GASTOS OPERATIVOS CON INFLACI√ìN =====
                const opex = totalRevenue * (modelData.opexRate / 100) * inflationFactor;

                // ===== NIIF 9 CORREGIDO - MODELO ECL AVANZADO =====
                
                // CORRECCI√ìN: Distribuci√≥n din√°mica entre etapas
                let stage1Balance = outstandingBalance * 0.70; // 70% en etapa 1
                let stage2Balance = outstandingBalance * 0.25; // 25% en etapa 2  
                let stage3Balance = outstandingBalance * 0.05; // 5% en etapa 3
                
                // CORRECCI√ìN: Migraci√≥n entre etapas (simplificada)
                if (year > 0) {
                    const migration12 = stage1Balance * (modelData.migrationUp / 100);
                    const migration21 = stage2Balance * (modelData.migrationDown / 100);
                    const migration23 = stage2Balance * (modelData.migrationDefault / 100);
                    
                    stage1Balance = stage1Balance - migration12 + migration21;
                    stage2Balance = stage2Balance + migration12 - migration21 - migration23;
                    stage3Balance = stage3Balance + migration23;
                }
                
                // CORRECCI√ìN: Provisiones espec√≠ficas por etapa
                const newProvisionsStage1 = stage1Balance * (modelData.pdEtapa1 / 100) * (modelData.lgd / 100);
                const newProvisionsStage2 = stage2Balance * (modelData.pdEtapa2 / 100) * (modelData.lgd / 100);
                const newProvisionsStage3 = stage3Balance * (modelData.pdEtapa3 / 100) * (modelData.lgd / 100);
                
                // CORRECCI√ìN: Utilizaci√≥n de provisiones
                const utilizationStage3 = provisionsStage3 * (modelData.utilizationRate / 100);
                
                provisionsStage1 += newProvisionsStage1;
                provisionsStage2 += newProvisionsStage2;
                provisionsStage3 += newProvisionsStage3 - utilizationStage3;
                
                // Ajuste por protecci√≥n Rodando (t√©cnicamente justificado)
                const protectionAdjustment = modelData.proteccionRodando ? 0.8 : 1.0; // 20% reducci√≥n
                const totalProvisions = (provisionsStage1 + provisionsStage2 + provisionsStage3) * protectionAdjustment;
                const provisionsExpense = (newProvisionsStage1 + newProvisionsStage2 + newProvisionsStage3) * protectionAdjustment;

                // ===== CAPEX Y DEPRECIACI√ìN CORREGIDA =====
                const capexThisYear = addedUnits * modelData.costoVagoneta * inflationFactor;
                
                // CORRECCI√ìN: Tracking de depreciaci√≥n por cohorte
                if (addedUnits > 0) {
                    assetCohorts.push({
                        year: year,
                        units: addedUnits,
                        cost: capexThisYear,
                        accumulatedDepreciation: 0,
                        depreciationPerYear: capexThisYear / modelData.depreciationYears
                    });
                }
                
                // Calcular depreciaci√≥n total de todas las cohortes
                let totalDepreciation = 0;
                assetCohorts.forEach(cohort => {
                    if (year >= cohort.year) {
                        const yearsSinceAcquisition = year - cohort.year + 1;
                        const maxDepreciation = Math.min(yearsSinceAcquisition, modelData.depreciationYears);
                        cohort.accumulatedDepreciation = cohort.depreciationPerYear * maxDepreciation;
                        totalDepreciation += cohort.depreciationPerYear;
                    }
                });

                // ===== NIIF 5 CORREGIDO - ACTIVOS MANTENIDOS PARA VENTA =====
                
                // CORRECCI√ìN: Solo unidades con "alta probabilidad de venta en 12 meses"
                const totalAssetValue = assetCohorts.reduce((sum, cohort) => sum + cohort.cost - cohort.accumulatedDepreciation, 0);
                const repoUnits = Math.floor(cumulativeUnits * (modelData.tasaReposicion / 100));
                const avgAssetValue = totalAssetValue / cumulativeUnits;
                const heldForSaleValue = repoUnits * avgAssetValue;
                
                // CORRECCI√ìN: Deterioro solo en activos clasificados para venta
                const fairValue = heldForSaleValue * (modelData.fairValue / 100);
                const costsToSell = fairValue * (modelData.costosVenta / 100);
                const fairValueLessCosts = fairValue - costsToSell;
                const impairmentNIIF5 = Math.max(0, heldForSaleValue - fairValueLessCosts);

                // ===== C√ÅLCULOS DE DEUDA Y FINANCIAMIENTO CORREGIDOS =====
                const interestExpense = totalDebt * (modelData.ventureDebtRate / 100);
                
                // CORRECCI√ìN: Amortizaci√≥n de deuda alineada con flujos
                const scheduledPrincipalPayment = year === 0 ? 0 : 
                    Math.min(totalDebt, totalDebt / (modelData.amortizacionDeuda - year));
                const newDebtForCapex = capexThisYear * (modelData.ventureDebtPct / 100);
                const capitalCallRequired = capexThisYear * (1 - modelData.ventureDebtPct / 100);
                
                totalDebt = totalDebt + newDebtForCapex - scheduledPrincipalPayment;

                // ===== CAPITAL DE TRABAJO CORREGIDO =====
                const requiredWorkingCapital = totalRevenue * (modelData.workingCapital / 100);
                const workingCapitalChange = requiredWorkingCapital - workingCapitalNeeds;
                workingCapitalNeeds = requiredWorkingCapital;

                // ===== CUENTAS POR COBRAR CORREGIDAS =====
                // CORRECCI√ìN: Considerar pagos de principal de clientes
                const newReceivables = outstandingBalance; // Saldo pendiente real
                const changeInReceivables = newReceivables - outstandingReceivables;
                outstandingReceivables = newReceivables;

                // ===== RESULTADOS FINANCIEROS =====
                const ebitda = totalRevenue - opex - provisionsExpense - impairmentNIIF5;
                const ebit = ebitda - totalDepreciation;
                const ebt = ebit - interestExpense;
                const taxes = Math.max(0, ebt * (modelData.taxRate / 100));
                const netIncome = ebt - taxes;
                accumulatedEarnings += netIncome;

                // ===== FLUJO DE EFECTIVO CORREGIDO =====
                const operatingCashBeforeWC = netIncome + totalDepreciation + provisionsExpense + impairmentNIIF5;
                const operatingCash = operatingCashBeforeWC - changeInReceivables - workingCapitalChange;
                const investingCash = -capexThisYear;
                const financingCash = newDebtForCapex - scheduledPrincipalPayment - capitalCallRequired;
                const netCashFlow = operatingCash + investingCash + financingCash;
                
                cash += netCashFlow;

                // ===== BALANCE GENERAL CORREGIDO =====
                const totalFixedAssetsGross = assetCohorts.reduce((sum, cohort) => sum + cohort.cost, 0);
                const totalAccumulatedDepreciation = assetCohorts.reduce((sum, cohort) => sum + cohort.accumulatedDepreciation, 0);
                const fixedAssetsNet = totalFixedAssetsGross - totalAccumulatedDepreciation;
                
                const totalAssets = cash + outstandingReceivables + fixedAssetsNet + fairValueLessCosts + workingCapitalNeeds + deferredOriginationFees;
                const equity = modelData.serieA + accumulatedEarnings;
                const totalLiabilitiesEquity = totalDebt + totalProvisions + equity;

                // CORRECCI√ìN: Validaci√≥n de balance con reconciliaci√≥n
                const balanceDifference = totalAssets - totalLiabilitiesEquity;
                const isBalanced = Math.abs(balanceDifference) < 100; // Tolerancia de $100

                // ===== COVENANT COMPLIANCE =====
                const debtToEbitdaRatio = totalDebt / Math.max(1, ebitda);
                const covenantCompliance = {
                    year: year + 1,
                    debtToEbitda: debtToEbitdaRatio,
                    covenantLimit: modelData.debtCovenant,
                    isCompliant: debtToEbitdaRatio <= modelData.debtCovenant,
                    margin: modelData.debtCovenant - debtToEbitdaRatio
                };

                // Almacenar resultados
                financialResults.pl.push({
                    year: year + 1,
                    interestRevenue,
                    margenOriginacion: margenOriginacionRecognized,
                    gnvCommissions,
                    sparePartsRevenue,
                    marketplaceRevenue,
                    totalRevenue,
                    opex,
                    provisionsExpense,
                    impairment: impairmentNIIF5,
                    ebitda,
                    depreciation: totalDepreciation,
                    ebit,
                    interestExpense,
                    ebt,
                    taxes,
                    netIncome
                });

                financialResults.cf.push({
                    year: year + 1,
                    operatingCash,
                    investingCash,
                    financingCash,
                    netCashFlow,
                    workingCapitalChange,
                    changeInReceivables
                });

                financialResults.bs.push({
                    year: year + 1,
                    cash,
                    receivables: outstandingReceivables,
                    fixedAssets: fixedAssetsNet,
                    assetsHeldForSale: fairValueLessCosts,
                    workingCapital: workingCapitalNeeds,
                    deferredFees: deferredOriginationFees,
                    totalAssets,
                    debt: totalDebt,
                    provisionsStage1,
                    provisionsStage2,
                    provisionsStage3,
                    totalProvisions,
                    equity,
                    totalLiabilitiesEquity,
                    balanceDifference,
                    isBalanced
                });

                financialResults.niifDetails.push({
                    year: year + 1,
                    niif15: {
                        tieEfectiva: financialResults.tieEfectiva,
                        interestRevenue,
                        deferredOriginationTotal: deferredOriginationFees,
                        recognizedOrigination: margenOriginacionRecognized,
                        gnvRestriction: modelData.variableRestrictionGNV,
                        partsRestriction: modelData.variableRestrictionParts
                    },
                    niif9: {
                        stage1Balance,
                        stage2Balance,
                        stage3Balance,
                        provisionsStage1,
                        provisionsStage2,
                        provisionsStage3,
                        totalProvisions,
                        utilizationStage3,
                        pdStage1: modelData.pdEtapa1,
                        pdStage2: modelData.pdEtapa2,
                        pdStage3: modelData.pdEtapa3,
                        lgd: modelData.lgd,
                        protectionAdjustment
                    },
                    niif5: {
                        totalUnits: cumulativeUnits,
                        repoUnits,
                        heldForSaleValue,
                        fairValue,
                        costsToSell,
                        fairValueLessCosts,
                        impairment: impairmentNIIF5,
                        avgAssetValue
                    }
                });

                financialResults.covenantCompliance.push(covenantCompliance);

                // CORRECCI√ìN: Flujos para TIR m√°s completos
                projectCashFlows.push(netCashFlow);
                
                // CORRECCI√ìN: TIR cartera incluye todos los componentes
                const portfolioNetCash = interestRevenue - provisionsExpense - (opex * 0.6) - interestExpense;
                portfolioCashFlows.push(portfolioNetCash);
            }

            // CORRECCI√ìN: Calcular TIR con m√©todo mejorado
            financialResults.tirProyecto = calculateImprovedIRR(projectCashFlows);
            financialResults.tirCartera = calculateImprovedIRR(portfolioCashFlows);
            
            // Realizar an√°lisis de sensibilidad
            performSensitivityAnalysis();
        }

        // ===== FUNCI√ìN TIR MEJORADA CON CONVERGENCIA GARANTIZADA =====
        function calculateImprovedIRR(cashFlows, maxIterations = 200, tolerance = 1e-8) {
            if (!cashFlows || cashFlows.length < 2) return 0;
            
            const hasPositive = cashFlows.some(cf => cf > 0);
            const hasNegative = cashFlows.some(cf => cf < 0);
            if (!hasPositive || !hasNegative) return 0;

            // M√©todo de bisecci√≥n como respaldo
            function bisectionMethod(low, high) {
                for (let i = 0; i < 100; i++) {
                    const mid = (low + high) / 2;
                    const npvMid = calculateNPV(cashFlows, mid);
                    
                    if (Math.abs(npvMid) < tolerance) {
                        return mid * 100;
                    }
                    
                    const npvLow = calculateNPV(cashFlows, low);
                    if ((npvLow > 0 && npvMid > 0) || (npvLow < 0 && npvMid < 0)) {
                        low = mid;
                    } else {
                        high = mid;
                    }
                }
                return ((low + high) / 2) * 100;
            }

            // M√©todo Newton-Raphson mejorado
            let guess = 0.1;
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let dNpv = 0;
                
                for (let t = 0; t < cashFlows.length; t++) {
                    const denominator = Math.pow(1 + guess, t);
                    npv += cashFlows[t] / denominator;
                    if (t > 0) {
                        dNpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
                    }
                }
                
                if (Math.abs(npv) < tolerance) {
                    return Math.max(0, Math.min(200, guess * 100));
                }
                
                if (Math.abs(dNpv) < tolerance) {
                    // Si la derivada es muy peque√±a, usar bisecci√≥n
                    return bisectionMethod(-0.99, 5);
                }
                
                const newGuess = guess - npv / dNpv;
                
                if (Math.abs(newGuess - guess) < tolerance) {
                    return Math.max(0, Math.min(200, newGuess * 100));
                }
                
                // Evitar valores negativos extremos
                guess = Math.max(-0.99, Math.min(5, newGuess));
            }
            
            // Si Newton-Raphson no converge, usar bisecci√≥n
            return bisectionMethod(-0.99, 5);
        }

        function calculateNPV(cashFlows, rate) {
            let npv = 0;
            for (let t = 0; t < cashFlows.length; t++) {
                npv += cashFlows[t] / Math.pow(1 + rate, t);
            }
            return npv;
        }

        // ===== AN√ÅLISIS DE SENSIBILIDAD =====
        function performSensitivityAnalysis() {
            const baseIRR = financialResults.tirProyecto;
            const sensitivity = {};
            
            // Variables clave para an√°lisis
            const variables = [
                { name: 'tasaInteres', delta: 5, label: 'Tasa Inter√©s' },
                { name: 'pdEtapa2', delta: 5, label: 'PD Etapa 2' },
                { name: 'tasaReposicion', delta: 3, label: 'Tasa Reposici√≥n' },
                { name: 'opexRate', delta: 3, label: 'Gastos Operativos' }
            ];
            
            variables.forEach(variable => {
                const originalValue = modelData[variable.name];
                
                // Scenario +
                modelData[variable.name] = originalValue * (1 + variable.delta / 100);
                calculateAdvancedFinancials();
                const irrUp = financialResults.tirProyecto;
                
                // Scenario -
                modelData[variable.name] = originalValue * (1 - variable.delta / 100);
                calculateAdvancedFinancials();
                const irrDown = financialResults.tirProyecto;
                
                // Restaurar valor original
                modelData[variable.name] = originalValue;
                
                sensitivity[variable.name] = {
                    label: variable.label,
                    base: baseIRR,
                    up: irrUp,
                    down: irrDown,
                    sensitivity: (irrUp - irrDown) / (2 * variable.delta / 100)
                };
            });
            
            financialResults.sensitivityAnalysis = sensitivity;
            
            // Recalcular con valores originales
            calculateAdvancedFinancials();
        }

        // ===== CONFIGURACI√ìN DE ESCENARIOS EXPANDIDA =====
        function setupScenarios() {
            const scenarios = {
                base: {
                    tasaInteres: 40.0, pdEtapa1: 3.5, pdEtapa2: 15.0, pdEtapa3: 85.0,
                    lgd: 75, proteccionRodando: true, margenOriginacion: 10,
                    comisionGNV: 8, margenRefacciones: 25, opexRate: 15,
                    ventureDebtPct: 70, ventureDebtRate: 12, taxRate: 30,
                    unitsPerYear: [35, 70, 100, 150, 200]
                },
                optimista: {
                    tasaInteres: 42.5, pdEtapa1: 2.5, pdEtapa2: 10.0, pdEtapa3: 70.0,
                    lgd: 65, proteccionRodando: true, margenOriginacion: 12,
                    comisionGNV: 10, margenRefacciones: 28, opexRate: 13,
                    ventureDebtPct: 75, ventureDebtRate: 10, taxRate: 30,
                    unitsPerYear: [40, 85, 130, 190, 260]
                },
                conservador: {
                    tasaInteres: 37.5, pdEtapa1: 5.0, pdEtapa2: 20.0, pdEtapa3: 95.0,
                    lgd: 85, proteccionRodando: false, margenOriginacion: 8,
                    comisionGNV: 6, margenRefacciones: 20, opexRate: 18,
                    ventureDebtPct: 65, ventureDebtRate: 14, taxRate: 30,
                    unitsPerYear: [25, 50, 75, 110, 140]
                },
                estres: {
                    tasaInteres: 35.0, pdEtapa1: 8.0, pdEtapa2: 30.0, pdEtapa3: 100.0,
                    lgd: 95, proteccionRodando: false, margenOriginacion: 6,
                    comisionGNV: 5, margenRefacciones: 18, opexRate: 22,
                    ventureDebtPct: 60, ventureDebtRate: 16, taxRate: 30,
                    unitsPerYear: [20, 35, 50, 70, 90]
                }
            };

            document.getElementById('btn-base').addEventListener('click', () => applyScenario(scenarios.base));
            document.getElementById('btn-optimista').addEventListener('click', () => applyScenario(scenarios.optimista));
            document.getElementById('btn-conservador').addEventListener('click', () => applyScenario(scenarios.conservador));
            document.getElementById('btn-estres').addEventListener('click', () => applyScenario(scenarios.estres));
        }

        function applyScenario(scenario) {
            Object.keys(scenario).forEach(key => {
                if (modelData.hasOwnProperty(key)) {
                    modelData[key] = scenario[key];
                }
            });

            updateAllControlsUI(); // CORRECCI√ìN: Actualizar todos los controles
            calculateAdvancedFinancials();
            updateUI();
        }

        // ===== CORRECCI√ìN: ACTUALIZACI√ìN COMPLETA DE CONTROLES UI =====
        function updateAllControlsUI() {
            // Actualizar todos los sliders
            const controls = [
                'tasa-interes', 'pd-etapa1', 'pd-etapa2', 'pd-etapa3', 'lgd',
                'margen-originacion', 'comision-gnv', 'margen-refacciones', 'opex-rate',
                'tax-rate', 'inflation-rate', 'serie-a', 'venture-debt-pct', 'venture-debt-rate',
                'amortizacion-deuda', 'debt-covenant', 'working-capital', 'tasa-reposicion',
                'fair-value', 'costos-venta', 'depreciation-years'
            ];

            controls.forEach(controlId => {
                const slider = document.getElementById(controlId);
                const display = document.getElementById(`${controlId}-valor`);
                const prop = getPropertyName(controlId);
                
                if (slider && display && modelData[prop] !== undefined) {
                    slider.value = modelData[prop];
                    display.textContent = formatControlValue(controlId, modelData[prop]);
                }
            });

            // Actualizar campos num√©ricos
            document.getElementById('costo-vagoneta').value = modelData.costoVagoneta;
            document.getElementById('precio-financiado').value = modelData.precioFinanciado;

            // Actualizar unidades
            for (let year = 1; year <= 5; year++) {
                const input = document.getElementById(`unit-year-${year}`);
                if (input) {
                    input.value = modelData.unitsPerYear[year-1];
                }
            }

            // Actualizar checkbox
            document.getElementById('check-proteccion').checked = modelData.proteccionRodando;
            
            // Validar despu√©s de actualizar
            validatePricing();
        }

        function getPropertyName(controlId) {
            const mapping = {
                'tasa-interes': 'tasaInteres',
                'pd-etapa1': 'pdEtapa1',
                'pd-etapa2': 'pdEtapa2',
                'pd-etapa3': 'pdEtapa3',
                'lgd': 'lgd',
                'margen-originacion': 'margenOriginacion',
                'comision-gnv': 'comisionGNV',
                'margen-refacciones': 'margenRefacciones',
                'opex-rate': 'opexRate',
                'tax-rate': 'taxRate',
                'inflation-rate': 'inflationRate',
                'serie-a': 'serieA',
                'venture-debt-pct': 'ventureDebtPct',
                'venture-debt-rate': 'ventureDebtRate',
                'amortizacion-deuda': 'amortizacionDeuda',
                'debt-covenant': 'debtCovenant',
                'working-capital': 'workingCapital',
                'tasa-reposicion': 'tasaReposicion',
                'fair-value': 'fairValue',
                'costos-venta': 'costosVenta',
                'depreciation-years': 'depreciationYears'
            };
            return mapping[controlId];
        }

        function formatControlValue(controlId, value) {
            if (controlId === 'serie-a') return (value/1000000).toFixed(0) + 'M';
            if (controlId === 'debt-covenant') return value.toFixed(1) + 'x';
            if (controlId === 'amortizacion-deuda' || controlId === 'depreciation-years') return value + ' a√±os';
            if (controlId.includes('rate') || controlId.includes('tasa') || controlId.includes('margen') || 
                controlId.includes('comision') || controlId.includes('lgd') || controlId.includes('fair') || 
                controlId.includes('costos') || controlId.includes('debt-pct') || controlId.includes('capital') ||
                controlId.includes('pd-') || controlId.includes('interes') || controlId.includes('inflation')) {
                return value.toFixed(1) + '%';
            }
            return value.toString();
        }

        // ===== ACTUALIZACI√ìN DE LA INTERFAZ MEJORADA =====
        function updateUI() {
            if (financialResults.pl.length >= 5) {
                // Actualizar tarjetas resumen
                document.getElementById('ebitda-year5').textContent = formatCurrency(financialResults.pl[4].ebitda);
                document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
                document.getElementById('tir-cartera').textContent = financialResults.tirCartera.toFixed(1) + '%';
                document.getElementById('tie-efectiva').textContent = financialResults.tieEfectiva.toFixed(1) + '%';
                document.getElementById('vagonetas-total').textContent = modelData.unitsPerYear.reduce((a, b) => a + b, 0);
                
                // Status del balance
                const isBalanced = financialResults.bs[4].isBalanced;
                document.getElementById('balance-status').textContent = isBalanced ? '‚öñÔ∏è OK' : '‚ö†Ô∏è ERROR';
                document.getElementById('balance-status').className = 'text-xl font-bold ' + (isBalanced ? 'text-green-600' : 'text-red-600');
            }

            // Actualizar todas las tablas
            updateAdvancedTables();
            updateAdvancedNIIFTables();
            
            // CORRECCI√ìN: Actualizar gr√°ficos autom√°ticamente
            updateCharts();
        }

        // ===== TABLAS AVANZADAS =====
        function updateAdvancedTables() {
            updateAdvancedPLTable();
            updateAdvancedCashFlowTable();
            updateAdvancedBalanceSheetTable();
        }

        function updateAdvancedPLTable() {
            const tbody = document.getElementById('pl-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            const headers = [
                'Ingresos por Intereses (TIE)',
                'Margen Originaci√≥n (Diferido)',
                'Comisiones GNV (Restringido)',
                'Ingresos Refacciones (Restringido)',
                'Ingresos Marketplace',
                'Total Ingresos',
                'Gastos Operativos',
                'Provisiones NIIF 9',
                'P√©rdida Deterioro NIIF 5',
                'EBITDA',
                'Depreciaci√≥n',
                'EBIT',
                'Intereses Deuda',
                'EBT',
                'Impuestos',
                'Utilidad Neta'
            ];

            headers.forEach(header => {
                const row = document.createElement('tr');
                const headerCell = document.createElement('td');
                headerCell.textContent = header;
                headerCell.classList.add('font-medium');
                row.appendChild(headerCell);

                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value = 0;
                    if (financialResults.pl[i]) {
                        const pl = financialResults.pl[i];
                        switch(header) {
                            case 'Ingresos por Intereses (TIE)': value = pl.interestRevenue; break;
                            case 'Margen Originaci√≥n (Diferido)': value = pl.margenOriginacion; break;
                            case 'Comisiones GNV (Restringido)': value = pl.gnvCommissions; break;
                            case 'Ingresos Refacciones (Restringido)': value = pl.sparePartsRevenue; break;
                            case 'Ingresos Marketplace': value = pl.marketplaceRevenue; break;
                            case 'Total Ingresos': value = pl.totalRevenue; break;
                            case 'Gastos Operativos': value = pl.opex; break;
                            case 'Provisiones NIIF 9': value = pl.provisionsExpense; break;
                            case 'P√©rdida Deterioro NIIF 5': value = pl.impairment; break;
                            case 'EBITDA': value = pl.ebitda; break;
                            case 'Depreciaci√≥n': value = pl.depreciation; break;
                            case 'EBIT': value = pl.ebit; break;
                            case 'Intereses Deuda': value = pl.interestExpense; break;
                            case 'EBT': value = pl.ebt; break;
                            case 'Impuestos': value = pl.taxes; break;
                            case 'Utilidad Neta': value = pl.netIncome; break;
                        }
                    }
                    cell.textContent = formatCurrency(value);

                    // Styling mejorado
                    if (['Total Ingresos', 'EBITDA', 'EBIT', 'EBT', 'Utilidad Neta'].includes(header)) {
                        cell.classList.add('font-bold');
                    }
                    if (value > 0 && !header.includes('Gastos') && !header.includes('Provisiones') && 
                        !header.includes('P√©rdida') && !header.includes('Impuestos')) {
                        cell.classList.add('positive');
                    } else if (value < 0) {
                        cell.classList.add('negative');
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            });
        }

        function updateAdvancedCashFlowTable() {
            const tbody = document.getElementById('cf-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            const headers = [
                'Flujo Operativo',
                'Cambio Capital Trabajo',
                'Cambio Cuentas x Cobrar',
                'Flujo Operativo Neto',
                'Flujo Inversi√≥n (CAPEX)',
                'Nueva Deuda',
                'Pago Deuda',
                'Capital Call',
                'Flujo Financiero',
                'Flujo Neto'
            ];

            headers.forEach(header => {
                const row = document.createElement('tr');
                const headerCell = document.createElement('td');
                headerCell.textContent = header;
                headerCell.classList.add('font-medium');
                row.appendChild(headerCell);

                for (let year = 0; year <= 5; year++) {
                    const cell = document.createElement('td');
                    let value = 0;

                    if (year === 0) {
                        if (header === 'Nueva Deuda') {
                            value = modelData.serieA * (modelData.ventureDebtPct / 100);
                        } else if (header === 'Capital Call') {
                            value = modelData.serieA * (1 - modelData.ventureDebtPct / 100);
                        } else if (header === 'Flujo Financiero') {
                            value = modelData.serieA;
                        } else if (header === 'Flujo Neto') {
                            value = modelData.serieA;
                        }
                    } else {
                        const idx = year - 1;
                        if (financialResults.cf[idx]) {
                            const cf = financialResults.cf[idx];
                            switch(header) {
                                case 'Flujo Operativo': value = cf.operatingCash + cf.workingCapitalChange + cf.changeInReceivables; break;
                                case 'Cambio Capital Trabajo': value = -cf.workingCapitalChange; break;
                                case 'Cambio Cuentas x Cobrar': value = -cf.changeInReceivables; break;
                                case 'Flujo Operativo Neto': value = cf.operatingCash; break;
                                case 'Flujo Inversi√≥n (CAPEX)': value = cf.investingCash; break;
                                case 'Nueva Deuda': 
                                    const capex = Math.abs(cf.investingCash);
                                    value = capex * (modelData.ventureDebtPct / 100);
                                    break;
                                case 'Pago Deuda': 
                                    // Calcular pago programado
                                    const totalDebtPrev = idx === 0 ? modelData.serieA * (modelData.ventureDebtPct / 100) : 0;
                                    value = -Math.min(totalDebtPrev / modelData.amortizacionDeuda, totalDebtPrev);
                                    break;
                                case 'Capital Call':
                                    const capexForEquity = Math.abs(cf.investingCash);
                                    value = capexForEquity * (1 - modelData.ventureDebtPct / 100);
                                    break;
                                case 'Flujo Financiero': value = cf.financingCash; break;
                                case 'Flujo Neto': value = cf.netCashFlow; break;
                            }
                        }
                    }
                    cell.textContent = formatCurrency(value);

                    if (header === 'Flujo Neto') {
                        cell.classList.add('font-bold');
                    }
                    if (value > 0) {
                        cell.classList.add('positive');
                    } else if (value < 0) {
                        cell.classList.add('negative');
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            });
        }

        function updateAdvancedBalanceSheetTable() {
            const tbody = document.getElementById('bs-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            const headers = [
                'ACTIVOS',
                'Efectivo',
                'Cuentas por Cobrar',
                'Capital de Trabajo',
                'Activos Diferidos NIIF 15',
                'Activos Fijos (Neto)',
                'Activos para Venta (NIIF 5)',
                'Total Activos',
                '',
                'PASIVOS Y PATRIMONIO',
                'Deuda Venture',
                'Provisiones Etapa 1',
                'Provisiones Etapa 2',
                'Provisiones Etapa 3',
                'Total Provisiones',
                'Patrimonio',
                'Total Pasivo + Patrimonio',
                '',
                'VALIDACI√ìN',
                'Diferencia Balance'
            ];

            headers.forEach(header => {
                const row = document.createElement('tr');
                const headerCell = document.createElement('td');
                headerCell.textContent = header;
                
                if (header === 'ACTIVOS' || header === 'PASIVOS Y PATRIMONIO' || header === 'VALIDACI√ìN') {
                    headerCell.classList.add('font-bold', 'bg-gray-100');
                } else if (header === '') {
                    headerCell.innerHTML = '&nbsp;';
                } else {
                    headerCell.classList.add('font-medium');
                }
                row.appendChild(headerCell);

                for (let i = 0; i < 5; i++) {
                    const cell = document.createElement('td');
                    let value = 0;
                    
                    if (header === '' || header === 'ACTIVOS' || header === 'PASIVOS Y PATRIMONIO' || header === 'VALIDACI√ìN') {
                        cell.innerHTML = '&nbsp;';
                        if (header === 'ACTIVOS' || header === 'PASIVOS Y PATRIMONIO' || header === 'VALIDACI√ìN') {
                            cell.classList.add('font-bold', 'bg-gray-100');
                        }
                    } else if (financialResults.bs[i]) {
                        const bs = financialResults.bs[i];
                        switch(header) {
                            case 'Efectivo': value = bs.cash; break;
                            case 'Cuentas por Cobrar': value = bs.receivables; break;
                            case 'Capital de Trabajo': value = bs.workingCapital; break;
                            case 'Activos Diferidos NIIF 15': value = bs.deferredFees; break;
                            case 'Activos Fijos (Neto)': value = bs.fixedAssets; break;
                            case 'Activos para Venta (NIIF 5)': value = bs.assetsHeldForSale; break;
                            case 'Total Activos': value = bs.totalAssets; break;
                            case 'Deuda Venture': value = bs.debt; break;
                            case 'Provisiones Etapa 1': value = bs.provisionsStage1; break;
                            case 'Provisiones Etapa 2': value = bs.provisionsStage2; break;
                            case 'Provisiones Etapa 3': value = bs.provisionsStage3; break;
                            case 'Total Provisiones': value = bs.totalProvisions; break;
                            case 'Patrimonio': value = bs.equity; break;
                            case 'Total Pasivo + Patrimonio': value = bs.totalLiabilitiesEquity; break;
                            case 'Diferencia Balance': value = bs.balanceDifference; break;
                        }
                        
                        cell.textContent = formatCurrency(value);
                        
                        if (['Total Activos', 'Total Provisiones', 'Total Pasivo + Patrimonio'].includes(header)) {
                            cell.classList.add('font-bold');
                        }
                        
                        if (header === 'Diferencia Balance') {
                            if (Math.abs(value) < 100) {
                                cell.classList.add('positive');
                            } else {
                                cell.classList.add('negative');
                            }
                        }
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            });

            // Actualizar validaci√≥n del balance
            updateBalanceValidation();
        }

        function updateBalanceValidation() {
            const validationDiv = document.getElementById('balance-validation');
            if (!validationDiv || financialResults.bs.length < 5) return;

            const lastYear = financialResults.bs[4];
            const diff = Math.abs(lastYear.balanceDifference);
            
            if (diff < 100) {
                validationDiv.innerHTML = `
                    <div class="validation-success">
                        <p><strong>‚úÖ Balance General Validado</strong></p>
                        <p>Diferencia: ${formatCurrency(lastYear.balanceDifference)}</p>
                        <p>Activos = Pasivos + Patrimonio ‚úì</p>
                    </div>
                `;
            } else {
                validationDiv.innerHTML = `
                    <div class="validation-error">
                        <p><strong>‚ùå Balance General Desbalanceado</strong></p>
                        <p>Diferencia: ${formatCurrency(lastYear.balanceDifference)}</p>
                        <p class="text-sm mt-2">Se requiere reconciliaci√≥n detallada</p>
                        <div class="mt-3 p-3 bg-white rounded">
                            <p class="font-semibold">Reconciliaci√≥n:</p>
                            <p>Total Activos: ${formatCurrency(lastYear.totalAssets)}</p>
                            <p>Total Pasivos + Patrimonio: ${formatCurrency(lastYear.totalLiabilitiesEquity)}</p>
                            <p>Diferencia: ${formatCurrency(lastYear.balanceDifference)}</p>
                        </div>
                    </div>
                `;
            }
        }

        // ===== TABLAS NIIF AVANZADAS =====
        function updateAdvancedNIIFTables() {
            if (financialResults.niifDetails.length < 5) return;

            updateNIIF15Table();
            updateNIIF9Table();
            updateNIIF5Table();
        }

        function updateNIIF15Table() {
            const niif15Container = document.getElementById('niif15-container');
            if (!niif15Container) return;

            const lastYear = financialResults.niifDetails[4].niif15;
            
            niif15Container.innerHTML = `
                <div class="mb-6">
                    <h5 class="font-semibold text-lg mb-3">Tasa de Inter√©s Efectiva (TIE)</h5>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg text-center">
                            <h6 class="font-semibold">Tasa Contractual</h6>
                            <p class="text-xl font-bold">${modelData.tasaInteres.toFixed(1)}%</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg text-center">
                            <h6 class="font-semibold">Costos Transacci√≥n</h6>
                            <p class="text-xl font-bold">${modelData.transactionCosts.toFixed(1)}%</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg text-center">
                            <h6 class="font-semibold">TIE Efectiva</h6>
                            <p class="text-xl font-bold text-purple-600">${lastYear.tieEfectiva.toFixed(1)}%</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h5 class="font-semibold text-lg mb-3">Reconocimiento de Ingresos Diferido</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-yellow-50 rounded-lg">
                            <h6 class="font-semibold">Margen Originaci√≥n</h6>
                            <p>Total Diferido: ${formatCurrency(lastYear.deferredOriginationTotal)}</p>
                            <p>Reconocido A√±o 5: ${formatCurrency(lastYear.recognizedOrigination)}</p>
                            <p class="text-sm text-gray-600">Diferido en ${modelData.deferralMonths} meses</p>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-lg">
                            <h6 class="font-semibold">Consideraci√≥n Variable</h6>
                            <p>Restricci√≥n GNV: ${lastYear.gnvRestriction}%</p>
                            <p>Restricci√≥n Refacciones: ${lastYear.partsRestriction}%</p>
                            <p class="text-sm text-gray-600">M√°ximo reconocible por NIIF 15</p>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>Concepto NIIF 15</th>
                                <th>A√±o 1</th>
                                <th>A√±o 2</th>
                                <th>A√±o 3</th>
                                <th>A√±o 4</th>
                                <th>A√±o 5</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Ingresos Intereses (TIE)</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.interestRevenue)}</td>`).join('')}
                            </tr>
                            <tr>
                                <td>Margen Originaci√≥n (Reconocido)</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.recognizedOrigination)}</td>`).join('')}
                            </tr>
                            <tr class="font-semibold bg-gray-50">
                                <td>Total Activos Diferidos</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif15.deferredOriginationTotal)}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function updateNIIF9Table() {
            const niif9Container = document.getElementById('niif9-container');
            if (!niif9Container) return;

            const lastYear = financialResults.niifDetails[4].niif9;
            
            niif9Container.innerHTML = `
                <div class="mb-6">
                    <h5 class="font-semibold text-lg mb-3">Modelo ECL por Etapas</h5>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-green-50 rounded-lg text-center">
                            <h6 class="font-semibold">Etapa 1 - Riesgo Normal</h6>
                            <p class="text-sm">Saldo: ${formatCurrency(lastYear.stage1Balance)}</p>
                            <p class="text-sm">PD: ${lastYear.pdStage1.toFixed(1)}%</p>
                            <p class="text-lg font-bold text-green-600">${formatCurrency(lastYear.provisionsStage1)}</p>
                            <p class="text-xs">12 meses p√©rdidas esperadas</p>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-lg text-center">
                            <h6 class="font-semibold">Etapa 2 - Riesgo Significativo</h6>
                            <p class="text-sm">Saldo: ${formatCurrency(lastYear.stage2Balance)}</p>
                            <p class="text-sm">PD: ${lastYear.pdStage2.toFixed(1)}%</p>
                            <p class="text-lg font-bold text-yellow-600">${formatCurrency(lastYear.provisionsStage2)}</p>
                            <p class="text-xs">Vida completa p√©rdidas esperadas</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg text-center">
                            <h6 class="font-semibold">Etapa 3 - Deteriorado</h6>
                            <p class="text-sm">Saldo: ${formatCurrency(lastYear.stage3Balance)}</p>
                            <p class="text-sm">PD: ${lastYear.pdStage3.toFixed(0)}%</p>
                            <p class="text-lg font-bold text-red-600">${formatCurrency(lastYear.provisionsStage3)}</p>
                            <p class="text-xs">Utilizaci√≥n anual: ${formatCurrency(lastYear.utilizationStage3)}</p>
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-4 rounded-lg" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                    <h5 class="font-semibold text-lg mb-2">Resumen NIIF 9</h5>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">LGD Promedio</p>
                            <p class="text-lg font-bold">${lastYear.lgd}%</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Total Provisiones</p>
                            <p class="text-lg font-bold">${formatCurrency(lastYear.totalProvisions)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Factor Protecci√≥n</p>
                            <p class="text-lg font-bold">${lastYear.protectionAdjustment.toFixed(0)}%</p>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>Etapa NIIF 9</th>
                                <th>A√±o 1</th>
                                <th>A√±o 2</th>
                                <th>A√±o 3</th>
                                <th>A√±o 4</th>
                                <th>A√±o 5</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Provisiones Etapa 1</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif9.provisionsStage1)}</td>`).join('')}
                            </tr>
                            <tr>
                                <td>Provisiones Etapa 2</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif9.provisionsStage2)}</td>`).join('')}
                            </tr>
                            <tr>
                                <td>Provisiones Etapa 3</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif9.provisionsStage3)}</td>`).join('')}
                            </tr>
                            <tr class="font-semibold bg-gray-50">
                                <td>Total Provisiones</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif9.totalProvisions)}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function updateNIIF5Table() {
            const niif5Container = document.getElementById('niif5-container');
            if (!niif5Container) return;

            const lastYear = financialResults.niifDetails[4].niif5;
            
            niif5Container.innerHTML = `
                <div class="mb-6">
                    <h5 class="font-semibold text-lg mb-3">Criterios de Clasificaci√≥n NIIF 5</h5>
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="font-semibold">Criterio: Alta Probabilidad Venta 12 Meses</p>
                                <p class="text-sm">‚úÖ Evaluaci√≥n realizada por unidad</p>
                                <p class="text-sm">‚úÖ Solo unidades repose√≠das calificadas</p>
                            </div>
                            <div>
                                <p class="font-semibold">Medici√≥n</p>
                                <p class="text-sm">Menor entre:</p>
                                <p class="text-sm">‚Ä¢ Valor en libros</p>
                                <p class="text-sm">‚Ä¢ Valor razonable menos costos venta</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="space-y-4">
                        <div class="p-4 bg-purple-50 rounded-lg">
                            <h6 class="font-semibold">Activos Totales</h6>
                            <p class="text-lg">${Math.round(lastYear.totalUnits)} unidades</p>
                            <p class="text-sm text-gray-600">Valor promedio: ${formatCurrency(lastYear.avgAssetValue)}</p>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-lg">
                            <h6 class="font-semibold">Mantenidos para Venta</h6>
                            <p class="text-lg font-bold">${Math.round(lastYear.repoUnits)} unidades</p>
                            <p class="text-sm text-gray-600">Valor en libros: ${formatCurrency(lastYear.heldForSaleValue)}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-green-50 rounded-lg">
                            <h6 class="font-semibold">Valor Razonable</h6>
                            <p class="text-lg">${formatCurrency(lastYear.fairValue)}</p>
                            <p class="text-sm text-gray-600">Menos costos venta: ${formatCurrency(lastYear.costsToSell)}</p>
                            <p class="font-semibold">Neto: ${formatCurrency(lastYear.fairValueLessCosts)}</p>
                        </div>
                        <div class="p-4 ${lastYear.impairment > 0 ? 'bg-red-50' : 'bg-green-50'} rounded-lg">
                            <h6 class="font-semibold">Deterioro NIIF 5</h6>
                            <p class="text-lg font-bold ${lastYear.impairment > 0 ? 'text-red-600' : 'text-green-600'}">
                                ${lastYear.impairment > 0 ? formatCurrency(lastYear.impairment) : 'Sin deterioro'}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>Concepto NIIF 5</th>
                                <th>A√±o 1</th>
                                <th>A√±o 2</th>
                                <th>A√±o 3</th>
                                <th>A√±o 4</th>
                                <th>A√±o 5</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Unidades Mantenidas Venta</td>
                                ${financialResults.niifDetails.map(d => `<td>${Math.round(d.niif5.repoUnits)}</td>`).join('')}
                            </tr>
                            <tr>
                                <td>Valor en Libros</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif5.heldForSaleValue)}</td>`).join('')}
                            </tr>
                            <tr>
                                <td>Valor Razonable Neto</td>
                                ${financialResults.niifDetails.map(d => `<td>${formatCurrency(d.niif5.fairValueLessCosts)}</td>`).join('')}
                            </tr>
                            <tr class="font-semibold">
                                <td>P√©rdida por Deterioro</td>
                                ${financialResults.niifDetails.map(d => `<td class="${d.niif5.impairment > 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(d.niif5.impairment)}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ===== GR√ÅFICOS AVANZADOS =====
        function initializeCharts() {
            // EBITDA Chart
            const ctx1 = document.getElementById('ebitdaChart');
            if (ctx1) {
                charts.ebitda = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: ['A√±o 1', 'A√±o 2', 'A√±o 3', 'A√±o 4', 'A√±o 5'],
                        datasets: [{
                            label: 'EBITDA (M MXN)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3
                        }, {
                            label: 'EBITDA Ajustado Inflaci√≥n',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: false,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Evoluci√≥n del EBITDA' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // TIR Comparison Chart
            const ctx2 = document.getElementById('tirChart');
            if (ctx2) {
                charts.tir = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['TIR Proyecto', 'TIR Cartera', 'TIE Efectiva'],
                        datasets: [{
                            label: 'Tasas (%)',
                            data: [],
                            backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Comparaci√≥n de Tasas Corregidas' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Migration Chart
            const ctx3 = document.getElementById('migrationChart');
            if (ctx3) {
                charts.migration = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['A√±o 1', 'A√±o 2', 'A√±o 3', 'A√±o 4', 'A√±o 5'],
                        datasets: [
                            {
                                label: 'Etapa 1',
                                data: [],
                                backgroundColor: '#10b981'
                            },
                            {
                                label: 'Etapa 2',
                                data: [],
                                backgroundColor: '#f59e0b'
                            },
                            {
                                label: 'Etapa 3',
                                data: [],
                                backgroundColor: '#ef4444'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Migraci√≥n entre Etapas NIIF 9' }
                        },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        }
                    }
                });
            }

            // Covenant Chart
            const ctx4 = document.getElementById('covenantChart');
            if (ctx4) {
                charts.covenant = new Chart(ctx4, {
                    type: 'line',
                    data: {
                        labels: ['A√±o 1', 'A√±o 2', 'A√±o 3', 'A√±o 4', 'A√±o 5'],
                        datasets: [{
                            label: 'Deuda/EBITDA',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true
                        }, {
                            label: 'L√≠mite Covenant',
                            data: [],
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Cumplimiento de Covenants' }
                        }
                    }
                });
            }

            // Sensitivity Chart
            const ctx5 = document.getElementById('sensitivityChart');
            if (ctx5) {
                charts.sensitivity = new Chart(ctx5, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Sensibilidad TIR',
                            data: [],
                            backgroundColor: '#8b5cf6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'An√°lisis de Sensibilidad' }
                        },
                        indexAxis: 'y',
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }

            // Working Capital Chart
            const ctx6 = document.getElementById('workingCapitalChart');
            if (ctx6) {
                charts.workingCapital = new Chart(ctx6, {
                    type: 'line',
                    data: {
                        labels: ['A√±o 1', 'A√±o 2', 'A√±o 3', 'A√±o 4', 'A√±o 5'],
                        datasets: [{
                            label: 'Capital de Trabajo (M MXN)',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Evoluci√≥n Capital de Trabajo' }
                        }
                    }
                });
            }
        }

        function updateCharts() {
            if (financialResults.pl.length < 5) return;

            // Update EBITDA Chart
            if (charts.ebitda) {
                const ebitdaData = financialResults.pl.map(p => p.ebitda / 1000000);
                const ebitdaAdjusted = financialResults.pl.map((p, i) => {
                    const inflationFactor = Math.pow(1 + modelData.inflationRate / 100, i);
                    return (p.ebitda / inflationFactor) / 1000000;
                });
                charts.ebitda.data.datasets[0].data = ebitdaData;
                charts.ebitda.data.datasets[1].data = ebitdaAdjusted;
                charts.ebitda.update();
            }

            // Update TIR Chart
            if (charts.tir) {
                charts.tir.data.datasets[0].data = [
                    financialResults.tirProyecto,
                    financialResults.tirCartera,
                    financialResults.tieEfectiva
                ];
                charts.tir.update();
            }

            // Update Migration Chart
            if (charts.migration && financialResults.niifDetails.length >= 5) {
                const stage1Data = financialResults.niifDetails.map(n => n.niif9.provisionsStage1 / 1000);
                const stage2Data = financialResults.niifDetails.map(n => n.niif9.provisionsStage2 / 1000);
                const stage3Data = financialResults.niifDetails.map(n => n.niif9.provisionsStage3 / 1000);
                charts.migration.data.datasets[0].data = stage1Data;
                charts.migration.data.datasets[1].data = stage2Data;
                charts.migration.data.datasets[2].data = stage3Data;
                charts.migration.update();
            }

            // Update Covenant Chart
            if (charts.covenant && financialResults.covenantCompliance.length >= 5) {
                const ratios = financialResults.covenantCompliance.map(c => c.debtToEbitda);
                const limits = new Array(5).fill(modelData.debtCovenant);
                charts.covenant.data.datasets[0].data = ratios;
                charts.covenant.data.datasets[1].data = limits;
                charts.covenant.update();
            }

            // Update Sensitivity Chart
            if (charts.sensitivity && financialResults.sensitivityAnalysis) {
                const sensData = Object.values(financialResults.sensitivityAnalysis);
                if (sensData.length > 0) {
                    charts.sensitivity.data.labels = sensData.map(s => s.label);
                    charts.sensitivity.data.datasets[0].data = sensData.map(s => Math.abs(s.sensitivity));
                    charts.sensitivity.update();
                }
            }

            // Update Working Capital Chart
            if (charts.workingCapital) {
                const wcData = financialResults.bs.map(b => b.workingCapital / 1000000);
                charts.workingCapital.data.datasets[0].data = wcData;
                charts.workingCapital.update();
            }
        }

        // ===== NUEVA FUNCIONALIDAD: PANEL DE VALIDACI√ìN =====
        function setupValidation() {
            // Esta funci√≥n se llamar√° para configurar validaciones adicionales
        }

        function updateValidationDashboard() {
            const validationDiv = document.getElementById('validation-dashboard');
            if (!validationDiv) return;

            const validations = [];
            
            // Validar balance
            if (financialResults.bs.length >= 5) {
                const lastBalance = financialResults.bs[4];
                validations.push({
                    category: 'Balance General',
                    test: 'Activos = Pasivos + Patrimonio',
                    result: lastBalance.isBalanced,
                    value: formatCurrency(lastBalance.balanceDifference),
                    status: lastBalance.isBalanced ? 'success' : 'error'
                });
            }

            // Validar covenants
            if (financialResults.covenantCompliance.length >= 5) {
                const lastCovenant = financialResults.covenantCompliance[4];
                validations.push({
                    category: 'Covenant Deuda',
                    test: 'Deuda/EBITDA < L√≠mite',
                    result: lastCovenant.isCompliant,
                    value: `${lastCovenant.debtToEbitda.toFixed(2)}x (L√≠mite: ${lastCovenant.covenantLimit}x)`,
                    status: lastCovenant.isCompliant ? 'success' : 'warning'
                });
            }

            // Validar coherencia NIIF
            validations.push({
                category: 'NIIF 9',
                test: 'Progresi√≥n PD por Etapas',
                result: modelData.pdEtapa1 < modelData.pdEtapa2 && modelData.pdEtapa2 < modelData.pdEtapa3,
                value: `${modelData.pdEtapa1}% < ${modelData.pdEtapa2}% < ${modelData.pdEtapa3}%`,
                status: (modelData.pdEtapa1 < modelData.pdEtapa2 && modelData.pdEtapa2 < modelData.pdEtapa3) ? 'success' : 'error'
            });

            // Validar precios
            validations.push({
                category: 'NIIF 5',
                test: 'Precio > Costo',
                result: modelData.precioFinanciado > modelData.costoVagoneta,
                value: `${formatCurrency(modelData.precioFinanciado)} > ${formatCurrency(modelData.costoVagoneta)}`,
                status: modelData.precioFinanciado > modelData.costoVagoneta ? 'success' : 'error'
            });

            let validationHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;

            validations.forEach(validation => {
                const statusClass = {
                    'success': 'validation-success',
                    'warning': 'validation-warning', 
                    'error': 'validation-error'
                }[validation.status];

                const statusIcon = {
                    'success': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå'
                }[validation.status];

                validationHTML += `
                    <div class="${statusClass}">
                        <div class="flex items-center justify-between">
                            <div>
                                <h6 class="font-semibold">${statusIcon} ${validation.category}</h6>
                                <p class="text-sm">${validation.test}</p>
                                <p class="text-xs font-mono">${validation.value}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            validationHTML += '</div>';
            validationDiv.innerHTML = validationHTML;

            // Update balance reconciliation
            updateBalanceReconciliation();
            
            // Update sensitivity analysis display
            updateSensitivityDisplay();
        }

        function updateBalanceReconciliation() {
            const reconciliationDiv = document.getElementById('balance-reconciliation');
            if (!reconciliationDiv || financialResults.bs.length < 5) return;

            const bs = financialResults.bs[4];
            
            reconciliationDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h6 class="font-semibold text-lg mb-3">ACTIVOS</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Efectivo:</span>
                                <span class="font-mono">${formatCurrency(bs.cash)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cuentas por Cobrar:</span>
                                <span class="font-mono">${formatCurrency(bs.receivables)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Capital de Trabajo:</span>
                                <span class="font-mono">${formatCurrency(bs.workingCapital)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Activos Diferidos:</span>
                                <span class="font-mono">${formatCurrency(bs.deferredFees)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Activos Fijos (Neto):</span>
                                <span class="font-mono">${formatCurrency(bs.fixedAssets)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Activos para Venta:</span>
                                <span class="font-mono">${formatCurrency(bs.assetsHeldForSale)}</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold">
                                <span>TOTAL ACTIVOS:</span>
                                <span class="font-mono">${formatCurrency(bs.totalAssets)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h6 class="font-semibold text-lg mb-3">PASIVOS + PATRIMONIO</h6>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Deuda Venture:</span>
                                <span class="font-mono">${formatCurrency(bs.debt)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Provisiones Etapa 1:</span>
                                <span class="font-mono">${formatCurrency(bs.provisionsStage1)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Provisiones Etapa 2:</span>
                                <span class="font-mono">${formatCurrency(bs.provisionsStage2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Provisiones Etapa 3:</span>
                                <span class="font-mono">${formatCurrency(bs.provisionsStage3)}</span>
                            </div>
                            <div class="flex justify-between font-semibold">
                                <span>Total Provisiones:</span>
                                <span class="font-mono">${formatCurrency(bs.totalProvisions)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Patrimonio:</span>
                                <span class="font-mono">${formatCurrency(bs.equity)}</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold">
                                <span>TOTAL PAS + PAT:</span>
                                <span class="font-mono">${formatCurrency(bs.totalLiabilitiesEquity)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-4 ${Math.abs(bs.balanceDifference) < 100 ? 'bg-green-50' : 'bg-red-50'} rounded-lg">
                    <div class="text-center">
                        <h6 class="font-semibold text-lg">
                            ${Math.abs(bs.balanceDifference) < 100 ? '‚úÖ' : '‚ùå'} 
                            DIFERENCIA: ${formatCurrency(bs.balanceDifference)}
                        </h6>
                        <p class="text-sm mt-1">
                            ${Math.abs(bs.balanceDifference) < 100 ? 
                              'Balance validado correctamente' : 
                              'Se requiere ajuste para equilibrar el balance'}
                        </p>
                    </div>
                </div>
            `;
        }

        function updateSensitivityDisplay() {
            const sensitivityDiv = document.getElementById('sensitivity-analysis');
            if (!sensitivityDiv || !financialResults.sensitivityAnalysis) return;

            const sensData = Object.values(financialResults.sensitivityAnalysis);
            if (sensData.length === 0) return;

            let sensitivityHTML = `
                <div class="overflow-x-auto">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>TIR Base</th>
                                <th>Escenario +</th>
                                <th>Escenario -</th>
                                <th>Sensibilidad</th>
                                <th>Ranking</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Ordenar por sensibilidad
            const sortedSens = sensData.sort((a, b) => Math.abs(b.sensitivity) - Math.abs(a.sensitivity));

            sortedSens.forEach((sens, index) => {
                sensitivityHTML += `
                    <tr>
                        <td class="font-medium">${sens.label}</td>
                        <td>${sens.base.toFixed(1)}%</td>
                        <td class="${sens.up > sens.base ? 'positive' : 'negative'}">${sens.up.toFixed(1)}%</td>
                        <td class="${sens.down > sens.base ? 'positive' : 'negative'}">${sens.down.toFixed(1)}%</td>
                        <td class="font-mono">${Math.abs(sens.sensitivity).toFixed(2)}</td>
                        <td class="text-center">
                            <span class="inline-block w-6 h-6 rounded-full text-white text-xs leading-6 ${index === 0 ? 'bg-red-500' : index === 1 ? 'bg-orange-500' : index === 2 ? 'bg-yellow-500' : 'bg-gray-500'}">
                                ${index + 1}
                            </span>
                        </td>
                    </tr>
                `;
            });

            sensitivityHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h6 class="font-semibold">Interpretaci√≥n</h6>
                    <p class="text-sm mt-2">
                        La variable con mayor sensibilidad es <strong>${sortedSens[0].label}</strong>. 
                        Una variaci√≥n del 5% en esta variable genera un impacto de 
                        <strong>${Math.abs(sortedSens[0].sensitivity).toFixed(2)} puntos porcentuales</strong> en la TIR.
                    </p>
                </div>
            `;

            sensitivityDiv.innerHTML = sensitivityHTML;
        }

        // ===== FUNCIONALIDAD DE EXPORTACI√ìN =====
        function setupExportFunctionality() {
            const btnExport = document.getElementById('btn-export');
            if (btnExport) {
                btnExport.addEventListener('click', function() {
                    exportResults();
                });
            }
        }

        function exportResults() {
            const exportData = {
                metadata: {
                    timestamp: new Date().toISOString(),
                    model: 'Rodando a Gas - NIIF Compliant',
                    version: 'Corregido v2.0'
                },
                parameters: modelData,
                results: {
                    pl: financialResults.pl,
                    cf: financialResults.cf,
                    bs: financialResults.bs,
                    niif: financialResults.niifDetails,
                    tir: {
                        proyecto: financialResults.tirProyecto,
                        cartera: financialResults.tirCartera,
                        tieEfectiva: financialResults.tieEfectiva
                    },
                    covenants: financialResults.covenantCompliance,
                    sensitivity: financialResults.sensitivityAnalysis
                }
            };

            // Crear CSV para exportaci√≥n
            const csvContent = generateCSV(exportData);
            downloadCSV(csvContent, 'modelo_financiero_rag_corregido.csv');
            
            // Tambi√©n generar JSON
            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadJSON(jsonContent, 'modelo_financiero_rag_corregido.json');
        }

        function generateCSV(data) {
            let csv = 'Reporte Modelo Financiero RAG - NIIF Compliant\n\n';
            
            // Resumen ejecutivo
            csv += 'RESUMEN EJECUTIVO\n';
            csv += 'M√©trica,Valor\n';
            csv += `TIR Proyecto,${data.results.tir.proyecto.toFixed(2)}%\n`;
            csv += `TIR Cartera,${data.results.tir.cartera.toFixed(2)}%\n`;
            csv += `TIE Efectiva,${data.results.tir.tieEfectiva.toFixed(2)}%\n`;
            csv += `EBITDA A√±o 5,${formatCurrency(data.results.pl[4].ebitda)}\n`;
            csv += `Utilidad Neta A√±o 5,${formatCurrency(data.results.pl[4].netIncome)}\n\n`;
            
            // Estado de resultados
            csv += 'ESTADO DE RESULTADOS\n';
            csv += 'Concepto,A√±o 1,A√±o 2,A√±o 3,A√±o 4,A√±o 5\n';
            csv += `Total Ingresos,${data.results.pl.map(p => p.totalRevenue.toFixed(0)).join(',')}\n`;
            csv += `EBITDA,${data.results.pl.map(p => p.ebitda.toFixed(0)).join(',')}\n`;
            csv += `Utilidad Neta,${data.results.pl.map(p => p.netIncome.toFixed(0)).join(',')}\n\n`;
            
            return csv;
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadJSON(content, filename) {
            const blob = new Blob([content], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ===== UTILIDADES =====
        function formatCurrency(value) {
            if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M MXN';
            }
            if (Math.abs(value) >= 1000) {
                return '$' + (value / 1000).toFixed(0) + 'K MXN';
            }
            return '$' + Math.round(value).toLocaleString() + ' MXN';
        }
    </script>
</body>
</html>
