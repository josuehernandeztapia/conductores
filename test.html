<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero "Rodando a Gas" - NIIF Compliant Modularizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- M칩dulos del sistema -->
    <script src="js/Utils.js"></script>
    <script src="js/NIIFCalculations.js"></script>
    <script src="js/FinancialCalculations.js"></script>
    <script src="js/ChartManager.js"></script>
    <script src="js/TableRenderer.js"></script>
    <script src="js/UIController.js"></script>
    <script src="js/FinancialModel.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; }
        .tab-button.active { border-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #2563eb; border-radius: 9999px; cursor: pointer; }
        .financial-table { width: 100%; border-collapse: collapse; }
        .financial-table th, .financial-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid #e5e7eb; }
        .financial-table th { background-color: #f9fafb; font-weight: 600; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; }
        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .metric-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb; }
        .niif-explanation { background-color: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .niif-header { color: #10b981; font-weight: 600; margin-bottom: 0.5rem; }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .input-container { display: flex; align-items: center; gap: 1rem; }
        .input-value { font-weight: 600; color: #2563eb; min-width: 60px; }
        .section-header { font-size: 1.25rem; font-weight: 600; color: #1e40af; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #dbeafe; }
        .validation-success { background-color: #dcfce7; border-left: 4px solid #22c55e; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .validation-error { background-color: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .enganche-highlight { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; }
    </style>
</head>
<body class="text-gray-800">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8 text-center bg-white rounded-xl p-6 shadow-sm">
            <h1 class="text-3xl font-bold text-gray-900">Modelo Financiero - Rodando a Gas</h1>
            <p class="text-lg text-gray-600 mt-2">Financiamiento de Vagonetas con Cumplimiento NIIF - VERSI칍N MODULARIZADA</p>
            <div class="mt-4">
                <p class="text-gray-600">
                    RAG no vende vagonetas, las financia. Las vagonetas son activos fijos y
                    los ingresos provienen principalmente de intereses del financiamiento y servicios auxiliares.
                </p>
                <div class="mt-2 p-2 bg-blue-100 rounded">
                    <p class="text-sm text-blue-800 font-semibold">游댢 Arquitectura modularizada para mejor mantenibilidad y escalabilidad</p>
                </div>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-6 mb-8">
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">EBITDA A침o 5</div>
                <div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Proyecto</div>
                <div class="text-2xl font-bold" id="tir-proyecto">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">TIR Cartera</div>
                <div class="text-2xl font-bold" id="tir-cartera">0%</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Vagonetas</div>
                <div class="text-2xl font-bold" id="vagonetas-total">0</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Deuda Residual</div>
                <div class="text-2xl font-bold" id="deuda-residual">$0M MXN</div>
            </div>
            <div class="metric-card p-4 rounded-lg">
                <div class="text-sm text-gray-500">Balance Status</div>
                <div class="text-lg font-bold" id="balance-status">Verificando...</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active text-lg font-medium mr-2 inline-block p-4 border-b-2 border-blue-500 rounded-t-lg">游 Control</button>
                <button id="tab-financieros" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">游늵 Financieros</button>
                <button id="tab-niif" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">游늶 NIIF</button>
                <button id="tab-graficos" class="tab-button text-lg font-medium mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg">游늳 Gr치ficos</button>
            </nav>
        </div>

        <!-- Control Panel -->
        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-6">
                    <!-- Cr칠dito y Riesgo -->
                    <div class="card">
                        <div class="section-header">Cr칠dito y Riesgo</div>
                        <div class="niif-explanation">
                            <div class="niif-header">NIIF 9 - Instrumentos Financieros</div>
                            <p class="text-sm text-gray-700">
                                Establece c칩mo las entidades deben clasificar, medir y realizar pruebas
                                de deterioro de activos financieros. Requiere reconocimiento de p칠rdidas crediticias esperadas.
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa de Inter칠s Efectiva (%)</label>
                            <div class="input-container">
                                <input type="range" id="tasa-interes" min="10" max="40" step="0.1" value="40.0" class="input-slider">
                                <span id="tasa-interes-valor" class="input-value">40.0%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa de Morosidad (%)</label>
                            <div class="input-container">
                                <input type="range" id="tasa-morosidad" min="1" max="30" step="0.5" value="19.5" class="input-slider">
                                <span id="tasa-morosidad-valor" class="input-value">19.5%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">LGD (P칠rdida en caso de Incumplimiento) (%)</label>
                            <div class="input-container">
                                <input type="range" id="lgd" min="20" max="100" step="1" value="80" class="input-slider">
                                <span id="lgd-valor" class="input-value">80%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Etapa 2 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa2" min="1" max="30" step="0.5" value="12" class="input-slider">
                                <span id="pd-etapa2-valor" class="input-value">12%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">PD Etapa 3 (%)</label>
                            <div class="input-container">
                                <input type="range" id="pd-etapa3" min="1" max="100" step="1" value="30" class="input-slider">
                                <span id="pd-etapa3-valor" class="input-value">30%</span>
                            </div>
                        </div>
                        <div class="flex items-center mt-4">
                            <input id="check-proteccion" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                            <label for="check-proteccion" class="ml-2 block text-sm text-gray-900">Protecci칩n Rodando (Reducci칩n t칠cnica por colateral)</label>
                        </div>
                    </div>

                    <!-- Operaciones -->
                    <div class="card">
                        <div class="section-header">Operaciones</div>
                        <div class="niif-explanation">
                            <div class="niif-header">NIIF 15 - Ingresos de Actividades Ordinarias</div>
                            <p class="text-sm text-gray-700">
                                Establece los principios para el reconocimiento de ingresos por la venta
                                de bienes, prestaci칩n de servicios y contratos con clientes.
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margen por Originaci칩n (%)</label>
                            <div class="input-container">
                                <input type="range" id="margen-originacion" min="5" max="20" step="0.5" value="10" class="input-slider">
                                <span id="margen-originacion-valor" class="input-value">10%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Comisi칩n GNV (%)</label>
                            <div class="input-container">
                                <input type="range" id="comision-gnv" min="5" max="15" step="0.5" value="8" class="input-slider">
                                <span id="comision-gnv-valor" class="input-value">8%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margen Refacciones (%)</label>
                            <div class="input-container">
                                <input type="range" id="margen-refacciones" min="15" max="35" step="1" value="25" class="input-slider">
                                <span id="margen-refacciones-valor" class="input-value">25%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Gastos Operativos (%) - Rango 10-15%</label>
                            <div class="input-container">
                                <input type="range" id="opex-rate" min="10" max="15" step="0.5" value="12.5" class="input-slider">
                                <span id="opex-rate-valor" class="input-value">12.5%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-6">
                    <!-- Capital -->
                    <div class="card">
                        <div class="section-header">Capital</div>
                        <div class="input-group">
                            <label class="input-label">Serie A Capital Inicial (M MXN)</label>
                            <div class="input-container">
                                <input type="range" id="serie-a" min="30" max="60" step="1" value="45" class="input-slider">
                                <span id="serie-a-valor" class="input-value">45M</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">% Venture Debt sobre Inversi칩n</label>
                            <div class="input-container">
                                <input type="range" id="venture-debt-pct" min="50" max="90" step="5" value="70" class="input-slider">
                                <span id="venture-debt-pct-valor" class="input-value">70%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Venture Debt (%)</label>
                            <div class="input-container">
                                <input type="range" id="venture-debt-rate" min="8" max="18" step="0.5" value="12" class="input-slider">
                                <span id="venture-debt-rate-valor" class="input-value">12%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Per칤odo Amortizaci칩n Deuda (A침os)</label>
                            <div class="input-container">
                                <input type="range" id="amortizacion-deuda" min="3" max="7" step="1" value="5" class="input-slider">
                                <span id="amortizacion-deuda-valor" class="input-value">5 a침os</span>
                            </div>
                        </div>
                    </div>

                    <!-- Enganche Cliente -->
                    <div class="card enganche-highlight">
                        <div class="section-header">游 T칠rminos del Cliente</div>
                        <div class="niif-explanation">
                            <div class="niif-header">Assumption 4: Enganche Cliente</div>
                            <p class="text-sm text-gray-700">
                                El cliente puede dar un enganche de entre 100K y 150K MXN, 
                                reduciendo el monto a financiar y mejorando la TIR del proyecto.
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Enganche Cliente (MXN)</label>
                            <div class="input-container">
                                <input type="range" id="enganche-cliente" min="100000" max="150000" step="1000" value="100000" class="input-slider">
                                <span id="enganche-cliente-valor" class="input-value">$100K</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Monto Financiado Resultante</label>
                            <div class="p-2 bg-yellow-50 rounded">
                                <span id="monto-financiado-display" class="font-semibold text-yellow-600">$629,000 MXN</span>
                            </div>
                        </div>
                    </div>

                    <!-- Activos y NIIF 5 -->
                    <div class="card">
                        <div class="section-header">Activos y NIIF 5</div>
                        <div class="niif-explanation">
                            <div class="niif-header">NIIF 5 - Activos No Corrientes Mantenidos para la Venta</div>
                            <p class="text-sm text-gray-700">
                                Establece el tratamiento contable para activos que se mantienen para su
                                venta, incluyendo medici칩n, presentaci칩n e informaci칩n a revelar.
                            </p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Costo Vagoneta (MXN)</label>
                            <input type="number" id="costo-vagoneta" min="500000" max="800000" step="1000" value="641000" class="p-2 border rounded w-full">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Precio Base Financiado (MXN)</label>
                            <input type="number" id="precio-financiado" min="600000" max="900000" step="1000" value="729000" class="p-2 border rounded w-full">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Tasa Reposesi칩n (%)</label>
                            <div class="input-container">
                                <input type="range" id="tasa-reposicion" min="1" max="15" step="0.5" value="15" class="input-slider">
                                <span id="tasa-reposicion-valor" class="input-value">15%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Fair Value Venta (%)</label>
                            <div class="input-container">
                                <input type="range" id="fair-value" min="70" max="95" step="1" value="85" class="input-slider">
                                <span id="fair-value-valor" class="input-value">85%</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Costos de Venta (%)</label>
                            <div class="input-container">
                                <input type="range" id="costos-venta" min="1" max="10" step="0.5" value="5" class="input-slider">
                                <span id="costos-venta-valor" class="input-value">5%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unidades por A침o -->
            <div class="card mt-6">
                <div class="section-header">Unidades por A침o</div>
                <div class="niif-explanation">
                    <p class="text-sm text-gray-700">
                        Las vagonetas son activos fijos en el balance de RAG. Los ingresos
                        provienen de intereses del financiamiento y servicios auxiliares,
                        no de la venta de las vagonetas.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="units-container">
                    <div class="flex flex-col">
                        <label class="input-label">A침o 1</label>
                        <input type="number" id="unit-year-1" min="0" max="1000" value="35" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A침o 2</label>
                        <input type="number" id="unit-year-2" min="0" max="1000" value="70" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A침o 3</label>
                        <input type="number" id="unit-year-3" min="0" max="1000" value="100" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A침o 4</label>
                        <input type="number" id="unit-year-4" min="0" max="1000" value="150" class="p-2 border rounded">
                    </div>
                    <div class="flex flex-col">
                        <label class="input-label">A침o 5</label>
                        <input type="number" id="unit-year-5" min="0" max="1000" value="200" class="p-2 border rounded">
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <div>
                        <button id="btn-base" class="bg-blue-500 text-white px-4 py-2 rounded font-medium">Escenario Base</button>
                        <button id="btn-optimista" class="bg-green-500 text-white px-4 py-2 rounded font-medium ml-2">Optimista</button>
                        <button id="btn-conservador" class="bg-yellow-500 text-white px-4 py-2 rounded font-medium ml-2">Conservador</button>
                    </div>
                    <button id="btn-recalcular" class="bg-indigo-600 text-white px-4 py-2 rounded font-medium">游댃 Recalcular Modelo</button>
                </div>
                <div id="error-messages" class="mt-4"></div>
            </div>
        </div>

        <!-- Estados Financieros -->
        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A침o 1</th>
                                    <th>A침o 2</th>
                                    <th>A침o 3</th>
                                    <th>A침o 4</th>
                                    <th>A침o 5</th>
                                </tr>
                            </thead>
                            <tbody id="pl-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A침o 0</th>
                                    <th>A침o 1</th>
                                    <th>A침o 2</th>
                                    <th>A침o 3</th>
                                    <th>A침o 4</th>
                                    <th>A침o 5</th>
                                </tr>
                            </thead>
                            <tbody id="cf-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Balance General</h3>
                    <div class="overflow-x-auto">
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>A침o 1</th>
                                    <th>A침o 2</th>
                                    <th>A침o 3</th>
                                    <th>A침o 4</th>
                                    <th>A침o 5</th>
                                </tr>
                            </thead>
                            <tbody id="bs-table-body">
                                <!-- Content will be dynamically added -->
                            </tbody>
                        </table>
                    </div>
                    <div id="balance-validation" class="mt-4">
                        <!-- Balance validation message -->
                    </div>
                </div>
            </div>
        </div>

        <!-- NIIF -->
        <div id="content-niif" class="content-section">
            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos</h3>
                    <div class="niif-explanation">
                        <p>
                            <strong>Objetivo:</strong> Establecer los principios que una entidad
                            aplicar치 al reportar informaci칩n sobre la naturaleza, importe,
                            momento y incertidumbre de los ingresos de actividades ordinarias
                            procedentes de contratos con clientes.
                        </p>
                        <p class="mt-2">
                            <strong>Aplicaci칩n en RAG:</strong> Los ingresos por intereses se
                            reconocen en funci칩n del tiempo transcurrido utilizando el m칠todo
                            del inter칠s efectivo. El margen por originaci칩n se distribuye
                            durante la vida del pr칠stamo (5 a침os) seg칰n NIIF 15.
                        </p>
                    </div>
                    <div id="niif15-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 9 - Instrumentos Financieros</h3>
                    <div class="niif-explanation">
                        <p>
                            <strong>Objetivo:</strong> Establecer los requisitos para el
                            reconocimiento y medici칩n de activos financieros,
                            pasivos financieros y algunos contratos de compra o venta de activos no
                            financieros.
                        </p>
                        <p class="mt-2">
                            <strong>Aplicaci칩n en RAG:</strong> Las cuentas por cobrar se
                            clasifican como activos financieros medidos al costo amortizado.
                            Se aplica un modelo de deterioro crediticio en tres etapas basado en el
                            riesgo de incumplimiento con criterios t칠cnicos espec칤ficos.
                        </p>
                    </div>
                    <div id="niif9-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos No Corrientes Mantenidos para la Venta</h3>
                    <div class="niif-explanation">
                        <p>
                            <strong>Objetivo:</strong> Especificar el tratamiento contable para
                            los activos no corrientes mantenidos para la venta,
                            y la presentaci칩n e informaci칩n a revelar sobre las operaciones
                            discontinuadas.
                        </p>
                        <p class="mt-2">
                            <strong>Aplicaci칩n en RAG:</strong> Las vagonetas repose칤das se
                            reclasifican como activos mantenidos para la venta.
                            Se miden al menor valor entre su valor en libros y su valor razonable
                            menos los costos de venta. La depreciaci칩n se suspende.
                        </p>
                    </div>
                    <div id="niif5-container" class="mt-4">
                        <!-- Content will be dynamically added -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr치ficos -->
        <div id="content-graficos" class="content-section">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evoluci칩n de EBITDA</h4>
                    <div style="height: 300px;"><canvas id="ebitdaChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Composici칩n de Ingresos (A침o 5)</h4>
                    <div style="height: 300px;"><canvas id="revenueMixChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Evoluci칩n del Patrimonio</h4>
                    <div style="height: 300px;"><canvas id="equityChart"></canvas></div>
                </div>
                <div class="card">
                    <h4 class="font-semibold text-lg mb-2">Deterioro Crediticio por Etapas (NIIF 9)</h4>
                    <div style="height: 300px;"><canvas id="provisionChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializaci칩n de la aplicaci칩n modularizada
        document.addEventListener('DOMContentLoaded', function() {
            // Crear instancia del modelo financiero
            window.financialModel = new FinancialModel();
            
            // Inicializar la aplicaci칩n
            financialModel.initialize();
        });
    </script>
</body>
</html>
