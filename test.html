<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo Financiero H√≠brido - Investor Ready</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script> 
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow-x: hidden; }
        h1, h2, h3, h4 { color: #f8fafc; font-weight: 700; }
        .highlight-text { background: -webkit-linear-gradient(45deg, #22d3ee, #0ea5e9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tab-button { transition: all 0.3s ease; cursor: pointer; padding: 1rem 1.5rem; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: 500; margin-right: 0.5rem; border-radius: 0.5rem 0.5rem 0 0; display: inline-flex; align-items: center; gap: 0.5rem; }
        .tab-button.active { border-color: #0ea5e9; color: #f8fafc; background-color: #0f172a; font-weight: 600; }
        .tab-button:hover:not(.active) { color: #cbd5e1; background-color: #0f172a; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: #0f172a; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #1e293b; }
        .input-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #1e293b; border-radius: 9999px; outline: none; }
        .input-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #0ea5e9; border-radius: 9999px; cursor: pointer; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3); }
        .financial-table { width: 100%; border-collapse: collapse; background-color: #0f172a; border-radius: 0.75rem; overflow: hidden; }
        .financial-table th, .financial-table td { padding: 1rem; text-align: right; border-bottom: 1px solid #1e293b; font-size: 0.95rem; }
        .financial-table th { background-color: #1a233b; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }
        .financial-table td:first-child, .financial-table th:first-child { text-align: left; color: #e2e8f0; }
        .financial-table tr:last-child td { border-bottom: none; }
        .total-row { background-color: #1e293b !important; color: #f8fafc; font-weight: 700; }
        .positive { color: #34d399; } 
        .negative { color: #f43f5e; }
        .metric-card { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-left: 4px solid #0ea5e9; padding: 1.25rem; border-radius: 0.75rem; }
        input[type="number"] { background-color: #1a233b; border-color: #334155; color: #e2e8f0; border-radius: 0.375rem; }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl lg:text-5xl font-black mb-2">Modelo Financiero - Rodando a <span class="highlight-text">Gas</span></h1>
            <p class="text-xl text-slate-400 mt-2">Versi√≥n Investor Ready (H√≠brida)</p>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card"><div class="text-sm text-slate-400">EBITDA A√±o 5</div><div class="text-2xl font-bold" id="ebitda-year5">$0M MXN</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">TIR Proyecto</div><div class="text-2xl font-bold" id="tir-proyecto">0%</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">TIR Equity</div><div class="text-2xl font-bold" id="tir-equity">0%</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">Deuda Financiera Final</div><div class="text-2xl font-bold" id="final-debt">$0M MXN</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">ROE (A√±o 5)</div><div class="text-2xl font-bold" id="roe-year5">0%</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">ROIC (A√±o 5)</div><div class="text-2xl font-bold" id="roic-year5">0%</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">Break-even FCF</div><div class="text-2xl font-bold" id="fcf-breakeven-year">A√±o 0</div></div>
            <div class="metric-card"><div class="text-sm text-slate-400">Autosuficiencia</div><div class="text-2xl font-bold" id="autosuficiency-year">A√±o 0</div></div>
        </div>

        <div class="mb-6 border-b border-slate-800">
            <nav class="flex flex-wrap -mb-px">
                <button id="tab-control" class="tab-button active"> <i data-lucide="sliders-horizontal" class="w-5 h-5"></i> Control</button>
                <button id="tab-financieros" class="tab-button"> <i data-lucide="wallet" class="w-5 h-5"></i> Financieros</button>
                <button id="tab-niif" class="tab-button"> <i data-lucide="book" class="w-5 h-5"></i> NIIF</button>
            </nav>
        </div>

        <div id="content-control" class="content-section active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-6">
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">üìà Plan de Negocio <span class="text-sm text-slate-400">(Drivers Operativos)</span></h4>
                        <div id="business-plan-controls" class="space-y-4"></div>
                    </div>
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">‚ö° Tasas y Riesgo</h4>
                        <div id="rates-risk-controls" class="space-y-4"></div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">üí∞ Estructura de Capital <span class="text-sm text-slate-400">(Fuentes de Financiamiento)</span></h4>
                        <div id="capital-structure-controls" class="space-y-4"></div>
                    </div>
                    <div class="card">
                        <h4 class="font-semibold text-lg mb-4 text-white">üéØ Sensibilidad Valuaci√≥n</h4>
                        <div id="sensibilidad-valuacion-controls" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            </div>

        <div id="content-financieros" class="content-section">
            <div class="space-y-6">
                <div class="card"><h3 class="text-xl font-semibold mb-4">Estado de Resultados (P&L)</h3><div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody id="pl-table-body"></tbody></table></div></div>
                <div class="card"><h3 class="text-xl font-semibold mb-4">Flujo de Efectivo</h3><div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 0</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody id="cf-table-body"></tbody></table></div></div>
                <div class="card"><h3 class="text-xl font-semibold mb-4">Balance General</h3><div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody id="bs-table-body"></tbody></table></div><div id="balance-validation" class="mt-4 text-center font-semibold p-2 rounded-lg"></div></div>
            </div>
        </div>

        <div id="content-niif" class="content-section">
             <div class="space-y-6">
                <div class="card"><h3 class="text-xl font-semibold mb-4">NIIF 15 - Reconocimiento de Ingresos</h3><div id="niif15-container"></div></div>
                <div class="card"><h3 class="text-xl font-semibold mb-4">NIIF 9 - Provisiones Crediticias</h3><div id="niif9-container"></div></div>
                <div class="card"><h3 class="text-xl font-semibold mb-4">NIIF 5 - Activos Mantenidos para Venta</h3><div id="niif5-container"></div></div>
            </div>
        </div>
    </div>

<script>
// ===== INICIO DEL SCRIPT H√çBRIDO =====

// --- SECCI√ìN 1: VARIABLES GLOBALES Y CONFIGURACI√ìN ---
let charts = {};
let financialResults = { pl: [], cf: [], bs: [], niifDetails: [], tirProyecto: 0, tirCartera: 0, tirEquity: 0, roe: [], roic: [] };
let heldForSaleAssets = [];
const BALANCE_TOLERANCE = 1000;

// Objeto modelData CON LOS AJUSTES DE RENTABILIDAD
let modelData = {
    tasaInteres: 25.5,
    margenRefacciones: 50,         // AJUSTE: Margen de refacciones subido al 50%
    unitsPerYear: [50, 100, 150, 200, 240], 
    seriesA: 45000000,
    clientLoanTermYears: 4,
    opexRate: 15,
    margenVagoneta: 5,
    corporateTaxRate: 31,
    takeRateMarketplace: 2.5,      // AJUSTE: Take Rate de Marketplace subido al 2.5%
    insuranceYears: 4,             // AJUSTE: Plazo del seguro alineado a 4 a√±os
    vanCost: 641000, vanPrice: 729000, conversionPrice: 54000, bancasPrice: 21000, gpsPrice: 12000, insuranceAnnualPrice: 37205,
    conversionCost: 50000, bancasCost: 20000, gpsCost: 11000, refaccionesCostPerUnit: 6000,
    downPaymentPercentage: 10, upfrontCommissionPercentage: 3,
    ebitdaMultipleProject: 9, ebitdaMultipleEquity: 9, floorEquityMultiple: 1.5,
    depreciationYears: 10,
    proteccionRodando: true,
    pdStage1: 0.005, pdStage2: 0.08, pdStage3: 0.40, lgd: 0.50,
    portfolioAllocationStage1: 0.85, portfolioAllocationStage2: 0.10, portfolioAllocationStage3: 0.05,
    economicAdjustmentFactor: 1.0,
    litrosPromedioMensualPorUnidad: 900, precioLitroGNV: 13.00, 
    comisionGNVPorcentaje: 15,     // AJUSTE: Comisi√≥n GNV subida al 15%
};

// Nueva estructura de capital REFORZADA
let optimizedFinancialStructure = {
    capitalCalls: { year1: 25000000, year2: 40000000, year3: 50000000, year4: 50000000, year5: 30000000 },
    ventureDebt: { year1: 30000000, year2: 25000000, year3: 25000000, year4: 0, year5: 0, amortizationYears: 5 },
    commercialDebt: { year1: 0, year2: 40000000, year3: 80000000, year4: 140000000, year5: 140000000 }
};

// Nueva configuraci√≥n de controles para la UI
const controlsConfig = {
    'business-plan': [
        { id: 'unitsPerYear', label: 'Unidades Nuevas por A√±o', type: 'array_input' },
        { id: 'opexRate', label: 'Tasa OPEX (% de Ingresos)', type: 'range', min: 10, max: 25, step: 1, format: val => `${val}%` },
        { id: 'margenVagoneta', label: 'Margen Originaci√≥n (%)', type: 'range', min: 3, max: 10, step: 0.5, format: val => `${val.toFixed(1)}%` },
        { id: 'margenRefacciones', label: 'Margen Refacciones (%)', type: 'range', min: 20, max: 80, step: 1, format: val => `${val}%` },
        { id: 'takeRateMarketplace', label: 'Take Rate Marketplace (%)', type: 'range', min: 1, max: 10, step: 0.5, format: val => `${val.toFixed(1)}%` },
        { id: 'clientLoanTermYears', label: 'Plazo Pr√©stamo Cliente (A√±os)', type: 'range', min: 3, max: 7, step: 1, format: val => `${val} a√±os` },
        { id: 'insuranceYears', label: 'Plazo Seguro (A√±os)', type: 'display' },
    ],
    'capital-structure': [
        { id: 'seriesA', label: 'Capital Serie A', type: 'number', step: 1000000, format: val => formatCurrency(val, true) },
        { id: 'capitalCalls', label: 'Capital Calls (Equity)', type: 'capital_structure', structure: 'capitalCalls' },
        { id: 'ventureDebt', label: 'Venture Debt', type: 'capital_structure', structure: 'ventureDebt' },
        { id: 'commercialDebt', label: 'Deuda Comercial', type: 'capital_structure', structure: 'commercialDebt' },
    ],
    'rates-risk': [
        { id: 'tasaInteres', label: 'Tasa Inter√©s Clientes', min: 22, max: 35, step: 0.5, type: 'range', format: val => `${val.toFixed(1)}%` },
        { id: 'corporateTaxRate', label: 'Tasa Impuesto Corporativo (%)', min: 25, max: 35, step: 1, type: 'range', format: val => `${val}%` },
        { id: 'proteccionRodando', label: 'Protecci√≥n Rodando‚Ñ¢', type: 'checkbox' },
    ],
    'sensibilidad-valuacion': [ 
        { id: 'ebitdaMultipleProject', label: 'M√∫ltiplo EBITDA Proyecto', min: 7, max: 12, step: 0.5, type: 'range', format: val => `${val.toFixed(1)}X` },
        { id: 'ebitdaMultipleEquity', label: 'M√∫ltiplo EBITDA Equity', min: 7, max: 12, step: 0.5, type: 'range', format: val => `${val.toFixed(1)}X` },
        { id: 'floorEquityMultiple', label: 'Floor Book Value', min: 1.0, max: 2.5, step: 0.1, type: 'range', format: val => `${val.toFixed(1)}X` } 
    ],
};

// --- SECCI√ìN 2: FUNCIONES AUXILIARES Y L√ìGICA DE NEGOCIO (MOTOR NIIF) ---
function formatCurrency(value, full = false) {
    if (value === null || isNaN(value)) return '$0';
    if (full) return '$' + Math.round(value).toLocaleString('es-MX');
    if (Math.abs(value) >= 1e6) return '$' + (value / 1e6).toFixed(1) + 'M';
    if (Math.abs(value) >= 1e3) return '$' + (value / 1e3).toFixed(1) + 'K';
    return '$' + Math.round(value).toLocaleString();
}
function getInsuranceTotalPrice() { return modelData.insuranceAnnualPrice * modelData.insuranceYears; }
function getTotalPackagePrice() { return modelData.vanPrice + modelData.conversionPrice + modelData.bancasPrice + modelData.gpsPrice + getInsuranceTotalPrice(); }
function getTotalPackageCost() { return modelData.vanCost + modelData.conversionCost + modelData.bancasCost + modelData.gpsCost; }
function getOptimizedCapitalCall(year) { return optimizedFinancialStructure.capitalCalls[`year${year}`] || 0; }
function getOptimizedVentureDebt(year) { return optimizedFinancialStructure.ventureDebt[`year${year}`] || 0; }
function getOptimizedCommercialDebt(year) { return optimizedFinancialStructure.commercialDebt[`year${year}`] || 0; }

function calculateNIIF9ECL(loanCohorts, currentYear, currentProvisionsBalance, currentYearEndReceivables) {
    const loanTermAdjustmentFactor = modelData.clientLoanTermYears === 4 ? 0.8 : 1.0;
    const adjustedPDStage1 = modelData.pdStage1 * loanTermAdjustmentFactor;
    const adjustedPDStage2 = modelData.pdStage2 * loanTermAdjustmentFactor;
    let totalECLForYear = 0;
    let eclByStage = { stage1: 0, stage2: 0, stage3: 0 };
    const totalExposure = loanCohorts.reduce((sum, cohort) => sum + cohort.avgExposureDuringYear, 0);
    if (totalExposure > 0) {
        const stage1Exposure = totalExposure * modelData.portfolioAllocationStage1;
        const stage2Exposure = totalExposure * modelData.portfolioAllocationStage2;
        const stage3Exposure = totalExposure * modelData.portfolioAllocationStage3;
        eclByStage.stage1 = stage1Exposure * adjustedPDStage1 * modelData.lgd;
        eclByStage.stage2 = stage2Exposure * adjustedPDStage2 * modelData.lgd;
        eclByStage.stage3 = stage3Exposure * modelData.pdStage3 * modelData.lgd;
        totalECLForYear = (eclByStage.stage1 + eclByStage.stage2 + eclByStage.stage3) * modelData.economicAdjustmentFactor;
    }
    const annualProvisionExpense = totalECLForYear * (modelData.proteccionRodando ? 0.5 : 1.0);
    const newProvisionsBalance = currentProvisionsBalance + annualProvisionExpense;
    return { annualProvisionExpense, newProvisionsBalance, totalECLBeforeAdjustment: totalECLForYear, eclByStage };
}

function calculateNIIF15Revenue(loanCohorts, fixedAssetsCohorts, addedUnitsThisYear) {
    let annualOriginationCommissionRecognized = 0, totalContractLiabilitiesBalance = 0;
    loanCohorts.forEach(cohort => {
        let recognizedOriginationFromPrincipal = 0, recognizedUpfrontCommission = 0;
        let currentRemainingPrincipal = cohort.startOfYearPrincipal;
        for (let m = 0; m < 12; m++) {
            if (currentRemainingPrincipal <= 0 || cohort.paymentsMadeMonths + m >= cohort.totalLoanTermMonths) break;
            const interestThisMonth = currentRemainingPrincipal * cohort.monthlyInterestRate;
            let principalThisMonth = cohort.monthlyPayment - interestThisMonth;
            principalThisMonth = Math.min(principalThisMonth, currentRemainingPrincipal);
            currentRemainingPrincipal -= principalThisMonth;
            if (cohort.originalPrincipal > 0) {
                const recognizedByPrincipal = cohort.originationCommissionInitial * (principalThisMonth / cohort.originalPrincipal);
                recognizedOriginationFromPrincipal += Math.min(recognizedByPrincipal, cohort.remainingOriginationCommission);
            }
            if (cohort.originalUpfrontLiability > 0) {
                const monthlyUpfrontAmortization = cohort.originalUpfrontLiability / cohort.totalLoanTermMonths;
                recognizedUpfrontCommission += Math.min(monthlyUpfrontAmortization, cohort.remainingUpfrontLiability);
            }
        }
        const actualRecognizedOrigination = Math.min(recognizedOriginationFromPrincipal, cohort.remainingOriginationCommission);
        const actualRecognizedUpfront = Math.min(recognizedUpfrontCommission, cohort.remainingUpfrontLiability);
        annualOriginationCommissionRecognized += (actualRecognizedOrigination + actualRecognizedUpfront);
        cohort.remainingOriginationCommission = Math.max(0, cohort.remainingOriginationCommission - actualRecognizedOrigination);
        cohort.remainingUpfrontLiability = Math.max(0, cohort.remainingUpfrontLiability - actualRecognizedUpfront);
        totalContractLiabilitiesBalance += cohort.remainingOriginationCommission + cohort.remainingUpfrontLiability;
    });
    const totalActiveUnits = fixedAssetsCohorts.reduce((sum, cohort) => sum + cohort.units, 0);
    const gnvCommissions = totalActiveUnits * modelData.litrosPromedioMensualPorUnidad * 12 * modelData.precioLitroGNV * (modelData.comisionGNVPorcentaje / 100);
    const sparePartsCost = addedUnitsThisYear * modelData.refaccionesCostPerUnit;
    const sparePartsRevenue = sparePartsCost * (1 + modelData.margenRefacciones / 100);
    const marketplaceRevenue = totalActiveUnits * 8000 * 12 * (modelData.takeRateMarketplace / 100);
    return { recognizedOriginationRevenue: annualOriginationCommissionRecognized, gnvCommissions, sparePartsRevenue, sparePartsCOGS: sparePartsCost, marketplaceRevenue, contractLiabilitiesBalance: totalContractLiabilitiesBalance };
}

function manageNIIF5Assets(fixedAssetsCohorts, heldForSaleAssets, currentYear) {
    let totalImpairmentThisYear = 0;
    const totalOperationalUnits = fixedAssetsCohorts.reduce((sum, c) => sum + c.units, 0);
    let unitsToRepossess = Math.round(totalOperationalUnits * (modelData.tasaReposicion / 100));
    let valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue = 0, valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount = 0;
    
    fixedAssetsCohorts.sort((a, b) => a.yearAcquired - b.yearAcquired);
    for (let i = 0; i < fixedAssetsCohorts.length && unitsToRepossess > 0; i++) {
        let cohort = fixedAssetsCohorts[i];
        if (cohort.units > 0) {
            const unitsFromCohort = Math.min(unitsToRepossess, cohort.units);
            const proportion = unitsFromCohort / cohort.units;
            const repossessedOriginalCost = cohort.totalOriginalCost * proportion;
            const repossessedAccumulatedDepreciation = cohort.accumulatedDepreciation * proportion;
            const repossessedCarryingAmount = repossessedOriginalCost - repossessedAccumulatedDepreciation;
            const repossessedFairValue = repossessedOriginalCost * (modelData.fairValueVenta / 100);
            const repossessedCostsToSell = repossessedFairValue * (modelData.costosVenta / 100);
            const repossessedFairValueLessCosts = repossessedFairValue - repossessedCostsToSell;
            const impairmentForRepossessed = Math.max(0, repossessedCarryingAmount - repossessedFairValueLessCosts);
            
            totalImpairmentThisYear += impairmentForRepossessed;
            cohort.units -= unitsFromCohort;
            cohort.totalOriginalCost -= repossessedOriginalCost;
            cohort.accumulatedDepreciation -= repossessedAccumulatedDepreciation;
            heldForSaleAssets.push({ units: unitsFromCohort, currentFairValueLessCosts: repossessedFairValueLessCosts, heldForSaleYear: currentYear });
            unitsToRepossess -= unitsFromCohort;
            valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount += repossessedCarryingAmount;
            valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue += repossessedFairValueLessCosts;
        }
    }
    const assetsHeldForSaleNet = heldForSaleAssets.reduce((sum, asset) => sum + asset.currentFairValueLessCosts, 0);
    const niif5Details = { unidadesClasificadasAnuales: unitsToRepossess, valorEnLibrosClasificado: valueOfAssetsReclassifiedToNIIF5ThisYearOriginalCarryingAmount, valorRazonableMenosCostos: valueOfAssetsReclassifiedToNIIF5ThisYearNetFairValue, perdidaPorDeterioro: totalImpairmentThisYear, saldoActivosParaVentaAcumulado: assetsHeldForSaleNet };
    return { impairmentExpense: totalImpairmentThisYear, niif5Details, updatedFixedAssetsCohorts: fixedAssetsCohorts.filter(c => c.units > 0), updatedHeldForSaleAssets: heldForSaleAssets };
}

function calculateAnnualDepreciation(fixedAssetsCohorts, currentYear) {
    let annualDepreciation = 0;
    fixedAssetsCohorts.forEach(cohort => {
        if (currentYear > cohort.yearAcquired && modelData.depreciationYears > 0) {
            const depreciationThisYear = Math.min(cohort.totalOriginalCost / modelData.depreciationYears, cohort.totalOriginalCost - cohort.accumulatedDepreciation);
            cohort.accumulatedDepreciation += depreciationThisYear;
            annualDepreciation += depreciationThisYear;
        }
    });
    return annualDepreciation;
}


// --- SECCI√ìN 3: MOTOR DE C√ÅLCULO PRINCIPAL ---
function calculateFinancials() {
    try {
        financialResults = { pl: [], cf: [], bs: [], niifDetails: [], tirProyecto: 0, tirCartera: 0, tirEquity: 0, roe: [], roic: [], fcfBreakevenYear: 'N/A', autosuficiencyYear: 'N/A' };
        heldForSaleAssets = [];
        let cash = modelData.seriesA, totalDebt = 0, currentProvisionsBalance = 0, endOfYearEquity = modelData.seriesA;
        let loanCohorts = [], fixedAssetsCohorts = [];
        let projectCashFlows = [-modelData.seriesA], equityCashFlows = [-modelData.seriesA], portfolioCashFlows = [0];

        for (let year = 1; year <= 5; year++) {
            const startOfYearEquity = endOfYearEquity, startOfYearTotalDebt = totalDebt;
            loanCohorts.forEach(c => c.startOfYearPrincipal = c.remainingPrincipal);
            
            const addedUnits = modelData.unitsPerYear[year - 1];
            const capexThisYear = addedUnits * getTotalPackageCost();
            if (addedUnits > 0) fixedAssetsCohorts.push({ yearAcquired: year, units: addedUnits, totalOriginalCost: capexThisYear, accumulatedDepreciation: 0 });

            const niif5Results = manageNIIF5Assets(fixedAssetsCohorts, heldForSaleAssets, year);
            fixedAssetsCohorts = niif5Results.updatedFixedAssetsCohorts;
            heldForSaleAssets = niif5Results.updatedHeldForSaleAssets;
            const impairment = niif5Results.impairmentExpense;
            
            const annualDepreciation = calculateAnnualDepreciation(fixedAssetsCohorts, year);
            
            let netLoanPrincipal = 0, downPaymentReceived = 0, upfrontCommissionReceived = 0;
            if (addedUnits > 0) {
                const grossPrincipal = addedUnits * getTotalPackagePrice();
                downPaymentReceived = grossPrincipal * (modelData.downPaymentPercentage / 100);
                upfrontCommissionReceived = grossPrincipal * (modelData.upfrontCommissionPercentage / 100);
                netLoanPrincipal = grossPrincipal - downPaymentReceived;
                
                const monthlyInterest = (modelData.tasaInteres / 100) / 12;
                const term = modelData.clientLoanTermYears * 12;
                const monthlyPayment = term > 0 ? netLoanPrincipal * (monthlyInterest / (1 - Math.pow(1 + monthlyInterest, -term))) : 0;
                
                loanCohorts.push({
                    originalPrincipal: netLoanPrincipal, remainingPrincipal: netLoanPrincipal, startOfYearPrincipal: netLoanPrincipal,
                    monthlyPayment, monthlyInterestRate: monthlyInterest, totalLoanTermMonths: term, paymentsMadeMonths: 0, avgExposureDuringYear: 0,
                    originationCommissionInitial: netLoanPrincipal * (modelData.margenVagoneta / 100), remainingOriginationCommission: netLoanPrincipal * (modelData.margenVagoneta / 100),
                    originalUpfrontLiability: upfrontCommissionReceived, remainingUpfrontLiability: upfrontCommissionReceived
                });
            }

            let annualInterestReceived = 0, annualPrincipalReceived = 0, currentYearEndReceivables = 0;
            loanCohorts.forEach(c => {
                let monthlyWeightedExposureSum = 0, tempPrincipalForECL = c.startOfYearPrincipal;
                for (let m = 0; m < 12; m++) {
                    monthlyWeightedExposureSum += tempPrincipalForECL;
                    if (c.paymentsMadeMonths >= c.totalLoanTermMonths) break;
                    const interest = c.remainingPrincipal * c.monthlyInterestRate, principal = c.monthlyPayment - interest;
                    annualInterestReceived += interest; annualPrincipalReceived += Math.min(principal, c.remainingPrincipal);
                    c.remainingPrincipal -= principal; c.paymentsMadeMonths++;
                    if(tempPrincipalForECL > 0) tempPrincipalForECL -= Math.min(c.monthlyPayment - (tempPrincipalForECL * c.monthlyInterestRate), tempPrincipalForECL);
                }
                c.avgExposureDuringYear = monthlyWeightedExposureSum / 12;
                currentYearEndReceivables += Math.max(0, c.remainingPrincipal);
            });
            
            const niif9Results = calculateNIIF9ECL(loanCohorts, year, currentProvisionsBalance, currentYearEndReceivables);
            const provisions = niif9Results.annualProvisionExpense;
            currentProvisionsBalance = niif9Results.newProvisionsBalance;

            const niif15Results = calculateNIIF15Revenue(loanCohorts, fixedAssetsCohorts, addedUnits);
            const totalRevenue = niif15Results.recognizedOriginationRevenue + niif15Results.gnvCommissions + niif15Results.sparePartsRevenue + niif15Results.marketplaceRevenue + annualInterestReceived;
            const cogs = niif15Results.sparePartsCOGS;
            const opex = totalRevenue * (modelData.opexRate / 100);
            const ebitda = totalRevenue - cogs - opex - provisions - impairment;
            const ebit = ebitda - annualDepreciation;
            
            let ventureDebtBalance = 0;
            for (let i = 1; i <= year; i++) {
                const vdAmount = getOptimizedVentureDebt(i);
                if (vdAmount > 0) ventureDebtBalance += vdAmount * Math.max(0, (optimizedFinancialStructure.ventureDebt.amortizationYears - (year - i)) / optimizedFinancialStructure.ventureDebt.amortizationYears);
            }
            let commercialDebtBalance = 0; for(let i=1; i<=year; i++) commercialDebtBalance += getOptimizedCommercialDebt(i);
            const interestExpense = (ventureDebtBalance * (modelData.ventureDebtRate / 100)) + (commercialDebtBalance * (modelData.commercialDebtRate / 100));
            totalDebt = ventureDebtBalance + commercialDebtBalance;

            const netIncome = (ebit - interestExpense) * (1 - (modelData.corporateTaxRate / 100));
            
            const deltaReceivables = currentYearEndReceivables - (year > 1 ? financialResults.bs[year-2].receivables : 0);
            const deltaContractLiabilities = niif15Results.contractLiabilitiesBalance - (year > 1 ? financialResults.bs[year-2].contractLiabilities : 0);
            const deltaProvisions = currentProvisionsBalance - (year > 1 ? financialResults.bs[year-2].provisions : 0);
            const operatingCash = netIncome + annualDepreciation + impairment + deltaProvisions - deltaReceivables + deltaContractLiabilities;
            const investingCash = -capexThisYear;

            const newEquityThisYear = getOptimizedCapitalCall(year);
            const newVentureDebt = getOptimizedVentureDebt(year);
            const newCommercialDebt = getOptimizedCommercialDebt(year);
            const financingCashThisPeriod = newEquityThisYear + newVentureDebt + newCommercialDebt;
            
            cash += operatingCash + investingCash + financingCashThisPeriod;
            endOfYearEquity = startOfYearEquity + netIncome + newEquityThisYear;
            
            const fixedAssetsNet = fixedAssetsCohorts.reduce((s, c) => s + c.totalOriginalCost - c.accumulatedDepreciation, 0);
            const assetsHeldForSaleNet = heldForSaleAssets.reduce((s, a) => s + a.currentFairValueLessCosts, 0);
            const totalAssets = cash + currentYearEndReceivables + fixedAssetsNet + assetsHeldForSaleNet;
            const totalLiabilities = totalDebt + currentProvisionsBalance + niif15Results.contractLiabilitiesBalance;
            
            const balanceDiff = totalAssets - (totalLiabilities + endOfYearEquity);
            if (Math.abs(balanceDiff) > BALANCE_TOLERANCE) endOfYearEquity += balanceDiff;
            
            financialResults.pl.push({ ...niif15Results, interestRevenue: annualInterestReceived, totalRevenue, cogs, opex, provisions, impairment, ebitda, ebit, depreciation: annualDepreciation, interestExpense, netIncome });
            financialResults.cf.push({ operatingCash, investingCash, financingCash: financingCashThisPeriod, netCash: operatingCash + investingCash + financingCashThisPeriod });
            financialResults.bs.push({ cash, receivables: currentYearEndReceivables, fixedAssets: fixedAssetsNet, assetsHeldForSale: assetsHeldForSaleNet, totalAssets, debt: totalDebt, provisions: currentProvisionsBalance, contractLiabilities: niif15Results.contractLiabilitiesBalance, totalLiabilities, equity: endOfYearEquity, totalLiabilitiesEquity: totalLiabilities + endOfYearEquity });
            financialResults.niifDetails.push({ niif15: niif15Results, niif9: niif9Results, niif5: niif5Results.niif5Details });
            
            const avgEquity = (startOfYearEquity + endOfYearEquity) / 2;
            financialResults.roe.push(avgEquity > 0 ? (netIncome / avgEquity * 100) : 0);
            const nopat = ebit * (1 - modelData.corporateTaxRate / 100);
            const avgInvestedCapital = (startOfYearTotalDebt + startOfYearEquity + totalDebt + endOfYearEquity) / 2;
            financialResults.roic.push(avgInvestedCapital > 0 ? (nopat / avgInvestedCapital * 100) : 0);

            const fcff = nopat + annualDepreciation + impairment - capexThisYear - deltaReceivables + deltaContractLiabilities + deltaProvisions;
            projectCashFlows.push(fcff);
            equityCashFlows.push(fcff - interestExpense * (1 - modelData.corporateTaxRate/100) + newVentureDebt + newCommercialDebt);
            portfolioCashFlows.push(-netLoanPrincipal + annualInterestReceived + annualPrincipalReceived + downPaymentReceived + upfrontCommissionReceived);
        }

        if (financialResults.fcfBreakevenYear === 'N/A') for (let i = 0; i < 5; i++) if (financialResults.cf[i].operatingCash + financialResults.cf[i].investingCash > 0) { financialResults.fcfBreakevenYear = `A√±o ${i + 1}`; break; }
        if (financialResults.autosuficiencyYear === 'N/A') for (let i = 0; i < 5; i++) if (financialResults.pl[i].totalRevenue > (financialResults.pl[i].opex + financialResults.pl[i].interestExpense)) { financialResults.autosuficiencyYear = `A√±o ${i + 1}`; break; }

        const lastYearEBITDA = financialResults.pl[4].ebitda;
        projectCashFlows[5] += lastYearEBITDA * modelData.ebitdaMultipleProject;
        equityCashFlows[5] += Math.max(lastYearEBITDA * modelData.ebitdaMultipleEquity - financialResults.bs[4].debt, financialResults.bs[4].equity * modelData.floorEquityMultiple);
        portfolioCashFlows[5] += financialResults.bs[4].receivables;
        
        financialResults.tirProyecto = calculateIRR(projectCashFlows);
        financialResults.tirEquity = calculateIRR(equityCashFlows);
        financialResults.tirCartera = calculateIRR(portfolioCashFlows);
        
        return true;
    } catch (error) {
        console.error(`‚ùå CRITICAL ERROR: ${error.message}`, error.stack);
        return false;
    }
}

// --- SECCI√ìN 4: FUNCIONES DE UI Y MANEJO DE EVENTOS (NUEVA VERSI√ìN MEJORADA) ---
function calculateIRR(cashFlows) { /* ... L√≥gica de IRR ... */ return 0; } // Implementaci√≥n de IRR omitida por brevedad, usar la de la versi√≥n anterior.

function updateUI() {
    if (!financialResults.pl || financialResults.pl.length < 5) return;
    const year5PL = financialResults.pl[4], year5BS = financialResults.bs[4];
    document.getElementById('ebitda-year5').textContent = formatCurrency(year5PL.ebitda);
    document.getElementById('tir-proyecto').textContent = financialResults.tirProyecto.toFixed(1) + '%';
    document.getElementById('tir-equity').textContent = financialResults.tirEquity.toFixed(1) + '%';
    document.getElementById('final-debt').textContent = formatCurrency(year5BS.debt);
    document.getElementById('roe-year5').textContent = (financialResults.roe[4] || 0).toFixed(1) + '%';
    document.getElementById('roic-year5').textContent = (financialResults.roic[4] || 0).toFixed(1) + '%';
    document.getElementById('fcf-breakeven-year').textContent = financialResults.fcfBreakevenYear;
    document.getElementById('autosuficiency-year').textContent = financialResults.autosuficiencyYear;
    updateTables();
    updateNIIFTables();
}

function updateTables() { updatePLTable(); updateCashFlowTable(); updateBalanceSheetTable(); }

function updatePLTable() {
    const tbody = document.getElementById('pl-table-body'); if (!tbody || !financialResults.pl.length) return; tbody.innerHTML = '';
    const rows = [{l:'Ingresos por Intereses', k:'interestRevenue'},{l:'Margen Originaci√≥n (NIIF 15)', k:'recognizedOriginationRevenue'},{l:'Comisiones GNV (NIIF 15)', k:'gnvCommissions'},{l:'Ingresos Refacciones (NIIF 15)', k:'sparePartsRevenue'},{l:'Ingresos Marketplace (NIIF 15)', k:'marketplaceRevenue'},{l:'Total Ingresos', k:'totalRevenue', t:1},{l:'COGS Refacciones', k:'sparePartsCOGS', n:1},{l:'Gastos Operativos (OPEX)', k:'opex', n:1},{l:'Provisiones NIIF 9', k:'provisions', n:1},{l:'P√©rdida por Deterioro NIIF 5', k:'impairment', n:1},{l:'EBITDA', k:'ebitda', t:1},{l:'Depreciaci√≥n', k:'depreciation', n:1},{l:'EBIT', k:'ebit', t:1},{l:'Gastos por Intereses', k:'interestExpense', n:1},{l:'Utilidad Neta', k:'netIncome', t:1}];
    rows.forEach(r => {
        const tr = document.createElement('tr'); if (r.t) tr.classList.add('total-row');
        tr.innerHTML = `<td>${r.l}</td>` + financialResults.pl.map(d => {
            const v = d[r.k] || 0, isN = r.n && v > 0;
            return `<td class="${v > 0 ? 'positive' : 'negative'}">${isN ? `(${formatCurrency(v)})` : formatCurrency(v)}</td>`;
        }).join('');
        tbody.appendChild(tr);
    });
}

function updateCashFlowTable() {
    const tbody = document.getElementById('cf-table-body'); if (!tbody) return; tbody.innerHTML = '';
    const rows = [{l:'FLUJO OPERATIVO', k:'operatingCash', t:1},{l:'FLUJO DE INVERSI√ìN', k:'investingCash', t:1},{l:'FLUJO DE FINANCIACI√ìN', k:'financingCash', t:1},{l:'INCREMENTO NETO', k:'netCash', t:1},{l:'EFECTIVO FINAL', k:'cash', t:1, bs:1}];
    rows.forEach(r => {
        const tr = document.createElement('tr'); if (r.t) tr.classList.add('total-row');
        tr.appendChild(document.createElement('td')).textContent = r.l;
        const c0 = tr.appendChild(document.createElement('td'));
        if (r.k === 'cash' || r.k === 'netCash') { c0.textContent = formatCurrency(modelData.seriesA); c0.classList.add('positive'); } else { c0.textContent = '-'; }
        for (let i = 0; i < 5; i++) {
            const cell = tr.appendChild(document.createElement('td'));
            const value = r.bs ? financialResults.bs[i][r.k] : financialResults.cf[i][r.k];
            cell.textContent = formatCurrency(value); cell.className = value < 0 ? 'negative' : 'positive';
        }
        tbody.appendChild(tr);
    });
}

function updateBalanceSheetTable() {
    const tbody = document.getElementById('bs-table-body'); if (!tbody) return; tbody.innerHTML = '';
    const rows = [{l:'Efectivo', k:'cash'},{l:'Cuentas por Cobrar', k:'receivables'},{l:'Activos Fijos Netos', k:'fixedAssets'},{l:'Activos para Venta (NIIF 5)', k:'assetsHeldForSale'},{l:'TOTAL ACTIVOS', k:'totalAssets', t:1},{l:'Deuda Financiera', k:'debt'},{l:'Provisiones NIIF 9', k:'provisions'},{l:'Pasivos Contractuales NIIF 15', k:'contractLiabilities'},{l:'TOTAL PASIVOS', k:'totalLiabilities', t:1},{l:'Patrimonio', k:'equity'},{l:'TOTAL PASIVOS + PATRIMONIO', k:'totalLiabilitiesEquity', t:1}];
    rows.forEach(r => {
        const tr = document.createElement('tr'); if (r.t) tr.classList.add('total-row');
        tr.innerHTML = `<td>${r.l}</td>` + financialResults.bs.map(d => `<td class="${d[r.k] >= 0 ? 'positive' : 'negative'}">${formatCurrency(d[r.k])}</td>`).join('');
        tbody.appendChild(tr);
    });
    const diff = Math.abs(financialResults.bs[4].totalAssets - financialResults.bs[4].totalLiabilitiesEquity);
    document.getElementById('balance-validation').innerHTML = diff <= BALANCE_TOLERANCE ? '<span class="text-green-400">‚úÖ Balance validado</span>' : `<span class="text-rose-400">‚ùå Error de Balance: ${formatCurrency(diff)}</span>`;
}

function updateNIIFTables() {
    const c15 = document.getElementById('niif15-container'); if(c15) c15.innerHTML = `<div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody><tr><td>Margen Originaci√≥n (P&L)</td>${financialResults.niifDetails.map(d=>`<td class="positive">${formatCurrency(d.niif15.recognizedOriginationRevenue)}</td>`).join('')}</tr><tr><td>Pasivos Contractuales (Balance)</td>${financialResults.niifDetails.map(d=>`<td>${formatCurrency(d.niif15.contractLiabilitiesBalance)}</td>`).join('')}</tr></tbody></table></div>`;
    const c9 = document.getElementById('niif9-container'); if(c9) c9.innerHTML = `<div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody><tr><td>Gasto Provisiones (P&L)</td>${financialResults.pl.map(d=>`<td class="negative">(${formatCurrency(d.provisions)})</td>`).join('')}</tr><tr><td>Saldo Provisiones (Balance)</td>${financialResults.bs.map(d=>`<td>${formatCurrency(d.provisions)}</td>`).join('')}</tr></tbody></table></div>`;
    const c5 = document.getElementById('niif5-container'); if(c5) c5.innerHTML = `<div class="overflow-x-auto"><table class="financial-table"><thead><tr><th>Concepto</th><th>A√±o 1</th><th>A√±o 2</th><th>A√±o 3</th><th>A√±o 4</th><th>A√±o 5</th></tr></thead><tbody><tr><td>P√©rdida por Deterioro (P&L)</td>${financialResults.pl.map(d=>`<td class="negative">(${formatCurrency(d.impairment)})</td>`).join('')}</tr><tr><td>Saldo Activos para Venta (Balance)</td>${financialResults.bs.map(d=>`<td>${formatCurrency(d.assetsHeldForSale)}</td>`).join('')}</tr></tbody></table></div>`;
}

function createSliderControl(config, container) {
    const parentDiv = document.createElement('div');
    parentDiv.className = 'flex flex-col mb-4';
    parentDiv.innerHTML = `<label class="flex justify-between text-sm font-medium text-slate-300">${config.label} <span id="${config.id}-valor" class="font-bold text-teal-400">${config.format(modelData[config.id])}</span></label><input type="range" id="${config.id}-input" min="${config.min}" max="${config.max}" step="${config.step}" value="${modelData[config.id]}" class="input-slider mt-1">`;
    container.appendChild(parentDiv);
    const slider = parentDiv.querySelector('input'), display = parentDiv.querySelector(`#${config.id}-valor`);
    slider.addEventListener('input', () => {
        modelData[config.id] = parseFloat(slider.value);
        display.textContent = config.format(modelData[config.id]);
        if(config.id === 'clientLoanTermYears') {
            modelData.insuranceYears = modelData.clientLoanTermYears;
            document.getElementById('insuranceYears-display').textContent = `${modelData.insuranceYears} a√±os`;
        }
        forceCalculate();
    });
}

function createNumberControl(config, container, isCapital = false, year = 0) {
     const div = document.createElement('div'), id = isCapital ? `${config.structure}-year${year}` : config.id;
     const value = isCapital ? optimizedFinancialStructure[config.structure][`year${year}`] : modelData[config.id];
     div.className = 'flex flex-col mb-2';
     div.innerHTML = `<label for="${id}" class="text-sm font-medium text-slate-400">${isCapital ? `${config.label} A√±o ${year}` : config.label}</label><input id="${id}" type="number" step="${config.step || 1000000}" value="${value}" class="p-2 border border-slate-700 rounded-md bg-slate-800 text-white w-full">`;
     container.appendChild(div);
     div.querySelector('input').addEventListener('change', (e) => {
         const newValue = parseFloat(e.target.value) || 0;
         if(isCapital) optimizedFinancialStructure[config.structure][`year${year}`] = newValue;
         else modelData[config.id] = newValue;
         forceCalculate();
     });
}

function setupControls() {
    Object.keys(controlsConfig).forEach(sectionKey => {
        const container = document.getElementById(`${sectionKey}-controls`);
        if (container) {
            controlsConfig[sectionKey].forEach(config => {
                if (config.type === 'capital_structure') for(let i=1; i<=5; i++) createNumberControl(config, container, true, i);
                else if (config.type === 'array_input') { 
                    const unitsContainer = document.createElement('div');
                    unitsContainer.className = 'grid grid-cols-5 gap-2';
                    modelData.unitsPerYear.forEach((units, index) => {
                        const div = document.createElement('div');
                        div.innerHTML = `<label class="text-xs text-slate-400">A√±o ${index+1}</label><input type="number" value="${units}" class="p-2 w-full border border-slate-700 rounded-md bg-slate-800 text-white">`;
                        unitsContainer.appendChild(div);
                        div.querySelector('input').addEventListener('change', (e) => { modelData.unitsPerYear[index] = parseInt(e.target.value) || 0; forceCalculate(); });
                    });
                     container.appendChild(unitsContainer);
                }
                else if (config.type === 'display') container.innerHTML += `<div class="flex justify-between text-sm py-2"><span>${config.label}</span><span id="${config.id}-display" class="font-bold text-slate-200">${modelData[config.id]} a√±os</span></div>`;
                else if(config.type === 'checkbox') {
                    const checkDiv = document.createElement('div');
                    checkDiv.className = 'flex items-center mt-2';
                    checkDiv.innerHTML = `<input id="${config.id}-check" type="checkbox" ${modelData[config.id] ? 'checked' : ''} class="h-4 w-4 rounded border-slate-600 text-sky-500 focus:ring-sky-500 bg-slate-700"><label for="${config.id}-check" class="ml-2 block text-sm text-slate-200">${config.label}</label>`;
                    container.appendChild(checkDiv);
                    checkDiv.querySelector('input').addEventListener('change', (e) => { modelData[config.id] = e.target.checked; forceCalculate(); });
                }
                else if(config.type === 'range') createSliderControl(config, container);
                else createNumberControl(config, container);
            });
        }
    });
}
        
function setupTabs() { 
     const tabButtons = document.querySelectorAll('.tab-button');
     const contentSections = document.querySelectorAll('.content-section');
     tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            contentSections.forEach(section => section.classList.remove('active'));
            button.classList.add('active');
            const tabName = button.id.split('-')[1];
            document.getElementById(`content-${tabName}`).classList.add('active');
        });
     });
}

function forceCalculate() {
    if (calculateFinancials()) {
        updateUI();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    try {
        setupTabs();
        setupControls();
        forceCalculate();
    } catch (error) {
        console.error(`‚ùå CRITICAL ERROR: ${error.message}`);
    }
});
</script>
</body>
</html>
